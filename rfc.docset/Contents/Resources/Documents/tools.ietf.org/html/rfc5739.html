<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><head profile="http://dublincore.org/documents/2008/08/04/dc-html/">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <meta content="index,follow" name="robots"/>
    <meta content="rfcmarkup version 1.107" name="creator"/>
    <link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/>
<meta content="draft-eronen-ipsec-ikev2-ipv6-config" name="DC.Relation.Replaces"/>
<meta content="urn:ietf:rfc:5739" name="DC.Identifier"/>
<meta content="February, 2010" name="DC.Date.Issued"/>
<meta content="Laganier, Julien" name="DC.Creator"/>
<meta content="Madson, Cheryl" name="DC.Creator"/>
<meta content="Eronen, Pasi" name="DC.Creator"/>
<meta content='When Internet Key Exchange Protocol version 2 (IKEv2) is used for\nremote VPN access (client to VPN gateway), the gateway assigns the\nclient an IP address from the internal network using IKEv2\nconfiguration payloads. The configuration payloads specified in RFC\n4306 work well for IPv4 but make it difficult to use certain features\nof IPv6. This document specifies new configuration attributes for\nIKEv2 that allows the VPN gateway to assign IPv6 prefixes to clients,\nenabling all features of IPv6 to be used with the client-gateway\n"virtual link". This document defines an Experimental Protocol for the\nInternet community.' name="DC.Description.Abstract"/>
<meta content="IPv6 Configuration in Internet Key Exchange Protocol Version 2 (IKEv2)" name="DC.Title"/>

    <link href="http://tools.ietf.org/images/rfc.png" rel="icon" type="image/png"/>
    <link href="http://tools.ietf.org/images/rfc.png" rel="shortcut icon" type="image/png"/>
    <title>RFC 5739 - IPv6 Configuration in Internet Key Exchange Protocol Version 2 (IKEv2)</title>
    
    
    <style type="text/css">
	body {
	    margin: 0px 8px;
            font-size: 1em;
	}
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        a.selflink {
          color: black;
          text-decoration: none;
        }
        @media print {
            body {
                font-family: monospace;
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 1em;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>                   <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>                     <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>             <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>              <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td>      <td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td>         <td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard (old designation):</td> <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Internet Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>                  <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>                  <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
   <div style="height: 13px;">
      <div class="pre noprint docinfo bgyellow" onclick="showElem('legend');" onmouseout="hideElem('legend')" onmouseover="this.style.cursor='pointer';" style="height: 6px; position: absolute;" title="Click for colour legend.">                                                                        </div>
      <div class="docinfo noprint pre legend" id="legend" onmouseout="hideElem('legend');" onmouseover="showElem('legend');" style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; ">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="index.html" title="Document search and retrieval page">Docs</a>] [<a href="http://tools.ietf.org/rfc/rfc5739.txt" title="Plaintext version of this document">txt</a>|<a href="http://tools.ietf.org/pdf/rfc5739" title="PDF version of this document">pdf</a>] [<a href="http://tools.ietf.org/html/draft-ietf-ipsecme-ikev2-ipv6-config" title="draft-ietf-ipsecme-ikev2-ipv6-config">draft-ietf-ipsecm...</a>] [<a href="http://tools.ietf.org/rfcdiff?difftype=--hwdiff&amp;url2=rfc5739" title="Inline diff (wdiff)">Diff1</a>] [<a href="http://tools.ietf.org/rfcdiff?url2=rfc5739" title="Side-by-side diff">Diff2</a>] [<a href="http://www.rfc-editor.org/errata_search.php?rfc=5739">Errata</a>]        </span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<span class="pre noprint docinfo">                                                            EXPERIMENTAL</span><br/>
<span class="pre noprint docinfo">                                                            <span style="color: #C00;">Errata Exist</span></span><br/>
<pre>Internet Engineering Task Force (IETF)                         P. Eronen
Request for Comments: 5739                                         Nokia
Category: Experimental                                       J. Laganier
ISSN: 2070-1721                                           QUALCOMM, Inc.
                                                               C. Madson
                                                           Cisco Systems
                                                           February 2010


 <span class="h1">IPv6 Configuration in Internet Key Exchange Protocol Version 2 (IKEv2)</span>

Abstract

   When Internet Key Exchange Protocol version 2 (IKEv2) is used for
   remote VPN access (client to VPN gateway), the gateway assigns the
   client an IP address from the internal network using IKEv2
   configuration payloads.  The configuration payloads specified in <a href="rfc4306.html">RFC</a>
   <a href="rfc4306.html">4306</a> work well for IPv4 but make it difficult to use certain features
   of IPv6.  This document specifies new configuration attributes for
   IKEv2 that allows the VPN gateway to assign IPv6 prefixes to clients,
   enabling all features of IPv6 to be used with the client-gateway
   "virtual link".

Status of This Memo

   This document is not an Internet Standards Track specification; it is
   published for examination, experimental implementation, and
   evaluation.

   This document defines an Experimental Protocol for the Internet
   community.  This document is a product of the Internet Engineering
   Task Force (IETF).  It represents the consensus of the IETF
   community.  It has received public review and has been approved for
   publication by the Internet Engineering Steering Group (IESG).  Not
   all documents approved by the IESG are a candidate for any level of
   Internet Standard; see <a href="rfc5741.html#section-2">Section 2 of RFC 5741</a>.

   Information about the current status of this document, any errata,
   and how to provide feedback on it may be obtained at
   <a href="http://www.rfc-editor.org/info/rfc5739">http://www.rfc-editor.org/info/rfc5739</a>.











<span class="grey">Eronen, et al.                Experimental                      [Page 1]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-2" id="page-2" name="page-2"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


Copyright Notice

   Copyright (c) 2010 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="http://tools.ietf.org/html/bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in <a href="#section-4">Section 4</a>.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.

   This document may contain material from IETF Documents or IETF
   Contributions published or made publicly available before November
   10, 2008.  The person(s) controlling the copyright in some of this
   material may not have granted the IETF Trust the right to allow
   modifications of such material outside the IETF Standards Process.
   Without obtaining an adequate license from the person(s) controlling
   the copyright in such materials, this document may not be modified
   outside the IETF Standards Process, and derivative works of it may
   not be created outside the IETF Standards Process, except to format
   it for publication as an RFC or to translate it into languages other
   than English.

























<span class="grey">Eronen, et al.                Experimental                      [Page 2]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-3" id="page-3" name="page-3"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


Table of Contents

   <a href="#section-1">1</a>. Introduction and Problem Statement ..............................<a href="#page-4">4</a>
   <a href="#section-2">2</a>. Terminology .....................................................<a href="#page-5">5</a>
   <a href="#section-3">3</a>. Current Limitations and Goals ...................................<a href="#page-6">6</a>
      <a href="#section-3.1">3.1</a>. Multiple Prefixes ..........................................<a href="#page-6">6</a>
      <a href="#section-3.2">3.2</a>. Link-Local Addresses .......................................<a href="#page-6">6</a>
      <a href="#section-3.3">3.3</a>. Interface Identifier Selection .............................<a href="#page-7">7</a>
      <a href="#section-3.4">3.4</a>. Sharing VPN Access .........................................<a href="#page-7">7</a>
      <a href="#section-3.5">3.5</a>. General Goals ..............................................<a href="#page-8">8</a>
      <a href="#section-3.6">3.6</a>. Non-Goals ..................................................<a href="#page-8">8</a>
      <a href="#section-3.7">3.7</a>. Additional Information .....................................<a href="#page-9">9</a>
   <a href="#section-4">4</a>. Solution Details ................................................<a href="#page-9">9</a>
      <a href="#section-4.1">4.1</a>. Initial Exchanges ..........................................<a href="#page-9">9</a>
      <a href="#section-4.2">4.2</a>. Reauthentication ..........................................<a href="#page-11">11</a>
      <a href="#section-4.3">4.3</a>. Creating CHILD_SAs ........................................<a href="#page-11">11</a>
      <a href="#section-4.4">4.4</a>. Relationship to Neighbor Discovery ........................<a href="#page-12">12</a>
      <a href="#section-4.5">4.5</a>. Relationship to Existing IKEv2 Payloads ...................<a href="#page-13">13</a>
   <a href="#section-5">5</a>. Payload Formats ................................................<a href="#page-13">13</a>
      <a href="#section-5.1">5.1</a>. INTERNAL_IP6_LINK Configuration Attribute .................<a href="#page-13">13</a>
      <a href="#section-5.2">5.2</a>. INTERNAL_IP6_PREFIX Configuration Attribute ...............<a href="#page-14">14</a>
      <a href="#section-5.3">5.3</a>. LINK_ID Notify Payload ....................................<a href="#page-14">14</a>
   <a href="#section-6">6</a>. IANA Considerations ............................................<a href="#page-15">15</a>
   <a href="#section-7">7</a>. Security Considerations ........................................<a href="#page-15">15</a>
   <a href="#section-8">8</a>. Acknowledgments ................................................<a href="#page-15">15</a>
   <a href="#section-9">9</a>. References .....................................................<a href="#page-16">16</a>
      <a href="#section-9.1">9.1</a>. Normative References ......................................<a href="#page-16">16</a>
      <a href="#section-9.2">9.2</a>. Informative References ....................................<a href="#page-16">16</a>
   <a href="#appendix-A">Appendix A</a>.  Design Rationale (Non-Normative) ...................<a href="#page-19">19</a>
     <a href="#appendix-A.1">A.1</a>.  Link Model ................................................<a href="#page-20">20</a>
     <a href="#appendix-A.2">A.2</a>.  Distributing Prefix Information ...........................<a href="#page-20">20</a>
     <a href="#appendix-A.3">A.3</a>.  Unique Address Allocation .................................<a href="#page-21">21</a>
     <a href="#appendix-A.4">A.4</a>.  Layer 3 Access Control ....................................<a href="#page-21">21</a>
     <a href="#appendix-A.5">A.5</a>.  Other Considerations ......................................<a href="#page-22">22</a>
     <a href="#appendix-A.6">A.6</a>.  Alternative Solution Sketches .............................<a href="#page-24">24</a>
       <a href="#appendix-A.6.1">A.6.1</a>.  Version -00 Sketch ..................................<a href="#page-24">24</a>
       <a href="#appendix-A.6.2">A.6.2</a>.  Router Aggregation Sketch #1 ..........................<a href="#page-25">25</a>
       <a href="#appendix-A.6.3">A.6.3</a>.  Router Aggregation Sketch #2 ..........................<a href="#page-27">27</a>
       <a href="#appendix-A.6.4">A.6.4</a>.  IPv4-Like Sketch ....................................<a href="#page-28">28</a>
       <a href="#appendix-A.6.5">A.6.5</a>.  Sketch Based on <a href="rfc3456.html">RFC 3456</a> ..............................<a href="#page-30">30</a>
   <a href="#appendix-B">Appendix B</a>.  Evaluation (Non-Normative) .........................<a href="#page-31">31</a>










<span class="grey">Eronen, et al.                Experimental                      [Page 3]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-4" id="page-4" name="page-4"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/1.%20%20Introduction%20and%20Problem%20Statement"></a><a class="selflink" href="#section-1" name="section-1">1</a>.  Introduction and Problem Statement</span>

   In typical remote access VPN use (client to VPN gateway), the client
   needs an IP address in the network protected by the security gateway.
   IKEv2 includes a feature called "configuration payloads" that allows
   the gateway to dynamically assign a temporary address to the client
   [<a href="#ref-IKEv2" title='"Internet Key Exchange (IKEv2) Protocol"'>IKEv2</a>].

   For IPv4, the message exchange would look as follows:

      Client      Gateway
     --------    ---------

      HDR(IKE_SA_INIT), SAi1, KEi, Ni  --&gt;

               &lt;--  HDR(IKE_SA_INIT), SAr1, KEr, Nr, [CERTREQ]

      HDR(IKE_AUTH),
      SK { IDi, CERT, [CERTREQ], AUTH, [IDr],
           CP(CFG_REQUEST) =
              { INTERNAL_IP4_ADDRESS(),
                INTERNAL_IP4_DNS() }, SAi2,
           TSi = (0, 0-65535, 0.0.0.0-255.255.255.255),
           TSr = (0, 0-65535, 0.0.0.0-255.255.255.255) }  --&gt;

             &lt;--  HDR(IKE_AUTH),
                  SK { IDr, CERT, AUTH,
                       CP(CFG_REPLY) =
                          { INTERNAL_IP4_ADDRESS(192.0.2.234),
                            INTERNAL_IP4_DNS(198.51.100.33) },
                       SAr2,
                       TSi = (0, 0-65535, 192.0.2.234-192.0.2.234),
                       TSr = (0, 0-65535, 0.0.0.0-255.255.255.255) }

                       Figure 1: IPv4 Configuration

   The IPv4 case has been implemented by various vendors and, in
   general, works well.  IKEv2 also defines almost identical
   configuration payloads for IPv6:












<span class="grey">Eronen, et al.                Experimental                      [Page 4]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-5" id="page-5" name="page-5"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


      Client      Gateway
     --------    ---------

      HDR(IKE_AUTH),
      SK { IDi, CERT, [CERTREQ], AUTH, [IDr],
           CP(CFG_REQUEST) =
              { INTERNAL_IP6_ADDRESS(),
                INTERNAL_IP6_DNS() }, SAi2,
           TSi = (0, 0-65535,
                  0:0:0:0:0:0:0:0 -
                  FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF),
           TSr = (0,
                  0-65535, 0:0:0:0:0:0:0:0 -
                  FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF) }  --&gt;

             &lt;--  HDR(IKE_AUTH),
                  SK { IDr, CERT, AUTH,
                       CP(CFG_REPLY) =
                          { INTERNAL_IP6_ADDRESS(2001:DB8:0:1:2:3:4:5,
                                                 64),
                            INTERNAL_IP6_DNS(2001:DB8:9:8:7:6:5:4) },
                       SAr2,
                       TSi = (0, 0-65535,
                              2001:DB8:0:1:2:3:4:5 -
                              2001:DB8:0:1:2:3:4:5),
                       TSr = (0, 0-65535,
                              0:0:0:0:0:0:0:0 -
                              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF) }

                       Figure 2: IPv6 Configuration

   In other words, IPv6 is basically treated as IPv4 with larger
   addresses.  As noted in [<a href="rfc4718.html" title='"IKEv2 Clarifications and Implementation Guidelines"'>RFC4718</a>], this does not fully follow the
   "normal IPv6 way of doing things", and it complicates or prevents
   using certain features of IPv6.  <a href="#section-3">Section 3</a> describes the limitations
   in detail.

   This document specifies new configuration attributes for IKEv2 that
   allows the VPN gateway to assign IPv6 prefixes to clients, enabling
   all features of IPv6 to be used with the client-gateway "virtual
   link".

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/2.%20%20Terminology"></a><a class="selflink" href="#section-2" name="section-2">2</a>.  Terminology</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in [<a href="#ref-KEYWORDS" title='"Key words for use in RFCs to Indicate Requirement Levels"'>KEYWORDS</a>].




<span class="grey">Eronen, et al.                Experimental                      [Page 5]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-6" id="page-6" name="page-6"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


   When messages containing IKEv2 payloads are described, optional
   payloads are shown in brackets (for instance, "[FOO]"); a plus sign
   indicates that a payload can be repeated one or more times (for
   instance, "FOO+").

   This document uses the term "virtual interface" when describing how
   the client uses the IPv6 address(es) assigned by the gateway.  While
   existing IPsec documents do not use this term, it is not a new
   concept.  In order to use the address assigned by the VPN gateway,
   current VPN clients already create a local "virtual interface", as
   only addresses assigned to interfaces can be used, e.g., as source
   addresses for TCP connections.  Note that this definition of
   "interface" is not necessarily identical with what some particular
   implementations call "interface".

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/3.%20%20Current%20Limitations%20and%20Goals"></a><a class="selflink" href="#section-3" name="section-3">3</a>.  Current Limitations and Goals</span>

   This section describes the limitations of the current IPv6
   configuration mechanism and requirements for the new solution.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.1.%20%20Multiple%20Prefixes"></a><a class="selflink" href="#section-3.1" name="section-3.1">3.1</a>.  Multiple Prefixes</span>

   In Figure 2, only a single IPv6 address (from a single prefix) is
   assigned.  The specification does allow the client to include
   multiple INTERNAL_IP6_ADDRESS attributes in its request, but the
   gateway cannot assign more addresses than the client requested.

   Multiple prefixes are useful for site renumbering, host-based site
   multihoming [<a href="#ref-SHIM6" title='"Shim6: Level 3 Multihoming Shim Protocol for IPv6"'>SHIM6</a>], and unique local IPv6 addresses [<a href="rfc4193.html" title='"Unique Local IPv6 Unicast Addresses"'>RFC4193</a>].  In
   all of these cases, the gateway has better information on how many
   different addresses (from different prefixes) the client should be
   assigned.

   The solution should support assigning addresses from multiple
   prefixes, without requiring the client to know beforehand how many
   prefixes are needed.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.2.%20%20Link-Local%20Addresses"></a><a class="selflink" href="#section-3.2" name="section-3.2">3.2</a>.  Link-Local Addresses</span>

   The IPv6 addressing architecture [<a href="#ref-IPv6Addr" title='"IP Version 6 Addressing Architecture"'>IPv6Addr</a>] specifies that "IPv6
   addresses of all types are assigned to interfaces, not nodes. [..]
   All interfaces are required to have at least one Link-Local unicast
   address".

   Currently, the virtual interface created by IKEv2 configuration
   payloads does not have link-local addresses.  This violates the
   requirements in [<a href="#ref-IPv6Addr" title='"IP Version 6 Addressing Architecture"'>IPv6Addr</a>] and prevents the use of protocols that
   require link-local addresses, such as [<a href="#ref-MLDv2" title='"Multicast Listener Discovery Version 2 (MLDv2) for IPv6"'>MLDv2</a>] and [<a href="#ref-DHCPv6" title='"Dynamic Host Configuration Protocol for IPv6 (DHCPv6)"'>DHCPv6</a>].



<span class="grey">Eronen, et al.                Experimental                      [Page 6]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-7" id="page-7" name="page-7"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


   The solution should assign link-local addresses to the virtual
   interfaces and allow them to be used for protocols between the VPN
   client and gateway.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.3.%20%20Interface%20Identifier%20Selection"></a><a class="selflink" href="#section-3.3" name="section-3.3">3.3</a>.  Interface Identifier Selection</span>

   In the message exchange shown in Figure 2, the gateway chooses the
   interface ID used by the client.  It is also possible for the client
   to request a specific interface ID; the gateway then chooses the
   prefix part.

   This approach complicates the use of Cryptographically Generated
   Addresses (CGAs) [<a href="#ref-CGA" title='"Cryptographically Generated Addresses (CGA)"'>CGA</a>].  With CGAs, the interface ID cannot be
   calculated before the prefix is known.  The client could first obtain
   a non-CGA address to determine the prefix and then send a separate
   CFG_REQUEST to obtain a CGA address with the same prefix.  However,
   this approach requires that the IKEv2 software component provide an
   interface to the component managing CGAs; an ugly implementation
   dependency that would be best avoided.

   Similar concerns apply to other cases where the client has some
   interest in what interface ID is being used, such as Hash-Based
   Addresses [<a href="#ref-HBA" title='"Hash-Based Addresses (HBA)"'>HBA</a>] and privacy addresses [<a href="rfc4941.html" title='"Privacy Extensions for Stateless Address Autoconfiguration in IPv6"'>RFC4941</a>].

   Without CGAs and HBAs, VPN clients are not able to fully use IPv6
   features such as [<a href="#ref-SHIM6" title='"Shim6: Level 3 Multihoming Shim Protocol for IPv6"'>SHIM6</a>] or enhanced Mobile IPv6 route optimization
   [<a href="rfc4866.html" title='"Enhanced Route Optimization for Mobile IPv6"'>RFC4866</a>].

   The solution should allow the VPN client to easily obtain several
   addresses from a given prefix, where the interface IDs are selected
   by the client and may depend on the prefix.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.4.%20%20Sharing%20VPN%20Access"></a><a class="selflink" href="#section-3.4" name="section-3.4">3.4</a>.  Sharing VPN Access</span>

   Some VPN clients may want to share the VPN connection with other
   devices (e.g., from a cell phone to a laptop or vice versa) via some
   local area network connection (such as Wireless LAN or Bluetooth), if
   allowed by the security policy.

   Quite obviously, sharing of VPN access requires more than one address
   (unless NAT is used).  However, the current model where each address
   is requested separately is probably complex to integrate with a local
   area network that uses stateless address autoconfiguration
   [<a href="#ref-AUTOCONF" title='"IPv6 Stateless Address Autoconfiguration"'>AUTOCONF</a>].  Thus, obtaining a whole prefix for the VPN client and
   advertising that to the local link (something resembling [<a href="#ref-NDProxy" title='"Neighbor Discovery Proxies (ND Proxy)"'>NDProxy</a>])
   would be preferable.  With DHCPv6 prefix delegation [<a href="rfc3633.html" title='"IPv6 Prefix Options for Dynamic Host Configuration Protocol (DHCP) version 6"'>RFC3633</a>], even
   [<a href="#ref-NDProxy" title='"Neighbor Discovery Proxies (ND Proxy)"'>NDProxy</a>] and associated multi-link subnet issues would be avoided.




<span class="grey">Eronen, et al.                Experimental                      [Page 7]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-8" id="page-8" name="page-8"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


   The solution should support sharing the VPN access over a local area
   network connection when the other hosts are using stateless address
   autoconfiguration.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.5.%20%20General%20Goals"></a><a class="selflink" href="#section-3.5" name="section-3.5">3.5</a>.  General Goals</span>

   o  The solution should avoid periodic messages over the VPN tunnel.

   o  Reauthentication should work, where the client can start a new IKE
      Security Association (SA) and continue using the same addresses as
      before.

   o  There should be compatibility with other IPsec uses.  Configuring
      a virtual IPv6 link (with addresses assigned in IKEv2) should not
      prevent the same peers from using IPsec/IKEv2 for other uses (with
      other addresses).  In particular, the peers may have Security
      Policy Database (SPD) entries and Peer Authorization Database
      (PAD) Child SA Authorization Data entries that are not related to
      the virtual link; when a CHILD_SA is created, it should be
      unambiguous which entries are used.

   o  There should be compatibility with current IPv6 configuration.
      Although the current IPv6 mechanism is not widely implemented, new
      solutions should not preclude its use (e.g., by defining
      incompatible semantics for the existing payloads).

   o  The solution should have clean implementation dependencies.  In
      particular, it should not require significant modifications to the
      core IPv6 stack (typically part of the operating system) or
      require the IKEv2 implementor to re-implement parts of the IPv6
      stack (e.g., to have access or control to functionality that is
      currently not exposed by interfaces of the IPv6 stack).

   o  Re-use existing mechanisms as much as possible, as described in
      [<a href="#ref-IPConfig" title='"Principles of Internet Host Configuration"'>IPConfig</a>].  <a href="#appendix-A">Appendix A</a> describes the rationale of why this
      document nevertheless uses IKEv2 configuration payloads for
      configuring the addresses.  However, <a href="#section-4.1">Section 4.1</a> recommends using
      a DHCPv6 Information-Request message for obtaining other
      configuration information (such as DNS server addresses).

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.6.%20%20Non-Goals"></a><a class="selflink" href="#section-3.6" name="section-3.6">3.6</a>.  Non-Goals</span>

   Mobile IPv6 already defines how it interacts with IPsec/IKEv2
   [<a href="rfc4877.html" title='"Mobile IPv6 Operation with IKEv2 and the Revised IPsec Architecture"'>RFC4877</a>], and the intent of this document is not to change that
   interaction in any way.






<span class="grey">Eronen, et al.                Experimental                      [Page 8]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-9" id="page-9" name="page-9"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.7.%20%20Additional%20Information"></a><a class="selflink" href="#section-3.7" name="section-3.7">3.7</a>.  Additional Information</span>

   If the VPN client is assigned IPv6 address(es) from prefix(es) that
   are shared with other VPN clients, this results in some kind of
   multi-link subnet.  [<a href="#ref-Multilink" title='"Multi-Link Subnet Issues"'>Multilink</a>] describes issues associated with
   multi-link subnets and recommends that they be avoided.

   The original 3GPP specifications for IPv6 assigned a single IPv6
   address to each mobile phone, resembling current IKEv2 payloads.
   [<a href="rfc3314.html" title='"Recommendations for IPv6 in Third Generation Partnership Project (3GPP) Standards"'>RFC3314</a>] describes the problems with this approach and caused 3GPP
   to change the specifications to assign unique /64 prefix(es) for each
   phone.

   Due to similar concerns, the IEEE 802.16 IPv6 Convergence Sublayer
   [<a href="rfc5121.html" title='"Transmission of IPv6 via the IPv6 Convergence Sublayer over IEEE 802.16 Networks"'>RFC5121</a>] and Proxy Mobile IPv6 [<a href="rfc5213.html" title='"Proxy Mobile IPv6"'>RFC5213</a>] also assign unique
   prefixes.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/4.%20%20Solution%20Details"></a><a class="selflink" href="#section-4" name="section-4">4</a>.  Solution Details</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.1.%20%20Initial%20Exchanges"></a><a class="selflink" href="#section-4.1" name="section-4.1">4.1</a>.  Initial Exchanges</span>

   During IKE_AUTH, the client sends a new configuration attribute,
   INTERNAL_IP6_LINK, which requests a virtual link to be configured.
   The attribute contains the client's interface ID for the link-local
   address (other addresses may use other interface IDs).  Typically,
   the client would also ask for the DHCPv6 server address; this is used
   only for configuration (such as DNS server addresses), not address
   assignment.

       CP(CFG_REQUEST) =
          { INTERNAL_IP6_LINK(Client's Link-Local Interface ID)
            INTERNAL_IP6_DHCP() }
       TSi = (0, 0-65535, 0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
       TSr = (0, 0-65535, 0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)  --&gt;

   If the client has sent the INTERNAL_IP6_LINK configuration attribute,
   the VPN gateway SHOULD ignore any INTERNAL_IP6_ADDRESS configuration
   attribute present in the request.

   The VPN gateway MUST choose for itself a link-local interface
   identifier different than the client's, i.e., accept the link-local
   interface identifier proposed by the client.  In case the VPN gateway
   cannot accept the link-local interface identifier the client
   proposed, the VPN gateway MUST fail the IPv6 address assignment by
   including a NOTIFY payload with the INTERNAL_ADDRESS_FAILURE message.




<span class="grey">Eronen, et al.                Experimental                      [Page 9]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-10" id="page-10" name="page-10"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


   The VPN gateway then replies with an INTERNAL_IP6_LINK configuration
   attribute that contains the IKEv2 Link ID (an identifier selected by
   the VPN gateway, treated as an opaque octet string by the client --
   this will be used for reauthentication and CREATE_CHILD_SA messages),
   the gateway's link-local interface identifier, and zero or more
   INTERNAL_IP6_PREFIX attributes.  The traffic selectors proposed by
   the initiator are also narrowed to contain only the assigned prefixes
   and the client link-local address (FE80::&lt;Client's Interface ID&gt;)
   identifier.

       CP(CFG_REPLY) =
          { INTERNAL_IP6_LINK(Gateway's Link-Local Interface ID,
                              IKEv2 Link ID)
            INTERNAL_IP6_PREFIX(Prefix1/64),
            [INTERNAL_IP6_PREFIX(Prefix2/64),...],
            INTERNAL_IP6_DHCP(Address) }
       TSi = ((0, 0-65535,
               FE80::&lt;Client's Interface ID&gt; -
               FE80::&lt;Client's Interface ID&gt;)
              (0, 0-65535,
               Prefix1::0 -
               Prefix1::FFFF:FFFF:FFFF:FFFF),
              [(0, 0-65535,
                Prefix2::0 -
                Prefix2::FFFF:FFFF:FFFF:FFFF), ...])
       TSr = (0, 0-65535,
              0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)

   At this point, the client can configure its link-local address
   (FE80::&lt;Client's Interface ID&gt;) and other non-link-local unicast
   addresses from the assigned prefixes (with any proper interface
   identifier [<a href="#ref-IPv6Addr" title='"IP Version 6 Addressing Architecture"'>IPv6Addr</a>]).  The VPN gateway MUST NOT simultaneously
   assign the same prefixes to any other client and MUST NOT itself
   configure addresses from these prefixes.  Thus, the client does not
   have to perform Duplicate Address Detection (DAD).  (This approach is
   based on [<a href="#ref-IPv6PPP" title='"IP Version 6 over PPP"'>IPv6PPP</a>].)

   The prefixes remain valid through the lifetime of the IKE SA (and its
   continuations via rekeying).  If the VPN gateway needs to remove a
   prefix it has previously assigned, or assign a new prefix, it can do
   so with reauthentication (either starting reauthentication itself or
   requesting the client to reauthenticate using [<a href="rfc4478.html" title='"Repeated Authentication in Internet Key Exchange (IKEv2) Protocol"'>RFC4478</a>]).

   The client also contacts the DHCPv6 server.  This is the RECOMMENDED
   way to obtain additional configuration parameters (such as DNS server
   addresses), as it allows easier extensibility and more options (such
   as the domain search list for DNS).



<span class="grey">Eronen, et al.                Experimental                     [Page 10]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-11" id="page-11" name="page-11"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.2.%20%20Reauthentication"></a><a class="selflink" href="#section-4.2" name="section-4.2">4.2</a>.  Reauthentication</span>

   When the client performs reauthentication (and wants to continue
   using the same "virtual link"), it includes the IKEv2 Link ID given
   by the gateway in the INTERNAL_IP6_LINK attribute.

      CP(CFG_REQUEST) =
         { INTERNAL_IP6_LINK(Client's Link Local Interface ID,
                             IKEv2 Link ID)
           INTERNAL_IP6_DHCP() }
      TSi = (0, 0-65535, 0:0:0:0:0:0:0:0 -
             FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
      TSr = (0, 0-65535, 0:0:0:0:0:0:0:0 -
             FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)  --&gt;

   At this point, the gateway MUST verify that the client is indeed
   allowed to use the link identified by the IKEv2 Link ID.  The same
   situation occurs in [<a href="#ref-IKEv2" title='"Internet Key Exchange (IKEv2) Protocol"'>IKEv2</a>] when the client wants to continue using
   the same IPv4 address with the INTERNAL_IP4_ADDRESS configuration
   attribute.  Typically, the gateway would use the Link ID to look up
   relevant local state and compare the authenticated peer identity of
   the IKE_SA with the local state.

   If the client is allowed to continue using this link, the gateway
   replies (see <a href="#section-4.1">Section 4.1</a>) with the same gateway's link-local
   interface ID and IKEv2 Link ID as used earlier and sends the IPv6
   prefix(es) associated with this link.  Usually, the IPv6 prefix(es)
   will also be the same as earlier, but this is not required.

   If the client is not allowed to continue using this link, the gateway
   treats it as a request for a new virtual link, selects a different
   IKEv2 Link ID value, and replies as in <a href="#section-4.1">Section 4.1</a>.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.3.%20%20Creating%20CHILD_SAs"></a><a class="selflink" href="#section-4.3" name="section-4.3">4.3</a>.  Creating CHILD_SAs</span>

   When a CHILD_SA is created, the peers need to determine which SPD
   entries and PAD Child SA Authorization Data entries are used for this
   CHILD_SA.  In the basic client-to-VPN-gateway uses, the situation is
   simple: all the matching SPD entries and Child SA Authorization Data
   entries are related to the "virtual link" between the VPN client and
   the VPN gateway.  However, if the same peers are also using IPsec/
   IKEv2 for other uses (with addresses not assigned inside IKEv2), they
   would also have SPD entries and PAD Child SA Authorization Data that
   is not related to the virtual link.

   If one of the peers requests a CHILD_SA and proposes traffic
   selectors covering everything (like in Figure 2), should those be
   narrowed to the prefixes configured with INTERNAL_IP6_PREFIX or to



<span class="grey">Eronen, et al.                Experimental                     [Page 11]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-12" id="page-12" name="page-12"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


   the other SPD/PAD entries?  While some kind of heuristics are
   possible (see <a href="#appendix-A">Appendix A</a> for discussion), this document specifies an
   explicit solution:

   The peers MUST include a LINK_ID notification, containing the IKEv2
   Link ID, in all CREATE_CHILD_SA requests (including rekeys) that are
   related to the virtual link.  The LINK_ID notification is not
   included in the CREATE_CHILD_SA response or when doing IKE_SA
   rekeying.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.4.%20%20Relationship%20to%20Neighbor%20Discovery"></a><a class="selflink" href="#section-4.4" name="section-4.4">4.4</a>.  Relationship to Neighbor Discovery</span>

   Neighbor Discovery [<a href="#ref-IPv6ND" title='"Neighbor Discovery for IP version 6 (IPv6)"'>IPv6ND</a>] specifies the following mechanisms:

   Router Discovery, Prefix Discovery, Parameter Discovery, and address
   autoconfiguration are not used, as the necessary functionality is
   implemented in IKEv2.

   Address Resolution, Next-hop Determination, and Redirect are not
   used, as the virtual link does not have link-layer addresses and is a
   point-to-point link.

   Neighbor Unreachability Detection could be used but is a bit
   redundant given IKEv2 Dead Peer Detection.

   Duplicate Address Detection is not needed because this is a point-to-
   point link, where the VPN gateway does not assign any addresses from
   the global unicast prefixes, and the link-local interface identifier
   is negotiated separately.

   Duplicate Address Detection is not needed for global unicast
   addresses formed from the global unicast prefix(es) configured as
   part of the IKEv2 exchange, because this is a point-to-point link,
   where the VPN gateway does not assign any addresses from the global
   unicast prefixes.  Duplicate Address Detection may be needed for
   link-local addresses, e.g., when the client configures a link-local
   address as per [<a href="rfc4941.html" title='"Privacy Extensions for Stateless Address Autoconfiguration in IPv6"'>RFC4941</a>].

   Thus, Duplicate Address Detection MAY be skipped for global unicast
   addresses formed from the global unicast prefix(es) configured as
   part of the IKEv2 exchange.  However, Duplicate Address Detection for
   link-local unicast addresses MUST be performed as required per some
   other specifications, e.g., [<a href="rfc4941.html" title='"Privacy Extensions for Stateless Address Autoconfiguration in IPv6"'>RFC4941</a>].








<span class="grey">Eronen, et al.                Experimental                     [Page 12]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-13" id="page-13" name="page-13"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.5.%20%20Relationship%20to%20Existing%20IKEv2%20Payloads"></a><a class="selflink" href="#section-4.5" name="section-4.5">4.5</a>.  Relationship to Existing IKEv2 Payloads</span>

   The mechanism described in this document is not intended to be used
   at the same time as the existing INTERNAL_IP6_ADDRESS attribute.  For
   compatibility with gateways implementing only INTERNAL_IP6_ADDRESS,
   the VPN client MAY include attributes for both mechanisms in
   CFG_REQUEST.  The capabilities and preferences of the VPN gateway
   will then determine which is used.

   All other attributes except INTERNAL_IP6_ADDRESS (and
   INTENAL_ADDRESS_EXPIRY) from [<a href="#ref-IKEv2" title='"Internet Key Exchange (IKEv2) Protocol"'>IKEv2</a>] remain valid, including the
   somewhat confusingly named INTERNAL_IP6_SUBNET (see <a href="rfc4718.html#section-6.3">Section 6.3 of
   [RFC4718]</a> for discussion).

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/5.%20%20Payload%20Formats"></a><a class="selflink" href="#section-5" name="section-5">5</a>.  Payload Formats</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/5.1.%20%20INTERNAL_IP6_LINK%20Configuration%20Attribute"></a><a class="selflink" href="#section-5.1" name="section-5.1">5.1</a>.  INTERNAL_IP6_LINK Configuration Attribute</span>

   The INTERNAL_IP6_LINK configuration attribute is formatted as
   follows:

                        1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   !R|         Attribute Type      !            Length             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                          Link-Local                           |
   |                         Interface ID                          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                        IKEv2 Link ID                          ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   o  Reserved (1 bit) - See [<a href="#ref-IKEv2" title='"Internet Key Exchange (IKEv2) Protocol"'>IKEv2</a>].

   o  Attribute Type (15 bits) - INTERNAL_IP6_LINK (17).

   o  Length (2 octets) - Length in octets of the Value field (Link-
      Local Interface ID and IKEv2 Link ID); 8 or more.

   o  Link-Local Interface ID (8 octets) - The Interface ID used for
      link-local address (by the party that sent this attribute).

   o  IKEv2 Link ID (variable length) - The Link ID (may be empty when
      the client does not yet know the Link ID).  The Link ID is
      selected by the VPN gateway and is treated as an opaque octet
      string by the client.



<span class="grey">Eronen, et al.                Experimental                     [Page 13]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-14" id="page-14" name="page-14"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/5.2.%20%20INTERNAL_IP6_PREFIX%20Configuration%20Attribute"></a><a class="selflink" href="#section-5.2" name="section-5.2">5.2</a>.  INTERNAL_IP6_PREFIX Configuration Attribute</span>

   The INTERNAL_IP6_PREFIX configuration attribute is formatted as
   follows:

                        1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   !R|         Attribute Type      !            Length             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   |                            Prefix                             |
   |                                                               |
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | Prefix Length |
   +-+-+-+-+-+-+-+-+

   o  Reserved (1 bit) - See [<a href="#ref-IKEv2" title='"Internet Key Exchange (IKEv2) Protocol"'>IKEv2</a>].

   o  Attribute Type (15 bits) - INTERNAL_IP6_PREFIX (18).

   o  Length (2 octets) - Length in octets of the Value field; in this
      case, 17.

   o  Prefix (16 octets) - An IPv6 prefix assigned to the virtual link.
      The low-order bits of the prefix field that are not part of the
      prefix MUST be set to zero by the sender and MUST be ignored by
      the receiver.

   o  Prefix Length (1 octet) - The length of the prefix in bits;
      usually 64.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/5.3.%20%20LINK_ID%20Notify%20Payload"></a><a class="selflink" href="#section-5.3" name="section-5.3">5.3</a>.  LINK_ID Notify Payload</span>

   The LINK_ID notification is included in CREATE_CHILD_SA requests to
   indicate that the SA being created is related to the virtual link.
   If this notification is not included, the CREATE_CHILD_SA requests
   are related to the real interface.

   The Notify Message Type for LINK_ID is 16414.  The Protocol ID and
   SPI Size fields are set to zero.  The data associated with this
   notification is the IKEv2 Link ID returned in the INTERNAL_IP6_LINK
   configuration attribute.







<span class="grey">Eronen, et al.                Experimental                     [Page 14]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-15" id="page-15" name="page-15"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/6.%20%20IANA%20Considerations"></a><a class="selflink" href="#section-6" name="section-6">6</a>.  IANA Considerations</span>

   This document defines two new IKEv2 configuration attributes, whose
   values have been allocated from the "IKEv2 Configuration Payload
   Attribute Types" namespace [<a href="#ref-IKEv2" title='"Internet Key Exchange (IKEv2) Protocol"'>IKEv2</a>]:

                                       Multi-
      Value    Attribute Type          Valued  Length         Reference
      ------   ----------------------  ------  -------------  ---------
      17       INTERNAL_IP6_LINK       NO      8 or more      [<a href="rfc5739.html">RFC5739</a>]
      18       INTERNAL_IP6_PREFIX     YES     17 octets      [<a href="rfc5739.html">RFC5739</a>]

   This document also defines one new IKEv2 notification, whose value
   has been allocated from the "IKEv2 Notify Message Types - Status
   Types" namespace [<a href="#ref-IKEv2" title='"Internet Key Exchange (IKEv2) Protocol"'>IKEv2</a>]:

      Value   Notify Messages - Status Types   Reference
      ------  -------------------------------  ---------
      16414   LINK_ID                          [<a href="rfc5739.html">RFC5739</a>]

   This document does not create any new namespaces to be maintained by
   IANA.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/7.%20%20Security%20Considerations"></a><a class="selflink" href="#section-7" name="section-7">7</a>.  Security Considerations</span>

   Since this document is an extension to IKEv2, the security
   considerations in [<a href="#ref-IKEv2" title='"Internet Key Exchange (IKEv2) Protocol"'>IKEv2</a>] apply here as well.

   The mechanism described in this document assigns each client a unique
   prefix, which makes using randomized interface identifiers [<a href="rfc4941.html" title='"Privacy Extensions for Stateless Address Autoconfiguration in IPv6"'>RFC4941</a>]
   ineffective from a privacy point of view: the client is still
   uniquely identified by the prefix.  In some environments, it may be
   preferable to assign a VPN client the same prefix each time a VPN
   connection is established; other environments may prefer assigning a
   different prefix every time for privacy reasons.  (This is basically
   a similar trade-off as in Mobile IPv6 -- using the same Home Address
   forever is simpler than changing it often, but has privacy
   implications.)

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/8.%20%20Acknowledgments"></a><a class="selflink" href="#section-8" name="section-8">8</a>.  Acknowledgments</span>

   The authors would like to thank Patrick Irwin, Tero Kivinen, Chinh
   Nguyen, Mohan Parthasarathy, Yaron Sheffer, Hemant Singh, Dave
   Thaler, Yinghzhe Wu, and Fan Zhao for their valuable comments.

   Many of the challenges associated with IPsec-protected "virtual
   interfaces" have been identified before, for example, in the context
   of protecting IPv6-in-IPv4 tunnels with IPsec [<a href="rfc4891.html" title='"Using IPsec to Secure IPv6-in-IPv4 Tunnels"'>RFC4891</a>], Provider



<span class="grey">Eronen, et al.                Experimental                     [Page 15]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-16" id="page-16" name="page-16"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


   Provisioned VPNs ([<a href="#ref-VLINK" title='"Framework for IPsec Protected Virtual Links for PPVPNs"'>VLINK</a>], [<a href="rfc3884.html" title='"Use of IPsec Transport Mode for Dynamic Routing"'>RFC3884</a>]), and Mobile IPv6 [<a href="rfc4877.html" title='"Mobile IPv6 Operation with IKEv2 and the Revised IPsec Architecture"'>RFC4877</a>].
   Some of the limitations of assigning a single IPv6 address were
   identified in [<a href="rfc3314.html" title='"Recommendations for IPv6 in Third Generation Partnership Project (3GPP) Standards"'>RFC3314</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/9.%20%20References"></a><a class="selflink" href="#section-9" name="section-9">9</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/9.1.%20%20Normative%20References"></a><a class="selflink" href="#section-9.1" name="section-9.1">9.1</a>.  Normative References</span>

   [<a id="ref-IKEv2" name="ref-IKEv2">IKEv2</a>]      Kaufman, C., "Internet Key Exchange (IKEv2) Protocol",
                <a href="rfc4306.html">RFC 4306</a>, December 2005.

   [<a id="ref-IPv6Addr" name="ref-IPv6Addr">IPv6Addr</a>]   Hinden, R. and S. Deering, "IP Version 6 Addressing
                Architecture", <a href="rfc4291.html">RFC 4291</a>, February 2006.

   [<a id="ref-KEYWORDS" name="ref-KEYWORDS">KEYWORDS</a>]   Bradner, S., "Key words for use in RFCs to Indicate
                Requirement Levels", <a href="http://tools.ietf.org/html/bcp14">BCP 14</a>, <a href="rfc2119.html">RFC 2119</a>, March 1997.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/9.2.%20%20Informative%20References"></a><a class="selflink" href="#section-9.2" name="section-9.2">9.2</a>.  Informative References</span>

   [<a id="ref-AUTOCONF" name="ref-AUTOCONF">AUTOCONF</a>]   Thomson, S., Narten, T., and T. Jinmei, "IPv6 Stateless
                Address Autoconfiguration", <a href="rfc4862.html">RFC 4862</a>, September 2007.

   [<a id="ref-CGA" name="ref-CGA">CGA</a>]        Aura, T., "Cryptographically Generated Addresses (CGA)",
                <a href="rfc3972.html">RFC 3972</a>, March 2006.

   [<a id="ref-DHCPv6" name="ref-DHCPv6">DHCPv6</a>]     Droms, R., Bound, J., Volz, B., Lemon, T., Perkins, C.,
                and M. Carney, "Dynamic Host Configuration Protocol for
                IPv6 (DHCPv6)", <a href="rfc3315.html">RFC 3315</a>, July 2003.

   [<a id="ref-HBA" name="ref-HBA">HBA</a>]        Bagnulo, M., "Hash-Based Addresses (HBA)", <a href="rfc5535.html">RFC 5535</a>,
                June 2009.

   [<a id="ref-IPConfig" name="ref-IPConfig">IPConfig</a>]   Aboba, B., Thaler, D., Andersson, L., and S. Cheshire,
                "Principles of Internet Host Configuration", <a href="rfc5505.html">RFC 5505</a>,
                May 2009.

   [<a id="ref-IPv6ND" name="ref-IPv6ND">IPv6ND</a>]     Narten, T., Nordmark, E., Simpson, W., and H. Soliman,
                "Neighbor Discovery for IP version 6 (IPv6)", <a href="rfc4861.html">RFC 4861</a>,
                September 2007.

   [<a id="ref-IPv6PPP" name="ref-IPv6PPP">IPv6PPP</a>]    Varada, S., Haskins, D., and E. Allen, "IP Version 6
                over PPP", <a href="rfc5072.html">RFC 5072</a>, September 2007.

   [<a id="ref-MLDv2" name="ref-MLDv2">MLDv2</a>]      Vida, R. and L. Costa, "Multicast Listener Discovery
                Version 2 (MLDv2) for IPv6", <a href="rfc3810.html">RFC 3810</a>, June 2004.

   [<a id="ref-MOBIKE" name="ref-MOBIKE">MOBIKE</a>]     Eronen, P., "IKEv2 Mobility and Multihoming Protocol
                (MOBIKE)", <a href="rfc4555.html">RFC 4555</a>, June 2006.



<span class="grey">Eronen, et al.                Experimental                     [Page 16]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-17" id="page-17" name="page-17"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


   [<a id="ref-Multilink" name="ref-Multilink">Multilink</a>]  Thaler, D., "Multi-Link Subnet Issues", <a href="rfc4903.html">RFC 4903</a>,
                June 2007.

   [<a id="ref-NDProxy" name="ref-NDProxy">NDProxy</a>]    Thaler, D., Talwar, M., and C. Patel, "Neighbor
                Discovery Proxies (ND Proxy)", <a href="rfc4389.html">RFC 4389</a>, April 2006.

   [<a id="ref-RFC3314" name="ref-RFC3314">RFC3314</a>]    Wasserman, M., "Recommendations for IPv6 in Third
                Generation Partnership Project (3GPP) Standards",
                <a href="rfc3314.html">RFC 3314</a>, September 2002.

   [<a id="ref-RFC3456" name="ref-RFC3456">RFC3456</a>]    Patel, B., Aboba, B., Kelly, S., and V. Gupta, "Dynamic
                Host Configuration Protocol (DHCPv4) Configuration of
                IPsec Tunnel Mode", <a href="rfc3456.html">RFC 3456</a>, January 2003.

   [<a id="ref-RFC3633" name="ref-RFC3633">RFC3633</a>]    Troan, O. and R. Droms, "IPv6 Prefix Options for Dynamic
                Host Configuration Protocol (DHCP) version 6", <a href="rfc3633.html">RFC 3633</a>,
                December 2003.

   [<a id="ref-RFC3884" name="ref-RFC3884">RFC3884</a>]    Touch, J., Eggert, L., and Y. Wang, "Use of IPsec
                Transport Mode for Dynamic Routing", <a href="rfc3884.html">RFC 3884</a>,
                September 2004.

   [<a id="ref-RFC4193" name="ref-RFC4193">RFC4193</a>]    Hinden, R. and B. Haberman, "Unique Local IPv6 Unicast
                Addresses", <a href="rfc4193.html">RFC 4193</a>, October 2005.

   [<a id="ref-RFC4478" name="ref-RFC4478">RFC4478</a>]    Nir, Y., "Repeated Authentication in Internet Key
                Exchange (IKEv2) Protocol", <a href="rfc4478.html">RFC 4478</a>, April 2006.

   [<a id="ref-RFC4718" name="ref-RFC4718">RFC4718</a>]    Eronen, P. and P. Hoffman, "IKEv2 Clarifications and
                Implementation Guidelines", <a href="rfc4718.html">RFC 4718</a>, October 2006.

   [<a id="ref-RFC4866" name="ref-RFC4866">RFC4866</a>]    Arkko, J., Vogt, C., and W. Haddad, "Enhanced Route
                Optimization for Mobile IPv6", <a href="rfc4866.html">RFC 4866</a>, May 2007.

   [<a id="ref-RFC4877" name="ref-RFC4877">RFC4877</a>]    Devarapalli, V. and F. Dupont, "Mobile IPv6 Operation
                with IKEv2 and the Revised IPsec Architecture",
                <a href="rfc4877.html">RFC 4877</a>, April 2007.

   [<a id="ref-RFC4891" name="ref-RFC4891">RFC4891</a>]    Graveman, R., Parthasarathy, M., Savola, P., and H.
                Tschofenig, "Using IPsec to Secure IPv6-in-IPv4
                Tunnels", <a href="rfc4891.html">RFC 4891</a>, May 2007.

   [<a id="ref-RFC4941" name="ref-RFC4941">RFC4941</a>]    Narten, T., Draves, R., and S. Krishnan, "Privacy
                Extensions for Stateless Address Autoconfiguration in
                IPv6", <a href="rfc4941.html">RFC 4941</a>, September 2007.






<span class="grey">Eronen, et al.                Experimental                     [Page 17]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-18" id="page-18" name="page-18"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


   [<a id="ref-RFC5121" name="ref-RFC5121">RFC5121</a>]    Patil, B., Xia, F., Sarikaya, B., Choi, JH., and S.
                Madanapalli, "Transmission of IPv6 via the IPv6
                Convergence Sublayer over IEEE 802.16 Networks",
                <a href="rfc5121.html">RFC 5121</a>, February 2008.

   [<a id="ref-RFC5213" name="ref-RFC5213">RFC5213</a>]    Gundavelli, S., Leung, K., Devarapalli, V., Chowdhury,
                K., and B. Patil, "Proxy Mobile IPv6", <a href="rfc5213.html">RFC 5213</a>,
                August 2008.

   [<a id="ref-SHIM6" name="ref-SHIM6">SHIM6</a>]      Nordmark, E. and M. Bagnulo, "Shim6: Level 3 Multihoming
                Shim Protocol for IPv6", <a href="rfc5533.html">RFC 5533</a>, June 2009.

   [<a id="ref-VLINK" name="ref-VLINK">VLINK</a>]      Duffy, M., "Framework for IPsec Protected Virtual Links
                for PPVPNs", Work in Progress, October 2002.





































<span class="grey">Eronen, et al.                Experimental                     [Page 18]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-19" id="page-19" name="page-19"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/Appendix%20A.%20%20Design%20Rationale%20%28Non-Normative%29"></a><a class="selflink" href="#appendix-A" name="appendix-A">Appendix A</a>.  Design Rationale (Non-Normative)</span>

   This appendix describes some of the reasons why the solution in
   <a href="#section-4">Section 4</a> was selected and lists some alternative designs that were
   considered but were ultimately rejected.

   Assigning a new IPv6 address to the client creates a new "virtual
   IPv6 interface" and "virtual link" between the client and the
   gateway.  We will assume that the virtual link has the following
   properties:

   o  The link and its interfaces are created and destroyed by the IKEv2
      process.

   o  The link is not an IPsec SA; at any time, there can be zero or
      more IPsec SAs covering traffic on this link.

   o  The link is not a single IKE SA; to support reauthentication, it
      must be possible to identify the same link in another IKE SA.

   o  Not all IPsec-protected traffic between the peers is necessarily
      related to the virtual link (although in the simplest VPN client-
      to-gateway scenario, it will be).

   Given these assumptions and the goals described in <a href="#section-3">Section 3</a>, it
   seems that the most important design choices to be made are the
   following:

   o  What link/subnet model is used; in other words, how relationships
      between VPN clients, IPv6 subnet prefixes, and link-local traffic
      (especially link-local multicast) are organized.

   o  How information about the IPv6 prefix(es) is distributed from the
      gateway to the clients.

   o  How to ensure unique IPv6 addresses for each client and keep
      forwarding state up-to-date accordingly.

   o  How layer 3 access control is done; in other words, where the
      mechanisms for preventing address spoofing by clients are placed
      architecturally.

   Each of these is discussed next in turn.








<span class="grey">Eronen, et al.                Experimental                     [Page 19]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-20" id="page-20" name="page-20"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


<span class="h1"><a class="selflink" href="#appendix-A.1" name="appendix-A.1">A.1</a>.  Link Model</span>

   There are at least three main choices for how to organize the
   relationships between VPN clients, IPv6 subnet prefixes, and link-
   local traffic:

   o  Point-to-point link model: each VPN client is assigned one or more
      IPv6 prefixes.  These prefixes are not shared with other clients,
      and there is no link-local traffic between different VPN clients
      connected to the same gateway.

   o  Multi-access link model: multiple VPN clients share the same IPv6
      prefix.  Link-local multicast packets sent by one VPN client will
      be received by other VPN clients (VPN gateway will forward the
      packets, possibly with Multicast Listener Discovery (MLD) snooping
      to remove unnecessary packets).

   o  "Router aggregation" link model: one form of "multi-link" subnet
      [<a href="#ref-Multilink" title='"Multi-Link Subnet Issues"'>Multilink</a>] where multiple VPN clients share the same IPv6 prefix.
      Link-local multicast will not be received by other VPN clients.

   In the multi-access link model, VPN clients who are idle (i.e., not
   currently sending or receiving application traffic) could receive
   significant amounts of multicast packets from other clients
   (depending on how many other clients are connected).  This is
   especially undesirable when the clients are battery-powered such as a
   PDA that keeps the VPN connection to corporate intranet active 24/7.
   For this reason, using the multi-access link model was rejected.

   The configuration attributes specified in <a href="#section-4">Section 4</a> use the point-to-
   point link model.

<span class="h1"><a class="selflink" href="#appendix-A.2" name="appendix-A.2">A.2</a>.  Distributing Prefix Information</span>

   Some types of addresses, such as CGAs, require knowledge about the
   prefix before an address can be generated.  The prefix information
   could be distributed to clients in the following ways:

   o  IKEv2 messages (configuration payloads)

   o  Router Advertisement messages (sent over the IPsec tunnel)

   o  DHCPv6 messages (sent over the IPsec tunnel)

   In <a href="#section-4">Section 4</a>, the prefix information is distributed in IKEv2
   messages.





<span class="grey">Eronen, et al.                Experimental                     [Page 20]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-21" id="page-21" name="page-21"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


<span class="h1"><a class="selflink" href="#appendix-A.3" name="appendix-A.3">A.3</a>.  Unique Address Allocation</span>

   In the "multi-access" and "router aggregation" link models (where a
   single IPv6 prefix is shared between multiple VPN clients),
   mechanisms are needed to ensure that one VPN client does not use an
   address already used by some other client.  Also, the VPN gateway has
   to know which client is using which addresses in order to correctly
   forward traffic.

   The main choices seem to be the following:

   o  Clients receive the address(es) they are allowed to use in IKEv2
      messages (configuration payloads).  In this case, keeping track of
      which client is using which address is trivial.

   o  Clients receive the address(es) they are allowed to use in DHCPv6
      messages sent over the IPsec tunnel.  In case the DHCPv6 server is
      not integrated with the VPN gateway, the gateway may need to work
      as a relay agent to keep track of which client is using which
      address (and update its forwarding state accordingly).

   o  Clients can use stateless address autoconfiguration to configure
      addresses and perform Duplicate Address Detection (DAD).  This is
      easy to do in a multi-access link model and can be made to work
      with a router aggregation link model if the VPN gateway traps
      Neighbor Solicitation (NS) messages and spoofs Neighbor
      Advertisement (NA) replies.  The gateway keeps track of which
      client is using which address (and updates its forwarding state
      accordingly) by trapping these NS/NA messages.

   In the point-to-point link model, the client can simply use any
   address from the prefix, and the VPN gateway only needs to know which
   client is using which prefix in order to forward packets correctly.

<span class="h1"><a class="selflink" href="#appendix-A.4" name="appendix-A.4">A.4</a>.  Layer 3 Access Control</span>

   It is almost always desirable to prevent one VPN client from sending
   packets with a source address that is used by another VPN client.  In
   order to correctly forward packets destined to clients, the VPN
   gateway obviously has to know which client is using which address;
   the question is therefore where, architecturally, the mechanisms for
   ingress filtering are placed.

   o  Layer 3 access control could be enforced by IPsec Security
      Association Database (SAD) / SPD; the addresses/prefixes assigned
      to a VPN client would be reflected in the traffic selectors used
      in IPsec Security Association and Security Policy Database
      entries, as negotiated in IKEv2.



<span class="grey">Eronen, et al.                Experimental                     [Page 21]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-22" id="page-22" name="page-22"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


   o  The ingress filtering capability could be placed outside IPsec;
      the traffic selectors in SAD/SPD entries would cover traffic that
      would be dropped later by ingress filtering.

   The former approach is used by the current IPv4 solution and the
   mechanism specified in <a href="#section-4">Section 4</a>.

<span class="h1"><a class="selflink" href="#appendix-A.5" name="appendix-A.5">A.5</a>.  Other Considerations</span>

   VPN gateway state

      In some combinations of design choices, the amount of state
      information required in the VPN gateway depends not only on the
      number of clients but also on the number of addresses used by one
      client.  With privacy addresses and potentially some uses of
      Cryptographically Generated Addresses (CGAs), a single client
      could have a large number of different addresses (especially if
      different privacy addresses are used with different destinations).

   Virtual link identifier

      Reauthentication requires a way to uniquely identify the virtual
      link when a second IKE SA is created.  Some possible alternatives
      are the IKE Security Parameter Indexes (SPIs) of the IKE SA where
      the virtual link was "created" (assuming we can't have multiple
      virtual links within the same IKE SA), a new identifier assigned
      when the link is created, or any unique prefix or address that
      remains assigned to the link for its entire lifetime.  <a href="#section-4">Section 4</a>
      specifies that the gateway assigns a new IKEv2 Link ID when the
      link is created.  The client treats the Link ID as an opaque octet
      string; the gateway uses it to identify relevant local state when
      reauthentication is done.

      Note that the link is not uniquely identified by the IKE peer
      identities (because IDi is often a user identity that can be used
      on multiple hosts at the same time) or the outer IP addresses of
      the peers (due to NAT Traversal and [<a href="#ref-MOBIKE" title='"IKEv2 Mobility and Multihoming Protocol (MOBIKE)"'>MOBIKE</a>]).














<span class="grey">Eronen, et al.                Experimental                     [Page 22]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-23" id="page-23" name="page-23"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


   Prefix lifetime

      Prefixes could remain valid either for the lifetime of the IKE SA,
      until explicitly cancelled, or for an explicitly specified time.
      In <a href="#section-4">Section 4</a>, the prefixes remain valid for the lifetime of the
      IKE SA (and its continuations via rekeying but not via
      reauthentication).  If necessary, the VPN gateway can thus add or
      remove prefixes by triggering reauthentication.  It is assumed
      that adding or removing prefixes is a relatively rare situation,
      and thus this document does not specify more complex solutions
      (such as explicit prefix lifetimes or use of CFG_SET/CFG_ACK).

   Compatibility with other IPsec uses

      Compatibility with other IPsec uses probably requires that when a
      CHILD_SA is created, both peers can determine whether the CHILD_SA
      applies to the virtual interface (at the end of the virtual link)
      or the real interfaces over which IKEv2 messages are being sent.
      This is required to select the correct SPD to be used for traffic-
      selector narrowing and SA authorization in general.

      One straight-forward solution is to add an extra payload to
      CREATE_CHILD_SA requests, containing the virtual link identifier.
      Requests not containing this payload would refer to the real link
      (over which IKEv2 messages are being sent).

      Another solution is to require that the peer requesting a CHILD_SA
      proposes traffic selectors that identify the link.  For example,
      if TSi includes the peer's "outer" IP address, it's probably
      related to the real interface, not the virtual one.  Or if TSi
      includes any of the prefixes assigned by the gateway (or the link-
      local or multicast prefix), it is probably related to the virtual
      interface.

      These heuristics can work in many situations but have proved
      inadequate in the context of IPv6-in-IPv4 tunnels [<a href="rfc4891.html" title='"Using IPsec to Secure IPv6-in-IPv4 Tunnels"'>RFC4891</a>],
      Provider Provisioned VPNs ([<a href="#ref-VLINK" title='"Framework for IPsec Protected Virtual Links for PPVPNs"'>VLINK</a>], [<a href="rfc3884.html" title='"Use of IPsec Transport Mode for Dynamic Routing"'>RFC3884</a>]), and Mobile IPv6
      [<a href="rfc4877.html" title='"Mobile IPv6 Operation with IKEv2 and the Revised IPsec Architecture"'>RFC4877</a>].  Thus, <a href="#section-4">Section 4</a> includes the virtual link identifier
      in all CREATE_CHILD_SA requests that apply to the virtual
      interface.

   Example of other IPsec uses:

      If a VPN gateway receives a CREATE_CHILD_SA request associated
      with a physical Ethernet interface, requesting an SA for
      (TSi=FE80::something, dst=*), it would typically reject the





<span class="grey">Eronen, et al.                Experimental                     [Page 23]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-24" id="page-24" name="page-24"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


      request (or, in other words, narrow it to an empty set) because it
      doesn't have SPD/PAD entries that would allow joe.user@example.com
      to request such CHILD_SAs.

      (However, it might have SPD/PAD entries that would allow
      "neighboring-router.example.com" to create such SAs to protect,
      for example, some routing protocol that uses link-local
      addresses.)

      However, the virtual interface created when joe.user@example.com
      authenticated and sent INTERNAL_IP6_LINK would have a different
      SPD/PAD, which would allow joe.user@example.com to create this SA.

<span class="h1"><a class="selflink" href="#appendix-A.6" name="appendix-A.6">A.6</a>.  Alternative Solution Sketches</span>

<span class="h1"><a class="selflink" href="#appendix-A.6.1" name="appendix-A.6.1">A.6.1</a>.  Version -00 Sketch</span>

   The -00 version of this document contained the following solution
   sketch, which is basically a combination of (1) a point-to-point link
   model, (2) prefix information distributed in Neighbor Advertisements,
   and (3) access control enforced outside IPsec.

   1.  During IKE_AUTH, the client sends a new configuration attribute,
       INTERNAL_IP6_LINK, which requests a virtual link to be created.
       The attribute contains the client's interface ID for the link-
       local address (other addresses may use other interface IDs).

       CP(CFG_REQUEST) =
          { INTERNAL_IP6_LINK(Link-Local Interface ID) }
       TSi = (0, 0-65535, 0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
       TSr = (0, 0-65535, 0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)  --&gt;

   The VPN gateway replies with its own link-local interface ID (which
   has to be different from the client's) and an IKEv2 Link ID (which
   will be used for reauthentication).

       CP(CFG_REPLY) =
         { INTERNAL_IP6_LINK(Link-Local Interface ID, IKEv2 Link ID) }
       TSi = (0, 0-65535, 0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
       TSr = (0, 0-65535, 0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)

   At this point, both peers configure the virtual interface with the
   link-local addresses.




<span class="grey">Eronen, et al.                Experimental                     [Page 24]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-25" id="page-25" name="page-25"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


   2.  The next step is IPv6 stateless address autoconfiguration, that
       is, Router Solicitation and Router Advertisement messages sent
       over the IPsec SA.

       ESP(Router Solicitation:
           src=::,
           dst=FF02:0:0:0:0:0:0:2)  --&gt;

       &lt;-- ESP(Router Advertisement:
               src=FE80::&lt;Gateway's Interface ID&gt;
               dst=FF02:0:0:0:0:0:0:1,
               Prefix1, [Prefix2...])

   After receiving the Router Advertisement, the client can configure
   unicast addresses from the advertised prefixes, using any proper
   interface ID.  The VPN gateway does not simultaneously assign the
   same prefixes to any other client and does not itself configure
   addresses from these prefixes.  Thus, the client does not have to
   perform Duplicate Address Detection (DAD).

   3.  Reauthentication works basically the same way as in <a href="#section-4">Section 4</a>;
       the client includes the IKEv2 Link ID in the INTERNAL_IP6_LINK
       attribute.

   4.  Creating and rekeying IPsec SAs works basically the same way as
       in <a href="#section-4.3">Section 4.3</a>; the client includes the IKEv2 Link ID in those
       CHILD_SA requests that are related to the virtual link.

   Comments: This was changed in the -01 version of this document based
   on feedback from VPN vendors; while the solution looks nice on paper,
   it is claimed to be unnecessarily complex to implement when the IKE
   implementation and IPv6 stack are from different companies.
   Furthermore, enforcing access control outside IPsec is a significant
   architectural change compared to current IPv4 solutions.

<span class="h1"><a class="selflink" href="#appendix-A.6.2" name="appendix-A.6.2">A.6.2</a>.  Router Aggregation Sketch #1</span>

   Hemant Singh helped sketch the following solution during the IETF 70
   meeting in Vancouver.  It combines (1) the router aggregation link
   model, (2) prefix information distributed in IKEv2 messages, (3)
   unique address allocation with stateless address autoconfiguration
   (with VPN gateway trapping NS messages and spoofing NA replies), and
   (4) access control enforced (partly) outside IPsec.

   1.  During IKE_AUTH, the client sends a new configuration attribute,
       INTERNAL_IP6_LINK, which requests a virtual link to be created.
       The attribute contains the client's interface ID for the link-
       local address (other addresses may use other interface IDs).



<span class="grey">Eronen, et al.                Experimental                     [Page 25]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-26" id="page-26" name="page-26"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


       CP(CFG_REQUEST) =
          { INTERNAL_IP6_LINK(Link-Local Interface ID) }
       TSi = (0, 0-65535, 0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
       TSr = (0, 0-65535, 0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)  --&gt;

   The VPN gateway replies with its own Link-Local Interface ID (which
   has to be different from the client's), an IKEv2 Link ID (which will
   be used for reauthentication and CREATE_CHILD_SA messages), and zero
   or more INTERNAL_IP6_PREFIX attributes.  The traffic selectors
   proposed by the initiator are also narrowed to contain only the
   assigned prefixes (and the link-local prefix).

       CP(CFG_REPLY) =
          { INTERNAL_IP6_LINK(Link-Local Interface ID, IKEv2 Link ID),
            INTERNAL_IP6_PREFIX(Prefix1/64),
            [INTERNAL_IP6_PREFIX(Prefix2/64),...] }
       TSi = ((0, 0-65535,
               FE80::&lt;Client's Interface ID&gt; -
               FE80::&lt;Client's Interface ID&gt;)
              (0, 0-65535,
               Prefix1::0 -
               Prefix1::FFFF:FFFF:FFFF:FFFF),
              [(0, 0-65535,
                Prefix2::0 -
                Prefix2::FFFF:FFFF:FFFF:FFFF), ...])
       TSr = (0, 0-65535,
              0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)

   2.  The client now configures tentative unicast addresses from the
       prefixes given by the gateway, and performs Duplicate Address
       Detection (DAD) for them.

       The Neighbor Solicitation messages are processed by the VPN
       gateway; if the target address is already in use by some other
       VPN client, the gateway replies with a Neighbor Advertisement.
       If the target address is not already in use, the VPN gateway
       notes that it is now being used by this client and updates its
       forwarding state accordingly.










<span class="grey">Eronen, et al.                Experimental                     [Page 26]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-27" id="page-27" name="page-27"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


   Comments: The main disadvantages of this solution are non-standard
   processing of NS messages (which are used to update the gateway's
   forwarding state), and performing access control partly outside
   IPsec.

<span class="h1"><a class="selflink" href="#appendix-A.6.3" name="appendix-A.6.3">A.6.3</a>.  Router Aggregation Sketch #2</span>

   This is basically similar to the version -00 sketch described above
   but uses the router aggregation link model.  In other words, it
   combines (1) the router aggregation link model, (2) prefix
   information distributed in Neighbor Advertisements, (3) unique
   address allocation with stateless address autoconfiguration (with the
   VPN gateway trapping NS messages and spoofing NA replies), and (4)
   access control enforced outside IPsec.

   1.  During IKE_AUTH, the client sends a new configuration attribute,
       INTERNAL_IP6_LINK, which requests a virtual link to be created.
       The attribute contains the client's interface ID for the link-
       local address (other addresses may use other interface IDs).

       CP(CFG_REQUEST) =
          { INTERNAL_IP6_LINK(Link-Local Interface ID) }
       TSi = (0, 0-65535, 0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
       TSr = (0, 0-65535, 0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)  --&gt;

   The VPN gateway replies with its own Link-Local Interface ID (which
   has to be different from the client's) and an IKEv2 Link ID (which
   will be used for reauthentication).

       CP(CFG_REPLY) =
         { INTERNAL_IP6_LINK(Link-Local Interface ID, IKEv2 Link ID) }
       TSi = (0, 0-65535, 0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
       TSr = (0, 0-65535, 0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)

   At this point, both peers configure the virtual interface with the
   link-local addresses.

   2.  The next step is IPv6 stateless address autoconfiguration, that
       is, Router Solicitation and Router Advertisement messages sent
       over the IPsec SA.







<span class="grey">Eronen, et al.                Experimental                     [Page 27]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-28" id="page-28" name="page-28"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


       ESP(Router Solicitation:
           src=::,
           dst=FF02:0:0:0:0:0:0:2)  --&gt;

       &lt;-- ESP(Router Advertisement:
               src=FE80::&lt;Gateway's Interface ID&gt;
               dst=FF02:0:0:0:0:0:0:1,
               Prefix1, [Prefix2...])

   3.  The client now configures tentative unicast addresses from the
       prefixes given by the gateway and performs Duplicate Address
       Detection (DAD) for them.

       The Neighbor Solicitation messages are processed by the VPN
       gateway; if the target address is already in use by some other
       VPN client, the gateway replies with a Neighbor Advertisement.
       If the target address is not already in use, the VPN gateway
       notes that it is now being used by this client and updates its
       forwarding state accordingly.

   Comments: The main disadvantages of this solution are non-standard
   processing of NS messages (which are used to update the gateway's
   forwarding state) and performing access control outside IPsec.

<span class="h1"><a class="selflink" href="#appendix-A.6.4" name="appendix-A.6.4">A.6.4</a>.  IPv4-Like Sketch</span>

   This sketch resembles the current IPv4 configuration payloads and
   combines (1) the router aggregation link model, (2) prefix
   information distributed in IKEv2 messages, (3) unique address
   allocation with IKEv2 messages, and (4) access control enforced by
   IPsec SAD/SPD.

   1.  During IKE_AUTH, the client sends a new configuration attribute,
       INTERNAL_IP6_LINK, which requests a virtual link to be created.
       The attribute contains the client's interface ID for the link-
       local address (other addresses may use other interface IDs).

       CP(CFG_REQUEST) =
          { INTERNAL_IP6_LINK(Link-Local Interface ID) }
       TSi = (0, 0-65535,
              0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
       TSr = (0, 0-65535,
              0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)  --&gt;






<span class="grey">Eronen, et al.                Experimental                     [Page 28]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-29" id="page-29" name="page-29"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


   The VPN gateway replies with its own Link-Local Interface ID (which
   has to be different from the client's), an IKEv2 Link ID (which will
   be used for reauthentication and CREATE_CHILD_SA messages), and zero
   or more INTERNAL_IP6_ADDRESS2 attributes.  Each attribute contains
   one address from a particular prefix.

       CP(CFG_REPLY) =
          { INTERNAL_IP6_LINK(Link-Local Interface ID, IKEv2 Link ID),
            INTERNAL_IP6_ADDRESS2(Prefix1+Client's Interface ID1),
            [INTERNAL_IP6_ADDRESS2(Prefix2+Client's Interface ID2),...],
       TSi = ((0, 0-65535,
               FE80::&lt;Client's Link-Local Interface ID&gt; -
               FE80::&lt;Client's Link-Local Interface ID&gt;)
              (0, 0-65535,
               Prefix1::&lt;Client's Interface ID1&gt; -
               Prefix1::&lt;Client's Interface ID1&gt;),
              [(0, 0-65535,
                Prefix2::&lt;Client's Interface ID2&gt; -
                Prefix2::&lt;Client's Interface ID2&gt;), ...])
       TSr = (0, 0-65535,
              0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)

   Since the VPN gateway keeps track of address uniqueness, there is no
   need to perform Duplicate Address Detection.

   2.  If the client wants additional addresses later (for example, with
       a specific interface ID), it requests them in a separate
       CREATE_CHILD_SA exchange.  For example:

       CP(CFG_REQUEST) =
          { INTERNAL_IP6_ADDRESS2(Prefix1+Client's Interface ID3) }
       TSi = (0, 0-65535,
              Prefix1::0 -
              Prefix1::FFFF:FFFF:FFFF:FFFF&gt;),
       TSr = (0, 0-65535,
              0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)  --&gt;

   If the requested address is not currently in use by some other
   client, the VPN gateway simply returns the same address and the
   appropriately narrowed traffic selectors.









<span class="grey">Eronen, et al.                Experimental                     [Page 29]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-30" id="page-30" name="page-30"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


       CP(CFG_REQUEST) =
          { INTERNAL_IP6_ADDRESS2(Prefix1+Client's Interface ID3) }
       TSi = ((0, 0-65535,
               Prefix1::&lt;Client's Interface ID3&gt; -
               Prefix1::&lt;Client's Interface ID3&gt;),
       TSr = (0, 0-65535,
              0:0:0:0:0:0:0:0 -
              FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)

   Comments: The main advantage of this solution is that it's quite
   close to the current IPv4 way of doing things.  By adding explicit
   link creation (with Link ID for reauthentication/SPD selection and
   link-local addresses) and slightly changing the semantics (and also
   name) of the INTERNAL_IP6_ADDRESS attribute (which can return more
   attributes than was asked), we get much of the needed functionality.

   The biggest disadvantages are probably potentially complex
   implementation dependency for interface ID selection (see
   <a href="#section-3.3">Section 3.3</a>) and the multi-link subnet model.

<span class="h1"><a class="selflink" href="#appendix-A.6.5" name="appendix-A.6.5">A.6.5</a>.  Sketch Based on <a href="rfc3456.html">RFC 3456</a></span>

   For completeness: a solution modeled after [<a href="rfc3456.html" title='"Dynamic Host Configuration Protocol (DHCPv4) Configuration of IPsec Tunnel Mode"'>RFC3456</a>] would combine
   (1) the router aggregation link model, (2) prefix information
   distribution and unique address allocation with DHCPv6, and (3)
   access control enforced by IPsec SAD/SPD.

























<span class="grey">Eronen, et al.                Experimental                     [Page 30]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-31" id="page-31" name="page-31"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/Appendix%20B.%20%20Evaluation%20%28Non-Normative%29"></a><a class="selflink" href="#appendix-B" name="appendix-B">Appendix B</a>.  Evaluation (Non-Normative)</span>

   <a href="#section-3">Section 3</a> describes the goals and requirements for IPv6 configuration
   in IKEv2.  This appendix briefly summarizes how the solution
   specified in Sections <a href="#section-4">4</a> and <a href="#section-5">5</a> meets these goals.

   o  (3.1) Assigning addresses from multiple prefixes is supported,
      without requiring the client to know beforehand how many prefixes
      are needed.

   o  (3.2) Link-local addresses are assigned and can be used for
      protocols between the VPN client and gateway.

   o  (3.3) The entire prefix is assigned to a single client, so the
      client can freely select any number of interface IDs (which may
      depend on the prefix).

   o  (3.4) This document does not specify how the VPN client would
      share the VPN connection with other devices.  However, since the
      entire prefix is assigned to a single client, the client could
      further assign addresses from it without requiring coordination
      with the VPN gateway.

   o  (3.5) The solution does not add any new periodic messages over the
      VPN tunnel.

   o  (3.5) Reauthentication works (see <a href="#section-4.2">Section 4.2</a>).

   o  (3.5) The solution is compatible with other IPsec uses since the
      LINK_ID notification makes it unambiguous which CHILD_SAs are
      related to the virtual link and which are not (see Sections <a href="#section-4.3">4.3</a>
      and 5.3).

   o  (3.5) The new mechanisms do not prevent the VPN client and/or
      gateway from implementing the INTERNAL_IP6_ADDRESS configuration
      attribute as well; however, the two mechanisms are not intended to
      be used simultaneously (see <a href="#section-4.5">Section 4.5</a>).

   o  (3.5) Implementation dependencies are, obviously, implementation
      dependent (and their cleanliness somewhat subjective).  Possible
      drawbacks of some alternative solutions are discussed in
      <a href="#appendix-A.6">Appendix A.6</a>.

   o  (3.5) The mechanism for configuring the prefixes (configuration
      payloads) is specific to IKEv2, for reasons described in
      <a href="#appendix-A">Appendix A</a>.  However, <a href="#section-4.1">Section 4.1</a> recommends using DHCPv6
      Information-Request message for obtaining other configuration
      information (such as DNS server addresses).



<span class="grey">Eronen, et al.                Experimental                     [Page 31]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-32" id="page-32" name="page-32"> </a>
<span class="grey"><a href="rfc5739.html">RFC 5739</a>               IPv6 Configuration in IKEv2         February 2010</span>


Authors' Addresses

   Pasi Eronen
   Nokia Research Center
   P.O. Box 407
   FIN-00045 Nokia Group
   Finland

   EMail: pasi.eronen@nokia.com


   Julien Laganier
   QUALCOMM Incorporated
   5775 Morehouse Drive
   San Diego, CA  92121
   USA

   Phone: +1 858 658 3538
   EMail: julienl@qualcomm.com


   Cheryl Madson
   Cisco Systems, Inc.
   510 MacCarthy Drive
   Milpitas, CA
   USA

   EMail: cmadson@cisco.com























Eronen, et al.                Experimental                     [Page 32]

</pre><br/>
<span class="noprint"><small><small>Html markup produced by rfcmarkup 1.107, available from
<a href="http://tools.ietf.org/tools/rfcmarkup/">http://tools.ietf.org/tools/rfcmarkup/</a>
</small></small></span>


<meta content="text/html;charset=utf-8" http-equiv="content-type"/><!-- /Added by HTTrack -->

</body><!-- Mirrored from tools.ietf.org/html/rfc5739 by HTTrack Website Copier/3.x [XR&CO'2010], Wed, 19 Mar 2014 18:36:11 GMT --><!-- Added by HTTrack --></html>