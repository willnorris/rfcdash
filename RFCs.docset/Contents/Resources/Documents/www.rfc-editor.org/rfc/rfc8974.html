<!DOCTYPE html>
<html class="RFC" lang="en"><head>
<meta charset="utf-8"/>
<meta content="Common,Latin" name="scripts"/>
<meta content="initial-scale=1.0" name="viewport"/>
<title>RFC 8974: Extended Tokens and Stateless Clients in the Constrained Application Protocol (CoAP)</title>
<meta content="Klaus Hartke" name="author"/>
<meta content="Michael C. Richardson" name="author"/>
<meta content='
       
        This document provides considerations for alleviating Constrained Application Protocol (CoAP) clients and
        intermediaries of keeping per-request state. To facilitate this, this
        document additionally introduces a new, optional CoAP protocol extension
        for extended token lengths.
       
       
        This document updates RFCs 7252 and 8323 with an extended definition of the
        "TKL" field in the CoAP message header.
       
    ' name="description"/>
<meta content="xml2rfc 3.5.0" name="generator"/>
<meta content="6tisch" name="keyword"/>
<meta content="minimal-security" name="keyword"/>
<meta content="8974" name="rfc.number"/>
<!-- Generator version information:
  xml2rfc 3.5.0
    Python 3.6.10
    appdirs 1.4.4
    ConfigArgParse 1.2.3
    google-i18n-address 2.3.5
    html5lib 1.0.1
    intervaltree 3.0.2
    Jinja2 2.11.2
    kitchen 1.2.6
    lxml 4.4.2
    pycairo 1.19.0
    pycountry 19.8.18
    pyflakes 2.1.1
    PyYAML 5.3.1
    requests 2.22.0
    setuptools 40.6.2
    six 1.14.0
    WeasyPrint 51
-->
<link href="rfc8974.xml" rel="alternate" type="application/rfc+xml"/>
<link href="#copyright" rel="license"/>
<style type="text/css">/*

  NOTE: Changes at the bottom of this file overrides some earlier settings.

  Once the style has stabilized and has been adopted as an official RFC style,
  this can be consolidated so that style settings occur only in one place, but
  for now the contents of this file consists first of the initial CSS work as
  provided to the RFC Formatter (xml2rfc) work, followed by itemized and
  commented changes found necssary during the development of the v3
  formatters.

*/

/* fonts */
@import url('https://fonts.googleapis.com/css?family=Noto+Sans'); /* Sans-serif */
@import url('https://fonts.googleapis.com/css?family=Noto+Serif'); /* Serif (print) */
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono'); /* Monospace */

@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}
/* general and mobile first */
html {
}
body {
  max-width: 90%;
  margin: 1.5em auto;
  color: #222;
  background-color: #fff;
  font-size: 14px;
  font-family: 'Noto Sans', Arial, Helvetica, sans-serif;
  line-height: 1.6;
  scroll-behavior: smooth;
}
.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  margin: 1em 0 0.5em;
  font-weight: bold;
  line-height: 1.3;
}
#title {
  clear: both;
  border-bottom: 1px solid #ddd;
  margin: 0 0 0.5em 0;
  padding: 1em 0 0.5em;
}
.author {
  padding-bottom: 4px;
}
h1 {
  font-size: 26px;
  margin: 1em 0;
}
h2 {
  font-size: 22px;
  margin-top: -20px;  /* provide offset for in-page anchors */
  padding-top: 33px;
}
h3 {
  font-size: 18px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h4 {
  font-size: 16px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h5, h6 {
  font-size: 14px;
}
#n-copyright-notice {
  border-bottom: 1px solid #ddd;
  padding-bottom: 1em;
  margin-bottom: 1em;
}
/* general structure */
p {
  padding: 0;
  margin: 0 0 1em 0;
  text-align: left;
}
div, span {
  position: relative;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignRight.art-text pre {
  padding: 0;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
.alignCenter.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignCenter.art-text pre {
  padding: 0;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 1em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
/* 
dl.nohang > dt {
  float: none;
}
*/
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}

/* links */
a {
  text-decoration: none;
}
a[href] {
  color: #22e; /* Arlen: WCAG 2019 */
}
a[href]:hover {
  background-color: #f2f2f2;
}
figcaption a[href],
a[href].selfRef {
  color: #222;
}
/* XXX probably not this:
a.selfRef:hover {
  background-color: transparent;
  cursor: default;
} */

/* Figures */
tt, code, pre, code {
  background-color: #f9f9f9;
  font-family: 'Roboto Mono', monospace;
}
pre {
  border: 1px solid #eee;
  margin: 0;
  padding: 1em;
}
img {
  max-width: 100%;
}
figure {
  margin: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption {
  font-style: italic;
  margin: 0 0 1em 0;
}
@media screen {
  pre {
    overflow-x: auto;
    max-width: 100%;
    max-width: calc(100% - 22px);
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 1.2em 2em;
}
blockquote {
  background-color: #f9f9f9;
  color: #111; /* Arlen: WCAG 2019 */
  border: 1px solid #ddd;
  border-radius: 3px;
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
  border: 1px solid #eee;
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 0.5em 0.75em;
}
th {
  text-align: left;
  background-color: #e9e9e9;
}
tr:nth-child(2n+1) > td {
  background-color: #f5f5f5;
}
table caption {
  font-style: italic;
  margin: 0;
  padding: 0;
  text-align: left;
}
table p {
  /* XXX to avoid bottom margin on table row signifiers. If paragraphs should
     be allowed within tables more generally, it would be far better to select on a class. */
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  color: #666; /* Arlen: AHDJ 2019 */
  text-decoration: none;
  visibility: hidden;
  user-select: none;
  -ms-user-select: none;
  -o-user-select:none;
  -moz-user-select: none;
  -khtml-user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}
@media screen {
  aside:hover > a.pilcrow,
  p:hover > a.pilcrow,
  blockquote:hover > a.pilcrow,
  div:hover > a.pilcrow,
  li:hover > a.pilcrow,
  pre:hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid #eee;
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: 0.9em;
}
#identifiers dt {
  width: 3em;
  clear: left;
}
#identifiers dd {
  float: left;
  margin-bottom: 0;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #666; /* Arlen: WCAG 2019 */
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc  {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
nav.toc ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
nav.toc li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 600px) {
  .index ul {
    -moz-column-count: 2;
    -moz-column-gap: 20px;
  }
  .index ul ul {
    -moz-column-count: 1;
    -moz-column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}

address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  font-family: "Noto Sans",Arial,Helvetica,sans-serif;
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}

/* temporary notes */
.rfcEditorRemove::before {
  position: absolute;
  top: 0.2em;
  right: 0.2em;
  padding: 0.2em;
  content: "The RFC Editor will remove this note";
  color: #9e2a00; /* Arlen: WCAG 2019 */
  background-color: #ffd; /* Arlen: WCAG 2019 */
}
.rfcEditorRemove {
  position: relative;
  padding-top: 1.8em;
  background-color: #ffd; /* Arlen: WCAG 2019 */
  border-radius: 3px;
}
.cref {
  background-color: #ffd; /* Arlen: WCAG 2019 */
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 1023px) {
  body {
    padding-top: 2em;
  }
  #title {
    padding: 1em 0;
  }
  h1 {
    font-size: 24px;
  }
  h2 {
    font-size: 20px;
    margin-top: -18px;  /* provide offset for in-page anchors */
    padding-top: 38px;
  }
  #identifiers dd {
    max-width: 60%;
  }
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    background-color: inherit;
    border-bottom: 1px solid #ccc;
  }
  #toc h2 {
    margin: -1px 0 0 0;
    padding: 4px 0 4px 6px;
    padding-right: 1em;
    min-width: 190px;
    font-size: 1.1em;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 6px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    padding: 0.5em 1em 1em;
    overflow: auto;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 1024px) {
  body {
    max-width: 724px;
    margin: 42px auto;
    padding-left: 1.5em;
    padding-right: 29em;
  }
  #toc {
    position: fixed;
    top: 42px;
    right: 42px;
    width: 25%;
    margin: 0;
    padding: 0 1em;
    z-index: 1;
  }
  #toc h2 {
    border-top: none;
    border-bottom: 1px solid #ddd;
    font-size: 1em;
    font-weight: normal;
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 0;
    overflow: auto;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {

    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

/* This is commented out here, as the string-set: doesn't
   pass W3C validation currently */
/*
.ears thead .left {
  string-set: ears-top-left content();
}

.ears thead .center {
  string-set: ears-top-center content();
}

.ears thead .right {
  string-set: ears-top-right content();
}

.ears tfoot .left {
  string-set: ears-bottom-left content();
}

.ears tfoot .center {
  string-set: ears-bottom-center content();
}

.ears tfoot .right {
  string-set: ears-bottom-right content();
}
*/

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
  /* The follwing is commented out here, but set appropriately by in code, as
     the content depends on the document */
  /*
  @top-left {
    content: 'Internet-Draft';
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-left {
    content: string(ears-top-left);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-center {
    content: string(ears-top-center);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-right {
    content: string(ears-top-right);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @bottom-left {
    content: string(ears-bottom-left);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-center {
    content: string(ears-bottom-center);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-right {
      content: '[Page ' counter(page) ']';
      vertical-align: top;
      border-top: solid 1px #ccc;
  }
  */

}

/* Changes introduced to fix issues found during implementation */
/* Make sure links are clickable even if overlapped by following H* */
a {
  z-index: 2;
}
/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}


/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Leave room in document info to show Internet-Draft on one line */
#identifiers dt {
  width: 8em;
}

/* Don't waste quite as much whitespace between label and value in doc info */
#identifiers dd {
  margin-left: 1em;
}

/* Give floating toc a background color (needed when it's a div inside section */
#toc {
  background-color: white;
}

/* Make the collapsed ToC header render white on gray also when it's a link */
@media screen and (max-width: 1023px) {
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
}

/* Give the bottom of the ToC some whitespace */
@media screen and (min-width: 1024px) {
  #toc {
    padding: 0 0 1em 1em;
  }
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* prevent monospace from becoming overly large */
tt, code, pre, code {
  font-size: 95%;
}

/* Fix the height/width aspect for ascii art*/
pre.sourcecode,
.art-text pre {
  line-height: 1.12;
}


/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin-right: 0.5em;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table td.text-left,
table th.text-left {
  text-align: left;
}
table td.text-center,
table th.text-center {
  text-align: center;
}
table td.text-right,
table th.text-right {
  text-align: right;
}

/* Make the alternative author contact informatio look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 30em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Provide table alignment support.  We can't use the alignX classes above
   since they do unwanted things with caption and other styling. */
table.right {
 margin-left: auto;
 margin-right: 0;
}
table.center {
 margin-left: auto;
 margin-right: auto;
}
table.left {
 margin-left: 0;
 margin-right: auto;
}

/* Give the table caption label the same styling as the figcaption */
caption a[href] {
  color: #222;
}

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
/* Tweak the invisible space above H* in order not to overlay links in text above */
 h2 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 31px;
 }
 h3 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
 h4 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
/* Float artwork pilcrow to the right */
@media screen {
  .artwork a.pilcrow {
    display: block;
    line-height: 0.7;
    margin-top: 0.15em;
  }
}
/* Make pilcrows on dd visible */
@media screen {
  dd:hover > a.pilcrow {
    visibility: visible;
  }
}
/* Make the placement of figcaption match that of a table's caption
   by removing the figure's added bottom margin */
.alignLeft.art-text,
.alignCenter.art-text,
.alignRight.art-text {
   margin-bottom: 0;
}
.alignLeft,
.alignCenter,
.alignRight {
  margin: 1em 0 0 0;
}
/* In print, the pilcrow won't show on hover, so prevent it from taking up space,
   possibly even requiring a new line */
@media print {
  a.pilcrow {
    display: none;
  }
}
/* Styling for the external metadata */
div#external-metadata {
  background-color: #eee;
  padding: 0.5em;
  margin-bottom: 0.5em;
  display: none;
}
div#internal-metadata {
  padding: 0.5em;                       /* to match the external-metadata padding */
}
/* Styling for title RFC Number */
h1#rfcnum {
  clear: both;
  margin: 0 0 -1em;
  padding: 1em 0 0 0;
}
/* Make .olPercent look the same as <ol><li> */
dl.olPercent > dd {
  margin-bottom: 0.25em;
  min-height: initial;
}
/* Give aside some styling to set it apart */
aside {
  border-left: 1px solid #ddd;
  margin: 1em 0 1em 2em;
  padding: 0.2em 2em;
}
aside > dl,
aside > ol,
aside > ul,
aside > table,
aside > p {
  margin-bottom: 0.5em;
}
/* Additional page break settings */
@media print {
  figcaption, table caption {
    page-break-before: avoid;
  }
}
/* Font size adjustments for print */
@media print {
  body  { font-size: 10pt;      line-height: normal; max-width: 96%; }
  h1    { font-size: 1.72em;    padding-top: 1.5em; } /* 1*1.2*1.2*1.2 */
  h2    { font-size: 1.44em;    padding-top: 1.5em; } /* 1*1.2*1.2 */
  h3    { font-size: 1.2em;     padding-top: 1.5em; } /* 1*1.2 */
  h4    { font-size: 1em;       padding-top: 1.5em; }
  h5, h6 { font-size: 1em;      margin: initial; padding: 0.5em 0 0.3em; }
}
/* Sourcecode margin in print, when there's no pilcrow */
@media print {
  .artwork,
  .sourcecode {
    margin-bottom: 1em;
  }
}
/* Avoid narrow tables forcing too narrow table captions, which may render badly */
table {
  min-width: 20em;
}
/* ol type a */
ol.type-a { list-style-type: lower-alpha; }
ol.type-A { list-style-type: upper-alpha; }
ol.type-i { list-style-type: lower-roman; }
ol.type-I { list-style-type: lower-roman; }
/* Apply the print table and row borders in general, on request from the RPC,
and increase the contrast between border and odd row background sligthtly */
table {
  border: 1px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
}
tr:nth-child(2n+1) > td {
  background-color: #f8f8f8;
}
/* Use style rules to govern display of the TOC. */
@media screen and (max-width: 1023px) {
  #toc nav { display: none; }
  #toc.active nav { display: block; }
}
/* Add support for keepWithNext */
.keepWithNext {
  break-after: avoid-page;
  break-after: avoid-page;
}
/* Add support for keepWithPrevious */
.keepWithPrevious {
  break-before: avoid-page;
}
/* Change the approach to avoiding breaks inside artwork etc. */
figure, pre, table, .artwork, .sourcecode  {
  break-before: avoid-page;
  break-after: auto;
}
/* Avoid breaks between <dt> and <dd> */
dl {
  break-before: auto;
  break-inside: auto;
}
dt {
  break-before: auto;
  break-after: avoid-page;
}
dd {
  break-before: avoid-page;
  break-after: auto;
  orphans: 3;
  widows: 3
}
span.break, dd.break {
  margin-bottom: 0;
  min-height: 0;
  break-before: auto;
  break-inside: auto;
  break-after: auto;
}
/* Undo break-before ToC */
@media print {
  #toc {
    break-before: auto;
  }
}
/* Text in compact lists should not get extra bottim margin space,
   since that would makes the list not compact */
ul.compact p, .ulCompact p,
ol.compact p, .olCompact p {
 margin: 0;
}
/* But the list as a whole needs the extra space at the end */
section ul.compact,
section .ulCompact,
section ol.compact,
section .olCompact {
  margin-bottom: 1em;                    /* same as p not within ul.compact etc. */
}
/* The tt and code background above interferes with for instance table cell
   backgrounds.  Changed to something a bit more selective. */
tt, code {
  background-color: transparent;
}
p tt, p code, li tt, li code {
  background-color: #f8f8f8;
}
/* Tweak the pre margin -- 0px doesn't come out well */
pre {
   margin-top: 0.5px;
}
/* Tweak the comact list text */
ul.compact, .ulCompact,
ol.compact, .olCompact,
dl.compact, .dlCompact {
  line-height: normal;
}
/* Don't add top margin for nested lists */
li > ul, li > ol, li > dl,
dd > ul, dd > ol, dd > dl,
dl > dd > dl {
  margin-top: initial;
}
/* Elements that should not be rendered on the same line as a <dt> */
/* This should match the element list in writer.text.TextWriter.render_dl() */
dd > div.artwork:first-child,
dd > aside:first-child,
dd > figure:first-child,
dd > ol:first-child,
dd > div:first-child > pre.sourcecode,
dd > table:first-child,
dd > ul:first-child {
  clear: left;
}
/* fix for weird browser behaviour when <dd/> is empty */
dt+dd:empty::before{
  content: "\00a0";
}
</style>
<link href="rfc-local.css" rel="stylesheet" type="text/css"/>
<link href="https://dx.doi.org/10.17487/rfc8974" rel="alternate"/>
  <link href="urn:issn:2070-1721" rel="alternate"/>
  <link href="https://datatracker.ietf.org/doc/draft-ietf-core-stateless-08" rel="prev"/>
  </head>
<body>
<script src="https://www.rfc-editor.org/js/metadata.min.js"></script>
<table class="ears">
<thead><tr>
<td class="left">RFC 8974</td>
<td class="center">Extended Tokens in CoAP</td>
<td class="right">January 2021</td>
</tr></thead>
<tfoot><tr>
<td class="left">Hartke &amp; Richardson</td>
<td class="center">Standards Track</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div class="document-information" id="external-metadata"></div>
<div class="document-information" id="internal-metadata">
<dl id="identifiers">
<dt class="label-stream">Stream:</dt>
<dd class="stream">Internet Engineering Task Force (IETF)</dd>
<dt class="label-rfc">RFC:</dt>
<dd class="rfc"><a class="eref" href="https://www.rfc-editor.org/rfc/rfc8974">8974</a></dd>
<dt class="label-updates">Updates:</dt>
<dd class="updates">
<a class="eref" href="https://www.rfc-editor.org/rfc/rfc7252">7252</a>, <a class="eref" href="https://www.rfc-editor.org/rfc/rfc8323">8323</a> </dd>
<dt class="label-category">Category:</dt>
<dd class="category">Standards Track</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time class="published" datetime="2021-01">January 2021</time>
    </dd>
<dt class="label-issn">ISSN:</dt>
<dd class="issn">2070-1721</dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">K. Hartke</div>
<div class="org">Ericsson</div>
</div>
<div class="author">
      <div class="author-name">M. Richardson</div>
<div class="org">Sandelman</div>
</div>
</dd>
</dl>
</div>
<h1 id="rfcnum">RFC 8974</h1>
<h1 id="title">Extended Tokens and Stateless Clients in the Constrained Application Protocol (CoAP)</h1>
<section id="section-abstract">
      <h2 id="abstract"><a class="selfRef" href="#abstract">Abstract</a></h2>
<p id="section-abstract-1">
        This document provides considerations for alleviating Constrained Application Protocol (CoAP) clients and
        intermediaries of keeping per-request state. To facilitate this, this
        document additionally introduces a new, optional CoAP protocol extension
        for extended token lengths.<a class="pilcrow" href="#section-abstract-1">¶</a></p>
<p id="section-abstract-2">
        This document updates RFCs 7252 and 8323 with an extended definition of the
        "TKL" field in the CoAP message header.<a class="pilcrow" href="#section-abstract-2">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a class="section-name selfRef" href="#name-status-of-this-memo">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
            This is an Internet Standards Track document.<a class="pilcrow" href="#section-boilerplate.1-1">¶</a></p>
<p id="section-boilerplate.1-2">
            This document is a product of the Internet Engineering Task Force
            (IETF).  It represents the consensus of the IETF community.  It has
            received public review and has been approved for publication by
            the Internet Engineering Steering Group (IESG).  Further
            information on Internet Standards is available in Section 2 of 
            RFC 7841.<a class="pilcrow" href="#section-boilerplate.1-2">¶</a></p>
<p id="section-boilerplate.1-3">
            Information about the current status of this document, any
            errata, and how to provide feedback on it may be obtained at
            <span><a href="https://www.rfc-editor.org/info/rfc8974">https://www.rfc-editor.org/info/rfc8974</a></span>.<a class="pilcrow" href="#section-boilerplate.1-3">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a class="section-name selfRef" href="#name-copyright-notice">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2021 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a class="pilcrow" href="#section-boilerplate.2-1">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Simplified BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Simplified BSD License.<a class="pilcrow" href="#section-boilerplate.2-2">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a class="toplink" href="#" onclick="scroll(0,0)">▲</a><h2 id="name-table-of-contents">
<a class="section-name selfRef" href="#name-table-of-contents">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="toc ulEmpty compact">
<li class="toc ulEmpty compact" id="section-toc.1-1.1">
            <p class="keepWithNext" id="section-toc.1-1.1.1"><a class="xref" href="#section-1">1</a>.  <a class="xref" href="#name-introduction">Introduction</a><a class="pilcrow" href="#section-toc.1-1.1.1">¶</a></p>
<ul class="toc ulEmpty compact">
<li class="toc ulEmpty compact" id="section-toc.1-1.1.2.1">
                <p class="keepWithNext" id="section-toc.1-1.1.2.1.1"><a class="xref" href="#section-1.1">1.1</a>.  <a class="xref" href="#name-terminology">Terminology</a><a class="pilcrow" href="#section-toc.1-1.1.2.1.1">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc ulEmpty compact" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1"><a class="xref" href="#section-2">2</a>.  <a class="xref" href="#name-extended-tokens">Extended Tokens</a><a class="pilcrow" href="#section-toc.1-1.2.1">¶</a></p>
<ul class="toc ulEmpty compact">
<li class="toc ulEmpty compact" id="section-toc.1-1.2.2.1">
                <p class="keepWithNext" id="section-toc.1-1.2.2.1.1"><a class="xref" href="#section-2.1">2.1</a>.  <a class="xref" href="#name-extended-token-length-tkl-f">Extended Token Length (TKL) Field</a><a class="pilcrow" href="#section-toc.1-1.2.2.1.1">¶</a></p>
</li>
              <li class="toc ulEmpty compact" id="section-toc.1-1.2.2.2">
                <p id="section-toc.1-1.2.2.2.1"><a class="xref" href="#section-2.2">2.2</a>.  <a class="xref" href="#name-discovering-support">Discovering Support</a><a class="pilcrow" href="#section-toc.1-1.2.2.2.1">¶</a></p>
<ul class="toc ulEmpty compact">
<li class="toc ulEmpty compact" id="section-toc.1-1.2.2.2.2.1">
                    <p id="section-toc.1-1.2.2.2.2.1.1"><a class="xref" href="#section-2.2.1">2.2.1</a>.  <a class="xref" href="#name-extended-token-length-capab">Extended-Token-Length Capability Option</a><a class="pilcrow" href="#section-toc.1-1.2.2.2.2.1.1">¶</a></p>
</li>
                  <li class="toc ulEmpty compact" id="section-toc.1-1.2.2.2.2.2">
                    <p id="section-toc.1-1.2.2.2.2.2.1"><a class="xref" href="#section-2.2.2">2.2.2</a>.  <a class="xref" href="#name-trial-and-error">Trial and Error</a><a class="pilcrow" href="#section-toc.1-1.2.2.2.2.2.1">¶</a></p>
</li>
                </ul>
</li>
              <li class="toc ulEmpty compact" id="section-toc.1-1.2.2.3">
                <p id="section-toc.1-1.2.2.3.1"><a class="xref" href="#section-2.3">2.3</a>.  <a class="xref" href="#name-intermediaries">Intermediaries</a><a class="pilcrow" href="#section-toc.1-1.2.2.3.1">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc ulEmpty compact" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a class="xref" href="#section-3">3</a>.  <a class="xref" href="#name-stateless-clients">Stateless Clients</a><a class="pilcrow" href="#section-toc.1-1.3.1">¶</a></p>
<ul class="toc ulEmpty compact">
<li class="toc ulEmpty compact" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a class="xref" href="#section-3.1">3.1</a>.  <a class="xref" href="#name-serializing-client-state">Serializing Client State</a><a class="pilcrow" href="#section-toc.1-1.3.2.1.1">¶</a></p>
</li>
              <li class="toc ulEmpty compact" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a class="xref" href="#section-3.2">3.2</a>.  <a class="xref" href="#name-using-extended-tokens">Using Extended Tokens</a><a class="pilcrow" href="#section-toc.1-1.3.2.2.1">¶</a></p>
</li>
              <li class="toc ulEmpty compact" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a class="xref" href="#section-3.3">3.3</a>.  <a class="xref" href="#name-transmitting-messages">Transmitting Messages</a><a class="pilcrow" href="#section-toc.1-1.3.2.3.1">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc ulEmpty compact" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a class="xref" href="#section-4">4</a>.  <a class="xref" href="#name-stateless-intermediaries">Stateless Intermediaries</a><a class="pilcrow" href="#section-toc.1-1.4.1">¶</a></p>
<ul class="toc ulEmpty compact">
<li class="toc ulEmpty compact" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a class="xref" href="#section-4.1">4.1</a>.  <a class="xref" href="#name-observing-resources">Observing Resources</a><a class="pilcrow" href="#section-toc.1-1.4.2.1.1">¶</a></p>
</li>
              <li class="toc ulEmpty compact" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a class="xref" href="#section-4.2">4.2</a>.  <a class="xref" href="#name-block-wise-transfers">Block-Wise Transfers</a><a class="pilcrow" href="#section-toc.1-1.4.2.2.1">¶</a></p>
</li>
              <li class="toc ulEmpty compact" id="section-toc.1-1.4.2.3">
                <p id="section-toc.1-1.4.2.3.1"><a class="xref" href="#section-4.3">4.3</a>.  <a class="xref" href="#name-gateway-timeouts">Gateway Timeouts</a><a class="pilcrow" href="#section-toc.1-1.4.2.3.1">¶</a></p>
</li>
              <li class="toc ulEmpty compact" id="section-toc.1-1.4.2.4">
                <p id="section-toc.1-1.4.2.4.1"><a class="xref" href="#section-4.4">4.4</a>.  <a class="xref" href="#name-extended-tokens-2">Extended Tokens</a><a class="pilcrow" href="#section-toc.1-1.4.2.4.1">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc ulEmpty compact" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a class="xref" href="#section-5">5</a>.  <a class="xref" href="#name-security-considerations">Security Considerations</a><a class="pilcrow" href="#section-toc.1-1.5.1">¶</a></p>
<ul class="toc ulEmpty compact">
<li class="toc ulEmpty compact" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a class="xref" href="#section-5.1">5.1</a>.  <a class="xref" href="#name-extended-tokens-3">Extended Tokens</a><a class="pilcrow" href="#section-toc.1-1.5.2.1.1">¶</a></p>
</li>
              <li class="toc ulEmpty compact" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a class="xref" href="#section-5.2">5.2</a>.  <a class="xref" href="#name-stateless-clients-and-inter">Stateless Clients and Intermediaries</a><a class="pilcrow" href="#section-toc.1-1.5.2.2.1">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc ulEmpty compact" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a class="xref" href="#section-6">6</a>.  <a class="xref" href="#name-iana-considerations">IANA Considerations</a><a class="pilcrow" href="#section-toc.1-1.6.1">¶</a></p>
<ul class="toc ulEmpty compact">
<li class="toc ulEmpty compact" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a class="xref" href="#section-6.1">6.1</a>.  <a class="xref" href="#name-coap-signaling-option-numbe">CoAP Signaling Option Number</a><a class="pilcrow" href="#section-toc.1-1.6.2.1.1">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc ulEmpty compact" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a class="xref" href="#section-7">7</a>.  <a class="xref" href="#name-references">References</a><a class="pilcrow" href="#section-toc.1-1.7.1">¶</a></p>
<ul class="toc ulEmpty compact">
<li class="toc ulEmpty compact" id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a class="xref" href="#section-7.1">7.1</a>.  <a class="xref" href="#name-normative-references">Normative References</a><a class="pilcrow" href="#section-toc.1-1.7.2.1.1">¶</a></p>
</li>
              <li class="toc ulEmpty compact" id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a class="xref" href="#section-7.2">7.2</a>.  <a class="xref" href="#name-informative-references">Informative References</a><a class="pilcrow" href="#section-toc.1-1.7.2.2.1">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc ulEmpty compact" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a class="xref" href="#section-appendix.a">Appendix A</a>.  <a class="xref" href="#name-updated-message-formats">Updated Message Formats</a><a class="pilcrow" href="#section-toc.1-1.8.1">¶</a></p>
<ul class="toc ulEmpty compact">
<li class="toc ulEmpty compact" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a class="xref" href="#section-a.1">A.1</a>.  <a class="xref" href="#name-coap-over-udp">CoAP over UDP</a><a class="pilcrow" href="#section-toc.1-1.8.2.1.1">¶</a></p>
</li>
              <li class="toc ulEmpty compact" id="section-toc.1-1.8.2.2">
                <p id="section-toc.1-1.8.2.2.1"><a class="xref" href="#section-a.2">A.2</a>.  <a class="xref" href="#name-coap-over-tcp-tls">CoAP over TCP/TLS</a><a class="pilcrow" href="#section-toc.1-1.8.2.2.1">¶</a></p>
</li>
              <li class="toc ulEmpty compact" id="section-toc.1-1.8.2.3">
                <p id="section-toc.1-1.8.2.3.1"><a class="xref" href="#section-a.3">A.3</a>.  <a class="xref" href="#name-coap-over-websockets">CoAP over WebSockets</a><a class="pilcrow" href="#section-toc.1-1.8.2.3.1">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc ulEmpty compact" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a class="xref" href="#section-appendix.b"></a><a class="xref" href="#name-acknowledgements">Acknowledgements</a><a class="pilcrow" href="#section-toc.1-1.9.1">¶</a></p>
</li>
          <li class="toc ulEmpty compact" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a class="xref" href="#section-appendix.c"></a><a class="xref" href="#name-authors-addresses">Authors' Addresses</a><a class="pilcrow" href="#section-toc.1-1.10.1">¶</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a class="section-number selfRef" href="#section-1">1. </a><a class="section-name selfRef" href="#name-introduction">Introduction</a>
      </h2>
<p id="section-1-1">
        The Constrained Application Protocol (CoAP) <span>[<a class="xref" href="#RFC7252">RFC7252</a>]</span> is
        a RESTful application-layer protocol for <span><a class="xref" href="#RFC7228">constrained environments</a> [<a class="xref" href="#RFC7228">RFC7228</a>]</span>. In CoAP, clients (or
        intermediaries in the client role) make requests to servers (or
        intermediaries in the server role), which satisfy the requests by
        returning responses.<a class="pilcrow" href="#section-1-1">¶</a></p>
<p id="section-1-2">
        While a request is ongoing, a client typically needs to keep some state that
        it requires for processing the response when that arrives. Identification
        of this state is done in CoAP by means of a token: an
        opaque sequence of bytes that is chosen by the client and included in the CoAP
        request and that is returned by the server verbatim in any resulting CoAP
        response (<a class="xref" href="#stateful-exchange">Figure 1</a>).<a class="pilcrow" href="#section-1-2">¶</a></p>
<span id="name-token-as-an-identifier-for-"></span><div id="stateful-exchange">
<figure id="figure-1">
        <div class="artwork art-text alignCenter" id="section-1-3.1">
<pre>+-----------------+     request with     +------------+
|        |        |   state identifier   |            |
|        |        |       as token       |            |
|    .-&lt;-+-&gt;------|---------------------&gt;|------.     |
|   _|_           |                      |      |     |
|  /   \ stored   |                      |      |     |
|  \___/ state    |                      |      |     |
|    |            |                      |      |     |
|    '-&gt;-+-&lt;------|&lt;---------------------|------'     |
|        |        |     response with    |            |
|        v        |   token echoed back  |            |
+-----------------+                      +------------+
      Client                                 Server
</pre>
</div>
<figcaption><a class="selfRef" href="#figure-1">Figure 1</a>:
<a class="selfRef" href="#name-token-as-an-identifier-for-">Token as an Identifier for Request State</a>
        </figcaption></figure>
</div>
<p id="section-1-4">
        In some scenarios, it can be beneficial to reduce the amount of state
        that is stored at the client at the cost of increased message sizes. A client can
        opt into this by serializing (parts of) its state into the token itself and then
        recovering this state from the token in the response (<a class="xref" href="#stateless-exchange">Figure 2</a>).<a class="pilcrow" href="#section-1-4">¶</a></p>
<span id="name-token-as-serialization-of-r"></span><div id="stateless-exchange">
<figure id="figure-2">
        <div class="artwork art-text alignCenter" id="section-1-5.1">
<pre>+-----------------+     request with     +------------+
|        |        |   serialized state   |            |
|        |        |       as token       |            |
|        +--------|=====================&gt;|------.     |
|                 |                      |      |     |
|    look ma,     |                      |      |     |
|    no state!    |                      |      |     |
|                 |                      |      |     |
|        +--------|&lt;=====================|------'     |
|        |        |     response with    |            |
|        v        |   token echoed back  |            |
+-----------------+                      +------------+
      Client                                 Server
</pre>
</div>
<figcaption><a class="selfRef" href="#figure-2">Figure 2</a>:
<a class="selfRef" href="#name-token-as-serialization-of-r">Token as Serialization of Request State</a>
        </figcaption></figure>
</div>
<p id="section-1-6">
        <a class="xref" href="#stateless-clients">Section 3</a> of this document provides
        considerations for clients becoming "stateless" in this way.
        (The term "stateless" is in quotes here, because it's a bit
        oversimplified. Such clients still need to maintain per-server state and other
        kinds of state. So it would be more accurate to
        just say that the clients are avoiding per-request state.)<a class="pilcrow" href="#section-1-6">¶</a></p>
<p id="section-1-7">
        <a class="xref" href="#stateless-intermediaries">Section 4</a> of this document
        extends the considerations for clients to intermediaries, which
        may want to avoid keeping state for not only the requests they
        send to servers but also the requests they receive from
        clients.<a class="pilcrow" href="#section-1-7">¶</a></p>
<p id="section-1-8">
        The serialization of state into tokens is limited by the fact
        that both <span><a class="xref" href="#RFC7252">CoAP over UDP</a> [<a class="xref" href="#RFC7252">RFC7252</a>]</span> and <span><a class="xref" href="#RFC8323">CoAP over reliable transports</a> [<a class="xref" href="#RFC8323">RFC8323</a>]</span> restrict
        the maximum token length to 8 bytes. To overcome this
        limitation, <a class="xref" href="#extended-tokens">Section 2</a> of this document
        introduces a CoAP protocol extension for extended token
        lengths.<a class="pilcrow" href="#section-1-8">¶</a></p>
<p id="section-1-9">
         While the use case (avoiding per-request state) and the mechanism
         (extended token lengths) presented in this document are closely
         related, each can be used independently of the other.  Some
         implementations may be able to fit their state in just 8 bytes; some
         implementations may have other use cases for extended token lengths.<a class="pilcrow" href="#section-1-9">¶</a></p>
<section id="section-1.1">
        <h3 id="name-terminology">
<a class="section-number selfRef" href="#section-1.1">1.1. </a><a class="section-name selfRef" href="#name-terminology">Terminology</a>
        </h3>
<p id="section-1.1-1">
          In this document, the term "stateless" refers to an implementation
          strategy for a client (or intermediary in the client role) that does
          not require it to keep state for the individual requests it sends to a
          server (or intermediary in the server role). The client still needs to
          keep state for each server it communicates with (e.g., for token
          generation, message retransmission, and congestion control).<a class="pilcrow" href="#section-1.1-1">¶</a></p>
<p id="section-1.1-2">
   The key words "<span class="bcp14">MUST</span>", "<span class="bcp14">MUST NOT</span>", "<span class="bcp14">REQUIRED</span>", "<span class="bcp14">SHALL</span>", "<span class="bcp14">SHALL NOT</span>", "<span class="bcp14">SHOULD</span>", "<span class="bcp14">SHOULD NOT</span>", "<span class="bcp14">RECOMMENDED</span>", "<span class="bcp14">NOT RECOMMENDED</span>",
   "<span class="bcp14">MAY</span>", and "<span class="bcp14">OPTIONAL</span>" in this document are to be interpreted as
   described in BCP 14 <span>[<a class="xref" href="#RFC2119">RFC2119</a>]</span> <span>[<a class="xref" href="#RFC8174">RFC8174</a>]</span> 
   when, and only when, they appear in all capitals, as shown here.<a class="pilcrow" href="#section-1.1-2">¶</a></p>
</section>
</section>
</div>
<div id="extended-tokens">
<section id="section-2">
      <h2 id="name-extended-tokens">
<a class="section-number selfRef" href="#section-2">2. </a><a class="section-name selfRef" href="#name-extended-tokens">Extended Tokens</a>
      </h2>
<p id="section-2-1">
        This document updates the message formats defined for <span><a class="xref" href="#RFC7252">CoAP over UDP</a> [<a class="xref" href="#RFC7252">RFC7252</a>]</span> and <span><a class="xref" href="#RFC8323">CoAP
        over TCP, TLS, and WebSockets</a> [<a class="xref" href="#RFC8323">RFC8323</a>]</span> with a new definition of the "TKL"
        field.<a class="pilcrow" href="#section-2-1">¶</a></p>
<div id="tkl-field">
<section id="section-2.1">
        <h3 id="name-extended-token-length-tkl-f">
<a class="section-number selfRef" href="#section-2.1">2.1. </a><a class="section-name selfRef" href="#name-extended-token-length-tkl-f">Extended Token Length (TKL) Field</a>
        </h3>
<p id="section-2.1-1">
          The definition of the "TKL" field is updated as follows:<a class="pilcrow" href="#section-2.1-1">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-2.1-2">
          <dt id="section-2.1-2.1">Token Length (TKL):</dt>
          <dd id="section-2.1-2.2" style="margin-left: 1.5em">
            <p id="section-2.1-2.2.1">
              4-bit unsigned integer. A value between 0 and 12, inclusive,
              indicates the length of the variable-length "Token" field in bytes.
              The other three values are reserved for special constructs:<a class="pilcrow" href="#section-2.1-2.2.1">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-2.1-2.2.2">
              <dt id="section-2.1-2.2.2.1">13:</dt>
              <dd id="section-2.1-2.2.2.2" style="margin-left: 3.0em">
                  An 8-bit unsigned integer directly precedes the "Token" field and
                  indicates the length of the "Token" field minus 13.<a class="pilcrow" href="#section-2.1-2.2.2.2">¶</a>
</dd>
              <dd class="break"></dd>
<dt id="section-2.1-2.2.2.3">14:</dt>
              <dd id="section-2.1-2.2.2.4" style="margin-left: 3.0em">
                  A 16-bit unsigned integer in network byte order directly precedes the
                  "Token" field and indicates the length of the "Token" field minus
                  269.<a class="pilcrow" href="#section-2.1-2.2.2.4">¶</a>
</dd>
              <dd class="break"></dd>
<dt id="section-2.1-2.2.2.5">15:</dt>
              <dd id="section-2.1-2.2.2.6" style="margin-left: 3.0em">
                  Reserved. This value <span class="bcp14">MUST NOT</span> be sent and <span class="bcp14">MUST</span> be processed as
                  a message-format error.<a class="pilcrow" href="#section-2.1-2.2.2.6">¶</a>
</dd>
            <dd class="break"></dd>
</dl>
</dd>
        <dd class="break"></dd>
</dl>
<p id="section-2.1-3">
          All other fields retain their definitions.<a class="pilcrow" href="#section-2.1-3">¶</a></p>
<p id="section-2.1-4">
          The updated message formats are illustrated in <a class="xref" href="#message-formats">Appendix A</a>.<a class="pilcrow" href="#section-2.1-4">¶</a></p>
<p id="section-2.1-5">
          The new definition of the "TKL" field increases the maximum token length that can be represented in a
          message to 65804 bytes. However, the maximum token length that sender and
          recipient implementations support may be shorter. For example, a
          constrained node of <span><a class="xref" href="#RFC7228">Class 1</a> [<a class="xref" href="#RFC7228">RFC7228</a>]</span> might
          support extended token lengths only up to 32 bytes.<a class="pilcrow" href="#section-2.1-5">¶</a></p>
<p id="section-2.1-6">
          In CoAP over UDP, it is often beneficial to keep CoAP messages small
          enough to avoid IP fragmentation. The maximum practical token length
          may therefore also be influenced by the Path MTU (PMTU). See <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7252#section-4.6">Section 4.6</a> of [<a class="xref" href="#RFC7252">RFC7252</a>]</span> for details.<a class="pilcrow" href="#section-2.1-6">¶</a></p>
</section>
</div>
<div id="discovery">
<section id="section-2.2">
        <h3 id="name-discovering-support">
<a class="section-number selfRef" href="#section-2.2">2.2. </a><a class="section-name selfRef" href="#name-discovering-support">Discovering Support</a>
        </h3>
<p id="section-2.2-1">
          Extended token lengths require support from server implementations.
          Support can be discovered by a client implementation in one of two
          ways:<a class="pilcrow" href="#section-2.2-1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2.2-2.1">
              Where Capabilities and Settings Messages (CSMs) are available,
              such as in CoAP over TCP, support can be discovered using the
              Extended-Token-Length Capability Option defined in <a class="xref" href="#capability-option">Section 2.2.1</a>.<a class="pilcrow" href="#section-2.2-2.1">¶</a>
</li>
          <li class="normal" id="section-2.2-2.2">
              Otherwise, such as in CoAP over UDP, support can only be
              discovered by trial and error, as described in <a class="xref" href="#trial-and-error">Section 2.2.2</a>.<a class="pilcrow" href="#section-2.2-2.2">¶</a>
</li>
        </ul>
<div id="capability-option">
<section id="section-2.2.1">
          <h4 id="name-extended-token-length-capab">
<a class="section-number selfRef" href="#section-2.2.1">2.2.1. </a><a class="section-name selfRef" href="#name-extended-token-length-capab">Extended-Token-Length Capability Option</a>
          </h4>
<p id="section-2.2.1-1">
            A server can use the elective Extended-Token-Length Capability
            Option to indicate the maximum token length it can accept in
            requests.<a class="pilcrow" href="#section-2.2.1-1">¶</a></p>
<span id="name-the-extended-token-length-c"></span><div id="capability-option-definition">
<table class="center" id="table-1">
            <caption>
<a class="selfRef" href="#table-1">Table 1</a>:
<a class="selfRef" href="#name-the-extended-token-length-c">The Extended-Token-Length Capability Option</a>
            </caption>
<thead>
              <tr>
                <th class="text-right" colspan="1" rowspan="1">#</th>
                <th class="text-left" colspan="1" rowspan="1">C</th>
                <th class="text-left" colspan="1" rowspan="1">R</th>
                <th class="text-left" colspan="1" rowspan="1">Applies to</th>
                <th class="text-left" colspan="1" rowspan="1">Name</th>
                <th class="text-left" colspan="1" rowspan="1">Format</th>
                <th class="text-left" colspan="1" rowspan="1">Length</th>
                <th class="text-left" colspan="1" rowspan="1">Base Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="text-right" colspan="1" rowspan="1">6</td>
                <td class="text-left" colspan="1" rowspan="1"></td>
                <td class="text-left" colspan="1" rowspan="1"></td>
                <td class="text-left" colspan="1" rowspan="1">CSM</td>
                <td class="text-left" colspan="1" rowspan="1">Extended-Token-Length</td>
                <td class="text-left" colspan="1" rowspan="1">uint</td>
                <td class="text-left" colspan="1" rowspan="1">0-3</td>
                <td class="text-left" colspan="1" rowspan="1">8</td>
              </tr>
            </tbody>
          </table>
</div>
<p class="keepWithPrevious" id="section-2.2.1-3">C=Critical, R=Repeatable<a class="pilcrow" href="#section-2.2.1-3">¶</a></p>
<p id="section-2.2.1-4">
            As per <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7252#section-3">Section 3</a> of [<a class="xref" href="#RFC7252">RFC7252</a>]</span>, the base value (and the value used
            when this option is not implemented) is 8.<a class="pilcrow" href="#section-2.2.1-4">¶</a></p>
<p id="section-2.2.1-5">
            The active value of the Extended-Token-Length Option is replaced
            each time the option is sent with a modified value. Its starting
            value is its base value.<a class="pilcrow" href="#section-2.2.1-5">¶</a></p>
<p id="section-2.2.1-6">
            The option value <span class="bcp14">MUST NOT</span> be less than 8 or greater than 65804. If
            an option value less than 8 is received, the option <span class="bcp14">MUST</span> be ignored.
            If an option value greater than 65804 is received, the option value
            <span class="bcp14">MUST</span> be set to 65804.<a class="pilcrow" href="#section-2.2.1-6">¶</a></p>
<p id="section-2.2.1-7">
            Any option value greater than 8 implies support for the new
            definition of the "TKL" field specified in <a class="xref" href="#tkl-field">Section 2.1</a>.
            Indication of support by a server does not oblige a client to
            actually make use of token lengths greater than 8.<a class="pilcrow" href="#section-2.2.1-7">¶</a></p>
<p id="section-2.2.1-8">
            If a server receives a request with a token of a length greater than what
            it indicated in its Extended-Token-Length Option, it <span class="bcp14">MUST</span> handle the
            request as a message-format error.<a class="pilcrow" href="#section-2.2.1-8">¶</a></p>
<p id="section-2.2.1-9">
            If a server receives a request with a token of a length less than, or
            equal to, what it indicated in its Extended-Token-Length Option but
            is unwilling or unable to handle the token at that time, it <span class="bcp14">MUST NOT</span>
            handle the request as a message-format error. Instead, it <span class="bcp14">SHOULD</span>
            return a 5.03 (Service Unavailable) response.<a class="pilcrow" href="#section-2.2.1-9">¶</a></p>
<p id="section-2.2.1-10">
            The Extended-Token-Length Capability Option does not apply to
            responses. The sender of a request is simply expected not to use a
            token of a length greater than it is willing to accept in a
            response.<a class="pilcrow" href="#section-2.2.1-10">¶</a></p>
</section>
</div>
<div id="trial-and-error">
<section id="section-2.2.2">
          <h4 id="name-trial-and-error">
<a class="section-number selfRef" href="#section-2.2.2">2.2.2. </a><a class="section-name selfRef" href="#name-trial-and-error">Trial and Error</a>
          </h4>
<p id="section-2.2.2-1">
            A server implementation that does not support the updated definition of the "TKL"
            field specified in <a class="xref" href="#tkl-field">Section 2.1</a> will consider a
            request with a "TKL" field value outside the range 0 to 8 to be a message-format error and reject it (<span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7252#section-3">Section 3</a> of [<a class="xref" href="#RFC7252">RFC7252</a>]</span>). A client can
            therefore determine support by sending a request with an extended
            token length and checking whether or not it is rejected by the server.<a class="pilcrow" href="#section-2.2.2-1">¶</a></p>
<p id="section-2.2.2-2">
            In CoAP over UDP, the way a request message is rejected depends on the message type.
            A Confirmable message with a message-format error
            is rejected with a Reset message (<span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7252#section-4.2">Section 4.2</a> of [<a class="xref" href="#RFC7252">RFC7252</a>]</span>). A
            Non-confirmable message with a message-format error is either rejected
            with a Reset message or just silently ignored (<span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7252#section-4.3">Section 4.3</a> of [<a class="xref" href="#RFC7252">RFC7252</a>]</span>). To reliably get a Reset message, it is therefore <span class="bcp14">REQUIRED</span> that clients use a Confirmable
            message for determining support.<a class="pilcrow" href="#section-2.2.2-2">¶</a></p>
<p id="section-2.2.2-3">
            As per RFC 7252, Reset messages are empty and do not contain a
            token; they only return the Message ID (<a class="xref" href="#trial-and-error-illustration">Figure 3</a>). They also do not contain
            any indication of what caused a message-format error. To avoid any
            ambiguity, it is therefore <span class="bcp14">RECOMMENDED</span> that clients use a request
            that has no potential message-format error other than the extended
            token length.<a class="pilcrow" href="#section-2.2.2-3">¶</a></p>
<span id="name-a-confirmable-request-with-"></span><div id="trial-and-error-illustration">
<figure id="figure-3">
            <div class="artwork art-text alignCenter" id="section-2.2.2-4.1">
<pre>+-----------------+   request message    +------------+
|        |        |    with extended     |            |
|        |        |     token length     |            |
|    .-&lt;-+-&gt;------|---------------------&gt;|------.     |
|   _|_           |                      |      |     |
|  /   \ stored   |                      |      |     |
|  \___/ state    |                      |      |     |
|    |            |                      |      |     |
|    '-&gt;-+-&lt;------|&lt;---------------------|------'     |
|        |        |     Reset message    |            |
|        v        |   with only message  |            |
+-----------------+    ID echoed back    +------------+
      Client                                 Server
</pre>
</div>
<figcaption><a class="selfRef" href="#figure-3">Figure 3</a>:
<a class="selfRef" href="#name-a-confirmable-request-with-">A Confirmable Request with an Extended Token Is Rejected with a Reset Message If the Server Does Not Have Support</a>
            </figcaption></figure>
</div>
<p id="section-2.2.2-5">

     
            An example of a suitable request is a GET request in a Confirmable  message that
            includes only an If-None-Match option and a token of the greatest length
            that the client intends to use. Any response with the same token
            echoed back indicates that tokens up to that length are supported by
            the server.<a class="pilcrow" href="#section-2.2.2-5">¶</a></p>
<p id="section-2.2.2-6">
            Since network addresses may change, a client <span class="bcp14">SHOULD NOT</span> assume that extended token
            lengths are supported by a server for an unlimited duration.
            Unless additional information is available, the client should assume that addresses (and therefore extended token lengths) are valid for a minimum of 1800 s and a maximum of 86400 s (1 day).
            A client may use additional forms of input into this determination.
            For instance, a client may assume a server that is in the same subnet as the client has a similar address lifetime as the client.
            The client may use DHCP lease times or Router Advertisements to set the limits.
            For servers that are not local, if the server was looked up using DNS, then the DNS resource record will have a Time To Live (TTL), and the extended token length should be kept for only that amount of time.<a class="pilcrow" href="#section-2.2.2-6">¶</a></p>
<p id="section-2.2.2-7">
            If a server supports extended token lengths but receives a request
            with a token of a length it is unwilling or unable to handle, it
            <span class="bcp14">MUST NOT</span> reject the message, as that would imply that extended token
            lengths are not supported at all. Instead, if the server cannot
            handle the request at the time, it <span class="bcp14">SHOULD</span> return a 5.03 (Service
            Unavailable) response; if the server will never be able to handle the request
            (e.g., because the token is too large), it <span class="bcp14">SHOULD</span> return a 4.00 (Bad
            Request) response.<a class="pilcrow" href="#section-2.2.2-7">¶</a></p>
<aside id="section-2.2.2-8">
            <p id="section-2.2.2-8.1">Design Note: The requirement to return an error response when a
                token cannot be handled might seem somewhat contradictory, as
                returning the error response requires the server also to return the
                token it cannot handle. However,
                processing a request usually involves a number of steps from
                receiving the message to passing it to application logic.
                The idea is that a server implementing this extension
                supports large tokens at least in its first few processing steps, enough to
                return an error response rather than a Reset message.<a class="pilcrow" href="#section-2.2.2-8.1">¶</a></p>
</aside>
<aside id="section-2.2.2-9">
            <p id="section-2.2.2-9.1">Design Note: To prevent the trial-and-error-based discovery from becoming too complicated, no effort is made to indicate the maximum supported
                token length. A client implementation would probably
                already choose the shortest token possible for the task (such as
                being stateless, as described in <a class="xref" href="#stateless-clients">Section 3</a>), so it would probably not be able
                to reduce the length any further anyway should a server
                indicate a lower limit.<a class="pilcrow" href="#section-2.2.2-9.1">¶</a></p>
</aside>
</section>
</div>
</section>
</div>
<div id="hop-by-hop">
<section id="section-2.3">
        <h3 id="name-intermediaries">
<a class="section-number selfRef" href="#section-2.3">2.3. </a><a class="section-name selfRef" href="#name-intermediaries">Intermediaries</a>
        </h3>
<p id="section-2.3-1">
          Tokens are a hop-by-hop feature: if there are one or more
          intermediaries between a client and a server, every token is scoped to
          the exchange between a node in the client role and the node in the
          server role that it is immediately interacting with.<a class="pilcrow" href="#section-2.3-1">¶</a></p>
<p id="section-2.3-2">
          When an intermediary receives a request, the only requirement is that
          it echoes the token back in any resulting response. There is no
          requirement or expectation that an intermediary passes a client's
          token on to a server or that an intermediary uses extended token
          lengths itself in its request to satisfy a request with an extended
          token length. Discovery needs to be performed for each hop where extended token lengths are to be used.<a class="pilcrow" href="#section-2.3-2">¶</a></p>
</section>
</div>
</section>
</div>
<div id="stateless-clients">
<section id="section-3">
      <h2 id="name-stateless-clients">
<a class="section-number selfRef" href="#section-3">3. </a><a class="section-name selfRef" href="#name-stateless-clients">Stateless Clients</a>
      </h2>
<p id="section-3-1">
        A client can be alleviated of keeping per-request state as follows:<a class="pilcrow" href="#section-3-1">¶</a></p>
<ol class="normal type-1" id="section-3-2" start="1" type="1">
<li id="section-3-2.1">
            The client serializes (parts of) its per-request state into
            a sequence of bytes and sends those bytes as the token of
            its request to the server.<a class="pilcrow" href="#section-3-2.1">¶</a>
</li>
        <li id="section-3-2.2">
            The server returns the token verbatim in the response to the
            client, which allows the client to recover the state and
            process the response as if it had kept the state locally.<a class="pilcrow" href="#section-3-2.2">¶</a>
</li>
      </ol>
<p id="section-3-3">
        As servers are just expected to return any token verbatim to the
        client, this implementation strategy for clients does not impact the
        interoperability of client and server implementations. However,
        there are a number of significant, nonobvious implications
        (e.g., related to security and other CoAP protocol features)
        that client implementations need take into consideration.<a class="pilcrow" href="#section-3-3">¶</a></p>
<p id="section-3-4">
        The following subsections discuss some of these considerations.<a class="pilcrow" href="#section-3-4">¶</a></p>
<div id="serialized-state">
<section id="section-3.1">
        <h3 id="name-serializing-client-state">
<a class="section-number selfRef" href="#section-3.1">3.1. </a><a class="section-name selfRef" href="#name-serializing-client-state">Serializing Client State</a>
        </h3>
<p id="section-3.1-1">
          The format of the serialized state is generally an
          implementation detail of the client and opaque to the server.

          However, serialized state information is an attractive target
          for both unwanted nodes (e.g., on-path attackers) and wanted
          nodes (e.g., any configured forward proxy) on the path.

          The serialization format therefore needs to include security
          measures such as the following:<a class="pilcrow" href="#section-3.1-1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1-2.1">
              A client <span class="bcp14">SHOULD</span> protect the integrity of the state information
              serialized in a token.<a class="pilcrow" href="#section-3.1-2.1">¶</a>
</li>
          <li class="normal" id="section-3.1-2.2">
              Even when the integrity of the serialized state is protected, an
              attacker may still replay a response, making the client
              believe it sent the same request twice.

              For this reason, the client <span class="bcp14">SHOULD</span> implement replay
              protection (e.g., by using sequence numbers and a replay
              window).

              For replay protection, integrity protection is <span class="bcp14">REQUIRED</span>.<a class="pilcrow" href="#section-3.1-2.2">¶</a>
</li>
          <li class="normal" id="section-3.1-2.3">
              If processing a response without keeping request state is
              sensitive to the time elapsed since sending the request, then the
              client <span class="bcp14">SHOULD</span> include freshness information (e.g., a timestamp) in
              the serialized state and reject any response where the freshness
              information is insufficiently fresh.<a class="pilcrow" href="#section-3.1-2.3">¶</a>
</li>
          <li class="normal" id="section-3.1-2.4">
              Information in the serialized state may be privacy
              sensitive.

              A client <span class="bcp14">SHOULD</span> encrypt the serialized state if it
              contains privacy-sensitive information that an attacker
              would not get otherwise.<a class="pilcrow" href="#section-3.1-2.4">¶</a>
</li>
          <li class="normal" id="section-3.1-2.5">
              When a client changes the format of the serialized state,
              it <span class="bcp14">SHOULD</span> prevent false interoperability with the previous
              format (e.g., by changing the key used for integrity
              protection or changing a field in the serialized state).<a class="pilcrow" href="#section-3.1-2.5">¶</a>
</li>
        </ul>
</section>
</div>
<section id="section-3.2">
        <h3 id="name-using-extended-tokens">
<a class="section-number selfRef" href="#section-3.2">3.2. </a><a class="section-name selfRef" href="#name-using-extended-tokens">Using Extended Tokens</a>
        </h3>
<p id="section-3.2-1">
          A client that depends on
          support for extended token lengths (<a class="xref" href="#extended-tokens">Section 2</a>)
          from the server to avoid keeping request state needs to perform a
          discovery of support (<a class="xref" href="#discovery">Section 2.2</a>) before it can be
          stateless.<a class="pilcrow" href="#section-3.2-1">¶</a></p>
<p id="section-3.2-2">
          This discovery <span class="bcp14">MUST</span> be performed in a stateful way, i.e.,
          keeping state for the request (<a class="xref" href="#stateful-discovery">Figure 4</a>).
          If the client was stateless from the start, and the server does not
          support extended tokens, then no error message could be processed,
          since the state would neither be present at the client nor returned in
          the Reset message (<a class="xref" href="#stateless-discovery">Figure 5</a>).<a class="pilcrow" href="#section-3.2-2">¶</a></p>
<span id="name-depending-on-extended-token"></span><div id="stateful-discovery">
<figure id="figure-4">
          <div class="artwork art-text alignCenter" id="section-3.2-3.1">
<pre>+-----------------+    dummy request     +------------+
|        |        |    with extended     |            |
|        |        |        token         |            |
|    .-&lt;-+-&gt;------|=====================&gt;|------.     |
|   _|_           |                      |      |     |
|  /   \ stored   |                      |      |     |
|  \___/ state    |                      |      |     |
|    |            |                      |      |     |
|    '-&gt;-+-&lt;------|&lt;=====================|------'     |
|        |        |     response with    |            |
|        |        |    extended token    |            |
|        |        |      echoed back     |            |
|        |        |                      |            |
|        |        |                      |            |
|        |        |     request with     |            |
|        |        |   serialized state   |            |
|        |        |       as token       |            |
|        +--------|=====================&gt;|------.     |
|                 |                      |      |     |
|    look ma,     |                      |      |     |
|    no state!    |                      |      |     |
|                 |                      |      |     |
|        +--------|&lt;=====================|------'     |
|        |        |     response with    |            |
|        v        |   token echoed back  |            |
+-----------------+                      +------------+
      Client                                 Server
</pre>
</div>
<figcaption><a class="selfRef" href="#figure-4">Figure 4</a>:
<a class="selfRef" href="#name-depending-on-extended-token">Depending on Extended Tokens for Being Stateless First Requires a Successful Stateful Discovery of Support</a>
          </figcaption></figure>
</div>
<span id="name-stateless-discovery-of-supp"></span><div id="stateless-discovery">
<figure id="figure-5">
          <div class="artwork art-text alignCenter" id="section-3.2-4.1">
<pre>+-----------------+    dummy request     +------------+
|        |        |    with extended     |            |
|        |        |        token         |            |
|        +--------|=====================&gt;|------.     |
|                 |                      |      |     |
|                 |                      |      |     |
|                 |                      |      |     |
|                 |                      |      |     |
|              ???|&lt;---------------------|------'     |
|                 |     Reset message    |            |
|                 |   with only message  |            |
+-----------------+    ID echoed back    +------------+
      Client                                 Server
</pre>
</div>
<figcaption><a class="selfRef" href="#figure-5">Figure 5</a>:
<a class="selfRef" href="#name-stateless-discovery-of-supp">Stateless Discovery of Support Does Not Work</a>
          </figcaption></figure>
</div>
<p id="section-3.2-5">
          In environments where support can be reliably discovered through some
          other means, the discovery of support is <span class="bcp14">OPTIONAL</span>. An example for this
          is the <span><a class="xref" href="#I-D.ietf-6tisch-minimal-security">Constrained
          Join Protocol (CoJP) in a 6TiSCH network</a> [<a class="xref" href="#I-D.ietf-6tisch-minimal-security">6TISCH-MIN-SEC</a>]</span>, where support for
          extended tokens is required from all relevant parties.<a class="pilcrow" href="#section-3.2-5">¶</a></p>
</section>
<section id="section-3.3">
        <h3 id="name-transmitting-messages">
<a class="section-number selfRef" href="#section-3.3">3.3. </a><a class="section-name selfRef" href="#name-transmitting-messages">Transmitting Messages</a>
        </h3>
<p id="section-3.3-1">
          In <span><a class="xref" href="#RFC7252">CoAP over UDP</a> [<a class="xref" href="#RFC7252">RFC7252</a>]</span>, a client has the choice between
          Confirmable and Non-confirmable messages for requests. When using
          Non-confirmable messages, a client does not have to keep any message-exchange state, which can help in the goal of avoiding state. When using
          Confirmable messages, a client needs to keep message-exchange
          state for performing retransmissions and handling Acknowledgement and
          Reset messages, however. Non-confirmable messages are therefore better suited for avoiding state.

          In any case, a client still needs to keep congestion-control state, i.e.,
          maintain state for each node it communicates with and enforce limits
          like NSTART.<a class="pilcrow" href="#section-3.3-1">¶</a></p>
<p id="section-3.3-2">
          As per <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7252#section-5.2">Section 5.2</a> of [<a class="xref" href="#RFC7252">RFC7252</a>]</span>, a client must be prepared to receive a response as a
          piggybacked response, a separate response, or a Non-confirmable response,
          regardless of the message type used for the
          request. A stateless client <span class="bcp14">MUST</span> handle these response types as
          follows:<a class="pilcrow" href="#section-3.3-2">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.3-3.1">
              If a piggybacked response passes the checks for token integrity
              and freshness (<a class="xref" href="#serialized-state">Section 3.1</a>), the client processes the message as
              specified in RFC 7252; otherwise, it processes the acknowledgement
              portion of the message as specified in RFC 7252 and silently
              discards the response portion.<a class="pilcrow" href="#section-3.3-3.1">¶</a>
</li>
          <li class="normal" id="section-3.3-3.2">
              If a separate response passes the checks for token integrity and
              freshness, the client processes the message as specified in
              RFC 7252; otherwise, it rejects the message as specified in <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7252#section-4.2">Section 4.2</a> of [<a class="xref" href="#RFC7252">RFC7252</a>]</span>.<a class="pilcrow" href="#section-3.3-3.2">¶</a>
</li>
          <li class="normal" id="section-3.3-3.3">
              If a Non-confirmable response passes the checks for token
              integrity and freshness, the client processes the message
              as specified in RFC 7252; otherwise, it rejects the message as
              specified in <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7252#section-4.3">Section 4.3</a> of [<a class="xref" href="#RFC7252">RFC7252</a>]</span>.<a class="pilcrow" href="#section-3.3-3.3">¶</a>
</li>
        </ul>
</section>
</section>
</div>
<div id="stateless-intermediaries">
<section id="section-4">
      <h2 id="name-stateless-intermediaries">
<a class="section-number selfRef" href="#section-4">4. </a><a class="section-name selfRef" href="#name-stateless-intermediaries">Stateless Intermediaries</a>
      </h2>
<p id="section-4-1">
        Tokens are a hop-by-hop feature. If a client makes a request to an
        intermediary, that intermediary needs to store the client's token
        (along with the client's transport address) while it makes its own
        request towards the origin server and waits for the
        response. When the intermediary receives the response, it looks up
        the client's token and transport address for the received request and
        sends an appropriate response to the client.<a class="pilcrow" href="#section-4-1">¶</a></p>
<p id="section-4-2">
        An intermediary might want to be "stateless" not only in its role as
        a client but also in its role as a server, i.e., be
        alleviated of storing the client information for
        the requests it receives.<a class="pilcrow" href="#section-4-2">¶</a></p>
<p id="section-4-3">
        Such an intermediary can be implemented by serializing the
        client information along with the request state into the token towards the origin server.
        When the intermediary receives the response, it can recover
        the client information from the token and use it to satisfy the client's
        request; therefore, the intermediary doesn't need to store the information itself.<a class="pilcrow" href="#section-4-3">¶</a></p>
<p id="section-4-4">
        The following subsections discuss some considerations for this approach.<a class="pilcrow" href="#section-4-4">¶</a></p>
<section id="section-4.1">
        <h3 id="name-observing-resources">
<a class="section-number selfRef" href="#section-4.1">4.1. </a><a class="section-name selfRef" href="#name-observing-resources">Observing Resources</a>
        </h3>
<p id="section-4.1-1">
          One drawback of the approach is that an intermediary, without keeping
          request state, is unable to aggregate multiple requests for the same
          target resource, which can significantly reduce efficiency. In
          particular, when clients observe <span>[<a class="xref" href="#RFC7641">RFC7641</a>]</span> the
          same resource, aggregating requests is <span class="bcp14">REQUIRED</span> (<span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7641#section-3.1">Section 3.1</a> of [<a class="xref" href="#RFC7641">RFC7641</a>]</span>). This requirement cannot be satisfied without keeping request
          state.<a class="pilcrow" href="#section-4.1-1">¶</a></p>
<p id="section-4.1-2">
          Furthermore, an intermediary that does not keep track of the clients
          observing a resource is not able to determine whether these
          clients are still interested in receiving further notifications
          (<span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7641#section-3.5">Section 3.5</a> of [<a class="xref" href="#RFC7641">RFC7641</a>]</span>) or want to cancel an observation (<span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7641#section-3.6">Section 3.6</a> of [<a class="xref" href="#RFC7641">RFC7641</a>]</span>).<a class="pilcrow" href="#section-4.1-2">¶</a></p>
<p id="section-4.1-3">
          Therefore, an intermediary <span class="bcp14">MUST NOT</span> include an Observe Option in
          requests it sends without keeping both the request state for the requests it sends and the
          client information for the requests it receives.<a class="pilcrow" href="#section-4.1-3">¶</a></p>
</section>
<section id="section-4.2">
        <h3 id="name-block-wise-transfers">
<a class="section-number selfRef" href="#section-4.2">4.2. </a><a class="section-name selfRef" href="#name-block-wise-transfers">Block-Wise Transfers</a>
        </h3>
<p id="section-4.2-1">
          When using <span><a class="xref" href="#RFC7959">block-wise transfers</a> [<a class="xref" href="#RFC7959">RFC7959</a>]</span>, a
          server might not be able to distinguish blocks originating from
          different clients once they have been forwarded by an intermediary.
          Intermediaries need to ensure that this does not lead to inconsistent
          resource state by keeping distinct block-wise request operations on
          the same resource apart, e.g., utilizing the <span><a class="xref" href="#I-D.ietf-core-echo-request-tag">Request-Tag Option</a> [<a class="xref" href="#I-D.ietf-core-echo-request-tag">ECHO-REQUEST-TAG</a>]</span>.<a class="pilcrow" href="#section-4.2-1">¶</a></p>
</section>
<section id="section-4.3">
        <h3 id="name-gateway-timeouts">
<a class="section-number selfRef" href="#section-4.3">4.3. </a><a class="section-name selfRef" href="#name-gateway-timeouts">Gateway Timeouts</a>
        </h3>
<p id="section-4.3-1">
          As per <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7252#section-5.7.1">Section 5.7.1</a> of [<a class="xref" href="#RFC7252">RFC7252</a>]</span>, an intermediary is <span class="bcp14">REQUIRED</span> to
          return a 5.04 (Gateway Timeout) response if it cannot obtain a
          response within a timeout. However, if an intermediary does not keep
          the client information for the requests it receives, it cannot return
          such a response. Therefore, in this case, the gateway cannot return
          such a response and as such cannot implement such a timeout.<a class="pilcrow" href="#section-4.3-1">¶</a></p>
</section>
<section id="section-4.4">
        <h3 id="name-extended-tokens-2">
<a class="section-number selfRef" href="#section-4.4">4.4. </a><a class="section-name selfRef" href="#name-extended-tokens-2">Extended Tokens</a>
        </h3>
<p id="section-4.4-1">
          A client may make use of extended token lengths in a request to an
          intermediary that wants to be "stateless". This means that such an intermediary
          may have to serialize potentially very large client information into
          its token towards the origin server. The tokens can grow even further
          when it progresses along a chain of intermediaries that all want to be
          "stateless".<a class="pilcrow" href="#section-4.4-1">¶</a></p>
<p id="section-4.4-2">
          Intermediaries <span class="bcp14">SHOULD</span> limit the size of client information they are
          serializing into their own tokens. An intermediary can do this, for
          example, by limiting the extended token lengths it accepts from its
          clients (see <a class="xref" href="#discovery">Section 2.2</a>) or by keeping the client
          information locally when the client information exceeds the limit
          (i.e., not being "stateless").<a class="pilcrow" href="#section-4.4-2">¶</a></p>
</section>
</section>
</div>
<div id="security">
<section id="section-5">
      <h2 id="name-security-considerations">
<a class="section-number selfRef" href="#section-5">5. </a><a class="section-name selfRef" href="#name-security-considerations">Security Considerations</a>
      </h2>
<section id="section-5.1">
        <h3 id="name-extended-tokens-3">
<a class="section-number selfRef" href="#section-5.1">5.1. </a><a class="section-name selfRef" href="#name-extended-tokens-3">Extended Tokens</a>
        </h3>
<p id="section-5.1-1">
          Tokens significantly larger than the 8 bytes specified in RFC 7252
          have implications -- in particular, for nodes with constrained memory size --
          that need to be mitigated. A node in the server role supporting
          extended token lengths may be vulnerable to a denial of service when
          an attacker (either on-path or a malicious client) sends large tokens
          to fill up the memory of the node. Implementations need to be prepared
          to handle such messages.<a class="pilcrow" href="#section-5.1-1">¶</a></p>
</section>
<section id="section-5.2">
        <h3 id="name-stateless-clients-and-inter">
<a class="section-number selfRef" href="#section-5.2">5.2. </a><a class="section-name selfRef" href="#name-stateless-clients-and-inter">Stateless Clients and Intermediaries</a>
        </h3>
<p id="section-5.2-1">
          Transporting the state needed by a client to process a response as
          serialized state information in the token has several significant and
          nonobvious security and privacy implications that need to be
          mitigated; see <a class="xref" href="#serialized-state">Section 3.1</a> for recommendations.<a class="pilcrow" href="#section-5.2-1">¶</a></p>
<p id="section-5.2-2">
          In addition to the format requirements outlined there, implementations
          need to ensure that they are not vulnerable to maliciously crafted,
          delayed, or replayed tokens.<a class="pilcrow" href="#section-5.2-2">¶</a></p>
<p id="section-5.2-3">
          It is generally expected that the use of encryption, integrity
          protection, and replay protection for serialized state is
          appropriate.<a class="pilcrow" href="#section-5.2-3">¶</a></p>
<p id="section-5.2-4">
          In the absence of integrity and replay protection, an on-path attacker
          or rogue server/intermediary could return a state (either one modified
          in a reply, or an unsolicited one) that could alter the internal state
          of the client.<a class="pilcrow" href="#section-5.2-4">¶</a></p>
<p id="section-5.2-5">
          It is for this reason that at least the use of integrity protection on
          the token is always recommended.<a class="pilcrow" href="#section-5.2-5">¶</a></p>
<p id="section-5.2-6">
          It may be that in some very specific cases, as a result of a careful
          and detailed analysis of any potential attacks, it is decided that such cryptographic protections do not add value.
          The authors of this document have not found such a use case as yet, but this
          is a local decision.<a class="pilcrow" href="#section-5.2-6">¶</a></p>
<p id="section-5.2-7">
          It should further be emphasized that the encrypted state is created by the
          sending node and decrypted by the same node when receiving a
          response.
          The key is not shared with any other system.
          Therefore, the choice of encryption scheme and the generation of the key for
          this system is purely a local matter.<a class="pilcrow" href="#section-5.2-7">¶</a></p>
<p id="section-5.2-8">
          When encryption is used, the use of <span><a class="xref" href="#RFC3610">AES-CCM</a> [<a class="xref" href="#RFC3610">RFC3610</a>]</span> with a 64-bit tag is recommended,
          combined with a sequence number and a replay window.

          This choice is informed by available hardware acceleration of on
          many constrained systems.
          If a different algorithm is available accelerated on the sender,
          with similar or stronger strength, then it <span class="bcp14">SHOULD</span> be preferred.

          Where privacy of the state is not required, and encryption is not needed, <span><a class="xref" href="#RFC6234">HMAC-SHA-256</a> [<a class="xref" href="#RFC6234">RFC6234</a>]</span>, combined with a sequence number
          and a replay window, may be used.<a class="pilcrow" href="#section-5.2-8">¶</a></p>
<p id="section-5.2-9">
          This size of the replay window depends upon the number of
          requests that need to be outstanding.  This can be
          determined from the rate at which new ones are made and the
          expected time period during which responses are expected.<a class="pilcrow" href="#section-5.2-9">¶</a></p>
<p id="section-5.2-10">
          For instance, given a CoAP MAX_TRANSMIT_WAIT of 93 s (<span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7252#section-4.8.2">Section 4.8.2</a> of [<a class="xref" href="#RFC7252">RFC7252</a>]</span>), any request that is not answered within 93 s will
          be considered to have failed.  At a request rate of
          one request per 10 s, at most 10 (ceil(9.3)) requests can be
          outstanding at a time, and any convenient replay window larger than
          20 will work.  As replay windows are often implemented with a
          sliding window and a bit, the use of a 32-bit window would be
          sufficient.<a class="pilcrow" href="#section-5.2-10">¶</a></p>
<p id="section-5.2-11">
          For use cases where requests are being relayed from another node,
          the request rate may be estimated by the total link capacity
          allocated for that kind of traffic.  An alternate view would
          consider how many IPv6 Neighbor Cache Entries (NCEs) the system can
          afford to allocate for this use.<a class="pilcrow" href="#section-5.2-11">¶</a></p>
<p id="section-5.2-12">
          When using an encryption mode that depends on a nonce, such as
          AES-CCM, repeated use of the same nonce under the same key
          causes the cipher to fail catastrophically.<a class="pilcrow" href="#section-5.2-12">¶</a></p>
<p id="section-5.2-13">
          If a nonce is ever used for more than one encryption operation with
          the same key, then the same key stream gets used to encrypt both plaintexts, and the
          confidentiality guarantees are voided. Devices with low-quality entropy
          sources -- as is typical with constrained devices, which incidentally
          happen to be a natural candidate for the stateless mechanism described
          in this document -- need to carefully pick a nonce-generation
          mechanism that provides the above uniqueness guarantee.<a class="pilcrow" href="#section-5.2-13">¶</a></p>
<p id="section-5.2-14">
          <span>[<a class="xref" href="#RFC8613">RFC8613</a>]</span>, Appendix B.1.1 ("Sender Sequence Number")
          provides a model for how to maintain nonrepeating nonces without
          causing excessive wear of flash memory.<a class="pilcrow" href="#section-5.2-14">¶</a></p>
</section>
</section>
</div>
<section id="section-6">
      <h2 id="name-iana-considerations">
<a class="section-number selfRef" href="#section-6">6. </a><a class="section-name selfRef" href="#name-iana-considerations">IANA Considerations</a>
      </h2>
<section id="section-6.1">
        <h3 id="name-coap-signaling-option-numbe">
<a class="section-number selfRef" href="#section-6.1">6.1. </a><a class="section-name selfRef" href="#name-coap-signaling-option-numbe">CoAP Signaling Option Number</a>
        </h3>
<p id="section-6.1-1">
          The following entry has been added to the "CoAP Signaling Option Numbers"
          registry within the "CoRE Parameters" registry.<a class="pilcrow" href="#section-6.1-1">¶</a></p>
<span id="name-coap-signaling-option-number"></span><table class="center" id="table-2">
          <caption>
<a class="selfRef" href="#table-2">Table 2</a>:
<a class="selfRef" href="#name-coap-signaling-option-number">CoAP Signaling Option Number</a>
          </caption>
<thead>
            <tr>
              <th class="text-left" colspan="1" rowspan="1">Applies to</th>
              <th class="text-right" colspan="1" rowspan="1">Number</th>
              <th class="text-left" colspan="1" rowspan="1">Name</th>
              <th class="text-left" colspan="1" rowspan="1">Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" colspan="1" rowspan="1">7.01</td>
              <td class="text-right" colspan="1" rowspan="1">6</td>
              <td class="text-left" colspan="1" rowspan="1">Extended-Token-Length</td>
              <td class="text-left" colspan="1" rowspan="1">RFC 8974</td>
            </tr>
          </tbody>
        </table>
<p id="section-6.1-3"></p>
</section>
</section>
<section id="section-7">
      <h2 id="name-references">
<a class="section-number selfRef" href="#section-7">7. </a><a class="section-name selfRef" href="#name-references">References</a>
      </h2>
<section id="section-7.1">
        <h3 id="name-normative-references">
<a class="section-number selfRef" href="#section-7.1">7.1. </a><a class="section-name selfRef" href="#name-normative-references">Normative References</a>
        </h3>
<dl class="references">
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time class="refDate" datetime="1997-03">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7252">[RFC7252]</dt>
        <dd>
<span class="refAuthor">Shelby, Z.</span><span class="refAuthor">, Hartke, K.</span><span class="refAuthor">, and C. Bormann</span>, <span class="refTitle">"The Constrained Application Protocol (CoAP)"</span>, <span class="seriesInfo">RFC 7252</span>, <span class="seriesInfo">DOI 10.17487/RFC7252</span>, <time class="refDate" datetime="2014-06">June 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7252">https://www.rfc-editor.org/info/rfc7252</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7641">[RFC7641]</dt>
        <dd>
<span class="refAuthor">Hartke, K.</span>, <span class="refTitle">"Observing Resources in the Constrained Application Protocol (CoAP)"</span>, <span class="seriesInfo">RFC 7641</span>, <span class="seriesInfo">DOI 10.17487/RFC7641</span>, <time class="refDate" datetime="2015-09">September 2015</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7641">https://www.rfc-editor.org/info/rfc7641</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7959">[RFC7959]</dt>
        <dd>
<span class="refAuthor">Bormann, C.</span><span class="refAuthor"> and Z. Shelby, Ed.</span>, <span class="refTitle">"Block-Wise Transfers in the Constrained Application Protocol (CoAP)"</span>, <span class="seriesInfo">RFC 7959</span>, <span class="seriesInfo">DOI 10.17487/RFC7959</span>, <time class="refDate" datetime="2016-08">August 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7959">https://www.rfc-editor.org/info/rfc7959</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time class="refDate" datetime="2017-05">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8323">[RFC8323]</dt>
      <dd>
<span class="refAuthor">Bormann, C.</span><span class="refAuthor">, Lemay, S.</span><span class="refAuthor">, Tschofenig, H.</span><span class="refAuthor">, Hartke, K.</span><span class="refAuthor">, Silverajan, B.</span><span class="refAuthor">, and B. Raymor, Ed.</span>, <span class="refTitle">"CoAP (Constrained Application Protocol) over TCP, TLS, and WebSockets"</span>, <span class="seriesInfo">RFC 8323</span>, <span class="seriesInfo">DOI 10.17487/RFC8323</span>, <time class="refDate" datetime="2018-02">February 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8323">https://www.rfc-editor.org/info/rfc8323</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-7.2">
        <h3 id="name-informative-references">
<a class="section-number selfRef" href="#section-7.2">7.2. </a><a class="section-name selfRef" href="#name-informative-references">Informative References</a>
        </h3>
<dl class="references">
<dt id="I-D.ietf-6tisch-minimal-security">[6TISCH-MIN-SEC]</dt>
        <dd>
<span class="refAuthor">Vucinic, M.</span><span class="refAuthor">, Simon, J.</span><span class="refAuthor">, Pister, K.</span><span class="refAuthor">, and M. Richardson</span>, <span class="refTitle">"Constrained Join Protocol (CoJP) for 6TiSCH"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-6tisch-minimal-security-15</span>, <time class="refDate" datetime="2019-12-10">10 December 2019</time>, <span>&lt;<a href="https://tools.ietf.org/html/draft-ietf-6tisch-minimal-security-15">https://tools.ietf.org/html/draft-ietf-6tisch-minimal-security-15</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-core-echo-request-tag">[ECHO-REQUEST-TAG]</dt>
        <dd>
<span class="refAuthor">Amsüss, C.</span><span class="refAuthor">, Mattsson, J. P.</span><span class="refAuthor">, and G. Selander</span>, <span class="refTitle">"CoAP: Echo, Request-Tag, and Token Processing"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-core-echo-request-tag-11</span>, <time class="refDate" datetime="2020-11-02">2 November 2020</time>, <span>&lt;<a href="https://tools.ietf.org/html/draft-ietf-core-echo-request-tag-11">https://tools.ietf.org/html/draft-ietf-core-echo-request-tag-11</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3610">[RFC3610]</dt>
        <dd>
<span class="refAuthor">Whiting, D.</span><span class="refAuthor">, Housley, R.</span><span class="refAuthor">, and N. Ferguson</span>, <span class="refTitle">"Counter with CBC-MAC (CCM)"</span>, <span class="seriesInfo">RFC 3610</span>, <span class="seriesInfo">DOI 10.17487/RFC3610</span>, <time class="refDate" datetime="2003-09">September 2003</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc3610">https://www.rfc-editor.org/info/rfc3610</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6234">[RFC6234]</dt>
        <dd>
<span class="refAuthor">Eastlake 3rd, D.</span><span class="refAuthor"> and T. Hansen</span>, <span class="refTitle">"US Secure Hash Algorithms (SHA and SHA-based HMAC and HKDF)"</span>, <span class="seriesInfo">RFC 6234</span>, <span class="seriesInfo">DOI 10.17487/RFC6234</span>, <time class="refDate" datetime="2011-05">May 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6234">https://www.rfc-editor.org/info/rfc6234</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7228">[RFC7228]</dt>
        <dd>
<span class="refAuthor">Bormann, C.</span><span class="refAuthor">, Ersue, M.</span><span class="refAuthor">, and A. Keranen</span>, <span class="refTitle">"Terminology for Constrained-Node Networks"</span>, <span class="seriesInfo">RFC 7228</span>, <span class="seriesInfo">DOI 10.17487/RFC7228</span>, <time class="refDate" datetime="2014-05">May 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7228">https://www.rfc-editor.org/info/rfc7228</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8613">[RFC8613]</dt>
      <dd>
<span class="refAuthor">Selander, G.</span><span class="refAuthor">, Mattsson, J.</span><span class="refAuthor">, Palombini, F.</span><span class="refAuthor">, and L. Seitz</span>, <span class="refTitle">"Object Security for Constrained RESTful Environments (OSCORE)"</span>, <span class="seriesInfo">RFC 8613</span>, <span class="seriesInfo">DOI 10.17487/RFC8613</span>, <time class="refDate" datetime="2019-07">July 2019</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8613">https://www.rfc-editor.org/info/rfc8613</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</section>
<div id="message-formats">
<section id="section-appendix.a">
      <h2 id="name-updated-message-formats">
<a class="section-number selfRef" href="#section-appendix.a">Appendix A. </a><a class="section-name selfRef" href="#name-updated-message-formats">Updated Message Formats</a>
      </h2>
<p id="section-appendix.a-1">
        In <a class="xref" href="#extended-tokens">Section 2</a>, this document updates the
        CoAP message formats by specifying a new definition of the "TKL"
        field in the message header. As an alternative presentation of
        this update, this appendix shows the CoAP message formats for
        <span><a class="xref" href="#RFC7252">CoAP over UDP</a> [<a class="xref" href="#RFC7252">RFC7252</a>]</span> and <span><a class="xref" href="#RFC8323">CoAP over TCP, TLS, and WebSockets</a> [<a class="xref" href="#RFC8323">RFC8323</a>]</span> with
        the new definition applied.<a class="pilcrow" href="#section-appendix.a-1">¶</a></p>
<section id="section-a.1">
        <h2 id="name-coap-over-udp">
<a class="section-number selfRef" href="#section-a.1">A.1. </a><a class="section-name selfRef" href="#name-coap-over-udp">CoAP over UDP</a>
        </h2>
<div class="artwork art-text alignCenter" id="section-a.1-1">
<pre>                0   1   2   3   4   5   6   7
              +-------+-------+---------------+
              |       |       |               |
              |  Ver  |   T   |      TKL      |   1 byte
              |       |       |               |
              +-------+-------+---------------+
              |                               |
              |             Code              |   1 byte
              |                               |
              +-------------------------------+
              |                               |
              |                               |
              |                               |
              +-         Message ID          -+   2 bytes
              |                               |
              |                               |
              |                               |
              +-------------------------------+
              \                               \
              /              TKL              /   0-2 bytes
              \          (extended)           \
              +-------------------------------+
              \                               \
              /             Token             /   0-65804 bytes
              \                               \
              +-------------------------------+
              \                               \
              /                               /
              \                               \
              /            Options            /   0 or more bytes
              \                               \
              /                               /
              \                               \
              +---------------+---------------+
              |               |               |
              |      15       |       15      |   1 byte (if payload)
              |               |               |
              +---------------+---------------+
              \                               \
              /                               /
              \                               \
              /            Payload            /   0 or more bytes
              \                               \
              /                               /
              \                               \
              +-------------------------------+
</pre><a class="pilcrow" href="#section-a.1-1">¶</a>
</div>
</section>
<section id="section-a.2">
        <h2 id="name-coap-over-tcp-tls">
<a class="section-number selfRef" href="#section-a.2">A.2. </a><a class="section-name selfRef" href="#name-coap-over-tcp-tls">CoAP over TCP/TLS</a>
        </h2>
<div class="artwork art-text alignCenter" id="section-a.2-1">
<pre>                0   1   2   3   4   5   6   7
              +---------------+---------------+
              |               |               |
              |      Len      |      TKL      |   1 byte
              |               |               |
              +---------------+---------------+
              \                               \
              /              Len              /   0-4 bytes
              \          (extended)           \
              +-------------------------------+
              |                               |
              |             Code              |   1 byte
              |                               |
              +-------------------------------+
              \                               \
              /              TKL              /   0-2 bytes
              \          (extended)           \
              +-------------------------------+
              \                               \
              /             Token             /   0-65804 bytes
              \                               \
              +-------------------------------+
              \                               \
              /                               /
              \                               \
              /            Options            /   0 or more bytes
              \                               \
              /                               /
              \                               \
              +---------------+---------------+
              |               |               |
              |      15       |       15      |   1 byte (if payload)
              |               |               |
              +---------------+---------------+
              \                               \
              /                               /
              \                               \
              /            Payload            /   0 or more bytes
              \                               \
              /                               /
              \                               \
              +-------------------------------+
</pre><a class="pilcrow" href="#section-a.2-1">¶</a>
</div>
</section>
<section id="section-a.3">
        <h2 id="name-coap-over-websockets">
<a class="section-number selfRef" href="#section-a.3">A.3. </a><a class="section-name selfRef" href="#name-coap-over-websockets">CoAP over WebSockets</a>
        </h2>
<div class="artwork art-text alignCenter" id="section-a.3-1">
<pre>                0   1   2   3   4   5   6   7
              +---------------+---------------+
              |               |               |
              |       0       |      TKL      |   1 byte
              |               |               |
              +---------------+---------------+
              |                               |
              |             Code              |   1 byte
              |                               |
              +-------------------------------+
              \                               \
              /              TKL              /   0-2 bytes
              \          (extended)           \
              +-------------------------------+
              \                               \
              /             Token             /   0-65804 bytes
              \                               \
              +-------------------------------+
              \                               \
              /                               /
              \                               \
              /            Options            /   0 or more bytes
              \                               \
              /                               /
              \                               \
              +---------------+---------------+
              |               |               |
              |      15       |       15      |   1 byte (if payload)
              |               |               |
              +---------------+---------------+
              \                               \
              /                               /
              \                               \
              /            Payload            /   0 or more bytes
              \                               \
              /                               /
              \                               \
              +-------------------------------+
</pre><a class="pilcrow" href="#section-a.3-1">¶</a>
</div>
</section>
</section>
</div>
<section id="section-appendix.b">
      <h2 id="name-acknowledgements">
<a class="section-name selfRef" href="#name-acknowledgements">Acknowledgements</a>
      </h2>
<p id="section-appendix.b-1">
        This document is based on the requirements of, and work on, "Constrained Join Protocol (CoJP) for 6TiSCH" (January 2020) by <span class="contact-name">Mališa Vučinić</span>, <span class="contact-name">Jonathan Simon</span>, <span class="contact-name">Kris Pister</span>, and
        <span class="contact-name">Michael Richardson</span>.<a class="pilcrow" href="#section-appendix.b-1">¶</a></p>
<p id="section-appendix.b-2">
        Thanks to
        <span class="contact-name">Christian Amsüss</span>,
        <span class="contact-name">Carsten Bormann</span>, 
        <span class="contact-name">Roman Danyliw</span>, 
        <span class="contact-name">Christer Holmberg</span>, 
        <span class="contact-name">Benjamin Kaduk</span>, 
        <span class="contact-name">Ari Keränen</span>, 
        <span class="contact-name">Erik Kline</span>, 
        <span class="contact-name">Murray Kucherawy</span>, 
        <span class="contact-name">Warren Kumari</span>, 
        <span class="contact-name">Barry Leiba</span>, 
        <span class="contact-name">David Mandelberg</span>, 
        <span class="contact-name">Dan Romascanu</span>, 
        <span class="contact-name">Jim Schaad</span>, 
        <span class="contact-name">Göran Selander</span>, 
        <span class="contact-name">Mališa Vučinić</span>, 
        <span class="contact-name">Éric Vyncke</span>,  and
        <span class="contact-name">Robert Wilton</span>
        for helpful comments and discussions that have shaped the document.<a class="pilcrow" href="#section-appendix.b-2">¶</a></p>
<p id="section-appendix.b-3">
        Special thanks to <span class="contact-name">John Mattsson</span> for his contributions to the security considerations of the document, and to <span class="contact-name">Thomas Fossati</span> for his in-depth review, copious comments, and suggested text.<a class="pilcrow" href="#section-appendix.b-3">¶</a></p>
</section>
<div id="authors-addresses">
<section id="section-appendix.c">
      <h2 id="name-authors-addresses">
<a class="section-name selfRef" href="#name-authors-addresses">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div class="left" dir="auto"><span class="fn nameRole">Klaus Hartke</span></div>
<div class="left" dir="auto"><span class="org">Ericsson</span></div>
<div class="left" dir="auto"><span class="street-address">Torshamnsgatan 23</span></div>
<div class="left" dir="auto">SE-<span class="postal-code">16483</span> <span class="locality">Stockholm</span>
</div>
<div class="left" dir="auto"><span class="country-name">Sweden</span></div>
<div class="email">
<span>Email:</span>
<a class="email" href="mailto:klaus.hartke@ericsson.com">klaus.hartke@ericsson.com</a>
</div>
</address>
<address class="vcard">
        <div class="left" dir="auto"><span class="fn nameRole">Michael C. Richardson</span></div>
<div class="left" dir="auto"><span class="org">Sandelman Software Works</span></div>
<div class="email">
<span>Email:</span>
<a class="email" href="mailto:mcr+ietf@sandelman.ca">mcr+ietf@sandelman.ca</a>
</div>
<div class="url">
<span>URI:</span>
<a class="url" href="http://www.sandelman.ca/">http://www.sandelman.ca/</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>


</body></html>