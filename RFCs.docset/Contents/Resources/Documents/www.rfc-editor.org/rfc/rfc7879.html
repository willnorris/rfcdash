<html><head></head><body><pre>Internet Engineering Task Force (IETF)                   R. Ravindranath
Request for Comments: 7879                                      T. Reddy
Category: Standards Track                                   G. Salgueiro
ISSN: 2070-1721                                                    Cisco
                                                              V. Pascual
                                                                  Oracle
                                                            P. Ravindran
                                                          Nokia Networks
                                                                May 2016


           <span class="h1">DTLS-SRTP Handling in SIP Back-to-Back User Agents</span>

Abstract

   Session Initiation Protocol (SIP) Back-to-Back User Agents (B2BUAs)
   exist on the signaling and media paths between the endpoints.  This
   document describes the behavior of B2BUAs when Secure Real-time
   Transport (SRTP) security context is set up with the Datagram
   Transport Layer Security (DTLS) protocol.

Status of This Memo

   This is an Internet Standards Track document.

   This document is a product of the Internet Engineering Task Force
   (IETF).  It represents the consensus of the IETF community.  It has
   received public review and has been approved for publication by the
   Internet Engineering Steering Group (IESG).  Further information on
   Internet Standards is available in <a href="./rfc7841#section-2">Section 2 of RFC 7841</a>.

   Information about the current status of this document, any errata,
   and how to provide feedback on it may be obtained at
   <a href="http://www.rfc-editor.org/info/rfc7879">http://www.rfc-editor.org/info/rfc7879</a>.

















<span class="grey">Ravindranath, et al.         Standards Track                    [Page 1]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-2"></span>
<span class="grey"><a href="./rfc7879">RFC 7879</a>             DTLS-SRTP Handling in SIP B2BUA            May 2016</span>


Copyright Notice

   Copyright (c) 2016 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="https://www.rfc-editor.org/bcp/bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.

Table of Contents

   <a href="#section-1">1</a>.  Introduction  . . . . . . . . . . . . . . . . . . . . . . . .   <a href="#page-3">3</a>
     <a href="#section-1.1">1.1</a>.  Overview  . . . . . . . . . . . . . . . . . . . . . . . .   <a href="#page-3">3</a>
     <a href="#section-1.2">1.2</a>.  Goals and Scope of this Document  . . . . . . . . . . . .   <a href="#page-4">4</a>
   <a href="#section-2">2</a>.  Terminology . . . . . . . . . . . . . . . . . . . . . . . . .   <a href="#page-4">4</a>
   <a href="#section-3">3</a>.  B2BUAs Procedures to Allow End-to-End DTLS-SRTP . . . . . . .   <a href="#page-5">5</a>
   <a href="#section-4">4</a>.  Signaling-Plane B2BUA Handling of DTLS-SRTP . . . . . . . . .   <a href="#page-5">5</a>
     <a href="#section-4.1">4.1</a>.  Proxy-B2BUAs  . . . . . . . . . . . . . . . . . . . . . .   <a href="#page-6">6</a>
     4.2.  Signaling-Only and SDP-Modifying Signaling-Only B2BUAs  .   6
   <a href="#section-5">5</a>.  Media-Plane B2BUA Handling of DTLS-SRTP . . . . . . . . . . .   <a href="#page-6">6</a>
     <a href="#section-5.1">5.1</a>.  General . . . . . . . . . . . . . . . . . . . . . . . . .   <a href="#page-6">6</a>
       <a href="#section-5.1.1">5.1.1</a>.  Media Relay . . . . . . . . . . . . . . . . . . . . .   <a href="#page-6">6</a>
       <a href="#section-5.1.2">5.1.2</a>.  RTP- and RTCP-Aware Media-Aware B2BUA . . . . . . . .   <a href="#page-8">8</a>
   <a href="#section-6">6</a>.  Forking Considerations  . . . . . . . . . . . . . . . . . . .   <a href="#page-9">9</a>
   <a href="#section-7">7</a>.  Security Considerations . . . . . . . . . . . . . . . . . . .  <a href="#page-10">10</a>
   <a href="#section-8">8</a>.  References  . . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-11">11</a>
     <a href="#section-8.1">8.1</a>.  Normative References  . . . . . . . . . . . . . . . . . .  <a href="#page-11">11</a>
     <a href="#section-8.2">8.2</a>.  Informative References  . . . . . . . . . . . . . . . . .  <a href="#page-11">11</a>
   Acknowledgments . . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-12">12</a>
   Contributors  . . . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-12">12</a>
   Authors' Addresses  . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-13">13</a>














<span class="grey">Ravindranath, et al.         Standards Track                    [Page 2]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-3"></span>
<span class="grey"><a href="./rfc7879">RFC 7879</a>             DTLS-SRTP Handling in SIP B2BUA            May 2016</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.%20%20Introduction"></a><a class="selflink" href="#section-1" id="section-1">1</a>.  Introduction</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.1.%20%20Overview"></a><a class="selflink" href="#section-1.1" id="section-1.1">1.1</a>.  Overview</span>

   [<a id="ref-RFC5763">RFC5763</a>] describes how the Session Initiation Protocol (SIP)
   [<a href="./rfc3261" title='"SIP: Session Initiation Protocol"'>RFC3261</a>] can be used to establish a Secure Real-time Transport
   Protocol (SRTP) [<a href="./rfc3711" title='"The Secure Real-time Transport Protocol (SRTP)"'>RFC3711</a>] security context with the Datagram
   Transport Layer Security (DTLS) protocol [<a href="./rfc6347" title='"Datagram Transport Layer Security Version 1.2"'>RFC6347</a>].  It describes a
   mechanism for transporting a certificate fingerprint using the
   Session Description Protocol (SDP) [<a href="./rfc4566" title='"SDP: Session Description Protocol"'>RFC4566</a>].  The fingerprint
   identifies the certificate that will be presented during the DTLS
   handshake.  DTLS-SRTP is currently defined for point-to-point media
   sessions, in which there are exactly two participants.  Each DTLS-
   SRTP session (described in <a href="./rfc5764#section-3">Section 3 of [RFC5764]</a>) contains a single
   DTLS connection (if RTP and RTP Control Protocol (RTCP) are
   multiplexed) or two DTLS connections (if RTP and RTCP are not
   multiplexed), and either two SRTP contexts (if media traffic is
   flowing in both directions on the same 5-tuple) or one SRTP context
   (if media traffic is only flowing in one direction).

   In many SIP deployments, SIP Back-to-Back User Agents (B2BUA)
   entities exist on the SIP-signaling path between the endpoints.  As
   described in [<a href="./rfc7092" title='"A Taxonomy of Session Initiation Protocol (SIP) Back-to-Back User Agents"'>RFC7092</a>], these B2BUAs can modify SIP and SDP
   information.  For example, as described in <a href="./rfc7092#section-3.1.3">Section 3.1.3 of
   [RFC7092]</a>, SDP-modifying signaling-only B2BUAs can potentially modify
   the SDP.  B2BUAs can also be present on the media path, in which case
   they modify parts of the SDP information (like IP address, port) and
   subsequently modify the RTP headers as well.  Such B2BUAs are
   referred to as "media-plane B2BUAs".  [<a href="./rfc7092" title='"A Taxonomy of Session Initiation Protocol (SIP) Back-to-Back User Agents"'>RFC7092</a>] describes two
   different categories of media-plane B2BUAs, according to the level of
   activities performed on the media plane.

   When B2BUAs are present in a call between two SIP User Agents (UAs),
   they often make end-to-end DTLS-SRTP sessions impossible.  An "end-
   to-end DTLS-SRTP session" means that man-in-the-middle devices cannot
   break the DTLS-SRTP session between the endpoints.  In other words,
   the man-in-the-middle device cannot create a separate DTLS-SRTP
   session between the client and the middle device on one side, and the
   middle device and the remote peer on the other side.  B2BUAs may be
   deployed for address hiding or media latching [<a href="./rfc7362" title='"Latching: Hosted NAT Traversal (HNT) for Media in Real-Time Communication"'>RFC7362</a>], although
   Traversal Using Relays around NAT (TURN) and Interactive Connectivity
   Establishment (ICE) are expected to be used more often for this
   purpose as it provides better security properties.  Such B2BUAs are
   able to perform their functions without requiring termination of
   DTLS-SRTP sessions, i.e., these B2BUAs need not act as DTLS proxy and
   decrypt the RTP payload.





<span class="grey">Ravindranath, et al.         Standards Track                    [Page 3]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-4"></span>
<span class="grey"><a href="./rfc7879">RFC 7879</a>             DTLS-SRTP Handling in SIP B2BUA            May 2016</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.2.%20%20Goals%20and%20Scope%20of%20this%20Document"></a><a class="selflink" href="#section-1.2" id="section-1.2">1.2</a>.  Goals and Scope of this Document</span>

   A B2BUA could be deployed for address hiding or media latching as
   described in [<a href="./rfc7362" title='"Latching: Hosted NAT Traversal (HNT) for Media in Real-Time Communication"'>RFC7362</a>].  Such B2BUAs only terminate the media plane
   at the IP and transport (UDP/TCP) layers and may inspect the RTP
   headers or RTP Control Protocol (RTCP) packets.  The goal of this
   specification is to provide guidance on how such B2BUAs function
   without breaking the end-to-end DTLS-SRTP session.  A B2BUA could
   also terminate the media, or modify the RTP headers or RTP Control
   Protocol (RTCP) packets.  Such B2BUAs will not allow end-to-end DTLS-
   SRTP.  The recommendations made in this document are not expected to
   be applied by B2BUAs terminating DTLS-SRTP sessions given deployment
   reality.

   This specification assumes that a B2BUA is not providing identity
   assurance and is not authorized to terminate the DTLS-SRTP session.
   A B2BUA that provides identity assurance on behalf of endpoints
   behind it can modify any portion of SIP and SDP before it generates
   the identity signature.  As the B2BUA is generating the identity
   signature, it is not possible to detect if a B2BUA has terminated the
   DTLS-SRTP session.  B2BUAs providing identity assurance and
   terminating DTLS-SRTP sessions are out of scope of this document.

   The following sections describe the behavior B2BUAs can follow to
   avoid breaking end-to-end DTLS-SRTP sessions.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/2.%20%20Terminology"></a><a class="selflink" href="#section-2" id="section-2">2</a>.  Terminology</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in [<a href="./rfc2119" title='"Key words for use in RFCs to Indicate Requirement Levels"'>RFC2119</a>].

   Transport Address: The combination of an IP address and port number.

   The following generalized terms are defined in <a href="./rfc3261#section-6">[RFC3261], Section 6</a>.

      B2BUA: A SIP Back-to-Back User Agent, which is the logical
      combination of a User Agent Server (UAS) and a User Agent Client
      (UAC).

      UAS: A SIP User Agent Server.

      UAC: A SIP User Agent Client.

   All of the pertinent B2BUA terminology and taxonomy used in this
   document are based on [<a href="./rfc7092" title='"A Taxonomy of Session Initiation Protocol (SIP) Back-to-Back User Agents"'>RFC7092</a>].





<span class="grey">Ravindranath, et al.         Standards Track                    [Page 4]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-5"></span>
<span class="grey"><a href="./rfc7879">RFC 7879</a>             DTLS-SRTP Handling in SIP B2BUA            May 2016</span>


   It is assumed the reader is already familiar with the fundamental
   concepts of the RTP protocol [<a href="./rfc3550" title='"RTP: A Transport Protocol for Real-Time Applications"'>RFC3550</a>] and its taxonomy [<a href="./rfc7656" title='"A Taxonomy of Semantics and Mechanisms for Real-Time Transport Protocol (RTP) Sources"'>RFC7656</a>], as
   well as those of SRTP [<a href="./rfc3711" title='"The Secure Real-time Transport Protocol (SRTP)"'>RFC3711</a>] and DTLS [<a href="./rfc6347" title='"Datagram Transport Layer Security Version 1.2"'>RFC6347</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.%20%20B2BUAs%20Procedures%20to%20Allow%20End-to-End%20DTLS-SRTP"></a><a class="selflink" href="#section-3" id="section-3">3</a>.  B2BUAs Procedures to Allow End-to-End DTLS-SRTP</span>

   A B2BUA MUST follow the rules mentioned below to allow end-to-end
   DTLS-SRTP sessions.

   1.  B2BUAs MUST forward the certificate fingerprint and SDP setup
       attribute it receives from one endpoint unmodified towards the
       other endpoint and vice versa.

   2.  The enhancements described in [<a href="./rfc4474" title='"Enhancements for Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>RFC4474</a>] provide a means for
       signing portions of SIP requests in order to provide identity
       assurance and certificate pinning by providing an identity
       signature over the SDP that carries the fingerprint of keying for
       DTLS-SRTP [<a href="./rfc5763" title='"Framework for Establishing a Secure Real-time Transport Protocol (SRTP) Security Context Using Datagram Transport Layer Security (DTLS)"'>RFC5763</a>].  B2BUAs can identify that the enhancements
       in [<a href="./rfc4474" title='"Enhancements for Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>RFC4474</a>] are used for identity assurance if the SIP request
       contains both Identity and Identity-Info headers.  In cases where
       endpoints use [<a href="./rfc4474" title='"Enhancements for Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>RFC4474</a>], B2BUAs MUST ensure that it does not
       modify any of the information used to construct the identity
       signature.  This includes the entire SDP body and portions of the
       SIP header as described in [<a href="./rfc4474" title='"Enhancements for Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>RFC4474</a>].  In this case, a B2BUA
       cannot act as a media-relay B2BUA.

   3.  [<a href="#ref-SIP-ID" title='"Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>SIP-ID</a>] is introduced to overcome the limitations of [<a href="./rfc4474" title='"Enhancements for Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>RFC4474</a>]
       (discussed in Section 1 of [<a href="#ref-SIP-ID" title='"Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>SIP-ID</a>]).  Unlike [<a href="./rfc4474" title='"Enhancements for Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>RFC4474</a>], [<a href="#ref-SIP-ID" title='"Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>SIP-ID</a>]
       does not generate an identity signature over material that
       intermediaries in the field commonly alter.  In this case, a
       B2BUA can act as a media-relay B2BUA.  B2BUAs can identify that
       [<a href="#ref-SIP-ID" title='"Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>SIP-ID</a>] is used for identity assurance if the SIP request
       contains an Identity header but does not include an Identity-Info
       header.  The Identity-Info header is deprecated in [<a href="#ref-SIP-ID" title='"Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>SIP-ID</a>].  A
       B2BUA MUST ensure that it does not modify any of the headers used
       to construct the identity signature.

   4.  Both media relays and media-aware relays MUST NOT modify the
       authenticated portion of RTP and RTCP packets, and MUST NOT
       modify the authentication tag in the RTP and RTCP packets.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.%20%20Signaling-Plane%20B2BUA%20Handling%20of%20DTLS-SRTP"></a><a class="selflink" href="#section-4" id="section-4">4</a>.  Signaling-Plane B2BUA Handling of DTLS-SRTP</span>

   <a href="./rfc7092#section-3.1">Section 3.1 of [RFC7092]</a> describes different categories of signaling-
   plane B2BUAs.  This section explains how these B2BUAs are expected to
   comply with the recommendations in <a href="#section-3">Section 3</a>.





<span class="grey">Ravindranath, et al.         Standards Track                    [Page 5]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-6"></span>
<span class="grey"><a href="./rfc7879">RFC 7879</a>             DTLS-SRTP Handling in SIP B2BUA            May 2016</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.1.%20%20Proxy-B2BUAs"></a><a class="selflink" href="#section-4.1" id="section-4.1">4.1</a>.  Proxy-B2BUAs</span>

   Proxy-B2BUAs, as defined in <a href="./rfc7092#section-3.1.1">Section 3.1.1 of [RFC7092]</a>, modify only
   the Via and Record-Route SIP headers.  These B2BUAs can continue to
   perform their function and still allow end-to-end DTLS-SRTP sessions
   since none of the headers used to construct the identity signature
   are modified.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.2.%20%20Signaling-Only%20and%20SDP-Modifying%20Signaling-Only%20B2BUAs"></a><a class="selflink" href="#section-4.2" id="section-4.2">4.2</a>.  Signaling-Only and SDP-Modifying Signaling-Only B2BUAs</span>

   These categories of B2BUAs are likely to modify headers that are used
   to construct the identity signature.  For example, a signaling-only
   B2BUA can modify the Contact URI.  Such B2BUAs are likely to violate
   rule 2 or rule 3 in <a href="#section-3">Section 3</a>.  Depending upon the application
   requirements, such a B2BUA may be able to limit modification of
   header fields to those allowed to be modified by [<a href="./rfc4474" title='"Enhancements for Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>RFC4474</a>] or
   [<a href="#ref-SIP-ID" title='"Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>SIP-ID</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.%20%20Media-Plane%20B2BUA%20Handling%20of%20DTLS-SRTP"></a><a class="selflink" href="#section-5" id="section-5">5</a>.  Media-Plane B2BUA Handling of DTLS-SRTP</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.1.%20%20General"></a><a class="selflink" href="#section-5.1" id="section-5.1">5.1</a>.  General</span>

   This section describes how the different types of media-plane B2BUAs
   defined in [<a href="./rfc7092" title='"A Taxonomy of Session Initiation Protocol (SIP) Back-to-Back User Agents"'>RFC7092</a>] are expected to comply with the recommendations
   in <a href="#section-3">Section 3</a>.

<span class="h4"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.1.1.%20%20Media%20Relay"></a><a class="selflink" href="#section-5.1.1" id="section-5.1.1">5.1.1</a>.  Media Relay</span>

   From an application-layer point of view, a media relay (as defined in
   <a href="./rfc7092#section-3.2.1">Section 3.2.1 of [RFC7092]</a>) forwards all packets it receives on a
   negotiated connection, without inspecting or modifying the packet
   contents.  A media relay only modifies the transport layer (UDP/TCP)
   and IP headers.

   A media-relay B2BUA follows rule 1 mentioned in <a href="#section-3">Section 3</a> and
   forwards the certificate fingerprint and SDP setup attribute it
   receives from one endpoint unmodified towards the other endpoint and
   vice versa.  The following example shows a SIP call establishment
   flow, with both SIP endpoints (user agents) using DTLS-SRTP, and a
   media-relay B2BUA.











<span class="grey">Ravindranath, et al.         Standards Track                    [Page 6]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-7"></span>
<span class="grey"><a href="./rfc7879">RFC 7879</a>             DTLS-SRTP Handling in SIP B2BUA            May 2016</span>


       +-------+            +-------------------+             +-----+
       | Alice |            | Media-Relay B2BUA |             | Bob |
       +-------+            +-------------------+             +-----+
           |(1) INVITE               |  (3) INVITE               |
           |   a=setup:actpass       |   a=setup:actpass         |
           |   a=fingerprint1        |   a=fingerprint1          |
           |   (Alice's IP/port)     |   (B2BUAs IP/port)        |
           |------------------------&gt;|--------------------------&gt;|
           |                         |                           |
           |    (2)  100 trying      |                           |
           |&lt;------------------------|                           |
           |                         | (4) 100 trying            |
           |                         |&lt;--------------------------|
           |                         |                           |
           |                         |  (5) 200 OK               |
           |                         |   a=setup:active          |
           |                         |    a=fingerprint2         |
           |                         |  (Bob's IP/port)          |
           |&lt;------------------------|&lt;--------------------------|
           |    (6) 200 OK           |                           |
           |    a=setup:active       |                           |
           |    a=fingerprint2       |                           |
           |    B2BUAs IP/port       |                           |
           |               (7, 8) ClientHello + use_srtp         |
           |&lt;----------------------------------------------------|
           |(B2BUA changes transport(UDP/TCP) and IP header)     |
           |                         |                           |
           |                         |                           |
           |           (9,10) ServerHello + use_srtp             |
           |----------------------------------------------------&gt;|
           |(B2BUA changes transport(UDP/TCP) and IP header)     |
           |                         |                           |
           |                         |                           |
           |                 (11)    |                           |
           |  [Certificate exchange between Alice and Bob over   |
           |   DTLS ]                |                           |
           |                         |                           |
           |         (12)            |                           |
           |&lt;---------SRTP/SRTCP-----------SRTP/SRTCP-----------&gt;|
           | [B2BUA changes transport(UDP/TCP) and IP headers]   |

         Figure 1: INVITE with SDP Call Flow for Media-Relay B2BUA

   Note: For brevity, the entire value of the SDP fingerprint attribute
   is not shown.  The example here shows only one DTLS connection for
   the sake of simplicity.  In reality, depending on whether the RTP and
   RTCP flows are multiplexed or demultiplexed, there will be one or two
   DTLS connections.



<span class="grey">Ravindranath, et al.         Standards Track                    [Page 7]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-8"></span>
<span class="grey"><a href="./rfc7879">RFC 7879</a>             DTLS-SRTP Handling in SIP B2BUA            May 2016</span>


   If RTP and RTCP traffic is multiplexed on a single port as described
   in [<a href="./rfc5761" title='"Multiplexing RTP Data and Control Packets on a Single Port"'>RFC5761</a>], then only a single DTLS connection is required between
   the peers.  If RTP and RTCP are not multiplexed, then the peers would
   have to establish two DTLS connections.  In this case, after
   receiving an INVITE request, Bob triggers the establishment of a DTLS
   connection.  Note that the DTLS handshake and the sending of the
   INVITE response can happen in parallel; thus, the B2BUA has to be
   prepared to receive DTLS, Session Traversal Utilities for NAT (STUN),
   and media on the ports it advertised to Bob in the SDP offer before
   it receives an SDP answer from Bob. Since a media-relay B2BUA does
   not differentiate between a DTLS message, RTP, or any packet it
   receives, it only changes the transport layer (UDP/TCP) and IP
   headers and forwards the packet towards the other endpoint.  The
   B2BUA cannot decrypt the RTP payload, as the payload is encrypted
   using the SRTP keys derived from the DTLS connection setup between
   Alice and Bob.

   If the endpoints use [<a href="./rfc4474" title='"Enhancements for Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>RFC4474</a>], a B2BUA cannot function as a media-
   relay without violating rule 2 in <a href="#section-3">Section 3</a>.  If [<a href="#ref-SIP-ID" title='"Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>SIP-ID</a>] is used, a
   B2BUA can modify the IP address in the c= line and the port in the m=
   line in the SDP as long as it does not otherwise violate rule 3 in
   <a href="#section-3">Section 3</a>.

<span class="h4"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.1.2.%20%20RTP-%20and%20RTCP-Aware%20Media-Aware%20B2BUA"></a><a class="selflink" href="#section-5.1.2" id="section-5.1.2">5.1.2</a>.  RTP- and RTCP-Aware Media-Aware B2BUA</span>

   Unlike the media relay discussed in <a href="#section-5.1.1">Section 5.1.1</a>, a media-aware
   relay as defined in <a href="./rfc7092#section-3.2.2">Section 3.2.2 of [RFC7092]</a> is aware of the type
   of media traffic it is receiving.  There are two types of media-aware
   relays, those that merely inspect the RTP headers and unencrypted
   portions of RTCP packets, and those that inspect and modify the RTP
   headers and unencrypted portions of RTCP packets.

<span class="h5"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.1.2.1.%20%20RTP%20Header%20and%20RTCP%20Packets%20Inspection"></a><a class="selflink" href="#section-5.1.2.1" id="section-5.1.2.1">5.1.2.1</a>.  RTP Header and RTCP Packets Inspection</span>

   An RTP-/RTCP-aware media relay does not modify the RTP headers and
   RTCP packets but only inspects the packets.  Such B2BUAs follow rule
   4 in <a href="#section-3">Section 3</a> and can continue to do their function while allowing
   end-to-end DTLS-SRTP.  Inspection by the B2BUA will not reveal the
   clear-text for encrypted parts of the SRTP/SRTCP packets.

<span class="h5"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.1.2.2.%20%20RTP%20Header%20and%20RTCP%20Packet%20Modification"></a><a class="selflink" href="#section-5.1.2.2" id="section-5.1.2.2">5.1.2.2</a>.  RTP Header and RTCP Packet Modification</span>

   A B2BUA cannot modify RTP headers or RTCP packets, as to do so it
   would need to act as a DTLS endpoint, terminate the DTLS-SRTP
   session, and decrypt/re-encrypt RTP packets.  If a B2BUA modifies
   unencrypted or encrypted portions of the RTP or RTCP packets, then
   the integrity check will fail and the packet will be dropped by the
   endpoint.  The unencrypted and encrypted portions of the RTP or RTCP



<span class="grey">Ravindranath, et al.         Standards Track                    [Page 8]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-9"></span>
<span class="grey"><a href="./rfc7879">RFC 7879</a>             DTLS-SRTP Handling in SIP B2BUA            May 2016</span>


   packets are integrity protected using the HMAC algorithm negotiated
   during the DTLS handshake (discussed in <a href="./rfc5764#section-4.1.2">Section 4.1.2 of [RFC5764]</a>).
   B2BUAs have to follow the rules in <a href="#section-3">Section 3</a> to avoid breaking the
   integrity of SRTP/SRTCP streams.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/6.%20%20Forking%20Considerations"></a><a class="selflink" href="#section-6" id="section-6">6</a>.  Forking Considerations</span>

   Due to forking [<a href="./rfc3261" title='"SIP: Session Initiation Protocol"'>RFC3261</a>], a SIP request carrying an SDP offer sent by
   an endpoint (offerer) can reach multiple remote endpoints.  As a
   result, multiple DTLS-SRTP sessions can be established, one between
   the endpoint that sent the SIP request and each of the remote
   endpoints that received the request.  B2BUAs have to follow rule 1 in
   <a href="#section-3">Section 3</a> while handling offer/answer and forward the certificate
   fingerprints and SDP setup attributes it received in the SDP answer
   from each endpoint (answerer) unmodified towards the offerer.  Since
   each DTLS connection is set up on a unique 5-tuple, B2BUA replaces
   the answerer's transport addresses in each answer with its unique
   transport addresses so that the offerer can establish a DTLS
   connection with each answerer.  The B2BUA, acting as a media relay
   here, follows rule 4 mentioned in <a href="#section-3">Section 3</a>.

                                             Bob (192.0.2.1:6666)
                                            /
                                           /
                                          / DTLS-SRTP=XXX
                                         /
                                        /
                         DTLS-SRTP=XXX v
                         &lt;-----------&gt;  (192.0.2.3:7777)
   Alice (192.0.2.0:5555)             B2BUA
                         &lt;-----------&gt;  (192.0.2.3:8888)
                         DTLS-SRTP=YYY ^
                                        \
                                         \  DTLS-SRTP=YYY
                                          \
                                           \
                                            \
                                             Charlie (192.0.2.2:6666)

                 Figure 2: B2BUA Handling Multiple Answers

   For instance, as shown in Figure 2, Alice sends a request with an
   offer and the request is forked.  Alice receives answers from both
   Bob and Charlie.  The B2BUA advertises different B2BUA transport
   addresses in each answer, as shown in Figure 2, where XXX and YYY
   represent different DTLS-SRTP sessions.  The B2BUA replaces Bob's
   transport address (192.0.2.1:6666) in the answer with its transport
   address (192.0.2.3:7777) and Charlie's transport address



<span class="grey">Ravindranath, et al.         Standards Track                    [Page 9]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-10"></span>
<span class="grey"><a href="./rfc7879">RFC 7879</a>             DTLS-SRTP Handling in SIP B2BUA            May 2016</span>


   (192.0.2.2:6666) in the answer with its transport address
   (192.0.2.3:8888).  The B2BUA tracks the remote sources (Bob and
   Charlie) and associates them to the local sources that are used to
   send packets to Alice.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/7.%20%20Security%20Considerations"></a><a class="selflink" href="#section-7" id="section-7">7</a>.  Security Considerations</span>

   This document describes the behavior B2BUAs must follow to avoid
   breaking end-to-end DTLS-SRTP.  Media relays that modify RTP or RTCP,
   or modify SIP header fields or SDP fields that are protected by the
   identity signature, are incompatible with end-to-end DTLS-SRTP.  Such
   relays are out of scope for this document.  Security considerations
   discussed in [<a href="./rfc5763" title='"Framework for Establishing a Secure Real-time Transport Protocol (SRTP) Security Context Using Datagram Transport Layer Security (DTLS)"'>RFC5763</a>] are also applicable to this document.  In
   addition, the B2BUA behaviors outlined in this document do not impact
   the security and integrity of a DTLS-SRTP session or the data
   exchanged over it.  A malicious B2BUA can try to break into the DTLS
   connection, but such an attack can be prevented using the identity
   validation mechanism discussed in [<a href="./rfc4474" title='"Enhancements for Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>RFC4474</a>] or [<a href="#ref-SIP-ID" title='"Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>SIP-ID</a>].  Either the
   endpoints or the authentication service proxies involved in the call
   can use the identity validation mechanisms discussed in [<a href="./rfc4474" title='"Enhancements for Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>RFC4474</a>] or
   [<a href="#ref-SIP-ID" title='"Authenticated Identity Management in the Session Initiation Protocol (SIP)"'>SIP-ID</a>] to validate the identity of peers and detect malicious
   B2BUAs that can attempt to terminate the DTLS connection to decrypt
   the RTP payload.




























<span class="grey">Ravindranath, et al.         Standards Track                   [Page 10]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-11"></span>
<span class="grey"><a href="./rfc7879">RFC 7879</a>             DTLS-SRTP Handling in SIP B2BUA            May 2016</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/8.%20%20References"></a><a class="selflink" href="#section-8" id="section-8">8</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/8.1.%20%20Normative%20References"></a><a class="selflink" href="#section-8.1" id="section-8.1">8.1</a>.  Normative References</span>

   [<a id="ref-RFC2119">RFC2119</a>]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", <a href="https://www.rfc-editor.org/bcp/bcp14">BCP 14</a>, <a href="./rfc2119">RFC 2119</a>,
              DOI 10.17487/RFC2119, March 1997,
              &lt;<a href="http://www.rfc-editor.org/info/rfc2119">http://www.rfc-editor.org/info/rfc2119</a>&gt;.

   [<a id="ref-RFC3550">RFC3550</a>]  Schulzrinne, H., Casner, S., Frederick, R., and V.
              Jacobson, "RTP: A Transport Protocol for Real-Time
              Applications", STD 64, <a href="./rfc3550">RFC 3550</a>, DOI 10.17487/RFC3550,
              July 2003, &lt;<a href="http://www.rfc-editor.org/info/rfc3550">http://www.rfc-editor.org/info/rfc3550</a>&gt;.

   [<a id="ref-RFC3711">RFC3711</a>]  Baugher, M., McGrew, D., Naslund, M., Carrara, E., and K.
              Norrman, "The Secure Real-time Transport Protocol (SRTP)",
              <a href="./rfc3711">RFC 3711</a>, DOI 10.17487/RFC3711, March 2004,
              &lt;<a href="http://www.rfc-editor.org/info/rfc3711">http://www.rfc-editor.org/info/rfc3711</a>&gt;.

   [<a id="ref-RFC5763">RFC5763</a>]  Fischl, J., Tschofenig, H., and E. Rescorla, "Framework
              for Establishing a Secure Real-time Transport Protocol
              (SRTP) Security Context Using Datagram Transport Layer
              Security (DTLS)", <a href="./rfc5763">RFC 5763</a>, DOI 10.17487/RFC5763, May
              2010, &lt;<a href="http://www.rfc-editor.org/info/rfc5763">http://www.rfc-editor.org/info/rfc5763</a>&gt;.

   [<a id="ref-RFC5764">RFC5764</a>]  McGrew, D. and E. Rescorla, "Datagram Transport Layer
              Security (DTLS) Extension to Establish Keys for the Secure
              Real-time Transport Protocol (SRTP)", <a href="./rfc5764">RFC 5764</a>,
              DOI 10.17487/RFC5764, May 2010,
              &lt;<a href="http://www.rfc-editor.org/info/rfc5764">http://www.rfc-editor.org/info/rfc5764</a>&gt;.

   [<a id="ref-RFC6347">RFC6347</a>]  Rescorla, E. and N. Modadugu, "Datagram Transport Layer
              Security Version 1.2", <a href="./rfc6347">RFC 6347</a>, DOI 10.17487/RFC6347,
              January 2012, &lt;<a href="http://www.rfc-editor.org/info/rfc6347">http://www.rfc-editor.org/info/rfc6347</a>&gt;.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/8.2.%20%20Informative%20References"></a><a class="selflink" href="#section-8.2" id="section-8.2">8.2</a>.  Informative References</span>

   [<a id="ref-RFC3261">RFC3261</a>]  Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston,
              A., Peterson, J., Sparks, R., Handley, M., and E.
              Schooler, "SIP: Session Initiation Protocol", <a href="./rfc3261">RFC 3261</a>,
              DOI 10.17487/RFC3261, June 2002,
              &lt;<a href="http://www.rfc-editor.org/info/rfc3261">http://www.rfc-editor.org/info/rfc3261</a>&gt;.

   [<a id="ref-RFC4474">RFC4474</a>]  Peterson, J. and C. Jennings, "Enhancements for
              Authenticated Identity Management in the Session
              Initiation Protocol (SIP)", <a href="./rfc4474">RFC 4474</a>,
              DOI 10.17487/RFC4474, August 2006,
              &lt;<a href="http://www.rfc-editor.org/info/rfc4474">http://www.rfc-editor.org/info/rfc4474</a>&gt;.



<span class="grey">Ravindranath, et al.         Standards Track                   [Page 11]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-12"></span>
<span class="grey"><a href="./rfc7879">RFC 7879</a>             DTLS-SRTP Handling in SIP B2BUA            May 2016</span>


   [<a id="ref-RFC4566">RFC4566</a>]  Handley, M., Jacobson, V., and C. Perkins, "SDP: Session
              Description Protocol", <a href="./rfc4566">RFC 4566</a>, DOI 10.17487/RFC4566,
              July 2006, &lt;<a href="http://www.rfc-editor.org/info/rfc4566">http://www.rfc-editor.org/info/rfc4566</a>&gt;.

   [<a id="ref-RFC5761">RFC5761</a>]  Perkins, C. and M. Westerlund, "Multiplexing RTP Data and
              Control Packets on a Single Port", <a href="./rfc5761">RFC 5761</a>,
              DOI 10.17487/RFC5761, April 2010,
              &lt;<a href="http://www.rfc-editor.org/info/rfc5761">http://www.rfc-editor.org/info/rfc5761</a>&gt;.

   [<a id="ref-RFC7092">RFC7092</a>]  Kaplan, H. and V. Pascual, "A Taxonomy of Session
              Initiation Protocol (SIP) Back-to-Back User Agents",
              <a href="./rfc7092">RFC 7092</a>, DOI 10.17487/RFC7092, December 2013,
              &lt;<a href="http://www.rfc-editor.org/info/rfc7092">http://www.rfc-editor.org/info/rfc7092</a>&gt;.

   [<a id="ref-RFC7362">RFC7362</a>]  Ivov, E., Kaplan, H., and D. Wing, "Latching: Hosted NAT
              Traversal (HNT) for Media in Real-Time Communication",
              <a href="./rfc7362">RFC 7362</a>, DOI 10.17487/RFC7362, September 2014,
              &lt;<a href="http://www.rfc-editor.org/info/rfc7362">http://www.rfc-editor.org/info/rfc7362</a>&gt;.

   [<a id="ref-RFC7656">RFC7656</a>]  Lennox, J., Gross, K., Nandakumar, S., Salgueiro, G., and
              B. Burman, Ed., "A Taxonomy of Semantics and Mechanisms
              for Real-Time Transport Protocol (RTP) Sources", <a href="./rfc7656">RFC 7656</a>,
              DOI 10.17487/RFC7656, November 2015,
              &lt;<a href="http://www.rfc-editor.org/info/rfc7656">http://www.rfc-editor.org/info/rfc7656</a>&gt;.

   [<a id="ref-SIP-ID">SIP-ID</a>]   Peterson, J., Jennings, C., Rescorla, E., and C. Wendt,
              "Authenticated Identity Management in the Session
              Initiation Protocol (SIP)", Work in Progress,
              <a href="./draft-ietf-stir-rfc4474bis-09">draft-ietf-stir-rfc4474bis-09</a>, May 2016

Acknowledgments

   Special thanks to Lorenzo Miniero, Ranjit Avarsala, Hadriel Kaplan,
   Muthu Arul Mozhi, Paul Kyzivat, Peter Dawes, Brett Tate, Dan Wing,
   Charles Eckel, Simon Perreault, Albrecht Schwarz, Jens Guballa,
   Christer Holmberg, Colin Perkins, Ben Campbell, and Alissa Cooper for
   their constructive comments, suggestions, and early reviews that were
   critical to the formulation and refinement of this document.  The
   authors would also like to thank Dan Romascanu, Vijay K. Gurbani,
   Francis Dupont, Paul Wouters, and Stephen Farrell for their review
   and feedback of this document.

Contributors

   Rajeev Seth provided substantial contributions to this document.






<span class="grey">Ravindranath, et al.         Standards Track                   [Page 12]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-13"></span>
<span class="grey"><a href="./rfc7879">RFC 7879</a>             DTLS-SRTP Handling in SIP B2BUA            May 2016</span>


Authors' Addresses

   Ram Mohan Ravindranath
   Cisco
   Cessna Business Park
   Sarjapur-Marathahalli Outer Ring Road
   Bangalore, Karnataka  560103
   India

   Email: rmohanr@cisco.com


   Tirumaleswar Reddy
   Cisco
   Cessna Business Park
   Sarjapur Marathalli Outer Ring Road
   Bangalore, Karnataka  560103
   India

   Email: tireddy@cisco.com


   Gonzalo Salgueiro
   Cisco Systems, Inc.
   7200-12 Kit Creek Road
   Research Triangle Park, NC  27709
   United States

   Email: gsalguei@cisco.com


   Victor Pascual
   Oracle
   Barcelona, Spain

   Email: victor.pascual.avila@oracle.com


   Parthasarathi Ravindran
   Nokia Networks
   Bangalore, Karnataka
   India

   Email: partha@parthasarathi.co.in







Ravindranath, et al.         Standards Track                   [Page 13]
</pre>
</body></html>