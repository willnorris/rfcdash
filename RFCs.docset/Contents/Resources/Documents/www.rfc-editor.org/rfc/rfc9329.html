<!DOCTYPE html>
<html class="RFC" lang="en"><head>
<meta charset="utf-8"/>
<meta content="Common,Latin" name="scripts"/>
<meta content="initial-scale=1.0" name="viewport"/>
<title>RFC 9329: TCP Encapsulation of Internet Key Exchange Protocol (IKE) and IPsec Packets</title>
<meta content="Tommy Pauly" name="author"/>
<meta content="Valery Smyslov" name="author"/>
<meta content='
        This document describes a method to transport Internet Key Exchange
        Protocol (IKE) and IPsec packets over a TCP connection for traversing
        network middleboxes that may block IKE negotiation over UDP.  This
        method, referred to as "TCP encapsulation", involves sending both IKE
        packets for Security Association (SA) establishment and Encapsulating
        Security Payload (ESP) packets over a TCP connection.  This method is
        intended to be used as a fallback option when IKE cannot be
        negotiated over UDP.
       
       TCP encapsulation for IKE and IPsec was defined in RFC 8229.
        This document clarifies the specification for TCP encapsulation by including
        additional clarifications obtained during implementation and deployment
        of this method. This documents obsoletes RFC 8229.
       
    ' name="description"/>
<meta content="xml2rfc 3.15.2" name="generator"/>
<meta content="9329" name="rfc.number"/>
<!-- Generator version information:
  xml2rfc 3.15.2
    Python 3.9.14
    appdirs 1.4.4
    ConfigArgParse 1.5.3
    google-i18n-address 2.5.1
    html5lib 1.1
    intervaltree 3.1.0
    Jinja2 3.1.2
    lxml 4.9.0
    MarkupSafe 2.1.1
    pycountry 22.3.5
    PyYAML 6.0
    requests 2.28.0
    setuptools 44.1.1
    six 1.16.0
    wcwidth 0.2.5
    weasyprint 56.1
-->
<link href="rfc9329.xml" rel="alternate" type="application/rfc+xml"/>
<link href="#copyright" rel="license"/>
<style type="text/css">/*

  NOTE: Changes at the bottom of this file overrides some earlier settings.

  Once the style has stabilized and has been adopted as an official RFC style,
  this can be consolidated so that style settings occur only in one place, but
  for now the contents of this file consists first of the initial CSS work as
  provided to the RFC Formatter (xml2rfc) work, followed by itemized and
  commented changes found necessary during the development of the v3
  formatters.

*/

/* fonts */
@import url('https://fonts.googleapis.com/css?family=Noto+Sans'); /* Sans-serif */
@import url('https://fonts.googleapis.com/css?family=Noto+Serif'); /* Serif (print) */
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono'); /* Monospace */

@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}
/* general and mobile first */
html {
}
body {
  max-width: 90%;
  margin: 1.5em auto;
  color: #222;
  background-color: #fff;
  font-size: 14px;
  font-family: 'Noto Sans', Arial, Helvetica, sans-serif;
  line-height: 1.6;
  scroll-behavior: smooth;
}
.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  margin: 1em 0 0.5em;
  font-weight: bold;
  line-height: 1.3;
}
#title {
  clear: both;
  border-bottom: 1px solid #ddd;
  margin: 0 0 0.5em 0;
  padding: 1em 0 0.5em;
}
.author {
  padding-bottom: 4px;
}
h1 {
  font-size: 26px;
  margin: 1em 0;
}
h2 {
  font-size: 22px;
  margin-top: -20px;  /* provide offset for in-page anchors */
  padding-top: 33px;
}
h3 {
  font-size: 18px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h4 {
  font-size: 16px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h5, h6 {
  font-size: 14px;
}
#n-copyright-notice {
  border-bottom: 1px solid #ddd;
  padding-bottom: 1em;
  margin-bottom: 1em;
}
/* general structure */
p {
  padding: 0;
  margin: 0 0 1em 0;
  text-align: left;
}
div, span {
  position: relative;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignRight.art-text pre {
  padding: 0;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
.alignCenter.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignCenter.art-text pre {
  padding: 0;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  display: table;
  border: none;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 1em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.ulBare, li.ulBare {
  margin-left: 0em !important;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
/* 
dl.nohang > dt {
  float: none;
}
*/
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}

/* links */
a {
  text-decoration: none;
}
a[href] {
  color: #22e; /* Arlen: WCAG 2019 */
}
a[href]:hover {
  background-color: #f2f2f2;
}
figcaption a[href],
a[href].selfRef {
  color: #222;
}
/* XXX probably not this:
a.selfRef:hover {
  background-color: transparent;
  cursor: default;
} */

/* Figures */
tt, code, pre {
  background-color: #f9f9f9;
  font-family: 'Roboto Mono', monospace;
}
pre {
  border: 1px solid #eee;
  margin: 0;
  padding: 1em;
}
img {
  max-width: 100%;
}
figure {
  margin: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption {
  font-style: italic;
  margin: 0 0 1em 0;
}
@media screen {
  pre {
    overflow-x: auto;
    max-width: 100%;
    max-width: calc(100% - 22px);
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 1.2em 2em;
}
blockquote {
  background-color: #f9f9f9;
  color: #111; /* Arlen: WCAG 2019 */
  border: 1px solid #ddd;
  border-radius: 3px;
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
  border: 1px solid #eee;
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 0.5em 0.75em;
}
th {
  text-align: left;
  background-color: #e9e9e9;
}
tr:nth-child(2n+1) > td {
  background-color: #f5f5f5;
}
table caption {
  font-style: italic;
  margin: 0;
  padding: 0;
  text-align: left;
}
table p {
  /* XXX to avoid bottom margin on table row signifiers. If paragraphs should
     be allowed within tables more generally, it would be far better to select on a class. */
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  color: #666; /* Arlen: AHDJ 2019 */
  text-decoration: none;
  visibility: hidden;
  user-select: none;
  -ms-user-select: none;
  -o-user-select:none;
  -moz-user-select: none;
  -khtml-user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}
@media screen {
  aside:hover > a.pilcrow,
  p:hover > a.pilcrow,
  blockquote:hover > a.pilcrow,
  div:hover > a.pilcrow,
  li:hover > a.pilcrow,
  pre:hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid #eee;
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: 0.9em;
}
#identifiers dt {
  width: 3em;
  clear: left;
}
#identifiers dd {
  float: left;
  margin-bottom: 0;
}
/* Fix PDF info block run off issue */
@media print {
  #identifiers dd {
    float: none;
  }
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #666; /* Arlen: WCAG 2019 */
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc  {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
nav.toc ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
nav.toc li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 600px) {
  .index ul {
    -moz-column-count: 2;
    -moz-column-gap: 20px;
  }
  .index ul ul {
    -moz-column-count: 1;
    -moz-column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}

address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  font-family: "Noto Sans",Arial,Helvetica,sans-serif;
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}

/* temporary notes */
.rfcEditorRemove::before {
  position: absolute;
  top: 0.2em;
  right: 0.2em;
  padding: 0.2em;
  content: "The RFC Editor will remove this note";
  color: #9e2a00; /* Arlen: WCAG 2019 */
  background-color: #ffd; /* Arlen: WCAG 2019 */
}
.rfcEditorRemove {
  position: relative;
  padding-top: 1.8em;
  background-color: #ffd; /* Arlen: WCAG 2019 */
  border-radius: 3px;
}
.cref {
  background-color: #ffd; /* Arlen: WCAG 2019 */
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 1023px) {
  body {
    padding-top: 2em;
  }
  #title {
    padding: 1em 0;
  }
  h1 {
    font-size: 24px;
  }
  h2 {
    font-size: 20px;
    margin-top: -18px;  /* provide offset for in-page anchors */
    padding-top: 38px;
  }
  #identifiers dd {
    max-width: 60%;
  }
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    background-color: inherit;
    border-bottom: 1px solid #ccc;
  }
  #toc h2 {
    margin: -1px 0 0 0;
    padding: 4px 0 4px 6px;
    padding-right: 1em;
    min-width: 190px;
    font-size: 1.1em;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 6px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    padding: 0.5em 1em 1em;
    overflow: auto;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 1024px) {
  body {
    max-width: 724px;
    margin: 42px auto;
    padding-left: 1.5em;
    padding-right: 29em;
  }
  #toc {
    position: fixed;
    top: 42px;
    right: 42px;
    width: 25%;
    margin: 0;
    padding: 0 1em;
    z-index: 1;
  }
  #toc h2 {
    border-top: none;
    border-bottom: 1px solid #ddd;
    font-size: 1em;
    font-weight: normal;
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 0;
    overflow: auto;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {

    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  pre.breakable {
    break-inside: auto;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

/* This is commented out here, as the string-set: doesn't
   pass W3C validation currently */
/*
.ears thead .left {
  string-set: ears-top-left content();
}

.ears thead .center {
  string-set: ears-top-center content();
}

.ears thead .right {
  string-set: ears-top-right content();
}

.ears tfoot .left {
  string-set: ears-bottom-left content();
}

.ears tfoot .center {
  string-set: ears-bottom-center content();
}

.ears tfoot .right {
  string-set: ears-bottom-right content();
}
*/

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
  /* The following is commented out here, but set appropriately by in code, as
     the content depends on the document */
  /*
  @top-left {
    content: 'Internet-Draft';
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-left {
    content: string(ears-top-left);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-center {
    content: string(ears-top-center);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-right {
    content: string(ears-top-right);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @bottom-left {
    content: string(ears-bottom-left);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-center {
    content: string(ears-bottom-center);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-right {
      content: '[Page ' counter(page) ']';
      vertical-align: top;
      border-top: solid 1px #ccc;
  }
  */

}

/* Changes introduced to fix issues found during implementation */
/* Make sure links are clickable even if overlapped by following H* */
a {
  z-index: 2;
}
/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}


/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Leave room in document info to show Internet-Draft on one line */
#identifiers dt {
  width: 8em;
}

/* Don't waste quite as much whitespace between label and value in doc info */
#identifiers dd {
  margin-left: 1em;
}

/* Give floating toc a background color (needed when it's a div inside section */
#toc {
  background-color: white;
}

/* Make the collapsed ToC header render white on gray also when it's a link */
@media screen and (max-width: 1023px) {
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
}

/* Give the bottom of the ToC some whitespace */
@media screen and (min-width: 1024px) {
  #toc {
    padding: 0 0 1em 1em;
  }
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* prevent monospace from becoming overly large */
tt, code, pre {
  font-size: 95%;
}

/* Fix the height/width aspect for ascii art*/
pre.sourcecode,
.art-text pre {
  line-height: 1.12;
}


/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin-right: 0.5em;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table td.text-left,
table th.text-left {
  text-align: left;
}
table td.text-center,
table th.text-center {
  text-align: center;
}
table td.text-right,
table th.text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 30em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Provide table alignment support.  We can't use the alignX classes above
   since they do unwanted things with caption and other styling. */
table.right {
 margin-left: auto;
 margin-right: 0;
}
table.center {
 margin-left: auto;
 margin-right: auto;
}
table.left {
 margin-left: 0;
 margin-right: auto;
}

/* Give the table caption label the same styling as the figcaption */
caption a[href] {
  color: #222;
}

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
/* Tweak the invisible space above H* in order not to overlay links in text above */
 h2 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 31px;
 }
 h3 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
 h4 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
/* Float artwork pilcrow to the right */
@media screen {
  .artwork a.pilcrow {
    display: block;
    line-height: 0.7;
    margin-top: 0.15em;
  }
}
/* Make pilcrows on dd visible */
@media screen {
  dd:hover > a.pilcrow {
    visibility: visible;
  }
}
/* Make the placement of figcaption match that of a table's caption
   by removing the figure's added bottom margin */
.alignLeft.art-text,
.alignCenter.art-text,
.alignRight.art-text {
   margin-bottom: 0;
}
.alignLeft,
.alignCenter,
.alignRight {
  margin: 1em 0 0 0;
}
/* In print, the pilcrow won't show on hover, so prevent it from taking up space,
   possibly even requiring a new line */
@media print {
  a.pilcrow {
    display: none;
  }
}
/* Styling for the external metadata */
div#external-metadata {
  background-color: #eee;
  padding: 0.5em;
  margin-bottom: 0.5em;
  display: none;
}
div#internal-metadata {
  padding: 0.5em;                       /* to match the external-metadata padding */
}
/* Styling for title RFC Number */
h1#rfcnum {
  clear: both;
  margin: 0 0 -1em;
  padding: 1em 0 0 0;
}
/* Make .olPercent look the same as <ol><li> */
dl.olPercent > dd {
  margin-bottom: 0.25em;
  min-height: initial;
}
/* Give aside some styling to set it apart */
aside {
  border-left: 1px solid #ddd;
  margin: 1em 0 1em 2em;
  padding: 0.2em 2em;
}
aside > dl,
aside > ol,
aside > ul,
aside > table,
aside > p {
  margin-bottom: 0.5em;
}
/* Additional page break settings */
@media print {
  figcaption, table caption {
    page-break-before: avoid;
  }
}
/* Font size adjustments for print */
@media print {
  body  { font-size: 10pt;      line-height: normal; max-width: 96%; }
  h1    { font-size: 1.72em;    padding-top: 1.5em; } /* 1*1.2*1.2*1.2 */
  h2    { font-size: 1.44em;    padding-top: 1.5em; } /* 1*1.2*1.2 */
  h3    { font-size: 1.2em;     padding-top: 1.5em; } /* 1*1.2 */
  h4    { font-size: 1em;       padding-top: 1.5em; }
  h5, h6 { font-size: 1em;      margin: initial; padding: 0.5em 0 0.3em; }
}
/* Sourcecode margin in print, when there's no pilcrow */
@media print {
  .artwork,
  .artwork > pre,
  .sourcecode {
    margin-bottom: 1em;
  }
}
/* Avoid narrow tables forcing too narrow table captions, which may render badly */
table {
  min-width: 20em;
}
/* ol type a */
ol.type-a { list-style-type: lower-alpha; }
ol.type-A { list-style-type: upper-alpha; }
ol.type-i { list-style-type: lower-roman; }
ol.type-I { list-style-type: lower-roman; }
/* Apply the print table and row borders in general, on request from the RPC,
and increase the contrast between border and odd row background slightly */
table {
  border: 1px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
}
tr {
  break-inside: avoid;
}
tr:nth-child(2n+1) > td {
  background-color: #f8f8f8;
}
/* Use style rules to govern display of the TOC. */
@media screen and (max-width: 1023px) {
  #toc nav { display: none; }
  #toc.active nav { display: block; }
}
/* Add support for keepWithNext */
.keepWithNext {
  break-after: avoid-page;
  break-after: avoid-page;
}
/* Add support for keepWithPrevious */
.keepWithPrevious {
  break-before: avoid-page;
}
/* Change the approach to avoiding breaks inside artwork etc. */
figure, pre, table, .artwork, .sourcecode  {
  break-before: auto;
  break-after: auto;
}
/* Avoid breaks between <dt> and <dd> */
dl {
  break-before: auto;
  break-inside: auto;
}
dt {
  break-before: auto;
  break-after: avoid-page;
}
dd {
  break-before: avoid-page;
  break-after: auto;
  orphans: 3;
  widows: 3
}
span.break, dd.break {
  margin-bottom: 0;
  min-height: 0;
  break-before: auto;
  break-inside: auto;
  break-after: auto;
}
/* Undo break-before ToC */
@media print {
  #toc {
    break-before: auto;
  }
}
/* Text in compact lists should not get extra bottom margin space,
   since that would makes the list not compact */
ul.compact p, .ulCompact p,
ol.compact p, .olCompact p {
 margin: 0;
}
/* But the list as a whole needs the extra space at the end */
section ul.compact,
section .ulCompact,
section ol.compact,
section .olCompact {
  margin-bottom: 1em;                    /* same as p not within ul.compact etc. */
}
/* The tt and code background above interferes with for instance table cell
   backgrounds.  Changed to something a bit more selective. */
tt, code {
  background-color: transparent;
}
p tt, p code, li tt, li code {
  background-color: #f8f8f8;
}
/* Tweak the pre margin -- 0px doesn't come out well */
pre {
   margin-top: 0.5px;
}
/* Tweak the compact list text */
ul.compact, .ulCompact,
ol.compact, .olCompact,
dl.compact, .dlCompact {
  line-height: normal;
}
/* Don't add top margin for nested lists */
li > ul, li > ol, li > dl,
dd > ul, dd > ol, dd > dl,
dl > dd > dl {
  margin-top: initial;
}
/* Elements that should not be rendered on the same line as a <dt> */
/* This should match the element list in writer.text.TextWriter.render_dl() */
dd > div.artwork:first-child,
dd > aside:first-child,
dd > figure:first-child,
dd > ol:first-child,
dd > div:first-child > pre.sourcecode,
dd > table:first-child,
dd > ul:first-child {
  clear: left;
}
/* fix for weird browser behaviour when <dd/> is empty */
dt+dd:empty::before{
  content: "\00a0";
}
/* Make paragraph spacing inside <li> smaller than in body text, to fit better within the list */
li > p {
  margin-bottom: 0.5em
}
/* Don't let p margin spill out from inside list items */
li > p:last-of-type {
  margin-bottom: 0;
}
</style>
<link href="rfc-local.css" rel="stylesheet" type="text/css"/>
<link href="https://dx.doi.org/10.17487/rfc9329" rel="alternate"/>
  <link href="urn:issn:2070-1721" rel="alternate"/>
  <link href="https://datatracker.ietf.org/doc/draft-ietf-ipsecme-rfc8229bis-09" rel="prev"/>
  </head>
<body class="xml2rfc">
<script src="https://www.rfc-editor.org/js/metadata.min.js"></script>
<table class="ears">
<thead><tr>
<td class="left">RFC 9329</td>
<td class="center">TCP Encapsulation of IKE &amp; IPsec Packets</td>
<td class="right">November 2022</td>
</tr></thead>
<tfoot><tr>
<td class="left">Pauly &amp; Smyslov</td>
<td class="center">Standards Track</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div class="document-information" id="external-metadata"></div>
<div class="document-information" id="internal-metadata">
<dl id="identifiers">
<dt class="label-stream">Stream:</dt>
<dd class="stream">Internet Engineering Task Force (IETF)</dd>
<dt class="label-rfc">RFC:</dt>
<dd class="rfc"><a class="eref" href="https://www.rfc-editor.org/rfc/rfc9329">9329</a></dd>
<dt class="label-obsoletes">Obsoletes:</dt>
<dd class="obsoletes">
<a class="eref" href="https://www.rfc-editor.org/rfc/rfc8229">8229</a> </dd>
<dt class="label-category">Category:</dt>
<dd class="category">Standards Track</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time class="published" datetime="2022-11">November 2022</time>
    </dd>
<dt class="label-issn">ISSN:</dt>
<dd class="issn">2070-1721</dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">T. Pauly</div>
<div class="org">Apple Inc.</div>
</div>
<div class="author">
      <div class="author-name">V. Smyslov</div>
<div class="org">ELVIS-PLUS</div>
</div>
</dd>
</dl>
</div>
<h1 id="rfcnum">RFC 9329</h1>
<h1 id="title">TCP Encapsulation of Internet Key Exchange Protocol (IKE) and IPsec Packets</h1>
<section id="section-abstract">
      <h2 id="abstract"><a class="selfRef" href="#abstract">Abstract</a></h2>
<p id="section-abstract-1"> This document describes a method to transport Internet Key Exchange
        Protocol (IKE) and IPsec packets over a TCP connection for traversing
        network middleboxes that may block IKE negotiation over UDP.  This
        method, referred to as "TCP encapsulation", involves sending both IKE
        packets for Security Association (SA) establishment and Encapsulating
        Security Payload (ESP) packets over a TCP connection.  This method is
        intended to be used as a fallback option when IKE cannot be
        negotiated over UDP.<a class="pilcrow" href="#section-abstract-1">¶</a></p>
<p id="section-abstract-2">TCP encapsulation for IKE and IPsec was defined in RFC 8229.
        This document clarifies the specification for TCP encapsulation by including
        additional clarifications obtained during implementation and deployment
        of this method. This documents obsoletes RFC 8229.<a class="pilcrow" href="#section-abstract-2">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a class="section-name selfRef" href="#name-status-of-this-memo">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
            This is an Internet Standards Track document.<a class="pilcrow" href="#section-boilerplate.1-1">¶</a></p>
<p id="section-boilerplate.1-2">
            This document is a product of the Internet Engineering Task Force
            (IETF).  It represents the consensus of the IETF community.  It has
            received public review and has been approved for publication by
            the Internet Engineering Steering Group (IESG).  Further
            information on Internet Standards is available in Section 2 of 
            RFC 7841.<a class="pilcrow" href="#section-boilerplate.1-2">¶</a></p>
<p id="section-boilerplate.1-3">
            Information about the current status of this document, any
            errata, and how to provide feedback on it may be obtained at
            <span><a href="https://www.rfc-editor.org/info/rfc9329">https://www.rfc-editor.org/info/rfc9329</a></span>.<a class="pilcrow" href="#section-boilerplate.1-3">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a class="section-name selfRef" href="#name-copyright-notice">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2022 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a class="pilcrow" href="#section-boilerplate.2-1">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a class="pilcrow" href="#section-boilerplate.2-2">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a class="toplink" href="#" onclick="scroll(0,0)">▲</a><h2 id="name-table-of-contents">
<a class="section-name selfRef" href="#name-table-of-contents">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p class="keepWithNext" id="section-toc.1-1.1.1"><a class="auto internal xref" href="#section-1">1</a>.  <a class="internal xref" href="#name-introduction">Introduction</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1">
                <p class="keepWithNext" id="section-toc.1-1.1.2.1.1"><a class="auto internal xref" href="#section-1.1">1.1</a>.  <a class="internal xref" href="#name-prior-work-and-motivation">Prior Work and Motivation</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.2">
                <p class="keepWithNext" id="section-toc.1-1.1.2.2.1"><a class="auto internal xref" href="#section-1.2">1.2</a>.  <a class="internal xref" href="#name-terminology-and-notation">Terminology and Notation</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1"><a class="auto internal xref" href="#section-2">2</a>.  <a class="internal xref" href="#name-configuration">Configuration</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a class="auto internal xref" href="#section-3">3</a>.  <a class="internal xref" href="#name-tcp-encapsulated-data-forma">TCP-Encapsulated Data Formats</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a class="auto internal xref" href="#section-3.1">3.1</a>.  <a class="internal xref" href="#name-tcp-encapsulated-ike-messag">TCP-Encapsulated IKE Message Format</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a class="auto internal xref" href="#section-3.2">3.2</a>.  <a class="internal xref" href="#name-tcp-encapsulated-esp-packet">TCP-Encapsulated ESP Packet Format</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a class="auto internal xref" href="#section-4">4</a>.  <a class="internal xref" href="#name-tcp-encapsulated-stream-pre">TCP-Encapsulated Stream Prefix</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a class="auto internal xref" href="#section-5">5</a>.  <a class="internal xref" href="#name-applicability">Applicability</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a class="auto internal xref" href="#section-5.1">5.1</a>.  <a class="internal xref" href="#name-recommended-fallback-from-u">Recommended Fallback from UDP</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a class="auto internal xref" href="#section-6">6</a>.  <a class="internal xref" href="#name-using-tcp-encapsulation">Using TCP Encapsulation</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a class="auto internal xref" href="#section-6.1">6.1</a>.  <a class="internal xref" href="#name-connection-establishment-an">Connection Establishment and Teardown</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a class="auto internal xref" href="#section-6.2">6.2</a>.  <a class="internal xref" href="#name-retransmissions">Retransmissions</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3">
                <p id="section-toc.1-1.6.2.3.1"><a class="auto internal xref" href="#section-6.3">6.3</a>.  <a class="internal xref" href="#name-cookies-and-puzzles">Cookies and Puzzles</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3.2.1">
                    <p id="section-toc.1-1.6.2.3.2.1.1"><a class="auto internal xref" href="#section-6.3.1">6.3.1</a>.  <a class="internal xref" href="#name-statelessness-versus-delay-">Statelessness versus Delay of SA Establishment</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.4">
                <p id="section-toc.1-1.6.2.4.1"><a class="auto internal xref" href="#section-6.4">6.4</a>.  <a class="internal xref" href="#name-error-handling-in-ike_sa_in">Error Handling in IKE_SA_INIT</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.5">
                <p id="section-toc.1-1.6.2.5.1"><a class="auto internal xref" href="#section-6.5">6.5</a>.  <a class="internal xref" href="#name-nat-detection-payloads">NAT-Detection Payloads</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.6">
                <p id="section-toc.1-1.6.2.6.1"><a class="auto internal xref" href="#section-6.6">6.6</a>.  <a class="internal xref" href="#name-nat-keepalive-packets">NAT-Keepalive Packets</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.7">
                <p id="section-toc.1-1.6.2.7.1"><a class="auto internal xref" href="#section-6.7">6.7</a>.  <a class="internal xref" href="#name-dead-peer-detection-and-tra">Dead Peer Detection and Transport Keepalives</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.8">
                <p id="section-toc.1-1.6.2.8.1"><a class="auto internal xref" href="#section-6.8">6.8</a>.  <a class="internal xref" href="#name-implications-of-tcp-encapsu">Implications of TCP Encapsulation on IPsec SA Processing</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a class="auto internal xref" href="#section-7">7</a>.  <a class="internal xref" href="#name-interaction-with-ikev2-exte">Interaction with IKEv2 Extensions</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a class="auto internal xref" href="#section-7.1">7.1</a>.  <a class="internal xref" href="#name-mobike-protocol">MOBIKE Protocol</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a class="auto internal xref" href="#section-7.2">7.2</a>.  <a class="internal xref" href="#name-ike-redirect">IKE Redirect</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.3">
                <p id="section-toc.1-1.7.2.3.1"><a class="auto internal xref" href="#section-7.3">7.3</a>.  <a class="internal xref" href="#name-ikev2-session-resumption">IKEv2 Session Resumption</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.4">
                <p id="section-toc.1-1.7.2.4.1"><a class="auto internal xref" href="#section-7.4">7.4</a>.  <a class="internal xref" href="#name-ikev2-protocol-support-for-">IKEv2 Protocol Support for High Availability</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.5">
                <p id="section-toc.1-1.7.2.5.1"><a class="auto internal xref" href="#section-7.5">7.5</a>.  <a class="internal xref" href="#name-ikev2-fragmentation">IKEv2 Fragmentation</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a class="auto internal xref" href="#section-8">8</a>.  <a class="internal xref" href="#name-middlebox-considerations">Middlebox Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a class="auto internal xref" href="#section-9">9</a>.  <a class="internal xref" href="#name-performance-considerations">Performance Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.1">
                <p id="section-toc.1-1.9.2.1.1"><a class="auto internal xref" href="#section-9.1">9.1</a>.  <a class="internal xref" href="#name-tcp-in-tcp">TCP-in-TCP</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.2">
                <p id="section-toc.1-1.9.2.2.1"><a class="auto internal xref" href="#section-9.2">9.2</a>.  <a class="internal xref" href="#name-added-reliability-for-unrel">Added Reliability for Unreliable Protocols</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.3">
                <p id="section-toc.1-1.9.2.3.1"><a class="auto internal xref" href="#section-9.3">9.3</a>.  <a class="internal xref" href="#name-quality-of-service-markings">Quality-of-Service Markings</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.4">
                <p id="section-toc.1-1.9.2.4.1"><a class="auto internal xref" href="#section-9.4">9.4</a>.  <a class="internal xref" href="#name-maximum-segment-size">Maximum Segment Size</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.5">
                <p id="section-toc.1-1.9.2.5.1"><a class="auto internal xref" href="#section-9.5">9.5</a>.  <a class="internal xref" href="#name-tunneling-ecn-in-tcp">Tunneling ECN in TCP</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a class="auto internal xref" href="#section-10">10</a>. <a class="internal xref" href="#name-security-considerations">Security Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a class="auto internal xref" href="#section-11">11</a>. <a class="internal xref" href="#name-iana-considerations">IANA Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a class="auto internal xref" href="#section-12">12</a>. <a class="internal xref" href="#name-references">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.1">
                <p id="section-toc.1-1.12.2.1.1"><a class="auto internal xref" href="#section-12.1">12.1</a>.  <a class="internal xref" href="#name-normative-references">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2">
                <p id="section-toc.1-1.12.2.2.1"><a class="auto internal xref" href="#section-12.2">12.2</a>.  <a class="internal xref" href="#name-informative-references">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a class="auto internal xref" href="#appendix-A">Appendix A</a>.  <a class="internal xref" href="#name-using-tcp-encapsulation-wit">Using TCP Encapsulation with TLS</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a class="auto internal xref" href="#appendix-B">Appendix B</a>.  <a class="internal xref" href="#name-example-exchanges-of-tcp-en">Example Exchanges of TCP Encapsulation with TLS 1.3</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14.2.1">
                <p id="section-toc.1-1.14.2.1.1"><a class="auto internal xref" href="#appendix-B.1">B.1</a>.  <a class="internal xref" href="#name-establishing-an-ike-session">Establishing an IKE Session</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14.2.2">
                <p id="section-toc.1-1.14.2.2.1"><a class="auto internal xref" href="#appendix-B.2">B.2</a>.  <a class="internal xref" href="#name-deleting-an-ike-session">Deleting an IKE Session</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14.2.3">
                <p id="section-toc.1-1.14.2.3.1"><a class="auto internal xref" href="#appendix-B.3">B.3</a>.  <a class="internal xref" href="#name-re-establishing-an-ike-sess">Re-establishing an IKE Session</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14.2.4">
                <p id="section-toc.1-1.14.2.4.1"><a class="auto internal xref" href="#appendix-B.4">B.4</a>.  <a class="internal xref" href="#name-using-mobike-between-udp-an">Using MOBIKE between UDP and TCP Encapsulation</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a class="auto internal xref" href="#appendix-C"></a><a class="internal xref" href="#name-acknowledgments">Acknowledgments</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16">
            <p id="section-toc.1-1.16.1"><a class="auto internal xref" href="#appendix-D"></a><a class="internal xref" href="#name-authors-addresses">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="intro">
<section id="section-1">
      <h2 id="name-introduction">
<a class="section-number selfRef" href="#section-1">1. </a><a class="section-name selfRef" href="#name-introduction">Introduction</a>
      </h2>
<p id="section-1-1"> The Internet Key Exchange Protocol version 2 (IKEv2) <span>[<a class="cite xref" href="#RFC7296">RFC7296</a>]</span> is a
        protocol for establishing IPsec Security Associations (SAs) using
        IKE messages over UDP for control traffic and using Encapsulating
        Security Payload (ESP) messages <span>[<a class="cite xref" href="#RFC4303">RFC4303</a>]</span> for encrypted data traffic.
        Many network middleboxes that filter traffic on public hotspots block
        all UDP traffic, including IKE and IPsec, but allow TCP connections
        through because they appear to be web traffic.  Devices on these
        networks that need to use IPsec (to access private enterprise
        networks, to route Voice over IP calls to carrier networks
        because of security policies, etc.) are unable to establish IPsec SAs.
        This document defines a method for encapsulating IKE control messages
        as well as ESP data messages within a TCP connection. Note that Authentication Header (AH) is not supported by this specification.<a class="pilcrow" href="#section-1-1">¶</a></p>
<p id="section-1-2"> Using TCP as a transport for IPsec packets adds the third option (below) to the
        list of traditional IPsec transports:<a class="pilcrow" href="#section-1-2">¶</a></p>
<ol class="normal type-1" id="section-1-3" start="1" type="1">
<li id="section-1-3.1">Direct.  Usually, IKE negotiations begin over UDP port 500.  If
          no Network Address Translation (NAT) device is detected between
          the Initiator and the Responder, then subsequent IKE packets are
          sent over UDP port 500 and IPsec data packets are sent
          using ESP.<a class="pilcrow" href="#section-1-3.1">¶</a>
</li>
        <li id="section-1-3.2">UDP Encapsulation.  Described in <span>[<a class="cite xref" href="#RFC3948">RFC3948</a>]</span>.  If a NAT is detected between the
          Initiator and the Responder, then subsequent IKE packets are sent
          over UDP port 4500 with 4 bytes of zero at the start of the
          UDP payload, and ESP packets are sent out over UDP port 4500.
          Some implementations default to using UDP encapsulation even when no NAT is
          detected on the path, as some middleboxes do not support IP
          protocols other than TCP and UDP.<a class="pilcrow" href="#section-1-3.2">¶</a>
</li>
        <li id="section-1-3.3">TCP Encapsulation.  Described in this document.  If the other two methods are not available or
          appropriate, IKE negotiation packets as well as ESP packets can
          be sent over a single TCP connection to the peer.<a class="pilcrow" href="#section-1-3.3">¶</a>
</li>
      </ol>
<p id="section-1-4"> Direct use of ESP or UDP encapsulation should be preferred by
        IKE implementations due to performance concerns when using
        TCP encapsulation (<a class="auto internal xref" href="#perf">Section 9</a>).  Most implementations should use
        TCP encapsulation only on networks where negotiation over UDP has
        been attempted without receiving responses from the peer or if a
        network is known to not support UDP.<a class="pilcrow" href="#section-1-4">¶</a></p>
<div id="prior">
<section id="section-1.1">
        <h3 id="name-prior-work-and-motivation">
<a class="section-number selfRef" href="#section-1.1">1.1. </a><a class="section-name selfRef" href="#name-prior-work-and-motivation">Prior Work and Motivation</a>
        </h3>
<p id="section-1.1-1"> Encapsulating IKE connections within TCP streams is a common approach
          to solve the problem of UDP packets being blocked by network
          middleboxes.  The specific goals of this document are as follows:<a class="pilcrow" href="#section-1.1-1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-2.1">To promote interoperability by defining a standard method of
            framing IKE and ESP messages within TCP streams.<a class="pilcrow" href="#section-1.1-2.1">¶</a>
</li>
          <li class="normal" id="section-1.1-2.2">To be compatible with the current IKEv2 standard without requiring
            modifications or extensions.<a class="pilcrow" href="#section-1.1-2.2">¶</a>
</li>
          <li class="normal" id="section-1.1-2.3">To use IKE over UDP by default to avoid the overhead of other
            alternatives that always rely on TCP or Transport Layer Security
            (TLS) <span>[<a class="cite xref" href="#RFC5246">RFC5246</a>]</span> <span>[<a class="cite xref" href="#RFC8446">RFC8446</a>]</span>.<a class="pilcrow" href="#section-1.1-2.3">¶</a>
</li>
        </ul>
<p id="section-1.1-3">Some previous alternatives include:<a class="pilcrow" href="#section-1.1-3">¶</a></p>
<span class="break"></span><dl class="dlNewline" id="section-1.1-4">
          <dt id="section-1.1-4.1">Cellular Network Access:</dt>
          <dd id="section-1.1-4.2" style="margin-left: 1.5em">
            Interworking Wireless LAN (IWLAN) uses IKEv2 to create secure
            connections to cellular carrier networks for making voice calls
            and accessing other network services over Wi-Fi networks. 3GPP has
            recommended that IKEv2 and ESP packets be sent within a TLS
            connection to be able to establish connections on restrictive
            networks.<a class="pilcrow" href="#section-1.1-4.2">¶</a>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-4.3">ISAKMP over TCP:</dt>
          <dd id="section-1.1-4.4" style="margin-left: 1.5em">
            Various non-standard extensions to the Internet Security
            Association and Key Management Protocol (ISAKMP) have been
            deployed that send IPsec traffic over TCP or TCP-like packets.<a class="pilcrow" href="#section-1.1-4.4">¶</a>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-4.5">Secure Sockets Layer (SSL) VPNs:</dt>
          <dd id="section-1.1-4.6" style="margin-left: 1.5em">
            Many proprietary VPN solutions use a combination of TLS and IPsec
            in order to provide reliability.  These often run on TCP port 443.<a class="pilcrow" href="#section-1.1-4.6">¶</a>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-4.7">IKEv2 over TCP:</dt>
          <dd id="section-1.1-4.8" style="margin-left: 1.5em">
            IKEv2 over TCP as described in <span>[<a class="cite xref" href="#I-D.ietf-ipsecme-ike-tcp">IPSECME-IKE-TCP</a>]</span> is used to avoid UDP
            fragmentation.<a class="pilcrow" href="#section-1.1-4.8">¶</a>
</dd>
        <dd class="break"></dd>
</dl>
<p id="section-1.1-5">

          TCP encapsulation for IKE and IPsec was defined in <span>[<a class="cite xref" href="#RFC8229">RFC8229</a>]</span>.
          This document updates the specification for TCP encapsulation by including
          additional clarifications obtained during implementation and deployment
          of this method.<a class="pilcrow" href="#section-1.1-5">¶</a></p>
<p id="section-1.1-6">In particular:<a class="pilcrow" href="#section-1.1-6">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-7.1">The interpretation of the Length field preceding every message is clarified (<a class="auto internal xref" href="#format">Section 3</a>).<a class="pilcrow" href="#section-1.1-7.1">¶</a>
</li>
          <li class="normal" id="section-1.1-7.2">The use of the NAT_DETECTION_*_IP notifications is clarified 
            (Sections <a class="auto internal xref" href="#fallback">5.1</a>, <a class="auto internal xref" href="#nat-det">6.5</a>, 
            and <a class="auto internal xref" href="#mobike">7.1</a>).<a class="pilcrow" href="#section-1.1-7.2">¶</a>
</li>
          <li class="normal" id="section-1.1-7.3">Retransmission behavior is clarified (<a class="auto internal xref" href="#retr">Section 6.2</a>).<a class="pilcrow" href="#section-1.1-7.3">¶</a>
</li>
          <li class="normal" id="section-1.1-7.4">The use of cookies and puzzles is described in more detail (<a class="auto internal xref" href="#cookie-puzzle">Section 6.3</a>).<a class="pilcrow" href="#section-1.1-7.4">¶</a>
</li>
          <li class="normal" id="section-1.1-7.5">Error handling is clarified (<a class="auto internal xref" href="#errors">Section 6.4</a>).<a class="pilcrow" href="#section-1.1-7.5">¶</a>
</li>
          <li class="normal" id="section-1.1-7.6">Implications of TCP encapsulation on IPsec SA processing are expanded (<a class="auto internal xref" href="#ipsec">Section 6.8</a>).<a class="pilcrow" href="#section-1.1-7.6">¶</a>
</li>
          <li class="normal" id="section-1.1-7.7">
            <a class="auto internal xref" href="#extensions">Section 7</a> describing interactions with other IKEv2 extensions is added.<a class="pilcrow" href="#section-1.1-7.7">¶</a>
</li>
          <li class="normal" id="section-1.1-7.8">The interaction of TCP encapsulation with IKEv2 Mobility and Multihoming (MOBIKE) is clarified (<a class="auto internal xref" href="#mobike">Section 7.1</a>).<a class="pilcrow" href="#section-1.1-7.8">¶</a>
</li>
          <li class="normal" id="section-1.1-7.9">The recommendation for TLS encapsulation (<a class="auto internal xref" href="#tls">Appendix A</a>) now includes TLS 1.3.<a class="pilcrow" href="#section-1.1-7.9">¶</a>
</li>
          <li class="normal" id="section-1.1-7.10">Examples of TLS encapsulation are provided using TLS 1.3 (<a class="auto internal xref" href="#tls-example">Appendix B</a>).<a class="pilcrow" href="#section-1.1-7.10">¶</a>
</li>
          <li class="normal" id="section-1.1-7.11">More security considerations are added.<a class="pilcrow" href="#section-1.1-7.11">¶</a>
</li>
        </ul>
</section>
</div>
<div id="mustshouldmay">
<section id="section-1.2">
        <h3 id="name-terminology-and-notation">
<a class="section-number selfRef" href="#section-1.2">1.2. </a><a class="section-name selfRef" href="#name-terminology-and-notation">Terminology and Notation</a>
        </h3>
<p id="section-1.2-1"> This document distinguishes between the IKE peer that initiates TCP
          connections to be used for TCP encapsulation and the roles of
          Initiator and Responder for particular IKE messages.  During the
          course of IKE exchanges, the role of IKE Initiator and Responder may
          swap for a given SA (as with IKE SA rekeys), while the Initiator of
          the TCP connection is still responsible for tearing down the TCP
          connection and re-establishing it if necessary.  For this reason,
          this document will use the term "TCP Originator" to indicate the IKE
          peer that initiates TCP connections.  The peer that receives TCP
          connections will be referred to as the "TCP Responder".  If an IKE SA
          is rekeyed one or more times, the TCP Originator <span class="bcp14">MUST</span> remain the peer
          that originally initiated the first IKE SA.<a class="pilcrow" href="#section-1.2-1">¶</a></p>
<p id="section-1.2-2">
    The key words "<span class="bcp14">MUST</span>", "<span class="bcp14">MUST NOT</span>", "<span class="bcp14">REQUIRED</span>", "<span class="bcp14">SHALL</span>", "<span class="bcp14">SHALL NOT</span>", "<span class="bcp14">SHOULD</span>", "<span class="bcp14">SHOULD NOT</span>", "<span class="bcp14">RECOMMENDED</span>", "<span class="bcp14">NOT RECOMMENDED</span>",
    "<span class="bcp14">MAY</span>", and "<span class="bcp14">OPTIONAL</span>" in this document are to be interpreted as
    described in BCP 14 <span>[<a class="cite xref" href="#RFC2119">RFC2119</a>]</span> <span>[<a class="cite xref" href="#RFC8174">RFC8174</a>]</span> 
    when, and only when, they appear in all capitals, as shown here.<a class="pilcrow" href="#section-1.2-2">¶</a></p>
</section>
</div>
</section>
</div>
<div id="config">
<section id="section-2">
      <h2 id="name-configuration">
<a class="section-number selfRef" href="#section-2">2. </a><a class="section-name selfRef" href="#name-configuration">Configuration</a>
      </h2>
<p id="section-2-1">One of the main reasons to use TCP encapsulation is that UDP traffic
        may be entirely blocked on a network.  Because of this, support for
        TCP encapsulation is not specifically negotiated in the IKE exchange.
        Instead, support for TCP encapsulation must be preconfigured on both
        the TCP Originator and the TCP Responder.<a class="pilcrow" href="#section-2-1">¶</a></p>
<p id="section-2-2">Compliant implementations <span class="bcp14">MUST</span> support TCP encapsulation on TCP port 4500,
        which is reserved for IPsec NAT traversal.<a class="pilcrow" href="#section-2-2">¶</a></p>
<p id="section-2-3">Beyond a flag indicating support for TCP encapsulation, the
        configuration for each peer can include the following optional
        parameters:<a class="pilcrow" href="#section-2-3">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2-4.1">Alternate TCP ports on which the specific TCP Responder listens
          for incoming connections.  Note that the TCP Originator may
          initiate TCP connections to the TCP Responder from any local port.<a class="pilcrow" href="#section-2-4.1">¶</a>
</li>
        <li class="normal" id="section-2-4.2">An extra framing protocol to use on top of TCP to further
          encapsulate the stream of IKE and IPsec packets.  See <a class="auto internal xref" href="#tls">Appendix A</a>
          for a detailed discussion.<a class="pilcrow" href="#section-2-4.2">¶</a>
</li>
      </ul>
<p id="section-2-5">Since TCP encapsulation of IKE and IPsec packets adds overhead and
        has potential performance trade-offs compared to direct or
        UDP-encapsulated SAs (as described in <a class="auto internal xref" href="#perf">Section 9</a>), implementations
        <span class="bcp14">SHOULD</span> prefer ESP direct or UDP-encapsulated SAs over
        TCP-encapsulated SAs when possible.<a class="pilcrow" href="#section-2-5">¶</a></p>
</section>
</div>
<div id="format">
<section id="section-3">
      <h2 id="name-tcp-encapsulated-data-forma">
<a class="section-number selfRef" href="#section-3">3. </a><a class="section-name selfRef" href="#name-tcp-encapsulated-data-forma">TCP-Encapsulated Data Formats</a>
      </h2>
<p id="section-3-1">Like UDP encapsulation, TCP encapsulation uses the first 4 bytes
        of a message to differentiate IKE and ESP messages.  TCP
        encapsulation also adds a 16-bit Length field that precedes every message
        to define the boundaries of messages within a stream.  
 The value in this field is equal to the length of the original message
 plus the length of the field itself, in octets.  If the first 32 bits
 of the message are zeros (a non-ESP marker), then the contents comprise an
        IKE message.  Otherwise, the contents comprise an ESP message.
        AH messages are not supported for TCP
        encapsulation.<a class="pilcrow" href="#section-3-1">¶</a></p>
<p id="section-3-2">Although a TCP stream may be able to send very long messages,
        implementations <span class="bcp14">SHOULD</span> limit message lengths to match the lengths
        used for UDP encapsulation of ESP messages. 
 The maximum message length is used as the effective MTU 
        for connections that are being encrypted using ESP, 
        so the maximum message length will influence characteristics of these
        connections, such as the TCP Maximum Segment Size (MSS).<a class="pilcrow" href="#section-3-2">¶</a></p>
<p id="section-3-3">Due to the fact that the Length field is 16 bits and includes both the message length and the 
        length of the field itself, it is impossible to encapsulate messages greater than 65533 
        octets in length. In most cases, this is not a problem. Note that a similar
        limitation exists for encapsulation ESP in UDP <span>[<a class="cite xref" href="#RFC3948">RFC3948</a>]</span>.<a class="pilcrow" href="#section-3-3">¶</a></p>
<p id="section-3-4">The minimum size of an encapsulated message is 1 octet 
        (for NAT-keepalive packets, see <a class="auto internal xref" href="#nat-ka">Section 6.6</a>). Empty messages 
        (where the Length field equals 2) <span class="bcp14">MUST</span> be silently ignored by receiver.<a class="pilcrow" href="#section-3-4">¶</a></p>
<p id="section-3-5">Note that this method of encapsulation will also work for placing IKE
        and ESP messages within any protocol that presents a stream
        abstraction, beyond TCP.<a class="pilcrow" href="#section-3-5">¶</a></p>
<div id="format-ike">
<section id="section-3.1">
        <h3 id="name-tcp-encapsulated-ike-messag">
<a class="section-number selfRef" href="#section-3.1">3.1. </a><a class="section-name selfRef" href="#name-tcp-encapsulated-ike-messag">TCP-Encapsulated IKE Message Format</a>
        </h3>
<span id="name-ike-message-format-for-tcp-"></span><div id="f-format-ike">
<figure id="figure-1">
          <div class="alignLeft art-text artwork" id="section-3.1-1.1">
<pre>                     1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
                                +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                |            Length             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Non-ESP Marker                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~                     IKE Message (RFC 7296)                    ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</pre>
</div>
<figcaption><a class="selfRef" href="#figure-1">Figure 1</a>:
<a class="selfRef" href="#name-ike-message-format-for-tcp-">IKE Message Format for TCP Encapsulation</a>
          </figcaption></figure>
</div>
<p id="section-3.1-2"> The IKE message is preceded by a 16-bit Length field in network byte
          order that specifies the length of the IKE message (including the
          non-ESP marker) within the TCP stream.  As with IKE over UDP
          port 4500, a zeroed 32-bit non-ESP marker is inserted before the
          start of the IKE header in order to differentiate the traffic from
          ESP traffic between the same addresses and ports.<a class="pilcrow" href="#section-3.1-2">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-3.1-3">
          <dt id="section-3.1-3.1">Length (2 octets, unsigned integer):</dt>
          <dd id="section-3.1-3.2" style="margin-left: 1.5em"> Length of the IKE message,
            including the Length field and non-ESP marker. The value in the Length
 field <span class="bcp14">MUST NOT</span> be 0 or 1. The receiver <span class="bcp14">MUST</span> treat these values as
 fatal errors and <span class="bcp14">MUST</span> close the TCP connection.<a class="pilcrow" href="#section-3.1-3.2">¶</a>
</dd>
          <dd class="break"></dd>
<dt id="section-3.1-3.3">Non-ESP Marker (4 octets):</dt>
          <dd id="section-3.1-3.4" style="margin-left: 1.5em">Four zero-valued bytes.<a class="pilcrow" href="#section-3.1-3.4">¶</a>
</dd>
        <dd class="break"></dd>
</dl>
</section>
</div>
<div id="format-esp">
<section id="section-3.2">
        <h3 id="name-tcp-encapsulated-esp-packet">
<a class="section-number selfRef" href="#section-3.2">3.2. </a><a class="section-name selfRef" href="#name-tcp-encapsulated-esp-packet">TCP-Encapsulated ESP Packet Format</a>
        </h3>
<span id="name-esp-packet-format-for-tcp-e"></span><div id="f-format-esp">
<figure id="figure-2">
          <div class="alignLeft art-text artwork" id="section-3.2-1.1">
<pre>                     1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
                                +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                |            Length             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~                     ESP Packet (RFC 4303)                     ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</pre>
</div>
<figcaption><a class="selfRef" href="#figure-2">Figure 2</a>:
<a class="selfRef" href="#name-esp-packet-format-for-tcp-e">ESP Packet Format for TCP Encapsulation</a>
          </figcaption></figure>
</div>
<p id="section-3.2-2">The ESP packet is preceded by a 16-bit Length field in network byte
          order that specifies the length of the ESP packet within the TCP
          stream.<a class="pilcrow" href="#section-3.2-2">¶</a></p>
<p id="section-3.2-3">The Security Parameter Index (SPI) field <span>[<a class="cite xref" href="#RFC7296">RFC7296</a>]</span> in the ESP header
          <span class="bcp14">MUST NOT</span> be a zero value.<a class="pilcrow" href="#section-3.2-3">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-3.2-4">
          <dt id="section-3.2-4.1">Length (2 octets, unsigned integer):</dt>
          <dd id="section-3.2-4.2" style="margin-left: 1.5em">Length of the ESP
          packet, including the Length field. The value in the Length field
          <span class="bcp14">MUST NOT</span> be 0 or 1. The receiver <span class="bcp14">MUST</span>
          treat these values as fatal errors and <span class="bcp14">MUST</span> close TCP
          connection.<a class="pilcrow" href="#section-3.2-4.2">¶</a>
</dd>
        <dd class="break"></dd>
</dl>
</section>
</div>
</section>
</div>
<div id="prefix">
<section id="section-4">
      <h2 id="name-tcp-encapsulated-stream-pre">
<a class="section-number selfRef" href="#section-4">4. </a><a class="section-name selfRef" href="#name-tcp-encapsulated-stream-pre">TCP-Encapsulated Stream Prefix</a>
      </h2>
<p id="section-4-1">Each stream of bytes used for IKE and IPsec encapsulation <span class="bcp14">MUST</span> begin
        with a fixed sequence of 6 bytes as a magic value, containing the
        characters "IKETCP" as ASCII values.<a class="pilcrow" href="#section-4-1">¶</a></p>
<span id="name-tcp-encapsulated-stream-pref"></span><div id="f-prefix">
<figure id="figure-3">
        <div class="alignLeft art-text artwork" id="section-4-2.1">
<pre>   0      1      2      3      4      5
+------+------+------+------+------+------+
| 0x49 | 0x4b | 0x45 | 0x54 | 0x43 | 0x50 |
+------+------+------+------+------+------+</pre>
</div>
<figcaption><a class="selfRef" href="#figure-3">Figure 3</a>:
<a class="selfRef" href="#name-tcp-encapsulated-stream-pref">TCP-Encapsulated Stream Prefix</a>
        </figcaption></figure>
</div>
<p id="section-4-3">This value is intended to
        identify and validate that the TCP connection is being used for TCP
        encapsulation as defined in this document, to avoid conflicts with
        the prevalence of previous non-standard protocols that used TCP
        port 4500.  This value is only sent once, by the TCP Originator only,
        at the beginning of the TCP stream of IKE and ESP messages.<a class="pilcrow" href="#section-4-3">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4-4">
<pre>Initiator                                                   Responder
---------------------------------------------------------------------
          &lt;new TCP connection is established by Initiator&gt;

Stream Prefix|Length|non-ESP marker|IKE message --&gt;
                                &lt;-- Length|non-ESP marker|IKE message
Length|non-ESP marker|IKE message --&gt;
                                &lt;-- Length|non-ESP marker|IKE message

                                [...]
Length|ESP packet -&gt;
                                                 &lt;- Length|ESP packet</pre><a class="pilcrow" href="#section-4-4">¶</a>
</div>
<p id="section-4-5">If other framing protocols are used within TCP to further encapsulate
        or encrypt the stream of IKE and ESP messages, the stream prefix must
        be at the start of the TCP Originator's IKE and ESP message stream
        within the added protocol layer (<a class="auto internal xref" href="#tls">Appendix A</a>).  Although some framing
        protocols do support negotiating inner protocols, the stream prefix
        should always be used in order for implementations to be as generic
        as possible and not rely on other framing protocols on top of TCP.<a class="pilcrow" href="#section-4-5">¶</a></p>
</section>
</div>
<div id="applicability">
<section id="section-5">
      <h2 id="name-applicability">
<a class="section-number selfRef" href="#section-5">5. </a><a class="section-name selfRef" href="#name-applicability">Applicability</a>
      </h2>
<p id="section-5-1">TCP encapsulation is applicable only when it has been configured to
        be used with specific IKE peers.  If a Responder is configured to accept and is allowed to use
        TCP encapsulation, it <span class="bcp14">MUST</span> listen on the configured port(s) in case
        any peers will initiate new IKE sessions.  Initiators <span class="bcp14">MAY</span> use TCP
        encapsulation for any IKE session to a peer that is configured to
        support TCP encapsulation, although it is recommended that Initiators
        only use TCP encapsulation when traffic over UDP is blocked.<a class="pilcrow" href="#section-5-1">¶</a></p>
<p id="section-5-2">Since the support of TCP encapsulation is a configured property, not
        a negotiated one, it is recommended that if there are multiple IKE
        endpoints representing a single peer (such as multiple machines with
        different IP addresses when connecting by Fully Qualified Domain
        Name (FQDN), or endpoints used with IKE redirection), all of the endpoints
        equally support TCP encapsulation.<a class="pilcrow" href="#section-5-2">¶</a></p>
<p id="section-5-3">If TCP encapsulation is being used for a specific IKE SA, all
        IKE messages for that IKE SA and ESP packets for its Child SAs <span class="bcp14">MUST</span> be sent over a TCP
        connection until the SA is deleted or IKEv2 Mobility and Multihoming
        (MOBIKE) is used to change the SA endpoints and/or the encapsulation
        protocol.  See <a class="auto internal xref" href="#mobike">Section 7.1</a> for more details on using MOBIKE to
        transition between encapsulation modes.<a class="pilcrow" href="#section-5-3">¶</a></p>
<div id="fallback">
<section id="section-5.1">
        <h3 id="name-recommended-fallback-from-u">
<a class="section-number selfRef" href="#section-5.1">5.1. </a><a class="section-name selfRef" href="#name-recommended-fallback-from-u">Recommended Fallback from UDP</a>
        </h3>
<p id="section-5.1-1">Since UDP is the preferred method of transport for IKE messages,
          implementations that use TCP encapsulation should have an algorithm
          for deciding when to use TCP after determining that UDP is unusable.
          If an Initiator implementation has no prior knowledge about the
          network it is on and the status of UDP on that network, it <span class="bcp14">SHOULD</span>
          always attempt to negotiate IKE over UDP first.  IKEv2 defines how to
          use retransmission timers with IKE messages and, specifically,
          IKE_SA_INIT messages <span>[<a class="cite xref" href="#RFC7296">RFC7296</a>]</span>.  Generally, this means that the
          implementation will define a frequency of retransmission and the
          maximum number of retransmissions allowed before marking the IKE SA
          as failed.  An implementation can attempt negotiation over TCP once
          it has hit the maximum retransmissions over UDP, or slightly before
          to reduce connection setup delays.  It is recommended that the
          initial message over UDP be retransmitted at least once before
          falling back to TCP, unless the Initiator knows beforehand that the
          network is likely to block UDP.<a class="pilcrow" href="#section-5.1-1">¶</a></p>
<p id="section-5.1-2">When switching from UDP to TCP, a new IKE_SA_INIT exchange <span class="bcp14">MUST</span> be
          initiated with the Initiator's new SPI and with recalculated content of
          NAT_DETECTION_*_IP notifications.<a class="pilcrow" href="#section-5.1-2">¶</a></p>
</section>
</div>
</section>
</div>
<div id="tcp-encap">
<section id="section-6">
      <h2 id="name-using-tcp-encapsulation">
<a class="section-number selfRef" href="#section-6">6. </a><a class="section-name selfRef" href="#name-using-tcp-encapsulation">Using TCP Encapsulation</a>
      </h2>
<div id="establish">
<section id="section-6.1">
        <h3 id="name-connection-establishment-an">
<a class="section-number selfRef" href="#section-6.1">6.1. </a><a class="section-name selfRef" href="#name-connection-establishment-an">Connection Establishment and Teardown</a>
        </h3>
<p id="section-6.1-1">When the IKE Initiator uses TCP encapsulation, it will initiate a TCP
          connection to the Responder using the Responder's preconfigured TCP port.  The first
          bytes sent on the TCP stream <span class="bcp14">MUST</span> be the stream prefix value (<a class="auto internal xref" href="#prefix">Section 4</a>).
          After this prefix, encapsulated IKE messages will negotiate the IKE
          SA and initial Child SA <span>[<a class="cite xref" href="#RFC7296">RFC7296</a>]</span>.  After this point, both
          encapsulated IKE (<a class="auto internal xref" href="#f-format-ike">Figure 1</a>) and ESP (<a class="auto internal xref" href="#f-format-esp">Figure 2</a>)
          messages will be sent over the TCP connection.  The TCP Responder <span class="bcp14">MUST</span> wait for the entire
          stream prefix to be received on the stream before trying to parse out
          any IKE or ESP messages.  The stream prefix is sent only once, and
          only by the TCP Originator.<a class="pilcrow" href="#section-6.1-1">¶</a></p>
<p id="section-6.1-2">In order to close an IKE session, either the Initiator or Responder
          <span class="bcp14">SHOULD</span> gracefully tear down IKE SAs with DELETE payloads.  Once the
          SA has been deleted, the TCP Originator <span class="bcp14">SHOULD</span> close the TCP
          connection if it does not intend to use the connection for another
          IKE session to the TCP Responder.  If the TCP connection is no longer 
          associated with any active IKE SA, the TCP Responder <span class="bcp14">MAY</span> close the connection 
          to clean up IKE resources if the TCP Originator didn't close it within some reasonable period of time (e.g., a few seconds).<a class="pilcrow" href="#section-6.1-2">¶</a></p>
<p id="section-6.1-3">An unexpected FIN or a TCP Reset on the TCP connection may indicate a
          loss of connectivity, an attack, or some other error.  If a DELETE
          payload has not been sent, both sides <span class="bcp14">SHOULD</span> maintain the state for
          their SAs for the standard lifetime or timeout period.  The TCP
          Originator is responsible for re-establishing the TCP connection if
          it is torn down for any unexpected reason.  Since new TCP connections
          may use different IP addresses and/or ports due to NAT mappings or local address or port allocations
          changing, the TCP Responder <span class="bcp14">MUST</span> allow packets for existing SAs to be
          received from new source IP addresses and ports. Note that the 
   IPv6 Flow-ID header <span class="bcp14">MUST</span> remain constant when a new TCP connection is created to avoid ECMP load balancing.<a class="pilcrow" href="#section-6.1-3">¶</a></p>
<p id="section-6.1-4">A peer <span class="bcp14">MUST</span> discard a partially received message due to a broken
          connection.<a class="pilcrow" href="#section-6.1-4">¶</a></p>
<p id="section-6.1-5">Whenever the TCP Originator opens a new TCP connection to be used for
          an existing IKE SA, it <span class="bcp14">MUST</span> send the stream prefix first, before any
          IKE or ESP messages.  This follows the same behavior as the initial
          TCP connection.<a class="pilcrow" href="#section-6.1-5">¶</a></p>
<p id="section-6.1-6">Multiple IKE SAs <span class="bcp14">MUST NOT</span> share a single TCP connection, unless one
          is a rekey of an existing IKE SA, in which case there will
          temporarily be two IKE SAs on the same TCP connection.<a class="pilcrow" href="#section-6.1-6">¶</a></p>
<p id="section-6.1-7">If a TCP connection is being used to continue an existing IKE/ESP
  session, the TCP Responder can recognize the session using either the
  IKE SPI from an encapsulated IKE message or the ESP SPI from an
  encapsulated ESP packet.  If the session had been fully established
  previously, it is suggested that the TCP Originator send an
  UPDATE_SA_ADDRESSES message if MOBIKE is supported and an
  empty informational message if it is not.<a class="pilcrow" href="#section-6.1-7">¶</a></p>
<p id="section-6.1-8">The TCP Responder <span class="bcp14">MUST NOT</span> accept any messages for the existing IKE
          session on a new incoming connection, unless that connection begins
          with the stream prefix.  If either the TCP Originator or TCP
          Responder detects corruption on a connection that was started with a
          valid stream prefix, it <span class="bcp14">SHOULD</span> close the TCP connection.  The
          connection can be corrupted if there are too many
          subsequent messages that cannot be parsed as valid IKE messages or
          ESP messages with known SPIs, or if the authentication check for an
          IKE message or ESP message with a known SPI fails.  Implementations <span class="bcp14">SHOULD NOT</span>
          tear down a connection if only a few consecutive ESP packets have unknown
          SPIs since the SPI databases may be momentarily out of sync.  If
          there is instead a syntax issue within an IKE message, an
          implementation <span class="bcp14">MUST</span> send the INVALID_SYNTAX notify payload and
          tear down the IKE SA as usual, rather than tearing down the TCP
          connection directly.<a class="pilcrow" href="#section-6.1-8">¶</a></p>
<p id="section-6.1-9">A TCP Originator <span class="bcp14">SHOULD</span> only open one TCP connection per IKE SA, over
          which it sends all of the corresponding IKE and ESP messages.  This
          helps ensure that any firewall or NAT mappings allocated for the TCP
          connection apply to all of the traffic associated with the IKE SA
          equally.<a class="pilcrow" href="#section-6.1-9">¶</a></p>
<p id="section-6.1-10">  As with TCP Originators, a TCP Responder <span class="bcp14">SHOULD</span> send packets for an
  IKE SA and its Child SAs over only one TCP connection at any given
  time.  It <span class="bcp14">SHOULD</span> choose the TCP connection on which it last received
  a valid and decryptable IKE or ESP message.  In order to be
  considered valid for choosing a TCP connection, an IKE message must
  be successfully decrypted and authenticated, not be a retransmission
  of a previously received message, and be within the expected window
  for IKE message IDs.  Similarly, an ESP message must be successfully
  decrypted and authenticated, and must not be a replay of a previous
  message.<a class="pilcrow" href="#section-6.1-10">¶</a></p>
<p id="section-6.1-11">Since a connection may be broken and a new connection re-established
          by the TCP Originator without the TCP Responder being aware, a TCP
          Responder <span class="bcp14">SHOULD</span> accept receiving IKE and ESP messages on both old
          and new connections until the old connection is closed by the TCP
          Originator.  A TCP Responder <span class="bcp14">MAY</span> close a TCP connection that it
          perceives as idle and extraneous (one previously used for IKE and ESP
          messages that has been replaced by a new connection).<a class="pilcrow" href="#section-6.1-11">¶</a></p>
</section>
</div>
<div id="retr">
<section id="section-6.2">
        <h3 id="name-retransmissions">
<a class="section-number selfRef" href="#section-6.2">6.2. </a><a class="section-name selfRef" href="#name-retransmissions">Retransmissions</a>
        </h3>
<p id="section-6.2-1"><span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7296#section-2.1">Section 2.1</a> of [<a class="cite xref" href="#RFC7296">RFC7296</a>]</span> describes how IKEv2 deals with the unreliability
        of the UDP protocol.



In brief, the exchange Initiator is responsible for retransmissions
and must retransmit request messages until a response message is
received.  If no reply is received after several
          retransmissions, the SA is deleted.  The Responder never initiates retransmission,
          but it must send a response message again in case it receives a retransmitted request.<a class="pilcrow" href="#section-6.2-1">¶</a></p>
<p id="section-6.2-2">When IKEv2 uses a reliable transport protocol, like TCP, the retransmission rules are as follows:<a class="pilcrow" href="#section-6.2-2">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.2-3.1">The exchange Initiator <span class="bcp14">SHOULD NOT</span> retransmit request message (*); if
            no response is received within some reasonable period of time, the
            IKE SA is deleted.<a class="pilcrow" href="#section-6.2-3.1">¶</a>
</li>
          <li class="normal" id="section-6.2-3.2">If a new TCP connection for the IKE SA is established while the exchange
            Initiator is waiting for a response, the Initiator <span class="bcp14">MUST</span>
            retransmit its request over this connection and continue to wait for a response.<a class="pilcrow" href="#section-6.2-3.2">¶</a>
</li>
          <li class="normal" id="section-6.2-3.3">The exchange Responder does not change its behavior, but acts as
 described in <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7296#section-2.1">Section 2.1</a> of [<a class="cite xref" href="#RFC7296">RFC7296</a>]</span>.<a class="pilcrow" href="#section-6.2-3.3">¶</a>
</li>
        </ul>
<p id="section-6.2-4">
          (*) This is an optimization; implementations may continue to use the retransmission logic from 
          <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7296#section-2.1">Section 2.1</a> of [<a class="cite xref" href="#RFC7296">RFC7296</a>]</span> for simplicity.<a class="pilcrow" href="#section-6.2-4">¶</a></p>
</section>
</div>
<div id="cookie-puzzle">
<section id="section-6.3">
        <h3 id="name-cookies-and-puzzles">
<a class="section-number selfRef" href="#section-6.3">6.3. </a><a class="section-name selfRef" href="#name-cookies-and-puzzles">Cookies and Puzzles</a>
        </h3>
<p id="section-6.3-1">IKEv2 provides a DoS attack protection mechanism through Cookies, which
          is described in <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7296#section-2.6">Section 2.6</a> of [<a class="cite xref" href="#RFC7296">RFC7296</a>]</span>.  <span>[<a class="cite xref" href="#RFC8019">RFC8019</a>]</span> extends this
          mechanism for protection against DDoS attacks by means of Client
          Puzzles.  Both mechanisms allow the Responder to avoid keeping state until
          the Initiator proves its IP address is legitimate (and after solving a puzzle if required).<a class="pilcrow" href="#section-6.3-1">¶</a></p>
<p id="section-6.3-2">The connection-oriented nature of TCP transport brings additional 
          considerations for using these mechanisms.
          In general, Cookies provide less value in the case of TCP encapsulation; by the time a Responder receives the IKE_SA_INIT request, the TCP
          session has already been established and the Initiator's IP address
          has been verified.  Moreover, a TCP/IP stack creates state once
          a TCP SYN packet is received (unless SYN Cookies described in <span>[<a class="cite xref" href="#RFC4987">RFC4987</a>]</span>
          are employed), which contradicts the statelessness of IKEv2 Cookies.
          In particular, with TCP, an attacker is able to mount a SYN flooding DoS attack 
          that an IKEv2 Responder cannot prevent using stateless IKEv2 Cookies.
          Thus, when using TCP encapsulation, it makes little sense to send Cookie requests without 
          Puzzles unless the Responder is concerned with a possibility of TCP
          sequence number attacks (see <span>[<a class="cite xref" href="#RFC6528">RFC6528</a>]</span> and <span>[<a class="cite xref" href="#RFC9293">RFC9293</a>]</span> for details). Puzzles, on
   the other hand, still remain useful (and their use requires using Cookies).<a class="pilcrow" href="#section-6.3-2">¶</a></p>
<p id="section-6.3-3">The following considerations are applicable for using Cookie and
          Puzzle mechanisms in the case of TCP encapsulation:<a class="pilcrow" href="#section-6.3-3">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.3-4.1">The exchange Responder <span class="bcp14">SHOULD NOT</span> send an IKEv2 Cookie request without an accompanied Puzzle;
     implementations might choose to have exceptions to this for cases like mitigating TCP sequence number attacks.<a class="pilcrow" href="#section-6.3-4.1">¶</a>
</li>
          <li class="normal" id="section-6.3-4.2">If the Responder chooses to send a Cookie request (possibly along
            with Puzzle request), then the TCP connection that the IKE_SA_INIT
            request message was received over <span class="bcp14">SHOULD</span> be closed after the Responder sends its reply
            and no repeated requests are received within some short period of time 
            to keep the Responder stateless (see <a class="auto internal xref" href="#tradeoff">Section 6.3.1</a>). Note that the Responder <span class="bcp14">MUST NOT</span> 
            include the Initiator's TCP port into the Cookie
 calculation (*) since the Cookie can be returned over a new
 TCP connection with a different port.<a class="pilcrow" href="#section-6.3-4.2">¶</a>
</li>
          <li class="normal" id="section-6.3-4.3">The exchange Initiator acts as described in <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7296#section-2.6">Section 2.6</a> of [<a class="cite xref" href="#RFC7296">RFC7296</a>]</span> and <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc8019#section-7">Section 7</a> of [<a class="cite xref" href="#RFC8019">RFC8019</a>]</span>, i.e., using TCP encapsulation doesn't change the Initiator's behavior.<a class="pilcrow" href="#section-6.3-4.3">¶</a>
</li>
        </ul>
<p id="section-6.3-5">

          (*) Examples of Cookie calculation methods are given in <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7296#section-2.6">Section 2.6</a> of [<a class="cite xref" href="#RFC7296">RFC7296</a>]</span> and in <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc8019#section-7.1.1.3">Section 7.1.1.3</a> of [<a class="cite xref" href="#RFC8019">RFC8019</a>]</span>, and they don't
          include transport protocol ports.  However, these examples are given
          for illustrative purposes since the Cookie generation algorithm is a
          local matter and some implementations might include port numbers
          that won't work with TCP encapsulation. Note also that these
          examples include the Initiator's IP address in Cookie calculation.
          In general, this address may change between two initial requests
          (with and without Cookies).  This may happen due to NATs, which
          have more freedom to change source IP addresses for new TCP
          connections than for UDP. In such cases, cookie verification might
          fail.<a class="pilcrow" href="#section-6.3-5">¶</a></p>
<div id="tradeoff">
<section id="section-6.3.1">
          <h4 id="name-statelessness-versus-delay-">
<a class="section-number selfRef" href="#section-6.3.1">6.3.1. </a><a class="section-name selfRef" href="#name-statelessness-versus-delay-">Statelessness versus Delay of SA Establishment</a>
          </h4>
<p id="section-6.3.1-1">
            There is a trade-off in choosing the period of time after which
            the TCP connection is closed. If it is too short, then the proper Initiator
            that repeats its request would need to re-establish the TCP connection,
            introducing additional delay. On the other hand, if it is too long, then 
            the Responder's resources would be wasted in case the Initiator never comes back.   
            This document doesn't mandate the duration of time because it doesn't affect interoperability, 
            but it is believed that 5-10 seconds is a good compromise. Also, note that if the Responder requests that 
            the Initiator solve a puzzle, then the Responder can estimate how long it would take the Initiator 
            to find a solution and adjust the time interval accordingly.<a class="pilcrow" href="#section-6.3.1-1">¶</a></p>
</section>
</div>
</section>
</div>
<div id="errors">
<section id="section-6.4">
        <h3 id="name-error-handling-in-ike_sa_in">
<a class="section-number selfRef" href="#section-6.4">6.4. </a><a class="section-name selfRef" href="#name-error-handling-in-ike_sa_in">Error Handling in IKE_SA_INIT</a>
        </h3>
<p id="section-6.4-1"><span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7296#section-2.21.1">Section 2.21.1</a> of [<a class="cite xref" href="#RFC7296">RFC7296</a>]</span>
        describes how error notifications are handled in the IKE_SA_INIT
        exchange.  In particular, it is advised that the Initiator should not
        act immediately after receiving an error notification; instead, it should
        wait some time for a valid response since the IKE_SA_INIT
        messages are completely unauthenticated.  This advice does not apply
        equally in the case of TCP encapsulation.  If the Initiator receives a
        response message over TCP, then either this message is genuine and was
        sent by the peer or the TCP session was hijacked and the message is
        forged. In the latter case, no genuine messages from the Responder
        will be received.<a class="pilcrow" href="#section-6.4-1">¶</a></p>
<p id="section-6.4-2">Thus, in the case of TCP encapsulation, an Initiator <span class="bcp14">SHOULD NOT</span> wait for
          additional messages in case it receives an error notification from the
          Responder in the IKE_SA_INIT exchange.<a class="pilcrow" href="#section-6.4-2">¶</a></p>
<p id="section-6.4-3">In the IKE_SA_INIT exchange, if the Responder returns an error notification that implies
          a recovery action from the Initiator (such as INVALID_KE_PAYLOAD
          or INVALID_MAJOR_VERSION, see <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7296#section-2.21.1">Section 2.21.1</a> of [<a class="cite xref" href="#RFC7296">RFC7296</a>]</span>),
          then the Responder <span class="bcp14">SHOULD NOT</span> close the TCP connection immediately in anticipation of the fact
          that the Initiator will repeat the request with corrected parameters.
          See also <a class="auto internal xref" href="#cookie-puzzle">Section 6.3</a>.<a class="pilcrow" href="#section-6.4-3">¶</a></p>
</section>
</div>
<div id="nat-det">
<section id="section-6.5">
        <h3 id="name-nat-detection-payloads">
<a class="section-number selfRef" href="#section-6.5">6.5. </a><a class="section-name selfRef" href="#name-nat-detection-payloads">NAT-Detection Payloads</a>
        </h3>
<p id="section-6.5-1">When negotiating over UDP, IKE_SA_INIT packets include
          NAT_DETECTION_SOURCE_IP and NAT_DETECTION_DESTINATION_IP payloads to
          determine if UDP encapsulation of IPsec packets should be used.
          These payloads contain SHA-1 digests of the SPIs, IP addresses, and
          ports as defined in <span>[<a class="cite xref" href="#RFC7296">RFC7296</a>]</span>.  IKE_SA_INIT packets sent on a TCP
          connection <span class="bcp14">SHOULD</span> include these payloads with the same content as
          when sending over UDP and <span class="bcp14">SHOULD</span> use the applicable TCP ports when
          creating and checking the SHA-1 digests.<a class="pilcrow" href="#section-6.5-1">¶</a></p>
<p id="section-6.5-2">If a NAT is detected due to the SHA-1 digests not matching the
          expected values, no change should be made for encapsulation of
          subsequent IKE or ESP packets since TCP encapsulation inherently
          supports NAT traversal. However, for the transport mode IPsec SAs, implementations 
          need to handle TCP and UDP packet checksum fixup during decapsulation, 
          as defined for UDP encapsulation in <span>[<a class="cite xref" href="#RFC3948">RFC3948</a>]</span>.<a class="pilcrow" href="#section-6.5-2">¶</a></p>
<p id="section-6.5-3">Implementations <span class="bcp14">MAY</span> use the information that
          a NAT is present to influence keepalive timer values.<a class="pilcrow" href="#section-6.5-3">¶</a></p>
</section>
</div>
<div id="nat-ka">
<section id="section-6.6">
        <h3 id="name-nat-keepalive-packets">
<a class="section-number selfRef" href="#section-6.6">6.6. </a><a class="section-name selfRef" href="#name-nat-keepalive-packets">NAT-Keepalive Packets</a>
        </h3>
<p id="section-6.6-1">Encapsulating IKE and IPsec inside of a TCP connection can impact the
         strategy that implementations use to 
         maintain middlebox port mappings.<a class="pilcrow" href="#section-6.6-1">¶</a></p>
<p id="section-6.6-2">In general, TCP port mappings are maintained by NATs longer than UDP
          port mappings, so IPsec ESP NAT-keepalive packets <span>[<a class="cite xref" href="#RFC3948">RFC3948</a>]</span> <span class="bcp14">SHOULD NOT</span> be
          sent when using TCP encapsulation.  Any implementation using TCP
          encapsulation <span class="bcp14">MUST</span> silently drop incoming NAT-keepalive packets
          and not treat them as errors.  NAT-keepalive packets over a
          TCP-encapsulated IPsec connection will be sent as a 1-octet-long payload
          with the value 0xFF, preceded by the 2-octet Length specifying a length
          of 3 (since it includes the length of the Length field).<a class="pilcrow" href="#section-6.6-2">¶</a></p>
</section>
</div>
<div id="dpd">
<section id="section-6.7">
        <h3 id="name-dead-peer-detection-and-tra">
<a class="section-number selfRef" href="#section-6.7">6.7. </a><a class="section-name selfRef" href="#name-dead-peer-detection-and-tra">Dead Peer Detection and Transport Keepalives</a>
        </h3>
<p id="section-6.7-1">Peer liveness should be checked
          using IKE informational packets <span>[<a class="cite xref" href="#RFC7296">RFC7296</a>]</span>.<a class="pilcrow" href="#section-6.7-1">¶</a></p>
<p id="section-6.7-2">Note that, depending on the configuration of TCP and TLS on the
          connection, TCP keep-alives <span>[<a class="cite xref" href="#RFC1122">RFC1122</a>]</span> and TLS keep-alives <span>[<a class="cite xref" href="#RFC6520">RFC6520</a>]</span>
          <span class="bcp14">MAY</span> be used.  These <span class="bcp14">MUST NOT</span> be used as indications of IKE peer
          liveness, for which purpose the standard IKEv2 mechanism of exchanging (usually empty) INFORMATIONAL messages is used
          (see <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7296#section-1.4">Section 1.4</a> of [<a class="cite xref" href="#RFC7296">RFC7296</a>]</span>).<a class="pilcrow" href="#section-6.7-2">¶</a></p>
</section>
</div>
<div id="ipsec">
<section id="section-6.8">
        <h3 id="name-implications-of-tcp-encapsu">
<a class="section-number selfRef" href="#section-6.8">6.8. </a><a class="section-name selfRef" href="#name-implications-of-tcp-encapsu">Implications of TCP Encapsulation on IPsec SA Processing</a>
        </h3>
<p id="section-6.8-1">Using TCP encapsulation affects some aspects of IPsec SA processing.<a class="pilcrow" href="#section-6.8-1">¶</a></p>
<ol class="normal type-1" id="section-6.8-2" start="1" type="1">
<li id="section-6.8-2.1">
            <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc4301#section-8.1">Section 8.1</a> of [<a class="cite xref" href="#RFC4301">RFC4301</a>]</span> requires all tunnel mode IPsec SAs to
            be able to copy the Don't Fragment (DF) bit from inner IPv4 header to
            the outer (tunnel) one.  With TCP encapsulation, this is generally
            not possible because the TCP/IP stack manages the DF bit in the outer IPv4
            header, and usually the stack ensures that the DF bit is set for TCP
            packets to avoid IP fragmentation. Note, that this behavior is 
            compliant with generic tunneling considerations since the outer TCP header acts
            as a link-layer protocol and its fragmentation and reassembly have no correlation with
            the inner payload.<a class="pilcrow" href="#section-6.8-2.1">¶</a>
</li>
          <li id="section-6.8-2.2">The other feature that is less applicable with TCP encapsulation is an
            ability to split traffic of different QoS classes into different
            IPsec SAs, created by a single IKE SA.  In this case, the
            Differentiated Services Code Point (DSCP) field is usually copied
            from the inner IP header to the outer (tunnel) one, ensuring that
            IPsec traffic of each SA receives the corresponding level of service.
            With TCP encapsulation, all IPsec SAs created by a single IKE SA will
            share a single TCP connection; thus, they will receive the same level of
            service (see <a class="auto internal xref" href="#perf.3">Section 9.3</a>).  If this functionality is needed, 
            implementations should create several IKE SAs each over separate TCP connections 
            and assign a corresponding DSCP value to each of them.<a class="pilcrow" href="#section-6.8-2.2">¶</a>
</li>
        </ol>
<p id="section-6.8-3">TCP encapsulation of IPsec packets may have implications
          on performance of the encapsulated traffic. Performance considerations
          are discussed in <a class="auto internal xref" href="#perf">Section 9</a>.<a class="pilcrow" href="#section-6.8-3">¶</a></p>
</section>
</div>
</section>
</div>
<div id="extensions">
<section id="section-7">
      <h2 id="name-interaction-with-ikev2-exte">
<a class="section-number selfRef" href="#section-7">7. </a><a class="section-name selfRef" href="#name-interaction-with-ikev2-exte">Interaction with IKEv2 Extensions</a>
      </h2>
<div id="mobike">
<section id="section-7.1">
        <h3 id="name-mobike-protocol">
<a class="section-number selfRef" href="#section-7.1">7.1. </a><a class="section-name selfRef" href="#name-mobike-protocol">MOBIKE Protocol</a>
        </h3>
<p id="section-7.1-1">The MOBIKE protocol, which allows SAs to migrate between IP
          addresses, is defined in <span>[<a class="cite xref" href="#RFC4555">RFC4555</a>]</span>; <span>[<a class="cite xref" href="#RFC4621">RFC4621</a>]</span> further clarifies
          the details of the protocol. When an IKE session that has negotiated MOBIKE is
          transitioning between networks, the Initiator of the transition may
          switch between using TCP encapsulation, UDP encapsulation, or no
          encapsulation.  Implementations that implement both MOBIKE and TCP
          encapsulation within the same connection configuration 
          <span class="bcp14">MUST</span> support dynamically enabling and disabling TCP
          encapsulation as interfaces change.<a class="pilcrow" href="#section-7.1-1">¶</a></p>
<p id="section-7.1-2">When a MOBIKE-enabled Initiator changes networks, the 
          INFORMATIONAL exchange with the UPDATE_SA_ADDRESSES notification <span class="bcp14">SHOULD</span> be initiated 
          first over UDP before attempting over TCP.  If there is a response to the
          request sent over UDP, then the ESP packets should be sent directly over IP or over UDP port 4500 
          (depending on if a NAT was detected), regardless of if a connection on a previous
          network was using TCP encapsulation.  If no response is received within a certain period of time after
          several retransmissions, the Initiator ought to change its transport for this exchange from
          UDP to TCP and resend the request message. A new INFORMATIONAL exchange <span class="bcp14">MUST NOT</span> be started in this situation. If the Responder only responds to the request sent over TCP, then
          the ESP packets should be sent over the TCP connection, regardless of
          if a connection on a previous network did not use TCP encapsulation.<a class="pilcrow" href="#section-7.1-2">¶</a></p>
<p id="section-7.1-3">The value of the timeout and the specific number of retransmissions before switching to
          TCP can vary depending on the Initiator's configuration. Implementations ought to provide
          reasonable defaults to ensure that UDP attempts have a chance to succeed, but can shorten
          the timeout based on historical data or metrics.<a class="pilcrow" href="#section-7.1-3">¶</a></p>
<p id="section-7.1-4">If the TCP transport was used for the previous network connection, the old TCP
          connection <span class="bcp14">SHOULD</span> be closed by the Initiator once MOBIKE finishes migration 
          to a new connection (either TCP or UDP).<a class="pilcrow" href="#section-7.1-4">¶</a></p>
<p id="section-7.1-5">Since switching from UDP to TCP can happen during a single
   INFORMATIONAL message exchange, the content of the NAT_DETECTION_*_IP
   notifications will in most cases be incorrect (since UDP and TCP ports
   will most likely be different), and the peer may incorrectly detect
   the presence of a NAT. <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc4555#section-3.5">Section 3.5</a> of [<a class="cite xref" href="#RFC4555">RFC4555</a>]</span> states that 
          a new INFORMATIONAL exchange with the UPDATE_SA_ADDRESSES notify is initiated 
          in case the address (or transport) is changed while waiting for a response.<a class="pilcrow" href="#section-7.1-5">¶</a></p>
<p id="section-7.1-6"><span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc4555#section-3.5">Section 3.5</a> of [<a class="cite xref" href="#RFC4555">RFC4555</a>]</span> also states that 
          once an IKE SA is switched to a new IP address, all outstanding requests in this SA 
          are immediately retransmitted using this address. See also <a class="auto internal xref" href="#retr">Section 6.2</a>.<a class="pilcrow" href="#section-7.1-6">¶</a></p>
<p id="section-7.1-7">The MOBIKE protocol defines the NO_NATS_ALLOWED notification that can be
          used to detect the presence of NAT between peer and to refuse to
          communicate in this situation.  In the case of TCP, the NO_NATS_ALLOWED
          notification <span class="bcp14">SHOULD</span> be ignored because TCP generally has no problems
          with NAT boxes.<a class="pilcrow" href="#section-7.1-7">¶</a></p>
<p id="section-7.1-8"><span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc4555#section-3.7">Section 3.7</a> of [<a class="cite xref" href="#RFC4555">RFC4555</a>]</span> describes an additional optional step in the
          process of changing IP addresses called "Return Routability Check".  It
          is performed by Responders in order to be sure that the new
          Initiator's address is, in fact, routable.
In the case of TCP encapsulation, this check has little value since a
TCP handshake proves the routability of the TCP Originator's address;
thus, the Return Routability Check <span class="bcp14">SHOULD NOT</span> be performed.<a class="pilcrow" href="#section-7.1-8">¶</a></p>
</section>
</div>
<div id="redirect">
<section id="section-7.2">
        <h3 id="name-ike-redirect">
<a class="section-number selfRef" href="#section-7.2">7.2. </a><a class="section-name selfRef" href="#name-ike-redirect">IKE Redirect</a>
        </h3>
<p id="section-7.2-1">A redirect mechanism for IKEv2 is defined in <span>[<a class="cite xref" href="#RFC5685">RFC5685</a>]</span>.  This mechanism
          allows security gateways to redirect clients to another gateway
          either during IKE SA establishment or after session setup.  If a
          client is connecting to a security gateway using TCP and
          then is redirected to another security gateway, the client
          needs to reset its transport selection.

In other words, with the next security gateway, the client <span class="bcp14">MUST</span> first try UDP and then fall
back to TCP while establishing a new IKE SA, regardless of the transport of
the SA the redirect notification was received over (unless the client's
configuration instructs it to instantly use TCP for the gateway it is
redirected to).<a class="pilcrow" href="#section-7.2-1">¶</a></p>
</section>
</div>
<div id="resumption">
<section id="section-7.3">
        <h3 id="name-ikev2-session-resumption">
<a class="section-number selfRef" href="#section-7.3">7.3. </a><a class="section-name selfRef" href="#name-ikev2-session-resumption">IKEv2 Session Resumption</a>
        </h3>
<p id="section-7.3-1">Session resumption for IKEv2 is defined in <span>[<a class="cite xref" href="#RFC5723">RFC5723</a>]</span>.  Once an IKE SA is
          established, the server creates a resumption ticket where information
          about this SA is stored and transfers this ticket to the client.
          The ticket may be later used to resume the IKE SA after it is deleted.
          In the event of resumption, the client presents the ticket in a new
          exchange, called IKE_SESSION_RESUME.  Some parameters in the new SA
          are retrieved from the ticket and others are renegotiated (more details
          are given in <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc5723#section-5">Section 5</a> of [<a class="cite xref" href="#RFC5723">RFC5723</a>]</span>).<a class="pilcrow" href="#section-7.3-1">¶</a></p>
<p id="section-7.3-2">Since network conditions may change while the client is inactive,
          the fact that TCP encapsulation was used in an old SA <span class="bcp14">SHOULD NOT</span> affect which transport
          is used during session resumption. In other words, the transport should be 
          selected as if the IKE SA is being created from scratch.<a class="pilcrow" href="#section-7.3-2">¶</a></p>
</section>
</div>
<div id="ha">
<section id="section-7.4">
        <h3 id="name-ikev2-protocol-support-for-">
<a class="section-number selfRef" href="#section-7.4">7.4. </a><a class="section-name selfRef" href="#name-ikev2-protocol-support-for-">IKEv2 Protocol Support for High Availability</a>
        </h3>
<p id="section-7.4-1"><span>[<a class="cite xref" href="#RFC6311">RFC6311</a>]</span> defines a support for High Availability in IKEv2.
          In case of cluster failover, a new active node
          must immediately initiate a special INFORMATION exchange containing the
          IKEV2_MESSAGE_ID_SYNC notification, which instructs the client to
          skip some number of Message IDs that might not be synchronized yet
          between nodes at the time of failover.<a class="pilcrow" href="#section-7.4-1">¶</a></p>
<p id="section-7.4-2">Synchronizing states when using TCP encapsulation is much harder than
          when using UDP; doing so requires access to TCP/IP stack internals, which is
          not always available from an IKE/IPsec implementation.  If a cluster
          implementation doesn't synchronize TCP states between nodes, then
          after failover event the new active node will not have any TCP
          connection with the client, so the node cannot initiate the
          INFORMATIONAL exchange as required by <span>[<a class="cite xref" href="#RFC6311">RFC6311</a>]</span>.  Since the cluster
          usually acts as TCP Responder, the new active node cannot re- establish TCP connection because only the TCP Originator can do it.
          For the client, the cluster failover event may remain
          undetected for long time if it has no IKE or ESP traffic to send.  Once
          the client sends an ESP or IKEv2 packet, the cluster node will reply
          with TCP RST and the client (as TCP Originator) will reestablish the TCP
          connection so that the node will be able to initiate the
          INFORMATIONAL exchange informing the client about the cluster
          failover.<a class="pilcrow" href="#section-7.4-2">¶</a></p>
<p id="section-7.4-3">This document makes the following recommendation: if support for High
          Availability in IKEv2 is negotiated and TCP transport is used,
   a client that is a TCP Originator <span class="bcp14">SHOULD</span> periodically send
          IKEv2 messages (e.g., by initiating liveness check exchange) whenever
          there is no IKEv2 or ESP traffic.  This differs from the
          recommendations given in <span><a class="relref" href="https://www.rfc-editor.org/rfc/rfc7296#section-2.4">Section 2.4</a> of [<a class="cite xref" href="#RFC7296">RFC7296</a>]</span> in the following:
          the liveness check should be periodically performed even if the
          client has nothing to send over ESP.  The frequency of sending such
          messages should be high enough to allow quick detection and restoration
          of broken TCP connections.<a class="pilcrow" href="#section-7.4-3">¶</a></p>
</section>
</div>
<div id="frag">
<section id="section-7.5">
        <h3 id="name-ikev2-fragmentation">
<a class="section-number selfRef" href="#section-7.5">7.5. </a><a class="section-name selfRef" href="#name-ikev2-fragmentation">IKEv2 Fragmentation</a>
        </h3>
<p id="section-7.5-1">IKE message fragmentation <span>[<a class="cite xref" href="#RFC7383">RFC7383</a>]</span> is not required when using TCP
          encapsulation since a TCP stream already handles the fragmentation
          of its contents across packets.  Since fragmentation is redundant in
          this case, implementations might choose to not negotiate IKE
          fragmentation.  Even if fragmentation is negotiated, an
          implementation <span class="bcp14">SHOULD NOT</span> send fragments when going over a TCP
          connection, although it <span class="bcp14">MUST</span> support receiving fragments.<a class="pilcrow" href="#section-7.5-1">¶</a></p>
<p id="section-7.5-2">If an implementation supports both MOBIKE and IKE fragmentation, it
          <span class="bcp14">SHOULD</span> negotiate IKE fragmentation over a TCP-encapsulated session in
          case the session switches to UDP encapsulation on another network.<a class="pilcrow" href="#section-7.5-2">¶</a></p>
</section>
</div>
</section>
</div>
<div id="middle">
<section id="section-8">
      <h2 id="name-middlebox-considerations">
<a class="section-number selfRef" href="#section-8">8. </a><a class="section-name selfRef" href="#name-middlebox-considerations">Middlebox Considerations</a>
      </h2>
<p id="section-8-1">Many security networking devices, such as firewalls or intrusion
        prevention systems, network optimization/acceleration devices, and
        NAT devices, keep the state of sessions that traverse through them.<a class="pilcrow" href="#section-8-1">¶</a></p>
<p id="section-8-2">These devices commonly track the transport-layer and/or application-
        layer data to drop traffic that is anomalous or malicious in nature.
        While many of these devices will be more likely to pass
        TCP-encapsulated traffic as opposed to UDP-encapsulated traffic, some
        may still block or interfere with TCP-encapsulated IKE and IPsec
        traffic.<a class="pilcrow" href="#section-8-2">¶</a></p>
<p id="section-8-3">A network device that monitors the transport layer will track the
        state of TCP sessions, such as TCP sequence numbers.  If the IKE implementation 
        has its own minimal implementation of TCP,
        it <span class="bcp14">SHOULD</span> still use common TCP behaviors to avoid being dropped by
        middleboxes.<a class="pilcrow" href="#section-8-3">¶</a></p>
<p id="section-8-4">Operators that intentionally block IPsec because of security implications 
        might want to also block TCP port 4500 or use other methods to reject TCP encapsulated IPsec traffic 
 (e.g., filter out TCP connections that begin with the "IKETCP" stream prefix).<a class="pilcrow" href="#section-8-4">¶</a></p>
</section>
</div>
<div id="perf">
<section id="section-9">
      <h2 id="name-performance-considerations">
<a class="section-number selfRef" href="#section-9">9. </a><a class="section-name selfRef" href="#name-performance-considerations">Performance Considerations</a>
      </h2>
<p id="section-9-1">Several aspects of TCP encapsulation for IKE and IPsec packets may
        negatively impact the performance of connections within a tunnel-mode
        IPsec SA.  Implementations should be aware of these performance
        impacts and take these into consideration when determining when to
        use TCP encapsulation.  Implementations <span class="bcp14">MUST</span> favor using direct ESP
        or UDP encapsulation over TCP encapsulation whenever possible.<a class="pilcrow" href="#section-9-1">¶</a></p>
<div id="perf.1">
<section id="section-9.1">
        <h3 id="name-tcp-in-tcp">
<a class="section-number selfRef" href="#section-9.1">9.1. </a><a class="section-name selfRef" href="#name-tcp-in-tcp">TCP-in-TCP</a>
        </h3>
<p id="section-9.1-1">If the outer connection between IKE peers is over TCP, inner TCP
          connections may suffer negative effects from using TCP within TCP.
          Running TCP within TCP is discouraged since the TCP algorithms
          generally assume that they are running over an unreliable datagram
          layer.<a class="pilcrow" href="#section-9.1-1">¶</a></p>
<p id="section-9.1-2">If the outer (tunnel) TCP connection experiences packet loss, this
          loss will be hidden from any inner TCP connections since the outer
          connection will retransmit to account for the losses.  Since the
          outer TCP connection will deliver the inner messages in order, any
          messages after a lost packet may have to wait until the loss is
          recovered.  This means that loss on the outer connection will be
          interpreted only as delay by inner connections.  The burstiness of
          inner traffic can increase since a large number of inner packets may
          be delivered across the tunnel at once.  The inner TCP connection may
          interpret a long period of delay as a transmission problem,
          triggering a retransmission timeout, which will cause spurious
          retransmissions.  The sending rate of the inner connection may be
          unnecessarily reduced if the retransmissions are not detected as
          spurious in time.<a class="pilcrow" href="#section-9.1-2">¶</a></p>
<p id="section-9.1-3">The inner TCP connection's round-trip-time estimation will be
          affected by the burstiness of the outer TCP connection if there are
          long delays when packets are retransmitted by the outer TCP
          connection.  This will make the congestion control loop of the inner
          TCP traffic less reactive, potentially permanently leading to a lower
          sending rate than the outer TCP would allow for.<a class="pilcrow" href="#section-9.1-3">¶</a></p>
<p id="section-9.1-4"> TCP-in-TCP can also lead to "TCP meltdown", where stacked instances
          of TCP can result in significant impacts to performance
          <span>[<a class="cite xref" href="#TCP-MELTDOWN">TCP-MELTDOWN</a>]</span>. This can occur when losses in the lower TCP (closer to the link)
          increase delays seen by the higher TCP (closer to the application) that create
          timeouts, which, in turn, cause retransmissions that can then cause losses in 
          the lower TCP by overrunning its buffer. The very mechanism intended to avoid loss
          (retransmission) interacts between the two layers to increase loss. To limit this effect,
          the timeouts of the two TCP layers need to be carefully managed, e.g., such that
          the higher layer has a much longer timeout than the lower layer.<a class="pilcrow" href="#section-9.1-4">¶</a></p>
<p id="section-9.1-5">Note that any negative effects will be shared among all flows going
          through the outer TCP connection.  This is of particular concern for
          any latency-sensitive or real-time applications using the tunnel.  If
          such traffic is using a TCP-encapsulated IPsec connection, it is
          recommended that the number of inner connections sharing the tunnel
          be limited as much as possible.<a class="pilcrow" href="#section-9.1-5">¶</a></p>
</section>
</div>
<div id="perf.2">
<section id="section-9.2">
        <h3 id="name-added-reliability-for-unrel">
<a class="section-number selfRef" href="#section-9.2">9.2. </a><a class="section-name selfRef" href="#name-added-reliability-for-unrel">Added Reliability for Unreliable Protocols</a>
        </h3>
<p id="section-9.2-1">Since ESP is an unreliable protocol, transmitting ESP packets over a
          TCP connection will change the fundamental behavior of the packets.
          Some application-level protocols that prefer packet loss to delay
          (such as Voice over IP or other real-time protocols) may be
          negatively impacted if their packets are retransmitted by the TCP
          connection due to packet loss.<a class="pilcrow" href="#section-9.2-1">¶</a></p>
</section>
</div>
<div id="perf.3">
<section id="section-9.3">
        <h3 id="name-quality-of-service-markings">
<a class="section-number selfRef" href="#section-9.3">9.3. </a><a class="section-name selfRef" href="#name-quality-of-service-markings">Quality-of-Service Markings</a>
        </h3>
<p id="section-9.3-1">Quality-of-Service (QoS) markings, such as the Differentiated
          Services Code Point (DSCP) and Traffic Class, should be used with
          care on TCP connections used for encapsulation.  Individual packets
          <span class="bcp14">SHOULD NOT</span> use different markings than the rest of the connection
          since packets with different priorities may be routed differently and
          cause unnecessary delays in the connection.<a class="pilcrow" href="#section-9.3-1">¶</a></p>
</section>
</div>
<div id="perf.4">
<section id="section-9.4">
        <h3 id="name-maximum-segment-size">
<a class="section-number selfRef" href="#section-9.4">9.4. </a><a class="section-name selfRef" href="#name-maximum-segment-size">Maximum Segment Size</a>
        </h3>
<p id="section-9.4-1">A TCP connection used for IKE encapsulation <span class="bcp14">SHOULD</span> negotiate its MSS
          in order to avoid unnecessary fragmentation of packets.<a class="pilcrow" href="#section-9.4-1">¶</a></p>
</section>
</div>
<div id="perf.5">
<section id="section-9.5">
        <h3 id="name-tunneling-ecn-in-tcp">
<a class="section-number selfRef" href="#section-9.5">9.5. </a><a class="section-name selfRef" href="#name-tunneling-ecn-in-tcp">Tunneling ECN in TCP</a>
        </h3>
<p id="section-9.5-1">Since there is not a one-to-one relationship between outer IP packets
          and inner ESP/IP messages when using TCP encapsulation, the markings
          for Explicit Congestion Notification (ECN) <span>[<a class="cite xref" href="#RFC3168">RFC3168</a>]</span> cannot easily be
          mapped.  However, any ECN Congestion Experienced (CE) marking on
          inner headers should be preserved through the tunnel.<a class="pilcrow" href="#section-9.5-1">¶</a></p>
<p id="section-9.5-2">Implementations <span class="bcp14">SHOULD</span> follow the ECN compatibility mode for tunnel
          ingress as described in <span>[<a class="cite xref" href="#RFC6040">RFC6040</a>]</span>.  In compatibility mode, the outer
          tunnel TCP connection marks its packet headers as not ECN-capable.<a class="pilcrow" href="#section-9.5-2">¶</a></p>
<p id="section-9.5-3">Upon egress, if the arriving outer header is marked with CE, the
          implementation will drop the inner packet since there is not a
          distinct inner packet header onto which to translate the ECN
          markings.<a class="pilcrow" href="#section-9.5-3">¶</a></p>
</section>
</div>
</section>
</div>
<div id="security">
<section id="section-10">
      <h2 id="name-security-considerations">
<a class="section-number selfRef" href="#section-10">10. </a><a class="section-name selfRef" href="#name-security-considerations">Security Considerations</a>
      </h2>
<p id="section-10-1">IKE Responders that support TCP encapsulation may become vulnerable
        to new Denial-of-Service (DoS) attacks that are specific to TCP, such
        as SYN-flooding attacks. TCP Responders should be aware of this additional attack surface.<a class="pilcrow" href="#section-10-1">¶</a></p>
<p id="section-10-2">TCP connections are also susceptible to RST and other spoofing attacks <span>[<a class="cite xref" href="#RFC4953">RFC4953</a>]</span>.
        This specification makes IPsec tolerant of sudden TCP connection drops, but if an attacker
        is able to tear down TCP connections, IPsec connection's performance can suffer, 
        effectively making this a DoS attack.<a class="pilcrow" href="#section-10-2">¶</a></p>
<p id="section-10-3">TCP data injection attacks have no effect on application data since IPsec provides data integrity.
        However, they can have some effect, mostly by creating DoS attacks:<a class="pilcrow" href="#section-10-3">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10-4.1">If an attacker alters the content of the Length field that separates packets,
          then the Receiver will incorrectly identify the boundaries of the following packets and 
          will drop all of them or even tear down the TCP connection if the content of the
          Length field happens to be 0 or 1 (see <a class="auto internal xref" href="#format">Section 3</a>).<a class="pilcrow" href="#section-10-4.1">¶</a>
</li>
        <li class="normal" id="section-10-4.2">If the content of an IKE message is altered, then it will be dropped by the receiver;
          if the dropped message is the IKE request message, then the Initiator will tear 
          down the IKE SA after some timeout since, in most cases, the request message will not be retransmitted
          (as advised in <a class="auto internal xref" href="#retr">Section 6.2</a>); thus, the response will never be received.<a class="pilcrow" href="#section-10-4.2">¶</a>
</li>
        <li class="normal" id="section-10-4.3">If an attacker alters the non-ESP marker, then IKE packets will be dispatched to ESP
          (and sometimes visa versa) and those packets will be dropped.<a class="pilcrow" href="#section-10-4.3">¶</a>
</li>
        <li class="normal" id="section-10-4.4">If an attacker modifies TCP-Encapsulated stream prefix or unencrypted IKE messages before IKE SA is established, 
          then in most cases this will result in failure to establish IKE SA, often with false "authentication failed" diagnostics.<a class="pilcrow" href="#section-10-4.4">¶</a>
</li>
      </ul>
<p id="section-10-5">
        <span>[<a class="cite xref" href="#RFC5961">RFC5961</a>]</span> discusses how TCP injection attacks can be mitigated.<a class="pilcrow" href="#section-10-5">¶</a></p>
<p id="section-10-6">Note that data injection attacks are also possible on IP level (e.g., when IP fragmentation is used),
        resulting in DoS attacks even if TCP encapsulation is not used. On the other hand, TCP injection attacks are easier to mount 
        than the IP fragmentation injection attacks because TCP keeps a long receive window open that's a sitting target for such attacks.<a class="pilcrow" href="#section-10-6">¶</a></p>
<p id="section-10-7">If an attacker successfully mounts an injection attack on a TCP connection used for encapsulating IPsec traffic 
        and modifies a Length field, the receiver might not be able to correctly identify the boundaries of the following packets in the stream
        since it will try to parse arbitrary data as an ESP or IKE header.
        After such a parsing failure, all following packets will be dropped. Communication will eventually recover, but this might
        take several minutes and can result in IKE SA deletion and re-creation.<a class="pilcrow" href="#section-10-7">¶</a></p>
<p id="section-10-8">To speed up the recovery from such attacks, implementations are advised to follow recommendations in <a class="auto internal xref" href="#establish">Section 6.1</a> and close 
        the TCP connection if incoming packets contain SPIs that don't match any known SAs.
        Once the TCP connection is closed, it will be re-created by the TCP Originator as described in <a class="auto internal xref" href="#establish">Section 6.1</a>.<a class="pilcrow" href="#section-10-8">¶</a></p>
<p id="section-10-9">To avoid performance degradation caused by closing and re-creating TCP connections, 
 implementations <span class="bcp14">MAY</span> alternatively try to resync after they receive unknown SPIs by searching the TCP stream
        for a 64-bit binary vector consisting of a known SPI in the first 32 bits and a valid Sequence Number for this SPI in the
        second 32 bits. Then, they can validate the Integrity Check Value (ICV) of this packet candidate by taking the preceding 16 bits as the Length field.




They can also search for 4 bytes of zero (non-ESP marker) followed by
128 bits of IKE SPIs of the IKE SA(s) associated with this TCP connection and
then validate the ICV of this IKE message candidate by taking the 16 bits
preceding the non-ESP marker as the Length field.



 
       Implementations <span class="bcp14">SHOULD</span> limit the attempts to resync, because if the
  injection attack is ongoing, then there is a high probability that
  the resync process will not succeed or will quickly come under attack
  again.<a class="pilcrow" href="#section-10-9">¶</a></p>
<p id="section-10-10">An attacker capable of blocking UDP traffic can force peers to use TCP encapsulation,
        thus, degrading the performance and making the connection more vulnerable to DoS attacks.
        Note that an attacker that is able to modify packets on the wire or to block them can
        prevent peers from communicating regardless of the transport being used.<a class="pilcrow" href="#section-10-10">¶</a></p>
<p id="section-10-11">TCP Responders should be careful to ensure that the stream prefix
        "IKETCP" uniquely identifies incoming streams as streams that use the
        TCP encapsulation protocol.<a class="pilcrow" href="#section-10-11">¶</a></p>
<p id="section-10-12">Attackers may be able to disrupt the TCP connection by sending
        spurious TCP Reset packets.  Therefore, implementations <span class="bcp14">SHOULD</span> make
        sure that IKE session state persists even if the underlying TCP
        connection is torn down.<a class="pilcrow" href="#section-10-12">¶</a></p>
<p id="section-10-13">If MOBIKE is being used, all of the security considerations outlined
        for MOBIKE apply <span>[<a class="cite xref" href="#RFC4555">RFC4555</a>]</span>.<a class="pilcrow" href="#section-10-13">¶</a></p>
<p id="section-10-14">Similar to MOBIKE, TCP encapsulation requires a TCP Responder to
        handle changes to source address and port due to network or
        connection disruption.  The successful delivery of valid new IKE or ESP
        messages over a new TCP connection is used by the TCP Responder to
        determine where to send subsequent responses.  If an attacker is able
        to send packets on a new TCP connection that pass the validation
        checks of the TCP Responder, it can influence which path future
        packets will take.  For this reason, the validation of messages on
        the TCP Responder must include decryption, authentication, and replay
        checks.<a class="pilcrow" href="#section-10-14">¶</a></p>
</section>
</div>
<div id="iana">
<section id="section-11">
      <h2 id="name-iana-considerations">
<a class="section-number selfRef" href="#section-11">11. </a><a class="section-name selfRef" href="#name-iana-considerations">IANA Considerations</a>
      </h2>
<p id="section-11-1">TCP port 4500 is already allocated to IPsec for NAT traversal in the "Service Name and Transport Protocol Port Number Registry".  This
        port <span class="bcp14">SHOULD</span> be used for TCP-encapsulated IKE and ESP as described in
        this document.<a class="pilcrow" href="#section-11-1">¶</a></p>
<p id="section-11-2">This document updates the reference for TCP port 4500 from RFC 8229 to itself:<a class="pilcrow" href="#section-11-2">¶</a></p>
<span class="break"></span><dl class="dlCompact dlParallel" id="section-11-3">
        <dt id="section-11-3.1">Service Name:</dt>
        <dd id="section-11-3.2" style="margin-left: 1.5em">ipsec-nat-t<a class="pilcrow" href="#section-11-3.2">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-11-3.3">Port Number / Transport Protocol:</dt>
        <dd id="section-11-3.4" style="margin-left: 1.5em">4500/tcp<a class="pilcrow" href="#section-11-3.4">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-11-3.5">Description:</dt>
        <dd id="section-11-3.6" style="margin-left: 1.5em">IPsec NAT-Traversal<a class="pilcrow" href="#section-11-3.6">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-11-3.7">Reference:</dt>
        <dd id="section-11-3.8" style="margin-left: 1.5em">RFC 9329<a class="pilcrow" href="#section-11-3.8">¶</a>
</dd>
      <dd class="break"></dd>
</dl>
</section>
</div>
<section id="section-12">
      <h2 id="name-references">
<a class="section-number selfRef" href="#section-12">12. </a><a class="section-name selfRef" href="#name-references">References</a>
      </h2>
<section id="section-12.1">
        <h3 id="name-normative-references">
<a class="section-number selfRef" href="#section-12.1">12.1. </a><a class="section-name selfRef" href="#name-normative-references">Normative References</a>
        </h3>
<dl class="references">
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time class="refDate" datetime="1997-03">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3948">[RFC3948]</dt>
        <dd>
<span class="refAuthor">Huttunen, A.</span>, <span class="refAuthor">Swander, B.</span>, <span class="refAuthor">Volpe, V.</span>, <span class="refAuthor">DiBurro, L.</span>, and <span class="refAuthor">M. Stenberg</span>, <span class="refTitle">"UDP Encapsulation of IPsec ESP Packets"</span>, <span class="seriesInfo">RFC 3948</span>, <span class="seriesInfo">DOI 10.17487/RFC3948</span>, <time class="refDate" datetime="2005-01">January 2005</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc3948">https://www.rfc-editor.org/info/rfc3948</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4301">[RFC4301]</dt>
        <dd>
<span class="refAuthor">Kent, S.</span> and <span class="refAuthor">K. Seo</span>, <span class="refTitle">"Security Architecture for the Internet Protocol"</span>, <span class="seriesInfo">RFC 4301</span>, <span class="seriesInfo">DOI 10.17487/RFC4301</span>, <time class="refDate" datetime="2005-12">December 2005</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4301">https://www.rfc-editor.org/info/rfc4301</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4303">[RFC4303]</dt>
        <dd>
<span class="refAuthor">Kent, S.</span>, <span class="refTitle">"IP Encapsulating Security Payload (ESP)"</span>, <span class="seriesInfo">RFC 4303</span>, <span class="seriesInfo">DOI 10.17487/RFC4303</span>, <time class="refDate" datetime="2005-12">December 2005</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4303">https://www.rfc-editor.org/info/rfc4303</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6040">[RFC6040]</dt>
        <dd>
<span class="refAuthor">Briscoe, B.</span>, <span class="refTitle">"Tunnelling of Explicit Congestion Notification"</span>, <span class="seriesInfo">RFC 6040</span>, <span class="seriesInfo">DOI 10.17487/RFC6040</span>, <time class="refDate" datetime="2010-11">November 2010</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6040">https://www.rfc-editor.org/info/rfc6040</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7296">[RFC7296]</dt>
        <dd>
<span class="refAuthor">Kaufman, C.</span>, <span class="refAuthor">Hoffman, P.</span>, <span class="refAuthor">Nir, Y.</span>, <span class="refAuthor">Eronen, P.</span>, and <span class="refAuthor">T. Kivinen</span>, <span class="refTitle">"Internet Key Exchange Protocol Version 2 (IKEv2)"</span>, <span class="seriesInfo">STD 79</span>, <span class="seriesInfo">RFC 7296</span>, <span class="seriesInfo">DOI 10.17487/RFC7296</span>, <time class="refDate" datetime="2014-10">October 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7296">https://www.rfc-editor.org/info/rfc7296</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8019">[RFC8019]</dt>
        <dd>
<span class="refAuthor">Nir, Y.</span> and <span class="refAuthor">V. Smyslov</span>, <span class="refTitle">"Protecting Internet Key Exchange Protocol Version 2 (IKEv2) Implementations from Distributed Denial-of-Service Attacks"</span>, <span class="seriesInfo">RFC 8019</span>, <span class="seriesInfo">DOI 10.17487/RFC8019</span>, <time class="refDate" datetime="2016-11">November 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8019">https://www.rfc-editor.org/info/rfc8019</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
      <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time class="refDate" datetime="2017-05">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-12.2">
        <h3 id="name-informative-references">
<a class="section-number selfRef" href="#section-12.2">12.2. </a><a class="section-name selfRef" href="#name-informative-references">Informative References</a>
        </h3>
<dl class="references">
<dt id="I-D.ietf-ipsecme-ike-tcp">[IPSECME-IKE-TCP]</dt>
        <dd>
<span class="refAuthor">Nir, Y.</span>, <span class="refTitle">"A TCP transport for the Internet Key Exchange"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-ipsecme-ike-tcp-01</span>, <time class="refDate" datetime="2012-12-03">3 December 2012</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-ipsecme-ike-tcp-01">https://datatracker.ietf.org/doc/html/draft-ietf-ipsecme-ike-tcp-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC1122">[RFC1122]</dt>
        <dd>
<span class="refAuthor">Braden, R., Ed.</span>, <span class="refTitle">"Requirements for Internet Hosts - Communication Layers"</span>, <span class="seriesInfo">STD 3</span>, <span class="seriesInfo">RFC 1122</span>, <span class="seriesInfo">DOI 10.17487/RFC1122</span>, <time class="refDate" datetime="1989-10">October 1989</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc1122">https://www.rfc-editor.org/info/rfc1122</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2817">[RFC2817]</dt>
        <dd>
<span class="refAuthor">Khare, R.</span> and <span class="refAuthor">S. Lawrence</span>, <span class="refTitle">"Upgrading to TLS Within HTTP/1.1"</span>, <span class="seriesInfo">RFC 2817</span>, <span class="seriesInfo">DOI 10.17487/RFC2817</span>, <time class="refDate" datetime="2000-05">May 2000</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2817">https://www.rfc-editor.org/info/rfc2817</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3168">[RFC3168]</dt>
        <dd>
<span class="refAuthor">Ramakrishnan, K.</span>, <span class="refAuthor">Floyd, S.</span>, and <span class="refAuthor">D. Black</span>, <span class="refTitle">"The Addition of Explicit Congestion Notification (ECN) to IP"</span>, <span class="seriesInfo">RFC 3168</span>, <span class="seriesInfo">DOI 10.17487/RFC3168</span>, <time class="refDate" datetime="2001-09">September 2001</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc3168">https://www.rfc-editor.org/info/rfc3168</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4555">[RFC4555]</dt>
        <dd>
<span class="refAuthor">Eronen, P.</span>, <span class="refTitle">"IKEv2 Mobility and Multihoming Protocol (MOBIKE)"</span>, <span class="seriesInfo">RFC 4555</span>, <span class="seriesInfo">DOI 10.17487/RFC4555</span>, <time class="refDate" datetime="2006-06">June 2006</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4555">https://www.rfc-editor.org/info/rfc4555</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4621">[RFC4621]</dt>
        <dd>
<span class="refAuthor">Kivinen, T.</span> and <span class="refAuthor">H. Tschofenig</span>, <span class="refTitle">"Design of the IKEv2 Mobility and Multihoming (MOBIKE) Protocol"</span>, <span class="seriesInfo">RFC 4621</span>, <span class="seriesInfo">DOI 10.17487/RFC4621</span>, <time class="refDate" datetime="2006-08">August 2006</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4621">https://www.rfc-editor.org/info/rfc4621</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4953">[RFC4953]</dt>
        <dd>
<span class="refAuthor">Touch, J.</span>, <span class="refTitle">"Defending TCP Against Spoofing Attacks"</span>, <span class="seriesInfo">RFC 4953</span>, <span class="seriesInfo">DOI 10.17487/RFC4953</span>, <time class="refDate" datetime="2007-07">July 2007</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4953">https://www.rfc-editor.org/info/rfc4953</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4987">[RFC4987]</dt>
        <dd>
<span class="refAuthor">Eddy, W.</span>, <span class="refTitle">"TCP SYN Flooding Attacks and Common Mitigations"</span>, <span class="seriesInfo">RFC 4987</span>, <span class="seriesInfo">DOI 10.17487/RFC4987</span>, <time class="refDate" datetime="2007-08">August 2007</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4987">https://www.rfc-editor.org/info/rfc4987</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5246">[RFC5246]</dt>
        <dd>
<span class="refAuthor">Dierks, T.</span> and <span class="refAuthor">E. Rescorla</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.2"</span>, <span class="seriesInfo">RFC 5246</span>, <span class="seriesInfo">DOI 10.17487/RFC5246</span>, <time class="refDate" datetime="2008-08">August 2008</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc5246">https://www.rfc-editor.org/info/rfc5246</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5685">[RFC5685]</dt>
        <dd>
<span class="refAuthor">Devarapalli, V.</span> and <span class="refAuthor">K. Weniger</span>, <span class="refTitle">"Redirect Mechanism for the Internet Key Exchange Protocol Version 2 (IKEv2)"</span>, <span class="seriesInfo">RFC 5685</span>, <span class="seriesInfo">DOI 10.17487/RFC5685</span>, <time class="refDate" datetime="2009-11">November 2009</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc5685">https://www.rfc-editor.org/info/rfc5685</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5723">[RFC5723]</dt>
        <dd>
<span class="refAuthor">Sheffer, Y.</span> and <span class="refAuthor">H. Tschofenig</span>, <span class="refTitle">"Internet Key Exchange Protocol Version 2 (IKEv2) Session Resumption"</span>, <span class="seriesInfo">RFC 5723</span>, <span class="seriesInfo">DOI 10.17487/RFC5723</span>, <time class="refDate" datetime="2010-01">January 2010</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc5723">https://www.rfc-editor.org/info/rfc5723</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5961">[RFC5961]</dt>
        <dd>
<span class="refAuthor">Ramaiah, A.</span>, <span class="refAuthor">Stewart, R.</span>, and <span class="refAuthor">M. Dalal</span>, <span class="refTitle">"Improving TCP's Robustness to Blind In-Window Attacks"</span>, <span class="seriesInfo">RFC 5961</span>, <span class="seriesInfo">DOI 10.17487/RFC5961</span>, <time class="refDate" datetime="2010-08">August 2010</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc5961">https://www.rfc-editor.org/info/rfc5961</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6311">[RFC6311]</dt>
        <dd>
<span class="refAuthor">Singh, R., Ed.</span>, <span class="refAuthor">Kalyani, G.</span>, <span class="refAuthor">Nir, Y.</span>, <span class="refAuthor">Sheffer, Y.</span>, and <span class="refAuthor">D. Zhang</span>, <span class="refTitle">"Protocol Support for High Availability of IKEv2/IPsec"</span>, <span class="seriesInfo">RFC 6311</span>, <span class="seriesInfo">DOI 10.17487/RFC6311</span>, <time class="refDate" datetime="2011-07">July 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6311">https://www.rfc-editor.org/info/rfc6311</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6520">[RFC6520]</dt>
        <dd>
<span class="refAuthor">Seggelmann, R.</span>, <span class="refAuthor">Tuexen, M.</span>, and <span class="refAuthor">M. Williams</span>, <span class="refTitle">"Transport Layer Security (TLS) and Datagram Transport Layer Security (DTLS) Heartbeat Extension"</span>, <span class="seriesInfo">RFC 6520</span>, <span class="seriesInfo">DOI 10.17487/RFC6520</span>, <time class="refDate" datetime="2012-02">February 2012</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6520">https://www.rfc-editor.org/info/rfc6520</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6528">[RFC6528]</dt>
        <dd>
<span class="refAuthor">Gont, F.</span> and <span class="refAuthor">S. Bellovin</span>, <span class="refTitle">"Defending against Sequence Number Attacks"</span>, <span class="seriesInfo">RFC 6528</span>, <span class="seriesInfo">DOI 10.17487/RFC6528</span>, <time class="refDate" datetime="2012-02">February 2012</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6528">https://www.rfc-editor.org/info/rfc6528</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7383">[RFC7383]</dt>
        <dd>
<span class="refAuthor">Smyslov, V.</span>, <span class="refTitle">"Internet Key Exchange Protocol Version 2 (IKEv2) Message Fragmentation"</span>, <span class="seriesInfo">RFC 7383</span>, <span class="seriesInfo">DOI 10.17487/RFC7383</span>, <time class="refDate" datetime="2014-11">November 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7383">https://www.rfc-editor.org/info/rfc7383</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8229">[RFC8229]</dt>
        <dd>
<span class="refAuthor">Pauly, T.</span>, <span class="refAuthor">Touati, S.</span>, and <span class="refAuthor">R. Mantha</span>, <span class="refTitle">"TCP Encapsulation of IKE and IPsec Packets"</span>, <span class="seriesInfo">RFC 8229</span>, <span class="seriesInfo">DOI 10.17487/RFC8229</span>, <time class="refDate" datetime="2017-08">August 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8229">https://www.rfc-editor.org/info/rfc8229</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
        <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time class="refDate" datetime="2018-08">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8446">https://www.rfc-editor.org/info/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9293">[RFC9293]</dt>
        <dd>
<span class="refAuthor">Eddy, W., Ed.</span>, <span class="refTitle">"Transmission Control Protocol (TCP)"</span>, <span class="seriesInfo">STD 7</span>, <span class="seriesInfo">RFC 9293</span>, <span class="seriesInfo">DOI 10.17487/RFC9293</span>, <time class="refDate" datetime="2022-08">August 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9293">https://www.rfc-editor.org/info/rfc9293</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9325">[RFC9325]</dt>
        <dd>
<span class="refAuthor">Sheffer, Y.</span>, <span class="refAuthor">Saint-Andre, P.</span>, and <span class="refAuthor">T. Fossati</span>, <span class="refTitle">"Recommendations for Secure Use of Transport Layer Security (TLS) and Datagram Transport Layer Security (DTLS)"</span>, <span class="seriesInfo">RFC 9325</span>, <span class="seriesInfo">DOI 10.17487/RFC9325</span>, <time class="refDate" datetime="2022-11">November 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9325">https://www.rfc-editor.org/info/rfc9325</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="TCP-MELTDOWN">[TCP-MELTDOWN]</dt>
      <dd>
<span class="refAuthor">Honda, O.</span>, <span class="refAuthor">Ohsaki, H.</span>, <span class="refAuthor">Imase, M.</span>, <span class="refAuthor">Ishizuka, M.</span>, and <span class="refAuthor">J. Murayama</span>, <span class="refTitle">"Understanding TCP over TCP: effects of TCP tunneling on end-to-end throughput and latency"</span>, <time class="refDate" datetime="2005-10">October 2005</time>, <span>&lt;<a href="https://doi.org/10.1117/12.630496">https://doi.org/10.1117/12.630496</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</section>
<div id="tls">
<section id="appendix-A">
      <h2 id="name-using-tcp-encapsulation-wit">
<a class="section-number selfRef" href="#appendix-A">Appendix A. </a><a class="section-name selfRef" href="#name-using-tcp-encapsulation-wit">Using TCP Encapsulation with TLS</a>
      </h2>
<p id="appendix-A-1">This section provides recommendations on how to use TLS in addition
          to TCP encapsulation.<a class="pilcrow" href="#appendix-A-1">¶</a></p>
<p id="appendix-A-2">When using TCP encapsulation, implementations may choose to use TLS 1.2
          <span>[<a class="cite xref" href="#RFC5246">RFC5246</a>]</span> or TLS 1.3 <span>[<a class="cite xref" href="#RFC8446">RFC8446</a>]</span> on the TCP connection 
          to be able to traverse middleboxes, which may otherwise block the traffic.<a class="pilcrow" href="#appendix-A-2">¶</a></p>
<p id="appendix-A-3">If a web proxy is applied to the ports used for the TCP connection
          and TLS is being used, the TCP Originator can send an HTTP CONNECT
          message to establish an SA through the proxy <span>[<a class="cite xref" href="#RFC2817">RFC2817</a>]</span>.<a class="pilcrow" href="#appendix-A-3">¶</a></p>
<p id="appendix-A-4">The use of TLS should be configurable on the peers and may be used
          as the default when using TCP encapsulation or may be used as a
          fallback when basic TCP encapsulation fails.  The TCP Responder may
          expect to read encapsulated IKE and ESP packets directly from the TCP
          connection, or it may expect to read them from a stream of TLS data
          packets.  The TCP Originator should be preconfigured regarding whether or not to use TLS
          when communicating with a given port on the TCP Responder.<a class="pilcrow" href="#appendix-A-4">¶</a></p>
<p id="appendix-A-5">When new TCP connections are re-established due to a broken
          connection, TLS must be renegotiated.  TLS session resumption is
          recommended to improve efficiency in this case.<a class="pilcrow" href="#appendix-A-5">¶</a></p>
<p id="appendix-A-6">The security of the IKE session is entirely derived from the IKE
          negotiation and key establishment and not from the TLS session (which,
          in this context, is only used for encapsulation purposes); therefore,
          when TLS is used on the TCP connection, both the TCP Originator and
          the TCP Responder <span class="bcp14">SHOULD</span> allow the NULL cipher to be selected for
          performance reasons. Note that TLS 1.3 only supports AEAD algorithms
          and at the time of writing this document there was no recommended cipher suite 
          for TLS 1.3 with the NULL cipher. It is <span class="bcp14">RECOMMENDED</span> to follow 
          <span>[<a class="cite xref" href="#RFC9325">RFC9325</a>]</span> when selecting parameters for TLS.<a class="pilcrow" href="#appendix-A-6">¶</a></p>
<p id="appendix-A-7">Implementations should be aware that the use of TLS introduces
          another layer of overhead requiring more bytes to transmit a given
          IKE and IPsec packet.  For this reason, direct ESP, UDP
          encapsulation, or TCP encapsulation without TLS should be preferred
          in situations in which TLS is not required in order to traverse
          middleboxes.<a class="pilcrow" href="#appendix-A-7">¶</a></p>
</section>
</div>
<div id="tls-example">
<section id="appendix-B">
      <h2 id="name-example-exchanges-of-tcp-en">
<a class="section-number selfRef" href="#appendix-B">Appendix B. </a><a class="section-name selfRef" href="#name-example-exchanges-of-tcp-en">Example Exchanges of TCP Encapsulation with TLS 1.3</a>
      </h2>
<p id="appendix-B-1">This appendix contains examples of data flows in cases where TCP encapsulation of IKE and IPsec packets 
 is used with TLS 1.3. The examples below are provided for illustrative purpose only; 
 readers should refer to the main body of the document for details.<a class="pilcrow" href="#appendix-B-1">¶</a></p>
<div id="tls-example-1">
<section id="appendix-B.1">
        <h3 id="name-establishing-an-ike-session">
<a class="section-number selfRef" href="#appendix-B.1">B.1. </a><a class="section-name selfRef" href="#name-establishing-an-ike-session">Establishing an IKE Session</a>
        </h3>
<div class="alignLeft art-text artwork" id="appendix-B.1-1">
<pre>                Client                              Server
              ----------                          ----------
  1)  --------------------  TCP Connection  -------------------
      (IP_I:Port_I  -&gt; IP_R:Port_R)
      TcpSyn                   -------&gt;
                               &lt;-------              TcpSyn,Ack
      TcpAck                   -------&gt;
  2)  ---------------------  TLS Session  ---------------------
      ClientHello              -------&gt;
                                                    ServerHello
                                          {EncryptedExtensions}
                                                 {Certificate*}
                                           {CertificateVerify*}
                               &lt;-------              {Finished}
      {Finished}               -------&gt;
  3)  ---------------------- Stream Prefix --------------------
      "IKETCP"                 -------&gt;
  4)  ----------------------- IKE Session ---------------------
      Length + Non-ESP Marker  -------&gt;
      IKE_SA_INIT
      HDR, SAi1, KEi, Ni,
      [N(NAT_DETECTION_SOURCE_IP)],
      [N(NAT_DETECTION_DESTINATION_IP)]
                               &lt;------- Length + Non-ESP Marker
                                                    IKE_SA_INIT
                                            HDR, SAr1, KEr, Nr,
                                  [N(NAT_DETECTION_SOURCE_IP)],
                              [N(NAT_DETECTION_DESTINATION_IP)]
      Length + Non-ESP Marker  -------&gt;
      first IKE_AUTH
      HDR, SK {IDi, [CERTREQ]
      CP(CFG_REQUEST), IDr,
      SAi2, TSi, TSr, ...}
                               &lt;------- Length + Non-ESP Marker
                                                 first IKE_AUTH
                                    HDR, SK {IDr, [CERT], AUTH,
                                           EAP, SAr2, TSi, TSr}
      Length + Non-ESP Marker  -------&gt;
      IKE_AUTH (repeat 1..N times)
      HDR, SK {EAP}
                               &lt;------- Length + Non-ESP Marker
                                   IKE_AUTH (repeat 1..N times)
                                                   HDR SK {EAP}
      Length + Non-ESP Marker  -------&gt;
      final IKE_AUTH
      HDR, SK {AUTH}
                               &lt;------- Length + Non-ESP Marker
                                                 final IKE_AUTH
                                  HDR, SK {AUTH, CP(CFG_REPLY),
                                             SA, TSi, TSr, ...}
      -------------- IKE and IPsec SAs Established ------------
      Length + ESP Frame       -------&gt;</pre><a class="pilcrow" href="#appendix-B.1-1">¶</a>
</div>
<ol class="normal type-1" id="appendix-B.1-2" start="1" type="1">
<li id="appendix-B.1-2.1">The client establishes a TCP connection with the server on
               port 4500 or on an alternate preconfigured port that the server
               is listening on.<a class="pilcrow" href="#appendix-B.1-2.1">¶</a>
</li>
          <li id="appendix-B.1-2.2">If configured to use TLS, the client initiates a TLS handshake.
              During the TLS handshake, the server <span class="bcp14">SHOULD NOT</span> request the
              client's certificate since authentication is handled as part of
              IKE negotiation.<a class="pilcrow" href="#appendix-B.1-2.2">¶</a>
</li>
          <li id="appendix-B.1-2.3">The client sends the stream prefix for TCP-encapsulated IKE
              (<a class="auto internal xref" href="#prefix">Section 4</a>) traffic to signal the beginning of IKE negotiation.<a class="pilcrow" href="#appendix-B.1-2.3">¶</a>
</li>
          <li id="appendix-B.1-2.4">The client and server establish an IKE connection.  This example
              shows EAP-based authentication, although any authentication type
              may be used.<a class="pilcrow" href="#appendix-B.1-2.4">¶</a>
</li>
        </ol>
</section>
</div>
<div id="tls-example-2">
<section id="appendix-B.2">
        <h3 id="name-deleting-an-ike-session">
<a class="section-number selfRef" href="#appendix-B.2">B.2. </a><a class="section-name selfRef" href="#name-deleting-an-ike-session">Deleting an IKE Session</a>
        </h3>
<div class="alignLeft art-text artwork" id="appendix-B.2-1">
<pre>                Client                              Server
              ----------                          ----------
  1)  ----------------------- IKE Session ---------------------
      Length + Non-ESP Marker  -------&gt;
      INFORMATIONAL
      HDR, SK {[N,] [D,]
             [CP,] ...}
                               &lt;------- Length + Non-ESP Marker
                                                  INFORMATIONAL
                                             HDR, SK {[N,] [D,]
                                                     [CP], ...}
  2)  ---------------------  TLS Session  ---------------------
      close_notify             -------&gt;
                               &lt;-------            close_notify
  3)  --------------------  TCP Connection  -------------------
      TcpFin                   -------&gt;
                               &lt;-------                     Ack
                               &lt;-------                  TcpFin
      Ack                      -------&gt;
      --------------------  IKE SA Deleted  -------------------</pre><a class="pilcrow" href="#appendix-B.2-1">¶</a>
</div>
<ol class="normal type-1" id="appendix-B.2-2" start="1" type="1">
<li id="appendix-B.2-2.1">The client and server exchange informational messages to notify
              IKE SA deletion.<a class="pilcrow" href="#appendix-B.2-2.1">¶</a>
</li>
          <li id="appendix-B.2-2.2">The client and server negotiate TLS session deletion using TLS
              CLOSE_NOTIFY.<a class="pilcrow" href="#appendix-B.2-2.2">¶</a>
</li>
          <li id="appendix-B.2-2.3">The TCP connection is torn down.<a class="pilcrow" href="#appendix-B.2-2.3">¶</a>
</li>
        </ol>
<p id="appendix-B.2-3">The deletion of the IKE SA should lead to the disposal of the
            underlying TLS and TCP state.<a class="pilcrow" href="#appendix-B.2-3">¶</a></p>
</section>
</div>
<div id="tls-example-3">
<section id="appendix-B.3">
        <h3 id="name-re-establishing-an-ike-sess">
<a class="section-number selfRef" href="#appendix-B.3">B.3. </a><a class="section-name selfRef" href="#name-re-establishing-an-ike-sess">Re-establishing an IKE Session</a>
        </h3>
<div class="alignLeft art-text artwork" id="appendix-B.3-1">
<pre>                Client                              Server
              ----------                          ----------
  1)  --------------------  TCP Connection  -------------------
      (IP_I:Port_I  -&gt; IP_R:Port_R)
      TcpSyn                   -------&gt;
                               &lt;-------              TcpSyn,Ack
      TcpAck                   -------&gt;
  2)  ---------------------  TLS Session  ---------------------
      ClientHello              -------&gt;
                                                    ServerHello
                                          {EncryptedExtensions}
                               &lt;-------              {Finished}
      {Finished}               -------&gt;
  3)  ---------------------- Stream Prefix --------------------
      "IKETCP"                 -------&gt;
  4)  &lt;---------------------&gt; IKE/ESP Flow &lt;------------------&gt;</pre><a class="pilcrow" href="#appendix-B.3-1">¶</a>
</div>
<ol class="normal type-1" id="appendix-B.3-2" start="1" type="1">
<li id="appendix-B.3-2.1">If a previous TCP connection was broken (for example, due to a
              TCP Reset), the client is responsible for re-initiating the TCP
              connection.  The TCP Originator's address and port (IP_I and
              Port_I) may be different from the previous connection's address
              and port.<a class="pilcrow" href="#appendix-B.3-2.1">¶</a>
</li>
          <li id="appendix-B.3-2.2">The client <span class="bcp14">SHOULD</span> attempt TLS session resumption if it
              has previously established a session with the server.<a class="pilcrow" href="#appendix-B.3-2.2">¶</a>
</li>
          <li id="appendix-B.3-2.3">After TCP and TLS are complete, the client sends the stream
              prefix for TCP-encapsulated IKE traffic (<a class="auto internal xref" href="#prefix">Section 4</a>).<a class="pilcrow" href="#appendix-B.3-2.3">¶</a>
</li>
          <li id="appendix-B.3-2.4">The IKE and ESP packet flow can resume.  If MOBIKE is being used,
              the Initiator <span class="bcp14">SHOULD</span> send an UPDATE_SA_ADDRESSES message.<a class="pilcrow" href="#appendix-B.3-2.4">¶</a>
</li>
        </ol>
</section>
</div>
<div id="tls-example-4">
<section id="appendix-B.4">
        <h3 id="name-using-mobike-between-udp-an">
<a class="section-number selfRef" href="#appendix-B.4">B.4. </a><a class="section-name selfRef" href="#name-using-mobike-between-udp-an">Using MOBIKE between UDP and TCP Encapsulation</a>
        </h3>
<div class="alignLeft art-text artwork" id="appendix-B.4-1">
<pre>                  Client                              Server
                ----------                          ----------
  1)  --------------------- IKE_session ----------------------
      (IP_I1:UDP500 -&gt; IP_R:UDP500)
      IKE_SA_INIT              -------&gt;
      HDR, SAi1, KEi, Ni,
      [N(NAT_DETECTION_SOURCE_IP)],
      [N(NAT_DETECTION_DESTINATION_IP)]
                               &lt;-------            IKE_SA_INIT
                                            HDR, SAr1, KEr, Nr,
                                  [N(NAT_DETECTION_SOURCE_IP)],
                              [N(NAT_DETECTION_DESTINATION_IP)]
      (IP_I1:UDP4500 -&gt; IP_R:UDP4500)
      Non-ESP Marker           -------&gt;
      IKE_AUTH
      HDR, SK { IDi, CERT, AUTH,
      SAi2, TSi, TSr,
      N(MOBIKE_SUPPORTED) }
                               &lt;-------          Non-ESP Marker
                                                       IKE_AUTH
                                     HDR, SK { IDr, CERT, AUTH,
                                                SAr2, TSi, TSr,
                                          N(MOBIKE_SUPPORTED) }
      &lt;---------------------&gt; IKE/ESP Flow &lt;------------------&gt;
  2)  ------------ MOBIKE Attempt on New Network --------------
      (IP_I2:UDP4500 -&gt; IP_R:UDP4500)
      Non-ESP Marker           -------&gt;
      INFORMATIONAL
      HDR, SK { N(UPDATE_SA_ADDRESSES),
      N(NAT_DETECTION_SOURCE_IP),
      N(NAT_DETECTION_DESTINATION_IP) }
  3)  --------------------  TCP Connection  -------------------
      (IP_I2:Port_I -&gt; IP_R:Port_R)
      TcpSyn                   -------&gt;
                               &lt;-------              TcpSyn,Ack
      TcpAck                   -------&gt;
  4)  ---------------------  TLS Session  ---------------------
      ClientHello              -------&gt;
                                                    ServerHello
                                          {EncryptedExtensions}
                                                 {Certificate*}
                                           {CertificateVerify*}
                               &lt;-------              {Finished}
      {Finished}               -------&gt;
  5)  ---------------------- Stream Prefix --------------------
      "IKETCP"                 -------&gt;</pre><a class="pilcrow" href="#appendix-B.4-1">¶</a>
</div>
<div class="alignLeft art-text artwork" id="appendix-B.4-2">
<pre>  6)  ------------ Retransmit Message from step 2 -------------
      Length + Non-ESP Marker  -------&gt;
      INFORMATIONAL
      HDR, SK { N(UPDATE_SA_ADDRESSES),
      N(NAT_DETECTION_SOURCE_IP),
      N(NAT_DETECTION_DESTINATION_IP) }
                               &lt;------- Length + Non-ESP Marker
                                                  INFORMATIONAL
                          HDR, SK { N(NAT_DETECTION_SOURCE_IP),
                              N(NAT_DETECTION_DESTINATION_IP) }
  7)  -- New Exchange with recalculated  NAT_DETECTION_*_IP ---
      Length + Non-ESP Marker  -------&gt;
      INFORMATIONAL
      HDR, SK { N(UPDATE_SA_ADDRESSES),
      N(NAT_DETECTION_SOURCE_IP),
      N(NAT_DETECTION_DESTINATION_IP) }
                               &lt;------- Length + Non-ESP Marker
                                                  INFORMATIONAL
                          HDR, SK { N(NAT_DETECTION_SOURCE_IP),
                              N(NAT_DETECTION_DESTINATION_IP) }
  8)  &lt;---------------------&gt; IKE/ESP Flow &lt;------------------&gt;</pre><a class="pilcrow" href="#appendix-B.4-2">¶</a>
</div>
<ol class="normal type-1" id="appendix-B.4-3" start="1" type="1">
<li id="appendix-B.4-3.1">During the IKE_AUTH exchange, the client and server exchange
              MOBIKE_SUPPORTED notify payloads to indicate support for MOBIKE.<a class="pilcrow" href="#appendix-B.4-3.1">¶</a>
</li>
          <li id="appendix-B.4-3.2">The client changes its point of attachment to the network and
              receives a new IP address.  The client attempts to re-establish
              the IKE session using the UPDATE_SA_ADDRESSES notify payload, but
              the server does not respond because the network blocks UDP
              traffic.<a class="pilcrow" href="#appendix-B.4-3.2">¶</a>
</li>
          <li id="appendix-B.4-3.3">The client brings up a TCP connection to the server in order to
              use TCP encapsulation.<a class="pilcrow" href="#appendix-B.4-3.3">¶</a>
</li>
          <li id="appendix-B.4-3.4">The client initiates a TLS handshake with the server.<a class="pilcrow" href="#appendix-B.4-3.4">¶</a>
</li>
          <li id="appendix-B.4-3.5">The client sends the stream prefix for TCP-encapsulated IKE
              traffic (<a class="auto internal xref" href="#prefix">Section 4</a>).<a class="pilcrow" href="#appendix-B.4-3.5">¶</a>
</li>
          <li id="appendix-B.4-3.6">The client sends the UPDATE_SA_ADDRESSES notify payload in the 
              INFORMATIONAL exchange on the
              TCP-encapsulated connection.  Note that this IKE message is the
              same as the one sent over UDP in step 2; it should have the same
              message ID and contents.<a class="pilcrow" href="#appendix-B.4-3.6">¶</a>
</li>
          <li id="appendix-B.4-3.7">Once the client receives a response on the
              TCP-encapsulated connection, it immediately starts a new INFORMATIONAL
              exchange with an UPDATE_SA_ADDRESSES notify payload and recalculated 
              NAT_DETECTION_*_IP notify payloads in order to get correct information about the presence 
              of NATs.<a class="pilcrow" href="#appendix-B.4-3.7">¶</a>
</li>
          <li id="appendix-B.4-3.8">The IKE and ESP packet flow can resume.<a class="pilcrow" href="#appendix-B.4-3.8">¶</a>
</li>
        </ol>
</section>
</div>
</section>
</div>
<div id="acknowledgments">
<section id="appendix-C">
      <h2 id="name-acknowledgments">
<a class="section-name selfRef" href="#name-acknowledgments">Acknowledgments</a>
      </h2>
<p id="appendix-C-1">Thanks to the authors of RFC 8229 (<span class="contact-name">Tommy       Pauly</span>, <span class="contact-name">Samy Touati</span>, and <span class="contact-name">Ravi       Mantha</span>).  Since this document clarifies and obsoletes RFC 8229, most of
      its text was borrowed from the original document.<a class="pilcrow" href="#appendix-C-1">¶</a></p>
<p id="appendix-C-2">The following people provided valuable feedback and advice while
      preparing RFC 8229: <span class="contact-name">Stuart Cheshire</span>, <span class="contact-name">Delziel Fernandes</span>, <span class="contact-name">Yoav Nir</span>, <span class="contact-name">Christoph Paasch</span>, <span class="contact-name">Yaron Sheffer</span>,
      <span class="contact-name">David Schinazi</span>, <span class="contact-name">Graham       Bartlett</span>, <span class="contact-name">Byju Pularikkal</span>, <span class="contact-name">March Wu</span>, <span class="contact-name">Kingwel Xie</span>, <span class="contact-name">Valery Smyslov</span>, <span class="contact-name">Jun Hu</span>, and <span class="contact-name">Tero Kivinen</span>. Special thanks to <span class="contact-name">Eric       Kinnear</span> for his implementation work.<a class="pilcrow" href="#appendix-C-2">¶</a></p>
<p id="appendix-C-3">The authors would like to thank <span class="contact-name">Tero Kivinen</span>,
      <span class="contact-name">Paul Wouters</span>, <span class="contact-name">Joseph Touch</span>,
      and <span class="contact-name">Christian Huitema</span> for their valuable comments
      while preparing this document.<a class="pilcrow" href="#appendix-C-3">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-D">
      <h2 id="name-authors-addresses">
<a class="section-name selfRef" href="#name-authors-addresses">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div class="left" dir="auto"><span class="fn nameRole">Tommy Pauly</span></div>
<div class="left" dir="auto"><span class="org">Apple Inc.</span></div>
<div class="left" dir="auto"><span class="street-address">1 Infinite Loop</span></div>
<div class="left" dir="auto">
<span class="locality">Cupertino</span>, <span class="region">California</span> <span class="postal-code">95014</span>
</div>
<div class="left" dir="auto"><span class="country-name">United States of America</span></div>
<div class="email">
<span>Email:</span>
<a class="email" href="mailto:tpauly@apple.com">tpauly@apple.com</a>
</div>
</address>
<address class="vcard">
        <div class="left" dir="auto"><span class="fn nameRole">Valery Smyslov</span></div>
<div class="left" dir="auto"><span class="org">ELVIS-PLUS</span></div>
<div class="left" dir="auto"><span class="street-address">PO Box 81</span></div>
<div class="left" dir="auto"><span class="locality">Moscow (Zelenograd)</span></div>
<div class="left" dir="auto"><span class="postal-code">124460</span></div>
<div class="left" dir="auto"><span class="country-name">Russian Federation</span></div>
<div class="tel">
<span>Phone:</span>
<a class="tel" href="tel:+7%20495%20276%200211">+7 495 276 0211</a>
</div>
<div class="email">
<span>Email:</span>
<a class="email" href="mailto:svan@elvis.ru">svan@elvis.ru</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>


</body></html>