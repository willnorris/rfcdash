<html><head></head><body><pre>Internet Engineering Task Force (IETF)                       K. Kompella
Request for Comments: 6790                                      J. Drake
Updates: <a href="./rfc3031">3031</a>, <a href="./rfc3107">3107</a>, <a href="./rfc3209">3209</a>, <a href="./rfc5036">5036</a>                         Juniper Networks
Category: Standards Track                                      S. Amante
ISSN: 2070-1721                             Level 3 Communications, Inc.
                                                           W. Henderickx
                                                          Alcatel-Lucent
                                                                 L. Yong
                                                              Huawei USA
                                                           November 2012


              <span class="h1">The Use of Entropy Labels in MPLS Forwarding</span>

Abstract

   Load balancing is a powerful tool for engineering traffic across a
   network.  This memo suggests ways of improving load balancing across
   MPLS networks using the concept of "entropy labels".  It defines the
   concept, describes why entropy labels are useful, enumerates
   properties of entropy labels that allow maximal benefit, and shows
   how they can be signaled and used for various applications.  This
   document updates RFCs 3031, 3107, 3209, and 5036.

Status of This Memo

   This is an Internet Standards Track document.

   This document is a product of the Internet Engineering Task Force
   (IETF).  It represents the consensus of the IETF community.  It has
   received public review and has been approved for publication by the
   Internet Engineering Steering Group (IESG).  Further information on
   Internet Standards is available in <a href="./rfc5741#section-2">Section 2 of RFC 5741</a>.

   Information about the current status of this document, any errata,
   and how to provide feedback on it may be obtained at
   <a href="http://www.rfc-editor.org/info/rfc6790">http://www.rfc-editor.org/info/rfc6790</a>.

Copyright Notice

   Copyright (c) 2012 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="https://www.rfc-editor.org/bcp/bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect



<span class="grey">Kompella, et al.             Standards Track                    [Page 1]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-2"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.

Table of Contents

   <a href="#section-1">1</a>. Introduction ....................................................<a href="#page-3">3</a>
      <a href="#section-1.1">1.1</a>. Conventions Used ...........................................<a href="#page-4">4</a>
      <a href="#section-1.2">1.2</a>. Motivation .................................................<a href="#page-6">6</a>
   <a href="#section-2">2</a>. Approaches ......................................................<a href="#page-7">7</a>
   <a href="#section-3">3</a>. Entropy Labels and Their Structure ..............................<a href="#page-8">8</a>
   <a href="#section-4">4</a>. Data Plane Processing of Entropy Labels .........................<a href="#page-9">9</a>
      <a href="#section-4.1">4.1</a>. Egress LSR .................................................<a href="#page-9">9</a>
      <a href="#section-4.2">4.2</a>. Ingress LSR ...............................................<a href="#page-10">10</a>
      <a href="#section-4.3">4.3</a>. Transit LSR ...............................................<a href="#page-11">11</a>
      <a href="#section-4.4">4.4</a>. Penultimate Hop LSR .......................................<a href="#page-12">12</a>
   <a href="#section-5">5</a>. Signaling for Entropy Labels ...................................<a href="#page-12">12</a>
      <a href="#section-5.1">5.1</a>. LDP Signaling .............................................<a href="#page-12">12</a>
           <a href="#section-5.1.1">5.1.1</a>. Processing the ELC TLV .............................<a href="#page-13">13</a>
      <a href="#section-5.2">5.2</a>. BGP Signaling .............................................<a href="#page-13">13</a>
      <a href="#section-5.3">5.3</a>. RSVP-TE Signaling .........................................<a href="#page-14">14</a>
      <a href="#section-5.4">5.4</a>. Multicast LSPs and Entropy Labels .........................<a href="#page-15">15</a>
   6. Operations, Administration, and Maintenance (OAM) and
      Entropy Labels .................................................<a href="#page-15">15</a>
   <a href="#section-7">7</a>. MPLS-TP and Entropy Labels .....................................<a href="#page-16">16</a>
   <a href="#section-8">8</a>. Entropy Labels in Various Scenarios ............................<a href="#page-16">16</a>
      <a href="#section-8.1">8.1</a>. LDP Tunnel ................................................<a href="#page-17">17</a>
      <a href="#section-8.2">8.2</a>. LDP over RSVP-TE ..........................................<a href="#page-20">20</a>
      <a href="#section-8.3">8.3</a>. MPLS Applications .........................................<a href="#page-20">20</a>
   <a href="#section-9">9</a>. Security Considerations ........................................<a href="#page-20">20</a>
   <a href="#section-10">10</a>. IANA Considerations ...........................................<a href="#page-21">21</a>
      <a href="#section-10.1">10.1</a>. Reserved Label for ELI ...................................<a href="#page-21">21</a>
      <a href="#section-10.2">10.2</a>. LDP Entropy Label Capability TLV .........................<a href="#page-21">21</a>
      <a href="#section-10.3">10.3</a>. BGP Entropy Label Capability Attribute ...................<a href="#page-21">21</a>
      <a href="#section-10.4">10.4</a>. RSVP-TE Entropy Label Capability Flag ....................<a href="#page-22">22</a>
   <a href="#section-11">11</a>. Acknowledgments ...............................................<a href="#page-22">22</a>
   <a href="#section-12">12</a>. References ....................................................<a href="#page-22">22</a>
      <a href="#section-12.1">12.1</a>. Normative References .....................................<a href="#page-22">22</a>
      <a href="#section-12.2">12.2</a>. Informative References ...................................<a href="#page-23">23</a>
   <a href="#appendix-A">Appendix A</a>. Applicability of LDP Entropy Label Capability TLV .....<a href="#page-24">24</a>










<span class="grey">Kompella, et al.             Standards Track                    [Page 2]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-3"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.%20%20Introduction"></a><a class="selflink" href="#section-1" id="section-1">1</a>.  Introduction</span>

   Load balancing, or multi-pathing, is an attempt to balance traffic
   across a network by allowing the traffic to use multiple paths.  Load
   balancing has several benefits: it eases capacity planning, it can
   help absorb traffic surges by spreading them across multiple paths,
   and it allows better resilience by offering alternate paths in the
   event of a link or node failure.

   As providers scale their networks, they use several techniques to
   achieve greater bandwidth between nodes.  Two widely used techniques
   are: Link Aggregation Group (LAG) and Equal Cost Multi-Path (ECMP).
   LAG is used to bond together several physical circuits between two
   adjacent nodes so they appear to higher-layer protocols as a single,
   higher-bandwidth "virtual" pipe.  ECMP is used between two nodes
   separated by one or more hops, to allow load balancing over several
   shortest paths in the network.  This is typically obtained by
   arranging IGP metrics such that there are several equal cost paths
   between source-destination pairs.  Both of these techniques may, and
   often do, coexist in differing parts of a given provider's network,
   depending on various choices made by the provider.

   A very important requirement when load balancing is that packets
   belonging to a given "flow" must be mapped to the same path, i.e.,
   the same exact sequence of links across the network.  This is to
   avoid jitter, latency, and reordering issues for the flow.  What
   constitutes a flow varies considerably.  A common example of a flow
   is a TCP session.  Other examples are a Layer 2 Tunneling Protocol
   (L2TP) session corresponding to a given broadband user or traffic
   within an ATM virtual circuit.

   To meet this requirement, a node uses certain fields, termed "keys",
   within a packet's header as input to a load-balancing function
   (typically a hash function) that selects the path for all packets in
   a given flow.  The keys chosen for the load-balancing function depend
   on the packet type; a typical set (for IP packets) is the IP source
   and destination addresses, the protocol type, and (for TCP and UDP
   traffic) the source and destination port numbers.  An overly
   conservative choice of fields may lead to many flows mapping to the
   same hash value (and consequently poorer load balancing); an overly
   aggressive choice may map a flow to multiple values, potentially
   violating the above requirement.

   For MPLS networks, most of the same principles (and benefits) apply.
   However, finding useful keys in a packet for the purpose of load
   balancing can be more of a challenge.  In many cases, MPLS
   encapsulation may require fairly deep inspection of packets to find
   these keys at transit Label Switching Routers (LSRs).



<span class="grey">Kompella, et al.             Standards Track                    [Page 3]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-4"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   One way to eliminate the need for this deep inspection is to have the
   ingress LSR of an MPLS Label Switched Path extract the appropriate
   keys from a given packet, input them to its load-balancing function,
   and place the result in an additional label, termed the "entropy
   label", as part of the MPLS label stack it pushes onto that packet.

   The entire label stack of the MPLS packet can then be used by transit
   LSRs to perform load balancing, as the entropy label introduces the
   right level of "entropy" into the label stack.

   There are five key reasons why this is beneficial:

   1.  At the ingress LSR, MPLS encapsulation hasn't yet occurred, so
       deep inspection is not necessary.

   2.  The ingress LSR has more context and information about incoming
       packets than transit LSRs.

   3.  Ingress LSRs usually operate at lower bandwidths than transit
       LSRs, allowing them to do more work per packet.

   4.  Transit LSRs do not need to perform deep packet inspection and
       can load balance effectively using only a packet's MPLS label
       stack.

   5.  Transit LSRs, not having the full context that an ingress LSR
       does, have the hard choice between potentially misinterpreting
       fields in a packet as valid keys for load balancing (causing
       packet-ordering problems) or adopting a conservative approach
       (giving rise to sub-optimal load balancing).  Entropy labels
       relieve them of making this choice.

   This memo describes why entropy labels are needed and defines the
   properties of entropy labels, in particular, how they are generated
   and received and the expected behavior of transit LSRs.  Finally, it
   describes in general how signaling works and what needs to be
   signaled as well as specifics for the signaling of entropy labels for
   LDP [<a href="./rfc5036" title='"LDP Specification"'>RFC5036</a>], BGP [<a href="./rfc4271" title='"A Border Gateway Protocol 4 (BGP-4)"'>RFC4271</a>], and RSVP - Traffic Engineering
   (RSVP-TE) [<a href="./rfc3209" title='"RSVP-TE: Extensions to RSVP for LSP Tunnels"'>RFC3209</a>].

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.1.%20%20Conventions%20Used"></a><a class="selflink" href="#section-1.1" id="section-1.1">1.1</a>.  Conventions Used</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in [<a href="./rfc2119" title='"Key words for use in RFCs to Indicate Requirement Levels"'>RFC2119</a>].






<span class="grey">Kompella, et al.             Standards Track                    [Page 4]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-5"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   The following acronyms/initialisms are used:

      BoS: Bottom of Stack

      CE: Customer Edge

      ECMP: Equal Cost Multi-Path

      EL: Entropy Label

      ELC: Entropy Label Capability

      ELI: Entropy Label Indicator

      FEC: Forwarding Equivalence Class

      LAG: Link Aggregation Group

      LER: Label Edge Router

      LSP: Label Switched Path

      LSR: Label Switching Router

      PE: Provider Edge

      PW: Pseudowire

      PHP: Penultimate Hop Popping

      TC: Traffic Class

      TTL: Time to Live

      UHP: Ultimate Hop Popping

      VPLS: Virtual Private LAN (Local Area Network) Service

      VPN: Virtual Private Network

   The term "ingress LSR" (or "egress LSR") is used interchangeably with
   "ingress LER" (or "egress LER").  The term "application" throughout
   the text refers to an MPLS application (such as a VPN or VPLS).

   A label stack (say of three labels) is denoted by &lt;L1, L2, L3&gt;, where
   L1 is the "outermost" label and L3 the "innermost" (closest to the
   payload).  Packet flows are depicted left to right, and signaling is
   shown right to left (unless otherwise indicated).



<span class="grey">Kompella, et al.             Standards Track                    [Page 5]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-6"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   The term "label" is used both for the entire 32-bit label stack entry
   and the 20-bit label field within a label stack entry.  It should be
   clear from the context which is meant.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.2.%20%20Motivation"></a><a class="selflink" href="#section-1.2" id="section-1.2">1.2</a>.  Motivation</span>

   MPLS is a very successful generic forwarding substrate that
   transports several dozen types of protocols, most notably: IP, PWs,
   VPLS, and IP VPNs.  Within each type of protocol, there typically
   exist several variants, each with a different set of load-balancing
   keys, e.g., IPv4, IPv6, IPv6 in IPv4, etc. for IP and Ethernet; ATM,
   Frame-Relay, etc. for PWs.  There are also several different types of
   Ethernet over PW encapsulation, ATM over PW encapsulation, etc.
   Finally, given the popularity of MPLS, it is likely that it will
   continue to be extended to transport new protocols.

   Currently, each transit LSR along the path of a given LSP has to try
   to infer the underlying protocol within an MPLS packet in order to
   extract appropriate keys for load balancing.  Unfortunately, if the
   transit LSR is unable to infer the MPLS packet's protocol (as is
   often the case), it will typically use the topmost (or all) MPLS
   labels in the label stack as keys for the load-balancing function.
   The result may be an extremely inequitable distribution of traffic
   across equal cost paths exiting that LSR.  This is because MPLS
   labels are generally fairly coarse-grained forwarding labels that
   typically describe a next hop, or provide some demultiplexing and/or
   forwarding function, and do not describe the packet's underlying
   protocol.

   On the other hand, an ingress LSR (e.g., a PE router) has detailed
   knowledge of a packet's contents, typically through a priori
   configuration of the encapsulations that are expected at a given
   PE-CE interface, (e.g., IPv4, IPv6, VPLS, etc.).  They may also have
   more flexible forwarding hardware, depending on implementation
   details.  PE routers need this information and these capabilities to:

   a.  apply the required services for the CE;

   b.  discern the packet's Class of Service (CoS) forwarding treatment;

   c.  apply filters to forward or block traffic to/from the CE;

   d.  forward routing/control traffic to an onboard management
       processor; and,

   e.  load balance the traffic on its uplinks to transit LSRs (e.g., P
       routers).




<span class="grey">Kompella, et al.             Standards Track                    [Page 6]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-7"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   By knowing the expected encapsulation types, an ingress LSR router
   can apply a more specific set of payload parsing routines to extract
   the keys appropriate for a given protocol.  This allows for
   significantly improved accuracy in determining the appropriate load-
   balancing behavior for each protocol.

   If the ingress LSR were to capture the flow information so gathered
   in a convenient form for downstream transit LSRs, transit LSRs could
   remain completely oblivious to the contents of each MPLS packet and
   use only the captured flow information to perform load balancing.  In
   particular, there will be no reason to duplicate an ingress LSR's
   complex packet/payload parsing functionality in a transit LSR.  This
   will result in less complex transit LSRs, enabling them to more
   easily scale to higher forwarding rates, larger port density, lower
   power consumption, etc.  The idea in this memo is to capture this
   flow information as a label, the so-called "entropy label".

   Ingress LSRs can also adapt more readily to new protocols and extract
   the appropriate keys to use for load-balancing packets of those
   protocols.  This means that deploying new protocols or services in
   edge devices requires fewer concomitant changes in the core,
   resulting in higher edge-service velocity and, at the same time, more
   stable core networks.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/2.%20%20Approaches"></a><a class="selflink" href="#section-2" id="section-2">2</a>.  Approaches</span>

   There are two main approaches to encoding load-balancing information
   in the label stack.  The first allocates multiple labels for a
   particular Forwarding Equivalence Class (FEC).  These labels are
   equivalent in terms of forwarding semantics, but having multiple
   labels allows flexibility in assigning labels to flows belonging to
   the same FEC.  This approach has the advantage that the label stack
   has the same depth whether or not one uses label-based load
   balancing; consequently, there is no change to forwarding operations
   on transit and egress LSRs.  However, it has a major drawback in that
   there is a significant increase in both signaling and forwarding
   state.

   The other approach encodes the load-balancing information as an
   additional label in the label stack, thus increasing the depth of the
   label stack by one.  With this approach, there is minimal change to
   signaling state for a FEC; also, there is no change in forwarding
   operations in transit LSRs and no increase of forwarding state in any
   LSR.  The only purpose of the additional label is to increase the
   entropy in the label stack, so this is called an "entropy label".
   This memo focuses solely on this approach.





<span class="grey">Kompella, et al.             Standards Track                    [Page 7]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-8"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   This latter approach uses upstream-generated entropy labels, which
   may conflict with downstream-allocated application labels.  There are
   a few approaches to deal with this: 1) allocate a pair of labels for
   each FEC, one that must have an entropy label below it and one that
   must not; 2) use a label (the "Entropy Label Indicator") to indicate
   that the next label is an entropy label; and 3) allow entropy labels
   only where there is no possible confusion.  The first doubles control
   and data plane state in the network; the last is too restrictive.
   The approach taken here is the second.  In making both the above
   choices, the trade-off is to increase label stack depth rather than
   control and data plane state in the network.

   Finally, one may choose to associate ELs with MPLS tunnels (LSPs) or
   with MPLS applications (e.g., VPNs).  (What this entails is described
   in later sections.)  We take the former approach, for the following
   reasons:

   1.  There are a small number of tunneling protocols for MPLS, but a
       large and growing number of applications.  Defining ELs on a
       tunnel basis means simpler standards, lower development,
       interoperability, and testing efforts.

   2.  As a consequence, there will be much less churn in the network as
       new applications (services) are defined and deployed.

   3.  Processing application labels in the data plane is more complex
       than processing tunnel labels.  Thus, it is preferable to burden
       the latter rather than the former with EL processing.

   4.  Associating ELs with tunnels makes it simpler to deal with
       hierarchy, be it LDP-over-RSVP-TE or Carrier's Carrier VPNs.
       Each layer in the hierarchy can choose independently whether or
       not they want ELs.

   The cost of this approach is that ELIs will be mandatory; again, the
   trade-off is the size of the label stack.  To summarize, the net
   increase in the label stack to use entropy labels is two: one
   reserved label for the ELI and the entropy label itself.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.%20%20Entropy%20Labels%20and%20Their%20Structure"></a><a class="selflink" href="#section-3" id="section-3">3</a>.  Entropy Labels and Their Structure</span>

   An entropy label (as used here) is a label:

   1.  that is not used for forwarding;

   2.  that is not signaled; and





<span class="grey">Kompella, et al.             Standards Track                    [Page 8]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-9"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   3.  whose only purpose in the label stack is to provide "entropy" to
       improve load balancing.

   Entropy labels are generated by an ingress LSR, based entirely on
   load-balancing information.  However, they MUST NOT have values in
   the reserved label space (0-15) [<a href="./rfc3032" title='"MPLS Label Stack Encoding"'>RFC3032</a>].

   Since entropy labels are generated by an ingress LSR, an egress LSR
   MUST be able to distinguish unambiguously between entropy labels and
   application labels.  To accomplish this, it is REQUIRED that the
   label immediately preceding an Entropy Label (EL) in the MPLS label
   stack be an Entropy Label Indicator (ELI), where preceding means
   closer to the top of the label stack (farther from bottom of stack
   indication).  The ELI is a reserved label with value 7.  How to set
   values of the TTL, TC, and "Bottom of Stack" (BoS) fields [<a href="./rfc3032" title='"MPLS Label Stack Encoding"'>RFC3032</a>]
   for the ELI and for ELs is discussed in <a href="#section-4.2">Section 4.2</a>.

   Entropy labels are useful for pseudowires [<a href="./rfc4447" title='"Pseudowire Setup and Maintenance Using the Label Distribution Protocol (LDP)"'>RFC4447</a>].  [<a href="./rfc6391" title='"Flow-Aware Transport of Pseudowires over an MPLS Packet Switched Network"'>RFC6391</a>]
   explains how entropy labels can be used for pseudowires that are of
   the <a href="./rfc4447">RFC 4447</a> style and is therefore complementary to this memo, which
   focuses on how entropy labels can be used for tunnels and thus for
   all other MPLS applications.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.%20%20Data%20Plane%20Processing%20of%20Entropy%20Labels"></a><a class="selflink" href="#section-4" id="section-4">4</a>.  Data Plane Processing of Entropy Labels</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.1.%20%20Egress%20LSR"></a><a class="selflink" href="#section-4.1" id="section-4.1">4.1</a>.  Egress LSR</span>

   Suppose egress LSR Y is capable of processing entropy labels for a
   tunnel.  Y indicates this to all ingresses via signaling (see
   <a href="#section-5">Section 5</a>).  Y MUST be prepared to deal both with packets with an
   imposed EL and those without; the ELI will distinguish these cases.
   If a particular ingress chooses not to impose an EL, Y's processing
   of the received label stack (which might be empty) is as if Y chose
   not to accept ELs.

   If an ingress LSR X chooses to impose an EL, then Y will receive a
   tunnel termination packet with label stack &lt;TL, ELI, EL&gt; &lt;remaining
   packet header&gt;.  Y recognizes TL as the label it distributed to its
   upstreams for the tunnel and pops it.  (Note that TL may be the
   implicit null label, in which case it doesn't appear in the label
   stack.)  Y then recognizes the ELI and pops two labels: the ELI and
   the EL.  Y then processes the remaining packet header as normal; this
   may require further processing of tunnel termination, perhaps with
   further ELI+EL pairs.  When processing the final tunnel termination,
   Y MAY enqueue the packet based on that tunnel TL's or ELI's TC value
   and MAY use the tunnel TL's or ELI's TTL to compute the TTL of the
   remaining packet header.  The EL's TTL MUST be ignored.




<span class="grey">Kompella, et al.             Standards Track                    [Page 9]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-10"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   If any ELI processed by Y has the BoS bit set, Y MUST discard the
   packet and MAY log an error.  The EL's BoS bit will indicate whether
   or not there are more labels in the stack.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.2.%20%20Ingress%20LSR"></a><a class="selflink" href="#section-4.2" id="section-4.2">4.2</a>.  Ingress LSR</span>

   If an egress LSR Y indicates via signaling that it can process ELs on
   a particular tunnel, an ingress LSR X can choose whether or not to
   insert ELs for packets going into that tunnel.  Y MUST handle both
   cases.

   The steps that X performs to insert ELs are as follows:

   1.  On an incoming packet, identify the application to which the
       packet belongs; based on this, pick appropriate fields as input
       to the load-balancing function; apply the load-balancing function
       to these input fields and let LB be the output.

   2.  Determine the application label AL (if any).  Push &lt;AL&gt; onto the
       packet.

   3.  Based on the application, the load-balancing output LB and other
       factors, determine the egress LSR Y, the tunnel to Y, the
       specific interface to the next hop, and thus the tunnel label TL.
       Use LB to generate the entropy label EL.

   4.  If, for the chosen tunnel, Y has not indicated that it can
       process ELs, push &lt;TL&gt; onto the packet.  If Y has indicated that
       it can process ELs for the tunnel, push &lt;TL, ELI, EL&gt; onto the
       packet.  X SHOULD put the same TTL and TC fields for the ELI as
       it does for TL.  X MAY choose different values for the TTL and TC
       fields if it is known that the ELI will not be exposed as the top
       label at any point along the LSP (as may happen in cases where
       PHP is used and the ELI and EL are not stripped at the
       penultimate hop (see <a href="#section-4.4">Section 4.4</a>).  The BoS bit for the ELI MUST
       be zero (i.e., BoS is not set).  The TTL for the EL MUST be zero
       to ensure that it is not used inadvertently for forwarding.  The
       TC for the EL may be any value.  The BoS bit for the EL depends
       on whether or not there are more labels in the label stack.

   5.  X then determines whether further tunnel hierarchy is needed; if
       so, X goes back to step 3, possibly with a new egress Y for the
       new tunnel.  Otherwise, X is done and sends out the packet.








<span class="grey">Kompella, et al.             Standards Track                   [Page 10]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-11"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   Notes:

   a.  X computes load-balancing information and generates the EL based
       on the incoming application packet, even though the signaling of
       EL capability is associated with tunnels.

   b.  X MAY insert several entropy labels in the stack (each, of
       course, preceded by an ELI), potentially one for each
       hierarchical tunnel, provided that the egress for that tunnel has
       indicated that it can process ELs for that tunnel.

   c.  X MUST NOT include an entropy label for a given tunnel unless the
       egress LSR Y has indicated that it can process entropy labels for
       that tunnel.

   d.  The signaling and use of entropy labels in one direction
       (signaling from Y to X and data path from X to Y) is completely
       independent of the signaling and use of entropy labels in the
       reverse direction (signaling from X to Y and data path from Y to
       X).

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.3.%20%20Transit%20LSR"></a><a class="selflink" href="#section-4.3" id="section-4.3">4.3</a>.  Transit LSR</span>

   Transit LSRs MAY operate with no change in forwarding behavior.  The
   following are suggestions for optimizations that improve load
   balancing, reduce the amount of packet data processed, and/or enhance
   backward compatibility.

   If a transit LSR recognizes the ELI, it MAY choose to load balance
   solely on the following label (the EL); otherwise, it SHOULD use as
   much of the whole label stack as feasible as keys for the load-
   balancing function.  In any case, reserved labels MUST NOT be used as
   keys for the load-balancing function.

   Some transit LSRs look beyond the label stack for better load-
   balancing information.  This is a simple, backward-compatible
   approach in networks where some ingress LSRs impose ELs and others
   don't.  However, this is of limited incremental value if an EL is
   indeed present and requires more packet processing from the LSR.  A
   transit LSR MAY choose to parse the label stack for the presence of
   the ELI and look beyond the label stack only if it does not find it,
   thus retaining the old behavior when needed, yet avoiding unnecessary
   work if not needed.








<span class="grey">Kompella, et al.             Standards Track                   [Page 11]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-12"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   As stated in Sections <a href="#section-4.1">4.1</a> and <a href="#section-5">5</a>, an egress LSR that signals both ELC
   and implicit null MUST pop the ELI and the next label (which should
   be the EL), if it encounters a packet with the ELI as the topmost
   label.  Any other LSR (including PHP LSRs) MUST drop such packets, as
   per <a href="./rfc3031#section-3.18">Section 3.18 of [RFC3031]</a>.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.4.%20%20Penultimate%20Hop%20LSR"></a><a class="selflink" href="#section-4.4" id="section-4.4">4.4</a>.  Penultimate Hop LSR</span>

   No change is needed at penultimate hop LSRs.  However, a PHP LSR that
   recognizes the ELI MAY choose to pop the ELI and following label
   (which should be an entropy label) in addition to popping the tunnel
   label, provided that doing so doesn't diminish its ability to load
   balance on the next hop.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.%20%20Signaling%20for%20Entropy%20Labels"></a><a class="selflink" href="#section-5" id="section-5">5</a>.  Signaling for Entropy Labels</span>

   An egress LSR Y can signal to ingress LSR(s) its ability to process
   entropy labels (henceforth called "Entropy Label Capability" or ELC)
   on a given tunnel.  In particular, even if Y signals an implicit null
   label, indicating that PHP is to be performed, Y MUST be prepared to
   pop the ELI and EL.

   Note that Entropy Label Capability may be asymmetric: if LSRs X and Y
   are at opposite ends of a tunnel, X may be able to process entropy
   labels, whereas Y may not.  The signaling extensions below allow for
   this asymmetry.

   For an illustration of signaling and forwarding with entropy labels,
   see <a href="#section-8">Section 8</a>.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.1.%20%20LDP%20Signaling"></a><a class="selflink" href="#section-5.1" id="section-5.1">5.1</a>.  LDP Signaling</span>

   A new LDP TLV [<a href="./rfc5036" title='"LDP Specification"'>RFC5036</a>] is defined to signal an egress's ability to
   process entropy labels.  This is called the ELC TLV and may appear as
   an Optional Parameter of the Label Mapping Message TLV.

   The presence of the ELC TLV in a Label Mapping Message indicates to
   ingress LSRs that the egress LSR can process entropy labels for the
   associated LDP tunnel.  The ELC TLV has Type 0x0206 and Length 0.

   The structure of the ELC TLV is shown below.










<span class="grey">Kompella, et al.             Standards Track                   [Page 12]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-13"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |U|F|        Type 0x0206        |           Length (0)          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

                  Figure 1: Entropy Label Capability TLV

   where:

      U: Unknown bit.  This bit MUST be set to 1.  If the ELC TLV is not
      understood by the receiver, then it MUST be ignored.

      F: Forward bit.  This bit MUST be set be set to 1.  Since the ELC
      TLV is going to be propagated hop-by-hop, it should be forwarded
      even by nodes that may not understand it.

      Type: Type field (0x0206)

      Length: Length field.  This field specifies the total length in
      octets of the ELC TLV and is currently defined to be 0.

<span class="h4"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.1.1.%20%20Processing%20the%20ELC%20TLV"></a><a class="selflink" href="#section-5.1.1" id="section-5.1.1">5.1.1</a>.  Processing the ELC TLV</span>

   An LSR that receives a Label Mapping with the ELC TLV but does not
   understand it MUST propagate it intact to its neighbors and MUST NOT
   send a notification to the sender (following the meaning of the U-
   and F-bits).

   An LSR X may receive multiple Label Mappings for a given FEC F from
   its neighbors.  In its turn, X may advertise a Label Mapping for F to
   its neighbors.  If X understands the ELC TLV, and if any of the
   advertisements it received for FEC F does not include the ELC TLV, X
   MUST NOT include the ELC TLV in its own advertisements of F.  If all
   the advertised Mappings for F include the ELC TLV, then X MUST
   advertise its Mapping for F with the ELC TLV.  If any of X's
   neighbors resends its Mapping, sends a new Mapping or sends a Label
   Withdraw for a previously advertised Mapping for F, X MUST re-
   evaluate the status of ELC for FEC F, and, if there is a change, X
   MUST re-advertise its Mapping for F with the updated status of ELC.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.2.%20%20BGP%20Signaling"></a><a class="selflink" href="#section-5.2" id="section-5.2">5.2</a>.  BGP Signaling</span>

   When BGP [<a href="./rfc4271" title='"A Border Gateway Protocol 4 (BGP-4)"'>RFC4271</a>] is used for distributing Network Layer
   Reachability Information (NLRI) as described in, for example,
   [<a href="./rfc3107" title='"Carrying Label Information in BGP-4"'>RFC3107</a>], the BGP UPDATE message may include the ELC attribute as
   part of the Path Attributes.  This is an optional, transitive BGP




<span class="grey">Kompella, et al.             Standards Track                   [Page 13]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-14"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   attribute of value 28.  The inclusion of this attribute with an NLRI
   indicates that the advertising BGP router can process entropy labels
   as an egress LSR for all routes in that NLRI.

   A BGP speaker S that originates an UPDATE should include the ELC
   attribute only if both of the following are true:

   A1:  S sets the BGP NEXT_HOP attribute to itself AND

   A2:  S can process entropy labels.

   Suppose a BGP speaker T receives an UPDATE U with the ELC attribute.
   T has two choices.  T can simply re-advertise U with the ELC
   attribute if either of the following is true:

   B1:  T does not change the NEXT_HOP attribute OR

   B2:  T simply swaps labels without popping the entire label stack and
        processing the payload below.

   An example of the use of B1 is Route Reflectors.

   However, if T changes the NEXT_HOP attribute for U and in the data
   plane pops the entire label stack to process the payload, T MAY
   include an ELC attribute for UPDATE U' if both of the following are
   true:

   C1:  T sets the NEXT_HOP attribute of U' to itself AND

   C2:  T can process entropy labels.

   Otherwise, T MUST remove the ELC attribute.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.3.%20%20RSVP-TE%20Signaling"></a><a class="selflink" href="#section-5.3" id="section-5.3">5.3</a>.  RSVP-TE Signaling</span>

   Entropy label support is signaled in RSVP-TE [<a href="./rfc3209" title='"RSVP-TE: Extensions to RSVP for LSP Tunnels"'>RFC3209</a>] using the
   Entropy Label Capability (ELC) flag in the Attribute Flags TLV of the
   LSP_ATTRIBUTES object [<a href="./rfc5420" title='"Encoding of Attributes for MPLS LSP Establishment Using Resource Reservation Protocol Traffic Engineering (RSVP-TE)"'>RFC5420</a>].  The presence of the ELC flag in a
   Path message indicates that the ingress can process entropy labels in
   the upstream direction; this only makes sense for a bidirectional LSP
   and MUST be ignored otherwise.  The presence of the ELC flag in a
   Resv message indicates that the egress can process entropy labels in
   the downstream direction.

   The bit number for the ELC flag is 9.






<span class="grey">Kompella, et al.             Standards Track                   [Page 14]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-15"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.4.%20%20Multicast%20LSPs%20and%20Entropy%20Labels"></a><a class="selflink" href="#section-5.4" id="section-5.4">5.4</a>.  Multicast LSPs and Entropy Labels</span>

   Multicast LSPs [<a href="./rfc4875" title='"Extensions to Resource Reservation Protocol - Traffic Engineering (RSVP-TE) for Point-to-Multipoint TE Label Switched Paths (LSPs)"'>RFC4875</a>] [<a href="./rfc6388" title='"Label Distribution Protocol Extensions for Point-to- Multipoint and Multipoint-to-Multipoint Label Switched Paths"'>RFC6388</a>] typically do not use ECMP for load
   balancing, as the combination of replication and multi-pathing can
   lead to duplicate traffic delivery.  However, these LSPs can traverse
   bundled links [<a href="./rfc4201" title='"Link Bundling in MPLS Traffic Engineering (TE)"'>RFC4201</a>] and LAGs.  In both these cases, load
   balancing is useful, and hence entropy labels can be of value for
   multicast LSPs.

   The methodology defined for entropy labels here will be used for
   multicast LSPs; however, the details of signaling and processing ELs
   for multicast LSPs will be specified in a future document.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/6.%20%20Operations%2C%20Administration%2C%20and%20Maintenance%20%28OAM%29%20and%20Entropy%20Labels"></a><a class="selflink" href="#section-6" id="section-6">6</a>.  Operations, Administration, and Maintenance (OAM) and Entropy Labels</span>

   Generally, OAM comprises a set of functions operating in the data
   plane to allow a network operator to monitor its network
   infrastructure and to implement mechanisms in order to enhance the
   general behavior and the level of performance of its network, e.g.,
   the efficient and automatic detection, localization, diagnosis, and
   handling of defects.

   Currently defined OAM mechanisms for MPLS include LSP ping/traceroute
   [<a href="./rfc4379" title='"Detecting Multi-Protocol Label Switched (MPLS) Data Plane Failures"'>RFC4379</a>] and Bidirectional Forwarding Detection (BFD) for MPLS
   [<a href="./rfc5884" title='"Bidirectional Forwarding Detection (BFD) for MPLS Label Switched Paths (LSPs)"'>RFC5884</a>].  The latter provides connectivity verification between the
   endpoints of an LSP, and recommends establishing a separate BFD
   session for every path between the endpoints.

   The LSP traceroute procedures of [<a href="./rfc4379" title='"Detecting Multi-Protocol Label Switched (MPLS) Data Plane Failures"'>RFC4379</a>] allow an ingress LSR to
   obtain label ranges that can be used to send packets on every path to
   the egress LSR.  It works by having the ingress LSR sequentially ask
   the transit LSRs along a particular path to a given egress LSR to
   return a label range such that the inclusion of a label in that range
   in a packet will cause the replying transit LSR to send that packet
   out the egress interface for that path.  The ingress provides the
   label range returned by transit LSR N to transit LSR N + 1, which
   returns a label range that is less than or equal in span to the range
   provided to it.  This process iterates until the penultimate transit
   LSR replies to the ingress LSR with a label range that is acceptable
   to it and to all LSRs along path preceding it for forwarding a packet
   along the path.

   However, the LSP traceroute procedures do not specify where in the
   label stack the value from the label range is to be placed, whether
   deep packet inspection is allowed, and if so, which keys and key
   values are to be used.





<span class="grey">Kompella, et al.             Standards Track                   [Page 15]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-16"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   This memo updates LSP traceroute by specifying that the value from
   the label range is to be placed in the entropy label.  Deep packet
   inspection is thus not necessary, although an LSR may use it,
   provided it does so consistently, i.e., if the label range to go to a
   given downstream LSR is computed with deep packet inspection, then
   the data path should use the same approach and the same keys.

   In order to have a BFD session on a given path, a value from the
   label range for that path should be used as the EL value for BFD
   packets sent on that path.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/7.%20%20MPLS-TP%20and%20Entropy%20Labels"></a><a class="selflink" href="#section-7" id="section-7">7</a>.  MPLS-TP and Entropy Labels</span>

   Since the MPLS Transport Profile (MPLS-TP) does not use ECMP, entropy
   labels are not applicable to an MPLS-TP deployment.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/8.%20%20Entropy%20Labels%20in%20Various%20Scenarios"></a><a class="selflink" href="#section-8" id="section-8">8</a>.  Entropy Labels in Various Scenarios</span>

   This section describes the use of entropy labels in various
   scenarios.  The material in this section is illustrative and offers
   guidance to implementations, but it does not form a normative part of
   this specification.

   In the figures below, the following conventions are used to depict
   processing between X and Y.  Note that control plane signaling goes
   right to left, whereas data plane processing goes left to right.

   Protocols
   Y:        &lt;--- [L, E]                         Y signals L to X
       X ------------- Y
   Data Plane:
   X-Y:  &lt;L, ELI, EL&gt;                            Label Stack from X -&gt; Y
   Label Stack Operations:
   X:  +&lt;L, ELI, EL&gt;                             X pushes &lt;L, ELI, EL&gt;
   Y:                  -&lt;L, ELI, EL&gt;             Y pops &lt;L, ELI, EL&gt;

   This means that Y signals to X label L for an LDP tunnel.  E can be
   one of:

      0: meaning egress is NOT entropy label capable or

      1: meaning egress is entropy label capable

   The line with LS: shows the label stack on the wire.  Below that is
   the operation that each LSR does in the data plane, where + means
   push the following label stack, - means pop the following label
   stack, L~L' means swap L with L'.




<span class="grey">Kompella, et al.             Standards Track                   [Page 16]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-17"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/8.1.%20%20LDP%20Tunnel"></a><a class="selflink" href="#section-8.1" id="section-8.1">8.1</a>.  LDP Tunnel</span>

   The following figures illustrate several simple intra-AS LDP tunnels.
   The first diagram shows ultimate hop popping (UHP) with the ingress
   inserting an EL, the second UHP with no ELs, the third PHP with ELs,
   and finally, PHP with no ELs, but also with an application label AL
   (which could, for example, be a VPN label).

   Note that, in all the cases below, the MPLS application does not
   matter; it may be that X pushes some more labels (perhaps for a VPN
   or VPLS) below the ones shown, and Y pops them.

   A:        &lt;--- [TL4, 1]
   B:                     &lt;-- [TL3, 1]
   W:                           &lt;-- [TL2, 1]
   Y:                                        &lt;-- [TL0, 1]
       X --------------- A --------- B --- W ---------- Y
   Data Plane:
   X-A:   &lt;TL4, ELI, EL&gt;
   A-B:                     &lt;TL3,ELI,EL&gt;
   B-W:                                 &lt;TL2,ELI,EL&gt;
   W-Y:                                       &lt;TL0,ELI,EL&gt;
   Label Stack Operations:
   X:  +&lt;TL4, ELI, EL&gt;
   A:                    TL4~TL3
   B:                                TL3~TL2
   W:                                      TL2~TL0
   Y:                                                   -&lt;TL0, ELI, EL&gt;

                Figure 2: LDP with UHP; Ingress Inserts ELs





















<span class="grey">Kompella, et al.             Standards Track                   [Page 17]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-18"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   A:        &lt;--- [TL4, 1]
   B:                     &lt;-- [TL3, 1]
   W:                           &lt;-- [TL2, 1]
   Y:                                        &lt;-- [TL0, 1]
       X --------------- A --------- B --- W ---------- Y
   Data Plane:
   X-A:       &lt;TL4&gt;
   A-B:                      &lt;TL3&gt;
   B-W:                                 &lt;TL2&gt;
   W-Y:                                         &lt;TL0&gt;
   Label Stack Operations:
   X:  +&lt;TL4&gt;
   A:                    TL4~TL3
   B:                                TL3~TL2
   W:                                      TL2~TL0
   Y:                                                   -&lt;TL0&gt;

            Figure 3: LDP with UHP; Ingress Does Not Insert ELs

   Note that in Figure 3, above, the Egress Y is signaling it is EL-
   capable, but the Ingress X has chosen not to insert ELs.

   A:        &lt;--- [TL4, 1]
   B:                     &lt;-- [TL3, 1]
   W:                           &lt;-- [TL2, 1]
   Y:                                          &lt;-- [3, 1]
       X --------------- A --------- B --- W ---------- Y
   Data Plane:
   X-A:   &lt;TL4, ELI, EL&gt;
   A-B:                     &lt;TL3,ELI,EL&gt;
   B-W:                                 &lt;TL2,ELI,EL&gt;
   W-Y:                                       &lt;ELI,EL&gt;
   Label Stack Operations:
   X:  +&lt;TL4, ELI, EL&gt;
   A:                    TL4~TL3
   B:                                TL3~TL2
   W:                                      -TL2
   Y:                                                   -&lt;ELI, EL&gt;

                Figure 4: LDP with PHP; Ingress Inserts ELs











<span class="grey">Kompella, et al.             Standards Track                   [Page 18]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-19"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   A:        &lt;--- [TL4, 1]
   B:                     &lt;-- [TL3, 1]
   W:                           &lt;-- [TL2, 1]
   Y:                                          &lt;-- [3, 1]
   VPN:  &lt;------------------------------------------ [AL]
       X --------------- A --------- B --- W ---------- Y
   Data Plane:
   X-A:   &lt;TL4, AL&gt;
   A-B:                     &lt;TL3, AL&gt;
   B-W:                                 &lt;TL2, AL&gt;
   W-Y:                                       &lt;AL&gt;
   Label Stack Operations:
   X:  +&lt;TL4, AL&gt;
   A:                    TL4~TL3
   B:                                TL3~TL2
   W:                                      -TL2
   Y:                                                   -&lt;AL&gt;

         Figure 5: LDP with PHP + VPN; Ingress Does Not Insert ELs

   Note that in Figure 5, above, the Egress Y is signaling it is EL-
   capable, but the Ingress X has chosen not to insert ELs.

   A:        &lt;--- [TL4, 1]
   B:                        &lt;-- [TL3, 1]
   W:                              &lt;-- [TL2, 1]
   Y:                                             &lt;-- [3, 1]
   VPN:  &lt;--------------------------------------------- [AL]
       X --------------- A ------------ B --- W ---------- Y
   Data Plane:
   X-A:   &lt;TL4,ELI,EL,AL&gt;
   A-B:                     &lt;TL3,ELI,EL,AL&gt;
   B-W:                                    &lt;TL2,ELI,EL,AL&gt;
   W-Y:                                          &lt;ELI,EL,AL&gt;
   Label Stack Operations:
   X:  +&lt;TL4,ELI,EL,AL&gt;
   A:                    TL4~TL3
   B:                                   TL3~TL2
   W:                                         -TL2
   Y:                                                      -&lt;ELI,EL,AL&gt;

             Figure 6: LDP with PHP + VPN; Ingress Inserts ELs









<span class="grey">Kompella, et al.             Standards Track                   [Page 19]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-20"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/8.2.%20%20LDP%20over%20RSVP-TE"></a><a class="selflink" href="#section-8.2" id="section-8.2">8.2</a>.  LDP over RSVP-TE</span>

   Figure 7 illustrates "LDP over RSVP-TE" tunnels.  X and Y are the
   ingress and egress (respectively) of the LDP tunnel; A and W are the
   ingress and egress of the RSVP-TE tunnel.  It is assumed that both
   the LDP and RSVP-TE tunnels have PHP.

   LDP:       &lt;--- [L4, 1]  &lt;------- [L3, 1]  &lt;--- [3, 1]
   RSVP-TE:                &lt;-- [Rn, 0]
                                  &lt;-- [3, 0]
       X --------------- A --------- B --- W ---------- Y
   Data Plane:
   X-A:   &lt;L4, ELI, EL&gt;
   A-B:                     &lt;Rn,L3,ELI,EL&gt;
   B-W:                                 &lt;L3,ELI,EL&gt;
   W-Y:                                       &lt;ELI,EL&gt;
   Label Stack Operations:
   X:  +&lt;L4, ELI, EL&gt;
   A:                    &lt;L4~L3&gt;+Rn
   B:                                -Rn
   W:                                      -L3
   Y:                                                   -&lt;ELI, EL&gt;

          Figure 7: LDP with ELs over RSVP-TE Tunnels without ELs

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/8.3.%20%20MPLS%20Applications"></a><a class="selflink" href="#section-8.3" id="section-8.3">8.3</a>.  MPLS Applications</span>

   For each unicast tunnel starting at an ingress LSR X, X must remember
   whether the egress for that tunnel can process entropy labels.  X
   does not have to keep state per application running over that tunnel.
   However, an ingress PE can choose on a per-application basis whether
   or not to insert ELs.  For example, X may have an application for
   which it does not wish to use ECMP (e.g., circuit emulation) or for
   which it does not know which keys to use for load balancing (e.g.,
   Appletalk over a pseudowire).  In either of those cases, X may choose
   not to insert entropy labels but may choose to insert entropy labels
   for an IP VPN over the same tunnel.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/9.%20%20Security%20Considerations"></a><a class="selflink" href="#section-9" id="section-9">9</a>.  Security Considerations</span>

   This document describes advertisement of the capability to support
   receipt of entropy labels that an ingress LSR may insert in MPLS
   packets in order to allow transit LSRs to attain better load
   balancing across LAG and/or ECMP paths in the network.







<span class="grey">Kompella, et al.             Standards Track                   [Page 20]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-21"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   This document does not introduce new security vulnerabilities to LDP,
   BGP or RSVP-TE.  Please refer to the Security Considerations sections
   of these protocols ([<a href="./rfc5036" title='"LDP Specification"'>RFC5036</a>], [<a href="./rfc4271" title='"A Border Gateway Protocol 4 (BGP-4)"'>RFC4271</a>], and [<a href="./rfc3209" title='"RSVP-TE: Extensions to RSVP for LSP Tunnels"'>RFC3209</a>]) for security
   mechanisms applicable to each.

   Given that there is no end-user control over the values used for
   entropy labels, there is little risk of entropy label forgery, which
   could cause uneven load balancing in the network.  Note that if the
   EL value is calculated only based on packet headers, then a
   relatively efficient wiretapping interface could be added depending
   on the function used to generate the EL value.  An implementation may
   protect against this by adding some other input to the generation of
   the EL values that would make it harder to build a table of EL values
   to tap given knowledge of the keys from the packet.  For example, the
   ingress LSR could generate a random input to the EL generation
   process.  In practice, many ECMP hashing algorithms contain a random
   factor in any case so as to avoid polarization issues.

   If Entropy Label Capability is not signaled from an egress PE to an
   ingress PE, due to, for example, malicious configuration activity on
   the egress PE, then the PE will fall back to not using entropy labels
   for load balancing traffic over LAG or ECMP paths, which is, in
   general, no worse than the behavior observed in current production
   networks.  That said, it is recommended that operators monitor
   changes to PE configurations and, more importantly, the fairness of
   load distribution over LAG or ECMP paths.  If the fairness of load
   distribution over a set of paths changes that could indicate a
   misconfiguration, bug, or other non-optimal behavior on their PEs,
   and they should take corrective action.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/10.%20%20IANA%20Considerations"></a><a class="selflink" href="#section-10" id="section-10">10</a>.  IANA Considerations</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/10.1.%20%20Reserved%20Label%20for%20ELI"></a><a class="selflink" href="#section-10.1" id="section-10.1">10.1</a>.  Reserved Label for ELI</span>

   IANA has allocated a reserved label for the Entropy Label Indicator
   (ELI) from the "Multiprotocol Label Switching Architecture (MPLS)
   Label Values" registry.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/10.2.%20%20LDP%20Entropy%20Label%20Capability%20TLV"></a><a class="selflink" href="#section-10.2" id="section-10.2">10.2</a>.  LDP Entropy Label Capability TLV</span>

   IANA has allocated the value of 0x0206 from the IETF Consensus range
   (0x0001-0x07FF) in the "TLV Type Name Space" registry as the "Entropy
   Label Capability TLV".

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/10.3.%20%20BGP%20Entropy%20Label%20Capability%20Attribute"></a><a class="selflink" href="#section-10.3" id="section-10.3">10.3</a>.  BGP Entropy Label Capability Attribute</span>

   IANA has allocated the Path Attribute Type Code 28 from the "BGP Path
   Attributes" registry as the "BGP Entropy Label Capability Attribute".



<span class="grey">Kompella, et al.             Standards Track                   [Page 21]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-22"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/10.4.%20%20RSVP-TE%20Entropy%20Label%20Capability%20Flag"></a><a class="selflink" href="#section-10.4" id="section-10.4">10.4</a>.  RSVP-TE Entropy Label Capability Flag</span>

   IANA has allocated a new bit from the "Attribute Flags" sub-registry
   of the "Resource Reservation Protocol-Traffic Engineering (RSVP-TE)
   Parameters" registry.


   Bit | Name                     | Attribute  | Attribute  | RRO
   No  |                          | Flags Path | Flags Resv |
   ----+--------------------------+------------+------------+-----
    9   Entropy Label Capability       Yes          Yes       No

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/11.%20%20Acknowledgments"></a><a class="selflink" href="#section-11" id="section-11">11</a>.  Acknowledgments</span>

   We wish to thank Ulrich Drafz for his contributions, as well as the
   entire "hash label" team for their valuable comments and discussion.

   Sincere thanks to Nischal Sheth for his many suggestions and comments
   and for his careful reading of the document, especially with regard
   to data plane processing of entropy labels.

   Most of the work Kireeti Kompella did on this document was done while
   he was at Juniper Networks.  He has since moved to Contrail Systems.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/12.%20%20References"></a><a class="selflink" href="#section-12" id="section-12">12</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/12.1.%20%20Normative%20References"></a><a class="selflink" href="#section-12.1" id="section-12.1">12.1</a>.  Normative References</span>

   [<a id="ref-RFC2119">RFC2119</a>]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", <a href="https://www.rfc-editor.org/bcp/bcp14">BCP 14</a>, <a href="./rfc2119">RFC 2119</a>, March 1997.

   [<a id="ref-RFC3031">RFC3031</a>]  Rosen, E., Viswanathan, A., and R. Callon, "Multiprotocol
              Label Switching Architecture", <a href="./rfc3031">RFC 3031</a>, January 2001.

   [<a id="ref-RFC3032">RFC3032</a>]  Rosen, E., Tappan, D., Fedorkow, G., Rekhter, Y.,
              Farinacci, D., Li, T., and A. Conta, "MPLS Label Stack
              Encoding", <a href="./rfc3032">RFC 3032</a>, January 2001.

   [<a id="ref-RFC3107">RFC3107</a>]  Rekhter, Y. and E. Rosen, "Carrying Label Information in
              BGP-4", <a href="./rfc3107">RFC 3107</a>, May 2001.

   [<a id="ref-RFC3209">RFC3209</a>]  Awduche, D., Berger, L., Gan, D., Li, T., Srinivasan, V.,
              and G. Swallow, "RSVP-TE: Extensions to RSVP for LSP
              Tunnels", <a href="./rfc3209">RFC 3209</a>, December 2001.

   [<a id="ref-RFC5036">RFC5036</a>]  Andersson, L., Minei, I., and B. Thomas, "LDP
              Specification", <a href="./rfc5036">RFC 5036</a>, October 2007.




<span class="grey">Kompella, et al.             Standards Track                   [Page 22]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-23"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


   [<a id="ref-RFC5420">RFC5420</a>]  Farrel, A., Papadimitriou, D., Vasseur, JP., and A.
              Ayyangarps, "Encoding of Attributes for MPLS LSP
              Establishment Using Resource Reservation Protocol Traffic
              Engineering (RSVP-TE)", <a href="./rfc5420">RFC 5420</a>, February 2009.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/12.2.%20%20Informative%20References"></a><a class="selflink" href="#section-12.2" id="section-12.2">12.2</a>.  Informative References</span>

   [<a id="ref-RFC4201">RFC4201</a>]  Kompella, K., Rekhter, Y., and L. Berger, "Link Bundling
              in MPLS Traffic Engineering (TE)", <a href="./rfc4201">RFC 4201</a>, October 2005.

   [<a id="ref-RFC4271">RFC4271</a>]  Rekhter, Y., Li, T., and S. Hares, "A Border Gateway
              Protocol 4 (BGP-4)", <a href="./rfc4271">RFC 4271</a>, January 2006.

   [<a id="ref-RFC4379">RFC4379</a>]  Kompella, K. and G. Swallow, "Detecting Multi-Protocol
              Label Switched (MPLS) Data Plane Failures", <a href="./rfc4379">RFC 4379</a>,
              February 2006.

   [<a id="ref-RFC4447">RFC4447</a>]  Martini, L., Rosen, E., El-Aawar, N., Smith, T., and G.
              Heron, "Pseudowire Setup and Maintenance Using the Label
              Distribution Protocol (LDP)", <a href="./rfc4447">RFC 4447</a>, April 2006.

   [<a id="ref-RFC4875">RFC4875</a>]  Aggarwal, R., Papadimitriou, D., and S. Yasukawa,
              "Extensions to Resource Reservation Protocol - Traffic
              Engineering (RSVP-TE) for Point-to-Multipoint TE Label
              Switched Paths (LSPs)", <a href="./rfc4875">RFC 4875</a>, May 2007.

   [<a id="ref-RFC5884">RFC5884</a>]  Aggarwal, R., Kompella, K., Nadeau, T., and G. Swallow,
              "Bidirectional Forwarding Detection (BFD) for MPLS Label
              Switched Paths (LSPs)", <a href="./rfc5884">RFC 5884</a>, June 2010.

   [<a id="ref-RFC6388">RFC6388</a>]  Wijnands, IJ., Minei, I., Kompella, K., and B. Thomas,
              "Label Distribution Protocol Extensions for Point-to-
              Multipoint and Multipoint-to-Multipoint Label Switched
              Paths", <a href="./rfc6388">RFC 6388</a>, November 2011.

   [<a id="ref-RFC6391">RFC6391</a>]  Bryant, S., Filsfils, C., Drafz, U., Kompella, V., Regan,
              J., and S. Amante, "Flow-Aware Transport of Pseudowires
              over an MPLS Packet Switched Network", <a href="./rfc6391">RFC 6391</a>,
              November 2011.












<span class="grey">Kompella, et al.             Standards Track                   [Page 23]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-24"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/Appendix%20A.%20%20Applicability%20of%20LDP%20Entropy%20Label%20Capability%20TLV"></a><a class="selflink" href="#appendix-A" id="appendix-A">Appendix A</a>.  Applicability of LDP Entropy Label Capability TLV</span>

   In the case of unlabeled IPv4 (Internet) traffic, the best practice
   is for an egress LSR to propagate eBGP learned routes within a
   Service Provider's Autonomous System after resetting the BGP next-hop
   attribute to one of its loopback IP addresses.  That loopback IP
   address is injected into the Service Provider's IGP and,
   concurrently, a label assigned to it via LDP.  Thus, when an ingress
   LSR is performing a forwarding lookup for a BGP destination, it
   recursively resolves the associated next hop to a loopback IP address
   and associated LDP label of the egress LSR.

   Thus, in the context of unlabeled IPv4 traffic, the LDP Entropy Label
   Capability TLV will typically be applied only to the FEC for the
   loopback IP address of the egress LSR, and the egress LSR need not
   announce an Entropy Label Capability for the eBGP learned route.



































<span class="grey">Kompella, et al.             Standards Track                   [Page 24]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-25"></span>
<span class="grey"><a href="./rfc6790">RFC 6790</a>                   MPLS Entropy Labels             November 2012</span>


Authors' Addresses

   Kireeti Kompella
   Contrail Systems
   2350 Mission College Blvd.
   Santa Clara, CA  95054
   US

   EMail: kireeti.kompella@gmail.com


   John Drake
   Juniper Networks
   1194 N. Mathilda Ave.
   Sunnyvale, CA  94089
   US

   EMail: jdrake@juniper.net


   Shane Amante
   Level 3 Communications, Inc.
   1025 Eldorado Blvd
   Broomfield, CO  80021
   US

   EMail: shane@level3.net


   Wim Henderickx
   Alcatel-Lucent
   Copernicuslaan 50
   2018 Antwerp
   Belgium

   EMail: wim.henderickx@alcatel-lucent.com


   Lucy Yong
   Huawei USA
   5340 Legacy Dr.
   Plano, TX  75024
   US

   EMail: lucy.yong@huawei.com






Kompella, et al.             Standards Track                   [Page 25]
</pre>
</body></html>