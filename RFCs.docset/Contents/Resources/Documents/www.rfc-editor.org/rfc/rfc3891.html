<html><head></head><body><pre>Network Working Group                                            R. Mahy
Request for Comments: 3891                           Cisco Systems, Inc.
Category: Standards Track                                       B. Biggs
                                                                 R. Dean
                                                          September 2004


        <span class="h1">The Session Initiation Protocol (SIP) "Replaces" Header</span>

Status of this Memo

   This document specifies an Internet standards track protocol for the
   Internet community, and requests discussion and suggestions for
   improvements.  Please refer to the current edition of the "Internet
   Official Protocol Standards" (STD 1) for the standardization state
   and status of this protocol.  Distribution of this memo is unlimited.

Copyright Notice

   Copyright (C) The Internet Society (2004).

Abstract

   This document defines a new header for use with Session Initiation
   Protocol (SIP) multi-party applications and call control.  The
   Replaces header is used to logically replace an existing SIP dialog
   with a new SIP dialog.  This primitive can be used to enable a
   variety of features, for example: "Attended Transfer" and "Call
   Pickup".  Note that the definition of these example features is non-
   normative.





















<span class="grey">Mahy, et al.                Standards Track                     [Page 1]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-2"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


Table of Contents

   <a href="#section-1">1</a>.  Overview. . . . . . . . . . . . . . . . . . . . . . . . . . .   <a href="#page-2">2</a>
   <a href="#section-2">2</a>.  Conventions . . . . . . . . . . . . . . . . . . . . . . . . .   <a href="#page-4">4</a>
   <a href="#section-3">3</a>.  User Agent Server Behavior: Receiving a Replaces Header . . .   <a href="#page-4">4</a>
   <a href="#section-4">4</a>.  User Agent Client Behavior: Sending a Replaces Header . . . .   <a href="#page-6">6</a>
   <a href="#section-5">5</a>.  Proxy Behavior. . . . . . . . . . . . . . . . . . . . . . . .   <a href="#page-7">7</a>
   <a href="#section-6">6</a>.  Syntax. . . . . . . . . . . . . . . . . . . . . . . . . . . .   <a href="#page-7">7</a>
       <a href="#section-6.1">6.1</a>.  The Replaces Header . . . . . . . . . . . . . . . . . .   <a href="#page-7">7</a>
       <a href="#section-6.2">6.2</a>.  New Option Tag for Require and Supported Headers. . . .   <a href="#page-8">8</a>
   <a href="#section-7">7</a>.  Usage Examples. . . . . . . . . . . . . . . . . . . . . . . .   <a href="#page-9">9</a>
       <a href="#section-7.1">7.1</a>.  Replacing an Early Dialog at the Originator . . . . . .   <a href="#page-9">9</a>
   <a href="#section-8">8</a>.  Security Considerations . . . . . . . . . . . . . . . . . . .  <a href="#page-11">11</a>
   <a href="#section-9">9</a>.  IANA Considerations . . . . . . . . . . . . . . . . . . . . .  <a href="#page-13">13</a>
       <a href="#section-9.1">9.1</a>.  Registration of "Replaces" SIP Header . . . . . . . . .  <a href="#page-13">13</a>
       <a href="#section-9.2">9.2</a>.  Registration of "replaces" SIP Option-tag . . . . . . .  <a href="#page-13">13</a>
   <a href="#section-10">10</a>. Acknowledgments . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-13">13</a>
   <a href="#section-11">11</a>. References. . . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-13">13</a>
       <a href="#section-11.1">11.1</a>. Normative References. . . . . . . . . . . . . . . . . .  <a href="#page-13">13</a>
       <a href="#section-11.2">11.2</a>. Informative References. . . . . . . . . . . . . . . . .  <a href="#page-14">14</a>
   <a href="#section-12">12</a>. Authors' Addresses. . . . . . . . . . . . . . . . . . . . . .  <a href="#page-15">15</a>
   <a href="#section-13">13</a>. Full Copyright Statement. . . . . . . . . . . . . . . . . . .  <a href="#page-16">16</a>

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.%20%20Overview"></a><a class="selflink" href="#section-1" id="section-1">1</a>.  Overview</span>

   This document describes a SIP [<a href="#ref-1" title='"SIP: Session Initiation Protocol"'>1</a>] extension header field as part of
   the SIP multiparty applications architecture framework [<a href="#ref-10" title='"A Call Control and Multi-party usage framework for the Session Initiation Protocol (SIP)"'>10</a>].  The
   Replaces header is used to logically replace an existing SIP dialog
   with a new SIP dialog.  This is especially useful in peer-to-peer
   call control environments.

   One use of the "Replaces" header is to replace one participant with
   another in a multimedia conversation.  While this functionality is
   already available using 3rd party call control [<a href="#ref-11" title='"Best Current Practices for Third Party Call Control (3pcc) in the Session Initiation Protocol (SIP)"'>11</a>] style call
   control, the 3pcc model requires a central point of control which may
   not be desirable in many environments.  As such, a method of
   performing these same call control primitives in a distributed,
   peer-to-peer fashion is very desirable.

   Use of a new INVITE with a new header for dialog matching was chosen
   over making implicit associations in an incoming INVITE based on
   call-id or other fields for the following reasons:

   o  An INVITE already has the correct semantics for a new call

   o  Using an explicit Replaces header in a new request makes the
      intent of the request obvious.




<span class="grey">Mahy, et al.                Standards Track                     [Page 2]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-3"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


   o  A unique call-id may be given to the replacement call.  This
      avoids dialog matching problems in any of the related User Agents.

   o  There are no adverse effects if the header is unsupported.

   The Replaces header enables services such as attended call transfer,
   retrieve from park, and transition from locally mixed conferences to
   two party calls in a distributed peer-to-peer way.  This list of
   services is not exhaustive.  Although the Replaces header is
   frequently used in combination with the REFER [<a href="#ref-8" title='"The Session Initiation Protocol (SIP) Refer Method"'>8</a>] method as used in a
   Transfer [<a href="#ref-12" title='"Session Initiation Protocol Call Control - Transfer"'>12</a>], they may be used independently.

   For example, Alice is talking to Bob from phone1.  She transfers Bob
   to a Parking Place while she goes to the lab.  When she gets there
   she retrieves the "parked" call from phone2 by sending an INVITE with
   a Replaces header field to Bob with the dialog information Bob shared
   with the Parking Place.  Alice got this information using some out of
   band mechanism.  Perhaps she subscribed to this information from the
   Parking Place (using the session dialog package [<a href="#ref-13" title='"An INVITE Initiated Dialog Event Package for the Session Initiation Protocol (SIP)"'>13</a>]), or went to a
   website and clicked on a URI.  A short call flow for this example
   follows.  (Via and Max-Forwards headers are omitted for clarity.)

        Alice          Alice                             Parking
        phone1         phone2            Bob               Place
        |               |                 |                   |
        |&lt;===============================&gt;|                   |
        |               |                 |                   |
        |        Alice transfers Bob to Parking Place         |
        |               |                 |                   |
        |------------REFER/200-----------&gt;|    *1    *2       |
        |&lt;--NOTIFY/200 (trying)-----------|--INVITE/200/ACK--&gt;|
        |&lt;--NOTIFY/200 (success)----------|&lt;=================&gt;|
        |------------BYE/200-------------&gt;|                   |
        |               |                 |                   |
        |               |                 |                   |
        |  Alice later retrieves call from another phone      |
        |               |                 |                   |
        |            *3 |-INV w/Replaces-&gt;|                   |
        |               |&lt;--200-----------|                   |
        |               |---ACK----------&gt;|----BYE/200-------&gt;|
        |               |&lt;===============&gt;|                   |
        |               |                 |                   |









<span class="grey">Mahy, et al.                Standards Track                     [Page 3]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-4"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


   Message *1: Bob-&gt; Parking Place

   INVITE sip:parkingplace@example.org SIP/2.0
   To: &lt;sip:parkingplace@example.org&gt;
   From: &lt;sip:bob@example.org&gt;;tag=7743
   Call-ID: 425928@bobster.example.org
   CSeq: 1 INVITE
   Contact: &lt;sip:bob@bobster.example.org&gt;
   Referred-By: &lt;sip:alice@phone1.example.org&gt;

   Message *2: Parking Place -&gt; Bob

   SIP/2.0 200 OK
   To: &lt;sip:parkingplace@example.org&gt;;tag=6472
   From: &lt;sip:bob@example.org&gt;;tag=7743
   Call-ID: 425928@bobster.example.org
   CSeq: 1 INVITE
   Contact: &lt;sip:parkplace@monopoly.example.org&gt;

   Message *3: Alice@phone2 -&gt; Bob

   INVITE sip:bob@bobster.example.org
   To: &lt;sip:bob@example.org&gt;
   From: &lt;sip:alice@phone2.example.org&gt;;tag=8983
   Call-ID: 09870@phone2.example.org
   CSeq: 1 INVITE
   Contact: &lt;sip:alice@phone2.example.org&gt;
   Require: replaces
   Replaces: 425928@bobster.example.org;to-tag=7743;from-tag=6472

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/2.%20%20Conventions"></a><a class="selflink" href="#section-2" id="section-2">2</a>.  Conventions</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED",  "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <a href="https://www.rfc-editor.org/bcp/bcp14">BCP 14</a>, <a href="./rfc2119">RFC 2119</a> [<a href="#ref-2" title='"Key words for use in RFCs to Indicate Requirement Levels"'>2</a>].

   This document refers frequently to the terms "confirmed dialog" and
   "early dialog".  These are defined in <a href="#section-12">Section 12</a> of SIP [<a href="#ref-1" title='"SIP: Session Initiation Protocol"'>1</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.%20%20User%20Agent%20Server%20Behavior%3A%20Receiving%20a%20Replaces%20Header"></a><a class="selflink" href="#section-3" id="section-3">3</a>.  User Agent Server Behavior: Receiving a Replaces Header</span>

   The Replaces header contains information used to match an existing
   SIP dialog (call-id, to-tag, and from-tag).  Upon receiving an INVITE
   with a Replaces header, the User Agent (UA) attempts to match this
   information with a confirmed or early dialog.  The User Agent Server
   (UAS) matches the to-tag and from-tag parameters as if they were tags





<span class="grey">Mahy, et al.                Standards Track                     [Page 4]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-5"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


   present in an incoming request.  In other words, the to-tag parameter
   is compared to the local tag, and the from-tag parameter is compared
   to the remote tag.

   If more than one Replaces header field is present in an INVITE, or if
   a Replaces header field is present in a request other than INVITE,
   the UAS MUST reject the request with a 400 Bad Request response.

   The Replaces header has specific call control semantics.  If both a
   Replaces header field and another header field with contradictory
   semantics are present in a request, the request MUST be rejected with
   a 400 "Bad Request" response.

   If the Replaces header field matches more than one dialog, the UA
   MUST act as if no match is found.

   If no match is found, the UAS rejects the INVITE and returns a 481
   Call/Transaction Does Not Exist response.  Likewise, if the Replaces
   header field matches a dialog which was not created with an INVITE,
   the UAS MUST reject the request with a 481 response.

   If the Replaces header field matches a dialog which has already
   terminated, the UA SHOULD decline the request with a 603 Declined
   response.  (If the matched invitation was just terminated, the
   replacement request should fail as well.  Declining the request with
   a 600-class response prevents an irritating race-condition where the
   UA rings or alerts for a replacement call which is not wanted.)

   If the Replaces header field matches an active dialog, the UA MUST
   verify that the initiator of the new INVITE is authorized to replace
   the matched dialog.  If the initiator of the new INVITE has been
   successfully authenticated as equivalent to the user who is being
   replaced, then the replacement is authorized.  For example, if the
   user being replaced and the initiator of the replacement dialog share
   the same credentials for Digest authentication [<a href="#ref-6" title='"HTTP Authentication: Basic and Digest Access Authentication"'>6</a>], or they sign the
   replacement request with S/MIME [<a href="#ref-7" title='"Secure/Multipurpose Internet Mail Extensions (S/MIME) Version 3.1 Message Specification"'>7</a>] with the same private key and
   present the (same) corresponding certificate used in the original
   dialog, then the replacement is authorized.

   Alternatively, the Referred-By mechanism [<a href="#ref-4" title='"The Session Initiation Protocol (SIP) Referred-By Mechanism"'>4</a>] defines a mechanism that
   the UAS can use to verify that a replacement request was sent on
   behalf of the other participant in the matched dialog (in this case,
   triggered by a REFER request).  If the replacement request contains a
   Referred-By header that corresponds to the user being replaced, the
   UA SHOULD treat the replacement as if the replacement was authorized
   by the replaced party.  The Referred-By header SHOULD reference a
   corresponding, valid Refererred-By Authenticated Identity Body [<a href="#ref-5" title='"The Session Initiation Protocol (SIP) Authenticated Identity Body (AIB) Format"'>5</a>].




<span class="grey">Mahy, et al.                Standards Track                     [Page 5]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-6"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


   The UA MAY apply other local policy to authorize the remainder of the
   request.  In other words, the UAS may apply a different policy to the
   replacement dialog than was applied to the replaced dialog.

   In addition, the UA MAY use other authorization mechanisms defined
   for this purpose in standards track extensions.  Extensions could
   define other mechanisms for transitively asserting authorization of a
   replacement.

   If authorization is successful, the UA attempts to accept the new
   INVITE, reassign the user interface and other resources of the
   matched dialog to the new INVITE, and shut down the replaced dialog.
   If the UA cannot accept the new INVITE (for example: it cannot
   establish required QoS or keying, or it has incompatible media), the
   UA MUST return an appropriate error response and MUST leave the
   matched dialog unchanged.

   If the Replaces header field matches a confirmed dialog, it checks
   for the presence of the "early-only" flag in the Replaces header
   field.  (This flag allows the UAC to prevent a potentially
   undesirable race condition described in <a href="#section-7.1">Section 7.1</a>.) If the flag is
   present, the UA rejects the request with a 486 Busy response.
   Otherwise, it accepts the new INVITE by sending a 200-class response,
   and shuts down the replaced dialog by sending a BYE.  If the Replaces
   header field matches an early dialog that was initiated by the UA, it
   accepts the new INVITE by sending a 200-class response, and shuts
   down the replaced dialog by sending a CANCEL.

   If the Replaces header field matches an early dialog that was not
   initiated by this UA, it returns a 481 (Call/Transaction Does Not
   Exist) response to the new INVITE, and leaves the matched dialog
   unchanged.  Note that since Replaces matches only a single dialog,
   the replacement dialog will not be retargeted according to the same
   forking logic as the original request which created the early dialog.

   (Currently, no use cases have been identified for replacing just a
   single dialog in this circumstance.)

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.%20%20User%20Agent%20Client%20Behavior%3A%20Sending%20a%20Replaces%20Header"></a><a class="selflink" href="#section-4" id="section-4">4</a>.  User Agent Client Behavior: Sending a Replaces Header</span>

   A User Agent that wishes to replace a single existing early or
   confirmed dialog with a new dialog of its own, MAY send the target
   User Agent an INVITE request containing a Replaces header field.  The
   User Agent Client (UAC) places the Call-ID, to-tag, and from-tag
   information for the target dialog in a single Replaces header field
   and sends the new INVITE to the target.  If the user agent only
   wishes to replace an early dialog (as in the Call Pickup example in
   <a href="#section-7.1">Section 7.1</a>), the UAC MAY also include the "early-only" parameter in



<span class="grey">Mahy, et al.                Standards Track                     [Page 6]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-7"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


   the Replaces header field.  A UAC MUST NOT send an INVITE with a
   Replaces header field that attempts to replace an early dialog which
   was not originated by the target of the INVITE with a Replaces header
   field.

   Note that use of this mechanism does not provide a way to match
   multiple dialogs, nor does it provide a way to match an entire call,
   an entire transaction, or to follow a chain of proxy forking logic.
   For example, if Alice replaces Cathy in an early dialog with Bob, but
   Bob does not answer, Alice's replacement request will not match other
   dialogs to which Bob's UA redirects, nor other branches to which his
   proxy forwards.  Although this specification takes reasonable
   precautions to prevent unexpected behavior in the face of forking,
   implementations SHOULD only address replacement requests (i.e., set
   the Request-URI of the replacement request) to the SIP Contact URI of
   the target.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.%20%20Proxy%20behavior"></a><a class="selflink" href="#section-5" id="section-5">5</a>.  Proxy behavior</span>

   Proxy Servers do not require any new behavior to support this
   extension.  They simply pass the Replaces header field transparently
   as described in the SIP specification.

   Note that it is possible for a proxy (especially when forking based
   on some application layer logic, such as caller screening or time-
   of-day routing) to forward an INVITE request containing a Replaces
   header field to a completely orthogonal set of Contacts other than
   the original request it was intended to replace.  In this case, the
   INVITE request with the Replaces header field will fail.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/6.%20%20Syntax"></a><a class="selflink" href="#section-6" id="section-6">6</a>.  Syntax</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/6.1.%20%20The%20Replaces%20Header"></a><a class="selflink" href="#section-6.1" id="section-6.1">6.1</a>.  The Replaces Header</span>

   The Replaces header field indicates that a single dialog identified
   by the header field is to be shut down and logically replaced by the
   incoming INVITE in which it is contained.  It is a request header
   only, and defined only for INVITE requests.  The Replaces header
   field MAY be encrypted as part of end-to-end encryption.  Only a
   single Replaces header field value may be present in a SIP request.

   This document adds the following entry to Table 2 of [<a href="#ref-1" title='"SIP: Session Initiation Protocol"'>1</a>].  Additions
   to this table are also provided for extension methods defined at the
   time of publication of this document.  This is provided as a courtesy
   to the reader and is not normative in any way.  MESSAGE, SUBSCRIBE
   and NOTIFY, REFER, INFO, UPDATE, PRACK, and PUBLISH are defined
   respectively in [<a href="#ref-15" title='"Session Initiation Protocol (SIP) Extension for Instant Messaging"'>15</a>], [<a href="#ref-16" title='"Session Initiation Protocol (SIP)-Specific Event Notification"'>16</a>], [<a href="#ref-8" title='"The Session Initiation Protocol (SIP) Refer Method"'>8</a>], [<a href="#ref-17" title='"The SIP INFO Method"'>17</a>], [<a href="#ref-18" title='"The Session Initiation Protocol (SIP) UPDATE Method"'>18</a>], [<a href="#ref-19" title='"Reliability of Provisional Responses in Session Initiation Protocol (SIP)"'>19</a>], and [<a href="#ref-20" title='"SIMPLE Presence Publication Mechanism"'>20</a>].




<span class="grey">Mahy, et al.                Standards Track                     [Page 7]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-8"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


      Header field    where   proxy   ACK  BYE  CAN  INV  OPT  REG  MSG
      ------------    -----   -----   ---  ---  ---  ---  ---  ---  ---
      Replaces          R              -    -    -    o    -    -    -


                                      SUB  NOT  REF  INF  UPD  PRA  PUB
                                      ---  ---  ---  ---  ---  ---  ---
      Replaces          R              -    -    -    -    -    -    -

   The following syntax specification uses the augmented Backus-Naur
   Form (BNF) as described in <a href="./rfc2234">RFC 2234</a> [<a href="#ref-3" title='"Augmented BNF for Syntax Specifications: ABNF"'>3</a>].  The syntax below relies on
   a number of productions from SIP [<a href="#ref-1" title='"SIP: Session Initiation Protocol"'>1</a>].

      Replaces        = "Replaces" HCOLON callid *(SEMI replaces-param)
      replaces-param  = to-tag / from-tag / early-flag / generic-param
      to-tag          = "to-tag" EQUAL token
      from-tag        = "from-tag" EQUAL token
      early-flag      = "early-only"

   A Replaces header field MUST contain exactly one to-tag and exactly
   one from-tag, as they are required for unique dialog matching.  For
   compatibility with dialogs initiated by <a href="./rfc2543">RFC 2543</a> [<a href="#ref-9" title='"SIP: Session Initiation Protocol"'>9</a>] compliant UAs, a
   tag of zero matches both tags of zero and null.  A Replaces header
   field MAY contain the early-flag.

   Examples:

      Replaces: 98732@sip.example.com
                ;from-tag=r33th4x0r
                ;to-tag=ff87ff

      Replaces: 12adf2f34456gs5;to-tag=12345;from-tag=54321;early-only

      Replaces: 87134@171.161.34.23;to-tag=24796;from-tag=0

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/6.2.%20%20New%20Option%20Tag%20for%20Require%20and%20Supported%20Headers"></a><a class="selflink" href="#section-6.2" id="section-6.2">6.2</a>.  New Option Tag for Require and Supported Headers</span>

   This specification defines a new Require/Supported header option tag
   "replaces".  UAs which support the Replaces header MUST include the
   "replaces" option tag in a Supported header field.  UAs that want
   explicit failure notification if Replaces is not supported MAY
   include the "replaces" option in a Require header field.

   Example:

      Require: replaces, 100rel





<span class="grey">Mahy, et al.                Standards Track                     [Page 8]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-9"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/7.%20%20Usage%20Examples"></a><a class="selflink" href="#section-7" id="section-7">7</a>.  Usage Examples</span>

   The following non-normative examples are not intended to enumerate
   all the possibilities for the usage of this extension, but rather to
   provide examples or ideas only.  For more examples, please see SIP
   Service Examples [<a href="#ref-14" title='"Session Initiation Protocol Service Examples"'>14</a>].  Via and Max-Forwards headers are omitted for
   clarity and brevity.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/7.1.%20%20Replacing%20an%20Early%20Dialog%20at%20the%20Originator"></a><a class="selflink" href="#section-7.1" id="section-7.1">7.1</a>.  Replacing an Early Dialog at the Originator</span>

   In this example, Bob just arrived in the lab and hasn't registered
   there yet.  He hears his desk phone ring.  He quickly logs into a
   software UA on a nearby computer.  Among other things, the software
   UA has access to the dialog state of his desk phone.  When it notices
   that his phone is ringing, it offers him the choice of taking the
   call there.  The software UA sends an INVITE with Replaces to Alice.
   When Alice's UA receives this new INVITE, it CANCELs her original
   INVITE and connects Alice to Bob.

                              Bob                      Bob
       Alice                  desk                     lab
        |                       |                        |
    *1  |-----INVITE-----------&gt;|                        |
    *2  |&lt;----180---------------|  Bob hears desk phone  |
        |                       |  ringing from lab but  |
        |                       |  isn't REGISTERed yet  |
        |                       |                        |
        |                       |&lt;--fetch dialog state --|
        |                       |---response -----------&gt;|
   *3/4 |&lt;-----INVITE with Replaces/200/ACK--------------|
   *5/6 |------CANCEL/200------&gt;|                        |
   *7   |&lt;-----487--------------|                        |
        |------ACK-------------&gt;|                        |
        |                       |                        |
        |                       |                        |

   Message *1: Alice -&gt; Bob's desk phone

   INVITE sip:bob@example.org SIP/2.0
   To: &lt;sip:bob@example.org&gt;
   From: &lt;sip:alice@example.org&gt;;tag=7743
   Call-ID: 425928@phone.example.org
   CSeq: 1 INVITE
   Contact: &lt;sip:alice@phone.example.org&gt;







<span class="grey">Mahy, et al.                Standards Track                     [Page 9]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-10"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


   Message *2: Bob's desk phone -&gt; Alice

   SIP/2.0 180 Ringing
   To: &lt;sip:bob@example.org&gt;;tag=6472
   From: &lt;sip:alice@example.org&gt;;tag=7743
   Call-ID: 425928@phone.example.org
   CSeq: 1 INVITE
   Contact: &lt;sip:bob@bobster.example.org&gt;

   Message *3: Bob in lab -&gt; Alice

   INVITE sip:alice@phone.example.org
   To: &lt;sip:alice@example.org&gt;
   From: &lt;sip:bob@example.org&gt;;tag=8983
   Call-ID: 09870@labpc.example.org
   CSeq: 1 INVITE
   Contact: &lt;sip:bob@labpc.example.org&gt;
   Replaces: 425928@phone.example.org
    ;to-tag=7743;from-tag=6472;early-only

   Message *4: Alice -&gt; Bob in lab

   SIP/2.0 200 OK
   To: &lt;sip:alice@example.org&gt;;tag=9232
   From: &lt;sip:bob@example.org&gt;;tag=8983
   Call-ID: 09870@labpc.example.org
   CSeq: 1 INVITE
   Contact: &lt;sip:alice@phone.example.org&gt;

   Message *5: Alice -&gt; Bob's desk

   CANCEL sip:bob@example.org SIP/2.0
   To: &lt;sip:bob@example.org&gt;
   From: &lt;sip:alice@example.org&gt;;tag=7743
   Call-ID: 425928@phone.example.org
   CSeq: 1 CANCEL
   Contact: &lt;sip:alice@phone.example.org&gt;

   Message *6: Bob's desk -&gt; Alice

   SIP/2.0 200 OK
   To: &lt;sip:bob@example.org&gt;
   From: &lt;sip:alice@example.org&gt;;tag=7743
   Call-ID: 425928@phone.example.org
   CSeq: 1 CANCEL
   Contact: &lt;sip:bob@bobster.example.org&gt;





<span class="grey">Mahy, et al.                Standards Track                    [Page 10]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-11"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


   Message *7: Bob's desk -&gt; Alice

   SIP/2.0 487 Request Terminated
   To: &lt;sip:bob@example.org&gt;;tag=6472
   From: &lt;sip:alice@example.org&gt;;tag=7743
   Call-ID: 425928@phone.example.org
   CSeq: 1 INVITE

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/8.%20%20Security%20Considerations"></a><a class="selflink" href="#section-8" id="section-8">8</a>.  Security Considerations</span>

   The extension specified in this document significantly changes the
   relative security of SIP devices.  Currently in SIP, even if an
   eavesdropper learns the Call-ID, To, and From headers of a dialog,
   they cannot easily modify or destroy that dialog if Digest
   authentication or end-to-end message integrity are used.

   This extension can be used to disconnect participants or replace
   participants in a multimedia conversation.  As such, invitations with
   the Replaces header MUST only be accepted if the peer requesting
   replacement has been properly authenticated using a standard SIP
   mechanism (Digest or S/MIME), and authorized to request a replacement
   of the target dialog.  All SIP implementations are already required
   to support Digest Authentication.  In addition, implementations which
   support the Replaces header SHOULD also implement the Referred-By
   mechanism.

   How a User Agent determines which requests are legitimately
   authorized to make dialog replacements is non-trivial and depends on
   a considerable amount of local policy configuration.  In general,
   there are four cases when an authorization for a replacement is
   reasonable or warranted.

   1. Replacement made by a party considered equivalent to the replaced
      party

   2. Replacement made on behalf of the replaced party (perhaps
      transitively)

   3. Replacement made by a former participant

   4. Replacement made by a specifically authorized party

   Starting with #1 for example, if an executive and an assistant both
   receive requests for a shared address-of-record, if so configured,
   either should be able to replace dialogs of the other for the shared
   identity.  Both could even share the same keying material (Digest or
   S/MIME), or one could hold an authorization document signed by the




<span class="grey">Mahy, et al.                Standards Track                    [Page 11]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-12"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


   other expressing this relationship.  Likewise, in a call center
   environment, each call center agent could possess credentials to
   which supervisors also have access.

   The most common use case of a replacement is on the request of the
   replaced participant (who no longer wants to be involved).  This is
   the case in many features, such as completing an Attended Transfer
   and converting a 3-way call to a point-to-point call.  Such
   replacements are typically triggered by a REFER [<a href="#ref-8" title='"The Session Initiation Protocol (SIP) Refer Method"'>8</a>] request from the
   replaced participant.  The Referred-By [<a href="#ref-4" title='"The Session Initiation Protocol (SIP) Referred-By Mechanism"'>4</a>] mechanism defines one way
   to identify the apparent original requester and can point to a SIP
   Authenticated Identity Body [<a href="#ref-5" title='"The Session Initiation Protocol (SIP) Authenticated Identity Body (AIB) Format"'>5</a>] (an S/MIME-based signed assertion) to
   secure this information.

   In the example in <a href="#section-1">section 1</a>, Alice sends an INVITE with Replaces to
   Bob.  Alice was a former participant in the conversation and had a
   previous dialog relationship with Bob.  Alice can use the same Digest
   or S/MIME credentials she used to authenticate with Bob during the
   original call to prove that she was a former participant.  Note that
   this justification for replacing calls is more dangerous than the
   others, and in most cases is another way to authorize that the
   replacing participant is available.  Implementations SHOULD NOT rely
   on this method as an authorization mechanism.

   The last scenario is the easiest to secure but the least likely to be
   useful in practice.  It is unlikely that an arbitrary host in the
   Internet is aware of any special authorization relationship between
   the replaced and the replacing parties.  However, this use case may
   be useful in some environments.  Since this usage does not
   effectively degrade the security of the solution, it is still
   allowed.

   Some mechanisms for obtaining the dialog information needed by the
   Replaces header (Call-ID, to-tag, and from-tag) include URIs on a web
   page, subscriptions to an appropriate event package, and
   notifications after a REFER request.  Since manipulating this dialog
   information could cause User Agents to replace the wrong dialog, use
   of message integrity protection for this information is STRONGLY
   RECOMMENDED.  Use of end-to-end security mechanisms to encrypt this
   information is also RECOMMENDED.

   This extension was designed to take advantage of future signature or
   authorization schemes defined in standards track extensions.  In
   general, call control features benefit considerably from such work.







<span class="grey">Mahy, et al.                Standards Track                    [Page 12]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-13"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/9.%20%20IANA%20Considerations"></a><a class="selflink" href="#section-9" id="section-9">9</a>.  IANA Considerations</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/9.1.%20%20Registration%20of%20%22Replaces%22%20SIP%20header"></a><a class="selflink" href="#section-9.1" id="section-9.1">9.1</a>.  Registration of "Replaces" SIP header</span>

   Name of Header:          Replaces

   Short form:              none

   Normative description:   <a href="#section-6.1">section 6.1</a> of this document

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/9.2.%20%20Registration%20of%20%22replaces%22%20SIP%20Option-tag"></a><a class="selflink" href="#section-9.2" id="section-9.2">9.2</a>.  Registration of "replaces" SIP Option-tag</span>

   Name of option:          replaces

   Description:             Support for the SIP Replaces header

   SIP headers defined:     Replaces

   Normative description:   This document

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/10.%20%20Acknowledgments"></a><a class="selflink" href="#section-10" id="section-10">10</a>.  Acknowledgments</span>

   Thanks to Robert Sparks, Alan Johnston, Dan Petrie, Ben Campbell, and
   many other members of the SIP WG for their continued support of the
   cause of distributed call control in SIP.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/11.%20%20References"></a><a class="selflink" href="#section-11" id="section-11">11</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/11.1.%20%20Normative%20References"></a><a class="selflink" href="#section-11.1" id="section-11.1">11.1</a>.  Normative References</span>

   [<a id="ref-1">1</a>]  Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A.,
        Peterson, J., Sparks, R., Handley, M., and E. Schooler, "SIP:
        Session Initiation Protocol", <a href="./rfc3261">RFC 3261</a>, June 2002.

   [<a id="ref-2">2</a>]  Bradner, S., "Key words for use in RFCs to Indicate Requirement
        Levels", <a href="https://www.rfc-editor.org/bcp/bcp14">BCP 14</a>, <a href="./rfc2119">RFC 2119</a>, March 1997.

   [<a id="ref-3">3</a>]  Crocker, D. and P. Overell, "Augmented BNF for Syntax
        Specifications: ABNF", <a href="./rfc2234">RFC 2234</a>, November 1997.

   [<a id="ref-4">4</a>]  Sparks, R., "The Session Initiation Protocol (SIP) Referred-By
        Mechanism", <a href="./rfc3892">RFC 3892</a>, September 2004.

   [<a id="ref-5">5</a>]  Peterson, J., "The Session Initiation Protocol (SIP)
        Authenticated Identity Body (AIB) Format", <a href="./rfc3893">RFC 3893</a>, September
        2004.





<span class="grey">Mahy, et al.                Standards Track                    [Page 13]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-14"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


   [<a id="ref-6">6</a>]  Franks, J., Hallam-Baker, P., Hostetler, J., Lawrence, S.,
        Leach, P., Luotonen, A., and L. Stewart, "HTTP Authentication:
        Basic and Digest Access Authentication", <a href="./rfc2617">RFC 2617</a>, June 1999.

   [<a id="ref-7">7</a>]  Ramsdell, B., "Secure/Multipurpose Internet Mail Extensions
        (S/MIME) Version 3.1 Message Specification", <a href="./rfc3851">RFC 3851</a>, July
        2004.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/11.2.%20%20Informative%20References"></a><a class="selflink" href="#section-11.2" id="section-11.2">11.2</a>.  Informative References</span>

   [<a id="ref-8">8</a>]  Sparks, R., "The Session Initiation Protocol (SIP) Refer
        Method", <a href="./rfc3515">RFC 3515</a>, April 2003.

   [<a id="ref-9">9</a>]  Handley, M., Schulzrinne, H., Schooler, E., and J. Rosenberg,
        "SIP: Session Initiation Protocol", <a href="./rfc2543">RFC 2543</a>, March 1999.

   [<a id="ref-10">10</a>] Mahy, R., "A Call Control and Multi-party usage framework for
        the Session Initiation Protocol (SIP)", Work in Progress, March
        2003.

   [<a id="ref-11">11</a>] Rosenberg, J., Peterson, J., Schulzrinne, H., and G. Camarillo,
        "Best Current Practices for Third Party Call Control (3pcc) in
        the Session Initiation Protocol (SIP)", <a href="https://www.rfc-editor.org/bcp/bcp85">BCP 85</a>, <a href="./rfc3725">RFC 3725</a>, April
        2004.

   [<a id="ref-12">12</a>] Sparks, R. and A. Johnston, "Session Initiation Protocol Call
        Control - Transfer", Work in Progress, February 2003.

   [<a id="ref-13">13</a>] Rosenberg, J. and H. Schulzrinne, "An INVITE Initiated Dialog
        Event Package for the Session Initiation Protocol (SIP)", Work
        in Progress, March 2003.

   [<a id="ref-14">14</a>] Johnston, A. and S. Donovan, "Session Initiation Protocol
        Service Examples", Work in Progress, March 2003.

   [<a id="ref-15">15</a>] Campbell, B., Rosenberg, J., Schulzrinne, H., Huitema, C., and
        D. Gurle, "Session Initiation Protocol (SIP) Extension for
        Instant Messaging", <a href="./rfc3428">RFC 3428</a>, December 2002.

   [<a id="ref-16">16</a>] Roach, A., "Session Initiation Protocol (SIP)-Specific Event
        Notification", <a href="./rfc3265">RFC 3265</a>, June 2002.

   [<a id="ref-17">17</a>] Donovan, S., "The SIP INFO Method", <a href="./rfc2976">RFC 2976</a>, October 2000.

   [<a id="ref-18">18</a>] Rosenberg, J., "The Session Initiation Protocol (SIP) UPDATE
        Method", <a href="./rfc3311">RFC 3311</a>, October 2002.





<span class="grey">Mahy, et al.                Standards Track                    [Page 14]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-15"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


   [<a id="ref-19">19</a>] Rosenberg, J. and H. Schulzrinne, "Reliability of Provisional
        Responses in Session Initiation Protocol (SIP)", <a href="./rfc3262">RFC 3262</a>, June
        2002.

   [<a id="ref-20">20</a>] Campbell, B., <a href="https://www.google.com/search?sitesearch=datatracker.ietf.org%2Fdoc%2Fhtml%2F&amp;q=inurl:draft-+%22SIMPLE+Presence+Publication+Mechanism%22" style="text-decoration: none">"SIMPLE Presence Publication Mechanism"</a>, Work in
        Progress, February 2003.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/12.%20%20Authors%27%20Addresses"></a><a class="selflink" href="#section-12" id="section-12">12</a>.  Authors' Addresses</span>

   Rohan Mahy
   Cisco Systems, Inc.
   5617 Scotts Valley Dr
   Scotts Valley, CA  95066
   USA

   EMail: rohan@cisco.com


   Billy Biggs

   EMail: bbiggs@dumbterm.net


   Rick Dean

   EMail: rfc@fdd.com

























<span class="grey">Mahy, et al.                Standards Track                    [Page 15]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-16"></span>
<span class="grey"><a href="./rfc3891">RFC 3891</a>               The SIP "Replaces" Header          September 2004</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/13.%20%20Full%20Copyright%20Statement"></a><a class="selflink" href="#section-13" id="section-13">13</a>.  Full Copyright Statement</span>

   Copyright (C) The Internet Society (2004).

   This document is subject to the rights, licenses and restrictions
   contained in <a href="https://www.rfc-editor.org/bcp/bcp78">BCP 78</a>, and except as set forth therein, the authors
   retain all their rights.

   This document and the information contained herein are provided on an
   "AS IS" basis and THE CONTRIBUTOR, THE ORGANIZATION HE/S HE
   REPRESENTS OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY AND THE
   INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF
   THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED
   WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.

Intellectual Property

   The IETF takes no position regarding the validity or scope of any
   Intellectual Property Rights or other rights that might be claimed to
   pertain to the implementation or use of the technology described in
   this document or the extent to which any license under such rights
   might or might not be available; nor does it represent that it has
   made any independent effort to identify any such rights.  Information
   on the IETF's procedures with respect to rights in IETF Documents can
   be found in <a href="https://www.rfc-editor.org/bcp/bcp78">BCP 78</a> and <a href="https://www.rfc-editor.org/bcp/bcp79">BCP 79</a>.

   Copies of IPR disclosures made to the IETF Secretariat and any
   assurances of licenses to be made available, or the result of an
   attempt made to obtain a general license or permission for the use of
   such proprietary rights by implementers or users of this
   specification can be obtained from the IETF on-line IPR repository at
   <a href="http://www.ietf.org/ipr">http://www.ietf.org/ipr</a>.

   The IETF invites any interested party to bring to its attention any
   copyrights, patents or patent applications, or other proprietary
   rights that may cover technology that may be required to implement
   this standard.  Please address the information to the IETF at ietf-
   ipr@ietf.org.

Acknowledgement

   Funding for the RFC Editor function is currently provided by the
   Internet Society.







Mahy, et al.                Standards Track                    [Page 16]
</pre>
</body></html>