<!DOCTYPE html>
<html class="RFC" lang="en"><head>
<meta charset="utf-8"/>
<meta content="Common,Latin" name="scripts"/>
<meta content="initial-scale=1.0" name="viewport"/>
<title>RFC 9539: Unilateral Opportunistic Deployment of Encrypted Recursive‑to‑Authoritative DNS</title>
<meta content="Daniel Kahn Gillmor" name="author"/>
<meta content="Joey Salazar" name="author"/>
<meta content="Paul Hoffman" name="author"/>
<meta content="
       This document sets out steps that DNS servers (recursive resolvers and authoritative servers) can take unilaterally (without any coordination with other peers) to defend DNS query privacy against a passive network monitor.
The protections provided by the guidance in this document can be defeated by an active attacker, but they should be simpler and less risky to deploy than more powerful defenses. 
       The goal of this document is to simplify and speed up deployment of opportunistic encrypted transport in the recursive-to-authoritative hop of the DNS ecosystem.
Wider easy deployment of the underlying encrypted transport on an opportunistic basis may facilitate the future specification of stronger cryptographic protections against more-powerful attacks. 
    " name="description"/>
<meta content="xml2rfc 3.20.0" name="generator"/>
<meta content="DNS over TLS" name="keyword"/>
<meta content="DNS over QUIC" name="keyword"/>
<meta content="DoT" name="keyword"/>
<meta content="DoQ" name="keyword"/>
<meta content="encryption" name="keyword"/>
<meta content="unilateral" name="keyword"/>
<meta content="recursive" name="keyword"/>
<meta content="authoritative" name="keyword"/>
<meta content="DNS" name="keyword"/>
<meta content="9539" name="rfc.number"/>
<!-- Generator version information:
  xml2rfc 3.20.0
    Python 3.9.15
    ConfigArgParse 1.5.3
    google-i18n-address 3.0.0
    intervaltree 3.1.0
    Jinja2 3.1.2
    lxml 4.9.0
    platformdirs 3.8.0
    pycountry 22.3.5
    PyYAML 6.0
    requests 2.28.0
    setuptools 44.1.1
    six 1.16.0
    wcwidth 0.2.5
    weasyprint 56.1
-->
<link href="rfc9539.xml" rel="alternate" type="application/rfc+xml"/>
<link href="#copyright" rel="license"/>
<style type="text/css">/*

  NOTE: Changes at the bottom of this file overrides some earlier settings.

  Once the style has stabilized and has been adopted as an official RFC style,
  this can be consolidated so that style settings occur only in one place, but
  for now the contents of this file consists first of the initial CSS work as
  provided to the RFC Formatter (xml2rfc) work, followed by itemized and
  commented changes found necessary during the development of the v3
  formatters.

*/

/* fonts */
@import url('https://fonts.googleapis.com/css?family=Noto+Sans'); /* Sans-serif */
@import url('https://fonts.googleapis.com/css?family=Noto+Serif'); /* Serif (print) */
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono'); /* Monospace */

:root {
  --font-sans: 'Noto Sans', Arial, Helvetica, sans-serif;
  --font-serif: 'Noto Serif', 'Times', 'Times New Roman', serif;
  --font-mono: 'Roboto Mono', Courier, 'Courier New', monospace;
}

@viewport {
  zoom: 1.0;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}
/* general and mobile first */
html {
}
body {
  max-width: 90%;
  margin: 1.5em auto;
  color: #222;
  background-color: #fff;
  font-size: 14px;
  font-family: var(--font-sans);
  line-height: 1.6;
  scroll-behavior: smooth;
  overflow-wrap: break-word;
}
.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  margin: 1em 0 0.5em;
  font-weight: bold;
  line-height: 1.3;
}
#title {
  clear: both;
  border-bottom: 1px solid #ddd;
  margin: 0 0 0.5em 0;
  padding: 1em 0 0.5em;
}
.author {
  padding-bottom: 4px;
}
h1 {
  font-size: 26px;
  margin: 1em 0;
}
h2 {
  font-size: 22px;
  margin-top: -20px;  /* provide offset for in-page anchors */
  padding-top: 33px;
}
h3 {
  font-size: 18px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h4 {
  font-size: 16px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h5, h6 {
  font-size: 14px;
}
#n-copyright-notice {
  border-bottom: 1px solid #ddd;
  padding-bottom: 1em;
  margin-bottom: 1em;
}
/* general structure */
p {
  padding: 0;
  margin: 0 0 1em 0;
  text-align: left;
}
div, span {
  position: relative;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignRight.art-text pre {
  padding: 0;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
svg[font-family~="serif" i], svg [font-family~="serif" i] {
  font-family: var(--font-serif);
}
svg[font-family~="sans-serif" i], svg [font-family~="sans-serif" i] {
  font-family: var(--font-sans);
}
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignCenter.art-text pre {
  padding: 0;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  display: table;
  border: none;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 1em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.ulBare, li.ulBare {
  margin-left: 0em !important;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
/* 
dl.nohang > dt {
  float: none;
}
*/
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}

/* links */
a {
  text-decoration: none;
}
a[href] {
  color: #22e; /* Arlen: WCAG 2019 */
}
a[href]:hover {
  background-color: #f2f2f2;
}
figcaption a[href],
a[href].selfRef {
  color: #222;
}
/* XXX probably not this:
a.selfRef:hover {
  background-color: transparent;
  cursor: default;
} */

/* Figures */
tt, code, pre {
  background-color: #f9f9f9;
  font-family: var(--font-mono);
}
pre {
  border: 1px solid #eee;
  margin: 0;
  padding: 1em;
}
img {
  max-width: 100%;
}
figure {
  margin: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption {
  font-style: italic;
  margin: 0 0 1em 0;
}
@media screen {
  pre {
    overflow-x: auto;
    max-width: 100%;
    max-width: calc(100% - 22px);
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 1.2em 2em;
}
blockquote {
  background-color: #f9f9f9;
  color: #111; /* Arlen: WCAG 2019 */
  border: 1px solid #ddd;
  border-radius: 3px;
  margin: 1em 0;
}
blockquote > *:last-child {
  margin-bottom: 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
  border: 1px solid #eee;
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 0.5em 0.75em;
}
th {
  text-align: left;
  background-color: #e9e9e9;
}
tr:nth-child(2n+1) > td {
  background-color: #f5f5f5;
}
table caption {
  font-style: italic;
  margin: 0;
  padding: 0;
  text-align: left;
}
table p {
  /* XXX to avoid bottom margin on table row signifiers. If paragraphs should
     be allowed within tables more generally, it would be far better to select on a class. */
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  color: #666; /* Arlen: AHDJ 2019 */
  text-decoration: none;
  visibility: hidden;
  user-select: none;
  -ms-user-select: none;
  -o-user-select:none;
  -moz-user-select: none;
  -khtml-user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}
@media screen {
  aside:hover > a.pilcrow,
  p:hover > a.pilcrow,
  blockquote:hover > a.pilcrow,
  div:hover > a.pilcrow,
  li:hover > a.pilcrow,
  pre:hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid #eee;
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: 0.9em;
}
#identifiers dt {
  width: 3em;
  clear: left;
}
#identifiers dd {
  float: left;
  margin-bottom: 0;
}
/* Fix PDF info block run off issue */
@media print {
  #identifiers dd {
    float: none;
  }
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #666; /* Arlen: WCAG 2019 */
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc  {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
nav.toc ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
nav.toc li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.refSubseries {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 600px) {
  .index ul {
    -moz-column-count: 2;
    -moz-column-gap: 20px;
  }
  .index ul ul {
    -moz-column-count: 1;
    -moz-column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}

address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  font-family: var(--font-sans);
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}

/* temporary notes */
.rfcEditorRemove::before {
  position: absolute;
  top: 0.2em;
  right: 0.2em;
  padding: 0.2em;
  content: "The RFC Editor will remove this note";
  color: #9e2a00; /* Arlen: WCAG 2019 */
  background-color: #ffd; /* Arlen: WCAG 2019 */
}
.rfcEditorRemove {
  position: relative;
  padding-top: 1.8em;
  background-color: #ffd; /* Arlen: WCAG 2019 */
  border-radius: 3px;
}
.cref {
  background-color: #ffd; /* Arlen: WCAG 2019 */
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 1023px) {
  body {
    padding-top: 2em;
  }
  #title {
    padding: 1em 0;
  }
  h1 {
    font-size: 24px;
  }
  h2 {
    font-size: 20px;
    margin-top: -18px;  /* provide offset for in-page anchors */
    padding-top: 38px;
  }
  #identifiers dd {
    max-width: 60%;
  }
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    background-color: inherit;
    border-bottom: 1px solid #ccc;
  }
  #toc h2 {
    margin: -1px 0 0 0;
    padding: 4px 0 4px 6px;
    padding-right: 1em;
    min-width: 190px;
    font-size: 1.1em;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 6px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    padding: 0.5em 1em 1em;
    overflow: auto;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 1024px) {
  body {
    max-width: 724px;
    margin: 42px auto;
    padding-left: 1.5em;
    padding-right: 29em;
  }
  #toc {
    position: fixed;
    top: 42px;
    right: 42px;
    width: 25%;
    margin: 0;
    padding: 0 1em;
    z-index: 1;
  }
  #toc h2 {
    border-top: none;
    border-bottom: 1px solid #ddd;
    font-size: 1em;
    font-weight: normal;
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 0;
    overflow: auto;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  .breakable pre {
    break-inside: auto;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

/* This is commented out here, as the string-set: doesn't
   pass W3C validation currently */
/*
.ears thead .left {
  string-set: ears-top-left content();
}

.ears thead .center {
  string-set: ears-top-center content();
}

.ears thead .right {
  string-set: ears-top-right content();
}

.ears tfoot .left {
  string-set: ears-bottom-left content();
}

.ears tfoot .center {
  string-set: ears-bottom-center content();
}

.ears tfoot .right {
  string-set: ears-bottom-right content();
}
*/

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
  /* The following is commented out here, but set appropriately by in code, as
     the content depends on the document */
  /*
  @top-left {
    content: 'Internet-Draft';
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-left {
    content: string(ears-top-left);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-center {
    content: string(ears-top-center);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-right {
    content: string(ears-top-right);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @bottom-left {
    content: string(ears-bottom-left);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-center {
    content: string(ears-bottom-center);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-right {
      content: '[Page ' counter(page) ']';
      vertical-align: top;
      border-top: solid 1px #ccc;
  }
  */

}

/* Changes introduced to fix issues found during implementation */
/* Make sure links are clickable even if overlapped by following H* */
a {
  z-index: 2;
}
/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}


/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Leave room in document info to show Internet-Draft on one line */
#identifiers dt {
  width: 8em;
}

/* Don't waste quite as much whitespace between label and value in doc info */
#identifiers dd {
  margin-left: 1em;
}

/* Give floating toc a background color (needed when it's a div inside section */
#toc {
  background-color: white;
}

/* Make the collapsed ToC header render white on gray also when it's a link */
@media screen and (max-width: 1023px) {
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
}

/* Give the bottom of the ToC some whitespace */
@media screen and (min-width: 1024px) {
  #toc {
    padding: 0 0 1em 1em;
  }
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* prevent monospace from becoming overly large */
tt, code, pre {
  font-size: 95%;
}

/* Fix the height/width aspect for ascii art*/
.sourcecode pre,
.art-text pre {
  line-height: 1.12;
}


/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin-right: 0.5em;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table td.text-left,
table th.text-left {
  text-align: left;
}
table td.text-center,
table th.text-center {
  text-align: center;
}
table td.text-right,
table th.text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 30em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Provide table alignment support.  We can't use the alignX classes above
   since they do unwanted things with caption and other styling. */
table.right {
 margin-left: auto;
 margin-right: 0;
}
table.center {
 margin-left: auto;
 margin-right: auto;
}
table.left {
 margin-left: 0;
 margin-right: auto;
}

/* Give the table caption label the same styling as the figcaption */
caption a[href] {
  color: #222;
}

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
/* Tweak the invisible space above H* in order not to overlay links in text above */
 h2 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 31px;
 }
 h3 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
 h4 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
/* Float artwork pilcrow to the right */
@media screen {
  .artwork a.pilcrow {
    display: block;
    line-height: 0.7;
    margin-top: 0.15em;
  }
}
/* Make pilcrows on dd visible */
@media screen {
  dd:hover > a.pilcrow {
    visibility: visible;
  }
}
/* Make the placement of figcaption match that of a table's caption
   by removing the figure's added bottom margin */
.alignLeft.art-text,
.alignCenter.art-text,
.alignRight.art-text {
   margin-bottom: 0;
}
.alignLeft,
.alignCenter,
.alignRight {
  margin: 1em 0 0 0;
}
/* In print, the pilcrow won't show on hover, so prevent it from taking up space,
   possibly even requiring a new line */
@media print {
  a.pilcrow {
    display: none;
  }
}
/* Styling for the external metadata */
div#external-metadata {
  background-color: #eee;
  padding: 0.5em;
  margin-bottom: 0.5em;
  display: none;
}
div#internal-metadata {
  padding: 0.5em;                       /* to match the external-metadata padding */
}
/* Styling for title RFC Number */
h1#rfcnum {
  clear: both;
  margin: 0 0 -1em;
  padding: 1em 0 0 0;
}
/* Make .olPercent look the same as <ol><li> */
dl.olPercent > dd {
  margin-bottom: 0.25em;
  min-height: initial;
}
/* Give aside some styling to set it apart */
aside {
  border-left: 1px solid #ddd;
  margin: 1em 0 1em 2em;
  padding: 0.2em 2em;
}
aside > dl,
aside > ol,
aside > ul,
aside > table,
aside > p {
  margin-bottom: 0.5em;
}
/* Additional page break settings */
@media print {
  figcaption, table caption {
    page-break-before: avoid;
  }
}
/* Font size adjustments for print */
@media print {
  body  { font-size: 10pt;      line-height: normal; max-width: 96%; }
  h1    { font-size: 1.72em;    padding-top: 1.5em; } /* 1*1.2*1.2*1.2 */
  h2    { font-size: 1.44em;    padding-top: 1.5em; } /* 1*1.2*1.2 */
  h3    { font-size: 1.2em;     padding-top: 1.5em; } /* 1*1.2 */
  h4    { font-size: 1em;       padding-top: 1.5em; }
  h5, h6 { font-size: 1em;      margin: initial; padding: 0.5em 0 0.3em; }
}
/* Sourcecode margin in print, when there's no pilcrow */
@media print {
  .artwork,
  .artwork > pre,
  .sourcecode {
    margin-bottom: 1em;
  }
}
/* Avoid narrow tables forcing too narrow table captions, which may render badly */
table {
  min-width: 20em;
}
/* ol type a */
ol.type-a { list-style-type: lower-alpha; }
ol.type-A { list-style-type: upper-alpha; }
ol.type-i { list-style-type: lower-roman; }
ol.type-I { list-style-type: lower-roman; }
/* Apply the print table and row borders in general, on request from the RPC,
and increase the contrast between border and odd row background slightly */
table {
  border: 1px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
}
tr {
  break-inside: avoid;
}
tr:nth-child(2n+1) > td {
  background-color: #f8f8f8;
}
/* Use style rules to govern display of the TOC. */
@media screen and (max-width: 1023px) {
  #toc nav { display: none; }
  #toc.active nav { display: block; }
}
/* Add support for keepWithNext */
.keepWithNext {
  break-after: avoid-page;
  break-after: avoid-page;
}
/* Add support for keepWithPrevious */
.keepWithPrevious {
  break-before: avoid-page;
}
/* Change the approach to avoiding breaks inside artwork etc. */
figure, pre, table, .artwork, .sourcecode  {
  break-before: auto;
  break-after: auto;
}
/* Avoid breaks between <dt> and <dd> */
dl {
  break-before: auto;
  break-inside: auto;
}
dt {
  break-before: auto;
  break-after: avoid-page;
}
dd {
  break-before: avoid-page;
  break-after: auto;
  orphans: 3;
  widows: 3
}
span.break, dd.break {
  margin-bottom: 0;
  min-height: 0;
  break-before: auto;
  break-inside: auto;
  break-after: auto;
}
/* Undo break-before ToC */
@media print {
  #toc {
    break-before: auto;
  }
}
/* Text in compact lists should not get extra bottom margin space,
   since that would makes the list not compact */
ul.compact p, .ulCompact p,
ol.compact p, .olCompact p {
 margin: 0;
}
/* But the list as a whole needs the extra space at the end */
section ul.compact,
section .ulCompact,
section ol.compact,
section .olCompact {
  margin-bottom: 1em;                    /* same as p not within ul.compact etc. */
}
/* The tt and code background above interferes with for instance table cell
   backgrounds.  Changed to something a bit more selective. */
tt, code {
  background-color: transparent;
}
p tt, p code, li tt, li code {
  background-color: #f8f8f8;
}
/* Tweak the pre margin -- 0px doesn't come out well */
pre {
   margin-top: 0.5px;
}
/* Tweak the compact list text */
ul.compact, .ulCompact,
ol.compact, .olCompact,
dl.compact, .dlCompact {
  line-height: normal;
}
/* Don't add top margin for nested lists */
li > ul, li > ol, li > dl,
dd > ul, dd > ol, dd > dl,
dl > dd > dl {
  margin-top: initial;
}
/* Elements that should not be rendered on the same line as a <dt> */
/* This should match the element list in writer.text.TextWriter.render_dl() */
dd > div.artwork:first-child,
dd > aside:first-child,
dd > figure:first-child,
dd > ol:first-child,
dd > div.sourcecode:first-child,
dd > table:first-child,
dd > ul:first-child {
  clear: left;
}
/* fix for weird browser behaviour when <dd/> is empty */
dt+dd:empty::before{
  content: "\00a0";
}
/* Make paragraph spacing inside <li> smaller than in body text, to fit better within the list */
li > p {
  margin-bottom: 0.5em
}
/* Don't let p margin spill out from inside list items */
li > p:last-of-type:only-child {
  margin-bottom: 0;
}
</style>
<link href="rfc-local.css" rel="stylesheet" type="text/css"/>
<link href="https://datatracker.ietf.org/doc/draft-ietf-dprive-unilateral-probing-13" rel="prev"/>
  <link href="https://dx.doi.org/10.17487/rfc9539" rel="alternate"/>
  <link href="urn:issn:2070-1721" rel="alternate"/>
  </head>
<body class="xml2rfc">
<script src="https://www.rfc-editor.org/js/metadata.min.js"></script>
<table class="ears">
<thead><tr>
<td class="left">RFC 9539</td>
<td class="center">Unilateral Encrypted Authoritative DNS</td>
<td class="right">February 2024</td>
</tr></thead>
<tfoot><tr>
<td class="left">Gillmor, et al.</td>
<td class="center">Experimental</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div class="document-information" id="external-metadata"></div>
<div class="document-information" id="internal-metadata">
<dl id="identifiers">
<dt class="label-stream">Stream:</dt>
<dd class="stream">Internet Engineering Task Force (IETF)</dd>
<dt class="label-rfc">RFC:</dt>
<dd class="rfc"><a class="eref" href="https://www.rfc-editor.org/rfc/rfc9539">9539</a></dd>
<dt class="label-category">Category:</dt>
<dd class="category">Experimental</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time class="published" datetime="2024-02">February 2024</time>
    </dd>
<dt class="label-issn">ISSN:</dt>
<dd class="issn">2070-1721</dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">D. K. Gillmor, <span class="editor">Ed.</span>
</div>
<div class="org">ACLU</div>
</div>
<div class="author">
      <div class="author-name">J. Salazar, <span class="editor">Ed.</span>
</div>
</div>
<div class="author">
      <div class="author-name">P. Hoffman, <span class="editor">Ed.</span>
</div>
<div class="org">ICANN</div>
</div>
</dd>
</dl>
</div>
<h1 id="rfcnum">RFC 9539</h1>
<h1 id="title">Unilateral Opportunistic Deployment of Encrypted Recursive‑to‑Authoritative DNS</h1>
<section id="section-abstract">
      <h2 id="abstract"><a class="selfRef" href="#abstract">Abstract</a></h2>
<p id="section-abstract-1">This document sets out steps that DNS servers (recursive resolvers and authoritative servers) can take unilaterally (without any coordination with other peers) to defend DNS query privacy against a passive network monitor.
The protections provided by the guidance in this document can be defeated by an active attacker, but they should be simpler and less risky to deploy than more powerful defenses.<a class="pilcrow" href="#section-abstract-1">¶</a></p>
<p id="section-abstract-2">The goal of this document is to simplify and speed up deployment of opportunistic encrypted transport in the recursive-to-authoritative hop of the DNS ecosystem.
Wider easy deployment of the underlying encrypted transport on an opportunistic basis may facilitate the future specification of stronger cryptographic protections against more-powerful attacks.<a class="pilcrow" href="#section-abstract-2">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a class="section-name selfRef" href="#name-status-of-this-memo">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
            This document is not an Internet Standards Track specification; it is
            published for examination, experimental implementation, and
            evaluation.<a class="pilcrow" href="#section-boilerplate.1-1">¶</a></p>
<p id="section-boilerplate.1-2">
            This document defines an Experimental Protocol for the Internet
            community.  This document is a product of the Internet Engineering
            Task Force (IETF).  It represents the consensus of the IETF community.
            It has received public review and has been approved for publication
            by the Internet Engineering Steering Group (IESG).  Not all documents
            approved by the IESG are candidates for any level of Internet
            Standard; see Section 2 of RFC 7841.<a class="pilcrow" href="#section-boilerplate.1-2">¶</a></p>
<p id="section-boilerplate.1-3">
            Information about the current status of this document, any
            errata, and how to provide feedback on it may be obtained at
            <span><a href="https://www.rfc-editor.org/info/rfc9539">https://www.rfc-editor.org/info/rfc9539</a></span>.<a class="pilcrow" href="#section-boilerplate.1-3">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a class="section-name selfRef" href="#name-copyright-notice">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2024 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a class="pilcrow" href="#section-boilerplate.2-1">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a class="pilcrow" href="#section-boilerplate.2-2">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a class="toplink" href="#" onclick="scroll(0,0)">▲</a><h2 id="name-table-of-contents">
<a class="section-name selfRef" href="#name-table-of-contents">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p class="keepWithNext" id="section-toc.1-1.1.1"><a class="auto internal xref" href="#section-1">1</a>.  <a class="internal xref" href="#name-introduction">Introduction</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1">
                <p class="keepWithNext" id="section-toc.1-1.1.2.1.1"><a class="auto internal xref" href="#section-1.1">1.1</a>.  <a class="internal xref" href="#name-requirements-language">Requirements Language</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.2">
                <p class="keepWithNext" id="section-toc.1-1.1.2.2.1"><a class="auto internal xref" href="#section-1.2">1.2</a>.  <a class="internal xref" href="#name-terminology">Terminology</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1"><a class="auto internal xref" href="#section-2">2</a>.  <a class="internal xref" href="#name-priorities">Priorities</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.1">
                <p id="section-toc.1-1.2.2.1.1"><a class="auto internal xref" href="#section-2.1">2.1</a>.  <a class="internal xref" href="#name-minimizing-negative-impacts">Minimizing Negative Impacts</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.2">
                <p id="section-toc.1-1.2.2.2.1"><a class="auto internal xref" href="#section-2.2">2.2</a>.  <a class="internal xref" href="#name-protocol-choices">Protocol Choices</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a class="auto internal xref" href="#section-3">3</a>.  <a class="internal xref" href="#name-guidance-for-authoritative-">Guidance for Authoritative Servers</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a class="auto internal xref" href="#section-3.1">3.1</a>.  <a class="internal xref" href="#name-pooled-authoritative-server">Pooled Authoritative Servers behind a Load Balancer</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a class="auto internal xref" href="#section-3.2">3.2</a>.  <a class="internal xref" href="#name-authentication">Authentication</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a class="auto internal xref" href="#section-3.3">3.3</a>.  <a class="internal xref" href="#name-server-name-indication">Server Name Indication</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.4">
                <p id="section-toc.1-1.3.2.4.1"><a class="auto internal xref" href="#section-3.4">3.4</a>.  <a class="internal xref" href="#name-resource-exhaustion">Resource Exhaustion</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.5">
                <p id="section-toc.1-1.3.2.5.1"><a class="auto internal xref" href="#section-3.5">3.5</a>.  <a class="internal xref" href="#name-pad-responses-to-mitigate-t">Pad Responses to Mitigate Traffic Analysis</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a class="auto internal xref" href="#section-4">4</a>.  <a class="internal xref" href="#name-guidance-for-recursive-reso">Guidance for Recursive Resolvers</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a class="auto internal xref" href="#section-4.1">4.1</a>.  <a class="internal xref" href="#name-high-level-overview">High-Level Overview</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a class="auto internal xref" href="#section-4.2">4.2</a>.  <a class="internal xref" href="#name-maintaining-authoritative-s">Maintaining Authoritative State by IP Address</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3">
                <p id="section-toc.1-1.4.2.3.1"><a class="auto internal xref" href="#section-4.3">4.3</a>.  <a class="internal xref" href="#name-overall-recursive-resolver-">Overall Recursive Resolver Settings</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4">
                <p id="section-toc.1-1.4.2.4.1"><a class="auto internal xref" href="#section-4.4">4.4</a>.  <a class="internal xref" href="#name-recursive-resolver-requirem">Recursive Resolver Requirements</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5">
                <p id="section-toc.1-1.4.2.5.1"><a class="auto internal xref" href="#section-4.5">4.5</a>.  <a class="internal xref" href="#name-authoritative-server-encryp">Authoritative Server Encrypted Transport Connection State</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6">
                <p id="section-toc.1-1.4.2.6.1"><a class="auto internal xref" href="#section-4.6">4.6</a>.  <a class="internal xref" href="#name-probing-policy">Probing Policy</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.1">
                    <p id="section-toc.1-1.4.2.6.2.1.1"><a class="auto internal xref" href="#section-4.6.1">4.6.1</a>.  <a class="internal xref" href="#name-sending-a-query-over-do53">Sending a Query over Do53</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.2">
                    <p id="section-toc.1-1.4.2.6.2.2.1"><a class="auto internal xref" href="#section-4.6.2">4.6.2</a>.  <a class="internal xref" href="#name-receiving-a-response-over-d">Receiving a Response over Do53</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.3">
                    <p id="section-toc.1-1.4.2.6.2.3.1"><a class="auto internal xref" href="#section-4.6.3">4.6.3</a>.  <a class="internal xref" href="#name-initiating-a-connection-ove">Initiating a Connection over Encrypted Transport</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.4">
                    <p id="section-toc.1-1.4.2.6.2.4.1"><a class="auto internal xref" href="#section-4.6.4">4.6.4</a>.  <a class="internal xref" href="#name-establishing-an-encrypted-t">Establishing an Encrypted Transport Connection</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.5">
                    <p id="section-toc.1-1.4.2.6.2.5.1"><a class="auto internal xref" href="#section-4.6.5">4.6.5</a>.  <a class="internal xref" href="#name-failing-to-establish-an-enc">Failing to Establish an Encrypted Transport Connection</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.6">
                    <p id="section-toc.1-1.4.2.6.2.6.1"><a class="auto internal xref" href="#section-4.6.6">4.6.6</a>.  <a class="internal xref" href="#name-encrypted-transport-failure">Encrypted Transport Failure</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.7">
                    <p id="section-toc.1-1.4.2.6.2.7.1"><a class="auto internal xref" href="#section-4.6.7">4.6.7</a>.  <a class="internal xref" href="#name-handling-clean-shutdown-of-">Handling Clean Shutdown of an Encrypted Transport Connection</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.8">
                    <p id="section-toc.1-1.4.2.6.2.8.1"><a class="auto internal xref" href="#section-4.6.8">4.6.8</a>.  <a class="internal xref" href="#name-sending-a-query-over-encryp">Sending a Query over Encrypted Transport</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.9">
                    <p id="section-toc.1-1.4.2.6.2.9.1"><a class="auto internal xref" href="#section-4.6.9">4.6.9</a>.  <a class="internal xref" href="#name-receiving-a-response-over-e">Receiving a Response over Encrypted Transport</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.10">
                    <p id="section-toc.1-1.4.2.6.2.10.1"><a class="auto internal xref" href="#section-4.6.10">4.6.10</a>. <a class="internal xref" href="#name-resource-exhaustion-2">Resource Exhaustion</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.11">
                    <p id="section-toc.1-1.4.2.6.2.11.1"><a class="auto internal xref" href="#section-4.6.11">4.6.11</a>. <a class="internal xref" href="#name-maintaining-connections">Maintaining Connections</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.12">
                    <p id="section-toc.1-1.4.2.6.2.12.1"><a class="auto internal xref" href="#section-4.6.12">4.6.12</a>. <a class="internal xref" href="#name-additional-tuning">Additional Tuning</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a class="auto internal xref" href="#section-5">5</a>.  <a class="internal xref" href="#name-iana-considerations">IANA Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a class="auto internal xref" href="#section-6">6</a>.  <a class="internal xref" href="#name-privacy-considerations">Privacy Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a class="auto internal xref" href="#section-6.1">6.1</a>.  <a class="internal xref" href="#name-server-name-indication-3">Server Name Indication</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a class="auto internal xref" href="#section-6.2">6.2</a>.  <a class="internal xref" href="#name-modeling-the-probability-of">Modeling the Probability of Encryption</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a class="auto internal xref" href="#section-7">7</a>.  <a class="internal xref" href="#name-security-considerations">Security Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a class="auto internal xref" href="#section-8">8</a>.  <a class="internal xref" href="#name-operational-considerations">Operational Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a class="auto internal xref" href="#section-9">9</a>.  <a class="internal xref" href="#name-references">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.1">
                <p id="section-toc.1-1.9.2.1.1"><a class="auto internal xref" href="#section-9.1">9.1</a>.  <a class="internal xref" href="#name-normative-references">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.2">
                <p id="section-toc.1-1.9.2.2.1"><a class="auto internal xref" href="#section-9.2">9.2</a>.  <a class="internal xref" href="#name-informative-references">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a class="auto internal xref" href="#appendix-A">Appendix A</a>.  <a class="internal xref" href="#name-assessing-the-experiment">Assessing the Experiment</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a class="auto internal xref" href="#appendix-B">Appendix B</a>.  <a class="internal xref" href="#name-defense-against-active-atta">Defense against Active Attackers</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.1">
                <p id="section-toc.1-1.11.2.1.1"><a class="auto internal xref" href="#appendix-B.1">B.1</a>.  <a class="internal xref" href="#name-signaling-mechanism-propert">Signaling Mechanism Properties</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.2">
                <p id="section-toc.1-1.11.2.2.1"><a class="auto internal xref" href="#appendix-B.2">B.2</a>.  <a class="internal xref" href="#name-authentication-of-authorita">Authentication of Authoritative Servers</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.3">
                <p id="section-toc.1-1.11.2.3.1"><a class="auto internal xref" href="#appendix-B.3">B.3</a>.  <a class="internal xref" href="#name-combining-protocols">Combining Protocols</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a class="auto internal xref" href="#appendix-C"></a><a class="internal xref" href="#name-acknowledgements">Acknowledgements</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a class="auto internal xref" href="#appendix-D"></a><a class="internal xref" href="#name-authors-addresses">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a class="section-number selfRef" href="#section-1">1. </a><a class="section-name selfRef" href="#name-introduction">Introduction</a>
      </h2>
<p id="section-1-1">This document aims to provide guidance to DNS implementers and operators who want to simply enable protection against passive network observers.<a class="pilcrow" href="#section-1-1">¶</a></p>
<p id="section-1-2">In particular, it focuses on mechanisms that can be adopted
      unilaterally by recursive resolvers and authoritative servers, without
      any explicit coordination with the other parties.  This guidance
      provides opportunistic security (see <span>[<a class="cite xref" href="#RFC7435">RFC7435</a>]</span>), that is, 
      encrypting things that would otherwise be in the clear, without
      interfering with or weakening stronger forms of security.<a class="pilcrow" href="#section-1-2">¶</a></p>
<p id="section-1-3">This document also briefly introduces (but does not try to specify) how a future protocol might permit defense against an active attacker in <a class="auto internal xref" href="#adding-auth">Appendix B</a>.<a class="pilcrow" href="#section-1-3">¶</a></p>
<p id="section-1-4">The protocol described here offers three concrete advantages to the DNS ecosystem:<a class="pilcrow" href="#section-1-4">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1-5.1">
          <p id="section-1-5.1.1">Protection from passive attackers of DNS queries in transit between recursive and authoritative servers.<a class="pilcrow" href="#section-1-5.1.1">¶</a></p>
</li>
        <li class="normal" id="section-1-5.2">
          <p id="section-1-5.2.1">A road map for gaining real-world experience at scale with encrypted protections of this traffic.<a class="pilcrow" href="#section-1-5.2.1">¶</a></p>
</li>
        <li class="normal" id="section-1-5.3">
          <p id="section-1-5.3.1">A bridge to some possible future protection against a more powerful attacker.<a class="pilcrow" href="#section-1-5.3.1">¶</a></p>
</li>
      </ul>
<div id="requirements-language">
<section id="section-1.1">
        <h3 id="name-requirements-language">
<a class="section-number selfRef" href="#section-1.1">1.1. </a><a class="section-name selfRef" href="#name-requirements-language">Requirements Language</a>
        </h3>
<p id="section-1.1-1">
    The key words "<span class="bcp14">MUST</span>", "<span class="bcp14">MUST NOT</span>", "<span class="bcp14">REQUIRED</span>", "<span class="bcp14">SHALL</span>", "<span class="bcp14">SHALL NOT</span>", "<span class="bcp14">SHOULD</span>", "<span class="bcp14">SHOULD NOT</span>", "<span class="bcp14">RECOMMENDED</span>", "<span class="bcp14">NOT RECOMMENDED</span>",
    "<span class="bcp14">MAY</span>", and "<span class="bcp14">OPTIONAL</span>" in this document are to be interpreted as
    described in BCP 14 <span>[<a class="cite xref" href="#RFC2119">RFC2119</a>]</span> <span>[<a class="cite xref" href="#RFC8174">RFC8174</a>]</span> 
    when, and only when, they appear in all capitals, as shown here.<a class="pilcrow" href="#section-1.1-1">¶</a></p>
</section>
</div>
<div id="terminology">
<section id="section-1.2">
        <h3 id="name-terminology">
<a class="section-number selfRef" href="#section-1.2">1.2. </a><a class="section-name selfRef" href="#name-terminology">Terminology</a>
        </h3>
<span class="break"></span><dl class="dlParallel" id="section-1.2-1">
          <dt id="section-1.2-1.1">Unilateral:</dt>
          <dd id="section-1.2-1.2" style="margin-left: 1.5em">
            <p id="section-1.2-1.2.1">Capable of opportunistic probing without external coordination with any of the other parties.<a class="pilcrow" href="#section-1.2-1.2.1">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.2-1.3">Do53:</dt>
          <dd id="section-1.2-1.4" style="margin-left: 1.5em">
            <p id="section-1.2-1.4.1">DNS over port 53 (<span>[<a class="cite xref" href="#RFC1035">RFC1035</a>]</span>) for traditional cleartext transport.<a class="pilcrow" href="#section-1.2-1.4.1">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.2-1.5">DoQ:</dt>
          <dd id="section-1.2-1.6" style="margin-left: 1.5em">
            <p id="section-1.2-1.6.1">DNS over QUIC (<span>[<a class="cite xref" href="#RFC9250">RFC9250</a>]</span>).<a class="pilcrow" href="#section-1.2-1.6.1">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.2-1.7">DoT:</dt>
          <dd id="section-1.2-1.8" style="margin-left: 1.5em">
            <p id="section-1.2-1.8.1">DNS over TLS (<span>[<a class="cite xref" href="#RFC7858">RFC7858</a>]</span>).<a class="pilcrow" href="#section-1.2-1.8.1">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.2-1.9">Encrypted transports:</dt>
          <dd id="section-1.2-1.10" style="margin-left: 1.5em">
            <p id="section-1.2-1.10.1">DoQ and DoT, collectively.<a class="pilcrow" href="#section-1.2-1.10.1">¶</a></p>
</dd>
        <dd class="break"></dd>
</dl>
</section>
</div>
</section>
</div>
<div id="priorities">
<section id="section-2">
      <h2 id="name-priorities">
<a class="section-number selfRef" href="#section-2">2. </a><a class="section-name selfRef" href="#name-priorities">Priorities</a>
      </h2>
<p id="section-2-1">The protocol described in this document was developed with two priorities: minimizing negative impacts and retaining flexibility in the underlying encrypted transport protocol.<a class="pilcrow" href="#section-2-1">¶</a></p>
<div id="minimizing-negative-impacts">
<section id="section-2.1">
        <h3 id="name-minimizing-negative-impacts">
<a class="section-number selfRef" href="#section-2.1">2.1. </a><a class="section-name selfRef" href="#name-minimizing-negative-impacts">Minimizing Negative Impacts</a>
        </h3>
<p id="section-2.1-1">The protocol described in this document aims to minimize potentially negative impacts caused by the probing of encrypted transports for the systems that adopt the protocol, for the parties that those systems communicate with, and for uninvolved third parties.
The negative impacts that this protocol specifically tries to minimize are:<a class="pilcrow" href="#section-2.1-1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2.1-2.1">
            <p id="section-2.1-2.1.1">excessive bandwidth use,<a class="pilcrow" href="#section-2.1-2.1.1">¶</a></p>
</li>
          <li class="normal" id="section-2.1-2.2">
            <p id="section-2.1-2.2.1">excessive use of computational resources (CPU and memory in particular), and<a class="pilcrow" href="#section-2.1-2.2.1">¶</a></p>
</li>
          <li class="normal" id="section-2.1-2.3">
            <p id="section-2.1-2.3.1">the potential for amplification attacks (where DNS resolution infrastructure is wielded as part of a DoS attack).<a class="pilcrow" href="#section-2.1-2.3.1">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="protocol-choices">
<section id="section-2.2">
        <h3 id="name-protocol-choices">
<a class="section-number selfRef" href="#section-2.2">2.2. </a><a class="section-name selfRef" href="#name-protocol-choices">Protocol Choices</a>
        </h3>
<p id="section-2.2-1">Although this document focuses specifically on strategies used by DNS servers, it does not go into detail on the specific protocols used because those protocols, in particular DoT and DoQ, are described in other documents.
The DoT specification (<span>[<a class="cite xref" href="#RFC7858">RFC7858</a>]</span>) says that it:<a class="pilcrow" href="#section-2.2-1">¶</a></p>
<blockquote id="section-2.2-2">...focuses on securing stub-to-recursive traffic, as per the
        charter of the DPRIVE Working Group.  It does not prevent future
        applications of the protocol to recursive-to-authoritative
        traffic.<a class="pilcrow" href="#section-2.2-2">¶</a>
</blockquote>
<p id="section-2.2-3">It further says:<a class="pilcrow" href="#section-2.2-3">¶</a></p>
<blockquote id="section-2.2-4">It might work equally between recursive clients and
        authoritative servers...<a class="pilcrow" href="#section-2.2-4">¶</a>
</blockquote>
<p id="section-2.2-5">The DoQ specification (<span>[<a class="cite xref" href="#RFC9250">RFC9250</a>]</span>) says:<a class="pilcrow" href="#section-2.2-5">¶</a></p>
<blockquote id="section-2.2-6">For the recursive to authoritative scenario,
        authentication requirements are unspecified at the time of writing and
        are the subject of ongoing work in the DPRIVE WG.<a class="pilcrow" href="#section-2.2-6">¶</a>
</blockquote>
<p id="section-2.2-7">The protocol described in this document specifies the use of DoT and DoQ without authentication of the server.<a class="pilcrow" href="#section-2.2-7">¶</a></p>
<p id="section-2.2-8">This document does not pursue the use of DNS over HTTPS, commonly called "DoH" (<span>[<a class="cite xref" href="#RFC8484">RFC8484</a>]</span>), in this context because a DoH client needs to know the path part of a DoH endpoint URL. Currently, there are no mechanisms for a DNS recursive resolver to predict the path on its own, in an opportunistic or unilateral fashion, without incurring an excessive use of resources.
If such mechanisms are later defined, the protocol in this document can be updated to accommodate them.<a class="pilcrow" href="#section-2.2-8">¶</a></p>
</section>
</div>
</section>
</div>
<div id="authoritative-guidance">
<section id="section-3">
      <h2 id="name-guidance-for-authoritative-">
<a class="section-number selfRef" href="#section-3">3. </a><a class="section-name selfRef" href="#name-guidance-for-authoritative-">Guidance for Authoritative Servers</a>
      </h2>
<p id="section-3-1">The protocol described in this document is <span class="bcp14">OPTIONAL</span> for authoritative servers.
An authoritative server choosing to implement the protocol described in this document <span class="bcp14">MUST</span> implement at least one of either
DoT or DoQ on port 853.<a class="pilcrow" href="#section-3-1">¶</a></p>
<p id="section-3-2">An authoritative server choosing to implement the protocol described in this document <span class="bcp14">MAY</span> require clients to use Application-Layer Protocol Negotiation (ALPN) (see <span>[<a class="cite xref" href="#RFC7301">RFC7301</a>]</span>).
      The ALPN strings the client will use are given in <a class="auto internal xref" href="#recursive-requirements">Section 4.4</a>.<a class="pilcrow" href="#section-3-2">¶</a></p>
<p id="section-3-3">An authoritative server implementing DoT or DoQ <span class="bcp14">MUST</span> populate the response from the same authoritative zone data as the unencrypted DNS transports.
Encrypted transports have their own characteristic response size that might be different from the unencrypted DNS transports, so response sizes and related options (e.g., Extension Mechanisms for DNS (EDNS0)) and flags (e.g., the TrunCation (TC) bit) might vary based on the transport.
In other words, the content of the responses to a particular query <span class="bcp14">MUST</span> be the same regardless of the type of transport.<a class="pilcrow" href="#section-3-3">¶</a></p>
<div id="authoritative-pools">
<section id="section-3.1">
        <h3 id="name-pooled-authoritative-server">
<a class="section-number selfRef" href="#section-3.1">3.1. </a><a class="section-name selfRef" href="#name-pooled-authoritative-server">Pooled Authoritative Servers behind a Load Balancer</a>
        </h3>
<p id="section-3.1-1">Some authoritative DNS servers are structured as a pool of authoritatives standing behind a load balancer that runs on a single IP address, forwarding queries to members of the pool.
In such a deployment, individual members of the pool typically get updated independently from each other.<a class="pilcrow" href="#section-3.1-1">¶</a></p>
<p id="section-3.1-2">A recursive resolver following the guidance in <a class="auto internal xref" href="#recursive-guidance">Section 4</a> and interacting with such a pool likely does not know that it is a pool.
If some members of the pool follow the protocol specified in this document while others do not, the recursive client might see the pool as a single authoritative server that sometimes offers and sometimes refuses encrypted transport.<a class="pilcrow" href="#section-3.1-2">¶</a></p>
<p id="section-3.1-3">To avoid incurring additional minor timeouts for such a recursive resolver, the pool operator <span class="bcp14">SHOULD</span>:<a class="pilcrow" href="#section-3.1-3">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1-4.1">
            <p id="section-3.1-4.1.1">ensure that all members of the pool enable the same encrypted transport(s) within the span of a few seconds (such as within 30 seconds), or<a class="pilcrow" href="#section-3.1-4.1.1">¶</a></p>
</li>
          <li class="normal" id="section-3.1-4.2">
            <p id="section-3.1-4.2.1">ensure that the load balancer maps client requests to pool members based on client IP addresses, or<a class="pilcrow" href="#section-3.1-4.2.1">¶</a></p>
</li>
          <li class="normal" id="section-3.1-4.3">
            <p id="section-3.1-4.3.1">use a load balancer that forwards queries/connections on encrypted transports to only those members of the pool known (e.g., via monitoring) to support the given encrypted transport.<a class="pilcrow" href="#section-3.1-4.3.1">¶</a></p>
</li>
        </ul>
<p id="section-3.1-5">Similar concerns apply to authoritative servers responding from an anycast IP address.
As long as the pool of servers is in a heterogeneous state, any flapping route that switches a given client IP address to a different responder risks incurring an additional timeout.
Frequent changes of routing for anycast listening IP addresses are also likely to cause problems for TLS, TCP, or QUIC connection state as well, so stable routes are important to ensure that the service remains available and responsive.
The servers in a pool can share session information to increase the likelihood of successful resumptions.<a class="pilcrow" href="#section-3.1-5">¶</a></p>
</section>
</div>
<div id="authentication">
<section id="section-3.2">
        <h3 id="name-authentication">
<a class="section-number selfRef" href="#section-3.2">3.2. </a><a class="section-name selfRef" href="#name-authentication">Authentication</a>
        </h3>
<p id="section-3.2-1">For unilateral deployment, an authoritative server does not need to offer any particular form of authentication.<a class="pilcrow" href="#section-3.2-1">¶</a></p>
<p id="section-3.2-2">One simple deployment approach would just be to provide a self-issued, regularly updated X.509 certificate.
Whether the certificates used are short-lived or long-lived is up to the deployment.
This mechanism is supported by many TLS and QUIC clients and will be acceptable for any opportunistic connection.
The server could provide a normal PKI-based certificate, but there is no advantage to doing so at this time.<a class="pilcrow" href="#section-3.2-2">¶</a></p>
</section>
</div>
<div id="authoritative-sni">
<section id="section-3.3">
        <h3 id="name-server-name-indication">
<a class="section-number selfRef" href="#section-3.3">3.3. </a><a class="section-name selfRef" href="#name-server-name-indication">Server Name Indication</a>
        </h3>
<p id="section-3.3-1">An authoritative DNS server that wants to handle unilateral queries <span class="bcp14">MAY</span> rely on Server Name Indication (SNI) to select alternate server credentials.
However, such a server <span class="bcp14">MUST NOT</span> serve resource records that differ based on SNI (or on the lack of an SNI) provided by the client because a probing recursive resolver that offers SNI might or might not have used the right server name to get the records it is looking for.<a class="pilcrow" href="#section-3.3-1">¶</a></p>
</section>
</div>
<div id="authoritative-resource-exhaustion">
<section id="section-3.4">
        <h3 id="name-resource-exhaustion">
<a class="section-number selfRef" href="#section-3.4">3.4. </a><a class="section-name selfRef" href="#name-resource-exhaustion">Resource Exhaustion</a>
        </h3>
<p id="section-3.4-1">A well-behaved recursive resolver may keep an encrypted connection open to an authoritative server to amortize the costs of connection setup for both parties.<a class="pilcrow" href="#section-3.4-1">¶</a></p>
<p id="section-3.4-2">However, some authoritative servers may have insufficient resources available to keep many connections open concurrently.<a class="pilcrow" href="#section-3.4-2">¶</a></p>
<p id="section-3.4-3">To keep resources under control, authoritative servers should proactively manage their encrypted connections.
<span><a class="relref" href="https://rfc-editor.org/rfc/rfc9250#section-5.5">Section 5.5</a> of [<a class="cite xref" href="#RFC9250">RFC9250</a>]</span> offers useful guidance for servers managing DoQ connections.
<span><a class="relref" href="https://rfc-editor.org/rfc/rfc7858#section-3.4">Section 3.4</a> of [<a class="cite xref" href="#RFC7858">RFC7858</a>]</span> offers useful guidance for servers managing DoT connections.<a class="pilcrow" href="#section-3.4-3">¶</a></p>
<p id="section-3.4-4">An authoritative server facing unforeseen resource exhaustion <span class="bcp14">SHOULD</span> cleanly close open connections from recursive resolvers based on the authoritative server's preferred prioritization.<a class="pilcrow" href="#section-3.4-4">¶</a></p>
<p id="section-3.4-5">In the case of unanticipated resource exhaustion, close connections until resources are back in control.
A reasonable prioritization scheme would be to close connections with no outstanding queries, ordered by idle time (longest idle time gets closed first), then close connections with outstanding queries, ordered by age of outstanding query (oldest outstanding query gets closed first).<a class="pilcrow" href="#section-3.4-5">¶</a></p>
<p id="section-3.4-6">When resources are especially tight, the authoritative server may also decline to accept new connections over encrypted transport.<a class="pilcrow" href="#section-3.4-6">¶</a></p>
</section>
</div>
<div id="pad-responses-to-mitigate-traffic-analysis">
<section id="section-3.5">
        <h3 id="name-pad-responses-to-mitigate-t">
<a class="section-number selfRef" href="#section-3.5">3.5. </a><a class="section-name selfRef" href="#name-pad-responses-to-mitigate-t">Pad Responses to Mitigate Traffic Analysis</a>
        </h3>
<p id="section-3.5-1">To increase the anonymity set for each response, the authoritative server <span class="bcp14">SHOULD</span> use a sensible padding mechanism for all responses it sends when possible.
The ability for the authoritative server to add padding might be limited, such as by not receiving an EDNS0 option in the query.
Specifically, a DoT server <span class="bcp14">SHOULD</span> use EDNS0 padding <span>[<a class="cite xref" href="#RFC7830">RFC7830</a>]</span> if possible, and a DoQ server <span class="bcp14">SHOULD</span> follow the guidance in <span><a class="relref" href="https://rfc-editor.org/rfc/rfc9250#section-5.4">Section 5.4</a> of [<a class="cite xref" href="#RFC9250">RFC9250</a>]</span>.
How much to pad is out of scope of this document, but a reasonable suggestion can be found in <span>[<a class="cite xref" href="#RFC8467">RFC8467</a>]</span>.<a class="pilcrow" href="#section-3.5-1">¶</a></p>
</section>
</div>
</section>
</div>
<div id="recursive-guidance">
<section id="section-4">
      <h2 id="name-guidance-for-recursive-reso">
<a class="section-number selfRef" href="#section-4">4. </a><a class="section-name selfRef" href="#name-guidance-for-recursive-reso">Guidance for Recursive Resolvers</a>
      </h2>
<p id="section-4-1">The protocol described in this document is <span class="bcp14">OPTIONAL</span> for recursive resolvers.
This section outlines a probing policy suitable for unilateral adoption by any recursive resolver.
Following this policy should not result in failed resolutions or significant delays.<a class="pilcrow" href="#section-4-1">¶</a></p>
<div id="high-level-overview">
<section id="section-4.1">
        <h3 id="name-high-level-overview">
<a class="section-number selfRef" href="#section-4.1">4.1. </a><a class="section-name selfRef" href="#name-high-level-overview">High-Level Overview</a>
        </h3>
<p id="section-4.1-1">In addition to querying on Do53, the recursive resolver will try DoT, DoQ, or both concurrently.
The recursive resolver remembers what opportunistic encrypted transport protocols have worked recently based on a (clientIP, serverIP, protocol) tuple.<a class="pilcrow" href="#section-4.1-1">¶</a></p>
<p id="section-4.1-2">If a query needs to go to a given authoritative server, and the recursive resolver remembers a recent successful encrypted transport to that server, then it doesn't send the query over Do53 at all.
Rather, it only sends the query using the encrypted transport protocol that was recently shown to be good.<a class="pilcrow" href="#section-4.1-2">¶</a></p>
<p id="section-4.1-3">If the encrypted transport protocol fails, the recursive resolver falls back to Do53 for that serverIP.
When any encrypted transport fails, the recursive resolver remembers that failure for a reasonable amount of time to avoid flooding an incompatible server with requests that it cannot accept.
The description of how an encrypted transport protocol fails is in <a class="auto internal xref" href="#establish-encrypted">Section 4.6.4</a> and the sections following that.<a class="pilcrow" href="#section-4.1-3">¶</a></p>
<p id="section-4.1-4">See the subsections below for a more detailed description of this protocol.<a class="pilcrow" href="#section-4.1-4">¶</a></p>
</section>
</div>
<div id="maintaining-authoritative-state-by-ip-address">
<section id="section-4.2">
        <h3 id="name-maintaining-authoritative-s">
<a class="section-number selfRef" href="#section-4.2">4.2. </a><a class="section-name selfRef" href="#name-maintaining-authoritative-s">Maintaining Authoritative State by IP Address</a>
        </h3>
<p id="section-4.2-1">In designing a probing strategy, the recursive resolver could record its knowledge about any given authoritative server with different strategies, including at least:<a class="pilcrow" href="#section-4.2-1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.2-2.1">
            <p id="section-4.2-2.1.1">the authoritative server's IP address,<a class="pilcrow" href="#section-4.2-2.1.1">¶</a></p>
</li>
          <li class="normal" id="section-4.2-2.2">
            <p id="section-4.2-2.2.1">the authoritative server's name (the NS record used), or<a class="pilcrow" href="#section-4.2-2.2.1">¶</a></p>
</li>
          <li class="normal" id="section-4.2-2.3">
            <p id="section-4.2-2.3.1">the zone that contains the record being looked up.<a class="pilcrow" href="#section-4.2-2.3.1">¶</a></p>
</li>
        </ul>
<p id="section-4.2-3">This document encourages the first strategy, to minimize timeouts or accidental delays,
and does not describe the other two strategies.<a class="pilcrow" href="#section-4.2-3">¶</a></p>
<p id="section-4.2-4">A timeout (accidental delay) is most likely to happen when the recursive client believes that the authoritative server offers encrypted transport, but the actual server reached declines encrypted transport (or worse, filters the incoming traffic and does not even respond with an ICMP destination port unreachable message, such as during rate limiting).<a class="pilcrow" href="#section-4.2-4">¶</a></p>
<p id="section-4.2-5">By associating the state with the authoritative IP address, the client can minimize the number of accidental delays introduced (see also Sections <a class="auto internal xref" href="#authoritative-pools">3.1</a> and <a class="auto internal xref" href="#conn-state">4.5</a>).<a class="pilcrow" href="#section-4.2-5">¶</a></p>
<p id="section-4.2-6">For example, consider an authoritative server named <code>ns0.example.com</code> that is served by two installations: one at <code>2001:db8::7</code> that follows this guidance and one at <code>2001:db8::8</code> that is a legacy (cleartext port 53-only) deployment.
A recursive client who associates state with the NS name and reaches <code>2001:db8::7</code> first will "learn" that <code>ns0.example.com</code> supports encrypted transport.
A subsequent query over encrypted transport dispatched to <code>2001:db8::8</code> would fail, potentially delaying the response.<a class="pilcrow" href="#section-4.2-6">¶</a></p>
</section>
</div>
<div id="overall-recursive-resolver-settings">
<section id="section-4.3">
        <h3 id="name-overall-recursive-resolver-">
<a class="section-number selfRef" href="#section-4.3">4.3. </a><a class="section-name selfRef" href="#name-overall-recursive-resolver-">Overall Recursive Resolver Settings</a>
        </h3>
<p id="section-4.3-1">A recursive resolver implementing the protocol in this document needs to set system-wide values for some default parameters.
These parameters may be set independently for each supported encrypted transport, though a simple implementation may keep the parameters constant across encrypted transports.<a class="pilcrow" href="#section-4.3-1">¶</a></p>
<span id="name-recursive-resolver-system-p"></span><table class="center" id="table-1">
          <caption>
<a class="selfRef" href="#table-1">Table 1</a>:
<a class="selfRef" href="#name-recursive-resolver-system-p">Recursive Resolver System Parameters per Encrypted Transport</a>
          </caption>
<thead>
            <tr>
              <th class="text-left" colspan="1" rowspan="1">Name</th>
              <th class="text-left" colspan="1" rowspan="1">Description</th>
              <th class="text-left" colspan="1" rowspan="1">Suggested Default</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" colspan="1" rowspan="1">
                <code>persistence</code>
</td>
              <td class="text-left" colspan="1" rowspan="1">How long the recursive resolver remembers a successful encrypted transport connection</td>
              <td class="text-left" colspan="1" rowspan="1">3 days (259200 seconds)</td>
            </tr>
            <tr>
              <td class="text-left" colspan="1" rowspan="1">
                <code>damping</code>
</td>
              <td class="text-left" colspan="1" rowspan="1">How long the recursive resolver remembers an unsuccessful encrypted transport connection</td>
              <td class="text-left" colspan="1" rowspan="1">1 day (86400 seconds)</td>
            </tr>
            <tr>
              <td class="text-left" colspan="1" rowspan="1">
                <code>timeout</code>
</td>
              <td class="text-left" colspan="1" rowspan="1">How long the recursive resolver waits for an initiated encrypted connection to complete</td>
              <td class="text-left" colspan="1" rowspan="1">4 seconds</td>
            </tr>
          </tbody>
        </table>
<p id="section-4.3-3">This document uses the notation <code>&lt;transport&gt;-foo</code> to refer to the <code>foo</code> parameter for the encrypted transport <code>&lt;transport&gt;</code>.
For example, <code>DoT-persistence</code> would indicate the length of time that the recursive resolver will remember that an authoritative server had a successful connection over DoT.
Additionally, when describing an arbitrary encrypted transport, we use <code>E</code> in place of <code>&lt;transport&gt;</code> to generically mean whatever encrypted transport is in use.
For example, when handling a query sent over encrypted transport <code>E</code>, a reference to <code>E-timeout</code> should be understood to mean <code>DoT-timeout</code> if the query is sent over DoT, and to mean <code>DoQ-timeout</code> if the query is sent over DoQ.<a class="pilcrow" href="#section-4.3-3">¶</a></p>
<p id="section-4.3-4">This document also assumes that the recursive resolver maintains a list of outstanding cleartext queries destined for the authoritative server's IP address <code>X</code>.
This list is referred to as "<code>Do53-queries[X]</code>"
This document does not attempt to describe the specific operation of sending and receiving cleartext DNS queries (Do53) for a recursive resolver.
Instead it describes a "bolt-on" mechanism that extends the recursive resolver's operation on a few simple hooks into the recursive resolver's existing handling of Do53.<a class="pilcrow" href="#section-4.3-4">¶</a></p>
<p id="section-4.3-5">Implementers or deployers of DNS recursive resolvers that follow the strategies in this document are encouraged to publish their preferred values of these parameters.<a class="pilcrow" href="#section-4.3-5">¶</a></p>
</section>
</div>
<div id="recursive-requirements">
<section id="section-4.4">
        <h3 id="name-recursive-resolver-requirem">
<a class="section-number selfRef" href="#section-4.4">4.4. </a><a class="section-name selfRef" href="#name-recursive-resolver-requirem">Recursive Resolver Requirements</a>
        </h3>
<p id="section-4.4-1">To follow the strategies in this document, a recursive resolver <span class="bcp14">MUST</span> implement at least one of either DoT or DoQ in its capacity as a client of authoritative nameservers.
A recursive resolver <span class="bcp14">SHOULD</span> implement the client side of DoT.
A recursive resolver <span class="bcp14">SHOULD</span> implement the client side of DoQ.<a class="pilcrow" href="#section-4.4-1">¶</a></p>
<p id="section-4.4-2">DoT queries from the recursive resolver <span class="bcp14">MUST</span> target TCP port 853 using an ALPN of "<code>dot</code>".
DoQ queries from the recursive resolver <span class="bcp14">MUST</span> target UDP port 853 using an ALPN of "<code>doq</code>".<a class="pilcrow" href="#section-4.4-2">¶</a></p>
<p id="section-4.4-3">While this document focuses on the recursive-to-authoritative hop, a recursive resolver implementing the strategies in this document <span class="bcp14">SHOULD</span> also accept queries from its clients over some encrypted transport unless it only accepts queries from the localhost.<a class="pilcrow" href="#section-4.4-3">¶</a></p>
</section>
</div>
<div id="conn-state">
<section id="section-4.5">
        <h3 id="name-authoritative-server-encryp">
<a class="section-number selfRef" href="#section-4.5">4.5. </a><a class="section-name selfRef" href="#name-authoritative-server-encryp">Authoritative Server Encrypted Transport Connection State</a>
        </h3>
<p id="section-4.5-1">The recursive resolver <span class="bcp14">SHOULD</span> keep a record of the state for each authoritative server it contacts, indexed by the IP address of the authoritative server and the encrypted transports supported by the recursive resolver.<a class="pilcrow" href="#section-4.5-1">¶</a></p>
<p id="section-4.5-2">Note that the recursive resolver might record this per-authoritative-IP state for each source IP address it uses as it sends its queries.
For example, if a recursive resolver can send a packet to authoritative servers from IP addresses <code>2001:db8::100</code> and <code>2001:db8::200</code>, it could keep two distinct sets of per-authoritative-IP state: one for each source address it uses, if the recursive resolver knows the addresses in use.
Keeping these state tables distinct for each source address makes it possible for a pooled authoritative server behind a load balancer to do a partial rollout while minimizing accidental timeouts (see <a class="auto internal xref" href="#authoritative-pools">Section 3.1</a>).<a class="pilcrow" href="#section-4.5-2">¶</a></p>
<p id="section-4.5-3">In addition to tracking the state of connection attempts and outcomes, a recursive resolver <span class="bcp14">SHOULD</span> record the state of established sessions for encrypted protocols.
The details of how sessions are identified are dependent on the transport protocol implementation (such as a TLS session ticket or TLS session ID, a QUIC connection ID, and so on).
The use of session resumption as recommended here is limited somewhat because the tickets are only stored within the context defined by the (clientIP, serverIP, protocols) tuples used to track client-server interaction by the recursive resolver in a table like the one below.
However, session resumption still offers the ability to optimize the handshake in some circumstances.<a class="pilcrow" href="#section-4.5-3">¶</a></p>
<p id="section-4.5-4">Each record should contain the following fields for each supported encrypted transport, each of which would initially be <code>null</code>:<a class="pilcrow" href="#section-4.5-4">¶</a></p>
<span id="name-recursive-resolver-state-pe"></span><table class="center" id="table-2">
          <caption>
<a class="selfRef" href="#table-2">Table 2</a>:
<a class="selfRef" href="#name-recursive-resolver-state-pe">Recursive Resolver State per-Authoritative-IP and per-Encrypted Transport</a>
          </caption>
<thead>
            <tr>
              <th class="text-left" colspan="1" rowspan="1">Name</th>
              <th class="text-left" colspan="1" rowspan="1">Description</th>
              <th class="text-left" colspan="1" rowspan="1">Retain Across Restart</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" colspan="1" rowspan="1">
                <code>session</code>
</td>
              <td class="text-left" colspan="1" rowspan="1">The associated state of any existing established session (the structure of this value is dependent on the encrypted transport implementation).  If <code>session</code> is not <code>null</code>, it may be in one of two states: <code>pending</code> or <code>established</code>.</td>
              <td class="text-left" colspan="1" rowspan="1">no</td>
            </tr>
            <tr>
              <td class="text-left" colspan="1" rowspan="1">
                <code>initiated</code>
</td>
              <td class="text-left" colspan="1" rowspan="1">Timestamp of the most recent connection attempt</td>
              <td class="text-left" colspan="1" rowspan="1">yes</td>
            </tr>
            <tr>
              <td class="text-left" colspan="1" rowspan="1">
                <code>completed</code>
</td>
              <td class="text-left" colspan="1" rowspan="1">Timestamp of the most recent completed handshake (which can include one where an existing session is resumed)</td>
              <td class="text-left" colspan="1" rowspan="1">yes</td>
            </tr>
            <tr>
              <td class="text-left" colspan="1" rowspan="1">
                <code>status</code>
</td>
              <td class="text-left" colspan="1" rowspan="1">Enumerated value of <code>success</code>, <code>fail</code>, or <code>timeout</code> associated with the <code>completed</code> handshake</td>
              <td class="text-left" colspan="1" rowspan="1">yes</td>
            </tr>
            <tr>
              <td class="text-left" colspan="1" rowspan="1">
                <code>last-response</code>
</td>
              <td class="text-left" colspan="1" rowspan="1">A timestamp of the most recent response received on the connection</td>
              <td class="text-left" colspan="1" rowspan="1">yes</td>
            </tr>
            <tr>
              <td class="text-left" colspan="1" rowspan="1">
                <code>resumptions</code>
</td>
              <td class="text-left" colspan="1" rowspan="1">A stack of resumption tickets (and associated parameters) that could be used to resume a prior successful session</td>
              <td class="text-left" colspan="1" rowspan="1">yes</td>
            </tr>
            <tr>
              <td class="text-left" colspan="1" rowspan="1">
                <code>queries</code>
</td>
              <td class="text-left" colspan="1" rowspan="1">A queue of queries intended for this authoritative server, each of which has additional status of <code>early</code>, <code>unsent</code>, or <code>sent</code>
</td>
              <td class="text-left" colspan="1" rowspan="1">no</td>
            </tr>
            <tr>
              <td class="text-left" colspan="1" rowspan="1">
                <code>last-activity</code>
</td>
              <td class="text-left" colspan="1" rowspan="1">A timestamp of the most recent activity on the connection</td>
              <td class="text-left" colspan="1" rowspan="1">no</td>
            </tr>
          </tbody>
        </table>
<p id="section-4.5-6">Note that the <code>session</code> fields in aggregate constitute a pool of open connections to different servers.<a class="pilcrow" href="#section-4.5-6">¶</a></p>
<p id="section-4.5-7">With the exception of the <code>session</code>, <code>queries</code>, and <code>last-activity</code> fields, this cache information should be kept across restart of the server unless explicitly cleared by administrative action.<a class="pilcrow" href="#section-4.5-7">¶</a></p>
<p id="section-4.5-8">This document uses the notation <code>E-foo[X]</code> to indicate the value of field <code>foo</code> for encrypted transport <code>E</code> to IP address <code>X</code>.<a class="pilcrow" href="#section-4.5-8">¶</a></p>
<p id="section-4.5-9">For example, <code>DoT-initiated[192.0.2.4]</code> represents the timestamp when the most recent DoT connection packet was sent to IP address <code>192.0.2.4</code>.<a class="pilcrow" href="#section-4.5-9">¶</a></p>
<p id="section-4.5-10">This document uses the notation <code>any-E-queries</code> to indicate any query on an encrypted transport.<a class="pilcrow" href="#section-4.5-10">¶</a></p>
</section>
</div>
<div id="probing-policy">
<section id="section-4.6">
        <h3 id="name-probing-policy">
<a class="section-number selfRef" href="#section-4.6">4.6. </a><a class="section-name selfRef" href="#name-probing-policy">Probing Policy</a>
        </h3>
<p id="section-4.6-1">When a recursive resolver discovers the need for an authoritative lookup to an authoritative DNS server using that server's IP address <code>X</code>, it retrieves the connection state records described in <a class="auto internal xref" href="#conn-state">Section 4.5</a> associated with <code>X</code> from its cache.<a class="pilcrow" href="#section-4.6-1">¶</a></p>
<p id="section-4.6-2">Some of the subsections that follow offer pseudocode that corresponds roughly to an asynchronous programming model for a recursive resolver's interactions with authoritative servers.
All subsections also presume that the time of the discovery of the need for lookup is time <code>T0</code>.<a class="pilcrow" href="#section-4.6-2">¶</a></p>
<p id="section-4.6-3">If any of the records discussed here are absent, they are treated as <code>null</code>.<a class="pilcrow" href="#section-4.6-3">¶</a></p>
<p id="section-4.6-4">The recursive resolver must decide whether to initially send a query over Do53, or over either of the supported encrypted transports (DoT or DoQ).<a class="pilcrow" href="#section-4.6-4">¶</a></p>
<p id="section-4.6-5">Note that a recursive resolver might initiate this query via any or all of the known transports.
When multiple queries are sent, the initial packets for each connection can be sent concurrently, similar to the method used in the document known as "Happy Eyeballs" (<span>[<a class="cite xref" href="#RFC8305">RFC8305</a>]</span>).
However, unlike Happy Eyeballs, when one transport succeeds, the other connections do not need to be terminated; instead they can be continued to establish whether the IP address <code>X</code> is capable of communicating on the relevant transport.<a class="pilcrow" href="#section-4.6-5">¶</a></p>
<div id="sending-a-query-over-do53">
<section id="section-4.6.1">
          <h4 id="name-sending-a-query-over-do53">
<a class="section-number selfRef" href="#section-4.6.1">4.6.1. </a><a class="section-name selfRef" href="#name-sending-a-query-over-do53">Sending a Query over Do53</a>
          </h4>
<p id="section-4.6.1-1">For any of the supported encrypted transports <code>E</code>, the recursive resolver <span class="bcp14">SHOULD NOT</span> send a query to <code>X</code>  over Do53 if either of the following holds true:<a class="pilcrow" href="#section-4.6.1-1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.1-2.1">
              <p id="section-4.6.1-2.1.1"><code>E-session[X]</code> is in the <code>established</code> state, or<a class="pilcrow" href="#section-4.6.1-2.1.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.1-2.2">
              <p id="section-4.6.1-2.2.1"><code>E-status[X]</code> is <code>success</code> and <code>(T0 - E-last-response[X]) &lt; persistence</code>.<a class="pilcrow" href="#section-4.6.1-2.2.1">¶</a></p>
</li>
          </ul>
<p id="section-4.6.1-3">This indicates that one successful connection to a server that the client then closed cleanly would result in the client not sending the next query over Do53.<a class="pilcrow" href="#section-4.6.1-3">¶</a></p>
<p id="section-4.6.1-4">Otherwise, if there is no outstanding session for any encrypted transport, and the last successful encrypted transport connection was long ago, the recursive resolver sends a query to <code>X</code> over Do53.
When it does so, it inserts a handle for the query in <code>Do53-queries[X]</code>.<a class="pilcrow" href="#section-4.6.1-4">¶</a></p>
</section>
</div>
<div id="receiving-a-response-over-do53">
<section id="section-4.6.2">
          <h4 id="name-receiving-a-response-over-d">
<a class="section-number selfRef" href="#section-4.6.2">4.6.2. </a><a class="section-name selfRef" href="#name-receiving-a-response-over-d">Receiving a Response over Do53</a>
          </h4>
<p id="section-4.6.2-1">When any response <code>R</code> (a well-formed DNS response, asynchronous timeout, asynchronous destination port unreachable, etc.) for query <code>Q</code> arrives at the recursive resolver in cleartext sent over Do53 from an authoritative server with IP address <code>X</code>, the recursive resolver should perform the following.<a class="pilcrow" href="#section-4.6.2-1">¶</a></p>
<p id="section-4.6.2-2">If <code>Q</code> is not in <code>Do53-queries[X]</code>:<a class="pilcrow" href="#section-4.6.2-2">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.2-3.1">
              <p id="section-4.6.2-3.1.1">process <code>R</code> no further (do not respond to a cleartext response to a query that is not outstanding).<a class="pilcrow" href="#section-4.6.2-3.1.1">¶</a></p>
</li>
          </ul>
<p id="section-4.6.2-4">Otherwise, if <code>Q</code> was marked as already processed:<a class="pilcrow" href="#section-4.6.2-4">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.2-5.1">
              <p id="section-4.6.2-5.1.1">remove <code>Q</code> from <code>Do53-queries[X]</code>,<a class="pilcrow" href="#section-4.6.2-5.1.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.2-5.2">
              <p id="section-4.6.2-5.2.1">discard any content from the response, and process <code>R</code> no further.<a class="pilcrow" href="#section-4.6.2-5.2.1">¶</a></p>
</li>
          </ul>
<p id="section-4.6.2-6">If <code>R</code> is a well-formed DNS response:<a class="pilcrow" href="#section-4.6.2-6">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.2-7.1">
              <p id="section-4.6.2-7.1.1">remove <code>Q</code> from <code>Do53-queries[X]</code>,<a class="pilcrow" href="#section-4.6.2-7.1.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.2-7.2">
              <p id="section-4.6.2-7.2.1">process <code>R</code> further, and<a class="pilcrow" href="#section-4.6.2-7.2.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.2-7.3">
              <p id="section-4.6.2-7.3.1">for each supported encrypted transport <code>E</code>:<a class="pilcrow" href="#section-4.6.2-7.3.1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.2-7.3.2.1">
                  <p id="section-4.6.2-7.3.2.1.1">if <code>Q</code> is in <code>E-queries[X]</code>, then<a class="pilcrow" href="#section-4.6.2-7.3.2.1.1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.2-7.3.2.1.2.1">
                      <p id="section-4.6.2-7.3.2.1.2.1.1">mark <code>Q</code> as already processed.<a class="pilcrow" href="#section-4.6.2-7.3.2.1.2.1.1">¶</a></p>
</li>
                  </ul>
</li>
              </ul>
</li>
          </ul>
<p id="section-4.6.2-8">However, if <code>R</code> is malformed or a failure (e.g., a timeout or destination port unreachable), and<a class="pilcrow" href="#section-4.6.2-8">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.2-9.1">
              <p id="section-4.6.2-9.1.1">if <code>Q</code> is not in any of <code>any-E-queries[X]</code>, then<a class="pilcrow" href="#section-4.6.2-9.1.1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.2-9.1.2.1">
                  <p id="section-4.6.2-9.1.2.1.1">treat this as a failed query (i.e., follow the resolver's policy for unresponsive or non-compliant authoritatives, such as falling back to another authoritative server, returning <code>SERVFAIL</code> to the requesting client, and so on).<a class="pilcrow" href="#section-4.6.2-9.1.2.1.1">¶</a></p>
</li>
              </ul>
</li>
          </ul>
</section>
</div>
<div id="initiating-a-connection-over-encrypted-transport">
<section id="section-4.6.3">
          <h4 id="name-initiating-a-connection-ove">
<a class="section-number selfRef" href="#section-4.6.3">4.6.3. </a><a class="section-name selfRef" href="#name-initiating-a-connection-ove">Initiating a Connection over Encrypted Transport</a>
          </h4>
<p id="section-4.6.3-1">If any <code>E-session[X]</code> is in the <code>established</code> state, the recursive resolver <span class="bcp14">SHOULD NOT</span> initiate a new connection or resume a previous connection to <code>X</code> over Do53 or <code>E</code>, but should instead send queries to <code>X</code> through the existing session (see <a class="auto internal xref" href="#sending">Section 4.6.8</a>).<a class="pilcrow" href="#section-4.6.3-1">¶</a></p>
<p id="section-4.6.3-2">If the recursive resolver prefers one encrypted transport over another, but only the unpreferred encrypted transport is in the <code>established</code> state, it <span class="bcp14">MAY</span> also initiate a new connection to <code>X</code> over its preferred encrypted transport while concurrently sending the query over the <code>established</code> encrypted transport <code>E</code>.<a class="pilcrow" href="#section-4.6.3-2">¶</a></p>
<p id="section-4.6.3-3">Before considering whether to initiate a new connection over an encrypted transport, the timer should be examined, and its state possibly refreshed, for encrypted transport <code>E</code> to authoritative IP address <code>X</code>.<a class="pilcrow" href="#section-4.6.3-3">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.3-4.1">
              <p id="section-4.6.3-4.1.1">If <code>E-session[X]</code> is in state <code>pending</code>, and<a class="pilcrow" href="#section-4.6.3-4.1.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.3-4.2">
              <p id="section-4.6.3-4.2.1"><code>T0 - E-initiated[X] &gt; E-timeout</code>, then<a class="pilcrow" href="#section-4.6.3-4.2.1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.3-4.2.2.1">
                  <p id="section-4.6.3-4.2.2.1.1">set <code>E-session[X]</code> to <code>null</code>, and<a class="pilcrow" href="#section-4.6.3-4.2.2.1.1">¶</a></p>
</li>
                <li class="normal" id="section-4.6.3-4.2.2.2">
                  <p id="section-4.6.3-4.2.2.2.1">set <code>E-status[X]</code> to <code>timeout</code>.<a class="pilcrow" href="#section-4.6.3-4.2.2.2.1">¶</a></p>
</li>
              </ul>
</li>
          </ul>
<p id="section-4.6.3-5">When resources are available to attempt a new encrypted transport, the recursive resolver should only initiate a new connection to <code>X</code> over <code>E</code> as long as one of the following holds true:<a class="pilcrow" href="#section-4.6.3-5">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.3-6.1">
              <p id="section-4.6.3-6.1.1"><code>E-status[X]</code> is <code>success</code>, or<a class="pilcrow" href="#section-4.6.3-6.1.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.3-6.2">
              <p id="section-4.6.3-6.2.1"><code>E-status[X]</code> is either <code>fail</code> or <code>timeout</code> and <code>(T0 - E-completed[X]) &gt; damping</code>, or<a class="pilcrow" href="#section-4.6.3-6.2.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.3-6.3">
              <p id="section-4.6.3-6.3.1"><code>E-status[X]</code> is <code>null</code> and <code>E-initiated[X]</code> is <code>null</code>.<a class="pilcrow" href="#section-4.6.3-6.3.1">¶</a></p>
</li>
          </ul>
<p id="section-4.6.3-7">When initiating a session to <code>X</code> over encrypted transport <code>E</code>, if <code>E-resumptions[X]</code> is not empty, one ticket should be popped off the stack and used to try to resume a previous session.
Otherwise, the initial ClientHello handshake should not try to resume any session.<a class="pilcrow" href="#section-4.6.3-7">¶</a></p>
<p id="section-4.6.3-8">When initiating a connection, the recursive resolver should take the following steps:<a class="pilcrow" href="#section-4.6.3-8">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.3-9.1">
              <p id="section-4.6.3-9.1.1">set <code>E-initiated[X]</code> to <code>T0</code>,<a class="pilcrow" href="#section-4.6.3-9.1.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.3-9.2">
              <p id="section-4.6.3-9.2.1">store a handle for the new session (which should have <code>pending</code> state) in <code>E-session[X]</code>, and<a class="pilcrow" href="#section-4.6.3-9.2.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.3-9.3">
              <p id="section-4.6.3-9.3.1">insert a handle for the query that prompted this connection in <code>E-queries[X]</code>, with status <code>unsent</code> or <code>early</code>, as appropriate (see below).<a class="pilcrow" href="#section-4.6.3-9.3.1">¶</a></p>
</li>
          </ul>
<div id="early-data">
<section id="section-4.6.3.1">
            <h5 id="name-early-data">
<a class="section-number selfRef" href="#section-4.6.3.1">4.6.3.1. </a><a class="section-name selfRef" href="#name-early-data">Early Data</a>
            </h5>
<p id="section-4.6.3.1-1">Modern encrypted transports like TLS 1.3 offer the chance to send "early data" from the client in the initial ClientHello in some contexts.
A recursive resolver that initiates a connection over an encrypted transport according to this guidance in a context where early data is possible <span class="bcp14">SHOULD</span> send the DNS query that prompted the connection in the early data, according to the sending guidance in <a class="auto internal xref" href="#sending">Section 4.6.8</a>.<a class="pilcrow" href="#section-4.6.3.1-1">¶</a></p>
<p id="section-4.6.3.1-2">If it does so, the status of <code>Q</code> in <code>E-queries[X]</code> should be set to <code>early</code> instead of <code>unsent</code>.<a class="pilcrow" href="#section-4.6.3.1-2">¶</a></p>
</section>
</div>
<div id="resumption">
<section id="section-4.6.3.2">
            <h5 id="name-resumption-tickets">
<a class="section-number selfRef" href="#section-4.6.3.2">4.6.3.2. </a><a class="section-name selfRef" href="#name-resumption-tickets">Resumption Tickets</a>
            </h5>
<p id="section-4.6.3.2-1">When initiating a new connection (whether by resuming an old session or not), the recursive resolver <span class="bcp14">SHOULD</span> request a session resumption ticket from the authoritative server.
If the authoritative server supplies a resumption ticket, the recursive resolver pushes it into the stack at <code>E-resumptions[X]</code>.<a class="pilcrow" href="#section-4.6.3.2-1">¶</a></p>
</section>
</div>
<div id="recursive-sni">
<section id="section-4.6.3.3">
            <h5 id="name-server-name-indication-2">
<a class="section-number selfRef" href="#section-4.6.3.3">4.6.3.3. </a><a class="section-name selfRef" href="#name-server-name-indication-2">Server Name Indication</a>
            </h5>
<p id="section-4.6.3.3-1">For modern encrypted transports like TLS 1.3, most client implementations expect to send a Server Name Indication (SNI) in the ClientHello.<a class="pilcrow" href="#section-4.6.3.3-1">¶</a></p>
<p id="section-4.6.3.3-2">There are two complications with selecting or sending an SNI in this unilateral probing.<a class="pilcrow" href="#section-4.6.3.3-2">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.3.3-3.1">
                <p id="section-4.6.3.3-3.1.1">Some authoritative servers are known by more than one name; selecting a single name to use for a given connection may be difficult or impossible.<a class="pilcrow" href="#section-4.6.3.3-3.1.1">¶</a></p>
</li>
              <li class="normal" id="section-4.6.3.3-3.2">
                <p id="section-4.6.3.3-3.2.1">In most configurations, the contents of the SNI field are exposed on the wire to a passive adversary.
This potentially reveals additional information about which query is being made based on the NS of the query itself.<a class="pilcrow" href="#section-4.6.3.3-3.2.1">¶</a></p>
</li>
            </ul>
<p id="section-4.6.3.3-4">To avoid additional leakage and complexity, a recursive resolver following this guidance <span class="bcp14">SHOULD NOT</span> send an SNI to the authoritative server when attempting encrypted transport.<a class="pilcrow" href="#section-4.6.3.3-4">¶</a></p>
<p id="section-4.6.3.3-5">If the recursive resolver needs to send an SNI to the authoritative server for some reason not found in this document, using Encrypted ClientHello (<span>[<a class="cite xref" href="#I-D.ietf-tls-esni">TLS-ECH</a>]</span>) would reduce leakage.<a class="pilcrow" href="#section-4.6.3.3-5">¶</a></p>
</section>
</div>
<div id="authoritative-server-authentication">
<section id="section-4.6.3.4">
            <h5 id="name-authoritative-server-authen">
<a class="section-number selfRef" href="#section-4.6.3.4">4.6.3.4. </a><a class="section-name selfRef" href="#name-authoritative-server-authen">Authoritative Server Authentication</a>
            </h5>
<p id="section-4.6.3.4-1">Because this probing policy is unilateral and opportunistic, the client connecting under this policy <span class="bcp14">MUST</span> accept any certificate presented by the server.
If the client cannot verify the server's identity, it <span class="bcp14">MAY</span> use that information for reporting, logging, or other analysis purposes; however, it <span class="bcp14">MUST NOT</span> reject the connection due to the authentication failure, as the result would be falling back to cleartext, which would leak the content of the session to a passive network monitor.<a class="pilcrow" href="#section-4.6.3.4-1">¶</a></p>
</section>
</div>
</section>
</div>
<div id="establish-encrypted">
<section id="section-4.6.4">
          <h4 id="name-establishing-an-encrypted-t">
<a class="section-number selfRef" href="#section-4.6.4">4.6.4. </a><a class="section-name selfRef" href="#name-establishing-an-encrypted-t">Establishing an Encrypted Transport Connection</a>
          </h4>
<p id="section-4.6.4-1">When an encrypted transport connection actually completes (e.g., the TLS handshake completes) at time <code>T1</code>, the recursive resolver sets <code>E-completed[X]</code> to <code>T1</code> and does the following.<a class="pilcrow" href="#section-4.6.4-1">¶</a></p>
<p id="section-4.6.4-2">If the handshake completed successfully, the recursive resolver:<a class="pilcrow" href="#section-4.6.4-2">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.4-3.1">
              <p id="section-4.6.4-3.1.1">updates <code>E-session[X]</code> so that it is in state <code>established</code>,<a class="pilcrow" href="#section-4.6.4-3.1.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.4-3.2">
              <p id="section-4.6.4-3.2.1">sets <code>E-status[X]</code> to <code>success</code>,<a class="pilcrow" href="#section-4.6.4-3.2.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.4-3.3">
              <p id="section-4.6.4-3.3.1">sets <code>E-last-response[X]</code> to <code>T1</code>,<a class="pilcrow" href="#section-4.6.4-3.3.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.4-3.4">
              <p id="section-4.6.4-3.4.1">sets <code>E-completed[X]</code> to <code>T1</code>, and<a class="pilcrow" href="#section-4.6.4-3.4.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.4-3.5">
              <p id="section-4.6.4-3.5.1">for each query <code>Q</code> in <code>E-queries[X]</code>:<a class="pilcrow" href="#section-4.6.4-3.5.1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.4-3.5.2.1">
                  <p id="section-4.6.4-3.5.2.1.1">if early data was accepted and <code>Q</code> is <code>early</code>, then<a class="pilcrow" href="#section-4.6.4-3.5.2.1.1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.4-3.5.2.1.2.1">
                      <p id="section-4.6.4-3.5.2.1.2.1.1">sets the status of <code>Q</code> to <code>sent</code>.<a class="pilcrow" href="#section-4.6.4-3.5.2.1.2.1.1">¶</a></p>
</li>
                  </ul>
</li>
                <li class="normal" id="section-4.6.4-3.5.2.2">
                  <p id="section-4.6.4-3.5.2.2.1">Otherwise:<a class="pilcrow" href="#section-4.6.4-3.5.2.2.1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.4-3.5.2.2.2.1">
                      <p id="section-4.6.4-3.5.2.2.2.1.1">sends <code>Q</code> through the session (see <a class="auto internal xref" href="#sending">Section 4.6.8</a>) and sets the status of <code>Q</code> to <code>sent</code>.<a class="pilcrow" href="#section-4.6.4-3.5.2.2.2.1.1">¶</a></p>
</li>
                  </ul>
</li>
              </ul>
</li>
          </ul>
</section>
</div>
<div id="failing-to-establish-an-encrypted-transport-connection">
<section id="section-4.6.5">
          <h4 id="name-failing-to-establish-an-enc">
<a class="section-number selfRef" href="#section-4.6.5">4.6.5. </a><a class="section-name selfRef" href="#name-failing-to-establish-an-enc">Failing to Establish an Encrypted Transport Connection</a>
          </h4>
<p id="section-4.6.5-1">If, at time <code>T2</code>, an encrypted transport handshake completes with a failure (e.g., a TLS alert):<a class="pilcrow" href="#section-4.6.5-1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.5-2.1">
              <p id="section-4.6.5-2.1.1">set <code>E-session[X]</code> to <code>null</code>,<a class="pilcrow" href="#section-4.6.5-2.1.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.5-2.2">
              <p id="section-4.6.5-2.2.1">set <code>E-status[X]</code> to <code>fail</code>,<a class="pilcrow" href="#section-4.6.5-2.2.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.5-2.3">
              <p id="section-4.6.5-2.3.1">set <code>E-completed[X]</code> to <code>T2</code>, and<a class="pilcrow" href="#section-4.6.5-2.3.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.5-2.4">
              <p id="section-4.6.5-2.4.1">for each query <code>Q</code> in <code>E-queries[X]</code>:<a class="pilcrow" href="#section-4.6.5-2.4.1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.5-2.4.2.1">
                  <p id="section-4.6.5-2.4.2.1.1">if <code>Q</code> is not present in any other <code>any-E-queries[X]</code> or in <code>Do53-queries[X]</code>, add <code>Q</code> to <code>Do53-queries[X]</code> and send query <code>Q</code> to <code>X</code> over Do53.<a class="pilcrow" href="#section-4.6.5-2.4.2.1.1">¶</a></p>
</li>
              </ul>
</li>
          </ul>
<p id="section-4.6.5-3">Note that this failure will trigger the recursive resolver to fall back to cleartext queries to the authoritative server at IP address <code>X</code>.
It will retry encrypted transport to <code>X</code> once the <code>damping</code> timer has elapsed.<a class="pilcrow" href="#section-4.6.5-3">¶</a></p>
</section>
</div>
<div id="e-failure">
<section id="section-4.6.6">
          <h4 id="name-encrypted-transport-failure">
<a class="section-number selfRef" href="#section-4.6.6">4.6.6. </a><a class="section-name selfRef" href="#name-encrypted-transport-failure">Encrypted Transport Failure</a>
          </h4>
<p id="section-4.6.6-1">Once established, an encrypted transport might fail for a number of reasons (e.g., decryption failure or improper protocol sequence).<a class="pilcrow" href="#section-4.6.6-1">¶</a></p>
<p id="section-4.6.6-2">If this happens:<a class="pilcrow" href="#section-4.6.6-2">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.6-3.1">
              <p id="section-4.6.6-3.1.1">set <code>E-session[X]</code> to <code>null</code>,<a class="pilcrow" href="#section-4.6.6-3.1.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.6-3.2">
              <p id="section-4.6.6-3.2.1">set <code>E-status[X]</code> to <code>fail</code>, and<a class="pilcrow" href="#section-4.6.6-3.2.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.6-3.3">
              <p id="section-4.6.6-3.3.1">for each query <code>Q</code> in <code>E-queries[X]</code>:<a class="pilcrow" href="#section-4.6.6-3.3.1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.6-3.3.2.1">
                  <p id="section-4.6.6-3.3.2.1.1">if <code>Q</code> is not present in any other <code>any-E-queries[X]</code> or in <code>Do53-queries[X]</code>, add <code>Q</code> to <code>Do53-queries[X]</code> and send query <code>Q</code> to <code>X</code> over Do53.<a class="pilcrow" href="#section-4.6.6-3.3.2.1.1">¶</a></p>
</li>
              </ul>
</li>
          </ul>
<p id="section-4.6.6-4">Note that this failure will trigger the recursive resolver to fall back to cleartext queries to the authoritative server at IP address <code>X</code>.
It will retry encrypted transport to <code>X</code> once the <code>damping</code> timer has elapsed.<a class="pilcrow" href="#section-4.6.6-4">¶</a></p>
</section>
</div>
<div id="e-shutdown">
<section id="section-4.6.7">
          <h4 id="name-handling-clean-shutdown-of-">
<a class="section-number selfRef" href="#section-4.6.7">4.6.7. </a><a class="section-name selfRef" href="#name-handling-clean-shutdown-of-">Handling Clean Shutdown of an Encrypted Transport Connection</a>
          </h4>
<p id="section-4.6.7-1">At time <code>T3</code>, the recursive resolver may find that authoritative server <code>X</code> cleanly closes an existing outstanding connection (most likely due to resource exhaustion, see <a class="auto internal xref" href="#authoritative-resource-exhaustion">Section 3.4</a>).<a class="pilcrow" href="#section-4.6.7-1">¶</a></p>
<p id="section-4.6.7-2">When this happens:<a class="pilcrow" href="#section-4.6.7-2">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.7-3.1">
              <p id="section-4.6.7-3.1.1">set <code>E-session[X]</code> to <code>null</code>, and<a class="pilcrow" href="#section-4.6.7-3.1.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.7-3.2">
              <p id="section-4.6.7-3.2.1">for each query <code>Q</code> in <code>E-queries[X]</code>:<a class="pilcrow" href="#section-4.6.7-3.2.1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.7-3.2.2.1">
                  <p id="section-4.6.7-3.2.2.1.1">if <code>Q</code> is not present in any other <code>any-E-queries[X]</code> or in <code>Do53-queries[X]</code>, add <code>Q</code> to <code>Do53-queries[X]</code> and send query <code>Q</code> to <code>X</code> over Do53.<a class="pilcrow" href="#section-4.6.7-3.2.2.1.1">¶</a></p>
</li>
              </ul>
</li>
          </ul>
<p id="section-4.6.7-4">Note that this premature shutdown will trigger the recursive resolver to fall back to cleartext queries to the authoritative server at IP address <code>X</code>.
Any subsequent query to <code>X</code> will retry the encrypted connection promptly.<a class="pilcrow" href="#section-4.6.7-4">¶</a></p>
</section>
</div>
<div id="sending">
<section id="section-4.6.8">
          <h4 id="name-sending-a-query-over-encryp">
<a class="section-number selfRef" href="#section-4.6.8">4.6.8. </a><a class="section-name selfRef" href="#name-sending-a-query-over-encryp">Sending a Query over Encrypted Transport</a>
          </h4>
<p id="section-4.6.8-1">When sending a query to an authoritative server over encrypted transport at time <code>T4</code>, the recursive resolver should take a few reasonable steps to ensure privacy and efficiency.
After sending query <code>Q</code>, the recursive resolver should:<a class="pilcrow" href="#section-4.6.8-1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.8-2.1">Ensure that <code>Q</code>'s state in <code>E-queries[X]</code> is set to <code>sent</code>.<a class="pilcrow" href="#section-4.6.8-2.1">¶</a>
</li>
            <li class="normal" id="section-4.6.8-2.2">Set <code>E-last-activity[X]</code> to <code>T4</code>.<a class="pilcrow" href="#section-4.6.8-2.2">¶</a>
</li>
          </ul>
<p id="section-4.6.8-3">The recursive resolver should also consider the guidance in the following subsections.<a class="pilcrow" href="#section-4.6.8-3">¶</a></p>
<div id="pad-queries-to-mitigate-traffic-analysis">
<section id="section-4.6.8.1">
            <h5 id="name-pad-queries-to-mitigate-tra">
<a class="section-number selfRef" href="#section-4.6.8.1">4.6.8.1. </a><a class="section-name selfRef" href="#name-pad-queries-to-mitigate-tra">Pad Queries to Mitigate Traffic Analysis</a>
            </h5>
<p id="section-4.6.8.1-1">To increase the anonymity set for each query, the recursive resolver <span class="bcp14">SHOULD</span> use a sensible padding mechanism for all queries it sends.
Specifically, a DoT client <span class="bcp14">SHOULD</span> use EDNS0 padding <span>[<a class="cite xref" href="#RFC7830">RFC7830</a>]</span>, and a DoQ client <span class="bcp14">SHOULD</span> follow the guidance in <span><a class="relref" href="https://rfc-editor.org/rfc/rfc9250#section-5.4">Section 5.4</a> of [<a class="cite xref" href="#RFC9250">RFC9250</a>]</span>.
How much to pad is out of scope of this document, but a reasonable suggestion can be found in <span>[<a class="cite xref" href="#RFC8467">RFC8467</a>]</span>.<a class="pilcrow" href="#section-4.6.8.1-1">¶</a></p>
</section>
</div>
<div id="send-queries-in-separate-channels">
<section id="section-4.6.8.2">
            <h5 id="name-send-queries-in-separate-ch">
<a class="section-number selfRef" href="#section-4.6.8.2">4.6.8.2. </a><a class="section-name selfRef" href="#name-send-queries-in-separate-ch">Send Queries in Separate Channels</a>
            </h5>
<p id="section-4.6.8.2-1">When multiple queries are multiplexed on a single encrypted transport to a single authoritative server, the recursive resolver <span class="bcp14">SHOULD</span> pipeline queries and <span class="bcp14">MUST</span> be capable of receiving responses out of order.
For guidance on how to best achieve this on a given encrypted transport, see <span><a class="relref" href="https://rfc-editor.org/rfc/rfc7766#section-6.2.1.1">Section 6.2.1.1</a> of [<a class="cite xref" href="#RFC7766">RFC7766</a>]</span> (for DoT) and <span><a class="relref" href="https://rfc-editor.org/rfc/rfc9250#section-5.6">Section 5.6</a> of [<a class="cite xref" href="#RFC9250">RFC9250</a>]</span> (for DoQ).<a class="pilcrow" href="#section-4.6.8.2-1">¶</a></p>
</section>
</div>
</section>
</div>
<div id="receiving-encrypted">
<section id="section-4.6.9">
          <h4 id="name-receiving-a-response-over-e">
<a class="section-number selfRef" href="#section-4.6.9">4.6.9. </a><a class="section-name selfRef" href="#name-receiving-a-response-over-e">Receiving a Response over Encrypted Transport</a>
          </h4>
<p id="section-4.6.9-1">Even though session-level events on encrypted transports like clean shutdown (see <a class="auto internal xref" href="#e-shutdown">Section 4.6.7</a>) or encrypted transport failure (see <a class="auto internal xref" href="#e-failure">Section 4.6.6</a>) can happen, some events happen on encrypted transports that are specific to a query and are not session-wide.
This subsection describes how the recursive resolver deals with events related to a specific query.<a class="pilcrow" href="#section-4.6.9-1">¶</a></p>
<p id="section-4.6.9-2">When a query-specific response <code>R</code> (a well-formed DNS response or an asynchronous timeout) associated with query <code>Q</code> arrives at the recursive resolver over encrypted transport <code>E</code> from an authoritative server with IP address <code>X</code> at time <code>T5</code>, the recursive resolver should perform the following.<a class="pilcrow" href="#section-4.6.9-2">¶</a></p>
<p id="section-4.6.9-3">If <code>Q</code> is not in <code>E-queries[X]</code>:<a class="pilcrow" href="#section-4.6.9-3">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.9-4.1">
              <p id="section-4.6.9-4.1.1">discard the response and process <code>R</code> no further (do not respond to an encrypted response to a query that is not outstanding).<a class="pilcrow" href="#section-4.6.9-4.1.1">¶</a></p>
</li>
          </ul>
<p id="section-4.6.9-5">Otherwise:<a class="pilcrow" href="#section-4.6.9-5">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.9-6.1">
              <p id="section-4.6.9-6.1.1">remove <code>Q</code> from <code>E-queries[X]</code>,<a class="pilcrow" href="#section-4.6.9-6.1.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.9-6.2">
              <p id="section-4.6.9-6.2.1">set <code>E-last-activity[X]</code> to <code>T5</code>, and<a class="pilcrow" href="#section-4.6.9-6.2.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.9-6.3">
              <p id="section-4.6.9-6.3.1">set <code>E-last-response[X]</code> to <code>T5</code>.<a class="pilcrow" href="#section-4.6.9-6.3.1">¶</a></p>
</li>
          </ul>
<p id="section-4.6.9-7">If <code>Q</code> was marked as already processed:<a class="pilcrow" href="#section-4.6.9-7">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.9-8.1">
              <p id="section-4.6.9-8.1.1">discard the response and process the response no further.<a class="pilcrow" href="#section-4.6.9-8.1.1">¶</a></p>
</li>
          </ul>
<p id="section-4.6.9-9">If <code>R</code> is a well-formed DNS response:<a class="pilcrow" href="#section-4.6.9-9">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.9-10.1">
              <p id="section-4.6.9-10.1.1">process <code>R</code> further, and<a class="pilcrow" href="#section-4.6.9-10.1.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.9-10.2">
              <p id="section-4.6.9-10.2.1">for each supported encrypted transport <code>N</code> other than <code>E</code>:<a class="pilcrow" href="#section-4.6.9-10.2.1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.9-10.2.2.1">
                  <p id="section-4.6.9-10.2.2.1.1">if <code>Q</code> is in <code>N-queries[X]</code>, then<a class="pilcrow" href="#section-4.6.9-10.2.2.1.1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.9-10.2.2.1.2.1">
                      <p id="section-4.6.9-10.2.2.1.2.1.1">mark <code>Q</code> as already processed.<a class="pilcrow" href="#section-4.6.9-10.2.2.1.2.1.1">¶</a></p>
</li>
                  </ul>
</li>
              </ul>
</li>
            <li class="normal" id="section-4.6.9-10.3">
              <p id="section-4.6.9-10.3.1">If <code>Q</code> is in <code>Do53-queries[X]</code>:<a class="pilcrow" href="#section-4.6.9-10.3.1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.9-10.3.2.1">
                  <p id="section-4.6.9-10.3.2.1.1">mark <code>Q</code> as already processed.<a class="pilcrow" href="#section-4.6.9-10.3.2.1.1">¶</a></p>
</li>
              </ul>
</li>
          </ul>
<p id="section-4.6.9-11">However, if <code>R</code> is malformed or a failure (e.g., timeout), and<a class="pilcrow" href="#section-4.6.9-11">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.9-12.1">
              <p id="section-4.6.9-12.1.1">if <code>Q</code> is not in <code>Do53-queries[X]</code> or in any of <code>any-E-queries[X]</code>, then<a class="pilcrow" href="#section-4.6.9-12.1.1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.9-12.1.2.1">
                  <p id="section-4.6.9-12.1.2.1.1">treat this as a failed query (i.e., follow the resolver's policy for unresponsive or non-compliant authoritative servers, such as falling back to another authoritative server, returning <code>SERVFAIL</code> to the requesting client, and so on).<a class="pilcrow" href="#section-4.6.9-12.1.2.1.1">¶</a></p>
</li>
              </ul>
</li>
          </ul>
</section>
</div>
<div id="recursive-resource-exhaustion">
<section id="section-4.6.10">
          <h4 id="name-resource-exhaustion-2">
<a class="section-number selfRef" href="#section-4.6.10">4.6.10. </a><a class="section-name selfRef" href="#name-resource-exhaustion-2">Resource Exhaustion</a>
          </h4>
<p id="section-4.6.10-1">To keep resources under control, a recursive resolver should proactively manage outstanding encrypted connections.
<span><a class="relref" href="https://rfc-editor.org/rfc/rfc9250#section-5.5">Section 5.5</a> of [<a class="cite xref" href="#RFC9250">RFC9250</a>]</span> offers useful guidance for clients managing DoQ connections.
<span><a class="relref" href="https://rfc-editor.org/rfc/rfc7858#section-3.4">Section 3.4</a> of [<a class="cite xref" href="#RFC7858">RFC7858</a>]</span> offers useful guidance for clients managing DoT connections.<a class="pilcrow" href="#section-4.6.10-1">¶</a></p>
<p id="section-4.6.10-2">Even with sensible connection management, a recursive resolver doing unilateral probing may find resources unexpectedly scarce and may need to close some outstanding connections.<a class="pilcrow" href="#section-4.6.10-2">¶</a></p>
<p id="section-4.6.10-3">In such a situation, the recursive resolver <span class="bcp14">SHOULD</span> use a reasonable prioritization scheme to close outstanding connections.<a class="pilcrow" href="#section-4.6.10-3">¶</a></p>
<p id="section-4.6.10-4">One reasonable prioritization scheme would be to close outstanding <code>established</code> sessions based on <code>E-last-activity[X]</code> (i.e, the oldest timestamp gets closed first).<a class="pilcrow" href="#section-4.6.10-4">¶</a></p>
<p id="section-4.6.10-5">Note that when resources are limited, a recursive resolver following this guidance may also choose not to initiate new connections for encrypted transport.<a class="pilcrow" href="#section-4.6.10-5">¶</a></p>
</section>
</div>
<div id="maintaining-connections">
<section id="section-4.6.11">
          <h4 id="name-maintaining-connections">
<a class="section-number selfRef" href="#section-4.6.11">4.6.11. </a><a class="section-name selfRef" href="#name-maintaining-connections">Maintaining Connections</a>
          </h4>
<p id="section-4.6.11-1">Some recursive resolvers looking to amortize connection costs and minimize latency <span class="bcp14">MAY</span> choose to synthesize queries to a particular authoritative server to keep an encrypted transport session active.<a class="pilcrow" href="#section-4.6.11-1">¶</a></p>
<p id="section-4.6.11-2">A recursive resolver that adopts this approach should try to align the synthesized queries with other optimizations.
For example, a recursive resolver that "pre-fetches" a particular resource record to keep its cache "hot" can send that query over an established encrypted transport session.<a class="pilcrow" href="#section-4.6.11-2">¶</a></p>
</section>
</div>
<div id="additional-tuning">
<section id="section-4.6.12">
          <h4 id="name-additional-tuning">
<a class="section-number selfRef" href="#section-4.6.12">4.6.12. </a><a class="section-name selfRef" href="#name-additional-tuning">Additional Tuning</a>
          </h4>
<p id="section-4.6.12-1">A recursive resolver's state table for an authoritative server can contain additional information beyond what is described above.
The recursive resolver might use that additional state to change the way it interacts with the authoritative server in the future.
Some examples of additional states include the following.<a class="pilcrow" href="#section-4.6.12-1">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.12-2.1">
              <p id="section-4.6.12-2.1.1">Whether the server accepts "early data" over a transport such as DoQ.<a class="pilcrow" href="#section-4.6.12-2.1.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.12-2.2">
              <p id="section-4.6.12-2.2.1">Whether the server fails to respond to queries after the handshake succeeds.<a class="pilcrow" href="#section-4.6.12-2.2.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.12-2.3">
              <p id="section-4.6.12-2.3.1">Tracking the round-trip time of queries to the server.<a class="pilcrow" href="#section-4.6.12-2.3.1">¶</a></p>
</li>
            <li class="normal" id="section-4.6.12-2.4">
              <p id="section-4.6.12-2.4.1">Tracking the number of timeouts (compared to the number of successful queries).<a class="pilcrow" href="#section-4.6.12-2.4.1">¶</a></p>
</li>
          </ul>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="iana-considerations">
<section id="section-5">
      <h2 id="name-iana-considerations">
<a class="section-number selfRef" href="#section-5">5. </a><a class="section-name selfRef" href="#name-iana-considerations">IANA Considerations</a>
      </h2>
<p id="section-5-1">This document has no IANA actions.<a class="pilcrow" href="#section-5-1">¶</a></p>
</section>
</div>
<div id="privacy-considerations">
<section id="section-6">
      <h2 id="name-privacy-considerations">
<a class="section-number selfRef" href="#section-6">6. </a><a class="section-name selfRef" href="#name-privacy-considerations">Privacy Considerations</a>
      </h2>
<div id="sni-considerations">
<section id="section-6.1">
        <h3 id="name-server-name-indication-3">
<a class="section-number selfRef" href="#section-6.1">6.1. </a><a class="section-name selfRef" href="#name-server-name-indication-3">Server Name Indication</a>
        </h3>
<p id="section-6.1-1">A recursive resolver querying an authoritative server over DoT or DoQ that sends a Server Name Indication (SNI) in the clear in the cryptographic handshake leaks information about the intended query to a passive network observer.<a class="pilcrow" href="#section-6.1-1">¶</a></p>
<p id="section-6.1-2">In particular, if two different zones refer to the same nameserver IP addresses via differently named NS records, a passive network observer can distinguish the queries to one zone from the queries to the other.<a class="pilcrow" href="#section-6.1-2">¶</a></p>
<p id="section-6.1-3">Omitting SNI entirely, or using Encrypted ClientHello to hide the intended SNI, avoids this additional leakage.
However, a series of queries that leak this information is still an improvement over cleartext.<a class="pilcrow" href="#section-6.1-3">¶</a></p>
</section>
</div>
<div id="modeling-the-probability-of-encryption">
<section id="section-6.2">
        <h3 id="name-modeling-the-probability-of">
<a class="section-number selfRef" href="#section-6.2">6.2. </a><a class="section-name selfRef" href="#name-modeling-the-probability-of">Modeling the Probability of Encryption</a>
        </h3>
<p id="section-6.2-1">Given that there are many parameter choices that can be made by recursive resolvers and authoritative servers, it is reasonable to consider the probability that queries would be encrypted.
Such a measurement would also certainly be affected by the types of queries being sent by the recursive resolver, which, in turn, is also related to the types of queries that are sent to the recursive resolver by the stub resolvers and forwarders downstream.
Doing this type of research would be valuable to the DNS community after initial implementation by a variety of recursive resolvers and authoritative servers because it would help assess the overall DNS privacy value of implementing the protocol.
Thus, it would be useful if recursive resolvers and authoritative servers reported percentages of queries sent and received over the different transports.<a class="pilcrow" href="#section-6.2-1">¶</a></p>
</section>
</div>
</section>
</div>
<div id="security-considerations">
<section id="section-7">
      <h2 id="name-security-considerations">
<a class="section-number selfRef" href="#section-7">7. </a><a class="section-name selfRef" href="#name-security-considerations">Security Considerations</a>
      </h2>
<p id="section-7-1">The guidance in this document provides defense against passive network monitors for most queries.
It does not defend against active attackers.
It can also leak some queries and their responses due to Happy Eyeballs optimizations (<span>[<a class="cite xref" href="#RFC8305">RFC8305</a>]</span>) when the recursive resolver's cache is cold.<a class="pilcrow" href="#section-7-1">¶</a></p>
<p id="section-7-2">Implementation of the guidance in this document should increase deployment of opportunistic encrypted DNS transport between recursive resolvers and authoritative servers at little operational risk.<a class="pilcrow" href="#section-7-2">¶</a></p>
<p id="section-7-3">However, implementers cannot rely on the guidance in this document for robust defense against active attackers: they should treat it as a stepping stone en route to stronger defense.<a class="pilcrow" href="#section-7-3">¶</a></p>
<p id="section-7-4">In particular, a recursive resolver following the guidance in this document can easily be forced by an active attacker to fall back to cleartext DNS queries.
Or, an active attacker could position itself as a machine-in-the-middle, which the recursive resolver would not defend against or detect due to lack of server authentication.
Defending against these attacks without risking additional unexpected protocol failures would require signaling and coordination that are out of scope for this document.<a class="pilcrow" href="#section-7-4">¶</a></p>
<p id="section-7-5">This guidance is only one part of operating a privacy-preserving DNS ecosystem.
A privacy-preserving recursive resolver should adopt other practices as well, such as QNAME minimization (<span>[<a class="cite xref" href="#RFC9156">RFC9156</a>]</span>), local root zone (<span>[<a class="cite xref" href="#RFC8806">RFC8806</a>]</span>), etc., to reduce the overall leakage of query information that could infringe on the client's privacy.<a class="pilcrow" href="#section-7-5">¶</a></p>
</section>
</div>
<div id="operational-considerations">
<section id="section-8">
      <h2 id="name-operational-considerations">
<a class="section-number selfRef" href="#section-8">8. </a><a class="section-name selfRef" href="#name-operational-considerations">Operational Considerations</a>
      </h2>
<p id="section-8-1">As recursive resolvers implement this protocol, authoritative servers will see more probing on port 853 of IP addresses that are associated with NS records.
Such probing of an authoritative server should generally not cause any significant problems.  If the authoritative server is not supporting this protocol, it will not respond on port 853; if it is supporting this protocol, it will act accordingly.<a class="pilcrow" href="#section-8-1">¶</a></p>
<p id="section-8-2">However, a system that is a public recursive resolver that supports DoT and/or DoQ may also have an IP address that is associated with NS records.
This could be accidental (such as a glue record with the wrong target address) or intentional.
In such a case, a recursive resolver following this protocol will look for authoritative answers to ports 53 and 853 on that IP address. Additionally, the DNS server answering on port 853 would need to be able to differentiate queries for recursive answers from queries for authoritative answers (e.g., by having the authoritative server handle all queries that have the Recursion Desired (RD) flag unset).<a class="pilcrow" href="#section-8-2">¶</a></p>
<p id="section-8-3">As discussed in <a class="auto internal xref" href="#security-considerations">Section 7</a>, the protocol described in this document provides no defense against active attackers.
On a network where a captive portal is operating, some communications may be actively intercepted (e.g., when the network tries to redirect a user to complete an interaction with a captive portal server).
A recursive resolver operating on a node that performs captive portal detection and Internet connectivity checks <span class="bcp14">SHOULD</span> delay encrypted transport probes to authoritative servers until after the node's Internet connectivity check policy has been satisfied.<a class="pilcrow" href="#section-8-3">¶</a></p>
</section>
</div>
<section id="section-9">
      <h2 id="name-references">
<a class="section-number selfRef" href="#section-9">9. </a><a class="section-name selfRef" href="#name-references">References</a>
      </h2>
<div id="sec-normative-references">
<section id="section-9.1">
        <h3 id="name-normative-references">
<a class="section-number selfRef" href="#section-9.1">9.1. </a><a class="section-name selfRef" href="#name-normative-references">Normative References</a>
        </h3>
<dl class="references">
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time class="refDate" datetime="1997-03">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7301">[RFC7301]</dt>
        <dd>
<span class="refAuthor">Friedl, S.</span>, <span class="refAuthor">Popov, A.</span>, <span class="refAuthor">Langley, A.</span>, and <span class="refAuthor">E. Stephan</span>, <span class="refTitle">"Transport Layer Security (TLS) Application-Layer Protocol Negotiation Extension"</span>, <span class="seriesInfo">RFC 7301</span>, <span class="seriesInfo">DOI 10.17487/RFC7301</span>, <time class="refDate" datetime="2014-07">July 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7301">https://www.rfc-editor.org/info/rfc7301</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7858">[RFC7858]</dt>
        <dd>
<span class="refAuthor">Hu, Z.</span>, <span class="refAuthor">Zhu, L.</span>, <span class="refAuthor">Heidemann, J.</span>, <span class="refAuthor">Mankin, A.</span>, <span class="refAuthor">Wessels, D.</span>, and <span class="refAuthor">P. Hoffman</span>, <span class="refTitle">"Specification for DNS over Transport Layer Security (TLS)"</span>, <span class="seriesInfo">RFC 7858</span>, <span class="seriesInfo">DOI 10.17487/RFC7858</span>, <time class="refDate" datetime="2016-05">May 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7858">https://www.rfc-editor.org/info/rfc7858</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time class="refDate" datetime="2017-05">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9250">[RFC9250]</dt>
      <dd>
<span class="refAuthor">Huitema, C.</span>, <span class="refAuthor">Dickinson, S.</span>, and <span class="refAuthor">A. Mankin</span>, <span class="refTitle">"DNS over Dedicated QUIC Connections"</span>, <span class="seriesInfo">RFC 9250</span>, <span class="seriesInfo">DOI 10.17487/RFC9250</span>, <time class="refDate" datetime="2022-05">May 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9250">https://www.rfc-editor.org/info/rfc9250</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
<div id="sec-informative-references">
<section id="section-9.2">
        <h3 id="name-informative-references">
<a class="section-number selfRef" href="#section-9.2">9.2. </a><a class="section-name selfRef" href="#name-informative-references">Informative References</a>
        </h3>
<dl class="references">
<dt id="RFC1035">[RFC1035]</dt>
        <dd>
<span class="refAuthor">Mockapetris, P.</span>, <span class="refTitle">"Domain names - implementation and specification"</span>, <span class="seriesInfo">STD 13</span>, <span class="seriesInfo">RFC 1035</span>, <span class="seriesInfo">DOI 10.17487/RFC1035</span>, <time class="refDate" datetime="1987-11">November 1987</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc1035">https://www.rfc-editor.org/info/rfc1035</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7435">[RFC7435]</dt>
        <dd>
<span class="refAuthor">Dukhovni, V.</span>, <span class="refTitle">"Opportunistic Security: Some Protection Most of the Time"</span>, <span class="seriesInfo">RFC 7435</span>, <span class="seriesInfo">DOI 10.17487/RFC7435</span>, <time class="refDate" datetime="2014-12">December 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7435">https://www.rfc-editor.org/info/rfc7435</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7672">[RFC7672]</dt>
        <dd>
<span class="refAuthor">Dukhovni, V.</span> and <span class="refAuthor">W. Hardaker</span>, <span class="refTitle">"SMTP Security via Opportunistic DNS-Based Authentication of Named Entities (DANE) Transport Layer Security (TLS)"</span>, <span class="seriesInfo">RFC 7672</span>, <span class="seriesInfo">DOI 10.17487/RFC7672</span>, <time class="refDate" datetime="2015-10">October 2015</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7672">https://www.rfc-editor.org/info/rfc7672</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7766">[RFC7766]</dt>
        <dd>
<span class="refAuthor">Dickinson, J.</span>, <span class="refAuthor">Dickinson, S.</span>, <span class="refAuthor">Bellis, R.</span>, <span class="refAuthor">Mankin, A.</span>, and <span class="refAuthor">D. Wessels</span>, <span class="refTitle">"DNS Transport over TCP - Implementation Requirements"</span>, <span class="seriesInfo">RFC 7766</span>, <span class="seriesInfo">DOI 10.17487/RFC7766</span>, <time class="refDate" datetime="2016-03">March 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7766">https://www.rfc-editor.org/info/rfc7766</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7830">[RFC7830]</dt>
        <dd>
<span class="refAuthor">Mayrhofer, A.</span>, <span class="refTitle">"The EDNS(0) Padding Option"</span>, <span class="seriesInfo">RFC 7830</span>, <span class="seriesInfo">DOI 10.17487/RFC7830</span>, <time class="refDate" datetime="2016-05">May 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7830">https://www.rfc-editor.org/info/rfc7830</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8305">[RFC8305]</dt>
        <dd>
<span class="refAuthor">Schinazi, D.</span> and <span class="refAuthor">T. Pauly</span>, <span class="refTitle">"Happy Eyeballs Version 2: Better Connectivity Using Concurrency"</span>, <span class="seriesInfo">RFC 8305</span>, <span class="seriesInfo">DOI 10.17487/RFC8305</span>, <time class="refDate" datetime="2017-12">December 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8305">https://www.rfc-editor.org/info/rfc8305</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8460">[RFC8460]</dt>
        <dd>
<span class="refAuthor">Margolis, D.</span>, <span class="refAuthor">Brotman, A.</span>, <span class="refAuthor">Ramakrishnan, B.</span>, <span class="refAuthor">Jones, J.</span>, and <span class="refAuthor">M. Risher</span>, <span class="refTitle">"SMTP TLS Reporting"</span>, <span class="seriesInfo">RFC 8460</span>, <span class="seriesInfo">DOI 10.17487/RFC8460</span>, <time class="refDate" datetime="2018-09">September 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8460">https://www.rfc-editor.org/info/rfc8460</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8461">[RFC8461]</dt>
        <dd>
<span class="refAuthor">Margolis, D.</span>, <span class="refAuthor">Risher, M.</span>, <span class="refAuthor">Ramakrishnan, B.</span>, <span class="refAuthor">Brotman, A.</span>, and <span class="refAuthor">J. Jones</span>, <span class="refTitle">"SMTP MTA Strict Transport Security (MTA-STS)"</span>, <span class="seriesInfo">RFC 8461</span>, <span class="seriesInfo">DOI 10.17487/RFC8461</span>, <time class="refDate" datetime="2018-09">September 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8461">https://www.rfc-editor.org/info/rfc8461</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8467">[RFC8467]</dt>
        <dd>
<span class="refAuthor">Mayrhofer, A.</span>, <span class="refTitle">"Padding Policies for Extension Mechanisms for DNS (EDNS(0))"</span>, <span class="seriesInfo">RFC 8467</span>, <span class="seriesInfo">DOI 10.17487/RFC8467</span>, <time class="refDate" datetime="2018-10">October 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8467">https://www.rfc-editor.org/info/rfc8467</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8484">[RFC8484]</dt>
        <dd>
<span class="refAuthor">Hoffman, P.</span> and <span class="refAuthor">P. McManus</span>, <span class="refTitle">"DNS Queries over HTTPS (DoH)"</span>, <span class="seriesInfo">RFC 8484</span>, <span class="seriesInfo">DOI 10.17487/RFC8484</span>, <time class="refDate" datetime="2018-10">October 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8484">https://www.rfc-editor.org/info/rfc8484</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8806">[RFC8806]</dt>
        <dd>
<span class="refAuthor">Kumari, W.</span> and <span class="refAuthor">P. Hoffman</span>, <span class="refTitle">"Running a Root Server Local to a Resolver"</span>, <span class="seriesInfo">RFC 8806</span>, <span class="seriesInfo">DOI 10.17487/RFC8806</span>, <time class="refDate" datetime="2020-06">June 2020</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8806">https://www.rfc-editor.org/info/rfc8806</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9102">[RFC9102]</dt>
        <dd>
<span class="refAuthor">Dukhovni, V.</span>, <span class="refAuthor">Huque, S.</span>, <span class="refAuthor">Toorop, W.</span>, <span class="refAuthor">Wouters, P.</span>, and <span class="refAuthor">M. Shore</span>, <span class="refTitle">"TLS DNSSEC Chain Extension"</span>, <span class="seriesInfo">RFC 9102</span>, <span class="seriesInfo">DOI 10.17487/RFC9102</span>, <time class="refDate" datetime="2021-08">August 2021</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9102">https://www.rfc-editor.org/info/rfc9102</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9156">[RFC9156]</dt>
        <dd>
<span class="refAuthor">Bortzmeyer, S.</span>, <span class="refAuthor">Dolmans, R.</span>, and <span class="refAuthor">P. Hoffman</span>, <span class="refTitle">"DNS Query Name Minimisation to Improve Privacy"</span>, <span class="seriesInfo">RFC 9156</span>, <span class="seriesInfo">DOI 10.17487/RFC9156</span>, <time class="refDate" datetime="2021-11">November 2021</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9156">https://www.rfc-editor.org/info/rfc9156</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-tls-esni">[TLS-ECH]</dt>
        <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refAuthor">Oku, K.</span>, <span class="refAuthor">Sullivan, N.</span>, and <span class="refAuthor">C. A. Wood</span>, <span class="refTitle">"TLS Encrypted Client Hello"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-tls-esni-17</span>, <time class="refDate" datetime="2023-10-09">9 October 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-tls-esni-17">https://datatracker.ietf.org/doc/html/draft-ietf-tls-esni-17</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-dnsop-dns-error-reporting">[DNS-ER]</dt>
      <dd>
<span class="refAuthor">Arends, R.</span> and <span class="refAuthor">M. Larson</span>, <span class="refTitle">"DNS Error Reporting"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-dnsop-dns-error-reporting-07</span>, <time class="refDate" datetime="2023-11-17">17 November 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-dnsop-dns-error-reporting-07">https://datatracker.ietf.org/doc/html/draft-ietf-dnsop-dns-error-reporting-07</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
</section>
<div id="assessing-the-experiment">
<section id="appendix-A">
      <h2 id="name-assessing-the-experiment">
<a class="section-number selfRef" href="#appendix-A">Appendix A. </a><a class="section-name selfRef" href="#name-assessing-the-experiment">Assessing the Experiment</a>
      </h2>
<p id="appendix-A-1">This document is an Experimental RFC.
In order to assess the success of the experiment, some key metrics could be collected by the technical community about the deployment of the protocol in this document.
These metrics will be collected in recursive resolvers, authoritative servers, and the networks containing them.
Some key metrics include the following.<a class="pilcrow" href="#appendix-A-1">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A-2.1">
          <p id="appendix-A-2.1.1">Comparison of the CPU and memory use between Do53 and encrypted transports.<a class="pilcrow" href="#appendix-A-2.1.1">¶</a></p>
</li>
        <li class="normal" id="appendix-A-2.2">
          <p id="appendix-A-2.2.1">Comparison of the query response rates between Do53 and encrypted transports.<a class="pilcrow" href="#appendix-A-2.2.1">¶</a></p>
</li>
        <li class="normal" id="appendix-A-2.3">
          <p id="appendix-A-2.3.1">Measurement of server authentication successes and failures.<a class="pilcrow" href="#appendix-A-2.3.1">¶</a></p>
</li>
        <li class="normal" id="appendix-A-2.4">
          <p id="appendix-A-2.4.1">Measurement and descriptions of observed attack traffic, if any.<a class="pilcrow" href="#appendix-A-2.4.1">¶</a></p>
</li>
        <li class="normal" id="appendix-A-2.5">
          <p id="appendix-A-2.5.1">Comparison of transactional bandwidth (ingress/egress, packets per second, bytes per second) between Do53 and encrypted transports.<a class="pilcrow" href="#appendix-A-2.5.1">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="adding-auth">
<section id="appendix-B">
      <h2 id="name-defense-against-active-atta">
<a class="section-number selfRef" href="#appendix-B">Appendix B. </a><a class="section-name selfRef" href="#name-defense-against-active-atta">Defense against Active Attackers</a>
      </h2>
<p id="appendix-B-1">The protocol described in this document provides no defense against active attackers.
A future protocol for recursive-to-authoritative DNS might want to provide such protection.<a class="pilcrow" href="#appendix-B-1">¶</a></p>
<p id="appendix-B-2">This appendix assumes that the use case for that future protocol is a recursive resolver that wants to prevent an active attack on communication between it and an authoritative server that has committed to offering encrypted DNS transport.
An inherent part of this use case is that the recursive resolver would want to respond with a <code>SERVFAIL</code> response to its client if it cannot make an authenticated encrypted connection to any of the authoritative nameservers for a name.<a class="pilcrow" href="#appendix-B-2">¶</a></p>
<p id="appendix-B-3">However, an authoritative server that merely offers encrypted transport (for example, by following the guidance in <a class="auto internal xref" href="#authoritative-guidance">Section 3</a>) has made no such commitment, and no recursive resolver that prioritizes delivery of DNS records to its clients would want to "fail closed" unilaterally.<a class="pilcrow" href="#appendix-B-3">¶</a></p>
<p id="appendix-B-4">Therefore, such a future protocol would need at least three major distinctions from the protocol described in this document:<a class="pilcrow" href="#appendix-B-4">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-B-5.1">
          <p id="appendix-B-5.1.1">A signaling mechanism that tells the recursive resolver that the authoritative server intends to offer authenticated encryption.<a class="pilcrow" href="#appendix-B-5.1.1">¶</a></p>
</li>
        <li class="normal" id="appendix-B-5.2">
          <p id="appendix-B-5.2.1">Authentication of the authoritative server.<a class="pilcrow" href="#appendix-B-5.2.1">¶</a></p>
</li>
        <li class="normal" id="appendix-B-5.3">
          <p id="appendix-B-5.3.1">A way to combine defense against an active attacker with the defenses described in this document.<a class="pilcrow" href="#appendix-B-5.3.1">¶</a></p>
</li>
      </ul>
<p id="appendix-B-6">This can be thought of as a DNS analog to <span>[<a class="cite xref" href="#RFC8461">RFC8461</a>]</span> or <span>[<a class="cite xref" href="#RFC7672">RFC7672</a>]</span>.<a class="pilcrow" href="#appendix-B-6">¶</a></p>
<div id="signaling-mechanism-properties">
<section id="appendix-B.1">
        <h3 id="name-signaling-mechanism-propert">
<a class="section-number selfRef" href="#appendix-B.1">B.1. </a><a class="section-name selfRef" href="#name-signaling-mechanism-propert">Signaling Mechanism Properties</a>
        </h3>
<p id="appendix-B.1-1">To defend against an active attacker, the signaling mechanism needs to be able to indicate that the recursive resolver should fail closed if it cannot authenticate the server for a particular query.<a class="pilcrow" href="#appendix-B.1-1">¶</a></p>
<p id="appendix-B.1-2">The signaling mechanism itself would have to be resistant to downgrade attacks from active attackers.<a class="pilcrow" href="#appendix-B.1-2">¶</a></p>
<p id="appendix-B.1-3">One open question is how such a signal should be scoped.
While this document scopes opportunistic state about encrypted transport based on the IP addresses of the client and server, signaled intent to offer encrypted transport is more likely to be scoped by the queried zone in the DNS or by the nameserver name than by the IP address.<a class="pilcrow" href="#appendix-B.1-3">¶</a></p>
<p id="appendix-B.1-4">A reasonable authoritative server operator or zone administrator probably doesn't want to risk breaking anything when they first enable the signal.
Therefore, a signaling mechanism should probably also offer a means to report problems to the authoritative server operator without the client failing closed.
Such a mechanism is likely to be similar to those described in <span>[<a class="cite xref" href="#RFC8460">RFC8460</a>]</span> or <span>[<a class="cite xref" href="#I-D.ietf-dnsop-dns-error-reporting">DNS-ER</a>]</span>.<a class="pilcrow" href="#appendix-B.1-4">¶</a></p>
</section>
</div>
<div id="authentication-of-authoritative-server">
<section id="appendix-B.2">
        <h3 id="name-authentication-of-authorita">
<a class="section-number selfRef" href="#appendix-B.2">B.2. </a><a class="section-name selfRef" href="#name-authentication-of-authorita">Authentication of Authoritative Servers</a>
        </h3>
<p id="appendix-B.2-1">Forms of server authentication might include:<a class="pilcrow" href="#appendix-B.2-1">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-B.2-2.1">
            <p id="appendix-B.2-2.1.1">An X.509 certificate issued by a widely known certification authority associated with the common NS names used for this authoritative server.<a class="pilcrow" href="#appendix-B.2-2.1.1">¶</a></p>
</li>
          <li class="normal" id="appendix-B.2-2.2">
            <p id="appendix-B.2-2.2.1">DNS-Based Authentication of Named Entities (DANE) (to avoid infinite recursion, the DNS records necessary to authenticate could be transmitted in the TLS handshake using the DNSSEC chain extension (see <span>[<a class="cite xref" href="#RFC9102">RFC9102</a>]</span>)).<a class="pilcrow" href="#appendix-B.2-2.2.1">¶</a></p>
</li>
        </ul>
<p id="appendix-B.2-3">A recursive resolver would have to verify the server's identity.
When doing so, the identity would presumably be based on the NS name used for a given query or the IP address of the server.<a class="pilcrow" href="#appendix-B.2-3">¶</a></p>
</section>
</div>
<div id="combining-protocols">
<section id="appendix-B.3">
        <h3 id="name-combining-protocols">
<a class="section-number selfRef" href="#appendix-B.3">B.3. </a><a class="section-name selfRef" href="#name-combining-protocols">Combining Protocols</a>
        </h3>
<p id="appendix-B.3-1">If this protocol gains reasonable adoption, and a newer protocol that can offer defense against an active attacker were available, deployment is likely to be staggered and incomplete.
This means that an operator that wants to maximize confidentiality for their users will want to use both protocols together.<a class="pilcrow" href="#appendix-B.3-1">¶</a></p>
<p id="appendix-B.3-2">Any new stronger protocol should consider how it interacts with the opportunistic protocol defined here, so that operators are not faced with the choice between widespread opportunistic protection against passive attackers (this document) and more narrowly targeted protection against active attackers.<a class="pilcrow" href="#appendix-B.3-2">¶</a></p>
</section>
</div>
</section>
</div>
<div id="acknowledgements">
<section id="appendix-C">
      <h2 id="name-acknowledgements">
<a class="section-name selfRef" href="#name-acknowledgements">Acknowledgements</a>
      </h2>
<p id="appendix-C-1">Many people contributed to the development of this document beyond the authors, including
<span class="contact-name">Alexander Mayrhofer</span>,
<span class="contact-name">Brian Dickson</span>,
<span class="contact-name">Christian Huitema</span>,
<span class="contact-name">Dhruv Dhody</span>,
<span class="contact-name">Eric Nygren</span>,
<span class="contact-name">Erik Kline</span>,
<span class="contact-name">Florian Obser</span>,
<span class="contact-name">Haoyu Song</span>,
<span class="contact-name">Jim Reid</span>,
<span class="contact-name">Kris Shrishak</span>,
<span class="contact-name">Peter Thomassen</span>,
<span class="contact-name">Peter van Dijk</span>,
<span class="contact-name">Ralf Weber</span>,
<span class="contact-name">Rich Salz</span>,
<span class="contact-name">Robert Evans</span>,
<span class="contact-name">Sara Dickinson</span>,
<span class="contact-name">Scott Hollenbeck</span>,
<span class="contact-name">Stephane Bortzmeyer</span>,
<span class="contact-name">Yorgos Thessalonikefs</span>,
and the DPRIVE Working Group.<a class="pilcrow" href="#appendix-C-1">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-D">
      <h2 id="name-authors-addresses">
<a class="section-name selfRef" href="#name-authors-addresses">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div class="left" dir="auto"><span class="fn nameRole">Daniel Kahn Gillmor (<span class="role">editor</span>)</span></div>
<div class="left" dir="auto"><span class="org">American Civil Liberties Union</span></div>
<div class="left" dir="auto"><span class="street-address">125 Broad St.</span></div>
<div class="left" dir="auto">
<span class="locality">New York</span>, <span class="region">NY</span> <span class="postal-code">10004</span>
</div>
<div class="left" dir="auto"><span class="country-name">United States of America</span></div>
<div class="email">
<span>Email:</span>
<a class="email" href="mailto:dkg@fifthhorseman.net">dkg@fifthhorseman.net</a>
</div>
</address>
<address class="vcard">
        <div class="left" dir="auto"><span class="fn nameRole">Joey Salazar (<span class="role">editor</span>)</span></div>
<div class="left" dir="auto"><span class="locality">Alajuela</span></div>
<div class="left" dir="auto"><span class="postal-code">20201</span></div>
<div class="left" dir="auto"><span class="country-name">Costa Rica</span></div>
<div class="email">
<span>Email:</span>
<a class="email" href="mailto:joeygsal@gmail.com">joeygsal@gmail.com</a>
</div>
</address>
<address class="vcard">
        <div class="left" dir="auto"><span class="fn nameRole">Paul Hoffman (<span class="role">editor</span>)</span></div>
<div class="left" dir="auto"><span class="org">ICANN</span></div>
<div class="left" dir="auto"><span class="country-name">United States of America</span></div>
<div class="email">
<span>Email:</span>
<a class="email" href="mailto:paul.hoffman@icann.org">paul.hoffman@icann.org</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>


</body></html>