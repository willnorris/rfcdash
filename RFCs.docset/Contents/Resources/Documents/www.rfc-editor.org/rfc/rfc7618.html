<html><head></head><body><pre>Internet Engineering Task Force (IETF)                            Y. Cui
Request for Comments: 7618                                        Q. Sun
Category: Standards Track                            Tsinghua University
ISSN: 2070-1721                                                I. Farrer
                                                     Deutsche Telekom AG
                                                                  Y. Lee
                                                                 Comcast
                                                                  Q. Sun
                                                           China Telecom
                                                            M. Boucadair
                                                          France Telecom
                                                             August 2015


              <span class="h1">Dynamic Allocation of Shared IPv4 Addresses</span>

Abstract

   This memo describes the dynamic allocation of shared IPv4 addresses
   to clients using DHCPv4.  Address sharing allows a single IPv4
   address to be allocated to multiple active clients simultaneously,
   with each client being differentiated by a unique set of transport-
   layer source port numbers.  The necessary changes to existing DHCPv4
   client and server behavior are described, and a new DHCPv4 option for
   provisioning clients with shared IPv4 addresses is included.

   Due to the nature of IP address sharing, some limitations to its
   applicability are necessary.  This memo describes these limitations
   and recommends suitable architectures and technologies where address
   sharing may be utilized.

Status of This Memo

   This is an Internet Standards Track document.

   This document is a product of the Internet Engineering Task Force
   (IETF).  It represents the consensus of the IETF community.  It has
   received public review and has been approved for publication by the
   Internet Engineering Steering Group (IESG).  Further information on
   Internet Standards is available in <a href="./rfc5741#section-2">Section 2 of RFC 5741</a>.

   Information about the current status of this document, any errata,
   and how to provide feedback on it may be obtained at
   <a href="http://www.rfc-editor.org/info/rfc7618">http://www.rfc-editor.org/info/rfc7618</a>.







<span class="grey">Cui, et al.                  Standards Track                    [Page 1]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-2"></span>
<span class="grey"><a href="./rfc7618">RFC 7618</a>             Dynamic Shared IPv4 Allocation          August 2015</span>


Copyright Notice

   Copyright (c) 2015 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="https://www.rfc-editor.org/bcp/bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.

Table of Contents

   <a href="#section-1">1</a>. Introduction ....................................................<a href="#page-3">3</a>
   <a href="#section-2">2</a>. Applicability Statement .........................................<a href="#page-3">3</a>
   <a href="#section-3">3</a>. Requirements Language ...........................................<a href="#page-4">4</a>
   <a href="#section-4">4</a>. Terminology .....................................................<a href="#page-4">4</a>
   <a href="#section-5">5</a>. Functional Overview .............................................<a href="#page-4">4</a>
   <a href="#section-6">6</a>. Client-Server Interaction .......................................<a href="#page-5">5</a>
   <a href="#section-7">7</a>. Client Behavior .................................................<a href="#page-6">6</a>
      <a href="#section-7.1">7.1</a>. Restrictions to Client Usage of a Shared IPv4 Address ......<a href="#page-7">7</a>
   <a href="#section-8">8</a>. Server Behavior .................................................<a href="#page-7">7</a>
      8.1. Leasing Shared and Non-Shared IPv4 Addresses from a
           Single DHCP 4o6 Server .....................................<a href="#page-9">9</a>
   <a href="#section-9">9</a>. DHCPv4 Port Parameters Option ...................................<a href="#page-9">9</a>
   <a href="#section-10">10</a>. Security Considerations .......................................<a href="#page-10">10</a>
      <a href="#section-10.1">10.1</a>. Port Randomization .......................................<a href="#page-11">11</a>
   <a href="#section-11">11</a>. IANA Considerations ...........................................<a href="#page-11">11</a>
   <a href="#section-12">12</a>. References ....................................................<a href="#page-11">11</a>
      <a href="#section-12.1">12.1</a>. Normative References .....................................<a href="#page-11">11</a>
      <a href="#section-12.2">12.2</a>. Informative References ...................................<a href="#page-12">12</a>
   Acknowledgements ..................................................<a href="#page-14">14</a>
   Authors' Addresses ................................................<a href="#page-14">14</a>














<span class="grey">Cui, et al.                  Standards Track                    [Page 2]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-3"></span>
<span class="grey"><a href="./rfc7618">RFC 7618</a>             Dynamic Shared IPv4 Allocation          August 2015</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.%20%20Introduction"></a><a class="selflink" href="#section-1" id="section-1">1</a>.  Introduction</span>

   The shortage of available public IPv4 addresses means that it is not
   always possible for operators to allocate a full IPv4 address to
   every connected device.  This problem is particularly acute while an
   operator is migrating from their existing, native IPv4 network to a
   native IPv6 network with IPv4 provided as an overlay service.  During
   this phase, public IPv4 addresses are needed to provide for both
   existing and transition networks.

   Two main types of solutions have emerged to address the problem (see
   <a href="./rfc6269#appendix-A">Appendix A of [RFC6269]</a>):

   1.  Deploying Carrier-Grade Network Address Translation devices
       (CGNs) [<a href="./rfc6888" title='"Common Requirements for Carrier-Grade NATs (CGNs)"'>RFC6888</a>].

   2.  Distributing the same public IPv4 address to multiple clients
       differentiated by non-overlapping Layer 4 port sets.

   This memo focuses on the second category of solutions.

   [<a id="ref-RFC7341">RFC7341</a>] introduces a "DHCP 4o6 server", which offers dynamic
   leasing for IPv4 addresses to clients as described in DHCPv4
   [<a href="./rfc2131" title='"Dynamic Host Configuration Protocol"'>RFC2131</a>], but transported within a DHCPv6 message flow.  This memo
   specifies a new DHCPv4 option -- OPTION_V4_PORTPARAMS -- and
   describes how it can be used for the dynamic leasing of shared IPv4
   addresses.

   Although DHCPv4 over DHCPv6 is used as the underlying DHCPv4
   transport mechanism throughout this document, OPTION_V4_PORTPARAMS as
   a DHCPv4 option may also be used in other solutions, if required.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/2.%20%20Applicability%20Statement"></a><a class="selflink" href="#section-2" id="section-2">2</a>.  Applicability Statement</span>

   The solution allows multiple hosts to be simultaneously allocated the
   same IP address.  As the IP address is no longer a unique identifier
   for a host, this solution is only suitable for specific architectures
   based on the Address plus Port model (A+P) [<a href="./rfc6346" title='"The Address plus Port (A+P) Approach to the IPv4 Address Shortage"'>RFC6346</a>].  Specifically,
   this document presents a solution that applies to [<a href="./rfc7596" title='"Lightweight 4over6: An Extension to the Dual-Stack Lite Architecture"'>RFC7596</a>] and
   certain configurations of [<a href="./rfc7597" title='"Mapping of Address and Port with Encapsulation (MAP-E)"'>RFC7597</a>] (e.g., Embedded Address bit
   (EA-bit) length set to 0).

   The solution should only be used on point-to-point links, tunnels,
   and/or in environments where authentication at the link layer is
   performed before IP address assignment.  It is not suitable for
   network access over shared media (e.g., Ethernet, WLAN, cable).





<span class="grey">Cui, et al.                  Standards Track                    [Page 3]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-4"></span>
<span class="grey"><a href="./rfc7618">RFC 7618</a>             Dynamic Shared IPv4 Allocation          August 2015</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.%20%20Requirements%20Language"></a><a class="selflink" href="#section-3" id="section-3">3</a>.  Requirements Language</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in [<a href="./rfc2119" title='"Key words for use in RFCs to Indicate Requirement Levels"'>RFC2119</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.%20%20Terminology"></a><a class="selflink" href="#section-4" id="section-4">4</a>.  Terminology</span>

   This document uses the following terms:

   Shared IPv4 address:  An IPv4 address with a restricted Layer 4
                         port set.

   Port Set ID (PSID):   Identifier for a range of ports assigned to a
                         DHCP client.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.%20%20Functional%20Overview"></a><a class="selflink" href="#section-5" id="section-5">5</a>.  Functional Overview</span>

   Functionally, the dynamic allocation of shared IPv4 addresses by the
   DHCP 4o6 server is similar to the dynamic allocation process for
   "full" IPv4 addresses as described in [<a href="./rfc2131" title='"Dynamic Host Configuration Protocol"'>RFC2131</a>].  The essential
   difference is that the DHCP 4o6 server can allocate the same IPv4
   address to more than one DHCP 4o6 client simultaneously, providing
   that each shared-address allocation also includes a range of Layer 4
   source ports unique to that address (i.e., the combined tuple of IPv4
   address and Port Set ID is to be unique for each active lease).

   The DHCP 4o6 client implements OPTION_V4_PORTPARAMS (described
   below), which is a DHCPv4 option containing PSID information.  The
   client includes this option within the Parameter Request List option
   [<a href="./rfc2132" title='"DHCP Options and BOOTP Vendor Extensions"'>RFC2132</a>] in its DHCPv4 DHCPDISCOVER and DHCPREQUEST messages,
   indicating its support for shared, dynamic address leasing to the
   DHCP 4o6 server.

   OPTION_V4_PORTPARAMS is also implemented by the server to identify
   clients that support shared, dynamic address leasing.  With this
   option, the server can dynamically allocate PSIDs to clients and
   maintain shared IPv4 address leases.  The server then manages unique
   client leases based on the IPv4 address and PSID tuple, instead of
   using only the IPv4 address.

   In the event that a client capable of dynamic, shared addressing
   receives more than one DHCP 4o6 offer, where a received offer does
   not contain OPTION_V4_PORTPARAMS (i.e., it is an offer for a full
   IPv4 address), then the client SHOULD prefer the full IPv4 offer over
   the shared IPv4 address offer(s), unless specifically configured
   otherwise.




<span class="grey">Cui, et al.                  Standards Track                    [Page 4]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-5"></span>
<span class="grey"><a href="./rfc7618">RFC 7618</a>             Dynamic Shared IPv4 Allocation          August 2015</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/6.%20%20Client-Server%20Interaction"></a><a class="selflink" href="#section-6" id="section-6">6</a>.  Client-Server Interaction</span>

   The following DHCPv4 message flow is transported within the
   DHCPv4-query and DHCPv4-response messages as described in DHCPv4 over
   DHCPv6 [<a href="./rfc7341" title='"DHCPv4-over-DHCPv6 (DHCP 4o6) Transport"'>RFC7341</a>].

   1.  When the client constructs the DHCPv4 DHCPDISCOVER message to be
       transported within the DHCPv4-query message, the DHCPDISCOVER
       message MUST include the client identifier option (constructed as
       per [<a href="./rfc4361" title='"Node-specific Client Identifiers for Dynamic Host Configuration Protocol Version Four (DHCPv4)"'>RFC4361</a>]) and the Parameter Request List option with the
       code OPTION_V4_PORTPARAMS.  The client MAY insert an
       OPTION_V4_PORTPARAMS with preferred values in related fields as a
       suggestion to the DHCP 4o6 server.

   2.  DHCP 4o6 servers that receive the DHCPDISCOVER message and
       support shared IPv4 addresses respond with a DHCPOFFER message
       with the shared IPv4 address in the yiaddr field, and they MUST
       add an OPTION_V4_PORTPARAMS option containing an available
       restricted port set.  If the DHCPDISCOVER included an
       OPTION_V4_PORTPARAMS option containing a non-zero PSID-len field,
       the DHCP 4o6 server MAY allocate a port set of the requested size
       to the client (depending on policy).  The DHCPOFFER message is
       then encapsulated in the DHCPv4-response message and sent to the
       client.

   3.  The client evaluates all received DHCPOFFER messages and selects
       one (e.g., based on the configuration parameters received, such
       as the size of the offered port set).  The client then sends a
       DHCPREQUEST encapsulated in the DHCPv4-query message containing
       the corresponding OPTION_V4_PORTPARAMS received in the DHCPOFFER
       message.

   4.  The server identified in the DHCPREQUEST message creates a
       binding for the client.  The binding includes the client
       identifier, the IPv4 address, and the PSID.  These parameters are
       used by both the server and the client to identify a lease in any
       DHCP message.  The server MUST respond with a DHCPACK message
       containing OPTION_V4_PORTPARAMS for the requesting client.

   5.  On receipt of the DHCPACK message with the configuration
       parameters, the client MUST NOT perform an in-use probe on the
       address, such as ARPing for a duplicate allocated address.

   6.  If the client chooses to relinquish its lease by sending a
       DHCPRELEASE message, the client MUST include the leased network
       address and OPTION_V4_PORTPARAMS (with the allocated PSID) to
       identify the lease to be released.




<span class="grey">Cui, et al.                  Standards Track                    [Page 5]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-6"></span>
<span class="grey"><a href="./rfc7618">RFC 7618</a>             Dynamic Shared IPv4 Allocation          August 2015</span>


   In the case where the client has stored the previously allocated
   address and restricted port set, the logic described in <a href="./rfc2131#section-3.2">Section 3.2
   of [RFC2131]</a> MUST be followed on the condition that the client's
   source IPv6 address for DHCP 4o6 does not change.  Note that this
   corresponds to the INIT-REBOOT state defined in [<a href="./rfc2131" title='"Dynamic Host Configuration Protocol"'>RFC2131</a>].  The
   client MUST include the OPTION_V4_PORTPARAMS with the requested
   port-set information in the message flow, which starts with a
   DHCPREQUEST message.  If the client's DHCP 4o6 IPv6 source address
   is changed for any reason, the client MUST re-initiate the DHCP 4o6
   shared-address provisioning process by sending a
   DHCPDISCOVER message.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/7.%20%20Client%20Behavior"></a><a class="selflink" href="#section-7" id="section-7">7</a>.  Client Behavior</span>

   A DHCP 4o6 client sending a DHCPDISCOVER message for a shared IPv4
   address MUST include the OPTION_V4_PORTPARAMS Option Code in the
   Parameter Request List option.  If a client has previously been
   successfully allocated an IPv4 address and PSID, the client's
   DHCPDISCOVER message MAY include the Requested IP Address option
   along with an OPTION_V4_PORTPARAMS to request that a specific IPv4
   address and PSID be reassigned.  Alternatively, the client MAY omit
   the Requested IP Address option but include an OPTION_V4_PORTPARAMS
   with a non-zero value in only the PSID-len field, as a hint to the
   server for the preferred size of the port set.

   A client that requests OPTION_V4_PORTPARAMS but receives DHCPOFFER
   and DHCPACK messages without OPTION_V4_PORTPARAMS SHOULD proceed as
   described in <a href="./rfc7341#section-9">Section 9 of [RFC7341]</a> and configure a full IPv4 address
   with no address sharing (see <a href="#section-8.1">Section 8.1</a>).

   When receiving a DHCPACK message containing OPTION_V4_PORTPARAMS, the
   client MUST use the received explicit PSID for configuring the
   interface for which the DHCP 4o6 request was made.

   The client MUST NOT probe a newly received IPv4 address (e.g., using
   ARP) to see if it is in use by another host.

   When the client renews or releases its DHCP lease, it MUST include
   the offset, PSID length, and PSID values in OPTION_V4_PORTPARAMS, and
   send it to the server within corresponding DHCPv4 messages.

   In the event that the client's DHCP 4o6 IPv6 source address is
   changed for any reason, the client MUST re-initiate the DHCP 4o6
   shared-address provisioning process by sending a DHCPDISCOVER
   message.






<span class="grey">Cui, et al.                  Standards Track                    [Page 6]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-7"></span>
<span class="grey"><a href="./rfc7618">RFC 7618</a>             Dynamic Shared IPv4 Allocation          August 2015</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/7.1.%20%20Restrictions%20to%20Client%20Usage%20of%20a%20Shared%20IPv4%20Address"></a><a class="selflink" href="#section-7.1" id="section-7.1">7.1</a>.  Restrictions to Client Usage of a Shared IPv4 Address</span>

   As a single IPv4 address is being shared between a number of
   different clients, the allocated shared address is only suitable for
   certain uses.  The client MUST implement a function to ensure that
   only the allocated Layer 4 ports of the shared IPv4 address are used
   for sourcing new connections or accepting inbound connections.

   The client MUST apply the following rules for all traffic destined
   to, or originating from, the shared IPv4 address:

   o  The client MUST use only port-aware protocols (e.g., TCP, UDP, the
      Datagram Congestion Control Protocol (DCCP)) and be ICMP compliant
      with [<a href="./rfc5508" title='"NAT Behavioral Requirements for ICMP"'>RFC5508</a>].

   o  All connections originating from the shared IPv4 address MUST use
      a source port taken from the allocated restricted port set.

   o  The client MUST NOT accept inbound connections on ports outside of
      the allocated restricted port set.

   In order to prevent addressing conflicts that could arise from the
   allocation of the same IPv4 address, the client MUST NOT use the
   received restricted IPv4 address to perform ARP operations.

   The mechanism by which a client implements the above rules is out of
   scope for this document.

   In the event that the DHCPv4-over-DHCPv6 configuration mechanism
   fails for any reason, the client MUST NOT configure an IPv4
   link-local address [<a href="./rfc3927" title='"Dynamic Configuration of IPv4 Link-Local Addresses"'>RFC3927</a>] (taken from the 169.254.0.0/16 range).

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/8.%20%20Server%20Behavior"></a><a class="selflink" href="#section-8" id="section-8">8</a>.  Server Behavior</span>

   The DHCP 4o6 server MUST NOT reply with OPTION_V4_PORTPARAMS unless
   the client has explicitly listed the Option Code in the Parameter
   Request List (Option 55) [<a href="./rfc2132" title='"DHCP Options and BOOTP Vendor Extensions"'>RFC2132</a>].

   The DHCP 4o6 server SHOULD reply with OPTION_V4_PORTPARAMS if the
   client includes OPTION_V4_PORTPARAMS in its Parameter Request List.
   In order to achieve dynamic management of shared IPv4 addresses, the
   server is required to implement an address and port-set pool that
   provides the same function as the address pool in a regular DHCP
   server.  Also, the server uses the combination of address and PSID as
   the key for maintaining the state of a lease and for searching for an
   available lease for assignment.  The leasing database is required to
   include the IPv4 address, PSID, and client identifier of the
   requesting client.



<span class="grey">Cui, et al.                  Standards Track                    [Page 7]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-8"></span>
<span class="grey"><a href="./rfc7618">RFC 7618</a>             Dynamic Shared IPv4 Allocation          August 2015</span>


   When a server receives a DHCPDISCOVER message with
   OPTION_V4_PORTPARAMS in the Parameter Request List option, the server
   determines an IPv4 address with a PSID for the requesting client.  If
   an IPv4 address with a PSID is available, the server SHOULD follow
   the logic below to select which specific address and PSID to
   provision to the client.  The logic is similar to that described in
   <a href="./rfc2131#section-4.3.1">Section 4.3.1 of [RFC2131]</a>.

   o  The client's current address with the PSID, as recorded in the
      client's current lease binding, ELSE

   o  The client's previous address with the PSID, as recorded in the
      client's (expired or released) binding, if that address with PSID
      is in the server's pool of available addresses and PSIDs, and not
      already allocated, ELSE

   o  The address requested in the Requested IP Address option along
      with the PSID parameters requested in the OPTION_V4_PORTPARAMS, if
      that pair of address and PSID is valid and not already allocated,
      ELSE

   o  A new address with a PSID allocated from the server's pool of
      available addresses and PSIDs.

   Upon receipt of a DHCPRELEASE message with OPTION_V4_PORTPARAMS, the
   server searches for the lease using the address in the ciaddr field
   and the PSID information in the OPTION_V4_PORTPARAMS, and marks the
   lease as unallocated if a record (matching that PSID) is maintained
   by the server for that client.

   The port-set assignment MUST be coupled with the address assignment
   process.  Therefore, the server MUST assign the address and port set
   in the same DHCP message.

   When defining the pools of IPv4 addresses and PSIDs that are
   available to lease to clients, the server MUST implement a mechanism
   to reserve some port ranges (e.g., 0-1023) from allocation to
   clients.  The reservation policy SHOULD be configurable.













<span class="grey">Cui, et al.                  Standards Track                    [Page 8]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-9"></span>
<span class="grey"><a href="./rfc7618">RFC 7618</a>             Dynamic Shared IPv4 Allocation          August 2015</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/8.1.%20%20Leasing%20Shared%20and%20Non-Shared%20IPv4%20Addresses%20from%20a%20Single"></a><a class="selflink" href="#section-8.1" id="section-8.1">8.1</a>.  Leasing Shared and Non-Shared IPv4 Addresses from a Single</span>
<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/DHCP%204o6%20Server"></a>      DHCP 4o6 Server</span>

   A single DHCP 4o6 server may serve clients that do not support
   OPTION_V4_PORTPARAMS, as well as those that do.  As the rules for the
   allocation of shared addresses differ from the rules for full IPv4
   address assignment, the DHCP 4o6 server MUST implement a mechanism to
   ensure that clients not supporting OPTION_V4_PORTPARAMS do not
   receive shared addresses.  For example, two separate IPv4 addressing
   pools could be used, one of which allocates IPv4 addresses and PSIDs
   only to clients that have requested them.

   If the server is only configured with address pools for shared-
   address allocation, it MUST discard requests that do not contain
   OPTION_V4_PORTPARAMS in the Parameter Request List option.

   A server configured with non-shared address pools can be instructed
   to honor received requests that contain OPTION_V4_PORTPARAMS in the
   Parameter Request List option (that is, ignore OPTION_V4_PORTPARAMS
   and serve the requesting clients with non-shared IPv4 addresses).

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/9.%20%20DHCPv4%20Port%20Parameters%20Option"></a><a class="selflink" href="#section-9" id="section-9">9</a>.  DHCPv4 Port Parameters Option</span>

   The meanings of the offset, PSID-len, and PSID fields of the DHCPv4
   Port Parameters option are identical to those of the offset,
   PSID-len, and PSID fields of the S46 Port Parameters option
   (<a href="./rfc7598#section-4.5">Section 4.5 of [RFC7598]</a>).  The use of the same encoding in both
   options is meant to ensure compatibility with existing port-set
   implementations.

   The format of OPTION_V4_PORTPARAMS is shown in Figure 1.

              0                             1
              0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5
             +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
             |      option-code      |     option-len        |
             +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
             |         offset        |       PSID-len        |
             +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
             |                     PSID                      |
             +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+

                  Figure 1: DHCPv4 Port Parameters Option

   o  option-code: OPTION_V4_PORTPARAMS (159)

   o  option-len: 4




<span class="grey">Cui, et al.                  Standards Track                    [Page 9]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-10"></span>
<span class="grey"><a href="./rfc7618">RFC 7618</a>             Dynamic Shared IPv4 Allocation          August 2015</span>


   o  offset: PSID offset.  8-bit field that specifies the numeric value
      for the excluded port range/offset bits ('a' bits), as per
      <a href="./rfc7597#section-5.1">Section 5.1 of [RFC7597]</a>.  Allowed values are between 0 and 15,
      with the default value being 6 for MAP-based implementations.
      This parameter is unused by a Lightweight 4over6 client and should
      be set to 0.

   o  PSID-len: Bit length value of the number of significant bits in
      the PSID field (also known as 'k').  When set to 0, the PSID field
      is to be ignored.  After the first 'a' bits, there are k bits in
      the port number representing the value of PSID.  Subsequently, the
      address-sharing ratio would be 2^k.

   o  PSID: Explicit 16-bit (unsigned word) PSID value.  The PSID value
      algorithmically identifies a set of ports assigned to a client.
      The first k bits on the left of this 2-octet field indicate the
      PSID value.  The remaining (16 - k) bits on the right are padding
      zeros.

   <a href="./rfc7597#section-5.1">Section 5.1 of [RFC7597]</a> provides a full description of how the PSID
   is interpreted by the client.

   In order to exclude the system ports ([<a href="./rfc6335" title='"Internet Assigned Numbers Authority (IANA) Procedures for the Management of the Service Name and Transport Protocol Port Number Registry"'>RFC6335</a>]) or ports reserved by
   ISPs, the former port sets that contain well-known ports MUST NOT be
   assigned unless the operator has explicitly configured otherwise
   (e.g., by allocating a full IPv4 address).

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/10.%20%20Security%20Considerations"></a><a class="selflink" href="#section-10" id="section-10">10</a>.  Security Considerations</span>

   The security considerations described in [<a href="./rfc2131" title='"Dynamic Host Configuration Protocol"'>RFC2131</a>] and [<a href="./rfc7341" title='"DHCPv4-over-DHCPv6 (DHCP 4o6) Transport"'>RFC7341</a>] are
   also potentially applicable to this solution.  Unauthorized DHCP 4o6
   servers in the network could be used to stage an amplification attack
   or to supply an invalid configuration, leading to service disruption.
   The risks of these types of attacks can be reduced by using unicast
   DHCP 4o6 message flows (enabled by supplying DHCP 4o6 server unicast
   addresses within the OPTION_DHCP4_O_DHCP6_SERVER option [<a href="./rfc7341" title='"DHCPv4-over-DHCPv6 (DHCP 4o6) Transport"'>RFC7341</a>]).

   A malicious user could attempt a DoS attack by requesting a large
   number of IPv4 address (or fractional address) and port-set
   allocations, exhausting the available addresses and port sets for
   other clients.  This can be mitigated by implementing, on each
   applicable customer site, a DHCP 4o6 address allocation policy that
   limits the number of simultaneously active IPv4 leases for clients
   whose requests originate from that customer site.

   The purpose of the client identifier option is to ensure that the
   same client retains the same parameters over time.  However, this
   interferes with the client's privacy, as it allows the server to



<span class="grey">Cui, et al.                  Standards Track                   [Page 10]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-11"></span>
<span class="grey"><a href="./rfc7618">RFC 7618</a>             Dynamic Shared IPv4 Allocation          August 2015</span>


   track the client.  Clients can manage their level of exposure by
   controlling the value of the client identifier, thereby trading off
   stability of parameter allocation for privacy.  We expect that
   guidance on this trade-off will be discussed in a future version of
   [<a href="#ref-DHCP-Anonymity">DHCP-Anonymity</a>].

   Additional security considerations are discussed in <a href="./rfc7597#section-10">Section 10 of
   [RFC7597]</a> and <a href="./rfc7596#section-9">Section 9 of [RFC7596]</a>.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/10.1.%20%20Port%20Randomization"></a><a class="selflink" href="#section-10.1" id="section-10.1">10.1</a>.  Port Randomization</span>

   Preserving port randomization [<a href="./rfc6056" title='"Recommendations for Transport- Protocol Port Randomization"'>RFC6056</a>] may be more difficult because
   the host can only randomize the ports inside a fixed port range (see
   <a href="./rfc6269#section-13.4">Section 13.4 of [RFC6269]</a>).

   More discussion regarding improving the robustness of TCP against
   blind in-window attacks can be found in [<a href="./rfc5961" title="&quot;Improving TCP's Robustness to Blind In-Window Attacks&quot;">RFC5961</a>].  To provide
   protection against attacks, means other than (IPv4) source port
   randomization should be used (e.g., use [<a href="./rfc5961" title="&quot;Improving TCP's Robustness to Blind In-Window Attacks&quot;">RFC5961</a>] to improve the
   robustness of TCP against blind in-window attacks, or use IPv6).

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/11.%20%20IANA%20Considerations"></a><a class="selflink" href="#section-11" id="section-11">11</a>.  IANA Considerations</span>

   IANA has assigned the following new DHCPv4 Option Code in the
   registry maintained at
   &lt;<a href="http://www.iana.org/assignments/bootp-dhcp-parameters/">http://www.iana.org/assignments/bootp-dhcp-parameters/</a>&gt;:

   Option Name           Tag  Data   Meaning
                              Length
   --------------------  ---  ------ -----------------------------------
   OPTION_V4_PORTPARAMS  159  4      This option is used to configure a
                                     set of ports bound to a shared IPv4
                                     address.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/12.%20%20References"></a><a class="selflink" href="#section-12" id="section-12">12</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/12.1.%20%20Normative%20References"></a><a class="selflink" href="#section-12.1" id="section-12.1">12.1</a>.  Normative References</span>

   [<a id="ref-RFC2119">RFC2119</a>]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", <a href="https://www.rfc-editor.org/bcp/bcp14">BCP 14</a>, <a href="./rfc2119">RFC 2119</a>,
              DOI 10.17487/RFC2119, March 1997,
              &lt;<a href="http://www.rfc-editor.org/info/rfc2119">http://www.rfc-editor.org/info/rfc2119</a>&gt;.

   [<a id="ref-RFC2131">RFC2131</a>]  Droms, R., "Dynamic Host Configuration Protocol",
              <a href="./rfc2131">RFC 2131</a>, DOI 10.17487/RFC2131, March 1997,
              &lt;<a href="http://www.rfc-editor.org/info/rfc2131">http://www.rfc-editor.org/info/rfc2131</a>&gt;.





<span class="grey">Cui, et al.                  Standards Track                   [Page 11]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-12"></span>
<span class="grey"><a href="./rfc7618">RFC 7618</a>             Dynamic Shared IPv4 Allocation          August 2015</span>


   [<a id="ref-RFC2132">RFC2132</a>]  Alexander, S. and R. Droms, "DHCP Options and BOOTP Vendor
              Extensions", <a href="./rfc2132">RFC 2132</a>, DOI 10.17487/RFC2132, March 1997,
              &lt;<a href="http://www.rfc-editor.org/info/rfc2132">http://www.rfc-editor.org/info/rfc2132</a>&gt;.

   [<a id="ref-RFC4361">RFC4361</a>]  Lemon, T. and B. Sommerfeld, "Node-specific Client
              Identifiers for Dynamic Host Configuration Protocol
              Version Four (DHCPv4)", <a href="./rfc4361">RFC 4361</a>, DOI 10.17487/RFC4361,
              February 2006, &lt;<a href="http://www.rfc-editor.org/info/rfc4361">http://www.rfc-editor.org/info/rfc4361</a>&gt;.

   [<a id="ref-RFC5961">RFC5961</a>]  Ramaiah, A., Stewart, R., and M. Dalal, "Improving TCP's
              Robustness to Blind In-Window Attacks", <a href="./rfc5961">RFC 5961</a>,
              DOI 10.17487/RFC5961, August 2010,
              &lt;<a href="http://www.rfc-editor.org/info/rfc5961">http://www.rfc-editor.org/info/rfc5961</a>&gt;.

   [<a id="ref-RFC6056">RFC6056</a>]  Larsen, M. and F. Gont, "Recommendations for Transport-
              Protocol Port Randomization", <a href="https://www.rfc-editor.org/bcp/bcp156">BCP 156</a>, <a href="./rfc6056">RFC 6056</a>,
              DOI 10.17487/RFC6056, January 2011,
              &lt;<a href="http://www.rfc-editor.org/info/rfc6056">http://www.rfc-editor.org/info/rfc6056</a>&gt;.

   [<a id="ref-RFC7341">RFC7341</a>]  Sun, Q., Cui, Y., Siodelski, M., Krishnan, S., and I.
              Farrer, "DHCPv4-over-DHCPv6 (DHCP 4o6) Transport",
              <a href="./rfc7341">RFC 7341</a>, DOI 10.17487/RFC7341, August 2014,
              &lt;<a href="http://www.rfc-editor.org/info/rfc7341">http://www.rfc-editor.org/info/rfc7341</a>&gt;.

   [<a id="ref-RFC7596">RFC7596</a>]  Cui, Y., Sun, Q., Boucadair, M., Tsou, T., Lee, Y., and
              I. Farrer, "Lightweight 4over6: An Extension to the
              Dual-Stack Lite Architecture", <a href="./rfc7596">RFC 7596</a>,
              DOI 10.17487/RFC7596, July 2015,
              &lt;<a href="http://www.rfc-editor.org/info/rfc7596">http://www.rfc-editor.org/info/rfc7596</a>&gt;.

   [<a id="ref-RFC7597">RFC7597</a>]  Troan, O., Ed., Dec, W., Li, X., Bao, C., Matsushima, S.,
              Murakami, T., and T. Taylor, Ed., "Mapping of Address and
              Port with Encapsulation (MAP-E)", <a href="./rfc7597">RFC 7597</a>,
              DOI 10.17487/RFC7597, July 2015,
              &lt;<a href="http://www.rfc-editor.org/info/rfc7597">http://www.rfc-editor.org/info/rfc7597</a>&gt;.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/12.2.%20%20Informative%20References"></a><a class="selflink" href="#section-12.2" id="section-12.2">12.2</a>.  Informative References</span>

   [<a id="ref-DHCP-Anonymity">DHCP-Anonymity</a>]
              Huitema, C., Mrugalski, T., and S. Krishnan, "Anonymity
              profile for DHCP clients", Work in Progress,
              <a href="./draft-ietf-dhc-anonymity-profile-01">draft-ietf-dhc-anonymity-profile-01</a>, June 2015.

   [<a id="ref-DHCP-Port-Set-Opt">DHCP-Port-Set-Opt</a>]
              Sun, Q., Lee, Y., Sun, Q., Bajko, G., and M. Boucadair,
              "Dynamic Host Configuration Protocol (DHCP) Option for
              Port Set Assignment", Work in Progress,
              <a href="./draft-sun-dhc-port-set-option-02">draft-sun-dhc-port-set-option-02</a>, October 2013.



<span class="grey">Cui, et al.                  Standards Track                   [Page 12]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-13"></span>
<span class="grey"><a href="./rfc7618">RFC 7618</a>             Dynamic Shared IPv4 Allocation          August 2015</span>


   [<a id="ref-DHCPv4_v6-Shared-Addr">DHCPv4_v6-Shared-Addr</a>]
              Farrer, I., "Dynamic Allocation of Shared IPv4 Addresses
              using DHCPv4 over DHCPv6", Work in Progress,
              <a href="./draft-farrer-dhc-shared-address-lease-00">draft-farrer-dhc-shared-address-lease-00</a>, June 2013.

   [<a id="ref-RFC3927">RFC3927</a>]  Cheshire, S., Aboba, B., and E. Guttman, "Dynamic
              Configuration of IPv4 Link-Local Addresses", <a href="./rfc3927">RFC 3927</a>,
              DOI 10.17487/RFC3927, May 2005,
              &lt;<a href="http://www.rfc-editor.org/info/rfc3927">http://www.rfc-editor.org/info/rfc3927</a>&gt;.

   [<a id="ref-RFC5508">RFC5508</a>]  Srisuresh, P., Ford, B., Sivakumar, S., and S. Guha, "NAT
              Behavioral Requirements for ICMP", <a href="https://www.rfc-editor.org/bcp/bcp148">BCP 148</a>, <a href="./rfc5508">RFC 5508</a>,
              DOI 10.17487/RFC5508, April 2009,
              &lt;<a href="http://www.rfc-editor.org/info/rfc5508">http://www.rfc-editor.org/info/rfc5508</a>&gt;.

   [<a id="ref-RFC6269">RFC6269</a>]  Ford, M., Ed., Boucadair, M., Durand, A., Levis, P., and
              P. Roberts, "Issues with IP Address Sharing", <a href="./rfc6269">RFC 6269</a>,
              DOI 10.17487/RFC6269, June 2011,
              &lt;<a href="http://www.rfc-editor.org/info/rfc6269">http://www.rfc-editor.org/info/rfc6269</a>&gt;.

   [<a id="ref-RFC6335">RFC6335</a>]  Cotton, M., Eggert, L., Touch, J., Westerlund, M., and S.
              Cheshire, "Internet Assigned Numbers Authority (IANA)
              Procedures for the Management of the Service Name and
              Transport Protocol Port Number Registry", <a href="https://www.rfc-editor.org/bcp/bcp165">BCP 165</a>,
              <a href="./rfc6335">RFC 6335</a>, DOI 10.17487/RFC6335, August 2011,
              &lt;<a href="http://www.rfc-editor.org/info/rfc6335">http://www.rfc-editor.org/info/rfc6335</a>&gt;.

   [<a id="ref-RFC6346">RFC6346</a>]  Bush, R., Ed., "The Address plus Port (A+P) Approach to
              the IPv4 Address Shortage", <a href="./rfc6346">RFC 6346</a>, DOI 10.17487/
              <a href="./rfc6346">RFC6346</a>, August 2011,
              &lt;<a href="http://www.rfc-editor.org/info/rfc6346">http://www.rfc-editor.org/info/rfc6346</a>&gt;.

   [<a id="ref-RFC6888">RFC6888</a>]  Perreault, S., Ed., Yamagata, I., Miyakawa, S., Nakagawa,
              A., and H. Ashida, "Common Requirements for Carrier-Grade
              NATs (CGNs)", <a href="https://www.rfc-editor.org/bcp/bcp127">BCP 127</a>, <a href="./rfc6888">RFC 6888</a>, DOI 10.17487/RFC6888,
              April 2013, &lt;<a href="http://www.rfc-editor.org/info/rfc6888">http://www.rfc-editor.org/info/rfc6888</a>&gt;.

   [<a id="ref-RFC7598">RFC7598</a>]  Mrugalski, T., Troan, O., Farrer, I., Perreault, S., Dec,
              W., Bao, C., Yeh, L., and X. Deng, "DHCPv6 Options for
              Configuration of Softwire Address and Port-Mapped
              Clients", <a href="./rfc7598">RFC 7598</a>, DOI 10.17487/RFC7598, July 2015,
              &lt;<a href="http://www.rfc-editor.org/info/rfc7598">http://www.rfc-editor.org/info/rfc7598</a>&gt;.









<span class="grey">Cui, et al.                  Standards Track                   [Page 13]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-14"></span>
<span class="grey"><a href="./rfc7618">RFC 7618</a>             Dynamic Shared IPv4 Allocation          August 2015</span>


Acknowledgements

   This document is the result of merging [<a href="#ref-DHCP-Port-Set-Opt">DHCP-Port-Set-Opt</a>] and
   [<a href="#ref-DHCPv4_v6-Shared-Addr">DHCPv4_v6-Shared-Addr</a>].

   The authors would like to thank Peng Wu, Gabor Bajko, Teemu
   Savolainen, Ted Lemon, Tina Tsou, Pierre Levis, Cong Liu, Marcin
   Siodelski, and Christian Huitema for their contributions.

   Many thanks to Brian Haberman for the review.

Authors' Addresses

   Yong Cui
   Tsinghua University
   Beijing  100084
   China

   Phone: +86-10-62603059
   Email: yong@csnet1.cs.tsinghua.edu.cn


   Qi Sun
   Tsinghua University
   Beijing  100084
   China

   Phone: +86-10-62785822
   Email: sunqi.ietf@gmail.com


   Ian Farrer
   Deutsche Telekom AG
   CTO-ATI, Landgrabenweg 151
   Bonn, NRW  53227
   Germany

   Email: ian.farrer@telekom.de


   Yiu L. Lee
   Comcast
   One Comcast Center
   Philadelphia, PA  19103
   United States

   Email: yiu_lee@cable.comcast.com




<span class="grey">Cui, et al.                  Standards Track                   [Page 14]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-15"></span>
<span class="grey"><a href="./rfc7618">RFC 7618</a>             Dynamic Shared IPv4 Allocation          August 2015</span>


   Qiong Sun
   China Telecom
   Room 708, No.118, Xizhimennei Street
   Beijing  100035
   China

   Phone: +86-10-58552936
   Email: sunqiong@ctbri.com.cn


   Mohamed Boucadair
   France Telecom
   Rennes  35000
   France

   Email: mohamed.boucadair@orange.com



































Cui, et al.                  Standards Track                   [Page 15]
</pre>
</body></html>