<html><head></head><body><pre>Network Working Group                                          D. Willis
Request for Comments: 3327                              dynamicsoft Inc.
Category: Standards Track                                   B. Hoeneisen
                                                                  Switch
                                                           December 2002


        <span class="h1">Session Initiation Protocol (SIP) Extension Header Field</span>
                 <span class="h1">for Registering Non-Adjacent Contacts</span>

Status of this Memo

   This document specifies an Internet standards track protocol for the
   Internet community, and requests discussion and suggestions for
   improvements.  Please refer to the current edition of the "Internet
   Official Protocol Standards" (STD 1) for the standardization state
   and status of this protocol.  Distribution of this memo is unlimited.

Copyright Notice

   Copyright (C) The Internet Society (2002).  All Rights Reserved.

Abstract

   The REGISTER function is used in a Session Initiation Protocol (SIP)
   system primarily to associate a temporary contact address with an
   address-of-record.  This contact is generally in the form of a
   Uniform Resource Identifier (URI), such as Contact:
   &lt;sip:alice@pc33.atlanta.com&gt; and is generally dynamic and associated
   with the IP address or hostname of the SIP User Agent (UA).  The
   problem is that network topology may have one or more SIP proxies
   between the UA and the registrar, such that any request traveling
   from the user's home network to the registered UA must traverse these
   proxies.  The REGISTER method does not give us a mechanism to
   discover and record this sequence of proxies in the registrar for
   future use.  This document defines an extension header field, "Path"
   which provides such a mechanism.














<span class="grey">Willis &amp; Hoeneisen          Standards Track                     [Page 1]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-2"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


Table of Contents

   <a href="#section-1">1</a>.    Background . . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-2">2</a>
   <a href="#section-2">2</a>.    Terminology  . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-3">3</a>
   <a href="#section-3">3</a>.    Applicability Statement  . . . . . . . . . . . . . . . . . .  <a href="#page-3">3</a>
   <a href="#section-4">4</a>.    Path Header Field Definition and Syntax  . . . . . . . . . .  <a href="#page-3">3</a>
   <a href="#section-5">5</a>.    Usage of Path Header Field . . . . . . . . . . . . . . . . .  <a href="#page-5">5</a>
   <a href="#section-5.1">5.1</a>   Procedures at the UA . . . . . . . . . . . . . . . . . . . .  <a href="#page-5">5</a>
   <a href="#section-5.2">5.2</a>   Procedures at Intermediate Proxies . . . . . . . . . . . . .  <a href="#page-5">5</a>
   <a href="#section-5.3">5.3</a>   Procedures at the Registrar  . . . . . . . . . . . . . . . .  <a href="#page-6">6</a>
   <a href="#section-5.4">5.4</a>   Procedures at the Home Proxy . . . . . . . . . . . . . . . .  <a href="#page-6">6</a>
   <a href="#section-5.5">5.5</a>   Examples of Usage  . . . . . . . . . . . . . . . . . . . . .  <a href="#page-7">7</a>
   <a href="#section-5.5.1">5.5.1</a> Example of Mechanism in REGISTER Transaction . . . . . . . .  <a href="#page-7">7</a>
   <a href="#section-5.5.2">5.5.2</a> Example of Mechanism in INVITE Transaction . . . . . . . . . <a href="#page-11">11</a>
   <a href="#section-6">6</a>.    Security Considerations  . . . . . . . . . . . . . . . . . . <a href="#page-13">13</a>
   <a href="#section-6.1">6.1</a>   Considerations in REGISTER Request Processing  . . . . . . . <a href="#page-13">13</a>
   <a href="#section-6.2">6.2</a>   Considerations in REGISTER Response Processing . . . . . . . <a href="#page-14">14</a>
   <a href="#section-7">7</a>.    IANA Considerations  . . . . . . . . . . . . . . . . . . . . <a href="#page-15">15</a>
   <a href="#section-8">8</a>.    Acknowledgements . . . . . . . . . . . . . . . . . . . . . . <a href="#page-15">15</a>
         Normative References . . . . . . . . . . . . . . . . . . . . <a href="#page-16">16</a>
         Non-Normative References . . . . . . . . . . . . . . . . . . <a href="#page-16">16</a>
         Authors' Addresses . . . . . . . . . . . . . . . . . . . . . <a href="#page-16">16</a>
         Full Copyright Statement . . . . . . . . . . . . . . . . . . <a href="#page-17">17</a>

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.%20Background"></a><a class="selflink" href="#section-1" id="section-1">1</a>. Background</span>

   3GPP established a requirement for discovering intermediate proxies
   during SIP registration and published this requirement in [<a href="#ref-5" title='"3GPP Requirements On SIP"'>5</a>].

   Scenario:

   UA1----P1-----P2-----P3------REGISTRAR

   UA1 wishes to register with REGISTRAR.  However, due to network
   topology, UA1 must use P1 as an "outbound proxy", and all requests
   between UA1 and REGISTRAR must also traverse P1, P2, and P3 before
   reaching REGISTRAR.  Likewise, all requests between REGISTRAR and UA1
   must also traverse P3, P2, and P1 before reaching UA1.

   UA1 has a standing relationship with REGISTRAR.  How UA1 establishes
   this relationship is outside the scope of this document.  UA1
   discovers P1 as a result of configuration, DHCP assignment or other
   similar operation, also outside the scope of this document.
   REGISTRAR has a similar "default outbound proxy" relationship with
   P3.






<span class="grey">Willis &amp; Hoeneisen          Standards Track                     [Page 2]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-3"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


   Eventually, REGISTRAR or a "home proxy" (a proxy serving as the
   terminal point for routing an address-of-record) closely related to
   it will receive a request destined for UA1.  It needs to know which
   proxies must be transited by that request in order to get back to
   UA1.  In some cases, this information may be deducible from SIP
   routing configuration tables or from DNS entries.  In other cases,
   such as that raised by 3GPP, the information is not readily available
   outside of the SIP REGISTER transaction.

   The Path extension header field allows accumulating and transmitting
   the list of proxies between UA1 and REGISTRAR.  Intermediate nodes
   such as P1 may statefully retain Path information if needed by
   operational policy.  This mechanism is in many ways similar to the
   operation of Record-Route in dialog-initiating requests.  The routing
   established by the Path header field mechanism applies only to
   requests transiting or originating in the home domain.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/2.%20Terminology"></a><a class="selflink" href="#section-2" id="section-2">2</a>. Terminology</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <a href="https://www.rfc-editor.org/bcp/bcp14">BCP 14</a>, <a href="./rfc2119">RFC 2119</a> [<a href="#ref-3" title='"Key words for use in RFCs to Indicate Requirement Levels"'>3</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.%20Applicability%20Statement"></a><a class="selflink" href="#section-3" id="section-3">3</a>. Applicability Statement</span>

   The Path mechanism is applicable whenever there are intermediate
   proxies between a SIP UA and a SIP Registrar used by that UA where
   the following conditions are true:

   1. One or more of the intermediate proxies are visited by
      registration requests from the UA to the Registrar.
   2. The same intermediate proxies or a set of proxies known to the
      intermediate proxies must be traversed, in reverse order, by
      requests sent through a home proxy to the UA.  In the simplest
      form, the route between the home proxy and the UA is the exact
      inverse of the route between the UA and the route between the UA
      and the registrar.
   3. The network topology is such that the intermediate proxies which
      must be visited are NOT implied by SIP routing tables, DNS, or
      similar mechanisms.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.%20Path%20Header%20Field%20Definition%20and%20Syntax"></a><a class="selflink" href="#section-4" id="section-4">4</a>. Path Header Field Definition and Syntax</span>

   The Path header field is a SIP extension header field with syntax
   very similar to the Record-Route header field.  It is used in
   conjunction with SIP REGISTER requests and with 200 class messages in
   response to REGISTER (REGISTER responses).




<span class="grey">Willis &amp; Hoeneisen          Standards Track                     [Page 3]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-4"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


   A Path header field MAY be inserted into a REGISTER by any SIP node
   traversed by that request.  Like the Route header field, sequential
   Path header fields are evaluated in the sequence in which they are
   present in the request, and Path header fields MAY be combined into
   compound Path header in a single Path header field.  The registrar
   reflects the accumulated Path back into the REGISTER response, and
   intermediate nodes propagate this back toward the originating UA.
   The originating UA is therefore informed of the inclusion of nodes on
   its registered Path, and MAY use that information in other capacities
   outside the scope of this document.

   The difference between Path and Record-Route is that Path applies to
   REGISTER and 200 class responses to REGISTER.  Record-Route doesn't,
   and can't be defined in REGISTER for reasons of backward
   compatibility.  Furthermore, the vector established by Record-Route
   applies only to requests within the dialog that established that
   Record-Route, whereas the vector established by Path applies to
   future dialogs.

   The syntax for Path is defined as follows:

   Path = "Path" HCOLON path-value *( COMMA path-value )

   path-value = name-addr *( SEMI rr-param )

   Note that the Path header field values conform to the syntax of a
   Route element as defined in [<a href="#ref-1" title='"SIP: Session Initiation Protocol"'>1</a>].  As suggested therein, such values
   MUST include the loose-routing indicator parameter ";lr" for full
   compliance with [<a href="#ref-1" title='"SIP: Session Initiation Protocol"'>1</a>].

   The allowable usage of header fields is described in Tables 2 and 3
   of SIP [<a href="#ref-1" title='"SIP: Session Initiation Protocol"'>1</a>].  The following additions to this table are needed for
   Path.

   Support for the Path header field MAY be indicated by a UA by
   including the option-tag "path" in a Supported header field.

   Addition of Path to SIP Table 3:

      Header field          where   proxy ACK BYE CAN INV OPT REG
      ___________________________________________________________
      Path                    R       ar   -   -   -   -   -   o
      Path                   2xx       -   -   -   -   -   -   o








<span class="grey">Willis &amp; Hoeneisen          Standards Track                     [Page 4]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-5"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.%20Usage%20of%20Path%20Header%20Field"></a><a class="selflink" href="#section-5" id="section-5">5</a>. Usage of Path Header Field</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.1%20Procedures%20at%20the%20UA"></a><a class="selflink" href="#section-5.1" id="section-5.1">5.1</a> Procedures at the UA</span>

   The UA executes its register operation as usual.  The response MAY
   contain a Path header field.  The general operation of the UA is to
   ignore the Path header field in the response.  It MAY choose to
   display the contents of the Path header field to the user or take
   other action outside the scope of this document.  The Path
   information in the REGISTER response lets the UA know what
   intermediate proxies were added during registration.  Examination of
   this information may be important from a security perspective, as
   such inspection might allow the UA to detect intermediate proxies
   that have inappropriately added themselves.

   The UA SHOULD include the option tag "path" as a header field value
   in all Supported header fields, and SHOULD include a Supported header
   field in all requests.

   The UA MAY include a Path header field in a request.  This is not
   broadly applicable and caution must be taken to insure proper
   function, as the Path header field inserted by the UA may have
   additional Path header field values appended by intermediate proxies.
   Such proxies are not aware that the Path header field value was
   inserted by a UA, and will treat it as if it had been inserted by a
   previously traversed proxy, which could result in unexpected routing
   behavior wherein the UA is asked to act as a proxy.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.2%20Procedures%20at%20Intermediate%20Proxies"></a><a class="selflink" href="#section-5.2" id="section-5.2">5.2</a> Procedures at Intermediate Proxies</span>

   When a proxy processing a REGISTER request wishes to be on the path
   for future requests toward the UA originating that REGISTER request,
   the proxy inserts a URI for that proxy as the topmost value in the
   Path header field (or inserts a new topmost Path header) before
   proxying that request.  It is also possible for a proxy with specific
   knowledge of network topology to add a Path header field value
   referencing another node, thereby allowing construction of a Path
   which is discongruent with the route taken by the REGISTER request.
   Such a construction is implementation specific and outside the scope
   of this document.

   Intermediate proxies SHOULD NOT add a Path header field to a request
   unless the UA has indicated support for this extension with a
   Supported header field value.  If the UA has indicated support and
   the proxy requires the registrar to support the Path extension, then
   the proxy SHOULD insert a Requires header field value for this
   extension.  If the UA has not indicated support for the extension and
   the proxy requires support for it in the registrar, the proxy SHOULD



<span class="grey">Willis &amp; Hoeneisen          Standards Track                     [Page 5]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-6"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


   reject the request with a 421 response indicating a requirement for
   the extension.

   Proxies processing a REGISTER response SHOULD NOT alter any Path
   header field values that may be present in the response.  The
   registrar MAY protect the Path header field in the response by
   including it in a protected S/MIME body, and alterations of the Path
   by an intermediate proxy can therefore be detected by the UA as man-
   in-the-middle attacks.  Proxies SHOULD only consider altering the
   value of a Path header field in the REGISTER response if they have
   the credentials to correctly alter the S/MIME body to account for the
   change.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.3%20Procedures%20at%20the%20Registrar"></a><a class="selflink" href="#section-5.3" id="section-5.3">5.3</a> Procedures at the Registrar</span>

   If a Path header field exists in a successful REGISTER request, the
   registrar constructs an ordered list of route elements (a path
   vector) from the nodes listed in the Path header field values,
   preserving the order as indicated in the Path header field values.
   The registrar then stores this path vector in association with that
   contact and the address-of-record indicated in the REGISTER request
   (the "binding" as defined in [<a href="#ref-1" title='"SIP: Session Initiation Protocol"'>1</a>]).  The registrar copies the Path
   header field values into a Path header field in the successful (200
   class) REGISTER response.  In the event that the home proxy and
   registrar are not co-located, the registrar MAY apply a locally-
   determined transformation to the stored path vector.

   If a registrar receives a REGISTER request containing a Path header
   field and there is no indication of support for the extension in the
   UA (via a Supported header field), the registrar must rely on local
   policy in determining how to treat this request.  The recommended
   policy is for the registrar to reject the request with a 420 "Bad
   Extension" response indicating the Path extension.  This approach
   allows the UA to detect that an intermediate proxy has
   inappropriately added a Path header field.  However, the Path
   mechanism should technically work in the absence of UA support (at
   some compromise to security), so some registrars MAY choose to
   support the extension in the absence of a Supported header field
   value in the request.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.4%20Procedures%20at%20the%20Home%20Proxy"></a><a class="selflink" href="#section-5.4" id="section-5.4">5.4</a> Procedures at the Home Proxy</span>

   In the common SIP model, there is a home proxy associated with the
   registrar for a user.  Each incoming request targeted to the public
   address-of-record for the user is routed to this proxy, which
   consults the registrar's database in order to determine the contact
   to which the request should be retargeted.  The home proxy, in its
   basic mode of operation, rewrites the request-URI from the incoming



<span class="grey">Willis &amp; Hoeneisen          Standards Track                     [Page 6]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-7"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


   request with the value of the registered contact and retransmits the
   request.

   With the addition of Path, the home proxy also copies the stored path
   vector associated with the specific contact in the registrar database
   into the Route header field of the outgoing request as a preloaded
   route.  This causes the outgoing request to transit the proxies that
   were included in the Path header field of the REGISTER request.

   In normal processing, the home proxy is the "terminal point" for the
   user's address-of-record (AOR).  Consequentially, the Route header
   field on the incoming request will have been exhausted in reaching
   the home proxy.  If it isn't, then things get interesting.  In the
   most common case, the home proxy generates the outgoing Route header
   field by inserting the stored path vector ahead of the Route header
   field values contained in the incoming request. This procedure may be
   altered by a local policy at the home proxy.

   Loose routes may interact with routing policy in interesting ways.
   The specifics of how the stored path vector integrates with any
   locally required default route and local policy are implementation
   dependent.  For example, some devices will use locally-configured
   explicit loose routing to reach a next-hop proxy, and others will use
   a default outbound-proxy routing rule.  However, for the result to
   function, the combination must provide valid routing in the local
   environment.  In general, the stored path vector is appended to any
   locally configured route needed to egress the service cluster.  The
   service proxy (or registrar, as noted earlier) MAY also transform the
   stored path vector as needed to provide correct functionality.
   Systems designers must match the Path recording policy of their nodes
   with the routing policy in order to get a workable system.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.5%20Examples%20of%20Usage"></a><a class="selflink" href="#section-5.5" id="section-5.5">5.5</a> Examples of Usage</span>

   Note that some header fields (e.g. Content-Length) and session
   descriptions are omitted to provide a shorter and hopefully more
   readable presentation. The node marked REGISTRAR is a registrar and a
   proxy and serves as a home proxy. Thus, in the DNS the domain
   EXAMPLEHOME.COM points to the same host as REGISTRAR.EXAMPLEHOME.COM.

<span class="h4"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.5.1%20Example%20of%20Mechanism%20in%20REGISTER%20Transaction"></a><a class="selflink" href="#section-5.5.1" id="section-5.5.1">5.5.1</a> Example of Mechanism in REGISTER Transaction</span>

   As an example, we use the scenario from the Background section:

   UA1----P1-----P2----P3-----REGISTRAR






<span class="grey">Willis &amp; Hoeneisen          Standards Track                     [Page 7]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-8"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


   In this example, UA1 sends a REGISTER request to REGISTRAR.  This
   request transits its default outbound proxy P1, an intermediate proxy
   P2, and the firewall proxy for the home domain, P3, before reaching
   REGISTRAR.  Due to network topology and operational policy, P1 and
   and P3 need to be transited by requests from REGISTRAR or other nodes
   in the home network targeted to UA1.  P2 does not.  P1 and P3 have
   been configured to include themselves in Path header fields on
   REGISTER requests that they process.  UA1 has a current IP address of
   "192.0.2.4".

   Message sequence for REGISTER with Path:

   F1 Register UA1 -&gt; P1

      REGISTER sip:REGISTRAR.EXAMPLEHOME.COM SIP/2.0
      Via: SIP/2.0/UDP 192.0.2.4:5060;branch=z9hG4bKnashds7
      To: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;
      From: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;;tag=456248
      Call-ID: 843817637684230@998sdasdh09
      CSeq: 1826 REGISTER
      Contact: &lt;sip:UA1@192.0.2.4&gt;
      Supported: path
       . . .

   F2 Register P1 -&gt; P2

      REGISTER sip:REGISTRAR.EXAMPLEHOME.COM SIP/2.0
      Via: SIP/2.0/UDP 112.68.155.4:5060;branch=z9hG4bK34ghi7ab04
      Via: SIP/2.0/UDP 192.0.2.4:5060;branch=z9hG4bKnashds7
      To: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;
      From: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;;tag=456248
      Call-ID: 843817637684230@998sdasdh09
      CSeq: 1826 REGISTER
      Contact: &lt;sip:UA1@192.0.2.4&gt;
      Supported: path
      Path: &lt;sip:P1.EXAMPLEVISITED.COM;lr&gt;
       . . .

      Note: P1 has added itself to the Path.












<span class="grey">Willis &amp; Hoeneisen          Standards Track                     [Page 8]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-9"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


   F3 Register P2 -&gt; P3

      REGISTER sip:REGISTRAR.EXAMPLEHOME.COM SIP/2.0
      Via: SIP/2.0/UDP 178.73.76.230:5060;branch=z9hG4bKiokioukju908
      Via: SIP/2.0/UDP 112.68.155.4:5060;branch=z9hG4bK34ghi7ab04
      Via: SIP/2.0/UDP 192.0.2.4:5060;branch=z9hG4bKnashds7
      To: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;
      From: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;;tag=456248
      Call-ID: 843817637684230@998sdasdh09
      CSeq: 1826 REGISTER
      Contact: &lt;sip:UA1@192.0.2.4&gt;
      Supported: path
      Path: &lt;sip:P1.EXAMPLEVISITED.COM;lr&gt;
       . . .

      Note: P2 did NOT add itself to the Path.

   F4 Register P3 -&gt; REGISTRAR

      REGISTER sip:REGISTRAR.EXAMPLEHOME.COM SIP/2.0
      Via: SIP/2.0/UDP 19.31.97.3:5060;branch=z9hG4bKp3wer654363
      Via: SIP/2.0/UDP 178.73.76.230:5060;branch=z9hG4bKiokioukju908
      Via: SIP/2.0/UDP 112.68.155.4:5060;branch=z9hG4bK34ghi7ab04
      Via: SIP/2.0/UDP 192.0.2.4:5060;branch=z9hG4bKnashds7
      To: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;
      From: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;;tag=456248
      Call-ID: 843817637684230@998sdasdh09
      CSeq: 1826 REGISTER
      Contact: &lt;sip:UA1@192.0.2.4&gt;
      Supported: path
      Path: &lt;sip:P3.EXAMPLEHOME.COM;lr&gt;,&lt;sip:P1.EXAMPLEVISITED.COM;lr&gt;
       . . .

      Note: P3 added itself to the Path.

   F5 REGISTRAR executes Register

      REGISTRAR Stores:
      For UA1@EXAMPLEHOME.COM
      Contact: &lt;sip:UA1@192.0.2.4&gt;
      Supported: path
      Path: &lt;sip:P3.EXAMPLEHOME.COM;lr&gt;,&lt;sip:P1.EXAMPLEVISITED.COM;lr&gt;









<span class="grey">Willis &amp; Hoeneisen          Standards Track                     [Page 9]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-10"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


   F6 Register Response REGISTRAR -&gt; P3

      SIP/2.0 200 OK
      Via: SIP/2.0/UDP 19.31.97.3:5060;branch=z9hG4bKp3wer654363
      Via: SIP/2.0/UDP 178.73.76.230:5060;branch=z9hG4bKiokioukju908
      Via: SIP/2.0/UDP 112.68.155.4:5060;branch=z9hG4bK34ghi7ab04
      Via: SIP/2.0/UDP 192.0.2.4:5060;branch=z9hG4bKnashds7
      To: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;;tag=251077
      From: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;;tag=456248
      Call-ID: 843817637684230@998sdasdh09
      CSeq: 1826 REGISTER
      Contact: &lt;sip:UA1@192.0.2.4&gt;
      Supported: path
      Path: &lt;sip:P3.EXAMPLEHOME.COM;lr&gt;,&lt;sip:P1.EXAMPLEVISITED.COM;lr&gt;
       . . .

      Note: The Path header field in the response is identical to the
      one received in the REGISTER request.

   F7 Register Response P3 -&gt; P2

      SIP/2.0 200 OK
      Via: SIP/2.0/UDP 178.73.76.230:5060;branch=z9hG4bKiokioukju908
      Via: SIP/2.0/UDP 112.68.155.4:5060;branch=z9hG4bK34ghi7ab04
      Via: SIP/2.0/UDP 192.0.2.4:5060;branch=z9hG4bKnashds7
      To: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;;tag=251077
      From: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;;tag=456248
      Call-ID: 843817637684230@998sdasdh09
      CSeq: 1826 REGISTER
      Contact: &lt;sip:UA1@192.0.2.4&gt;
      Supported: path
      Path: &lt;sip:P3.EXAMPLEHOME.COM;lr&gt;,&lt;sip:P1.EXAMPLEVISITED.COM;lr&gt;
       . . .

   F8 Register Response P2 -&gt; P1

      SIP/2.0 200 OK
      Via: SIP/2.0/UDP 112.68.155.4:5060;branch=z9hG4bK34ghi7ab04
      Via: SIP/2.0/UDP 192.0.2.4:5060;branch=z9hG4bKnashds7
      To: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;;tag=251077
      From: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;;tag=456248
      Call-ID: 843817637684230@998sdasdh09
      CSeq: 1826 REGISTER
      Contact: &lt;sip:UA1@192.0.2.4&gt;
      Supported: path
      Path: &lt;sip:P3.EXAMPLEHOME.COM;lr&gt;,&lt;sip:P1.EXAMPLEVISITED.COM;lr&gt;
       . . .




<span class="grey">Willis &amp; Hoeneisen          Standards Track                    [Page 10]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-11"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


   F9 Register Response P1 -&gt; UA1

      SIP/2.0 200 OK
      Via: SIP/2.0/UDP 192.0.2.4:5060;branch=z9hG4bKnashds7
      To: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;;tag=251077
      From: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;;tag=456248
      Call-ID: 843817637684230@998sdasdh09
      CSeq: 1826 REGISTER
      Contact: &lt;sip:UA1@192.0.2.4&gt;
      Supported: path
      Path: &lt;sip:P3.EXAMPLEHOME.COM;lr&gt;,&lt;sip:P1.EXAMPLEVISITED.COM;lr&gt;
       . . .

<span class="h4"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.5.2%20Example%20of%20Mechanism%20in%20INVITE%20Transaction"></a><a class="selflink" href="#section-5.5.2" id="section-5.5.2">5.5.2</a> Example of Mechanism in INVITE Transaction</span>

   This example shows the message sequence for an INVITE transaction
   originating from UA2 eventually arriving at UA1.  REGISTRAR inserts a
   preloaded Route toward UA1 and retargets the request by replacing the
   request URI with the registered Contact.  It then sends the
   retargeted INVITE along the Path towards UA1.  Note that this example
   introduces foreign user agent UA2 (address "71.91.180.10") and
   foreign domain FOREIGN.ELSEWHERE.ORG.  We have extended the diagram
   from the previous example by adding UA2, and by showing P2 out-of-
   line indicating that it did not include itself in the path during
   registration.

   Scenario

         UA1----P1---------P3-----REGISTRAR
                     |               |
                     P2              |
                                     |
         UA2--------------------------

   Message sequence for INVITE using Path:

   F1 Invite UA2 -&gt; REGISTRAR

      INVITE UA1@EXAMPLEHOME.COM SIP/2.0
      Via: SIP/2.0/UDP 71.91.180.10:5060;branch=z9hG4bKe2i95c5st3R
      To: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;
      From: UA2 &lt;sip:UA2@FOREIGN.ELSEWHERE.ORG&gt;;tag=224497
      Call-ID: 48273181116@71.91.180.10
      CSeq: 29 INVITE
      Contact: &lt;sip:UA2@71.91.180.10&gt;
       . . .





<span class="grey">Willis &amp; Hoeneisen          Standards Track                    [Page 11]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-12"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


   F2 REGISTRAR processing

      REGISTRAR looks up name "UA1@EXAMPLEHOME.COM" and returns:
       - Contact = &lt;sip:UA1@192.0.2.4&gt;
       - Path vector = &lt;sip:P3.EXAMPLEHOME.COM;lr&gt;,
                       &lt;sip:P1.EXAMPLEVISITED.COM;lr&gt;

      Note: The Contact replaces the request-URI.  The path vector is
      pushed onto the Route stack (preloaded Route) of the outgoing
      INVITE request.  The topmost Route is used for making the
      routing decision (in conjunction with local policy).

   F3 Invite REGISTRAR  -&gt; P3

      INVITE UA1@192.0.2.4 SIP/2.0
      Via: SIP/2.0/UDP 143.70.6.83:5060;branch=z9hG4bKlj25C107a7b176
      Via: SIP/2.0/UDP 71.91.180.10:5060;branch=z9hG4bKe2i95c5st3R
      To: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;
      From: UA2 &lt;sip:UA2@FOREIGN.ELSEWHERE.ORG&gt;;tag=224497
      Call-ID: 48273181116@71.91.180.10
      CSeq: 29 INVITE
      Contact: &lt;sip:UA2@71.91.180.10&gt;
      Route: &lt;sip:P3.EXAMPLEHOME.COM;lr&gt;,&lt;sip:P1.EXAMPLEVISITED.COM;lr&gt;
       . . .

      Note: In this example REGISTRAR does not want to stay on the
      Route and therefore does not insert a Record-Route.

   F4 Invite P3 -&gt; P1

      INVITE UA1@192.0.2.4 SIP/2.0
      Via: SIP/2.0/UDP 19.31.97.3:5060;branch=z9hG4bKjasg7li7nc9e
      Via: SIP/2.0/UDP 143.70.6.83:5060;branch=z9hG4bKlj25C107a7b176
      Via: SIP/2.0/UDP 71.91.180.10:5060;branch=z9hG4bKe2i95c5st3R
      To: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;
      From: UA2 &lt;sip:UA2@FOREIGN.ELSEWHERE.ORG&gt;;tag=224497
      Call-ID: 48273181116@71.91.180.10
      CSeq: 29 INVITE
      Contact: &lt;sip:UA2@71.91.180.10&gt;
      Record-Route: &lt;sip:P3.EXAMPLEHOME.COM;lr&gt;
      Route: &lt;sip:P1.EXAMPLEVISITED.COM;lr&gt;
       . . .

      Note: P3 has added a Record-Route entry, indicating that it wants
      to be traversed by future messages in this dialog.






<span class="grey">Willis &amp; Hoeneisen          Standards Track                    [Page 12]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-13"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


   F5 Invite P1 -&gt; UA1

      INVITE UA1@192.0.2.4 SIP/2.0
      Via: SIP/2.0/UDP 112.68.155.4:5060;branch=z9hG4bKk5l1833o43p
      Via: SIP/2.0/UDP 19.31.97.3:5060;branch=z9hG4bKjasg7li7nc9e
      Via: SIP/2.0/UDP 143.70.6.83:5060;branch=z9hG4bKlj25C107a7b176
      Via: SIP/2.0/UDP 71.91.180.10:5060;branch=z9hG4bKe2i95c5st3R
      To: UA1 &lt;sip:UA1@EXAMPLEHOME.COM&gt;
      From: UA2 &lt;sip:UA2@FOREIGN.ELSEWHERE.ORG&gt;;tag=224497
      Call-ID: 48273181116@71.91.180.10
      CSeq: 29 INVITE
      Contact: &lt;sip:UA2@71.91.180.10&gt;
      Record-Route: &lt;sip:P1.EXAMPLEVISITED.COM;lr&gt;
      Record-Route: &lt;sip:P3.EXAMPLEHOME.COM;lr&gt;
       . . .

      Note: P1 has added a Record-Route entry, indicating that it wants
      to be traversed by future messages in this dialog.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/6.%20Security%20Considerations"></a><a class="selflink" href="#section-6" id="section-6">6</a>. Security Considerations</span>

   There are few security considerations for this document beyond those
   in SIP [<a href="#ref-1" title='"SIP: Session Initiation Protocol"'>1</a>].  From a security perspective, the Path extension and its
   usage are identical to the Record-Route header field of basic SIP.
   Note that the transparency of the user expectations are preserved by
   returning the final Path to the originating UA -- that is, the UA is
   informed which additional proxies have been inserted into the path
   for the registration associated with that response.

   The Path header field accumulates information in a hop-by-hop manner
   during REGISTER processing.  The return information is essentially
   end-to-end, that is, it is not altered by intermediate proxies.  This
   leads to two slightly different security approaches.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/6.1%20Considerations%20in%20REGISTER%20Request%20Processing"></a><a class="selflink" href="#section-6.1" id="section-6.1">6.1</a> Considerations in REGISTER Request Processing</span>

   Information accumulated in REGISTER processing causes additional
   proxies to be included in future requests between the registrar's
   location and the UA.  An attack that allowed an intruding proxy to
   add itself to this chain would allow the attacker to intercept future
   calls intended for the UA.

   An attacker could conceivably alter the Path either by altering data
   "on the wire" or by other manipulations (such as impersonation) that
   would cause it to be included in the SIP routing chain (a "node
   insertion" attack).  Altering data "on the wire" may be addressed
   adequately by the use of transport-layer integrity protection
   mechanisms such as TLS or IPSEC.  Proxy insertion can be addressed by



<span class="grey">Willis &amp; Hoeneisen          Standards Track                    [Page 13]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-14"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


   mutual authentication at the proxy layer, which can also be provided
   by TLS or IPSEC.  The "sips:" URI class defined in [<a href="#ref-1" title='"SIP: Session Initiation Protocol"'>1</a>] provides a
   mechanism by which a UA may request that intermediate proxies provide
   integrity protection and mutual authentication.

   Systems using the Path mechanism SHOULD use appropriate mechanisms
   (TLS, IPSEC, etc.) to provide message integrity and mutual
   authentication.  UAs SHOULD use "sips:" to request transitive
   protection.

   The registering UA SHOULD use S/MIME mechanisms to provide a
   protected copy of the original request to the registrar.  In this
   case, the UA SHOULD include a Supported header field with a value
   indicating support for the Path extension in the protected copy.
   Registrars receiving such as request MUST honor the Path extension
   only if support is indicated in the protected header field.  Further,
   they SHOULD compare the unprotected Supported header field with the
   protected Supported header field and take appropriate action in the
   event that an intermediate has altered the message to indicate
   support for Path when it was not indicated by the requesting UA.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/6.2%20Considerations%20in%20REGISTER%20Response%20Processing"></a><a class="selflink" href="#section-6.2" id="section-6.2">6.2</a> Considerations in REGISTER Response Processing</span>

   The data returned to the UA by the Path header field in the response
   to the REGISTER request is there to provide openness to the UA.  The
   registrar is telling the UA, "These are the intermediate proxies that
   will be included on future requests to you processed through me".  By
   inspection of this header field, the UA may be able to detect node
   insertion attacks that involve inserting a proxy into the SIP routing
   chain.  S/MIME techniques may be used to prevent alteration of this
   header field by intermediate proxies during response processing.

   As specified, there is no requirement for arbitrary proxies between
   the UA and the registrar to modify the Path header field in the
   REGISTER response.  Consequently, we may use an end-to-end protection
   technique.  The S/MIME technique defined in [<a href="#ref-1" title='"SIP: Session Initiation Protocol"'>1</a>] provides an effective
   mechanism.  Using this technique, the registrar makes a copy of the
   complete response, signs it, and attaches it as a body to the
   response.  The UA may then verify this response, assuring an
   unmodified Path header field is received.

   In addition to the hop-by-hop integrity protection and mutual
   authentication measures suggested for REGISTER request processing in
   the preceding section, systems using Path header fields SHOULD
   implement end-to-end protection using S/MIME.  More specifically,
   registrars returning a Path header field SHOULD attach a signed
   S/MIME of the response, and UAs receiving a REGISTER response
   containing a Path header field SHOULD validate the message using the



<span class="grey">Willis &amp; Hoeneisen          Standards Track                    [Page 14]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-15"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


   S/MIME technique.  Furthermore, UAs receiving a Path header field in
   a REGISTER response SHOULD render it to the user, or (where feasible)
   check it programmatically.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/7.%20IANA%20Considerations"></a><a class="selflink" href="#section-7" id="section-7">7</a>. IANA Considerations</span>

   This document defines the SIP extension header field "Path", which
   the IANA has added to the registry of SIP header fields defined in
   SIP [<a href="#ref-1" title='"SIP: Session Initiation Protocol"'>1</a>].

   This document also defines the SIP option tag "path" which IANA has
   added to the registry of SIP option tags defined in SIP [<a href="#ref-1" title='"SIP: Session Initiation Protocol"'>1</a>].

   The following is the registration for the Path header field:

      RFC Number: <a href="./rfc3327">RFC3327</a>

      Header Field Name: Path

      Compact Form: none

   The following is the registration for the path option tag:

      RFC Number: <a href="./rfc3327">RFC3327</a>

      Option Tag: path

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/8.%20Acknowledgements"></a><a class="selflink" href="#section-8" id="section-8">8</a>. Acknowledgements</span>

   Min Huang and Stinson Mathai, who put together the original proposal
   in 3GPP for this mechanism, and worked out most of the 3GPP
   procedures in 24.229.

   Keith Drage, Bill Marshall, and Miguel Angel Garcia-Martin who argued
   with everybody a lot about the idea as well as helped refine the
   requirements.

   Juha Heinanen, who argued steadfastly against standardizing the
   function of discovering the home proxy with this technique in this
   document.











<span class="grey">Willis &amp; Hoeneisen          Standards Track                    [Page 15]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-16"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


Normative References

   [<a id="ref-1">1</a>] Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A.,
       Peterson, J., Sparks, R., Handley, M. and E. Schooler, "SIP:
       Session Initiation Protocol", <a href="./rfc3261">RFC 3261</a>, June 2002.

   [<a id="ref-2">2</a>] Bradner, S., "The Internet Standards Process -- Revision 3", <a href="https://www.rfc-editor.org/bcp/bcp9">BCP</a>
       <a href="https://www.rfc-editor.org/bcp/bcp9">9</a>, <a href="./rfc2026">RFC 2026</a>, October 1996.

   [<a id="ref-3">3</a>] Bradner, S., "Key words for use in RFCs to Indicate Requirement
       Levels", <a href="https://www.rfc-editor.org/bcp/bcp14">BCP 14</a>, <a href="./rfc2119">RFC 2119</a>, March 1997.

   [<a id="ref-4">4</a>] Postel, J. and J. Reynolds, "Instructions to RFC Authors", <a href="./rfc2223">RFC</a>
       <a href="./rfc2223">2223</a>, October 1997.

Non-Normative References

   [<a id="ref-5">5</a>] Garcia-Martin, MA., <a href="https://www.google.com/search?sitesearch=datatracker.ietf.org%2Fdoc%2Fhtml%2F&amp;q=inurl:draft-+%223GPP+Requirements+On+SIP%22" style="text-decoration: none">"3GPP Requirements On SIP"</a>, Work in Progress.

   [<a id="ref-6">6</a>] Mankin, A., <a href="https://www.google.com/search?sitesearch=datatracker.ietf.org%2Fdoc%2Fhtml%2F&amp;q=inurl:draft-+%22SIP+Change+Process%22" style="text-decoration: none">"SIP Change Process"</a>, Work in Progress.

Authors' Addresses

   Dean Willis
   dynamicsoft Inc.
   5100 Tennyson Parkway
   Suite 1200
   Plano, TX  75028
   US

   Phone: +1 972 473 5455
   EMail: dean.willis@softarmor.com
   URI:   <a href="http://www.dynamicsoft.com/">http://www.dynamicsoft.com/</a>


   Bernie Hoeneisen
   Switch
   Limmatquai 138
   CH-8001 Zuerich
   Switzerland

   Phone: +41 1 268 1515
   EMail: hoeneisen@switch.ch, b.hoeneisen@ieee.org
   URI:   <a href="http://www.switch.ch/">http://www.switch.ch/</a>







<span class="grey">Willis &amp; Hoeneisen          Standards Track                    [Page 16]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-17"></span>
<span class="grey"><a href="./rfc3327">RFC 3327</a>          Path Extension Header Field for SIP      December 2002</span>


Full Copyright Statement

   Copyright (C) The Internet Society (2002).  All Rights Reserved.

   This document and translations of it may be copied and furnished to
   others, and derivative works that comment on or otherwise explain it
   or assist in its implementation may be prepared, copied, published
   and distributed, in whole or in part, without restriction of any
   kind, provided that the above copyright notice and this paragraph are
   included on all such copies and derivative works.  However, this
   document itself may not be modified in any way, such as by removing
   the copyright notice or references to the Internet Society or other
   Internet organizations, except as needed for the purpose of
   developing Internet standards in which case the procedures for
   copyrights defined in the Internet Standards process must be
   followed, or as required to translate it into languages other than
   English.

   The limited permissions granted above are perpetual and will not be
   revoked by the Internet Society or its successors or assigns.

   This document and the information contained herein is provided on an
   "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
   BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
   HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.

Acknowledgement

   Funding for the RFC Editor function is currently provided by the
   Internet Society.



















Willis &amp; Hoeneisen          Standards Track                    [Page 17]
</pre>
</body></html>