<html><head></head><body><pre>Internet Engineering Task Force (IETF)                        T. Mizrahi
Request for Comments: 7820                                       Marvell
Category: Experimental                                        March 2016
ISSN: 2070-1721


                       <span class="h1">UDP Checksum Complement in</span>
          <span class="h1">the One-Way Active Measurement Protocol (OWAMP) and</span>
              <span class="h1">Two-Way Active Measurement Protocol (TWAMP)</span>

Abstract

   The One-Way Active Measurement Protocol (OWAMP) and the Two-Way
   Active Measurement Protocol (TWAMP) are used for performance
   monitoring in IP networks.  Delay measurement is performed in these
   protocols by using timestamped test packets.  Some implementations
   use hardware-based timestamping engines that integrate the accurate
   transmission time into every outgoing OWAMP/TWAMP test packet during
   transmission.  Since these packets are transported over UDP, the UDP
   Checksum field is then updated to reflect this modification.  This
   document proposes to use the last 2 octets of every test packet as a
   Checksum Complement, allowing timestamping engines to reflect the
   checksum modification in the last 2 octets rather than in the UDP
   Checksum field.  The behavior defined in this document is completely
   interoperable with existing OWAMP/TWAMP implementations.

Status of This Memo

   This document is not an Internet Standards Track specification; it is
   published for examination, experimental implementation, and
   evaluation.

   This document defines an Experimental Protocol for the Internet
   community.  This document is a product of the Internet Engineering
   Task Force (IETF).  It represents the consensus of the IETF
   community.  It has received public review and has been approved for
   publication by the Internet Engineering Steering Group (IESG).  Not
   all documents approved by the IESG are a candidate for any level of
   Internet Standard; see <a href="./rfc5741#section-2">SectionÂ 2 of RFC 5741</a>.

   Information about the current status of this document, any errata,
   and how to provide feedback on it may be obtained at
   <a href="http://www.rfc-editor.org/info/rfc7820">http://www.rfc-editor.org/info/rfc7820</a>.








<span class="grey">Mizrahi                       Experimental                      [Page 1]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-2"></span>
<span class="grey"><a href="./rfc7820">RFC 7820</a>           OWAMP and TWAMP Checksum Complement        March 2016</span>


Copyright Notice

   Copyright (c) 2016 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="https://www.rfc-editor.org/bcp/bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.

Table of Contents

   <a href="#section-1">1</a>. Introduction ....................................................<a href="#page-3">3</a>
   <a href="#section-2">2</a>. Conventions Used in This Document ...............................<a href="#page-5">5</a>
      <a href="#section-2.1">2.1</a>. Terminology ................................................<a href="#page-5">5</a>
      <a href="#section-2.2">2.2</a>. Abbreviations ..............................................<a href="#page-5">5</a>
   <a href="#section-3">3</a>. Using the UDP Checksum Complement in OWAMP and TWAMP ............<a href="#page-6">6</a>
      <a href="#section-3.1">3.1</a>. Overview ...................................................<a href="#page-6">6</a>
      <a href="#section-3.2">3.2</a>. OWAMP/TWAMP Test Packets with Checksum Complement ..........<a href="#page-6">6</a>
           3.2.1. Transmission of OWAMP/TWAMP with Checksum
                  Complement .........................................<a href="#page-10">10</a>
           3.2.2. Intermediate Updates of OWAMP/TWAMP with
                  Checksum Complement ................................<a href="#page-10">10</a>
           <a href="#section-3.2.3">3.2.3</a>. Reception of OWAMP/TWAMP with Checksum Complement ..10
      <a href="#section-3.3">3.3</a>. Interoperability with Existing Implementations ............<a href="#page-10">10</a>
      3.4. Using the Checksum Complement with or without
           Authentication ............................................<a href="#page-11">11</a>
           <a href="#section-3.4.1">3.4.1</a>. Checksum Complement in Authenticated Mode ..........<a href="#page-11">11</a>
           <a href="#section-3.4.2">3.4.2</a>. Checksum Complement in Encrypted Mode ..............<a href="#page-11">11</a>
   <a href="#section-4">4</a>. Security Considerations ........................................<a href="#page-12">12</a>
   <a href="#section-5">5</a>. References .....................................................<a href="#page-12">12</a>
      <a href="#section-5.1">5.1</a>. Normative References ......................................<a href="#page-12">12</a>
      <a href="#section-5.2">5.2</a>. Informative References ....................................<a href="#page-13">13</a>
   <a href="#appendix-A">Appendix A</a>. Checksum Complement Usage Example .....................<a href="#page-14">14</a>
   Acknowledgments ...................................................<a href="#page-15">15</a>
   Author's Address ..................................................<a href="#page-15">15</a>










<span class="grey">Mizrahi                       Experimental                      [Page 2]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-3"></span>
<span class="grey"><a href="./rfc7820">RFC 7820</a>           OWAMP and TWAMP Checksum Complement        March 2016</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.%20%20Introduction"></a><a class="selflink" href="#section-1" id="section-1">1</a>.  Introduction</span>

   The One-Way Active Measurement Protocol [<a href="#ref-OWAMP" title='"A One-way Active Measurement Protocol (OWAMP)"'>OWAMP</a>] and the Two-Way
   Active Measurement Protocol [<a href="#ref-TWAMP" title='"A Two-Way Active Measurement Protocol (TWAMP)"'>TWAMP</a>] are used for performance
   monitoring in IP networks.

   Delay and delay variation are two of the metrics that OWAMP/TWAMP can
   measure.  Measurement is performed using timestamped test packets.
   In some use cases, such as carrier networks, these two metrics are an
   essential aspect of the Service Level Agreement (SLA) and therefore
   must be measured with a high degree of accuracy.  If packets are
   timestamped in hardware as they exit the host, then greater accuracy
   is possible in comparison to higher-layer timestamps (as explained
   further below).

   The accuracy of delay measurements relies on the timestamping method
   and its implementation.  In order to facilitate accurate
   timestamping, an implementation can use a hardware-based timestamping
   engine, as shown in Figure 1.  In such cases, the OWAMP/TWAMP packets
   are sent and received by a software layer, whereas the timestamping
   engine modifies every outgoing test packet by incorporating its
   accurate transmission time into the Timestamp field in the packet.





























<span class="grey">Mizrahi                       Experimental                      [Page 3]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-4"></span>
<span class="grey"><a href="./rfc7820">RFC 7820</a>           OWAMP and TWAMP Checksum Complement        March 2016</span>


                  OWAMP/TWAMP-enabled Node
                    +-------------------+
                    |                   |
                    |   +-----------+   |
     Software       |   |OWAMP/TWAMP|   |
                    |   | protocol  |   |
                    |   +-----+-----+   |
                    |         |         |     +-----------------------+
                    |   +-----+-----+   |    / Intermediate entity    |
                    |   | Accurate  |   |   /  in charge of:          |
     ASIC/FPGA      |   | Timestamp |   |  /__ - Timestamping         |
                    |   |  engine   |   |     |- Updating checksum or |
                    |   +-----------+   |     |  Checksum Complement  |
                    |         |         |     +-----------------------+
                    +---------+---------+
                              |
                              |test packets
                              |
                          ___ v _
                         /   \_/ \__
                        /           \_
                       /     IP      /
                       \_  Network  /
                        /           \
                        \__/\_   ___/
                              \_/

     ASIC: Application-Specific Integrated Circuit
     FPGA: Field-Programmable Gate Array

              Figure 1: Accurate Timestamping in OWAMP/TWAMP

   OWAMP/TWAMP test packets are transported over UDP.  When the UDP
   payload is changed by an intermediate entity such as the timestamping
   engine, the UDP Checksum field must be updated to reflect the new
   payload.  When using UDP over IPv4 [<a href="#ref-UDP" title='"User Datagram Protocol"'>UDP</a>], an intermediate entity that
   cannot update the value of the UDP Checksum has no choice except to
   assign a value of zero to the Checksum field, causing the receiver to
   ignore the Checksum field and potentially accept corrupted packets.
   UDP over IPv6, as defined in [<a href="#ref-IPv6" title='"Internet Protocol, Version 6 (IPv6) Specification"'>IPv6</a>], does not allow a zero checksum,
   except in specific cases [<a href="#ref-ZeroChecksum">ZeroChecksum</a>].  As discussed in
   [<a href="#ref-ZeroChecksum">ZeroChecksum</a>], the use of a zero checksum is generally not
   recommended and should be avoided to the extent possible.

   Since an intermediate entity only modifies a specific field in the
   packet, i.e., the Timestamp field, the UDP Checksum update can be
   performed incrementally, using the concepts presented in [<a href="#ref-Checksum" title='"Computation of the Internet Checksum via Incremental Update"'>Checksum</a>].




<span class="grey">Mizrahi                       Experimental                      [Page 4]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-5"></span>
<span class="grey"><a href="./rfc7820">RFC 7820</a>           OWAMP and TWAMP Checksum Complement        March 2016</span>


   A similar problem is addressed in Annex E of [<a href="#ref-IEEE1588" title='"IEEE Standard for a Precision Clock Synchronization Protocol for Networked Measurement and Control Systems"'>IEEE1588</a>].  When the
   Precision Time Protocol (PTP) is transported over IPv6, 2 octets are
   appended to the end of the PTP payload for UDP Checksum updates.  The
   value of these 2 octets can be updated by an intermediate entity,
   causing the value of the UDP Checksum field to remain correct.

   This document defines a similar concept for [<a href="#ref-OWAMP" title='"A One-way Active Measurement Protocol (OWAMP)"'>OWAMP</a>] and [<a href="#ref-TWAMP" title='"A Two-Way Active Measurement Protocol (TWAMP)"'>TWAMP</a>],
   allowing intermediate entities to update OWAMP/TWAMP test packets and
   maintain the correctness of the UDP Checksum by modifying the last
   2 octets of the packet.

   The term "Checksum Complement" is used throughout this document and
   refers to the 2 octets at the end of the UDP payload, used for
   updating the UDP Checksum by intermediate entities.

   The usage of the Checksum Complement can in some cases simplify the
   implementation, because if the packet data is processed in serial
   order, it is simpler to first update the Timestamp field and then
   update the Checksum Complement, rather than to update the timestamp
   and then update the UDP Checksum residing at the UDP header.

   The Checksum Complement mechanism is also defined for the Network
   Time Protocol in [<a href="./rfc7821" title='"UDP Checksum Complement in the Network Time Protocol (NTP)"'>RFC7821</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/2.%20%20Conventions%20Used%20in%20This%20Document"></a><a class="selflink" href="#section-2" id="section-2">2</a>.  Conventions Used in This Document</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/2.1.%20%20Terminology"></a><a class="selflink" href="#section-2.1" id="section-2.1">2.1</a>.  Terminology</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in [<a href="#ref-KEYWORDS" title='"Key words for use in RFCs to Indicate Requirement Levels"'>KEYWORDS</a>].

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/2.2.%20%20Abbreviations"></a><a class="selflink" href="#section-2.2" id="section-2.2">2.2</a>.  Abbreviations</span>

   HMAC     Hashed Message Authentication Code

   OWAMP    One-Way Active Measurement Protocol

   PTP      Precision Time Protocol

   TWAMP    Two-Way Active Measurement Protocol

   UDP      User Datagram Protocol








<span class="grey">Mizrahi                       Experimental                      [Page 5]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-6"></span>
<span class="grey"><a href="./rfc7820">RFC 7820</a>           OWAMP and TWAMP Checksum Complement        March 2016</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.%20%20Using%20the%20UDP%20Checksum%20Complement%20in%20OWAMP%20and%20TWAMP"></a><a class="selflink" href="#section-3" id="section-3">3</a>.  Using the UDP Checksum Complement in OWAMP and TWAMP</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.1.%20%20Overview"></a><a class="selflink" href="#section-3.1" id="section-3.1">3.1</a>.  Overview</span>

   The UDP Checksum Complement is a 2-octet field that is piggybacked at
   the end of the test packet.  It resides in the last 2 octets of the
   UDP payload.

                   +----------------------------------+
                   |         IPv4/IPv6 Header         |
                   +----------------------------------+
                   |            UDP Header            |
                   +----------------------------------+
            ^      |                                  |
            |      |           OWAMP/TWAMP            |
           UDP     |             packet               |
          Payload  +----------------------------------+
            |      |UDP Checksum Complement (2 octets)|
            v      +----------------------------------+

         Figure 2: Checksum Complement in OWAMP/TWAMP Test Packets

   The Checksum Complement is used to compensate for changes performed
   in the packet by intermediate entities, as described in the
   Introduction (<a href="#section-1">Section 1</a>).  An example of the usage of the Checksum
   Complement is provided in <a href="#appendix-A">Appendix A</a>.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.2.%20%20OWAMP%2FTWAMP%20Test%20Packets%20with%20Checksum%20Complement"></a><a class="selflink" href="#section-3.2" id="section-3.2">3.2</a>.  OWAMP/TWAMP Test Packets with Checksum Complement</span>

   The One-Way Active Measurement Protocol [<a href="#ref-OWAMP" title='"A One-way Active Measurement Protocol (OWAMP)"'>OWAMP</a>] and the Two-Way
   Active Measurement Protocol [<a href="#ref-TWAMP" title='"A Two-Way Active Measurement Protocol (TWAMP)"'>TWAMP</a>] both make use of timestamped test
   packets.  A Checksum Complement MAY be used in the following cases:

   o  In OWAMP test packets sent by the sender to the receiver.

   o  In TWAMP test packets sent by the sender to the reflector.

   o  In TWAMP test packets sent by the reflector to the sender.

   OWAMP/TWAMP test packets are transported over UDP, either over IPv4
   or over IPv6.  This document applies to both OWAMP and TWAMP over
   IPv4 and over IPv6.









<span class="grey">Mizrahi                       Experimental                      [Page 6]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-7"></span>
<span class="grey"><a href="./rfc7820">RFC 7820</a>           OWAMP and TWAMP Checksum Complement        March 2016</span>


   OWAMP/TWAMP test packets contain a Packet Padding field.  This
   document proposes to use the last 2 octets of the Packet Padding
   field as the Checksum Complement.  In this case, the Checksum
   Complement is always the last 2 octets of the UDP payload, and thus
   the field is located at (UDP Length - 2 octets) after the beginning
   of the UDP header.

   Figure 3 illustrates the OWAMP test packet format, including the UDP
   Checksum Complement.

     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                        Sequence Number                        |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                          Timestamp                            |
    |                                                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |        Error Estimate         |                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
    |                                                               |
    .                         Packet Padding                        .
    .                                                               .
    |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                               |      Checksum Complement      |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

            Figure 3: Checksum Complement in OWAMP Test Packets























<span class="grey">Mizrahi                       Experimental                      [Page 7]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-8"></span>
<span class="grey"><a href="./rfc7820">RFC 7820</a>           OWAMP and TWAMP Checksum Complement        March 2016</span>


   Figure 4 illustrates the TWAMP test packet format, including the UDP
   Checksum Complement.  ("TTL" means "Time to Live", and "MBZ" refers
   to the "MUST be zero" field [<a href="#ref-IPPMIPsec" title='"IKEv2-Derived Shared Secret Key for the One-Way Active Measurement Protocol (OWAMP) and Two-Way Active Measurement Protocol (TWAMP)"'>IPPMIPsec</a>].)

     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                        Sequence Number                        |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                          Timestamp                            |
    |                                                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |         Error Estimate        |           MBZ                 |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                     Receive Timestamp                         |
    |                                                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                   Sender Sequence Number                      |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                      Sender Timestamp                         |
    |                                                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |      Sender Error Estimate    |           MBZ                 |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |  Sender TTL   |                                               |
    +-+-+-+-+-+-+-+-+                                               +
    |                                                               |
    .                                                               .
    .                         Packet Padding                        .
    .                                                               .
    |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                               |     Checksum Complement       |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

            Figure 4: Checksum Complement in TWAMP Test Packets

   The length of the Packet Padding field in test packets is announced
   during the session initiation through the &lt;Padding Length&gt; field in
   the Request-Session message [<a href="#ref-OWAMP" title='"A One-way Active Measurement Protocol (OWAMP)"'>OWAMP</a>] or in the Request-TW-Session
   message [<a href="#ref-TWAMP" title='"A Two-Way Active Measurement Protocol (TWAMP)"'>TWAMP</a>].











<span class="grey">Mizrahi                       Experimental                      [Page 8]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-9"></span>
<span class="grey"><a href="./rfc7820">RFC 7820</a>           OWAMP and TWAMP Checksum Complement        March 2016</span>


   When a Checksum Complement is included, the padding length MUST be
   sufficiently long to include the Checksum Complement:

   o  In OWAMP, the padding length is at least 2 octets, allowing the
      sender to incorporate the Checksum Complement in the last 2 octets
      of the padding.

   o  In TWAMP, the padding length is at least 29 octets in
      unauthenticated mode and at least 58 octets in authenticated mode.
      The additional padding is required, since the header of reflector
      test packets is longer than the header of sender test packets.
      The difference between the sender packet and the reflector packet
      is 27 octets in unauthenticated mode and 56 octets in
      authenticated mode.  Thus, the padding in reflector test packets
      is shorter than the padding in sender packets.  Using at least
      29 octets of padding (58 in authenticated mode) in sender test
      packets allows both the sender and the reflector to use a 2-octet
      Checksum Complement.  Note: If the minimal length requirement is
      not met, the reflector cannot use a Checksum Complement in the
      reflected test packets, but the sender can use a Checksum
      Complement in the test packets it transmits.

   o  Two optional TWAMP features are defined in [<a href="#ref-TWAMP-Reflect">TWAMP-Reflect</a>]:
      octet reflection and symmetrical size.  When at least one of these
      features is enabled, the Request-TW-Session message includes the
      &lt;Padding Length&gt; field, as well as a &lt;Length of padding to
      reflect&gt; field.  In this case, both fields must be sufficiently
      long to allow at least 2 octets of padding in both sender test
      packets and reflector test packets.  Specifically, when octet
      reflection is enabled, the two Length fields must be defined such
      that the padding expands at least 2 octets beyond the end of the
      reflected octets.

   As described in <a href="#section-1">Section 1</a>, the extensions described in this document
   are implemented by two logical layers -- a protocol layer and a
   timestamping layer.  It is assumed that the two layers are
   synchronized regarding whether the usage of the Checksum Complement
   is enabled or not; since both logical layers reside in the same
   network device, it is assumed that there is no need for a protocol
   that synchronizes this information between the two layers.  When
   Checksum Complement usage is enabled, the protocol layer must take
   care to verify that test packets include the necessary padding,
   thereby avoiding the need for the timestamping layer to verify that
   en-route test packets include the necessary padding.







<span class="grey">Mizrahi                       Experimental                      [Page 9]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-10"></span>
<span class="grey"><a href="./rfc7820">RFC 7820</a>           OWAMP and TWAMP Checksum Complement        March 2016</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.2.1.%20%20Transmission%20of%20OWAMP%2FTWAMP%20with%20Checksum%20Complement"></a><a class="selflink" href="#section-3.2.1" id="section-3.2.1">3.2.1</a>.  Transmission of OWAMP/TWAMP with Checksum Complement</span>

   The transmitter of an OWAMP/TWAMP test packet MAY include a Checksum
   Complement field, incorporated in the last 2 octets of the padding.

   A transmitter that includes a Checksum Complement in its outgoing
   test packets MUST include a Packet Padding field in these packets,
   the length of which MUST be sufficient to include the Checksum
   Complement.  The length of the Packet Padding field is negotiated
   during session initiation, as described in <a href="#section-3.2">Section 3.2</a>.

<span class="h4"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.2.2.%20%20Intermediate%20Updates%20of%20OWAMP%2FTWAMP%20with%20Checksum%20Complement"></a><a class="selflink" href="#section-3.2.2" id="section-3.2.2">3.2.2</a>.  Intermediate Updates of OWAMP/TWAMP with Checksum Complement</span>

   An intermediate entity that receives and alters an OWAMP/TWAMP
   test packet can alter either the UDP Checksum field or the Checksum
   Complement field in order to maintain the correctness of the
   UDP Checksum value.

<span class="h4"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.2.3.%20%20Reception%20of%20OWAMP%2FTWAMP%20with%20Checksum%20Complement"></a><a class="selflink" href="#section-3.2.3" id="section-3.2.3">3.2.3</a>.  Reception of OWAMP/TWAMP with Checksum Complement</span>

   This document does not impose new requirements on the receiving end
   of an OWAMP/TWAMP test packet.

   The UDP layer at the receiving end verifies the UDP Checksum of
   received test packets, and the OWAMP/TWAMP layer should treat the
   Checksum Complement as part of the padding.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.3.%20%20Interoperability%20with%20Existing%20Implementations"></a><a class="selflink" href="#section-3.3" id="section-3.3">3.3</a>.  Interoperability with Existing Implementations</span>

   The behavior defined in this document does not impose new
   requirements on the reception behavior of OWAMP/TWAMP test packets.
   The protocol stack of the receiving host performs the conventional
   UDP Checksum verification; thus, from the perspective of the
   receiving host, the existence of the Checksum Complement is
   transparent.  Therefore, the functionality described in this document
   allows interoperability with existing implementations that comply
   with [<a href="#ref-OWAMP" title='"A One-way Active Measurement Protocol (OWAMP)"'>OWAMP</a>] or [<a href="#ref-TWAMP" title='"A Two-Way Active Measurement Protocol (TWAMP)"'>TWAMP</a>].














<span class="grey">Mizrahi                       Experimental                     [Page 10]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-11"></span>
<span class="grey"><a href="./rfc7820">RFC 7820</a>           OWAMP and TWAMP Checksum Complement        March 2016</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.4.%20%20Using%20the%20Checksum%20Complement%20with%20or%20without%20Authentication"></a><a class="selflink" href="#section-3.4" id="section-3.4">3.4</a>.  Using the Checksum Complement with or without Authentication</span>

   Both OWAMP and TWAMP may use authentication or encryption, as defined
   in [<a href="#ref-OWAMP" title='"A One-way Active Measurement Protocol (OWAMP)"'>OWAMP</a>] and [<a href="#ref-TWAMP" title='"A Two-Way Active Measurement Protocol (TWAMP)"'>TWAMP</a>].

<span class="h4"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.4.1.%20%20Checksum%20Complement%20in%20Authenticated%20Mode"></a><a class="selflink" href="#section-3.4.1" id="section-3.4.1">3.4.1</a>.  Checksum Complement in Authenticated Mode</span>

   OWAMP and TWAMP test packets can be authenticated using an HMAC
   (Hashed Message Authentication Code).  The HMAC covers some of the
   fields in the test packet header.  The HMAC does not cover the
   Timestamp field and the Packet Padding field.

   A Checksum Complement MAY be used when authentication is enabled.  In
   this case, an intermediate entity can timestamp test packets and
   update their Checksum Complement field without modifying the HMAC.

<span class="h4"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.4.2.%20%20Checksum%20Complement%20in%20Encrypted%20Mode"></a><a class="selflink" href="#section-3.4.2" id="section-3.4.2">3.4.2</a>.  Checksum Complement in Encrypted Mode</span>

   When OWAMP and TWAMP are used in encrypted mode, the Timestamp field
   is encrypted.

   A Checksum Complement SHOULD NOT be used in encrypted mode.  The
   Checksum Complement is effective in both unauthenticated mode and
   authenticated mode, allowing the intermediate entity to perform
   serial processing of the packet without storing and forwarding it.

   On the other hand, in encrypted mode, an intermediate entity that
   timestamps a test packet must also re-encrypt the packet accordingly.
   Re-encryption typically requires the intermediate entity to store the
   packet, re-encrypt it, and then forward it.  Thus, from an
   implementer's perspective, the Checksum Complement has very little
   value in encrypted mode, as it does not necessarily simplify the
   implementation.

   Note: While [<a href="#ref-OWAMP" title='"A One-way Active Measurement Protocol (OWAMP)"'>OWAMP</a>] and [<a href="#ref-TWAMP" title='"A Two-Way Active Measurement Protocol (TWAMP)"'>TWAMP</a>] include an inherent security
   mechanism, these protocols can be secured by other measures, e.g.,
   [<a href="#ref-IPPMIPsec" title='"IKEv2-Derived Shared Secret Key for the One-Way Active Measurement Protocol (OWAMP) and Two-Way Active Measurement Protocol (TWAMP)"'>IPPMIPsec</a>].  For reasons similar to those described above, a
   Checksum Complement SHOULD NOT be used in this case.













<span class="grey">Mizrahi                       Experimental                     [Page 11]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-12"></span>
<span class="grey"><a href="./rfc7820">RFC 7820</a>           OWAMP and TWAMP Checksum Complement        March 2016</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.%20%20Security%20Considerations"></a><a class="selflink" href="#section-4" id="section-4">4</a>.  Security Considerations</span>

   This document describes how a Checksum Complement extension can be
   used for maintaining the correctness of the UDP Checksum.

   The purpose of this extension is to ease the implementation of
   accurate timestamping engines, as illustrated in Figure 1.  The
   extension is intended to be used internally in an OWAMP/TWAMP-enabled
   node, and not intended to be used by intermediate switches and
   routers that reside between the sender and the receiver/reflector.
   Any modification of a test packet by intermediate switches or routers
   should be considered a malicious man-in-the-middle (MITM) attack.

   It is important to emphasize that the scheme described in this
   document does not increase the protocol's vulnerability to MITM
   attacks; a MITM attacker who maliciously modifies a packet and its
   Checksum Complement is logically equivalent to a MITM attacker who
   modifies a packet and its UDP Checksum field.

   The concept described in this document is intended to be used only in
   unauthenticated mode or authenticated mode.  As described in
   <a href="#section-3.4.2">Section 3.4.2</a>, using the Checksum Complement in encrypted mode does
   not simplify the implementation compared to using the conventional
   checksum, and therefore the Checksum Complement should not be used.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.%20%20References"></a><a class="selflink" href="#section-5" id="section-5">5</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.1.%20%20Normative%20References"></a><a class="selflink" href="#section-5.1" id="section-5.1">5.1</a>.  Normative References</span>

   [<a id="ref-Checksum">Checksum</a>]  Rijsinghani, A., Ed., "Computation of the Internet
               Checksum via Incremental Update", <a href="./rfc1624">RFC 1624</a>,
               DOI 10.17487/RFC1624, May 1994,
               &lt;<a href="http://www.rfc-editor.org/info/rfc1624">http://www.rfc-editor.org/info/rfc1624</a>&gt;.

   [<a id="ref-IPv6">IPv6</a>]      Deering, S. and R. Hinden, "Internet Protocol, Version 6
               (IPv6) Specification", <a href="./rfc2460">RFC 2460</a>, DOI 10.17487/RFC2460,
               December 1998, &lt;<a href="http://www.rfc-editor.org/info/rfc2460">http://www.rfc-editor.org/info/rfc2460</a>&gt;.

   [<a id="ref-KEYWORDS">KEYWORDS</a>]  Bradner, S., "Key words for use in RFCs to Indicate
               Requirement Levels", <a href="https://www.rfc-editor.org/bcp/bcp14">BCP 14</a>, <a href="./rfc2119">RFC 2119</a>,
               DOI 10.17487/RFC2119, March 1997,
               &lt;<a href="http://www.rfc-editor.org/info/rfc2119">http://www.rfc-editor.org/info/rfc2119</a>&gt;.

   [<a id="ref-OWAMP">OWAMP</a>]     Shalunov, S., Teitelbaum, B., Karp, A., Boote, J., and M.
               Zekauskas, "A One-way Active Measurement Protocol
               (OWAMP)", <a href="./rfc4656">RFC 4656</a>, DOI 10.17487/RFC4656, September 2006,
               &lt;<a href="http://www.rfc-editor.org/info/rfc4656">http://www.rfc-editor.org/info/rfc4656</a>&gt;.




<span class="grey">Mizrahi                       Experimental                     [Page 12]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-13"></span>
<span class="grey"><a href="./rfc7820">RFC 7820</a>           OWAMP and TWAMP Checksum Complement        March 2016</span>


   [<a id="ref-TWAMP">TWAMP</a>]     Hedayat, K., Krzanowski, R., Morton, A., Yum, K., and J.
               Babiarz, "A Two-Way Active Measurement Protocol (TWAMP)",
               <a href="./rfc5357">RFC 5357</a>, DOI 10.17487/RFC5357, October 2008,
               &lt;<a href="http://www.rfc-editor.org/info/rfc5357">http://www.rfc-editor.org/info/rfc5357</a>&gt;.

   [<a id="ref-TWAMP-Reflect">TWAMP-Reflect</a>]
               Morton, A. and L. Ciavattone, "Two-Way Active Measurement
               Protocol (TWAMP) Reflect Octets and Symmetrical Size
               Features", <a href="./rfc6038">RFC 6038</a>, DOI 10.17487/RFC6038, October 2010,
               &lt;<a href="http://www.rfc-editor.org/info/rfc6038">http://www.rfc-editor.org/info/rfc6038</a>&gt;.

   [<a id="ref-UDP">UDP</a>]       Postel, J., "User Datagram Protocol", STD 6, <a href="./rfc768">RFC 768</a>,
               DOI 10.17487/RFC768, August 1980,
               &lt;<a href="http://www.rfc-editor.org/info/rfc768">http://www.rfc-editor.org/info/rfc768</a>&gt;.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.2.%20%20Informative%20References"></a><a class="selflink" href="#section-5.2" id="section-5.2">5.2</a>.  Informative References</span>

   [<a id="ref-IEEE1588">IEEE1588</a>]  IEEE, "IEEE Standard for a Precision Clock
               Synchronization Protocol for Networked Measurement and
               Control Systems", IEEE Std 1588-2008,
               DOI 10.1109/IEEESTD.2008.4579760, July 2008.

   [<a id="ref-IPPMIPsec">IPPMIPsec</a>] Pentikousis, K., Ed., Zhang, E., and Y. Cui,
               "IKEv2-Derived Shared Secret Key for the One-Way Active
               Measurement Protocol (OWAMP) and Two-Way Active
               Measurement Protocol (TWAMP)", <a href="./rfc7717">RFC 7717</a>,
               DOI 10.17487/RFC7717, December 2015,
               &lt;<a href="http://www.rfc-editor.org/info/rfc7717">http://www.rfc-editor.org/info/rfc7717</a>&gt;.

   [<a id="ref-RFC7821">RFC7821</a>]   Mizrahi, T., "UDP Checksum Complement in the Network Time
               Protocol (NTP)", <a href="./rfc7821">RFC 7821</a>, DOI 10.17487/RFC7821,
               March 2016, &lt;<a href="http://www.rfc-editor.org/info/rfc7821">http://www.rfc-editor.org/info/rfc7821</a>&gt;.

   [<a id="ref-ZeroChecksum">ZeroChecksum</a>]
               Fairhurst, G. and M. Westerlund, "Applicability Statement
               for the Use of IPv6 UDP Datagrams with Zero Checksums",
               <a href="./rfc6936">RFC 6936</a>, DOI 10.17487/RFC6936, April 2013,
               &lt;<a href="http://www.rfc-editor.org/info/rfc6936">http://www.rfc-editor.org/info/rfc6936</a>&gt;.













<span class="grey">Mizrahi                       Experimental                     [Page 13]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-14"></span>
<span class="grey"><a href="./rfc7820">RFC 7820</a>           OWAMP and TWAMP Checksum Complement        March 2016</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/Appendix%20A.%20%20Checksum%20Complement%20Usage%20Example"></a><a class="selflink" href="#appendix-A" id="appendix-A">Appendix A</a>.  Checksum Complement Usage Example</span>

   Consider a session between an OWAMP sender and an OWAMP receiver, in
   which the sender transmits test packets to the receiver.

   The sender's software layer generates an OWAMP test packet with a
   timestamp T and a UDP Checksum value U.  The value of U is the
   checksum of the UDP header, UDP payload, and pseudo-header.  Thus,
   U is equal to:

                        U = Const + checksum(T)                      (1)

   Where "Const" is the checksum of all the fields that are covered by
   the checksum, except the timestamp T.

   Recall that the sender's software emits the test packet with a
   Checksum Complement field, which is simply the last 2 octets of the
   padding.  In this example, it is assumed that the sender initially
   assigns zero to these 2 octets.

   The sender's timestamping engine updates the Timestamp field to the
   accurate time, changing its value from T to T'.  The sender also
   updates the Checksum Complement field from zero to a new value C,
   such that:

                  checksum(C) = checksum(T) - checksum(T')           (2)

   When the test packet is transmitted by the sender's timestamping
   engine, the value of the checksum remains U as before:

      U = Const + checksum(T) = Const + checksum(T) + checksum(T') -
          checksum(T') = Const + checksum(T') + checksum(C)          (3)

   Thus, after the timestamping engine has updated the timestamp,
   U remains the correct checksum of the packet.

   When the test packet reaches the receiver, the receiver performs a
   conventional UDP Checksum computation, and the computed value is U.
   Since the Checksum Complement is part of the padding, the value of
   checksum(C) is transparently included in the computation, as per
   Equation (3), without requiring special treatment by the receiver.










<span class="grey">Mizrahi                       Experimental                     [Page 14]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-15"></span>
<span class="grey"><a href="./rfc7820">RFC 7820</a>           OWAMP and TWAMP Checksum Complement        March 2016</span>


Acknowledgments

   The author gratefully acknowledges Al Morton, Greg Mirsky, Steve
   Baillargeon, Brian Haberman, and Spencer Dawkins for their helpful
   comments.

Author's Address

   Tal Mizrahi
   Marvell
   6 Hamada St.
   Yokneam, 20692
   Israel

   Email: talmi@marvell.com




































Mizrahi                       Experimental                     [Page 15]
</pre>
</body></html>