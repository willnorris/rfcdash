<html><head></head><body><pre>Internet Engineering Task Force (IETF)                            Q. Sun
Request for Comments: 7753                                 China Telecom
Category: Standards Track                                   M. Boucadair
ISSN: 2070-1721                                           France Telecom
                                                            S. Sivakumar
                                                           Cisco Systems
                                                                 C. Zhou
                                                     Huawei Technologies
                                                                 T. Tsou
                                                        Philips Lighting
                                                            S. Perreault
                                                     Jive Communications
                                                           February 2016


     <span class="h1">Port Control Protocol (PCP) Extension for Port-Set Allocation</span>

Abstract

   In some use cases, e.g., Lightweight 4over6, the client may require
   not just one port, but a port set.  This document defines an
   extension to the Port Control Protocol (PCP) that allows clients to
   manipulate a set of ports as a whole.  This is accomplished using a
   new MAP option: PORT_SET.

Status of This Memo

   This is an Internet Standards Track document.

   This document is a product of the Internet Engineering Task Force
   (IETF).  It represents the consensus of the IETF community.  It has
   received public review and has been approved for publication by the
   Internet Engineering Steering Group (IESG).  Further information on
   Internet Standards is available in <a href="./rfc5741#section-2">SectionÂ 2 of RFC 5741</a>.

   Information about the current status of this document, any errata,
   and how to provide feedback on it may be obtained at
   <a href="http://www.rfc-editor.org/info/rfc7753">http://www.rfc-editor.org/info/rfc7753</a>.













<span class="grey">Sun, et al.                  Standards Track                    [Page 1]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-2"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


Copyright Notice

   Copyright (c) 2016 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="https://www.rfc-editor.org/bcp/bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.





































<span class="grey">Sun, et al.                  Standards Track                    [Page 2]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-3"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


Table of Contents

   <a href="#section-1">1</a>. Introduction ....................................................<a href="#page-4">4</a>
      <a href="#section-1.1">1.1</a>. Applications Using Port Sets ...............................<a href="#page-4">4</a>
      <a href="#section-1.2">1.2</a>. Lightweight 4over6 .........................................<a href="#page-4">4</a>
      <a href="#section-1.3">1.3</a>. Firewall Control ...........................................<a href="#page-4">4</a>
      <a href="#section-1.4">1.4</a>. Discovering Stateless Port-Set Mappings ....................<a href="#page-5">5</a>
   <a href="#section-2">2</a>. The Need for PORT_SET ...........................................<a href="#page-5">5</a>
   <a href="#section-3">3</a>. Terminology .....................................................<a href="#page-6">6</a>
   <a href="#section-4">4</a>. The PORT_SET Option .............................................<a href="#page-6">6</a>
      <a href="#section-4.1">4.1</a>. Client Behavior ............................................<a href="#page-8">8</a>
      <a href="#section-4.2">4.2</a>. Server Behavior ............................................<a href="#page-8">8</a>
      <a href="#section-4.3">4.3</a>. Absence of Capability Discovery ............................<a href="#page-9">9</a>
      <a href="#section-4.4">4.4</a>. Port-Set Renewal and Deletion .............................<a href="#page-10">10</a>
           <a href="#section-4.4.1">4.4.1</a>. Overlap Conditions .................................<a href="#page-10">10</a>
   <a href="#section-5">5</a>. Examples .......................................................<a href="#page-10">10</a>
      5.1. Simple Request on Network Address Translator
           IPv4/IPv4 (NAT44) .........................................<a href="#page-10">10</a>
      <a href="#section-5.2">5.2</a>. Stateless Mapping Discovery ...............................<a href="#page-12">12</a>
      <a href="#section-5.3">5.3</a>. Resolving Overlap .........................................<a href="#page-13">13</a>
   <a href="#section-6">6</a>. Operational Considerations .....................................<a href="#page-13">13</a>
      <a href="#section-6.1">6.1</a>. Limits and Quotas .........................................<a href="#page-13">13</a>
      <a href="#section-6.2">6.2</a>. High Availability .........................................<a href="#page-13">13</a>
      <a href="#section-6.3">6.3</a>. Idempotence ...............................................<a href="#page-13">13</a>
      6.4. What should a PCP client do when it receives fewer
           ports than requested? .....................................<a href="#page-15">15</a>
   <a href="#section-7">7</a>. Security Considerations ........................................<a href="#page-15">15</a>
   <a href="#section-8">8</a>. IANA Considerations ............................................<a href="#page-16">16</a>
   <a href="#section-9">9</a>. References .....................................................<a href="#page-16">16</a>
      <a href="#section-9.1">9.1</a>. Normative References ......................................<a href="#page-16">16</a>
      <a href="#section-9.2">9.2</a>. Informative References ....................................<a href="#page-16">16</a>
   Acknowledgements ..................................................<a href="#page-17">17</a>
   Contributors ......................................................<a href="#page-17">17</a>
   Authors' Addresses ................................................<a href="#page-18">18</a>

















<span class="grey">Sun, et al.                  Standards Track                    [Page 3]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-4"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.%20%20Introduction"></a><a class="selflink" href="#section-1" id="section-1">1</a>.  Introduction</span>

   This document extends the Port Control Protocol (PCP) [<a href="./rfc6887" title='"Port Control Protocol (PCP)"'>RFC6887</a>] with
   the ability to retrieve a set of ports using a single request.  It
   does so by defining a new PORT_SET option.

   This section describes a few of the possible envisioned use cases.
   Note that the PCP extension defined in this document is generic and
   is expected to be applicable to other use cases.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.1.%20%20Applications%20Using%20Port%20Sets"></a><a class="selflink" href="#section-1.1" id="section-1.1">1.1</a>.  Applications Using Port Sets</span>

   Some applications require not just one port, but a port set.  One
   example is a Session Initiation Protocol (SIP) User Agent Server
   (UAS) [<a href="./rfc3261" title='"SIP: Session Initiation Protocol"'>RFC3261</a>] expecting to handle multiple concurrent calls,
   including media termination.  When the UAS receives a call, it needs
   to signal media port numbers to its peer.  Generating individual PCP
   MAP requests for each of the media ports during call setup would
   introduce unwanted latency and increased signaling load.  Instead,
   the server can pre-allocate a set of ports such that no PCP exchange
   is needed during call setup.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.2.%20%20Lightweight%204over6"></a><a class="selflink" href="#section-1.2" id="section-1.2">1.2</a>.  Lightweight 4over6</span>

   In the Lightweight 4over6 (lw4o6) [<a href="./rfc7596" title='"Lightweight 4over6: An Extension to the Dual- Stack Lite Architecture"'>RFC7596</a>] architecture, shared
   global addresses can be allocated to customers.  This allows moving
   the Network Address Translation (NAT) function, otherwise
   accomplished by a Carrier-Grade NAT (CGN) [<a href="./rfc6888" title='"Common Requirements for Carrier-Grade NATs (CGNs)"'>RFC6888</a>], to the Customer
   Premises Equipment (CPE).  This provides more control over the NAT
   function to the user, and more scalability to the Internet Service
   Provider (ISP).

   In the lw4o6 architecture, the PCP-controlled device corresponds to
   the Lightweight Address Family Transition Router (lwAFTR), and the
   PCP client corresponds to the Lightweight B4 (lwB4).  The PCP client
   sends a PCP MAP request containing a PORT_SET option to trigger
   shared address allocation on the Lightweight AFTR (lwAFTR).  The PCP
   response contains the shared address information, including the port
   set allocated to the Lightweight B4 (lwB4).

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.3.%20%20Firewall%20Control"></a><a class="selflink" href="#section-1.3" id="section-1.3">1.3</a>.  Firewall Control</span>

   Port sets are often used in firewall rules.  For example, defining a
   range for Real-time Transport Protocol (RTP) [<a href="./rfc3550" title='"RTP: A Transport Protocol for Real-Time Applications"'>RFC3550</a>] traffic is
   common practice.  The PCP MAP request can already be used for
   firewall control.  The PORT_SET option brings the additional ability
   to manipulate firewall rules operating on port sets instead of single
   ports.



<span class="grey">Sun, et al.                  Standards Track                    [Page 4]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-5"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/1.4.%20%20Discovering%20Stateless%20Port-Set%20Mappings"></a><a class="selflink" href="#section-1.4" id="section-1.4">1.4</a>.  Discovering Stateless Port-Set Mappings</span>

   A PCP MAP request can be used to retrieve a mapping from a stateless
   device (i.e., one that does not establish any per-flow state, and
   simply rewrites the address and/or port in a purely algorithmic
   fashion, including no rewriting).  Similarly, a PCP MAP request with
   a PORT_SET request can be used to discover a port-set mapping from a
   stateless device.  See <a href="#section-5.2">Section 5.2</a> for an example.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/2.%20%20The%20Need%20for%20PORT_SET"></a><a class="selflink" href="#section-2" id="section-2">2</a>.  The Need for PORT_SET</span>

   Multiple PCP MAP requests can be used to manipulate a set of ports;
   this has roughly the same effect as a single use of a PCP MAP request
   with a PORT_SET option.  However, use of the PORT_SET option is more
   efficient when considering the following aspects:

   Network Traffic:  A single request uses fewer network resources than
      multiple requests.

   Latency:  Even though PCP MAP requests can be sent in parallel, we
      can expect the total processing time to be longer for multiple
      requests than for a single one.

   Server-side efficiency:  Some PCP-controlled devices can allocate
      port sets in a manner such that data passing through the device is
      processed much more efficiently than the equivalent using
      individual port allocations.  For example, a CGN having a "bulk"
      port allocation scheme (see <a href="./rfc6888#section-5">[RFC6888], SectionÂ 5</a>) often has this
      property.

   Server-side scalability:  The number of state table entries in PCP-
      controlled devices is often a limiting factor.  Allocating port
      sets in a single request can result in a single mapping entry
      being used, therefore allowing greater scalability.

   Therefore, while it is functionally possible to obtain the same
   results using plain MAP, the extension proposed in this document
   allows greater efficiency, scalability, and simplicity, while
   lowering latency and necessary network traffic.

   In addition, PORT_SET supports parity preservation.  Some protocols
   (e.g., RTP [<a href="./rfc3550" title='"RTP: A Transport Protocol for Real-Time Applications"'>RFC3550</a>]) assign meaning to a port number's parity.  When
   mapping sets of ports for the purpose of using such kind of protocol,
   preserving parity can be necessary.







<span class="grey">Sun, et al.                  Standards Track                    [Page 5]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-6"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/3.%20%20Terminology"></a><a class="selflink" href="#section-3" id="section-3">3</a>.  Terminology</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in [<a href="./rfc2119" title='"Key words for use in RFCs to Indicate Requirement Levels"'>RFC2119</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.%20%20The%20PORT_SET%20Option"></a><a class="selflink" href="#section-4" id="section-4">4</a>.  The PORT_SET Option</span>

   Option Name:  PORT_SET

   Number:  130 (see <a href="#section-8">Section 8</a>)

   Purpose:  To map sets of ports.

   Valid for Opcodes:  MAP

   Length:  5 bytes

   May appear in:  Both requests and responses

   Maximum occurrences:  1

   The PORT_SET option indicates that the PCP client wishes to reserve a
   set of ports.  The requested number of ports in that set is indicated
   in the option.

   The maximum occurrences of the PORT_SET option MUST be limited to 1.
   The reason is that the Suggested External Port Set depends on the
   data contained in the MAP Opcode header.  Having two PORT_SET options
   with a single MAP Opcode header would imply having two overlapping
   Suggested External Port Sets.

   Note that the option number is in the "optional to process" range
   (128-191), meaning that a PCP MAP request with a PORT_SET option will
   be interpreted by a PCP server that does not support PORT_SET as a
   single-port PCP MAP request, as if the PORT_SET option was absent.

   The PORT_SET option is formatted as shown in Figure 1.













<span class="grey">Sun, et al.                  Standards Track                    [Page 6]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-7"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Option Code=130|   Reserved    |        Option Length=5        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |        Port Set Size          |      First Internal Port      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Reserved   |P|
   +-+-+-+-+-+-+-+-+

                         Figure 1: PORT_SET Option

   The fields are as follows:

   Port Set Size:  A 16-bit unsigned integer.  Number of ports
      requested.  MUST NOT be zero.

   First Internal Port:  In a request, this field MUST be set equal to
      the Internal Port field in the MAP Opcode by the PCP client.  In a
      response, this field indicates the First Internal Port of the port
      set mapped by the PCP server, which may differ from the value sent
      in the request.  That is to be contrasted to the Internal Port
      field, which by necessity is always identical in matched requests
      and responses.

   Reserved:  MUST be set to zero when sending; MUST be ignored when
      receiving.

   P (parity bit):  1 if parity preservation is requested; 0 otherwise.
      See <a href="./rfc4787#section-4.2.2">[RFC4787], SectionÂ 4.2.2</a>.

   Note that Option Code, Reserved, and Option Length are as described
   in <a href="./rfc6887#section-7.3">[RFC6887], SectionÂ 7.3</a>.

   The Internal Port Set is defined as being the range of Port Set Size
   ports starting from the First Internal Port.  The Suggested External
   Port Set is defined as being the range of Port Set Size ports
   starting from the Suggested External Port.  Similarly, the Assigned
   External Port Set is defined as being the range of Port Set Size
   ports starting from the Assigned External Port.  The Internal Port
   Set returned in a response and the Assigned External Port Set have
   the same size.

   The Suggested External Port corresponds to the first port in the
   Suggested External Port Set.  Its purpose is for clients to be able
   to regenerate previous mappings after state loss.  When such an event
   happens, clients may attempt to regenerate identical mappings by




<span class="grey">Sun, et al.                  Standards Track                    [Page 7]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-8"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


   suggesting the same External Port Set as before the state loss.  Note
   that there is no guarantee that the allocated External Port Set will
   be the one suggested by the client.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.1.%20%20Client%20Behavior"></a><a class="selflink" href="#section-4.1" id="section-4.1">4.1</a>.  Client Behavior</span>

   To retrieve a set of ports, the PCP client adds a PORT_SET option to
   its PCP MAP request.  If parity preservation is required (i.e., an
   even port to be mapped to an even port and an odd port to be mapped
   to an odd port), the PCP client MUST set the parity bit (to 1) to ask
   the PCP server to preserve the port parity.

   The PCP client MUST NOT include more than one PORT_SET option in a
   PCP MAP request.  If several port sets are needed, the PCP client
   MUST issue separate PCP MAP requests, each potentially including a
   PORT_SET option.  These individual PCP MAP requests MUST include
   distinct Internal Ports.

   If the PCP client does not know the exact number of ports it
   requires, it MAY then set the Port Set Size to 0xffff, indicating
   that it is willing to accept as many ports as the PCP server can
   offer.

   A PCP client SHOULD NOT send a PORT_SET option for single-port PCP
   MAP requests (including creation, renewal, and deletion), because
   that needlessly increases processing on the server.

   PREFER_FAILURE MUST NOT appear in a request with a PORT_SET option.
   As a reminder, PREFER_FAILURE was specifically designed for the
   Universal Plug and Play (UPnP) Internet Gateway Device - Port Control
   Protocol Interworking Function (IGD-PCP IWF) [<a href="./rfc6970" title='"Universal Plug and Play (UPnP) Internet Gateway Device - Port Control Protocol Interworking Function (IGD-PCP IWF)"'>RFC6970</a>].  The reasons
   for not recommending the use of PREFER_FAILURE are discussed in
   <a href="./rfc6887#section-13.2">SectionÂ 13.2 of [RFC6887]</a>.

   When the PCP-controlled device supports delegation of multiple port
   sets for a given PCP client, the PCP client MAY re-initiate a PCP
   request to get another port set when it has exhausted all the ports
   within the port set.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.2.%20%20Server%20Behavior"></a><a class="selflink" href="#section-4.2" id="section-4.2">4.2</a>.  Server Behavior</span>

   In addition to regular PCP MAP request processing, the following
   checks are made upon receipt of a PORT_SET option with a non-zero
   Requested Lifetime:

   o  If multiple PORT_SET options are present in a single PCP MAP
      request, a MALFORMED_OPTION error is returned.




<span class="grey">Sun, et al.                  Standards Track                    [Page 8]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-9"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


   o  If the Port Set Size is zero, a MALFORMED_OPTION error is
      returned.

   o  If a PREFER_FAILURE option is present, a MALFORMED_OPTION error is
      returned.

   The PCP server MAY map fewer ports than the value of Port Set Size
   from the request.  It MUST NOT map more ports than the PCP client
   asked for.  Internal Ports outside the range of Port Set Size ports
   starting from the Internal Port MUST NOT be mapped by the PCP server.

   If the requested port set cannot be fully satisfied, the PCP server
   SHOULD map as many ports as possible and SHOULD map at least one port
   (which is the same behavior as if Port Set Size is set to 1).

   If the PCP server ends up mapping only a single port, for any reason,
   the PORT_SET option MUST NOT be present in the response.  In
   particular, if the PCP server receives a single-port PCP MAP request
   that includes a PORT_SET option, the PORT_SET option is silently
   ignored, and the request is handled as a single-port PCP MAP request.

   If the port parity preservation is requested (P = 1), the PCP server
   MAY preserve port parity.  In that case, the External Port is set to
   a value having the same parity as the First Internal Port.

   If the mapping is successful, the MAP response's Assigned External
   Port is set to the first port in the External Port Set, and the
   PORT_SET option's Port Set Size is set to the number of ports in the
   mapped port set.  The First Internal Port field is set to the first
   port in the Internal Port Set.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.3.%20%20Absence%20of%20Capability%20Discovery"></a><a class="selflink" href="#section-4.3" id="section-4.3">4.3</a>.  Absence of Capability Discovery</span>

   A PCP client that wishes to make use of a port set includes the
   PORT_SET option.  If no PORT_SET option is present in the response,
   the PCP client cannot conclude that the PCP server does not support
   the PORT_SET option.  It may just be that the PCP server does support
   PORT_SET but decided to allocate only a single port, for reasons that
   are its own.  If the client wishes to obtain more ports, it MAY send
   additional PCP MAP requests (see <a href="#section-6.4">Section 6.4</a>), which the PCP server
   may or may not grant according to local policy.

   If port-set capability is added to or removed from a running PCP
   server, the server MAY reset its Epoch time and send an ANNOUNCE
   message as described in the PCP specification (<a href="./rfc6887#section-14.1">[RFC6887],
   SectionÂ 14.1</a>).  This causes PCP clients to retry, and those using
   PORT_SET will now receive a different response.




<span class="grey">Sun, et al.                  Standards Track                    [Page 9]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-10"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.4.%20%20Port-Set%20Renewal%20and%20Deletion"></a><a class="selflink" href="#section-4.4" id="section-4.4">4.4</a>.  Port-Set Renewal and Deletion</span>

   Port-set mappings are renewed and deleted as a single entity.  That
   is, the lifetime of all port mappings in the set is set to the
   Assigned Lifetime at once.

   A PCP client attempting to refresh or delete a port-set mapping MUST
   include the PORT_SET option in its request.

<span class="h4"><a class="dashAnchor" name="//apple_ref/cpp/Section/4.4.1.%20%20Overlap%20Conditions"></a><a class="selflink" href="#section-4.4.1" id="section-4.4.1">4.4.1</a>.  Overlap Conditions</span>

   Port-set PCP MAP requests can overlap with existing single-port or
   port-set mappings.  This can happen either by mistake or after a PCP
   client becomes out of sync with server state.

   If a PCP server receives a PCP MAP request, with or without a
   PORT_SET option, that tries to map one or more Internal Ports or port
   sets belonging to already-existing mappings, then the request is
   considered to be a refresh request applying those mappings.  Each of
   the matching port or port-set mappings is processed independently, as
   if a separate refresh request had been received.  The processing is
   as described in <a href="./rfc6887#section-15">SectionÂ 15 of [RFC6887]</a>.  The PCP server sends a
   Mapping Update message for each of the mappings.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.%20%20Examples"></a><a class="selflink" href="#section-5" id="section-5">5</a>.  Examples</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.1.%20%20Simple%20Request%20on%20Network%20Address%20Translator%20IPv4%2FIPv4%20%28NAT44%29"></a><a class="selflink" href="#section-5.1" id="section-5.1">5.1</a>.  Simple Request on Network Address Translator IPv4/IPv4 (NAT44)</span>

   An application requires a range of 100 IPv4 UDP ports to be mapped to
   itself.  The application running on the host has created sockets
   bound to IPv4 UDP ports 50,000 to 50,099 for this purpose.  It does
   not care about which External Port numbers are allocated.  The PCP
   client sends a PCP request with the following parameters over IPv4:

   o  MAP Opcode

      Mapping Nonce:  &lt;a random nonce&gt;

      Protocol:  17

      Internal Port:  50,000

      Suggested External Port:  0

      Suggested External IP Address:  ::ffff:0.0.0.0






<span class="grey">Sun, et al.                  Standards Track                   [Page 10]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-11"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


   o  PORT_SET Option

      Port Set Size:  100

      First Internal Port:  50,000

      P: 0

   The PCP server is unable to fulfill the request fully: it is
   configured by local policy to only allocate 32 ports per user.  Since
   the PREFER_FAILURE option is absent from the request, it decides to
   map UDP ports 37,056 to 37,087 on external address 192.0.2.3 to
   Internal Ports 50,000 to 50,031.  After setting up the mapping in the
   NAT44 device it controls, it replies with the following PCP response:

   o  MAP Opcode

      Mapping Nonce:  &lt;copied from the request&gt;

      Protocol:  17

      Internal Port:  50,000

      Assigned External Port:  37,056

      Assigned External IP Address:  ::ffff:192.0.2.3

   o  PORT_SET Option

      Port Set Size:  32

      First Internal Port:  50,000

      P: 0

   Upon receiving this response, the host decides that 32 ports is good
   enough for its purposes.  It closes sockets bound to ports 50,032 to
   50,099, sets up a refresh timer, and starts using the port range it
   has just been assigned.












<span class="grey">Sun, et al.                  Standards Track                   [Page 11]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-12"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.2.%20%20Stateless%20Mapping%20Discovery"></a><a class="selflink" href="#section-5.2" id="section-5.2">5.2</a>.  Stateless Mapping Discovery</span>

   A host wants to discover a stateless NAT44 mapping pointing to it.
   To do so, it sends the following request over IPv4:

   o  MAP Opcode

      Mapping Nonce:  &lt;a random nonce&gt;

      Protocol:  0

      Internal Port:  1

      Suggested External Port:  0

      Suggested External IP Address:  ::ffff:0.0.0.0

   o  PORT_SET Option

      Port Set Size:  65,535

      First Internal Port:  1

      P: 0

   The PCP server sends the following response:

   o  MAP Opcode

      Mapping Nonce:  &lt;copied from the request&gt;

      Protocol:  0

      Internal Port:  1

      Assigned External Port:  26,624

      Assigned External IP Address:  ::ffff:192.0.2.5

   o  PORT_SET Option

      Port Set Size:  2048

      First Internal Port:  26,624

      P: 0





<span class="grey">Sun, et al.                  Standards Track                   [Page 12]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-13"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


   From this response, the host understands that a 2048-port stateless
   mapping is pointing to itself, starting from port 26,624 on external
   IP address 192.0.2.5.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/5.3.%20%20Resolving%20Overlap"></a><a class="selflink" href="#section-5.3" id="section-5.3">5.3</a>.  Resolving Overlap</span>

   This example relates to <a href="#section-4.4.1">Section 4.4.1</a>.

   Suppose Internal Port 100 is mapped to External Port 100 and port set
   101-199 is mapped to External Port Set 201-299.  The PCP server
   receives a PCP MAP request with Internal Port = 100, External Port =
   0, and a PORT_SET option with Port Set Size = 100.  The request's
   Mapping Nonce is equal to those of the existing single-port and port-
   set mappings.  This request is therefore treated as two refresh
   requests, the first one applying to the single-port mapping and the
   second one applying to the port-set mapping.  The PCP server updates
   the lifetimes of both mappings as usual and then sends two responses:
   the first one contains Internal Port = 100, External Port = 100, and
   no PORT_SET option, while the second one contains Internal Port =
   101, External Port = 201, and a PORT_SET option with Port Set Size =
   99.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/6.%20%20Operational%20Considerations"></a><a class="selflink" href="#section-6" id="section-6">6</a>.  Operational Considerations</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/6.1.%20%20Limits%20and%20Quotas"></a><a class="selflink" href="#section-6.1" id="section-6.1">6.1</a>.  Limits and Quotas</span>

   It is up to the PCP server to determine the port-set quota, if any,
   for each PCP client.

   If the PCP server is configured to allocate multiple port-set
   allocations for one subscriber, the same Assigned External IP Address
   SHOULD be assigned to the subscriber in multiple port-set responses.

   To optimize the number of mapping entries maintained by the PCP
   server, it is RECOMMENDED to configure the PCP server to assign the
   maximum allowed Port Set Size in a single response.  This policy
   SHOULD be configurable.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/6.2.%20%20High%20Availability"></a><a class="selflink" href="#section-6.2" id="section-6.2">6.2</a>.  High Availability</span>

   The failover mechanism in MAP (<a href="./rfc6887#section-14">SectionÂ 14 of [RFC6887]</a>) can also be
   applied to port sets.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/6.3.%20%20Idempotence"></a><a class="selflink" href="#section-6.3" id="section-6.3">6.3</a>.  Idempotence</span>

   A core, desirable property of PCP is idempotence.  In a nutshell,
   requests produce the same results whether they are executed once or
   multiple times.  This property is preserved with the PORT_SET option,



<span class="grey">Sun, et al.                  Standards Track                   [Page 13]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-14"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


   with the following caveat: the order in which the PCP server receives
   requests with overlapping Internal Port Sets will affect the mappings
   being created and the responses received.

   For example, suppose these two requests are sent by a PCP client:

   Request A:  Internal Port Set 1-10

   Request B:  Internal Port Set 5-14

   The PCP server's actions will depend on which request is received
   first.  Suppose that A is received before B:

   Upon reception of A:  Internal Ports 1-10 are mapped.  A success
      response containing the following fields is sent:

      Internal Port:  1

      First Internal Port:  1

      Port Set Size:  10

   Upon reception of B:  The request matches mapping A.  The request is
      interpreted as a refresh request for mapping A, and a response
      containing the following fields is sent:

      Internal Port:  5

      First Internal Port:  1

      Port Set Size:  10

   If the order of reception is reversed (B before A), the created
   mapping will be different, and the First Internal Port in both
   responses would then be 5.

   To avoid surprises, PCP clients MUST ensure that port-set mapping
   requests do not inadvertently overlap.  For example, a host's
   operating system could include a central PCP client process through
   which port-set mapping requests would be arbitrated.  Alternatively,
   individual PCP clients running on the same host would be required to
   acquire the Internal Ports from the operating system (e.g., a call to
   the bind() function from the BSD API) before trying to map them with
   PCP.







<span class="grey">Sun, et al.                  Standards Track                   [Page 14]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-15"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/6.4.%20%20What%20should%20a%20PCP%20client%20do%20when%20it%20receives%20fewer%20ports%20than"></a><a class="selflink" href="#section-6.4" id="section-6.4">6.4</a>.  What should a PCP client do when it receives fewer ports than</span>
<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/requested%3F"></a>      requested?</span>

   Suppose a PCP client asks for 16 ports and receives 8.  What should
   it do?  Should it consider this a final answer?  Should it try a
   second request, asking for 8 more ports?  Should it fall back to 8
   individual PCP MAP requests?  This document leaves the answers to be
   implementation specific but describes issues to be considered when
   answering them.

   First, the PCP server has decided to allocate 8 ports for some
   reason.  It may be that allocation sizes have been limited by the PCP
   server's administrator.  It may be that the PCP client has reached a
   quota.  It may be that these 8 ports were the last contiguous ones
   available.  Depending on the reason, asking for more ports may or may
   not be likely to actually yield more ports.  However, the PCP client
   has no way of knowing.

   Second, not all PCP clients asking for N ports actually need all N
   ports to function correctly.  For example, a DNS resolver could ask
   for N ports to be used for source-port randomization.  If fewer than
   N ports are received, the DNS resolver will still work correctly, but
   source-port randomization will be slightly less efficient, having
   fewer bits to play with.  In that case, it would not make much sense
   to ask for more ports.

   Finally, asking for more ports could be considered abuse.  External
   Ports are a resource that is to be shared among multiple PCP clients.
   A PCP client trying to obtain more than its fair share could trigger
   countermeasures according to local policy.

   In conclusion, it is expected that, for most applications, asking for
   more ports would not yield benefits justifying the additional costs.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/7.%20%20Security%20Considerations"></a><a class="selflink" href="#section-7" id="section-7">7</a>.  Security Considerations</span>

   The security considerations discussed in [<a href="./rfc6887" title='"Port Control Protocol (PCP)"'>RFC6887</a>] apply to this
   extension.

   As described in <a href="#section-4.4.1">Section 4.4.1</a>, a single PCP request using the
   PORT_SET option may result in multiple responses.  For this to
   happen, it is necessary that the request contain the nonce associated
   with multiple mappings on the server.  Therefore, an on-path attacker
   could use an eavesdropped nonce to mount an amplification attack.
   Use of PCP authentication (<a href="./rfc6887#section-18">[RFC6887], SectionÂ 18</a>) eliminates this
   attack vector.





<span class="grey">Sun, et al.                  Standards Track                   [Page 15]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-16"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


   In order to prevent a PCP client from controlling all ports bound to
   a shared IP address, port quotas should be configured on the PCP
   server (<a href="./rfc6887#section-17.2">SectionÂ 17.2 of [RFC6887]</a>).

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/8.%20%20IANA%20Considerations"></a><a class="selflink" href="#section-8" id="section-8">8</a>.  IANA Considerations</span>

   IANA has allocated value 130 in the "PCP Options" registry at
   &lt;<a href="http://www.iana.org/assignments/pcp-parameters">http://www.iana.org/assignments/pcp-parameters</a>&gt; for the new PCP
   option defined in <a href="#section-4">Section 4</a>.

<span class="h2"><a class="dashAnchor" name="//apple_ref/cpp/Section/9.%20%20References"></a><a class="selflink" href="#section-9" id="section-9">9</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/9.1.%20%20Normative%20References"></a><a class="selflink" href="#section-9.1" id="section-9.1">9.1</a>.  Normative References</span>

   [<a id="ref-RFC2119">RFC2119</a>]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", <a href="https://www.rfc-editor.org/bcp/bcp14">BCP 14</a>, <a href="./rfc2119">RFC 2119</a>,
              DOI 10.17487/RFC2119, March 1997,
              &lt;<a href="http://www.rfc-editor.org/info/rfc2119">http://www.rfc-editor.org/info/rfc2119</a>&gt;.

   [<a id="ref-RFC6887">RFC6887</a>]  Wing, D., Ed., Cheshire, S., Boucadair, M., Penno, R., and
              P. Selkirk, "Port Control Protocol (PCP)", <a href="./rfc6887">RFC 6887</a>,
              DOI 10.17487/RFC6887, April 2013,
              &lt;<a href="http://www.rfc-editor.org/info/rfc6887">http://www.rfc-editor.org/info/rfc6887</a>&gt;.

<span class="h3"><a class="dashAnchor" name="//apple_ref/cpp/Section/9.2.%20%20Informative%20References"></a><a class="selflink" href="#section-9.2" id="section-9.2">9.2</a>.  Informative References</span>

   [<a id="ref-RFC3261">RFC3261</a>]  Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston,
              A., Peterson, J., Sparks, R., Handley, M., and E.
              Schooler, "SIP: Session Initiation Protocol", <a href="./rfc3261">RFC 3261</a>,
              DOI 10.17487/RFC3261, June 2002,
              &lt;<a href="http://www.rfc-editor.org/info/rfc3261">http://www.rfc-editor.org/info/rfc3261</a>&gt;.

   [<a id="ref-RFC3550">RFC3550</a>]  Schulzrinne, H., Casner, S., Frederick, R., and V.
              Jacobson, "RTP: A Transport Protocol for Real-Time
              Applications", STD 64, <a href="./rfc3550">RFC 3550</a>, DOI 10.17487/RFC3550,
              July 2003, &lt;<a href="http://www.rfc-editor.org/info/rfc3550">http://www.rfc-editor.org/info/rfc3550</a>&gt;.

   [<a id="ref-RFC4787">RFC4787</a>]  Audet, F., Ed. and C. Jennings, "Network Address
              Translation (NAT) Behavioral Requirements for Unicast
              UDP", <a href="https://www.rfc-editor.org/bcp/bcp127">BCP 127</a>, <a href="./rfc4787">RFC 4787</a>, DOI 10.17487/RFC4787, January
              2007, &lt;<a href="http://www.rfc-editor.org/info/rfc4787">http://www.rfc-editor.org/info/rfc4787</a>&gt;.

   [<a id="ref-RFC6888">RFC6888</a>]  Perreault, S., Ed., Yamagata, I., Miyakawa, S., Nakagawa,
              A., and H. Ashida, "Common Requirements for Carrier-Grade
              NATs (CGNs)", <a href="https://www.rfc-editor.org/bcp/bcp127">BCP 127</a>, <a href="./rfc6888">RFC 6888</a>, DOI 10.17487/RFC6888,
              April 2013, &lt;<a href="http://www.rfc-editor.org/info/rfc6888">http://www.rfc-editor.org/info/rfc6888</a>&gt;.





<span class="grey">Sun, et al.                  Standards Track                   [Page 16]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-17"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


   [<a id="ref-RFC6970">RFC6970</a>]  Boucadair, M., Penno, R., and D. Wing, "Universal Plug and
              Play (UPnP) Internet Gateway Device - Port Control
              Protocol Interworking Function (IGD-PCP IWF)", <a href="./rfc6970">RFC 6970</a>,
              DOI 10.17487/RFC6970, July 2013,
              &lt;<a href="http://www.rfc-editor.org/info/rfc6970">http://www.rfc-editor.org/info/rfc6970</a>&gt;.

   [<a id="ref-RFC7596">RFC7596</a>]  Cui, Y., Sun, Q., Boucadair, M., Tsou, T., Lee, Y., and I.
              Farrer, "Lightweight 4over6: An Extension to the Dual-
              Stack Lite Architecture", <a href="./rfc7596">RFC 7596</a>, DOI 10.17487/RFC7596,
              July 2015, &lt;<a href="http://www.rfc-editor.org/info/rfc7596">http://www.rfc-editor.org/info/rfc7596</a>&gt;.

Acknowledgements

   The authors would like to express sincere appreciation to Alain
   Durand, Cong Liu, Dan Wing, Dave Thaler, Peter Koch, Reinaldo Penno,
   Sam Hartman, Stuart Cheshire, Ted Lemon, Yoshihiro Ohba, Meral
   Shirazipour, Jouni Korhonen, and Ben Campbell for their useful
   comments and suggestions.

Contributors

   The following individuals contributed to this document:

   Yunqing Chen
   China Telecom
   Room 502, No.118, Xizhimennei Street
   Beijing 100035
   China


   Chongfeng Xie
   China Telecom
   Room 502, No.118, Xizhimennei Street
   Beijing 100035
   China


   Yong Cui
   Tsinghua University
   Beijing 100084
   China

   Phone: +86-10-62603059
   Email: yong@csnet1.cs.tsinghua.edu.cn







<span class="grey">Sun, et al.                  Standards Track                   [Page 17]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-18"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


   Qi Sun
   Tsinghua University
   Beijing 100084
   China

   Phone: +86-10-62785822
   Email: sunqibupt@gmail.com


   Gabor Bajko
   Mediatek Inc.

   Email: gabor.bajko@mediatek.com


   Xiaohong Deng
   France Telecom

   Email: xiaohong.deng@orange-ftgroup.com

Authors' Addresses

   Qiong Sun
   China Telecom
   China

   Phone: 86 10 58552936
   Email: sunqiong@ctbri.com.cn


   Mohamed Boucadair
   France Telecom
   Rennes  35000
   France

   Email: mohamed.boucadair@orange.com


   Senthil Sivakumar
   Cisco Systems
   7100-8 Kit Creek Road
   Research Triangle Park, NC  27709
   United States

   Phone: +1 919 392 5158
   Email: ssenthil@cisco.com





<span class="grey">Sun, et al.                  Standards Track                   [Page 18]</span></pre>
<hr class="noprint"/><!--NewPage--><pre class="newpage"><span id="page-19"></span>
<span class="grey"><a href="./rfc7753">RFC 7753</a>                      PCP PORT_SET                 February 2016</span>


   Cathy Zhou
   Huawei Technologies
   Bantian, Longgang District
   Shenzhen  518129
   China

   Email: cathy.zhou@huawei.com


   Tina Tsou
   Philips Lighting
   3 Burlington Woods Dr #4t
   Burlington, MA  01803
   United States

   Phone: +1 617-423-9999
   Email: tina.tsou@philips.com


   Simon Perreault
   Jive Communications
   Quebec, QC
   Canada

   Email: sperreault@jive.com


























Sun, et al.                  Standards Track                   [Page 19]
</pre>
</body></html>