<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><!-- Mirrored from tools.ietf.org/html/rfc2983 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 14 Aug 2018 14:27:48 GMT --><!-- Added by HTTrack --><head><meta content="text/html;charset=utf-8" http-equiv="content-type"/><!-- /Added by HTTrack -->

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <meta content="index,follow" name="robots"/>
    <meta content="rfcmarkup version 1.127" name="creator"/>
    <link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/>
<meta content="draft-black-diffserv-tunnels" name="DC.Relation.Replaces"/>
<meta content="urn:ietf:rfc:2983" name="DC.Identifier"/>
<meta content="October, 2000" name="DC.Date.Issued"/>
<meta content="David L. Black &lt;black_david@emc.com&gt;" name="DC.Creator"/>
<meta content="This document considers the interaction of Differentiated Services
(diffserv) with IP tunnels of various forms. This memo provides
information for the Internet community." name="DC.Description.Abstract"/>
<meta content="Differentiated Services and Tunnels" name="DC.Title"/>

    <link href="https://tools.ietf.org/images/rfc.png" rel="icon" type="image/png"/>
    <link href="https://tools.ietf.org/images/rfc.png" rel="shortcut icon" type="image/png"/>
    <title>RFC 2983 - Differentiated Services and Tunnels</title>
    
    
    <style type="text/css">
	@media only screen 
	  and (min-width: 992px)
	  and (max-width: 1199px) {
	    body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 768px)
	  and (max-width: 991px) {
            body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 480px)
	  and (max-width: 767px) {
            body { font-size: 11pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (max-width: 479px) {
            body { font-size: 8pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-device-width : 375px) 
	  and (max-device-width : 667px) {
            body { font-size: 9.5pt; }
            div.content { width: 96ex; margin: 0 1px; }
        }
	@media only screen 
	  and (min-device-width: 1200px) {
            body { font-size: 10pt; margin: 0 4em; }
            div.content { width: 96ex; margin: 0; }
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        a.selflink {
          color: black;
          text-decoration: none;
        }
        @media print {
            body {
                font-family: monospace;
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 1em;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>                   <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>                     <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>             <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>              <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td>      <td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td>         <td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard (old designation):</td> <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Internet Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>                  <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>                  <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
  <div class="content">
   <div style="height: 13px;">
      <div class="pre noprint docinfo bgorange" onclick="showElem('legend');" onmouseout="hideElem('legend')" onmouseover="this.style.cursor='pointer';" style="height: 6px; position: absolute;" title="Click for colour legend.">                                                                        </div>
      <div class="docinfo noprint pre legend" id="legend" onmouseout="hideElem('legend');" onmouseover="showElem('legend');" style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; ">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="index.html" title="Document search and retrieval page">Docs</a>] [<a href="https://tools.ietf.org/rfc/rfc2983.txt" title="Plaintext version of this document">txt</a>|<a href="https://tools.ietf.org/pdf/rfc2983" title="PDF version of this document">pdf</a>] [<a href="https://tools.ietf.org/html/draft-ietf-diffserv-tunnels" title="draft-ietf-diffserv-tunnels">draft-ietf-diff...</a>] [<a href="https://datatracker.ietf.org/doc/rfc2983" title="IESG Datatracker information for this document">Tracker</a>] [<a href="https://tools.ietf.org/rfcdiff?difftype=--hwdiff&amp;url2=rfc2983" title="Inline diff (wdiff)">Diff1</a>] [<a href="https://tools.ietf.org/rfcdiff?url2=rfc2983" title="Side-by-side diff">Diff2</a>]         </span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<span class="pre noprint docinfo">                                                           INFORMATIONAL</span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<pre>Network Working Group                                          D. Black
Request for Comments: 2983                              EMC Corporation
Category: Informational                                    October 2000


                  <span class="h1">Differentiated Services and Tunnels</span>

Status of this Memo

   This memo provides information for the Internet community.  It does
   not specify an Internet standard of any kind.  Distribution of this
   memo is unlimited.

Copyright Notice

   Copyright (C) The Internet Society (2000).  All Rights Reserved.

Abstract

   This document considers the interaction of Differentiated Services
   (diffserv) (<a href="rfc2474.html">RFC 2474</a>, <a href="rfc2475.html">RFC 2475</a>) with IP tunnels of various forms.
   The discussion of tunnels in the diffserv architecture (<a href="rfc2475.html">RFC 2475</a>)
   provides insufficient guidance to tunnel designers and implementers.
   This document describes two conceptual models for the interaction of
   diffserv with Internet Protocol (IP) tunnels and employs them to
   explore the resulting configurations and combinations of
   functionality.  An important consideration is how and where it is
   appropriate to perform diffserv traffic conditioning in the presence
   of tunnel encapsulation and decapsulation.  A few simple mechanisms
   are also proposed that limit the complexity that tunnels would
   otherwise add to the diffserv traffic conditioning model.  Security
   considerations for IPSec tunnels limit the possible functionality in
   some circumstances.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/1.%20Conventions%20used%20in%20this%20document"></a><a class="selflink" href="#section-1" name="section-1">1</a>. Conventions used in this document</span>

   An IP tunnel encapsulates IP traffic in another IP header as it
   passes through the tunnel; the presence of these two IP headers is a
   defining characteristic of IP tunnels, although there may be
   additional headers inserted between the two IP headers.  The inner IP
   header is that of the original traffic; an outer IP header is
   attached and detached at tunnel endpoints.  In general, intermediate
   network nodes between tunnel endpoints operate solely on the outer IP
   header, and hence diffserv-capable intermediate nodes access and
   modify only the DSCP field in the outer IP header.  The terms
   "tunnel" and "IP tunnel" are used interchangeably in this document.
   For simplicity, this document does not consider tunnels other than IP
   tunnels (i.e., for which there is no encapsulating IP header), such



<span class="grey">Black                        Informational                      [Page 1]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-2" id="page-2" name="page-2"> </a>
<span class="grey"><a href="rfc2983.html">RFC 2983</a>                  Diffserv and Tunnels              October 2000</span>


   as MPLS paths and "tunnels" formed by encapsulation in layer 2 (link)
   headers, although the conceptual models and approach described here
   may be useful in understanding the interaction of diffserv with such
   tunnels.

   This analysis considers tunnels to be unidirectional; bi-directional
   tunnels are considered to be composed of two unidirectional tunnels
   carrying traffic in opposite directions between the same tunnel
   endpoints.  A tunnel consists of an ingress where traffic enters the
   tunnel and is encapsulated by the addition of the outer IP header, an
   egress where traffic exits the tunnel and is decapsulated by the
   removal of the outer IP header, and intermediate nodes through which
   tunneled traffic passes between the ingress and egress.  This
   document does not make any assumptions about routing and forwarding
   of tunnel traffic, and in particular assumes neither the presence nor
   the absence of route pinning in any form.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/2.%20Diffserv%20and%20Tunnels%20Overview"></a><a class="selflink" href="#section-2" name="section-2">2</a>. Diffserv and Tunnels Overview</span>

   Tunnels range in complexity from simple IP-in-IP tunnels [<a href="rfc2003.html">RFC 2003</a>]
   to more complex multi-protocol tunnels, such as IP in PPP in L2TP in
   IPSec transport mode [RFC 1661, <a href="rfc2401.html">RFC 2401</a>, <a href="rfc2661.html">RFC 2661</a>].  The most
   general tunnel configuration is one in which the tunnel is not end-
   to-end, i.e., the ingress and egress nodes are not the source and
   destination nodes for traffic carried by the tunnel; such a tunnel
   may carry traffic with multiple sources and destinations.  If the
   ingress node is the end-to-end source of all traffic in the tunnel,
   the result is a simplified configuration to which much of the
   analysis and guidance in this document are applicable, and likewise
   if the egress node is the end-to-end destination.

   A primary concern for differentiated services is the use of the
   Differentiated Services Code Point (DSCP) in the IP header [RFC 2474,
   <a href="rfc2475.html">RFC 2475</a>].  The diffserv architecture permits intermediate nodes to
   examine and change the value of the DSCP, which may result in the
   DSCP value in the outer IP header being modified between tunnel
   ingress and egress.  When a tunnel is not end-to-end, there are
   circumstances in which it may be desirable to propagate the DSCP
   and/or some of the information that it contains to the outer IP
   header on ingress and/or back to inner IP header on egress.  The
   current situation facing tunnel implementers is that [<a href="rfc2475.html">RFC 2475</a>]
   offers incomplete guidance.  Guideline G.7 in <a href="#section-3">Section 3</a> is an
   example, as some PHB specifications have followed it by explicitly
   specifying the PHBs that may be used in the outer IP header for
   tunneled traffic.  This is overly restrictive; for example, if a
   specification requires that the same PHB be used in both the inner
   and outer IP headers, traffic conforming to that specification cannot
   be tunneled across domains or networks that do not support that PHB.



<span class="grey">Black                        Informational                      [Page 2]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-3" id="page-3" name="page-3"> </a>
<span class="grey"><a href="rfc2983.html">RFC 2983</a>                  Diffserv and Tunnels              October 2000</span>


   A more flexible approach that should be used instead is to describe
   the behavioral properties of a PHB that are important to preserve
   when traffic is tunneled and allow the outer IP header to be marked
   in any fashion that is sufficient to preserve those properties.

   This document proposes an approach in which traffic conditioning is
   performed in series with tunnel ingress or egress processing, rather
   than in parallel.  This approach does not create any additional paths
   that transmit information across a tunnel endpoint, as all diffserv
   information is contained in the DSCPs in the IP headers.  The IPSec
   architecture [<a href="rfc2401.html">RFC 2401</a>] requires that this be the case to preserve
   security properties at the egress of IPSec tunnels, but this approach
   also avoids complicating diffserv traffic conditioning blocks by
   introducing out-of-band inputs.  A consequence of this approach is
   that the last sentence of Guideline G.7 in <a href="rfc2475.html#section-3">SectionÂ 3 of [RFC 2475]</a>
   becomes moot because there are no tunnel egress diffserv components
   that have access to both the inner and outer DSCPs.

   An additional advantage of this traffic conditioning approach is that
   it places no additional restrictions on the positioning of diffserv
   domain boundaries with respect to traffic conditioning and tunnel
   encapsulation/decapsulation components.  An interesting class of
   configurations involves a diffserv domain boundary that passes
   through (i.e., divides) a network node; such a boundary can be split
   to create a DMZ-like region between the domains that contains the
   tunnel encapsulation or decapsulation processing.  Diffserv traffic
   conditioning is not appropriate for such a DMZ-like region, as
   traffic conditioning is part of the operation and management of
   diffserv domains.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/3.%20Conceptual%20Models%20for%20Diffserv%20Tunnels"></a><a class="selflink" href="#section-3" name="section-3">3</a>. Conceptual Models for Diffserv Tunnels</span>

   This analysis introduces two conceptual traffic conditioning models
   for IP tunnels based on an initial discussion that assumes a fully
   diffserv-capable network.  Configurations in which this is not the
   case are taken up in <a href="#section-3.2">Section 3.2</a>.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.1%20Conceptual%20Models%20for%20Fully%20DS-capable%20Configurations"></a><a class="selflink" href="#section-3.1" name="section-3.1">3.1</a> Conceptual Models for Fully DS-capable Configurations</span>

   The first conceptual model is a uniform model that views IP tunnels
   as artifacts of the end to end path from a traffic conditioning
   standpoint; tunnels may be necessary mechanisms to get traffic to its
   destination(s), but have no significant impact on traffic
   conditioning.  In this model, any packet has exactly one DS Field
   that is used for traffic conditioning at any point, namely the DS
   Field in the outermost IP header; any others are ignored.
   Implementations of this model copy the DSCP value to the outer IP
   header at encapsulation and copy the outer header's DSCP value to the



<span class="grey">Black                        Informational                      [Page 3]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-4" id="page-4" name="page-4"> </a>
<span class="grey"><a href="rfc2983.html">RFC 2983</a>                  Diffserv and Tunnels              October 2000</span>


   inner IP header at decapsulation.  Use of this model allows IP
   tunnels to be configured without regard to diffserv domain boundaries
   because diffserv traffic conditioning functionality is not impacted
   by the presence of IP tunnels.

   The second conceptual model is a pipe model that views an IP tunnel
   as hiding the nodes between its ingress and egress so that they do
   not participate fully in traffic conditioning.  In this model, a
   tunnel egress node uses traffic conditioning information conveyed
   from the tunnel ingress by the DSCP value in the inner header, and
   ignores (i.e., discards) the DSCP value in the outer header.  The
   pipe model cannot completely hide traffic conditioning within the
   tunnel, as the effects of dropping and shaping at intermediate tunnel
   nodes may be visible at the tunnel egress and beyond.

   The pipe model has traffic conditioning consequences when the ingress
   and egress nodes are in different diffserv domains.  In such a
   situation, the egress node must perform traffic conditioning to
   ensure that the traffic exiting the tunnel has DSCP values acceptable
   to the egress diffserv domain (see <a href="#section-6">Section 6</a> of the diffserv
   architecture [<a href="rfc2475.html">RFC 2475</a>]).  An inter-domain TCA (Traffic Conditioning
   Agreement) between the diffserv domains containing the tunnel ingress
   and egress nodes may be used to reduce or eliminate egress traffic
   conditioning.  Complete elimination of egress traffic conditioning
   requires that the diffserv domains at ingress and egress have
   compatible service provisioning policies for the tunneled traffic and
   support all of the PHB groups and DSCP values used for that traffic
   in a consistent fashion.  Examples of this situation are provided by
   some virtual private network tunnels; it may be useful to view such
   tunnels as linking the diffserv domains at their endpoints into a
   diffserv region by making the tunnel endpoints virtually contiguous
   even though they may be physically separated by intermediate network
   nodes.

   The pipe model is also appropriate for situations in which the DSCP
   itself carries information through the tunnel.  For example, if
   transit between two domains is obtained via a path that uses the EF
   PHB [<a href="rfc2598.html">RFC 2598</a>], the drop precedence information in the AF PHB DSCP
   values [<a href="rfc2597.html">RFC 2597</a>] will be lost unless something is done to preserve
   it; an IP tunnel is one possible preservation mechanism.  A path that
   crosses one or more non-diffserv domains between its DS-capable
   endpoints may experience a similar information loss phenomenon if a
   tunnel is not used due to the limited set of DSCP codepoints that are
   compatible with such domains.







<span class="grey">Black                        Informational                      [Page 4]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-5" id="page-5" name="page-5"> </a>
<span class="grey"><a href="rfc2983.html">RFC 2983</a>                  Diffserv and Tunnels              October 2000</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.2%20Considerations%20for%20Partially%20DS-capable%20Configurations"></a><a class="selflink" href="#section-3.2" name="section-3.2">3.2</a> Considerations for Partially DS-capable Configurations</span>

   If only the tunnel egress node is DS-capable, [<a href="rfc2475.html">RFC 2475</a>] requires the
   egress node to perform any edge traffic conditioning needed by the
   diffserv domain for tunneled traffic entering from outside the
   domain.  If the egress node would not otherwise be a DS edge node,
   one way to meet this requirement is to perform edge traffic
   conditioning at an appropriate upstream DS edge node within the
   tunnel, and copy the DSCP value from the outer IP header to the inner
   IP header as part of tunnel decapsulation processing; this applies
   the uniform model to the portion of the tunnel within the egress
   node's diffserv domain.  A second alternative is to discard the outer
   DSCP value as part of decapsulation processing, reducing the
   resulting traffic conditioning problem and requirements to those of
   an ordinary DS ingress node.  This applies the pipe model to the
   portion of the tunnel within the egress node's diffserv domain and
   hence the adjacent upstream node for DSCP marking purposes is the
   tunnel ingress node, rather than the immediately upstream
   intermediate tunnel node.

   If only the tunnel ingress node is DS-capable, [<a href="rfc2475.html">RFC 2475</a>] requires
   that traffic emerging from the tunnel be compatible with the network
   at the tunnel egress.  If tunnel decapsulation processing discards
   the outer header's DSCP value without changing the inner header's
   DSCP value, the DS-capable tunnel ingress node is obligated to set
   the inner header's DSCP to a value compatible with the network at the
   tunnel egress.  The value 0 (DSCP of 000000) is used for this purpose
   by a number of existing tunnel implementations.  If the egress
   network implements IP precedence as specified in [<a href="rfc791.html">RFC 791</a>], then some
   or all of the eight class selector DSCP codepoints defined in [RFC
   2474] may be usable.  DSCP codepoints other than the class selectors
   are not generally suitable for this purpose, as correct operation
   would usually require diffserv functionality at the DS-incapable
   tunnel egress node.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/4.%20Ingress%20Functionality"></a><a class="selflink" href="#section-4" name="section-4">4</a>. Ingress Functionality</span>

   As described in <a href="#section-3">Section 3</a> above, this analysis is based on an
   approach in which diffserv functionality and/or out-of-band
   communication paths are not placed in parallel with tunnel
   encapsulation processing.  This allows three possible locations for
   traffic conditioning with respect to tunnel encapsulation processing,
   as shown in the following diagram that depicts the flow of IP headers
   through tunnel encapsulation:







<span class="grey">Black                        Informational                      [Page 5]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-6" id="page-6" name="page-6"> </a>
<span class="grey"><a href="rfc2983.html">RFC 2983</a>                  Diffserv and Tunnels              October 2000</span>


                                        +--------- [2 - Outer] --&gt;&gt;
                                       /
                                      /
   &gt;&gt;---- [1 - Before] -------- Encapsulate ------ [3 - Inner] --&gt;&gt;

   Traffic conditioning at [1 - Before] is logically separate from the
   tunnel, as it is not impacted by the presence of tunnel
   encapsulation, and hence should be allowed by tunnel designs and
   specifications.  Traffic conditioning at [2 - Outer] may interact
   with tunnel protocols that are sensitive to packet reordering; such
   tunnels may need to limit the functionality at [2 - Outer] as
   discussed further in <a href="#section-5.1">Section 5.1</a>.  In the absence of reordering
   sensitivity, no additional restrictions should be necessary, although
   traffic conditioning at [2 - Outer] may be responsible for remarking
   traffic to be compatible with the next diffserv domain that the
   tunneled traffic enters.

   In contrast, the [3 - Inner] location is difficult to utilize for
   traffic conditioning because it requires functionality that reaches
   inside the packet to operate on the inner IP header.  This is
   impossible for IPSec tunnels and any other tunnels that are encrypted
   or employ cryptographic integrity checks.  Hence traffic conditioning
   at [3 - Inner] can often only be performed as part of tunnel
   encapsulation processing, complicating both the encapsulation and
   traffic conditioning implementations.  In many cases, the desired
   functionality can be achieved via a combination of traffic
   conditioners in the other two locations, both of which can be
   specified and implemented independently of tunnel encapsulation.

   An exception for which traffic conditioning functionality is
   necessary at [3 - Inner] occurs when the DS-incapable tunnel egress
   discards the outer IP header as part of decapsulation processing, and
   hence the DSCP in the inner IP header must be compatible with the
   egress network.  Setting the inner DSCP to 0 as part of encapsulation
   addresses most of these cases, and the class selector DCSP codepoint
   values are also useful for this purpose, as they are valid for
   networks that support IP precedence [<a href="rfc791.html">RFC 791</a>].

   The following table summarizes the achievable relationships among the
   before (B), outer (O), and inner (I) DSCP values and the
   corresponding locations of traffic conditioning logic.










<span class="grey">Black                        Informational                      [Page 6]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-7" id="page-7" name="page-7"> </a>
<span class="grey"><a href="rfc2983.html">RFC 2983</a>                  Diffserv and Tunnels              October 2000</span>


   Relationship       Traffic Conditioning Location(s)
   ------------       --------------------------------
   B  = I  = O        No traffic conditioning required
   B != I  = O        [1 - Before]
   B  = I != O        [2 - Outer]
   B  = O != I        Limited support as part of encapsulation:
                        I can be set to 000000 or possibly one of
                        the class selector code points.
   B != I != O        Some combination of the above three scenarios.

   A combination of [1 - Before] and [2 - Outer] is applicable to many
   cases covered by the last two lines of the table, and may be
   preferable to deploying functionality at [3 - Inner].  Traffic
   conditioning may still be required for purposes such as rate and
   burst control even if DSCP values are not changed.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.1%20Ingress%20DSCP%20Selection%20and%20Reordering"></a><a class="selflink" href="#section-4.1" name="section-4.1">4.1</a> Ingress DSCP Selection and Reordering</span>

   It may be necessary or desirable to limit the DS behavior aggregates
   that utilize an IP tunnel that is sensitive to packet reordering
   within the tunnel.  The diffserv architecture allows packets to be
   reordered when they belong to behavior aggregates among which
   reordering is permitted; for example, reordering is allowed among
   behavior aggregates marked with different Class Selector DSCPs [RFC
   2474].  IPSec [<a href="rfc2401.html">RFC 2401</a>] and L2TP [<a href="rfc2661.html">RFC 2661</a>] provide examples of
   tunnels that are sensitive to packet reordering.  If IPSec's anti-
   replay support is configured, audit events are generated in response
   to packet reordering that exceeds certain levels, with the audit
   events indicating potential security issues.  L2TP can be configured
   to restore the ingress ordering of packets at tunnel egress, not only
   undoing any differentiation based on reordering within the tunnel,
   but also negatively impacting the traffic (e.g., by increasing
   latency).  The uniform model cannot be completely applied to such
   tunnels, as arbitrary mixing of traffic from different behavior
   aggregates can cause these undesirable interactions.

   The simplest method of avoiding undesirable interactions of
   reordering with reordering-sensitive tunnel protocols and features is
   not to employ the reordering-sensitive protocols or features, but
   this is often not desirable or even possible.  When such protocols or
   features are used, interactions can be avoided by ensuring that the
   aggregated flows through the tunnel are marked at [2 - Outer] to
   constitute a single ordered aggregate (i.e., the PHBs used share an
   ordering constraint that prevents packets from being reordered).
   Tunnel protocol specifications should indicate both whether and under
   what circumstances a tunnel should be restricted to a single ordered
   aggregate as well as the consequences of deviating from that
   restriction.  For the IPSec and L2TP examples discussed above, the



<span class="grey">Black                        Informational                      [Page 7]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-8" id="page-8" name="page-8"> </a>
<span class="grey"><a href="rfc2983.html">RFC 2983</a>                  Diffserv and Tunnels              October 2000</span>


   specifications should restrict each tunnel to a single ordered
   aggregate when protocol features sensitive to reordering are
   configured, and may adopt the approach of restricting all tunnels in
   order to avoid unexpected consequences of changes in protocol
   features or composition of tunneled traffic.  Diffserv
   implementations should not attempt to look within such tunnels to
   provide reordering-based differentiation to the encapsulated
   microflows.  If reordering-based differentiation is desired within
   such tunnels, multiple parallel tunnels between the same endpoints
   should be used.  This enables reordering among packets in different
   tunnels to coexist with an absence of packet reordering within each
   individual tunnel.  For IPSec and related security protocols, there
   is no cryptographic advantage to using a single tunnel for multiple
   ordered aggregates rather than multiple tunnels because any traffic
   analysis made possible by the use of multiple tunnels can also be
   performed based on the DSCPs in the outer headers of traffic in a
   single tunnel.  In general, the additional resources required to
   support multiple tunnels (e.g., cryptographic contexts), and the
   impact of multiple tunnels on network management should be considered
   in determining whether and where to deploy them.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.2%20Tunnel%20Selection"></a><a class="selflink" href="#section-4.2" name="section-4.2">4.2</a> Tunnel Selection</span>

   The behavioral characteristics of a tunnel are an important
   consideration in determining what traffic should utilize the tunnel.
   This involves the service provisioning policies of all the
   participating domains, not just the PHBs and DSCPs marked on the
   traffic at [2 - Outer].  For example, while it is in general a bad
   idea to tunnel EF PHB traffic via a Default PHB tunnel, this can be
   acceptable if the EF traffic is the only traffic that utilizes the
   tunnel, and the tunnel is provisioned in a fashion adequate to
   preserve the behavioral characteristics required by the EF PHB.

   Service provisioning policies are responsible for preventing
   mismatches such as forwarding EF traffic via an inadequately
   provisioned Default tunnel.  When multiple parallel tunnels with
   different behavioral characteristics are available, service
   provisioning policies are responsible for determining which flows
   should use which tunnels.  Among the possibilities is a coarse
   version of the uniform tunnel model in which the inner DSCP value is
   used to select a tunnel that will forward the traffic using a
   behavioral aggregate that is compatible with the traffic's PHB.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/5.%20Egress%20Functionality"></a><a class="selflink" href="#section-5" name="section-5">5</a>. Egress Functionality</span>

   As described in <a href="#section-3">Section 3</a> above, this analysis is based on an
   approach in which diffserv functionality and/or out-of-band
   communication paths are not placed in parallel with tunnel



<span class="grey">Black                        Informational                      [Page 8]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-9" id="page-9" name="page-9"> </a>
<span class="grey"><a href="rfc2983.html">RFC 2983</a>                  Diffserv and Tunnels              October 2000</span>


   encapsulation processing.  This allows three possible locations for
   traffic conditioners with respect to tunnel decapsulation processing,
   as shown in the following diagram that depicts the flow of IP headers
   through tunnel decapsulation:

   &gt;&gt;----[5 - Outer]-------------+
                                  \
                                   \
   &gt;&gt;----[4 - Inner] --------- Decapsulate ---- [6 - After] --&gt;&gt;

   Traffic conditioning at [5 - Outer] and [6 - After] is logically
   separate from the tunnel, as it is not impacted by the presence of
   tunnel decapsulation.  Tunnel designs and specifications should allow
   diffserv traffic conditioning at these locations. Such conditioning
   can be viewed as independent of the tunnel, i.e., [5 - Outer] is
   traffic conditioning that takes place prior to tunnel egress, and
   [6 - After] is traffic conditioning that takes place after egress
   decapsulation.  An important exception is that the configuration of a
   tunnel (e.g., the absence of traffic conditioning at tunnel ingress)
   and/or the diffserv domains involved may require that all traffic
   exiting a tunnel pass through diffserv traffic conditioning to
   fulfill the diffserv edge node traffic conditioning responsibilities
   of the tunnel egress node.  Tunnel designers are strongly encouraged
   to include the ability to require that all traffic exiting a tunnel
   pass through diffserv traffic conditioning in order to ensure that
   traffic exiting the node is compatible with the egress node's
   diffserv domain.

   In contrast, the [4 - Inner] location is difficult to employ for
   traffic conditioning because it requires reaching inside the packet
   to operate on the inner IP header.  Unlike the [3 - Inner] case for
   encapsulation, there is no need for functionality to be performed at
   [4- Inner], as diffserv traffic conditioning can be appended to the
   tunnel decapsulation (i.e., performed at [6 - After]).

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/5.1%20Egress%20DSCP%20Selection"></a><a class="selflink" href="#section-5.1" name="section-5.1">5.1</a> Egress DSCP Selection</span>

   The elimination of parallel functionality and data paths from
   decapsulation causes a potential loss of information.  As shown in
   the above diagram, decapsulation combines and reduces two DSCP values
   to one DSCP value, losing information in the most general case, even
   if arbitrary functionality is allowed.  Beyond this, allowing
   arbitrary functionality poses a structural problem, namely that the
   DSCP value from the outer IP header would have to be presented as an
   out-of-band input to the traffic conditioning block at [6 - After],
   complicating the traffic conditioning model.





<span class="grey">Black                        Informational                      [Page 9]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-10" id="page-10" name="page-10"> </a>
<span class="grey"><a href="rfc2983.html">RFC 2983</a>                  Diffserv and Tunnels              October 2000</span>


   To avoid such complications, the simpler approach of statically
   selecting either the inner or outer DSCP value at decapsulation is
   recommended, leaving the full generality of traffic conditioning
   functionality to be implemented at [5 - Outer] and/or [6 - After].
   Tunnels should support static selection of one or the other DSCP
   value at tunnel egress.  The rationale for this approach is usually
   only one of the two DSCP values contains useful information.  The
   conceptual model for the tunnel provides a strong indication of which
   one contains useful information; the outer DSCP value usually
   contains the useful information for tunnels based on the uniform
   model, and the inner DSCP value usually contains the useful
   information for tunnels based on the pipe model.  IPSec tunnels are
   usually based on the pipe model, and for security reasons are
   currently required to select the inner DSCP value; they should not be
   configured to select the outer DSCP value in the absence of an
   adequate security analysis of the resulting risks and implications.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/5.2%20Egress%20DSCP%20Selection%20Case%20Study"></a><a class="selflink" href="#section-5.2" name="section-5.2">5.2</a> Egress DSCP Selection Case Study</span>

   As a sanity check on the egress DSCP selection approach proposed
   above, this subsection considers a situation in which a more complex
   approach might be required.  Statically choosing a single DSCP value
   may not work well when both DSCPs are carrying information that is
   relevant to traffic conditioning.

   As an example, consider a situation in which different AF groups [RFC
   2597] are used by the two domains at the tunnel endpoints, and there
   is an intermediate domain along the tunnel using <a href="rfc791.html">RFC 791</a> IP
   precedences that is transited by setting the DSCP to zero.  This
   situation is shown in the following IP header flow diagram where I is
   the tunnel ingress node, E is the tunnel egress node and the vertical
   lines are domain boundaries.  The node at the left-hand vertical line
   sets the DSCP in the outer header to 0 in order to obtain
   compatibility with the middle domain:

                        |                   |
                  +-----|-------------------|------+
                 /      |                   |       \
   &gt;&gt;-----------I-------|-------------------|--------E----------&gt;&gt;
                        |                   |
      Ingress DS Domain        <a href="rfc791.html">RFC 791</a>         Egress DS domain
                            IP Precedence
                                Domain

   In this situation, the DS edge node for the egress domain (i.e., the
   node at the right-hand vertical line) can select the appropriate AF
   group (e.g., via an MF classifier), but cannot reconstruct the drop
   precedence information that was removed from the outer header when it



<span class="grey">Black                        Informational                     [Page 10]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-11" id="page-11" name="page-11"> </a>
<span class="grey"><a href="rfc2983.html">RFC 2983</a>                  Diffserv and Tunnels              October 2000</span>


   transited the <a href="rfc791.html">RFC 791</a> domain (although it can construct new
   information via metering and marking).  The original drop precedence
   information is preserved in the inner IP header's DSCP, and could be
   combined at the tunnel egress with the AF class selection
   communicated via the outer IP header's DSCP.  The marginal benefit of
   being able to reuse the original drop precedence information as
   opposed to constructing new drop precedence markings does not justify
   the additional complexity introduced into tunnel egress traffic
   conditioners by making both DSCP values available to traffic
   conditioning at [6 - After].

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/6.%20%20Diffserv%20and%20Protocol%20Translators"></a><a class="selflink" href="#section-6" name="section-6">6</a>.  Diffserv and Protocol Translators</span>

   A related issue involves protocol translators, including those
   employing the Stateless IP/ICMP Translation Algorithm [<a href="rfc2765.html">RFC 2765</a>].
   These translators are not tunnels because they do not add or remove a
   second IP header to/from packets (e.g., in contrast to IPv6 over IPv4
   tunnels [<a href="rfc1933.html">RFC 1933</a>]) and hence do not raise concerns of information
   propagation between inner and outer IP headers.  The primary
   interaction between translators and diffserv is that the translation
   boundary is likely to also be a diffserv domain boundary (e.g., the
   IPv4 and IPv6 domains may have different policies for traffic
   conditioning and DSCP usage), and hence such translators should allow
   the insertion of diffserv edge node processing (including traffic
   conditioning) both before and after the translation processing.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/7.%20Security%20Considerations"></a><a class="selflink" href="#section-7" name="section-7">7</a>. Security Considerations</span>

   The security considerations for the diffserv architecture discussed
   in [RFC 2474, <a href="rfc2475.html">RFC 2475</a>] apply when tunnels are present.  One of the
   requirements is that a tunnel egress node in the interior of a
   diffserv domain is the DS ingress node for traffic exiting the
   tunnel, and is responsible for performing appropriate traffic
   conditioning.  The primary security implication is that the traffic
   conditioning is responsible for dealing with theft- and denial-of-
   service threats posed to the diffserv domain by traffic exiting from
   the tunnel.  The IPSec architecture [<a href="rfc2401.html">RFC 2401</a>] places a further
   restriction on tunnel egress processing; the outer header is to be
   discarded unless the properties of the traffic conditioning to be
   applied are known and have been adequately analyzed for security
   vulnerabilities.  This includes both the [5 - Outer] and [6 - After]
   traffic conditioning blocks on the tunnel egress node, if present,
   and may involve traffic conditioning performed by an upstream DS-edge
   node that is the DS domain ingress node for the encapsulated tunneled
   traffic.






<span class="grey">Black                        Informational                     [Page 11]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-12" id="page-12" name="page-12"> </a>
<span class="grey"><a href="rfc2983.html">RFC 2983</a>                  Diffserv and Tunnels              October 2000</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/8.%20References"></a><a class="selflink" href="#section-8" name="section-8">8</a>. References</span>

   [<a id="ref-RFC 791" name="ref-RFC 791">RFC 791</a>]  Postel, J., "Internet Protocol", STD 5, <a href="rfc791.html">RFC 791</a>, September
              1981.

   [<a id="ref-RFC 1661" name="ref-RFC 1661">RFC 1661</a>] Simpson, W., "The Point-to-Point Protocol (PPP)", STD 51,
              <a href="rfc1661.html">RFC 1661</a>, July 1994.

   [<a id="ref-RFC 1933" name="ref-RFC 1933">RFC 1933</a>] Gilligan, R. and E. Nordmark, "Transition Mechanisms for
              IPv6 Hosts and Routers", <a href="rfc1933.html">RFC 1933</a>, April 1996.

   [<a id="ref-RFC 2003" name="ref-RFC 2003">RFC 2003</a>] Perkins, C., "IP Encapsulation within IP", <a href="rfc2003.html">RFC 2003</a>,
              October 1996.

   [<a id="ref-RFC 2401" name="ref-RFC 2401">RFC 2401</a>] Kent, S. and R. Atkinson, "Security Architecture for the
              Internet Protocol", <a href="rfc2401.html">RFC 2401</a>, November 1998.

   [<a id="ref-RFC 2474" name="ref-RFC 2474">RFC 2474</a>] Nichols, K., Blake, S., Baker, F. and D. Black,
              "Definition of the Differentiated Services Field (DS
              Field) in the IPv4 and IPv6 Headers", <a href="rfc2474.html">RFC 2474</a>, December
              1998.

   [<a id="ref-RFC 2475" name="ref-RFC 2475">RFC 2475</a>] Blake, S., Black, D., Carlson, M., Davies, E., Wang, Z.
              and W. Weiss, "An Architecture for Differentiated
              Services", <a href="rfc2475.html">RFC 2475</a>, December 1998.

   [<a id="ref-RFC 2597" name="ref-RFC 2597">RFC 2597</a>] Heinanen, J., Baker, F., Weiss, W. and J. Wroclawski,
              "Assured Forwarding PHB Group", <a href="rfc2597.html">RFC 2597</a>. June 1999.

   [<a id="ref-RFC 2598" name="ref-RFC 2598">RFC 2598</a>] Jacobson, V., Nichols, K. and K. Poduri, "An Expedited
              Forwarding PHB", <a href="rfc2598.html">RFC 2598</a>, June 1999.

   [<a id="ref-RFC 2661" name="ref-RFC 2661">RFC 2661</a>] Townsley, W., Valencia, A., Rubens, A., Pall, G., Zorn, G.
              and B. Palter. "Layer Two Tunneling Protocol "L2TP"", <a href="rfc2661.html">RFC</a>
              <a href="rfc2661.html">2661</a>, August 1999.

   [<a id="ref-RFC 2765" name="ref-RFC 2765">RFC 2765</a>] Nordmark, E., "Stateless IP/ICMP Translation Algorithm
              (SIIT)", <a href="rfc2765.html">RFC 2765</a>, February 2000.













<span class="grey">Black                        Informational                     [Page 12]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-13" id="page-13" name="page-13"> </a>
<span class="grey"><a href="rfc2983.html">RFC 2983</a>                  Diffserv and Tunnels              October 2000</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/9.%20Acknowledgments"></a><a class="selflink" href="#section-9" name="section-9">9</a>. Acknowledgments</span>

   Some of this material is based on discussions with Brian Carpenter,
   and in particular his presentation on this topic to the diffserv WG
   during the summer 1999 IETF meeting in Oslo.  Credit is also due to a
   number of people working on tunnel specifications who have discovered
   limitations of the diffserv architecture [<a href="rfc2475.html">RFC 2475</a>] in the area of
   tunnels.  Their patience with the time it has taken to address this
   set of issues is greatly appreciated.  Finally, this material has
   benefited from discussions within the diffserv WG, both in meetings
   and on the mailing list -- the contributions of participants in those
   discussions are gratefully acknowledged.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/10.%20Author%27s%20Address"></a><a class="selflink" href="#section-10" name="section-10">10</a>. Author's Address</span>

   David L. Black
   EMC Corporation
   42 South St.
   Hopkinton, MA   01748

   Phone: +1 (508) 435-1000 x75140
   EMail: black_david@emc.com





























<span class="grey">Black                        Informational                     [Page 13]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-14" id="page-14" name="page-14"> </a>
<span class="grey"><a href="rfc2983.html">RFC 2983</a>                  Diffserv and Tunnels              October 2000</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/11.%20%20Full%20Copyright%20Statement"></a><a class="selflink" href="#section-11" name="section-11">11</a>.  Full Copyright Statement</span>

   Copyright (C) The Internet Society (2000).  All Rights Reserved.

   This document and translations of it may be copied and furnished to
   others, and derivative works that comment on or otherwise explain it
   or assist in its implementation may be prepared, copied, published
   and distributed, in whole or in part, without restriction of any
   kind, provided that the above copyright notice and this paragraph are
   included on all such copies and derivative works.  However, this
   document itself may not be modified in any way, such as by removing
   the copyright notice or references to the Internet Society or other
   Internet organizations, except as needed for the purpose of
   developing Internet standards in which case the procedures for
   copyrights defined in the Internet Standards process must be
   followed, or as required to translate it into languages other than
   English.

   The limited permissions granted above are perpetual and will not be
   revoked by the Internet Society or its successors or assigns.

   This document and the information contained herein is provided on an
   "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
   BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
   HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.

Acknowledgement

   Funding for the RFC Editor function is currently provided by the
   Internet Society.



















Black                        Informational                     [Page 14]

</pre><br/>
    <span class="noprint"><small><small>Html markup produced by rfcmarkup 1.127, available from
      <a href="https://tools.ietf.org/tools/rfcmarkup/">https://tools.ietf.org/tools/rfcmarkup/</a>
    </small></small></span>
  </div>




</body><!-- Mirrored from tools.ietf.org/html/rfc2983 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 14 Aug 2018 14:27:48 GMT --></html>