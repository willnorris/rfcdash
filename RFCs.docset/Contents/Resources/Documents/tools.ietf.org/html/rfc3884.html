<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><!-- Mirrored from tools.ietf.org/html/rfc3884 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Mar 2018 23:18:45 GMT --><!-- Added by HTTrack --><head><meta content="text/html;charset=utf-8" http-equiv="content-type"/><!-- /Added by HTTrack -->

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <meta content="index,follow" name="robots"/>
    <meta content="rfcmarkup version 1.126" name="creator"/>
    <link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/>
<meta content="urn:ietf:rfc:3884" name="DC.Identifier"/>
<meta content="IPsec can secure the links of a multihop network to protect
communication between trusted components, e.g., for a secure virtual
network (VN), overlay, or virtual private network (VPN). Virtual links
established by IPsec tunnel mode can conflict with routing and
forwarding inside VNs because IP routing depends on references to
interfaces and next-hop IP addresses. The IPsec tunnel mode
specification is ambiguous on this issue, so even compliant
implementations cannot be trusted to avoid conflicts. An alternative
to tunnel mode uses non-IPsec IPIP encapsulation together with IPsec
transport mode, which we call IIPtran. IPIP encapsulation occurs as a
separate initial step, as the result of a forwarding lookup of the VN
packet. IPsec transport mode processes the resulting (tunneled) IP
packet with an SA determined through a security association database
(SAD) match on the tunnel header. IIPtran supports dynamic routing
inside the VN without changes to the current IPsec architecture.
IIPtran demonstrates how to configure any compliant IPsec
implementation to avoid the aforementioned conflicts. IIPtran is also
compared to several alternative mechanisms for VN routing and their
respective impact on IPsec, routing, policy enforcement, and
interactions with the Internet Key Exchange (IKE). This memo provides
information for the Internet community." name="DC.Description.Abstract"/>
<meta content="Touch, Joe" name="DC.Creator"/>
<meta content="Wang, Yu-Shun" name="DC.Creator"/>
<meta content="Eggert, Lars" name="DC.Creator"/>
<meta content="September, 2004" name="DC.Date.Issued"/>
<meta content="Use of IPsec Transport Mode for Dynamic Routing" name="DC.Title"/>

    <link href="https://tools.ietf.org/images/rfc.png" rel="icon" type="image/png"/>
    <link href="https://tools.ietf.org/images/rfc.png" rel="shortcut icon" type="image/png"/>
    <title>RFC 3884 - Use of IPsec Transport Mode for Dynamic Routing</title>
    
    
    <style type="text/css">
	@media only screen 
	  and (min-width: 992px)
	  and (max-width: 1199px) {
	    body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 768px)
	  and (max-width: 991px) {
            body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 480px)
	  and (max-width: 767px) {
            body { font-size: 11pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (max-width: 479px) {
            body { font-size: 8pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-device-width : 375px) 
	  and (max-device-width : 667px) {
            body { font-size: 9.5pt; }
            div.content { width: 96ex; margin: 0 1px; }
        }
	@media only screen 
	  and (min-device-width: 1200px) {
            body { font-size: 10pt; margin: 0 4em; }
            div.content { width: 96ex; margin: 0; }
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        a.selflink {
          color: black;
          text-decoration: none;
        }
        @media print {
            body {
                font-family: monospace;
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 1em;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>                   <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>                     <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>             <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>              <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td>      <td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td>         <td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard (old designation):</td> <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Internet Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>                  <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>                  <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
  <div class="content">
   <div style="height: 13px;">
      <div class="pre noprint docinfo bgorange" onclick="showElem('legend');" onmouseout="hideElem('legend')" onmouseover="this.style.cursor='pointer';" style="height: 6px; position: absolute;" title="Click for colour legend.">                                                                        </div>
      <div class="docinfo noprint pre legend" id="legend" onmouseout="hideElem('legend');" onmouseover="showElem('legend');" style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; ">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="index.html" title="Document search and retrieval page">Docs</a>] [<a href="https://tools.ietf.org/rfc/rfc3884.txt" title="Plaintext version of this document">txt</a>|<a href="https://tools.ietf.org/pdf/rfc3884" title="PDF version of this document">pdf</a>] [<a href="https://tools.ietf.org/html/draft-touch-ipsec-vpn" title="draft-touch-ipsec-vpn">draft-touch-ips...</a>] [<a href="https://datatracker.ietf.org/doc/rfc3884" title="IESG Datatracker information for this document">Tracker</a>] [<a href="https://tools.ietf.org/rfcdiff?difftype=--hwdiff&amp;url2=rfc3884" title="Inline diff (wdiff)">Diff1</a>] [<a href="https://tools.ietf.org/rfcdiff?url2=rfc3884" title="Side-by-side diff">Diff2</a>]         </span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<span class="pre noprint docinfo">                                                           INFORMATIONAL</span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<pre>Network Working Group                                           J. Touch
Request for Comments: 3884                                           ISI
Category: Informational                                        L. Eggert
                                                                     NEC
                                                                 Y. Wang
                                                                     ISI
                                                          September 2004


            <span class="h1">Use of IPsec Transport Mode for Dynamic Routing</span>

Status of this Memo

   This memo provides information for the Internet community.  It does
   not specify an Internet standard of any kind.  Distribution of this
   memo is unlimited.

Copyright Notice

   Copyright (C) The Internet Society (2004).

IESG Note

   This document is not a candidate for any level of Internet Standard.
   The IETF disclaims any knowledge of the fitness of this document for
   any purpose, and in particular notes that it has not had IETF review
   for such things as security, congestion control or inappropriate
   interaction with deployed protocols.  The RFC Editor has chosen to
   publish this document at its discretion.  Readers of this document
   should exercise caution in evaluating its value for implementation
   and deployment.

Abstract

   IPsec can secure the links of a multihop network to protect
   communication between trusted components, e.g., for a secure virtual
   network (VN), overlay, or virtual private network (VPN). Virtual
   links established by IPsec tunnel mode can conflict with routing and
   forwarding inside VNs because IP routing depends on references to
   interfaces and next-hop IP addresses. The IPsec tunnel mode
   specification is ambiguous on this issue, so even compliant
   implementations cannot be trusted to avoid conflicts.  An alternative
   to tunnel mode uses non-IPsec IPIP encapsulation together with IPsec
   transport mode, which we call IIPtran.  IPIP encapsulation occurs as
   a separate initial step, as the result of a forwarding lookup of the
   VN packet. IPsec transport mode processes the resulting (tunneled) IP
   packet with an SA determined through a security association database
   (SAD) match on the tunnel header.  IIPtran supports dynamic routing



<span class="grey">Touch, et al.                Informational                      [Page 1]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-2" id="page-2" name="page-2"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


   inside the VN without changes to the current IPsec architecture.
   IIPtran demonstrates how to configure any compliant IPsec
   implementation to avoid the aforementioned conflicts.  IIPtran is
   also compared to several alternative mechanisms for VN routing and
   their respective impact on IPsec, routing, policy enforcement, and
   interactions with the Internet Key Exchange (IKE).

Table of Contents

   <a href="#section-1">1</a>.  Introduction . . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-3">3</a>
       <a href="#section-1.2">1.2</a>.  Document History . . . . . . . . . . . . . . . . . . . .  <a href="#page-3">3</a>
   <a href="#section-2">2</a>.  Problem Description. . . . . . . . . . . . . . . . . . . . . .  <a href="#page-4">4</a>
       <a href="#section-2.1">2.1</a>.  IPsec Overview . . . . . . . . . . . . . . . . . . . . .  <a href="#page-5">5</a>
       <a href="#section-2.2">2.2</a>.  Forwarding Example . . . . . . . . . . . . . . . . . . .  <a href="#page-6">6</a>
       <a href="#section-2.3">2.3</a>.  Problem 1: Forwarding Issues . . . . . . . . . . . . . .  <a href="#page-7">7</a>
       <a href="#section-2.4">2.4</a>.  Problem 2: Source Address Selection  . . . . . . . . . .  <a href="#page-8">8</a>
   <a href="#section-3">3</a>.  IIPtran: IPIP Tunnel Devices + IPsec Transport Mode  . . . . .  <a href="#page-9">9</a>
       <a href="#section-3.1">3.1</a>.  IIPtran Details  . . . . . . . . . . . . . . . . . . . . <a href="#page-10">10</a>
       <a href="#section-3.2">3.2</a>.  Solving Problem 1: Forwarding Issues . . . . . . . . . . <a href="#page-11">11</a>
       <a href="#section-3.3">3.3</a>.  Solving Problem 2: Source Address Selection  . . . . . . <a href="#page-12">12</a>
   <a href="#section-4">4</a>.  Comparison . . . . . . . . . . . . . . . . . . . . . . . . . . <a href="#page-12">12</a>
       <a href="#section-4.1">4.1</a>.  Other Proposed Solutions . . . . . . . . . . . . . . . . <a href="#page-12">12</a>
             <a href="#section-4.1.1">4.1.1</a>.  Alternative 1: IPsec with Interface SAs. . . . . <a href="#page-13">13</a>
             4.1.2.  Alternative 2: IPsec with Initial
                     Forwarding Lookup. . . . . . . . . . . . . . . . <a href="#page-13">13</a>
             4.1.3.  Alternative 3: IPsec with Integrated
                     Forwarding . . . . . . . . . . . . . . . . . . . <a href="#page-14">14</a>
       <a href="#section-4.2">4.2</a>.  Discussion . . . . . . . . . . . . . . . . . . . . . . . <a href="#page-14">14</a>
             <a href="#section-4.2.1">4.2.1</a>.  VN Routing Support and Complexity  . . . . . . . <a href="#page-14">14</a>
             <a href="#section-4.2.2">4.2.2</a>.  Impact on the IPsec Architecture . . . . . . . . <a href="#page-15">15</a>
             <a href="#section-4.2.3">4.2.3</a>.  Policy Enforcement and Selectors . . . . . . . . <a href="#page-16">16</a>
             <a href="#section-4.2.4">4.2.4</a>.  IKE Impact . . . . . . . . . . . . . . . . . . . <a href="#page-19">19</a>
   <a href="#section-5">5</a>.  Security Considerations  . . . . . . . . . . . . . . . . . . . <a href="#page-19">19</a>
   <a href="#section-6">6</a>.  Summary and Recommendations  . . . . . . . . . . . . . . . . . <a href="#page-20">20</a>
   <a href="#section-7">7</a>.  Acknowledgments  . . . . . . . . . . . . . . . . . . . . . . . <a href="#page-20">20</a>
   <a href="#section-8">8</a>.  References . . . . . . . . . . . . . . . . . . . . . . . . . . <a href="#page-20">20</a>
       <a href="#section-8.1">8.1</a>.  Normative References . . . . . . . . . . . . . . . . . . <a href="#page-20">20</a>
       <a href="#section-8.2">8.2</a>.  Informative References . . . . . . . . . . . . . . . . . <a href="#page-21">21</a>
   <a href="#appendix-A">A</a>.  Encapsulation/Decapsulation Issues . . . . . . . . . . . . . . <a href="#page-22">22</a>
       <a href="#appendix-A.1">A.1</a>.  Encapsulation Issues . . . . . . . . . . . . . . . . . . <a href="#page-22">22</a>
       <a href="#appendix-A.2">A.2</a>.  Decapsulation Issues . . . . . . . . . . . . . . . . . . <a href="#page-23">23</a>
       <a href="#appendix-A.3">A.3</a>.  <a href="#appendix-S">Appendix S</a>ummary . . . . . . . . . . . . . . . . . . . . <a href="#page-23">23</a>
       Authors' Addresses . . . . . . . . . . . . . . . . . . . . . . <a href="#page-24">24</a>
       Full Copyright Statement . . . . . . . . . . . . . . . . . . . <a href="#page-25">25</a>







<span class="grey">Touch, et al.                Informational                      [Page 2]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-3" id="page-3" name="page-3"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/1.%20%20Introduction"></a><a class="selflink" href="#section-1" name="section-1">1</a>.  Introduction</span>

   The IP security architecture (IPsec) consists of two modes, transport
   mode and tunnel mode [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>].  Transport mode is allowed between two end
   hosts only; tunnel mode is required when at least one of the
   endpoints is a "security gateway" (intermediate system that
   implements IPsec functionality, e.g., a router.)

   IPsec can be used to secure the links of a virtual network (VN),
   creating a secure VN.  In a secure VN, trusted routers inside the
   network dynamically forward packets in the clear (internally), and
   exchange the packets on secure tunnels, where paths may traverse
   multiple tunnels.  Contrast this to the conventional 'virtual private
   network' (VPN), which often assumes that paths tend to traverse one
   secure tunnel to resources in a secure core.  A general secure VN
   allows this secure core to be distributed, composed of trusted or
   privately-managed resources anywhere in the network.

   This document addresses the use of IPsec to secure the links of a
   multihop, distributed VN.  It describes how virtual links established
   by IPsec tunnel mode can conflict with routing and forwarding inside
   the VN, due to the IP routing dependence on references to interfaces
   and next-hop IP addresses.

   This document proposes a solution called IIPtran that separates the
   step of IP tunnel encapsulation from IPsec processing.  The solution
   combines a subset of the current IPsec architecture with other
   Internet standards to arrive at an interoperable equivalent that is
   both simpler and has a modular specification.

   Later sections of this document compare IIPtran to other proposals
   for dynamic routing inside VPNs, focusing on the impact the different
   proposals have on the overall IPsec architecture, routing protocols,
   security policy enforcement, and the Internet Key Exchange (IKE)
   [<a href="#ref-9" title='"The Internet Key Exchange (IKE)"'>9</a>][10].  An appendix addresses IP tunnel processing issues in IPsec
   related to IPIP encapsulation and decapsulation.

   This document assumes familiarity with other Internet standards
   [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>][2], notably with terminology and numerous acronyms therein.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/1.2.%20%20Document%20History"></a><a class="selflink" href="#section-1.2" name="section-1.2">1.2</a>.  Document History</span>

   This document was first issued as an Internet Draft on March 10,
   2000, entitled "Use of IPSEC Transport Mode for Virtual Networks,"
   and was first presented in the IPsec WG at the 47th IETF in Adelaide
   in March 2000.  It was subsequently revised and presented to the
   PPVPN WG at the 51st IETF in London in August 2001, to the IPsec WG
   at the 52nd IETF in Salt Lake City in December 2001, and to both the



<span class="grey">Touch, et al.                Informational                      [Page 3]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-4" id="page-4" name="page-4"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


   IPsec and PPVPN WGs at the 53rd IETF in Minneapolis in March 2002.
   Version 04 of this draft was submitted for publication as an
   Informational RFC based on suggestions by the IPsec WG in June 2002,
   and was under IESG review from then until version 07 was approved for
   publication in June 2004.  During that time, it was substantively
   revised according to feedback from the IESG regarding interactions
   with the IPsec specification (<a href="rfc2401.html">RFC 2401</a> [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>]) and other protocols, with
   regard to security and compatibility issues.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/2.%20%20Problem%20Description"></a><a class="selflink" href="#section-2" name="section-2">2</a>.  Problem Description</span>

   Virtual networks connect subsets of resources of an underlying base
   network, and present the result as a virtual network layer to upper-
   layer protocols.  Similar to a real network, virtual networks consist
   of virtual hosts (packet sources and sinks) and virtual routers
   (packet transits), both of which can have a number of network
   interfaces, and links, which connect multiple network interfaces
   together.  Virtual links (also called tunnels, especially when
   point-to-point) are one-hop links in the VN topology, but are either
   direct links or paths (sequences of connected links) in the
   underlying base network.

   Base network hosts and routers can be part of multiple virtual
   networks at the same time, and their role in the base network does
   not need to coincide with their role in a virtual network (i.e., base
   network hosts may act as VN routers or hosts, as may base network
   routers).

   It is important to note that this definition of a VN is more general
   than some other definitions, where the VN participation of end
   systems is limited.  Some proposals only allow end systems to be part
   of a single VN, or even only allow them to be part of the VN and not
   the base network, substituting the VN for the Internet.  The
   definition above explicitly allows hosts and routers to participate
   in multiple, parallel VNs, and allows layered VNs (VN inside VN).

   It can be useful for a VN to secure its virtual links [<a href="#ref-3" title='"Dynamic Internet overlay deployment and management using the X-Bone"'>3</a>][4],
   resulting in a VPN.  This is not equivalent to end-to-end security,
   but can be useful when end hosts do not support secure communication
   themselves.  It can provide an additional level of hop-by-hop network
   security to secure routing in the VPN and isolate the traffic of
   different VPNs.

   The topology of an IPsec VPN commonly consists of IPsec tunnel mode
   virtual links, as required by the IPsec architecture when the
   communicating peers are gateway pairs, or a host and a gateway [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>].
   However, this current required use of IPsec tunnel mode can be
   incompatible with dynamic routing [<a href="#ref-3" title='"Dynamic Internet overlay deployment and management using the X-Bone"'>3</a>].



<span class="grey">Touch, et al.                Informational                      [Page 4]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-5" id="page-5" name="page-5"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


   The next section provides a short overview on IPsec transport and
   tunnel mode processing, as far as it is relevant for the
   understanding of the problem scenarios that follow.  The following
   sections discuss routing problems in detail, based on a common
   example.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/2.1.%20%20IPsec%20Overview"></a><a class="selflink" href="#section-2.1" name="section-2.1">2.1</a>.  IPsec Overview</span>

   There are two modes of IPsec, transport mode and tunnel mode [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>].
   Transport mode secures portions of the existing IP header and the
   payload data of the packet, and inserts an IPsec header between the
   IP header and the payload; tunnel mode adds an additional IP header
   before performing similar operations.  This section gives a short
   overview of the relevant processing steps for both modes.

   In transport mode, IPsec inserts a security protocol header into
   outgoing IP packets between the original IP header and the packet
   payload (Figure 1) [<a href="#ref-5" title='"IP Authentication Header"'>5</a>][6][<a href="#ref-11" title='"IP Authentication Header"'>11</a>][12].  The contents of the IPsec header
   are based on the result of a "security association" (SA) lookup that
   uses the contents of the original packet header (Figure 1, arrow) as
   well as its payload (especially transport layer headers) to locate an
   SA in the security association database (SAD).

   Original Outbound Packet       Outbound Packet (IPsec Transport Mode)
   +-----------+---------+        +-----------+==============+---------+
   | IP Header | Payload |        | IP Header | IPsec Header | Payload |
   +-----------+---------+        +-----------+==============+---------+
                                        |             ^
                                        |             |
                                        +-------------+
                                           SA Lookup

   Figure 1: Outbound Packet Construction under IPsec Transport Mode

   When receiving packets secured with IPsec transport mode, a similar
   SA lookup occurs based on the IP and IPsec headers, followed by a
   verification step after IPsec processing that checks the contents of
   the packet and its payload against the respective SA.  The
   verification step is similar to firewall processing.

   When using tunnel mode, IPsec prepends an IPsec header and an
   additional IP header to the outgoing IP packet (Figure 2).  In
   essence, the original packet becomes the payload of another IP
   packet, which IPsec then secures.  This has been described [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>] as "a
   tunnel mode SA is essentially a [transport mode] SA applied to an IP
   tunnel." However, there are significant differences between the two,
   as described in the remainder of this section.




<span class="grey">Touch, et al.                Informational                      [Page 5]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-6" id="page-6" name="page-6"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


   In IPsec tunnel mode, the IP header of the original outbound packet
   together with its payload (especially transport headers) determines
   the IPsec SA, as for transport mode.  However, a tunnel mode SA also
   contains encapsulation information, including the source and
   destination IP addresses for the outer tunnel IP header, which is
   also based on the original outbound packet header and its payload
   (Figure 2, arrows).

                    Outbound Packet (IPsec Tunnel Mode)
      +==================+==============+-----------------+---------+
      | Tunnel IP Header | IPsec Header | Orig. IP Header | Payload |
      +==================+==============+-----------------+---------+
               ^                ^              | |
               |                |              | |
               |                +--------------+ |
               |                    SA Lookup    |
               |                                 |
               +---------------------------------+
                        IP Encapsulation

     Figure 2: Outbound Packet Construction under IPsec Tunnel Mode

   When receiving packets secured with tunnel mode IPsec, an SA lookup
   occurs based on the contents of the IPsec header and the outer IP
   header.  Next, the packet is decrypted or authenticated based on its
   IPsec header and the SA, followed by a verification step that checks
   the contents of the original packet and its payload (especially the
   inner IP header and transport headers) against the respective SA.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/2.2.%20%20Forwarding%20Example"></a><a class="selflink" href="#section-2.2" name="section-2.2">2.2</a>.  Forwarding Example</span>

   Consider a VPN topology with virtual links established by IPsec
   tunnel mode SAs, as would be required for compliance with [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>].  Such
   hop-by-hop security can be useful, for example, to secure VN routing,
   and when legacy end systems do not support end-to-end IPsec
   themselves.

   Virtual routers in a VN need to forward packets the same way regular
   Internet routers do: based on the destination IP address and the
   forwarding table.  These two determine the next hop IP address the
   packet should be forwarded to (additional header fields and inner
   headers can be used, e.g., in policy routing.)

   In Figure 3, traffic arrives at gateway A on virtual link 1, having
   come from any of the virtual hosts upstream of that virtual link.
   There are two outgoing virtual links for this incoming traffic: out
   link 3 going to the VPN next-hop gateway B, and out link 4 going to
   the VPN next-hop gateway C.



<span class="grey">Touch, et al.                Informational                      [Page 6]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-7" id="page-7" name="page-7"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


   For this example, assume the incoming traffic is from a single VPN
   source X, going to a single VPN destination Y. Ellipses (...)
   represent multiple virtual links in Figure 3.

                                B ---...---
                               /           \
                              / 3           \
                             /               \
                X ---...--- A                 D ---...--- Y
                   1     2   \                /
                              \ 4            /
                               \            /
                                C ---...---

                Figure 3: Topology of a Virtual Network

   Two problems arise; one is forwarding of VN traffic over IPsec tunnel
   mode links, the other is source address selection on VN end systems.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/2.3.%20%20Problem%201%3A%20Forwarding%20Issues"></a><a class="selflink" href="#section-2.3" name="section-2.3">2.3</a>.  Problem 1: Forwarding Issues</span>

   Assume a packet from source X to destination Y arrives on link 2 at
   gateway A. Gateway A now needs to both forward and encrypt the packet
   to make progress to the next hop gateway inside the VPN.

   Dynamically routed gateways forward packets based on a forwarding
   table managed by a routing daemon that exchanges connectivity
   information with directly connected peers by communicating on its
   local interfaces.  Entries in the forwarding table map destination IP
   addresses to the IP address of a next-hop gateway and an associated
   outbound interface.

   The problem is that an intermediate router needs to pick a next hop
   gateway for a transit packet based on its destination IP address and
   the contents of the forwarding table.  However, the IPsec
   architecture does not define if and how tunnel mode SAs are
   represented in the forwarding table.

   The problem occurs when A tries to decide how to forward the packet
   X-&gt;Y.  In a regular IP network, this decision depends on a forwarding
   lookup on destination address Y, which indicates the IP address of
   the next-hop gateway and an associated outbound interface.  In the
   case of a VN, forwarding lookups occur on virtual destination
   addresses.  For the forwarding lookup on such a virtual destination
   address to succeed, routes through virtual interfaces (tunnels) must
   exist in the forwarding table.





<span class="grey">Touch, et al.                Informational                      [Page 7]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-8" id="page-8" name="page-8"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


   There are two common implementation scenarios for tunnel mode SAs:
   One is based on firewall-like packet matching operations where tunnel
   mode SAs are not virtual interfaces, another is tunnel-based, and
   treats a tunnel mode SA as a virtual interface.  The current IPsec
   architecture does not mandate one or the other.

   Under the first approach, the presence of IPsec tunnel mode SAs is
   invisible to the IP forwarding mechanism.  The lookup uses matching
   rules in the SA lookup process, closer to firewall matching than
   traditional IP forwarding lookups, and independent from existing IP
   forwarding tables.  The SA lookup determines which virtual link the
   packet will be forwarded over, because the tunnel mode SA includes
   encapsulation information.  This lookup and the subsequent tunnel
   mode processing both ignore the contents of the existing IP
   forwarding table, whether static or dynamic routing are used.  This
   type of tunnel mode processing is thus incompatible with dynamically
   routed VPNs.

   The second approach - requiring tunnel mode SAs to be interfaces -
   can be compatible with dynamically routed VPNs (see <a href="#section-4">Section 4</a>)
   depending on how it is implemented; however, IIPtran (see <a href="#section-3">Section 3</a>)
   has the additional benefit of greatly simplifying the IPsec
   architecture and related specifications, and of being compatible with
   all IPsec specification compliant implementations.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/2.4.%20%20Problem%202%3A%20Source%20Address%20Selection"></a><a class="selflink" href="#section-2.4" name="section-2.4">2.4</a>.  Problem 2: Source Address Selection</span>

   A second issue is source address selection at the source host.  When
   an application sends traffic to another host, the host must choose an
   IP source address for the IP packets before transmission.

   When an end system is connected to multiple networks, it must set the
   source address properly to receive return traffic over the correct
   network.  When a node participates in a virtual network, it is always
   connected to two networks, the base network and the VN (more if it
   connects to at least two VNs.) The IPsec specification currently does
   not define how tunnel mode SAs integrate with source address
   selection.

   For example, when communication occurs over a virtual network, the
   source address must lie inside the VN.  When X sends to Y (Figure 3),
   the source address must be the IP address of X's local end of tunnel
   1. If host A, which has multiple interfaces inside the VN, sends to
   Y, the source address must be the IP address of the local end of
   either tunnel 3 or 4.






<span class="grey">Touch, et al.                Informational                      [Page 8]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-9" id="page-9" name="page-9"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


   Most applications do not bind to a specific source IP address, and
   instead let the host pick one for their traffic [<a href="#ref-7" title='"Requirements for Internet Hosts - Communication Layers"'>7</a>].  Rules for
   source address selection that depend heavily on the notions of
   interfaces and routes.

   According to [<a href="#ref-7" title='"Requirements for Internet Hosts - Communication Layers"'>7</a>], the IP source address of an outbound packet should:
   (1) for directly connected networks derive from the corresponding
   interface, or (2) derive from existing dynamic or static route
   entries to the destination, or finally (3) derive from the interface
   attached to a default gateway.

   Because IPsec tunnel mode SAs are not required to be interfaces,
   rules (1) and (2) may not return a usable source address for a given
   packet.  Consequently, VN packets will use the IP address of the
   local interface connecting to a default gateway as their source
   address.  Often, a default gateway for a host provides connectivity
   in the base network underlying the VN.  The outgoing packet will thus
   have a source address in the base network, and a destination address
   in the VN.

   This can result in numerous problems, including applications that
   fail to operate at all, firewalls and admission control failures, and
   may even lead to compromised security.  Consider two cases, one with
   IPsec tunnels configured with no wildcard tunnel addresses, the other
   using certain wildcards.  In both cases, an application whose source
   address is set by <a href="rfc1122.html">RFC 1122</a> [<a href="#ref-7" title='"Requirements for Internet Hosts - Communication Layers"'>7</a>] rules may send packets (e.g.) with the
   source address of that host's base network (via the default route)
   and a destination address of the remote tunnel endpoint.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/3.%20%20IIPtran%3A%20IPIP%20Tunnel%20Devices%20%2B%20IPsec%20Transport%20Mode"></a><a class="selflink" href="#section-3" name="section-3">3</a>.  IIPtran: IPIP Tunnel Devices + IPsec Transport Mode</span>

   This section introduces a solution - called IIPtran - for the two
   issues identified above.  IIPtran replaces IPsec tunnel mode with a
   combination of IPIP tunnel interfaces that support forwarding and
   source address selection (as per <a href="rfc2003.html">RFC 2003</a> [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>]), followed by IPsec
   transport mode on the encapsulated packet.

   The IPsec architecture [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>] defines the appropriate use of IPsec
   transport mode and IPsec tunnel mode (host-to-host communication for
   the former, and all transit communication for the latter).  IIPtran
   appears to violate this requirement, because it uses IPsec transport
   mode for transit communication.

   However, for an IPIP tunnel between security gateways, the gateways
   themselves source or sink base network traffic when tunneling - they
   act as hosts in the base network.  Thus, IPsec transport mode is also
   appropriate, if not required, for encapsulated traffic, according to
   [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>].



<span class="grey">Touch, et al.                Informational                      [Page 9]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-10" id="page-10" name="page-10"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


   As a result, replacing IPsec tunnel mode with IPIP tunnel devices and
   IPsec transport mode is consistent with the existing architecture.
   Furthermore, this does not compromise the end-to-end use of IPsec,
   either inside a VPN or in the base network; it only adds IPsec
   protection to secure virtual links.

   The next sections will give a short overview of IPIP encapsulation,
   and show it combines with IPsec transport mode processing.  This
   section will then discuss how IIPtran addresses each of the problems
   identified above.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.1.%20%20IIPtran%20Details"></a><a class="selflink" href="#section-3.1" name="section-3.1">3.1</a>.  IIPtran Details</span>

   IIPtran uses IPIP tunnels (as defined in <a href="rfc2003.html">RFC 2003</a> [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>]), followed by
   IPsec transport mode on the encapsulated packet.

   <a href="rfc2003.html">RFC 2003</a> [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>] uniquely specifies IPIP encapsulation (placing an IP
   packet as payload inside another IP packet.) Originally developed for
   MobileIP, it has often been adopted when virtual topologies were
   required.  Examples include virtual (overlay) networks to support
   emerging protocols such as IP Multicast, IPv6, and Mobile IP itself,
   as well as systems that provide private networks over the Internet
   (X-Bone [<a href="#ref-3" title='"Dynamic Internet overlay deployment and management using the X-Bone"'>3</a>] and PPVPN).

   IPIP outbound packet processing, as specified by <a href="rfc2003.html">RFC 2003</a> [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>],
   tunnels an existing IP packet by prepending it with another IP header
   (Figure 4.)

                       Outbound Packet (IPIP Tunnel)
              +==================+-----------------+---------+
              | Tunnel IP Header | Orig. IP Header | Payload |
              +==================+-----------------+---------+
                       ^                  |
                       |                  |
                       +------------------+
                        IPIP Encapsulation

         Figure 4: Outbound Packet Construction for IPIP Tunnel

   IIPtran performs this IPIP processing as a first step, followed by
   IPsec transport mode processing on the resulting IPIP packet (Figure
   5.)









<span class="grey">Touch, et al.                Informational                     [Page 10]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-11" id="page-11" name="page-11"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


            Outbound Packet (IPIP Tunnel + IPsec Transport Mode)
      +==================+==============+-----------------+---------+
      | Tunnel IP Header | IPsec Header | Orig. IP Header | Payload |
      +==================+==============+-----------------+---------+
              ^  |               ^               |
              |  |               |               |
              |  +---------------+               |
              |      SA Lookup                   |
              |                                  |
              +----------------------------------+
                       IPIP Encapsulation

   Figure 5: Outbound Packet Construction for IPIP Tunnel with IPsec
                             Transport Mode

   A key difference between Figure 2 and Figure 5 is that in the
   proposed solution, the IPsec header is based on the outer IP header,
   whereas under IPsec tunnel mode processing, the IPsec header depends
   on the contents of the inner IP header and payload (see <a href="#section-2.1">Section 2.1</a>).

   However, the resulting VPN packet (Figure 5) on the wire cannot be
   distinguished from a VPN packet generated by IPsec tunnel mode
   processing (Figure 2); and the two methods inter-operate, given
   appropriate configurations on both ends [<a href="#ref-3" title='"Dynamic Internet overlay deployment and management using the X-Bone"'>3</a>].

   A detailed discussion of the differences between IIPtran, IPsec
   tunnel mode, and other proposed mechanisms follows in <a href="#section-4">Section 4</a>.  The
   remainder of this section will describe how IIPtran combines IPIP
   tunnel devices with IPsec transport mode to solve the problems
   identified in <a href="#section-2">Section 2</a>.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.2.%20%20Solving%20Problem%201%3A%20Forwarding%20Issues"></a><a class="selflink" href="#section-3.2" name="section-3.2">3.2</a>.  Solving Problem 1: Forwarding Issues</span>

   <a href="#section-2.3">Section 2.3</a> described how IP forwarding over IPsec tunnel mode SAs
   breaks, because tunnel mode SAs are not required to be network
   interfaces.  IIPtran uses <a href="rfc2003.html">RFC 2003</a> IPIP tunnels [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>] to establish the
   topology of the virtual network.  <a href="rfc2003.html">RFC 2003</a> [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>] requires that IPIP
   tunnels can be routed to, and have configurable addresses.  Thus,
   they can be references in node's routing table (supporting static
   routing), as well as used by dynamic routing daemons for local
   communication of reachability information.

   <a href="rfc2003.html">RFC 2003</a> [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>] addressed the issue of inserting an IPsec header between
   the two IP headers that are a result of IPIP encapsulation.  IIPtran
   provides further details on this configuration, and demonstrates how
   it enables dynamic routing in a virtual network.





<span class="grey">Touch, et al.                Informational                     [Page 11]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-12" id="page-12" name="page-12"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


   It is important to note that the <a href="rfc2003.html">RFC 2003</a> IPIP tunnels [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>] already
   provide a complete virtual network that can support static or dynamic
   routing.  The proposed solution of using IPIP tunnel with IPsec
   transport mode decouples IPsec processing from routing and
   forwarding.  IIPtran's use of IPsec is limited to securing the links
   of the VN (creating a VPN), because IPsec (rightly) lacks internal
   support for routing and forwarding.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.3.%20%20Solving%20Problem%202%3A%20Source%20Address%20Selection"></a><a class="selflink" href="#section-3.3" name="section-3.3">3.3</a>.  Solving Problem 2: Source Address Selection</span>

   <a href="#section-2.4">Section 2.4</a> gave an overview of IP source address selection and its
   dependence on interfaces and routes.

   Using <a href="rfc2003.html">RFC 2003</a> IPIP tunnel devices [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>] for VN links, instead of IPsec
   tunnel mode SAs, allows existing multihoming solutions for source
   address selection [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>] to solve source address selection in this
   context as well.  As indicated in <a href="#section-2.4">Section 2.4</a>, according to [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>], the
   IP source address of an outbound packet is determined by the outbound
   interface, which is in turn determined by existing forwarding
   mechanism.  Because IPIP tunnels are full-fledged interfaces with
   associated routes (as in Section 3.2 of [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>]), the routes and address
   selection as specified in [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>] can also operate as desired in the
   context of VN links.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/4.%20%20Comparison"></a><a class="selflink" href="#section-4" name="section-4">4</a>.  Comparison</span>

   The previous sections described problems when IPsec tunnel mode
   provides VPN links, and proposed a solution.  This section introduces
   a number of proposed alternatives, and compares their effect on the
   IPsec architecture, routing, and policy enforcement, among others, to
   IIPtran.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.1.%20%20Other%20Proposed%20Solutions"></a><a class="selflink" href="#section-4.1" name="section-4.1">4.1</a>.  Other Proposed Solutions</span>

   This section gives a brief overview of a number of alternative
   proposals that aim at establishing support for dynamic routing for
   IPsec-secured VNs.  The following section then compares these
   proposals in detail.

   Although some of the alternatives also address the issues identified
   above, IIPtran alone also significantly simplifies and modularizes
   the IPsec architecture.









<span class="grey">Touch, et al.                Informational                     [Page 12]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-13" id="page-13" name="page-13"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/4.1.1.%20%20Alternative%201%3A%20IPsec%20with%20Interface%20SAs"></a><a class="selflink" href="#section-4.1.1" name="section-4.1.1">4.1.1</a>.  Alternative 1: IPsec with Interface SAs</span>

   In the first alternative, each IPsec tunnel mode SA is required to
   act as a full-fledged network interface.  This SA interface acts as
   the outbound interface of the virtual destination's forwarding table
   entry.  IPsec dynamically updates the SA interface configuration in
   response to SAD changes, e.g., caused by IKE negotiation.

   This approach supports dynamic routing and existing source address
   selection rules, but requires extensions to the IPsec architecture
   that define tunnel mode SA interfaces and their associated management
   procedures.

   It would necessitate recapitulating the definition of the entirety of
   <a href="rfc2003.html">RFC 2003</a> IPIP encapsulation [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>], including the association of tunnels
   with interfaces, inside IPsec.  This defeats the modular architecture
   of the Internet, and violates the specification of type 4 IP in IP
   packets as being uniquely defined by a single Internet standard (it
   is already standardized by [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>]).

   This solution also requires augmenting the IPsec specification to
   mandate an implementation detail, one that may be difficult to
   resolve with other IPsec designs, notably the BITS (bump-in-the-
   stack) alternative.  Although the current IPsec specification is
   ambiguous and allows this implementation, an implementation-
   independent design is preferable.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/4.1.2.%20%20Alternative%202%3A%20IPsec%20with%20Initial%20Forwarding%20Lookup"></a><a class="selflink" href="#section-4.1.2" name="section-4.1.2">4.1.2</a>.  Alternative 2: IPsec with Initial Forwarding Lookup</span>

   A second alternative is the addition of an extra forwarding lookup
   before IPsec tunnel mode processing.  This forwarding lookup will
   return a "virtual interface" identifier, which indicates how to route
   the packet [<a href="#ref-13" title='"Personal Communication"'>13</a>].  Due to a lack of concrete documentation of this
   alternative at this time, proposed for an update pending to <a href="rfc2401.html">RFC 2401</a>
   [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>], two variants are presumed possible:

   In the first scenario, the extra forwarding lookup indicates the
   outbound interface of the final encapsulated tunnel mode packet,
   i.e., usually a physical interface in the base network.  The tunnel
   mode SA lookup following the forwarding lookup will occur in the
   per-interface SAD associated with the respective virtual interface.

   In the second scenario, the extra forwarding lookup returns an
   outbound tunnel SA interface.  This solution seems to be equivalent
   to the one described above (<a href="#section-4.1.1">Section 4.1.1</a>), i.e., all tunnel mode SAs
   must be interfaces, and is not discussed separately below.





<span class="grey">Touch, et al.                Informational                     [Page 13]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-14" id="page-14" name="page-14"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/4.1.3.%20%20Alternative%203%3A%20IPsec%20with%20Integrated%20Forwarding"></a><a class="selflink" href="#section-4.1.3" name="section-4.1.3">4.1.3</a>.  Alternative 3: IPsec with Integrated Forwarding</span>

   In the third alternative, the routing protocols and forwarding
   mechanisms are modified to consult both the routing tables and SADs
   to make forwarding decision.  To prevent IPsec processing from
   interfering with routing, forwarding table lookup must precede SAD
   lookup.

   This approach supports dynamic routing, but requires changes to
   routing mechanisms such that SAD contents are included in the route
   exchanges.  It is unclear how transport-layer selectors would affect
   this approach.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.2.%20%20Discussion"></a><a class="selflink" href="#section-4.2" name="section-4.2">4.2</a>.  Discussion</span>

   This section compares the three different alternatives and IIPtran
   according to a number of evaluation criteria, such as support for VN
   forwarding, or impact on the IPsec architecture.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/4.2.1.%20%20VN%20Routing%20Support%20and%20Complexity"></a><a class="selflink" href="#section-4.2.1" name="section-4.2.1">4.2.1</a>.  VN Routing Support and Complexity</span>

   This section investigates whether the three alternatives and IIPtran
   support VN routing, especially dynamic routing based on existing IP
   routing protocols.

   Both IIPtran (IPIP tunnels + transport mode) and alternative 1 (per-
   SA interfaces) establish VN links as full-fledged devices that can be
   referred to in the routing table, as well as used for local
   communication by dynamic routing protocols.  They both support static
   and dynamic VN routing.

   However, because the current IPsec architecture does not require
   tunnel mode SAs to behave similarly to interfaces (some implementers
   chose alternative 1, but it is not mandated by the specification),
   alternative 1 requires extensions to the current IPsec architecture
   that define the exact behavior of tunnel mode SAs.  The proposed
   solution does not require any such changes to IPsec, and for tunnels
   <a href="rfc2003.html">RFC 2003</a> already specifies those requirements [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>].  Furthermore,
   addition of those requirements would be redundant and potentially
   conflict with <a href="rfc2003.html">RFC 2003</a> [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>].

   Alternative 3 supports dynamic VN routing, but requires modifying
   routing protocols and forwarding lookup mechanisms to act or
   synchronize based on SAD entries.  This requires substantial changes
   to routing software and forwarding mechanisms in all participating
   nodes to interface to the internals of IPsec; this would require
   revising a large number of current Internet standards.  It is also




<span class="grey">Touch, et al.                Informational                     [Page 14]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-15" id="page-15" name="page-15"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


   not clear how tunnel mode SAs that specify port selectors would
   operate under this scheme, since IP routing has no dependence on
   transport-layer fields.

   Alternative 2 does not support dynamic VN routing.  The additional
   forwarding lookup before IPsec processing is irrelevant, because
   IPsec tunnel mode SAs are not represented as interfaces, and thus
   invisible to IP routing protocols.

   Additionally, the forwarding lookup suggested for alternative 2 is
   not compatible with a weak ES model described in [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>], which requires
   both an outbound interface indicator as well as the IP address of the
   next-hop gateway.  For example, multiple tunnels can use the same
   outgoing interface and thus same SAD.  The forwarding lookup would
   return only the interface; lacking the next-hop gateway, the correct
   SAD entry cannot be determined.  Given the next-hop gateway would not
   help, because the SAD is not indexed by tunnel mode SA encapsulation
   destination IP address.

   Because alternative 2 fails to support VN routing, it will not be
   discussed in the remainder of this section.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/4.2.2.%20%20Impact%20on%20the%20IPsec%20Architecture"></a><a class="selflink" href="#section-4.2.2" name="section-4.2.2">4.2.2</a>.  Impact on the IPsec Architecture</span>

   IIPtran recognizes that encapsulation is already a property of
   interface processing, and thus relies on IPIP tunnel devices to
   handle the IPIP encapsulation for VN links.  Tunnel mode IPsec thus
   becomes unnecessary and can potentially be removed from the IPsec
   architecture, greatly simplifying the specification.

   Alternative 1 requires SAs to be represented as full-fledged
   interfaces, for the purpose of routing.  SAD changes must furthermore
   dynamically update the configuration of these SA interfaces.  The
   IPsec architecture thus needs extensions that define the operation of
   interfaces and their interactions with the forwarding table and
   routes.

   Additionally, <a href="rfc2401.html">RFC 2401</a> [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>] describes per-interface SADs as a
   component of IPsec.  When tunnel mode SAs themselves act as
   interfaces, the function of per-interface SADs needs clarification as
   follows:

   First, each tunnel interface SAD must contain exactly one IPsec
   tunnel mode SA.  Transport mode SAs are prohibited, because they
   would not result in IP encapsulation (the encapsulation header is
   part of the tunnel mode SA, a transport mode SA would not cause
   encapsulation), and thus lead to processing loops.  Multiple tunnel
   mode SAs are prohibited, because dynamic routing algorithms construct



<span class="grey">Touch, et al.                Informational                     [Page 15]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-16" id="page-16" name="page-16"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


   topology information based on per-interface communication.  Merging
   different virtual links (tunnels) into a single SA interface can
   cause routing events on one virtual link to apply incorrectly to
   other links sharing an SA interface.

   Second, only the SAD of physical interfaces may contain IPsec
   transport mode SAs; otherwise, the current issues with VN routing
   remain unsolved.

   In summary, these restrictions cause the SADs of SA interfaces to
   contain only tunnel mode SAs, and the SADs of regular interfaces to
   contain only transport mode SAs.  Thus, tunnel encapsulation
   essentially becomes a unique property of the interface, and not
   IPsec.

   IIPtran already recognizes this property.  Consequently, it uses IPIP
   tunnels directly, and combines them with transport mode processing.
   By eliminating the use of tunnel mode, it removes the need for
   additional constraints on the contents of per-interface SAs.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/4.2.3.%20%20Policy%20Enforcement%20and%20Selectors"></a><a class="selflink" href="#section-4.2.3" name="section-4.2.3">4.2.3</a>.  Policy Enforcement and Selectors</span>

   On receiving a packet, both IPsec tunnel mode and IIPtran decrypt
   and/or authenticate the packet with the same techniques.  IPsec
   tunnel mode decapsulates and decrypts the packet in a single step,
   followed by a policy check of the inner packet and its payload
   against the respective IPsec tunnel mode SA.  IIPtran uses IPsec
   transport mode to decrypt and verify the incoming packet, then passes
   the decrypted IPIP packet on to <a href="rfc2003.html">RFC 2003</a> IPIP processing [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>].  At
   that point, IIPtran can support selector checks on both the header
   and its payload using firewall mechanisms, similar to IPsec tunnel
   mode processing.

   The primary difference between the two is that IPsec tunnel mode does
   not require a separate processing step for validating packets; once
   IPsec accepts them during the policy check during decapsulation, they
   are accepted.  IIPtran requires additional processing on the
   decapsulated packets, to validate whether they conform to their
   respective IPsec policy.

   As noted in <a href="#section-5.2">Section 5.2</a> of the IPsec architecture document [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>], IPsec
   processing should retain information about what SAs matched a given
   packet, for subsequent IPsec or firewall processing.  To allow for
   complex accept policies, it should be possible to reconstruct the
   format of the original packet at the time it first entered a machine
   based on saved processing context at any time during inbound





<span class="grey">Touch, et al.                Informational                     [Page 16]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-17" id="page-17" name="page-17"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


   processing.  IIPtran accepts incoming VN packets only if they have
   arrived over a specific IPIP tunnel that was secured with IPsec
   transport mode, but as a separate step following IPIP decapsulation.

   Note that IPsec tunnel mode and IIPtran are interoperable [<a href="#ref-3" title='"Dynamic Internet overlay deployment and management using the X-Bone"'>3</a>].
   Experiments have verified this interoperability, notably because
   there are no differences in the resulting packets on the wire, given
   appropriate keys.

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/4.2.3.1.%20%20Selector%20Expressiveness"></a><a class="selflink" href="#section-4.2.3.1" name="section-4.2.3.1">4.2.3.1</a>.  Selector Expressiveness</span>

   When looking up an SA for a given packet, IPsec allows selectors to
   match on the contents of the IP header and transport headers.
   IIPtran using existing IPsec cannot support transport header matches,
   because SA lookup occurs before decapsulation.  A small extension to
   IPsec can address this issue in a modular way.

   <a href="rfc2401.html">RFC 2401</a> [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>] explicitly recognizes that the transport layer header
   may be nested several headers deep inside the packet, and allows a
   system to (quote) "chain through the packet headers checking the
   'Protocol' or 'Next Header' field until it encounters either one it
   recognizes as a transport protocol, or until it reaches one that
   isn't on its list of extension headers, or until it encounters an ESP
   header that renders the transport protocol opaque."

   With IIPtran, the SA lookup starts on the outer (tunnel) header, and
   selectors including port number information must thus traverse the
   inner IP header (and possibly other headers) before they can match on
   the transport headers.  IIPtran thus requires that IP be a known
   IPsec "extension header." This recognizes that with IPIP
   encapsulation, IP VNs use the base IP network as a link layer.
   Although this small extension to IPsec is not explicitly required, it
   is already implied.

   Recognizing IP as a valid transport layer over IP also allows
   selectors to match on the contents of the inner ("transport") IP
   header.  Thus, IPsec selectors under IIPtran can express the same set
   of policies as conventional IPsec tunnel mode.

   Note that in both cases, these policy enforcement rules violate
   layering by looking at information other than the outermost header.
   This is consistent with IPsec's current use of port-based selectors.
   The next section discusses that selectors may not be useful for
   virtual networks.







<span class="grey">Touch, et al.                Informational                     [Page 17]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-18" id="page-18" name="page-18"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/4.2.3.2.%20%20Role%20of%20Selectors%20for%20VPNs"></a><a class="selflink" href="#section-4.2.3.2" name="section-4.2.3.2">4.2.3.2</a>.  Role of Selectors for VPNs</span>

   For secure VN links established via IPsec tunnel mode SAs, the
   selectors for the inner (VN) source and destination IP addresses
   often need to be wildcarded to support dynamic routing in a VN.
   Thus, the limitation described in 4.2.3.1 (without the proposed
   extension) may not be important in a VN scenario.

   Consider a four-node VN with nodes A, B, C, and N (Figure 6).
   Consider the case where N is either a new node joining an existing
   VPN, or an existing node that had been disconnected and was just
   rediscovered via dynamic routing.

   In this example, A has IPsec tunnel mode SAs to B and C. If the
   selectors for the virtual source and destination IP addresses for
   those SAs are not wildcards, the SA needs to be dynamically modified
   to permit packets from N to pass over the tunnels to B and C. This
   becomes quickly impractical as VPN sizes grow.

                                        B
                                       /
                                      /
                                     /
                           N ------ A
                                     \
                                      \
                                       \
                                        C

                Figure 6: Topology of a Virtual Network

   Thus, IPsec selectors appear much less useful in a VPN scenario than
   expected.  A consequence might be that IIPtran - even without
   extensions to support the full expressiveness of tunnel mode SA
   selectors as described above - can still support the majority of VPN
   scenarios.

   One purpose of selectors matching on transport header content is
   policy routing.  Different SAs can apply to different applications,
   resulting in different apparent virtual topologies.  IIPtran supports
   policy routing in a more modular way, by having existing policy
   routing implementations forward traffic over multiple, parallel VNs.
   IIPtran supports arbitrary IP-based policy routing schemes, while
   policies are limited by the expressiveness of IPsec's selectors in
   the former case.






<span class="grey">Touch, et al.                Informational                     [Page 18]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-19" id="page-19" name="page-19"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/4.2.4.%20%20IKE%20Impact"></a><a class="selflink" href="#section-4.2.4" name="section-4.2.4">4.2.4</a>.  IKE Impact</span>

   The Internet Key Exchange (IKE) [<a href="#ref-9" title='"The Internet Key Exchange (IKE)"'>9</a>][10] is a protocol to negotiate
   IPsec keys between end systems dynamically and securely.  It is not a
   strictly required component of IPsec in the sense that two hosts can
   communicate using IPsec without having used IKE to negotiate keys
   (through manually keyed SAs, for example).  Despite its name, IKE
   also acts as a tunnel management protocol (when IPsec tunnel mode SAs
   are configured), and negotiates security policies between the peers.

   Alternatives 1 and 3 use existing IKE without changes.

   One possible approach to use IKE with IIPtran is to negotiate a
   tunnel mode SA, and then treat it as a transport mode SA against an
   IPIP tunnel when communicating with conventional peers.  For policies
   that do not specify selectors based on transport-layer information,
   this establishes interoperability.

   However, since IIPtran eliminates IPsec tunnel mode, it could also
   simplify IKE, by limiting it to its original purpose of key exchange.
   A new tunnel management protocol (e.g., ATMP [<a href="#ref-8" title='"Ascend Tunnel Management Protocol - ATMP"'>8</a>]) would set up IPIP
   tunnels, use an as of yet unspecified second protocol to negotiate
   security policy, and then use IKE to exchange keys for use with the
   policy.

   Current IKE operation would become a modular composition of separate
   protocols, similar to how IIPtran modularizes IPsec by combining
   existing Internet standards.  For example, a VPN link creation could
   follow these steps: (1) IKE negotiation in the base network to secure
   (2) a subsequent tunnel management exchange [<a href="#ref-8" title='"Ascend Tunnel Management Protocol - ATMP"'>8</a>] in the base network,
   followed by (3) IKE exchanges over the established tunnel to create a
   secure VPN link.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/5.%20%20Security%20Considerations"></a><a class="selflink" href="#section-5" name="section-5">5</a>.  Security Considerations</span>

   This document addresses security considerations throughout, as they
   are a primary concern of proposed uses of IPsec.

   The primary purpose of this document is to extend the use of IPsec to
   dynamically routed VPNs, which will extend the use of IPsec and, it
   is hoped, increase the security of VPN infrastructures using existing
   protocols.









<span class="grey">Touch, et al.                Informational                     [Page 19]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-20" id="page-20" name="page-20"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/6.%20%20Summary%20and%20Recommendations"></a><a class="selflink" href="#section-6" name="section-6">6</a>.  Summary and Recommendations</span>

   This document presents a mechanism consistent with the current use of
   IPsec which supports dynamic routing inside a virtual network that
   uses IPsec to secure its links.  It illustrates how current use of
   IPsec tunnel mode can fail to support dynamic VN routing (depending
   on the implementation), and compares IIPtran with several different
   alternatives.  It finds that IIPtran, a composite of a subset of
   IPsec (i.e., transport mode) together with existing standard IPIP
   encapsulation, results in an interoperable, standards-conforming
   equivalent that is both simpler and modular.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/7.%20%20Acknowledgments"></a><a class="selflink" href="#section-7" name="section-7">7</a>.  Acknowledgments</span>

   The authors would like to thank the members of the X-Bone and
   DynaBone projects at USC/ISI for their contributions to the ideas
   behind this document, notably (current) Greg Finn and (past) Amy
   Hughes, Steve Hotz and Anindo Banerjea.

   The authors would also like to thank Jun-ichiro (itojun) Hagino and
   the KAME project for bringing IKE implications of this proposal to
   our attention, as well as implementing the mechanisms in this
   document in the KAME IPv6/IPsec network stack.  Members of several
   IETF WGs (especially IPsec: Stephen Kent, PPVPN: Eric Vyncke, Paul
   Knight, various members of MobileIP) provided valuable input on the
   details of IPsec processing in earlier revisions of this document.

   Effort sponsored by the Defense Advanced Research Projects Agency
   (DARPA) and Air Force Research Laboratory, Air Force Materiel
   Command, USAF, under agreements number F30602-98-1-0200 entitled "X-
   Bone" and number F30602-01-2-0529 entitled "DynaBone".

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/8.%20%20References"></a><a class="selflink" href="#section-8" name="section-8">8</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/8.1.%20%20Normative%20References"></a><a class="selflink" href="#section-8.1" name="section-8.1">8.1</a>.  Normative References</span>

   [<a id="ref-1" name="ref-1">1</a>]   Kent, S. and R. Atkinson, "Security Architecture for the
         Internet Protocol", <a href="rfc2401.html">RFC 2401</a>, November 1998.

   [<a id="ref-2" name="ref-2">2</a>]   Perkins, C., "IP Encapsulation within IP", <a href="rfc2003.html">RFC 2003</a>, October
         1996.

   [<a id="ref-3" name="ref-3">3</a>]   Touch, J., "Dynamic Internet overlay deployment and management
         using the X-Bone", Computer Networks Vol. 36, No. 2-3, July
         2001.






<span class="grey">Touch, et al.                Informational                     [Page 20]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-21" id="page-21" name="page-21"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


   [<a id="ref-4" name="ref-4">4</a>]   Touch, J., Wang, Y., Eggert, L. and G. Finn, "A Virtual
         Internet Architecture", ISI Technical Report ISI-TR-570,
         Workshop on Future Directions in Network Architecture (FDNA)
         2003, March 2003.

   [<a id="ref-5" name="ref-5">5</a>]   Kent, S. and R. Atkinson, "IP Authentication Header", <a href="rfc2402.html">RFC 2402</a>,
         November 1998.

   [<a id="ref-6" name="ref-6">6</a>]   Kent, S. and R. Atkinson, "IP Encapsulating Security Payload
         (ESP)", <a href="rfc2406.html">RFC 2406</a>, November 1998.

   [<a id="ref-7" name="ref-7">7</a>]   Braden, R., "Requirements for Internet Hosts - Communication
         Layers", STD 3, <a href="rfc1122.html">RFC 1122</a>, October 1989.

   [<a id="ref-8" name="ref-8">8</a>]   Hamzeh, K., "Ascend Tunnel Management Protocol - ATMP", <a href="rfc2107.html">RFC</a>
         <a href="rfc2107.html">2107</a>, February 1997.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/8.2.%20%20Informative%20References"></a><a class="selflink" href="#section-8.2" name="section-8.2">8.2</a>.  Informative References</span>

   [<a id="ref-9" name="ref-9">9</a>]   Harkins, D. and D. Carrel, "The Internet Key Exchange (IKE)",
         <a href="rfc2409.html">RFC 2409</a>, November 1998.

   [<a id="ref-10" name="ref-10">10</a>]  Kaufman, C., <a href="https://www.google.com/search?sitesearch=tools.ietf.org%2Fhtml%2F&amp;q=inurl:draft-+%22Internet+Key+Exchange+%28IKEv2%29+Protocol%22" style="text-decoration: none">"Internet Key Exchange (IKEv2) Protocol"</a>, Work in
         Progress, January 2004.

   [<a id="ref-11" name="ref-11">11</a>]  Kent, S., <a href="https://www.google.com/search?sitesearch=tools.ietf.org%2Fhtml%2F&amp;q=inurl:draft-+%22IP+Authentication+Header%22" style="text-decoration: none">"IP Authentication Header"</a>, Work in Progress,
         February 2004.

   [<a id="ref-12" name="ref-12">12</a>]  Kent, S., "IP Encapsulating Security Payload (ESP)", Work in
         progress, February 2004.

   [<a id="ref-13" name="ref-13">13</a>]  Kent, S., "Personal Communication", November 2002.

   [<a id="ref-14" name="ref-14">14</a>]  Mogul, J. and S. Deering, "Path MTU discovery", <a href="rfc1191.html">RFC 1191</a>,
         November 1990.

   [<a id="ref-15" name="ref-15">15</a>]  Lahey, K., "TCP Problems with Path MTU Discovery", <a href="rfc2923.html">RFC 2923</a>,
         September 2000.













<span class="grey">Touch, et al.                Informational                     [Page 21]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-22" id="page-22" name="page-22"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/Appendix%20A.%20%20Encapsulation%2FDecapsulation%20Issues"></a><a class="selflink" href="#appendix-A" name="appendix-A">Appendix A</a>.  Encapsulation/Decapsulation Issues</span>

   There are inconsistencies between the IPIP encapsulation rules
   specified by IPsec [<a href="#ref-1" title='"Security Architecture for the Internet Protocol"'>1</a>] and those specified by MobileIP [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>].  The
   latter specification is standards track, and the IP protocol number
   of 4 (payload of an IP packet of type 4) is uniquely specified by <a href="rfc2003.html">RFC</a>
   <a href="rfc2003.html">2003</a> according to IANA [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>].  The use of IPIP inside an IPsec
   transport packet can be confused with IPsec tunnel mode, because
   IPsec does not specify any limits on the types of IP packets that
   transport mode can secure.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/A.1.%20%20Encapsulation%20Issues"></a><a class="selflink" href="#appendix-A.1" name="appendix-A.1">A.1</a>.  Encapsulation Issues</span>

   When an IP packet is encapsulated as payload inside another IP
   packet, some of the outer header fields can be newly written (and the
   inner header determines some others [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>].) Among these fields is the
   IP DF (do not fragment) flag.  When the inner packet DF flag is
   clear, the outer packet may copy it or set it; however, when the
   inner DF flag is set, the outer header must copy it [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>].  IPsec
   defines conflicting rules, where that flag and other similar fields
   (TOS, etc.) may be copied, cleared, or set as specified by an SA.

   The IPsec specification indicates that such fields must be
   controlled, to achieve security.  Otherwise, such fields could
   provide a covert channel between the inner packet header and outer
   packet header.  However, <a href="rfc2003.html">RFC 2003</a> [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>] requires that the outer fields
   not be cleared when the inner ones are set, to prevent MTU discovery
   "black holes" [<a href="#ref-14" title='"Path MTU discovery"'>14</a>][15].

   To avoid a conflict between these rules, and to avoid security
   weaknesses associated with solely copying the fields, it is
   recommended that IPsec IPIP encapsulation not permit the clearing of
   the outer DF flag.  When the SA requires clearing the DF flag, and
   the inner packet DF is set, it is proposed that IPsec drop that
   packet, rather than violate <a href="rfc2003.html">RFC 2003</a> processing rules [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>].  Similar
   rules are being developed for TOS and other similar IP header fields,
   to be included in an update of <a href="rfc2003.html">RFC 2003</a> [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>].

   Another approach to closing the covert channel is always to set the
   DF flag in the outer header (whether or not it is set in the inner
   header).  Setting the DF flag allows PMTU discovery to operate
   normally.  The details of this approach are discussed in [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>].









<span class="grey">Touch, et al.                Informational                     [Page 22]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-23" id="page-23" name="page-23"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/A.2.%20%20Decapsulation%20Issues"></a><a class="selflink" href="#appendix-A.2" name="appendix-A.2">A.2</a>.  Decapsulation Issues</span>

   Given identical keys, a packet created by IPIP tunnel encapsulation
   combined with IPsec transport mode and an IPsec tunnel mode packet
   look identical on the wire.  Thus, when an IPsec'ed packet arrives
   that contains an IPIP inner packet, it is not possible to distinguish
   whether the packet was created using IPsec tunnel mode or IPsec
   transport mode of an IPIP encapsulated packet.  In both cases, the
   protocol field of the outer header is IPsec (AH or ESP), and the
   "next header" field for the inner data is 4 (IP).  IPsec requires the
   SA matching a received packet to indicate whether to apply tunnel
   mode or transport mode.

   Incoming packet processing must check the SAD before determining
   whether to decapsulate IPsec packets with inner payload of protocol
   type 4.  If the SAD indicates that a tunnel mode association applies,
   IPsec must decapsulate the packet.  If the SAD indicates that a
   transport mode association applies, IPsec must not decapsulate the
   packet.  This requires that the SAD indicate one of these two
   options; wildcard SAD entries ("ANY", or "TUNNEL or TRANSPORT")
   cannot be supported.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/A.3.%20%20Appendix%20Summary"></a><a class="selflink" href="#appendix-A.3" name="appendix-A.3">A.3</a>.  <a href="#appendix-S">Appendix S</a>ummary</span>

   IPsec's use of IPIP encapsulation conflicts with the IPIP standard
   [<a href="#ref-2" title='"IP Encapsulation within IP"'>2</a>].  This issue is already being resolved in an update to <a href="rfc2003.html">RFC 2003</a>,
   instead of specifying a non-standard conforming variant of IPIP
   encapsulation inside IPsec.























<span class="grey">Touch, et al.                Informational                     [Page 23]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-24" id="page-24" name="page-24"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


Authors' Addresses

   Joe Touch
   USC Information Sciences Institute
   4676 Admiralty Way
   Marina del Rey, CA  90292
   US

   Phone: +1 310 822 1511
   Fax:   +1 310 823 6714
   EMail: touch@isi.edu
   URI:   <a href="http://www.isi.edu/touch">http://www.isi.edu/touch</a>


   Lars Eggert
   NEC Network Laboratories
   Kurfuersten-Anlage 36
   Heidelberg  69115
   DE

   Phone: +49 6221 90511 43
   Fax:   +49 6221 90511 55
   EMail: lars.eggert@netlab.nec.de
   URI:   <a href="http://www.netlab.nec.de/">http://www.netlab.nec.de/</a>


   Yu-Shun Wang
   USC Information Sciences Institute
   4676 Admiralty Way
   Marina del Rey, CA  90292
   US

   Phone: +1 310 822 1511
   Fax:   +1 310 823 6714
   EMail: yushunwa@isi.edu
   URI:   <a href="http://www.isi.edu/yushunwa">http://www.isi.edu/yushunwa</a>















<span class="grey">Touch, et al.                Informational                     [Page 24]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-25" id="page-25" name="page-25"> </a>
<span class="grey"><a href="rfc3884.html">RFC 3884</a>        IPsec Transport Mode for Dynamic Routing  September 2004</span>


Full Copyright Statement

   Copyright (C) The Internet Society (2004).  This document is subject
   to the rights, licenses and restrictions contained in <a href="https://tools.ietf.org/html/bcp78">BCP 78</a>, and
   except as set forth therein, the authors retain all their rights.

   This document and the information contained herein are provided on an
   "AS IS" basis and THE CONTRIBUTOR, THE ORGANIZATION HE/SHE REPRESENTS
   OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY AND THE INTERNET
   ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES, EXPRESS OR IMPLIED,
   INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE
   INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED
   WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.

Intellectual Property

   The IETF takes no position regarding the validity or scope of any
   Intellectual Property Rights or other rights that might be claimed to
   pertain to the implementation or use of the technology described in
   this document or the extent to which any license under such rights
   might or might not be available; nor does it represent that it has
   made any independent effort to identify any such rights.  Information
   on the procedures with respect to rights in RFC documents can be
   found in <a href="https://tools.ietf.org/html/bcp78">BCP 78</a> and <a href="https://tools.ietf.org/html/bcp79">BCP 79</a>.

   Copies of IPR disclosures made to the IETF Secretariat and any
   assurances of licenses to be made available, or the result of an
   attempt made to obtain a general license or permission for the use of
   such proprietary rights by implementers or users of this
   specification can be obtained from the IETF on-line IPR repository at
   <a href="http://www.ietf.org/ipr">http://www.ietf.org/ipr</a>.

   The IETF invites any interested party to bring to its attention any
   copyrights, patents or patent applications, or other proprietary
   rights that may cover technology that may be required to implement
   this standard.  Please address the information to the IETF at ietf-
   ipr@ietf.org.

Acknowledgement

   Funding for the RFC Editor function is currently provided by the
   Internet Society.









Touch, et al.                Informational                     [Page 25]

</pre><br/>
    <span class="noprint"><small><small>Html markup produced by rfcmarkup 1.126, available from
      <a href="https://tools.ietf.org/tools/rfcmarkup/">https://tools.ietf.org/tools/rfcmarkup/</a>
    </small></small></span>
  </div>




</body><!-- Mirrored from tools.ietf.org/html/rfc3884 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Mar 2018 23:18:45 GMT --></html>