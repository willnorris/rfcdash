<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><!-- Mirrored from tools.ietf.org/html/rfc6857 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Mar 2018 23:18:26 GMT --><!-- Added by HTTrack --><head><meta content="text/html;charset=utf-8" http-equiv="content-type"/><!-- /Added by HTTrack -->

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <meta content="index,follow" name="robots"/>
    <meta content="rfcmarkup version 1.126" name="creator"/>
    <link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/>
<meta content="urn:ietf:rfc:6857" name="DC.Identifier"/>
<meta content="The Email Address Internationalization (SMTPUTF8) extension to SMTP
allows Unicode characters encoded in UTF-8 and outside the ASCII
repertoire in mail header fields. Upgraded POP and IMAP servers
support internationalized messages. If a POP or IMAP client does not
support Email Address Internationalization, a POP or IMAP server
cannot deliver internationalized messages to the client and cannot
remove the message. To avoid that situation, this document describes a
mechanism for converting internationalized messages into the
traditional message format. As part of the conversion process, message
elements that require internationalized treatment are recoded or
removed, and receivers are able to recognize that they received
messages containing such elements, even if they cannot process the
internationalized elements." name="DC.Description.Abstract"/>
<meta content="Kazunori Fujiwara &lt;fujiwara@jprs.co.jp&gt;" name="DC.Creator"/>
<meta content="March, 2013" name="DC.Date.Issued"/>
<meta content="Post-Delivery Message Downgrading for Internationalized Email Messages" name="DC.Title"/>

    <link href="https://tools.ietf.org/images/rfc.png" rel="icon" type="image/png"/>
    <link href="https://tools.ietf.org/images/rfc.png" rel="shortcut icon" type="image/png"/>
    <title>RFC 6857 - Post-Delivery Message Downgrading for Internationalized Email Messages</title>
    
    
    <style type="text/css">
	@media only screen 
	  and (min-width: 992px)
	  and (max-width: 1199px) {
	    body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 768px)
	  and (max-width: 991px) {
            body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 480px)
	  and (max-width: 767px) {
            body { font-size: 11pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (max-width: 479px) {
            body { font-size: 8pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-device-width : 375px) 
	  and (max-device-width : 667px) {
            body { font-size: 9.5pt; }
            div.content { width: 96ex; margin: 0 1px; }
        }
	@media only screen 
	  and (min-device-width: 1200px) {
            body { font-size: 10pt; margin: 0 4em; }
            div.content { width: 96ex; margin: 0; }
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        a.selflink {
          color: black;
          text-decoration: none;
        }
        @media print {
            body {
                font-family: monospace;
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 1em;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>                   <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>                     <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>             <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>              <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td>      <td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td>         <td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard (old designation):</td> <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Internet Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>                  <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>                  <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
  <div class="content">
   <div style="height: 13px;">
      <div class="pre noprint docinfo bgblue" onclick="showElem('legend');" onmouseout="hideElem('legend')" onmouseover="this.style.cursor='pointer';" style="height: 6px; position: absolute;" title="Click for colour legend.">                                                                        </div>
      <div class="docinfo noprint pre legend" id="legend" onmouseout="hideElem('legend');" onmouseover="showElem('legend');" style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; ">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="index.html" title="Document search and retrieval page">Docs</a>] [<a href="https://tools.ietf.org/rfc/rfc6857.txt" title="Plaintext version of this document">txt</a>|<a href="https://tools.ietf.org/pdf/rfc6857" title="PDF version of this document">pdf</a>] [<a href="https://tools.ietf.org/html/draft-ietf-eai-popimap-downgrade" title="draft-ietf-eai-popimap-downgrade">draft-ietf-eai-...</a>] [<a href="https://datatracker.ietf.org/doc/rfc6857" title="IESG Datatracker information for this document">Tracker</a>] [<a href="https://tools.ietf.org/rfcdiff?difftype=--hwdiff&amp;url2=rfc6857" title="Inline diff (wdiff)">Diff1</a>] [<a href="https://tools.ietf.org/rfcdiff?url2=rfc6857" title="Side-by-side diff">Diff2</a>] [<a href="https://www.rfc-editor.org/errata_search.php?rfc=6857">Errata</a>]</span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<span class="pre noprint docinfo">                                                       PROPOSED STANDARD</span><br/>
<span class="pre noprint docinfo">                                                            <span style="color: #C00;">Errata Exist</span></span><br/>
<pre>Internet Engineering Task Force (IETF)                       K. Fujiwara
Request for Comments: 6857                                          JPRS
Category: Standards Track                                     March 2013
ISSN: 2070-1721


 <span class="h1">Post-Delivery Message Downgrading for Internationalized Email Messages</span>

Abstract

   The Email Address Internationalization (SMTPUTF8) extension to SMTP
   allows Unicode characters encoded in UTF-8 and outside the ASCII
   repertoire in mail header fields.  Upgraded POP and IMAP servers
   support internationalized messages.  If a POP or IMAP client does not
   support Email Address Internationalization, a POP or IMAP server
   cannot deliver internationalized messages to the client and cannot
   remove the message.  To avoid that situation, this document describes
   a mechanism for converting internationalized messages into the
   traditional message format.  As part of the conversion process,
   message elements that require internationalized treatment are recoded
   or removed, and receivers are able to recognize that they received
   messages containing such elements, even if they cannot process the
   internationalized elements.

Status of This Memo

   This is an Internet Standards Track document.

   This document is a product of the Internet Engineering Task Force
   (IETF).  It represents the consensus of the IETF community.  It has
   received public review and has been approved for publication by the
   Internet Engineering Steering Group (IESG).  Further information on
   Internet Standards is available in <a href="rfc5741.html#section-2">Section 2 of RFC 5741</a>.

   Information about the current status of this document, any errata,
   and how to provide feedback on it may be obtained at
   <a href="http://www.rfc-editor.org/info/rfc6857">http://www.rfc-editor.org/info/rfc6857</a>.














<span class="grey">Fujiwara                     Standards Track                    [Page 1]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-2" id="page-2" name="page-2"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


Copyright Notice

   Copyright (c) 2013 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="https://tools.ietf.org/html/bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.





































<span class="grey">Fujiwara                     Standards Track                    [Page 2]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-3" id="page-3" name="page-3"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


Table of Contents

   <a href="#section-1">1</a>.  Introduction . . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-4">4</a>
     <a href="#section-1.1">1.1</a>.  Problem Statement  . . . . . . . . . . . . . . . . . . . .  <a href="#page-4">4</a>
     <a href="#section-1.2">1.2</a>.  Possible Solutions . . . . . . . . . . . . . . . . . . . .  <a href="#page-4">4</a>
     <a href="#section-1.3">1.3</a>.  Approach Taken in This Specification . . . . . . . . . . .  <a href="#page-5">5</a>
   <a href="#section-2">2</a>.  Terminology  . . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-6">6</a>
   <a href="#section-3">3</a>.  Email Message Header Field Downgrading . . . . . . . . . . . .  <a href="#page-7">7</a>
     <a href="#section-3.1">3.1</a>.  Downgrading Method for Each ABNF Element . . . . . . . . .  <a href="#page-7">7</a>
       <a href="#section-3.1.1">3.1.1</a>.  Unstructured Downgrading . . . . . . . . . . . . . . .  <a href="#page-7">7</a>
       <a href="#section-3.1.2">3.1.2</a>.  Word Downgrading . . . . . . . . . . . . . . . . . . .  <a href="#page-7">7</a>
       <a href="#section-3.1.3">3.1.3</a>.  Comment Downgrading  . . . . . . . . . . . . . . . . .  <a href="#page-7">7</a>
       <a href="#section-3.1.4">3.1.4</a>.  MIME-Value Downgrading . . . . . . . . . . . . . . . .  <a href="#page-7">7</a>
       <a href="#section-3.1.5">3.1.5</a>.  Display-Name Downgrading . . . . . . . . . . . . . . .  <a href="#page-7">7</a>
       <a href="#section-3.1.6">3.1.6</a>.  Domain Downgrading . . . . . . . . . . . . . . . . . .  <a href="#page-8">8</a>
       <a href="#section-3.1.7">3.1.7</a>.  Group Downgrading  . . . . . . . . . . . . . . . . . .  <a href="#page-8">8</a>
       <a href="#section-3.1.8">3.1.8</a>.  Mailbox Downgrading  . . . . . . . . . . . . . . . . .  <a href="#page-8">8</a>
       <a href="#section-3.1.9">3.1.9</a>.  Type-Addr Downgrading  . . . . . . . . . . . . . . . .  <a href="#page-9">9</a>
       <a href="#section-3.1.10">3.1.10</a>. Encapsulation: A Last Resort . . . . . . . . . . . . .  <a href="#page-9">9</a>
     <a href="#section-3.2">3.2</a>.  Downgrading Method for Each Header Field . . . . . . . . . <a href="#page-10">10</a>
       3.2.1.  Address Header Fields That Contain &lt;address&gt;
               Elements . . . . . . . . . . . . . . . . . . . . . . . <a href="#page-10">10</a>
       <a href="#section-3.2.2">3.2.2</a>.  Non-ASCII Strings in &lt;comment&gt; Elements  . . . . . . . <a href="#page-11">11</a>
       <a href="#section-3.2.3">3.2.3</a>.  Message-ID Header Fields . . . . . . . . . . . . . . . <a href="#page-11">11</a>
       <a href="#section-3.2.4">3.2.4</a>.  Received Header Field  . . . . . . . . . . . . . . . . <a href="#page-11">11</a>
       <a href="#section-3.2.5">3.2.5</a>.  MIME Content Header Fields . . . . . . . . . . . . . . <a href="#page-12">12</a>
       <a href="#section-3.2.6">3.2.6</a>.  Non-ASCII Characters in &lt;unstructured&gt; Elements  . . . <a href="#page-12">12</a>
       <a href="#section-3.2.7">3.2.7</a>.  Non-ASCII Characters in &lt;phrase&gt; Elements  . . . . . . <a href="#page-12">12</a>
       <a href="#section-3.2.8">3.2.8</a>.  Other Header Fields  . . . . . . . . . . . . . . . . . <a href="#page-12">12</a>
   <a href="#section-4">4</a>.  MIME Body Parts and Delivery Status Notifications  . . . . . . <a href="#page-12">12</a>
     <a href="#section-4.1">4.1</a>.  MIME Body Part Header Field Downgrading  . . . . . . . . . <a href="#page-13">13</a>
     <a href="#section-4.2">4.2</a>.  Delivery Status Notification Downgrading . . . . . . . . . <a href="#page-13">13</a>
   <a href="#section-5">5</a>.  Security Considerations  . . . . . . . . . . . . . . . . . . . <a href="#page-13">13</a>
   <a href="#section-6">6</a>.  Implementation Note: Encoded-Word Encoding . . . . . . . . . . <a href="#page-14">14</a>
   <a href="#section-7">7</a>.  IANA Considerations  . . . . . . . . . . . . . . . . . . . . . <a href="#page-15">15</a>
     <a href="#section-7.1">7.1</a>.  Obsolescence of Existing Downgraded-* Header Fields  . . . <a href="#page-15">15</a>
     <a href="#section-7.2">7.2</a>.  Registration of New Downgraded-* Header Fields . . . . . . <a href="#page-15">15</a>
   <a href="#section-8">8</a>.  Acknowledgements . . . . . . . . . . . . . . . . . . . . . . . <a href="#page-16">16</a>
   <a href="#section-9">9</a>.  References . . . . . . . . . . . . . . . . . . . . . . . . . . <a href="#page-16">16</a>
     <a href="#section-9.1">9.1</a>.  Normative References . . . . . . . . . . . . . . . . . . . <a href="#page-16">16</a>
     <a href="#section-9.2">9.2</a>.  Informative References . . . . . . . . . . . . . . . . . . <a href="#page-18">18</a>
   <a href="#appendix-A">Appendix A</a>.  Downgrading Example . . . . . . . . . . . . . . . . . <a href="#page-19">19</a>









<span class="grey">Fujiwara                     Standards Track                    [Page 3]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-4" id="page-4" name="page-4"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/1.%20%20Introduction"></a><a class="selflink" href="#section-1" name="section-1">1</a>.  Introduction</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/1.1.%20%20Problem%20Statement"></a><a class="selflink" href="#section-1.1" name="section-1.1">1.1</a>.  Problem Statement</span>

   Traditional (legacy) mail systems, which are defined by the Internet
   Message Format [<a href="rfc5322.html" title='"Internet Message Format"'>RFC5322</a>] and other specifications, allow only ASCII
   characters in mail header field values.  The SMTPUTF8 extension
   [<a href="rfc6530.html" title='"Overview and Framework for Internationalized Email"'>RFC6530</a>] [<a href="rfc6531.html" title='"SMTP Extension for Internationalized Email"'>RFC6531</a>] [<a href="rfc6532.html" title='"Internationalized Email Headers"'>RFC6532</a>] allows Unicode characters encoded in
   UTF-8 [<a href="rfc3629.html" title='"UTF-8, a transformation format of ISO 10646"'>RFC3629</a>] in these mail header fields.  "Raw non-ASCII strings"
   refers to strings of those characters in which at least one of them
   is not part of the ASCII repertoire.

   If a header field contains non-ASCII strings, a POP or IMAP server
   cannot deliver internationalized messages to legacy clients that do
   not send UTF8 commands or have UTF8 capability.  Also, because they
   have no obvious or standardized way to explain what is going on to
   clients, a POP or IMAP server cannot even safely discard the message.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/1.2.%20%20Possible%20Solutions"></a><a class="selflink" href="#section-1.2" name="section-1.2">1.2</a>.  Possible Solutions</span>

   There are four plausible approaches to the problem.  The preferred
   approach depends on the particular circumstances and relationship
   among the delivery SMTP server, the mail store, the POP or IMAP
   server, and the users and their Mail User Agent (MUA) clients.  The
   four approaches are as follows:

   1.  If the delivery Mail Transport Agent (MTA) has sufficient
       knowledge about the POP or IMAP server and the clients being
       used, the message may be rejected as undeliverable.

   2.  A new, surrogate, message may be created by downgrading the
       original one in the POP or IMAP server in a way that preserves
       maximum information at the expense of some complexity and that
       does not create security or operational problems in the mail
       system.  These surrogate messages are referred to as "downgraded"
       in this specification and as "surrogate messages" elsewhere.

   3.  Some intermediate downgrading may be applied that balances
       additional information loss against lower complexity and greater
       ease of implementation.

   4.  The POP or IMAP server may fabricate a message that is intended
       to notify the client that an internationalized message is waiting
       but cannot be delivered until an upgraded client is available.







<span class="grey">Fujiwara                     Standards Track                    [Page 4]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-5" id="page-5" name="page-5"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/1.3.%20%20Approach%20Taken%20in%20This%20Specification"></a><a class="selflink" href="#section-1.3" name="section-1.3">1.3</a>.  Approach Taken in This Specification</span>

   This specification describes the second of these options.  It is
   worth noting that, at least in the general case, none of these
   options preserves sufficient information to guarantee that it is
   possible to reply to an incoming message without loss of information,
   so the choice may be considered one of the available "least bad"
   options.  While this document specifies a well-designed mechanism, it
   is only an interim solution while clients are being upgraded
   [<a href="rfc6855.html" title='"IMAP Support for UTF-8"'>RFC6855</a>] [<a href="rfc6856.html" title='"Post Office Protocol Version 3 (POP3) Support for UTF-8"'>RFC6856</a>].

   This message downgrading mechanism converts mail header fields to an
   all-ASCII representation.  The POP or IMAP server can use the
   downgrading mechanism and then deliver the internationalized message
   in a traditional form, which allows receivers to know whether a
   message is internationalized or unknown or broken.

   The Internationalized Mail Header specification [<a href="rfc6532.html" title='"Internationalized Email Headers"'>RFC6532</a>] allows
   UTF-8 characters (see <a href="#section-2">Section 2</a>) to be used in mail header fields and
   MIME header fields.  The Internationalized Mail Transport
   specification [<a href="rfc6531.html" title='"SMTP Extension for Internationalized Email"'>RFC6531</a>] allows UTF-8 characters to be used in some
   trace header fields.  The message downgrading mechanism specified
   here describes the method by which internationalized messages
   [<a href="rfc6530.html" title='"Overview and Framework for Internationalized Email"'>RFC6530</a>] [<a href="rfc6532.html" title='"Internationalized Email Headers"'>RFC6532</a>] are converted to traditional email messages
   [<a href="rfc5322.html" title='"Internet Message Format"'>RFC5322</a>].

   This document provides a precise definition of the minimum-
   information-loss message downgrading process.

   Downgrading consists of the following two parts:

   o  Email header field downgrading

   o  MIME header field downgrading

   Email header field downgrading is described in <a href="#section-3">Section 3</a>.  It
   generates ASCII-only header fields.

   Header fields starting with Downgraded- are introduced in
   <a href="#section-3.1.10">Section 3.1.10</a>.  They preserve the information that appeared in the
   original header fields.

   The definition of MIME header fields in internationalized messages is
   described in <a href="rfc6532.html">RFC 6532</a>.  A delivery status notification may contain
   non-ASCII addresses.  MIME header field downgrading is described in
   <a href="#section-4.1">Section 4.1</a>.  Delivery status notification downgrading is described
   in <a href="#section-4.2">Section 4.2</a>.  It generates ASCII-only MIME header fields.




<span class="grey">Fujiwara                     Standards Track                    [Page 5]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-6" id="page-6" name="page-6"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


   Displaying downgraded messages that originally contained
   internationalized header fields is out of scope of this document.  A
   POP or IMAP client that does not support UTF8 extensions as defined
   for POP3 "UTF8 command" and IMAP "ENABLE UTF8=ACCEPT command" does
   not recognize the internationalized message format [<a href="rfc6532.html" title='"Internationalized Email Headers"'>RFC6532</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/2.%20%20Terminology"></a><a class="selflink" href="#section-2" name="section-2">2</a>.  Terminology</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <a href="rfc2119.html">RFC 2119</a> [<a href="rfc2119.html" title='"Key words for use in RFCs to Indicate Requirement Levels"'>RFC2119</a>].

   Many of the specialized terms used in this specification are defined
   in other documents.  They include "Overview and Framework for
   Internationalized Email" [<a href="rfc6530.html" title='"Overview and Framework for Internationalized Email"'>RFC6530</a>], the Internet Message Format
   specification [<a href="rfc5322.html" title='"Internet Message Format"'>RFC5322</a>], and some of the basic MIME documents
   [<a href="rfc2045.html" title='"Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies"'>RFC2045</a>] [<a href="rfc2183.html" title='"Communicating Presentation Information in Internet Messages: The Content-Disposition Header Field"'>RFC2183</a>].  This specification makes extensive use of the
   MIME Message Header Extensions [<a href="rfc2047.html" title='"MIME (Multipurpose Internet Mail Extensions) Part Three: Message Header Extensions for Non-ASCII Text"'>RFC2047</a>] and extended MIME parameter
   encodings [<a href="rfc2231.html" title='"MIME Parameter Value and Encoded Word Extensions: Character Sets, Languages, and Continuations"'>RFC2231</a>].  For convenience, both are described as
   "encoded-words" or "encoded-word encoding".  All of the encoded-words
   generated according to this specification use UTF-8 as their charset.

   The terms "U-label", "A-label", and "IDNA" are used as defined in the
   IDNA Definitions document [<a href="rfc5890.html" title='"Internationalized Domain Names for Applications (IDNA): Definitions and Document Framework"'>RFC5890</a>].  The terms "ASCII address",
   "non-ASCII address", "SMTPUTF8", "message", and "internationalized
   message" are used as defined <a href="rfc6530.html">RFC 6530</a>.  The term "non-ASCII string"
   is used with the definition provided in the Internationalized Email
   Headers document [<a href="rfc6532.html" title='"Internationalized Email Headers"'>RFC6532</a>].  The term "UTF-8 character" is used
   informally in this document to denote a Unicode character, encoded in
   UTF-8, outside the ASCII repertoire.  Such characters are more
   formally described using the ABNF element &lt;UTF8-non-ascii&gt;, defined
   in <a href="rfc6532.html">RFC 6532</a>.

   This document refers to the Augmented Backus-Naur Form (ABNF)
   [<a href="rfc5234.html" title='"Augmented BNF for Syntax Specifications: ABNF"'>RFC5234</a>] elements that appear in <a href="rfc5322.html">RFC 5322</a> and <a href="rfc2045.html">RFC 2045</a>.  <a href="rfc5322.html">RFC 5322</a>
   describes the ABNF elements &lt;CFWS&gt;, &lt;comment&gt;, &lt;display-name&gt;,
   &lt;group&gt;, &lt;id-left&gt;, &lt;id-right&gt;, &lt;mailbox&gt;, &lt;quoted-string&gt;,
   &lt;unstructured&gt;, and &lt;word&gt;.  <a href="rfc2045.html">RFC 2045</a> describes the ABNF element
   &lt;value&gt;.  <a href="#section-3.3">Section 3.3</a> of the Internationalized Mail Transport
   specification [<a href="rfc6531.html" title='"SMTP Extension for Internationalized Email"'>RFC6531</a>] and <a href="#section-3.2">Section 3.2</a> of the Internationalized
   Email Headers document [<a href="rfc6532.html" title='"Internationalized Email Headers"'>RFC6532</a>] updated &lt;domain&gt; to allow non-ASCII
   characters.

   Some additional terms are defined locally in-line below.







<span class="grey">Fujiwara                     Standards Track                    [Page 6]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-7" id="page-7" name="page-7"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/3.%20%20Email%20Message%20Header%20Field%20Downgrading"></a><a class="selflink" href="#section-3" name="section-3">3</a>.  Email Message Header Field Downgrading</span>

   This section defines the method for converting each header field that
   may contain non-ASCII strings into ASCII.  <a href="#section-3.1">Section 3.1</a> describes the
   methods for rewriting each ABNF element.  <a href="#section-3.2">Section 3.2</a> describes the
   methods for rewriting each header field.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.1.%20%20Downgrading%20Method%20for%20Each%20ABNF%20Element"></a><a class="selflink" href="#section-3.1" name="section-3.1">3.1</a>.  Downgrading Method for Each ABNF Element</span>

   Header field downgrading is defined below for each ABNF element.
   Conversion of the header field terminates when no characters other
   than those in the ASCII repertoire remain in the header field.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.1.1.%20%20Unstructured%20Downgrading"></a><a class="selflink" href="#section-3.1.1" name="section-3.1.1">3.1.1</a>.  Unstructured Downgrading</span>

   If the header field has an &lt;unstructured&gt; field that contains
   non-ASCII strings, apply encoded-word encoding.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.1.2.%20%20Word%20Downgrading"></a><a class="selflink" href="#section-3.1.2" name="section-3.1.2">3.1.2</a>.  Word Downgrading</span>

   If the header field has any &lt;word&gt; fields that contain non-ASCII
   strings, apply encoded-word encoding.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.1.3.%20%20Comment%20Downgrading"></a><a class="selflink" href="#section-3.1.3" name="section-3.1.3">3.1.3</a>.  Comment Downgrading</span>

   If the header field has any &lt;comment&gt; fields that contain non-ASCII
   strings, apply encoded-word encoding.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.1.4.%20%20MIME-Value%20Downgrading"></a><a class="selflink" href="#section-3.1.4" name="section-3.1.4">3.1.4</a>.  MIME-Value Downgrading</span>

   If the header field has any &lt;value&gt; elements [<a href="rfc2045.html" title='"Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies"'>RFC2045</a>] that contain
   non-ASCII strings, remove any &lt;CFWS&gt; that appear outside DQUOTE
   [<a href="rfc5234.html" title='"Augmented BNF for Syntax Specifications: ABNF"'>RFC5234</a>] that appear in those elements, then encode the &lt;value&gt;
   elements as extended MIME parameter encodings [<a href="rfc2231.html" title='"MIME Parameter Value and Encoded Word Extensions: Character Sets, Languages, and Continuations"'>RFC2231</a>] and leave the
   language information empty.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.1.5.%20%20Display-Name%20Downgrading"></a><a class="selflink" href="#section-3.1.5" name="section-3.1.5">3.1.5</a>.  Display-Name Downgrading</span>

   If the header field has any &lt;address&gt; (&lt;mailbox&gt; or &lt;group&gt;)
   elements, and they have &lt;display-name&gt; elements that contain
   non-ASCII strings, encode the &lt;display-name&gt; elements as encoded-
   words.  Display-Name downgrading uses the same algorithm as Word
   downgrading.








<span class="grey">Fujiwara                     Standards Track                    [Page 7]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-8" id="page-8" name="page-8"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.1.6.%20%20Domain%20Downgrading"></a><a class="selflink" href="#section-3.1.6" name="section-3.1.6">3.1.6</a>.  Domain Downgrading</span>

   If the header field has any &lt;domain&gt; elements that contain U-labels,
   rewrite the non-ASCII domain name into an ASCII domain name using
   A-labels [<a href="rfc5891.html" title='"Internationalized Domain Names in Applications (IDNA): Protocol"'>RFC5891</a>].

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.1.7.%20%20Group%20Downgrading"></a><a class="selflink" href="#section-3.1.7" name="section-3.1.7">3.1.7</a>.  Group Downgrading</span>

   &lt;group&gt; is defined in <a href="#section-3.4">Section 3.4</a> of the Internet Message Format
   specification [<a href="rfc5322.html" title='"Internet Message Format"'>RFC5322</a>].  The &lt;group&gt; element may contain &lt;mailbox&gt;
   elements that contain non-ASCII addresses.

   If a &lt;group&gt; element contains &lt;mailbox&gt; elements and one of those
   &lt;mailbox&gt; elements contains a non-ASCII &lt;local-part&gt;, rewrite the
   &lt;group&gt; element as

   display-name " " ENCODED_WORD " :;"

   where the &lt;ENCODED_WORD&gt; is the original &lt;group-list&gt; encoded as
   encoded-words.

   Otherwise, the &lt;group&gt; element contains an ASCII-only &lt;local-part&gt;.
   If the &lt;group&gt; element contains non-ASCII &lt;mailbox&gt; elements, they
   contain non-ASCII domain names.  Rewrite the non-ASCII domain names
   into ASCII domain names using A-labels [<a href="rfc5891.html" title='"Internationalized Domain Names in Applications (IDNA): Protocol"'>RFC5891</a>].  Generated
   &lt;mailbox&gt; elements contain ASCII addresses only.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.1.8.%20%20Mailbox%20Downgrading"></a><a class="selflink" href="#section-3.1.8" name="section-3.1.8">3.1.8</a>.  Mailbox Downgrading</span>

   If the &lt;local-part&gt; of the &lt;mailbox&gt; element contains no characters
   other than those in the ASCII repertoire, the &lt;domain&gt; element may
   contain non-ASCII characters.  Rewrite the non-ASCII domain names
   into ASCII domain names using A-labels [<a href="rfc5891.html" title='"Internationalized Domain Names in Applications (IDNA): Protocol"'>RFC5891</a>].

   Otherwise, the &lt;local-part&gt; may contain non-ASCII characters.  The
   &lt;local-part&gt; that contains characters outside the ASCII repertoire
   has no equivalent format for ASCII addresses.  The &lt;addr-spec&gt;
   element that contains non-ASCII strings may appear in two forms as:

   "&lt;" addr-spec "&gt;"

   or

   addr-spec

   Rewrite both as:

   ENCODED-WORD " :;"



<span class="grey">Fujiwara                     Standards Track                    [Page 8]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-9" id="page-9" name="page-9"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


   where the &lt;ENCODED-WORD&gt; is the original &lt;addr-spec&gt; encoded as
   encoded-words.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.1.9.%20%20Type-Addr%20Downgrading"></a><a class="selflink" href="#section-3.1.9" name="section-3.1.9">3.1.9</a>.  Type-Addr Downgrading</span>

   If the header field contains &lt;utf-8-type-addr&gt; and the
   &lt;utf-8-type-addr&gt; contains raw non-ASCII strings (&lt;UTF8-non-ascii&gt;),
   it is in utf-8-address form [<a href="rfc6533.html" title='"Internationalized Delivery Status and Disposition Notifications"'>RFC6533</a>].  Convert it to
   utf-8-addr-xtext form [<a href="rfc6533.html" title='"Internationalized Delivery Status and Disposition Notifications"'>RFC6533</a>].  Comment downgrading is also
   performed in this case.  If the address type is unrecognized and the
   header field contains non-ASCII strings, then fall back to using
   Encapsulation on the entire header field as specified in
   <a href="#section-3.1.10">Section 3.1.10</a>.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.1.10.%20%20Encapsulation%3A%20A%20Last%20Resort"></a><a class="selflink" href="#section-3.1.10" name="section-3.1.10">3.1.10</a>.  Encapsulation: A Last Resort</span>

   As a last resort, when header fields cannot be converted as discussed
   in the previous subsection, the fields are deleted and replaced by
   specialized new header fields.  Those fields are defined to preserve,
   in encoded form, as much information as possible from the header
   field values of the incoming message.  This mechanism is known as
   Encapsulation downgrading in this specification because it preserves
   the original information in a different form.  The syntax of these
   new header fields is:

   fields                   =/ downgraded

   downgraded =  "Downgraded-Message-Id:"         unstructured CRLF /
                 "Downgraded-Resent-Message-Id:"  unstructured CRLF /
                 "Downgraded-In-Reply-To:"        unstructured CRLF /
                 "Downgraded-References:"         unstructured CRLF /
                 "Downgraded-Original-Recipient:" unstructured CRLF /
                 "Downgraded-Final-Recipient:"    unstructured CRLF

   Applying this procedure to the "Received:" header field is
   prohibited.  Encapsulation downgrading is allowed for "Message-ID:",
   "In-Reply-To:", "References:", "Original-Recipient:", and
   "Final-Recipient:" header fields.

   To preserve a header field in a Downgraded- header field:

   1.  Generate a new header field.

       *  The field name is a concatenation of Downgraded- and the
          original field name.

       *  The initial new field value is the original header field
          value.



<span class="grey">Fujiwara                     Standards Track                    [Page 9]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-10" id="page-10" name="page-10"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


   2.  Treat the initial new header field value as if it were
       unstructured, and then apply the encoded-word encoding as
       necessary so that the resulting new header field value is
       completely in ASCII.

   3.  Remove the original header field.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.2.%20%20Downgrading%20Method%20for%20Each%20Header%20Field"></a><a class="selflink" href="#section-3.2" name="section-3.2">3.2</a>.  Downgrading Method for Each Header Field</span>

   The Mail and MIME Header Fields document [<a href="rfc4021.html" title='"Registration of Mail and MIME Header Fields"'>RFC4021</a>] establishes a
   registry of header fields.  This section describes the downgrading
   method for each header field listed in that registry as of the date
   of publication of this specification.

   If the entire mail header field contains no characters other than
   those in the ASCII repertoire, email header field downgrading is not
   required.  Each header field's downgrading method is described below.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.2.1.%20%20Address%20Header%20Fields%20That%20Contain%20%3Caddress%3E%20Elements"></a><a class="selflink" href="#section-3.2.1" name="section-3.2.1">3.2.1</a>.  Address Header Fields That Contain &lt;address&gt; Elements</span>

   From:
   Sender:
   To:
   Cc:
   Bcc:
   Reply-To:
   Resent-From:
   Resent-Sender:
   Resent-To:
   Resent-Cc:
   Resent-Bcc:
   Resent-Reply-To:
   Return-Path:
   Disposition-Notification-To:

   If the header field contains non-ASCII characters, first perform
   Comment downgrading and Display-Name downgrading as described in the
   corresponding subsections of <a href="#section-3.1">Section 3.1</a>.  If the header field still
   contains non-ASCII characters, complete the following two steps:

   1.  If the header field contains &lt;group&gt; elements that contain
       non-ASCII addresses, perform Group downgrading on those elements.

   2.  If the header field contains &lt;mailbox&gt; elements that contain
       non-ASCII addresses, perform Mailbox downgrading on those
       elements.





<span class="grey">Fujiwara                     Standards Track                   [Page 10]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-11" id="page-11" name="page-11"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


   This procedure may generate empty &lt;group&gt; elements in the "From:" and
   "Sender:" header fields.  The Group Syntax document [<a href="rfc6854.html" title='"Update to Internet Message Format to Allow Group Syntax in the "'>RFC6854</a>] updates
   the Internet Message Format specification [<a href="rfc5322.html" title='"Internet Message Format"'>RFC5322</a>] to allow (empty)
   &lt;group&gt; elements in the "From:" and "Sender:" header fields.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.2.2.%20%20Non-ASCII%20Strings%20in%20%3Ccomment%3E%20Elements"></a><a class="selflink" href="#section-3.2.2" name="section-3.2.2">3.2.2</a>.  Non-ASCII Strings in &lt;comment&gt; Elements</span>

   Date:
   Resent-Date:
   MIME-Version:
   Content-ID:
   Content-Transfer-Encoding:
   Content-Language:
   Accept-Language:
   Auto-Submitted:

   Except in comments, these header fields do not contain characters
   other than those in the ASCII repertoire.  If the header field
   contains UTF-8 characters in comments, perform Comment downgrading.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.2.3.%20%20Message-ID%20Header%20Fields"></a><a class="selflink" href="#section-3.2.3" name="section-3.2.3">3.2.3</a>.  Message-ID Header Fields</span>

   Message-ID:
   Resent-Message-ID:
   In-Reply-To:
   References:

   If there are non-ASCII strings in &lt;id-left&gt; or &lt;id-right&gt; elements,
   perform Encapsulation.  Otherwise, the header field contains UTF-8
   characters in comments and Comment downgrading should be performed.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.2.4.%20%20Received%20Header%20Field"></a><a class="selflink" href="#section-3.2.4" name="section-3.2.4">3.2.4</a>.  Received Header Field</span>

   Received:

   If &lt;domain&gt; elements or &lt;mailbox&gt; elements contain U-labels, perform
   Domain downgrading as specified in <a href="#section-3.1.6">Section 3.1.6</a>.  Comments may
   contain non-ASCII strings; if so, perform Comment downgrading.

   After the Domain downgrading and the Comment downgrading, if the
   "FOR" clause contains a non-ASCII &lt;local-part&gt;, remove the FOR
   clause.  If the "ID" clause contains a non-ASCII value, remove the ID
   clause.








<span class="grey">Fujiwara                     Standards Track                   [Page 11]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-12" id="page-12" name="page-12"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.2.5.%20%20MIME%20Content%20Header%20Fields"></a><a class="selflink" href="#section-3.2.5" name="section-3.2.5">3.2.5</a>.  MIME Content Header Fields</span>

   Content-Type:
   Content-Disposition:

   If there are non-ASCII strings in &lt;value&gt; or &lt;CFWS&gt; elements, perform
   MIME-Value and Comment downgrading.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.2.6.%20%20Non-ASCII%20Characters%20in%20%3Cunstructured%3E%20Elements"></a><a class="selflink" href="#section-3.2.6" name="section-3.2.6">3.2.6</a>.  Non-ASCII Characters in &lt;unstructured&gt; Elements</span>

   Subject:
   Comments:
   Content-Description:

   If non-ASCII strings are present in &lt;unstructured&gt; elements, perform
   Unstructured downgrading.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.2.7.%20%20Non-ASCII%20Characters%20in%20%3Cphrase%3E%20Elements"></a><a class="selflink" href="#section-3.2.7" name="section-3.2.7">3.2.7</a>.  Non-ASCII Characters in &lt;phrase&gt; Elements</span>

   Keywords:

   If non-ASCII strings are present in &lt;phrase&gt; elements, perform Word
   downgrading.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.2.8.%20%20Other%20Header%20Fields"></a><a class="selflink" href="#section-3.2.8" name="section-3.2.8">3.2.8</a>.  Other Header Fields</span>

   Other header fields that are not covered in this document (such as
   implementation-specific or user-defined fields) might also contain
   non-ASCII strings.  Any header field that does not have a conversion
   method defined above will be in this category and treated as follows.

   If there are non-ASCII strings present in the header fields, perform
   Unstructured downgrading.

   If the software understands the header field's structure and a
   downgrading algorithm other than Unstructured is applicable, that
   software SHOULD use that algorithm; Unstructured downgrading is used
   when there is no other option.

   Mailing list header fields (those that start in "List-") are part of
   this category.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/4.%20%20MIME%20Body%20Parts%20and%20Delivery%20Status%20Notifications"></a><a class="selflink" href="#section-4" name="section-4">4</a>.  MIME Body Parts and Delivery Status Notifications</span>

   Both the MIME body part header fields [<a href="rfc2045.html" title='"Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies"'>RFC2045</a>] [<a href="rfc6532.html" title='"Internationalized Email Headers"'>RFC6532</a>] and the
   contents of a delivery status notification [<a href="rfc6533.html" title='"Internationalized Delivery Status and Disposition Notifications"'>RFC6533</a>] may contain
   non-ASCII characters.




<span class="grey">Fujiwara                     Standards Track                   [Page 12]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-13" id="page-13" name="page-13"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.1.%20%20MIME%20Body%20Part%20Header%20Field%20Downgrading"></a><a class="selflink" href="#section-4.1" name="section-4.1">4.1</a>.  MIME Body Part Header Field Downgrading</span>

   <a href="rfc6532.html">RFC 6532</a> specifies an extension that permits MIME header fields,
   including body part header fields, to contain non-ASCII strings.
   This section defines the conversion method to ASCII-only header
   fields for each MIME header field that contains non-ASCII strings.
   Parse the message body's MIME structure at all levels and check each
   MIME header field to see whether it contains non-ASCII strings.  If
   the header field contains non-ASCII strings in the header field
   value, the header field is a target of the MIME body part header
   field's downgrading.  The downgrading methods used for the MIME body
   part header fields Content-ID, Content-Type, Content-Disposition, and
   Content-Description are the same as those used for the header fields
   of the same name described in <a href="#section-3.2">Section 3.2</a>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.2.%20%20Delivery%20Status%20Notification%20Downgrading"></a><a class="selflink" href="#section-4.2" name="section-4.2">4.2</a>.  Delivery Status Notification Downgrading</span>

   If the message contains a delivery status notification (see <a href="#section-6">Section 6</a>
   of the SMTP DSN Extension [<a href="rfc3461.html" title='"Simple Mail Transfer Protocol (SMTP) Service Extension for Delivery Status Notifications (DSNs)"'>RFC3461</a>]), perform the following tests and
   conversions.

   If there are "Original-Recipient:" and "Final-Recipient:" header
   fields, and the header fields contain non-ASCII strings, perform
   Type-Addr downgrading.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/5.%20%20Security%20Considerations"></a><a class="selflink" href="#section-5" name="section-5">5</a>.  Security Considerations</span>

   The purpose of post-delivery message downgrading is to allow POP and
   IMAP servers to deliver internationalized messages to traditional POP
   and IMAP clients and to permit the clients to display those messages.
   Users that receive such messages can know that they were
   internationalized.  It does not permit receivers to read the messages
   in their original form and, in general, will not permit generating
   replies, at least without significant user intervention.

   After downgrading as specified in this document, the header fields of
   a message will contain ASCII characters only, some of them in
   encoded-word form.  Nothing in this document or other SMTPUTF8
   specifications [<a href="rfc6530.html" title='"Overview and Framework for Internationalized Email"'>RFC6530</a>] [<a href="rfc6531.html" title='"SMTP Extension for Internationalized Email"'>RFC6531</a>] alters the basic properties of
   MIME that allow characters outside the ASCII repertoire in encodings
   as specified for them.  Thus, this document inherits the security
   considerations associated with MIME-encoded header fields as
   specified in <a href="rfc2047.html">RFC 2047</a> [<a href="rfc2047.html" title='"MIME (Multipurpose Internet Mail Extensions) Part Three: Message Header Extensions for Non-ASCII Text"'>RFC2047</a>] and with UTF-8 itself as specified in
   <a href="rfc3629.html">RFC 3629</a> [<a href="rfc3629.html" title='"UTF-8, a transformation format of ISO 10646"'>RFC3629</a>].

   Rewriting header fields increases the opportunities for undetected
   spoofing by malicious senders.  However, the rewritten header field
   values are preserved in equivalent MIME form or in newly defined



<span class="grey">Fujiwara                     Standards Track                   [Page 13]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-14" id="page-14" name="page-14"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


   header fields for which traditional MUAs have no special processing
   procedures.

   The techniques described here may invalidate methods that depend on
   digital signatures over any part of the message, which includes the
   top-level header fields and body part header fields.  Depending on
   the specific message being downgraded, at least the following
   techniques are likely to break: DomainKeys Identified Mail (DKIM) and
   possibly S/MIME and Pretty Good Privacy (PGP).  The downgrade
   mechanism SHOULD NOT remove signatures even if the signatures will
   fail validation after downgrading.  As much of the information as
   possible from the original message SHOULD be preserved.  In addition,
   MUAs may be able to use the presence of an Authentication-Results
   header field [<a href="rfc5451.html" title='"Message Header Field for Indicating Message Authentication Status"'>RFC5451</a>] to assess whether the digital signatures were
   valid before the header fields were downgraded.

   While information in any email header field should usually be treated
   with some suspicion, current email systems commonly employ various
   mechanisms and protocols to make the information more trustworthy.
   Information in the new Downgraded-* header fields is not inspected by
   traditional MUAs and may be even less trustworthy than the
   traditional header fields.  Note that the Downgraded-* header fields
   could have been inserted with malicious intent (and with content
   unrelated to the traditional header fields); however, traditional
   MUAs do not evaluate Downgraded-* header fields.

   See the Security Considerations sections in the Group Syntax document
   [<a href="rfc6854.html" title='"Update to Internet Message Format to Allow Group Syntax in the "'>RFC6854</a>] and the Internationalized Email Framework [<a href="rfc6530.html" title='"Overview and Framework for Internationalized Email"'>RFC6530</a>] for
   more discussion.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/6.%20%20Implementation%20Note%3A%20Encoded-Word%20Encoding"></a><a class="selflink" href="#section-6" name="section-6">6</a>.  Implementation Note: Encoded-Word Encoding</span>

   While the specification of encoded-words includes specific rules for
   dealing with whitespace in adjacent encoded words [<a href="rfc2047.html" title='"MIME (Multipurpose Internet Mail Extensions) Part Three: Message Header Extensions for Non-ASCII Text"'>RFC2047</a>], there
   are a number of deployed implementations that fail to implement the
   algorithm correctly.  As a result, whitespace behavior is somewhat
   unpredictable, in practice, when multiple encoded words are used.

   While <a href="rfc5322.html">RFC 5322</a> states that implementations SHOULD limit lines to 78
   characters or less, implementations MAY choose to allow overly long
   encoded words to work around faulty implementations of encoded-words.
   Implementations that choose to do so SHOULD have an optional
   mechanism to limit line length to 78 characters.








<span class="grey">Fujiwara                     Standards Track                   [Page 14]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-15" id="page-15" name="page-15"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/7.%20%20IANA%20Considerations"></a><a class="selflink" href="#section-7" name="section-7">7</a>.  IANA Considerations</span>

   The experimental specification from which this document was partially
   derived [<a href="rfc5504.html" title='"Downgrading Mechanism for Email Address Internationalization"'>RFC5504</a>] specifies that no new header fields beginning with
   Downgraded- are to be registered.  That restriction is now lifted,
   and this document makes a new set of registrations, replacing the
   experimental fields with standard ones.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.1.%20%20Obsolescence%20of%20Existing%20Downgraded-%2A%20Header%20Fields"></a><a class="selflink" href="#section-7.1" name="section-7.1">7.1</a>.  Obsolescence of Existing Downgraded-* Header Fields</span>

   The Downgraded-* header fields that were registered as experimental
   fields in <a href="rfc5504.html">RFC 5504</a> are no longer in use.  IANA has changed the status
   from "experimental" to "obsoleted" for every name in the "Permanent
   Message Header Field Names" registry that began with Downgraded-.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.2.%20%20Registration%20of%20New%20Downgraded-%2A%20Header%20Fields"></a><a class="selflink" href="#section-7.2" name="section-7.2">7.2</a>.  Registration of New Downgraded-* Header Fields</span>

   The following header fields have been registered in the "Permanent
   Message Header Field Names" registry, in accordance with the
   procedures set out in the Header Field Registration document
   [<a href="rfc3864.html" title='"Registration Procedures for Message Header Fields"'>RFC3864</a>].

   Header field name:  Downgraded-Message-Id
   Applicable protocol:  mail
   Status:  standard
   Author/change controller:  IETF
   Specification document(s):  This document (<a href="#section-3.1.10">Section 3.1.10</a>)

   Header field name:  Downgraded-In-Reply-To
   Applicable protocol:  mail
   Status:  standard
   Author/change controller:  IETF
   Specification document(s):  This document (<a href="#section-3.1.10">Section 3.1.10</a>)

   Header field name:  Downgraded-References
   Applicable protocol:  mail
   Status:  standard
   Author/change controller:  IETF
   Specification document(s):  This document (<a href="#section-3.1.10">Section 3.1.10</a>)

   Header field name:  Downgraded-Original-Recipient
   Applicable protocol:  mail
   Status:  standard
   Author/change controller:  IETF
   Specification document(s):  This document (<a href="#section-3.1.10">Section 3.1.10</a>)






<span class="grey">Fujiwara                     Standards Track                   [Page 15]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-16" id="page-16" name="page-16"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


   Header field name:  Downgraded-Final-Recipient
   Applicable protocol:  mail
   Status:  standard
   Author/change controller:  IETF
   Specification document(s):  This document (<a href="#section-3.1.10">Section 3.1.10</a>)

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/8.%20%20Acknowledgements"></a><a class="selflink" href="#section-8" name="section-8">8</a>.  Acknowledgements</span>

   This document draws heavily from the experimental in-transit message
   downgrading procedure described <a href="rfc5504.html">RFC 5504</a>.  The contributions of the
   coauthor of that earlier document, Y. Yoneya, are gratefully
   acknowledged.  Significant comments and suggestions were received
   from John Klensin, Barry Leiba, Randall Gellens, Pete Resnick, Martin
   J. Durst, and other WG participants.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/9.%20%20References"></a><a class="selflink" href="#section-9" name="section-9">9</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/9.1.%20%20Normative%20References"></a><a class="selflink" href="#section-9.1" name="section-9.1">9.1</a>.  Normative References</span>

   [<a id="ref-RFC2045" name="ref-RFC2045">RFC2045</a>]  Freed, N. and N. Borenstein, "Multipurpose Internet Mail
              Extensions (MIME) Part One: Format of Internet Message
              Bodies", <a href="rfc2045.html">RFC 2045</a>, November 1996.

   [<a id="ref-RFC2047" name="ref-RFC2047">RFC2047</a>]  Moore, K., "MIME (Multipurpose Internet Mail Extensions)
              Part Three: Message Header Extensions for Non-ASCII Text",
              <a href="rfc2047.html">RFC 2047</a>, November 1996.

   [<a id="ref-RFC2119" name="ref-RFC2119">RFC2119</a>]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", <a href="https://tools.ietf.org/html/bcp14">BCP 14</a>, <a href="rfc2119.html">RFC 2119</a>, March 1997.

   [<a id="ref-RFC2183" name="ref-RFC2183">RFC2183</a>]  Troost, R., Dorner, S., and K. Moore, "Communicating
              Presentation Information in Internet Messages: The
              Content-Disposition Header Field", <a href="rfc2183.html">RFC 2183</a>, August 1997.

   [<a id="ref-RFC2231" name="ref-RFC2231">RFC2231</a>]  Freed, N. and K. Moore, "MIME Parameter Value and Encoded
              Word Extensions:
              Character Sets, Languages, and Continuations", <a href="rfc2231.html">RFC 2231</a>,
              November 1997.

   [<a id="ref-RFC3461" name="ref-RFC3461">RFC3461</a>]  Moore, K., "Simple Mail Transfer Protocol (SMTP) Service
              Extension for Delivery Status Notifications (DSNs)",
              <a href="rfc3461.html">RFC 3461</a>, January 2003.

   [<a id="ref-RFC3629" name="ref-RFC3629">RFC3629</a>]  Yergeau, F., "UTF-8, a transformation format of ISO
              10646", STD 63, <a href="rfc3629.html">RFC 3629</a>, November 2003.






<span class="grey">Fujiwara                     Standards Track                   [Page 16]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-17" id="page-17" name="page-17"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


   [<a id="ref-RFC3864" name="ref-RFC3864">RFC3864</a>]  Klyne, G., Nottingham, M., and J. Mogul, "Registration
              Procedures for Message Header Fields", <a href="https://tools.ietf.org/html/bcp90">BCP 90</a>, <a href="rfc3864.html">RFC 3864</a>,
              September 2004.

   [<a id="ref-RFC4021" name="ref-RFC4021">RFC4021</a>]  Klyne, G. and J. Palme, "Registration of Mail and MIME
              Header Fields", <a href="rfc4021.html">RFC 4021</a>, March 2005.

   [<a id="ref-RFC5322" name="ref-RFC5322">RFC5322</a>]  Resnick, P., Ed., "Internet Message Format", <a href="rfc5322.html">RFC 5322</a>,
              October 2008.

   [<a id="ref-RFC5890" name="ref-RFC5890">RFC5890</a>]  Klensin, J., "Internationalized Domain Names for
              Applications (IDNA): Definitions and Document Framework",
              <a href="rfc5890.html">RFC 5890</a>, August 2010.

   [<a id="ref-RFC5891" name="ref-RFC5891">RFC5891</a>]  Klensin, J., "Internationalized Domain Names in
              Applications (IDNA): Protocol", <a href="rfc5891.html">RFC 5891</a>, August 2010.

   [<a id="ref-RFC6530" name="ref-RFC6530">RFC6530</a>]  Klensin, J. and Y. Ko, "Overview and Framework for
              Internationalized Email", <a href="rfc6530.html">RFC 6530</a>, February 2012.

   [<a id="ref-RFC6531" name="ref-RFC6531">RFC6531</a>]  Yao, J. and W. Mao, "SMTP Extension for Internationalized
              Email", <a href="rfc6531.html">RFC 6531</a>, February 2012.

   [<a id="ref-RFC6532" name="ref-RFC6532">RFC6532</a>]  Yang, A., Steele, S., and N. Freed, "Internationalized
              Email Headers", <a href="rfc6532.html">RFC 6532</a>, February 2012.

   [<a id="ref-RFC6533" name="ref-RFC6533">RFC6533</a>]  Hansen, T., Newman, C., and A. Melnikov,
              "Internationalized Delivery Status and Disposition
              Notifications", <a href="rfc6533.html">RFC 6533</a>, February 2012.

   [<a id="ref-RFC6854" name="ref-RFC6854">RFC6854</a>]  Leiba, B., "Update to Internet Message Format to Allow
              Group Syntax in the "From:" and "Sender:" Header Fields",
              <a href="rfc6854.html">RFC 6854</a>, March 2013.

   [<a id="ref-RFC6855" name="ref-RFC6855">RFC6855</a>]  Resnick, P., Ed., Newman, C., Ed., and S. Shen, Ed., "IMAP
              Support for UTF-8", <a href="rfc6855.html">RFC 6855</a>, March 2013.

   [<a id="ref-RFC6856" name="ref-RFC6856">RFC6856</a>]  Gellens, R., Newman, C., Yao, J., and K. Fujiwara, "Post
              Office Protocol Version 3 (POP3) Support for UTF-8",
              <a href="rfc6856.html">RFC 6856</a>, March 2013.











<span class="grey">Fujiwara                     Standards Track                   [Page 17]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-18" id="page-18" name="page-18"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/9.2.%20%20Informative%20References"></a><a class="selflink" href="#section-9.2" name="section-9.2">9.2</a>.  Informative References</span>

   [<a id="ref-RFC5234" name="ref-RFC5234">RFC5234</a>]  Crocker, D. and P. Overell, "Augmented BNF for Syntax
              Specifications: ABNF", STD 68, <a href="rfc5234.html">RFC 5234</a>, January 2008.

   [<a id="ref-RFC5451" name="ref-RFC5451">RFC5451</a>]  Kucherawy, M., "Message Header Field for Indicating
              Message Authentication Status", <a href="rfc5451.html">RFC 5451</a>, April 2009.

   [<a id="ref-RFC5504" name="ref-RFC5504">RFC5504</a>]  Fujiwara, K. and Y. Yoneya, "Downgrading Mechanism for
              Email Address Internationalization", <a href="rfc5504.html">RFC 5504</a>, March 2009.









































<span class="grey">Fujiwara                     Standards Track                   [Page 18]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-19" id="page-19" name="page-19"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/Appendix%20A.%20%20Downgrading%20Example"></a><a class="selflink" href="#appendix-A" name="appendix-A">Appendix A</a>.  Downgrading Example</span>

   This appendix shows a message downgrading example.  Consider a
   received mail message where:

   o  The sender address is a non-ASCII address,
      "NON-ASCII-LOCAL@example.com".  Its display-name is
      "DISPLAY-LOCAL".

   o  The "To:" header field contains two non-ASCII addresses,
      "NON-ASCII-REMOTE1@example.net" and
      "NON-ASCII-REMOTE2@example.com".  Their display-names are
      "DISPLAY-REMOTE1" and "DISPLAY-REMOTE2".

   o  The "Cc:" header field contains a non-ASCII address,
      "NON-ASCII-REMOTE3@example.org".  Its display-name is
      "DISPLAY-REMOTE3".

   o  Four display-names contain non-ASCII characters.

   o  The "Subject:" header field is "NON-ASCII-SUBJECT", which contains
      non-ASCII strings.

   o  The "Message-Id:" header field contains "NON-ASCII-MESSAGE_ID",
      which contains non-ASCII strings.

   o  There is an unknown header field "X-Unknown-Header:", which
      contains non-ASCII strings.

   Return-Path: &lt;NON-ASCII-LOCAL@example.com&gt;
   Received: from ... by ... for &lt;NON-ASCII-REMOTE1@example.net&gt;
   Received: from ... by ... for &lt;NON-ASCII-REMOTE1@example.net&gt;
   From: DISPLAY-LOCAL &lt;NON-ASCII-LOCAL@example.com&gt;
   To: DISPLAY-REMOTE1 &lt;NON-ASCII-REMOTE1@example.net&gt;,
       DISPLAY-REMOTE2 &lt;NON-ASCII-REMOTE2@example.com&gt;
   Cc: DISPLAY-REMOTE3 &lt;NON-ASCII-REMOTE3@example.org&gt;
   Subject: NON-ASCII-SUBJECT
   Date: Mon, 30 Jul 2012 01:23:45 -0000
   Message-Id: NON-ASCII-MESSAGE_ID
   Mime-Version: 1.0
   Content-Type: text/plain; charset="UTF-8"
   Content-Transfer-Encoding: 8bit
   X-Unknown-Header: NON-ASCII-CHARACTERS

   MAIL_BODY

                 Figure 1: Received Message in a Maildrop




<span class="grey">Fujiwara                     Standards Track                   [Page 19]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-20" id="page-20" name="page-20"> </a>
<span class="grey"><a href="rfc6857.html">RFC 6857</a>                  POP or IMAP Downgrade               March 2013</span>


   The downgraded message is shown in Figure 2.  "Return-Path:",
   "From:", "To:", and "Cc:" header fields are rewritten.  "Subject:"
   and "X-Unknown-Header:" header fields are encoded as encoded-words.
   The "Message-Id:" header field is encapsulated as a
   "Downgraded-Message-Id:" header field.

   Return-Path: =?UTF-8?Q?NON-ASCII-LOCAL@example.com?= :;
   Received: from ... by ...
   Received: from ... by ...
   From: =?UTF-8?Q?DISPLAY-LOCAL?=
         =?UTF-8?Q?NON-ASCII-LOCAL@example.com?= :;
   To:   =?UTF-8?Q?DISPLAY-REMOTE1?=
         =?UTF-8?Q?NON-ASCII-REMOTE1@example.net?= :;,
         =?UTF-8?Q?DISPLAY-REMOTE2?=
         =?UTF-8?Q?NON-ASCII-REMOTE2@example.com?= :;,
   Cc:   =?UTF-8?Q?DISPLAY-REMOTE3?=
         =?UTF-8?Q?NON-ASCII-REMOTE3@example.org?= :;
   Subject: =?UTF-8?Q?NON-ASCII-SUBJECT?=
   Date: Mon, 30 Jul 2012 01:23:45 -0000
   Downgraded-Message-Id: =?UTF-8?Q?MESSAGE_ID?=
   Mime-Version: 1.0
   Content-Type: text/plain; charset="UTF-8"
   Content-Transfer-Encoding: 8bit
   X-Unknown-Header: =?UTF-8?Q?NON-ASCII-CHARACTERS?=

   MAIL_BODY

                       Figure 2: Downgraded Message

Author's Address

   Kazunori Fujiwara
   Japan Registry Services Co., Ltd.
   Chiyoda First Bldg. East 13F, 3-8-1 Nishi-Kanda
   Chiyoda-ku, Tokyo  101-0065
   Japan

   Phone: +81 3 5215 8451
   EMail: fujiwara@jprs.co.jp












Fujiwara                     Standards Track                   [Page 20]

</pre><br/>
    <span class="noprint"><small><small>Html markup produced by rfcmarkup 1.126, available from
      <a href="https://tools.ietf.org/tools/rfcmarkup/">https://tools.ietf.org/tools/rfcmarkup/</a>
    </small></small></span>
  </div>




</body><!-- Mirrored from tools.ietf.org/html/rfc6857 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Mar 2018 23:18:26 GMT --></html>