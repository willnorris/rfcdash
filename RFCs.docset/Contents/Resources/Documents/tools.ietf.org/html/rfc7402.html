<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><!-- Mirrored from tools.ietf.org/html/rfc7402 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Mar 2018 23:18:21 GMT --><!-- Added by HTTrack --><head><meta content="text/html;charset=utf-8" http-equiv="content-type"/><!-- /Added by HTTrack -->

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <meta content="index,follow" name="robots"/>
    <meta content="rfcmarkup version 1.126" name="creator"/>
    <link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/>
<meta content="rfc5202" name="DC.Relation.Replaces"/>
<meta content="urn:ietf:rfc:7402" name="DC.Identifier"/>
<meta content="April, 2015" name="DC.Date.Issued"/>
<meta content="Jokela, Petri" name="DC.Creator"/>
<meta content="Melen, Jan" name="DC.Creator"/>
<meta content="Moskowitz, Robert" name="DC.Creator"/>
<meta content="This memo specifies an Encapsulating Security Payload (ESP) based
mechanism for transmission of user data packets, to be used with the
Host Identity Protocol (HIP). This document obsoletes RFC 5202." name="DC.Description.Abstract"/>
<meta content="Using the Encapsulating Security Payload (ESP) Transport Format with the Host Identity Protocol (HIP)" name="DC.Title"/>

    <link href="https://tools.ietf.org/images/rfc.png" rel="icon" type="image/png"/>
    <link href="https://tools.ietf.org/images/rfc.png" rel="shortcut icon" type="image/png"/>
    <title>RFC 7402 - Using the Encapsulating Security Payload (ESP) Transport Format with the Host Identity Protocol (HIP)</title>
    
    
    <style type="text/css">
	@media only screen 
	  and (min-width: 992px)
	  and (max-width: 1199px) {
	    body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 768px)
	  and (max-width: 991px) {
            body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 480px)
	  and (max-width: 767px) {
            body { font-size: 11pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (max-width: 479px) {
            body { font-size: 8pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-device-width : 375px) 
	  and (max-device-width : 667px) {
            body { font-size: 9.5pt; }
            div.content { width: 96ex; margin: 0 1px; }
        }
	@media only screen 
	  and (min-device-width: 1200px) {
            body { font-size: 10pt; margin: 0 4em; }
            div.content { width: 96ex; margin: 0; }
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        a.selflink {
          color: black;
          text-decoration: none;
        }
        @media print {
            body {
                font-family: monospace;
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 1em;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>                   <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>                     <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>             <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>              <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td>      <td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td>         <td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard (old designation):</td> <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Internet Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>                  <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>                  <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
  <div class="content">
   <div style="height: 13px;">
      <div class="pre noprint docinfo bgblue" onclick="showElem('legend');" onmouseout="hideElem('legend')" onmouseover="this.style.cursor='pointer';" style="height: 6px; position: absolute;" title="Click for colour legend.">                                                                        </div>
      <div class="docinfo noprint pre legend" id="legend" onmouseout="hideElem('legend');" onmouseover="showElem('legend');" style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; ">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="index.html" title="Document search and retrieval page">Docs</a>] [<a href="https://tools.ietf.org/rfc/rfc7402.txt" title="Plaintext version of this document">txt</a>|<a href="https://tools.ietf.org/pdf/rfc7402" title="PDF version of this document">pdf</a>] [<a href="https://tools.ietf.org/html/draft-ietf-hip-rfc5202-bis" title="draft-ietf-hip-rfc5202-bis">draft-ietf-hip-...</a>] [<a href="https://datatracker.ietf.org/doc/rfc7402" title="IESG Datatracker information for this document">Tracker</a>] [<a href="https://tools.ietf.org/rfcdiff?difftype=--hwdiff&amp;url2=rfc7402" title="Inline diff (wdiff)">Diff1</a>] [<a href="https://tools.ietf.org/rfcdiff?url2=rfc7402" title="Side-by-side diff">Diff2</a>]         </span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<span class="pre noprint docinfo">                                                       PROPOSED STANDARD</span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<pre>Internet Engineering Task Force (IETF)                         P. Jokela
Request for Comments: 7402                  Ericsson Research NomadicLab
Obsoletes: <a href="rfc5202.html">5202</a>                                             R. Moskowitz
Category: Standards Track                                 HTT Consulting
ISSN: 2070-1721                                                 J. Melen
                                            Ericsson Research NomadicLab
                                                              April 2015


    <span class="h1">Using the Encapsulating Security Payload (ESP) Transport Format</span>
                 <span class="h1">with the Host Identity Protocol (HIP)</span>

Abstract

   This memo specifies an Encapsulating Security Payload (ESP) based
   mechanism for transmission of user data packets, to be used with the
   Host Identity Protocol (HIP).  This document obsoletes <a href="rfc5202.html">RFC 5202</a>.

Status of This Memo

   This is an Internet Standards Track document.

   This document is a product of the Internet Engineering Task Force
   (IETF).  It represents the consensus of the IETF community.  It has
   received public review and has been approved for publication by the
   Internet Engineering Steering Group (IESG).  Further information on
   Internet Standards is available in <a href="rfc5741.html#section-2">Section 2 of RFC 5741</a>.

   Information about the current status of this document, any errata,
   and how to provide feedback on it may be obtained at
   <a href="http://www.rfc-editor.org/info/rfc7402">http://www.rfc-editor.org/info/rfc7402</a>.

Copyright Notice

   Copyright (c) 2015 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="https://tools.ietf.org/html/bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.





<span class="grey">Jokela, et al.               Standards Track                    [Page 1]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-2" id="page-2" name="page-2"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


Table of Contents

   <a href="#section-1">1</a>. Introduction ....................................................<a href="#page-3">3</a>
   <a href="#section-2">2</a>. Conventions Used in This Document ...............................<a href="#page-4">4</a>
   <a href="#section-3">3</a>. Using ESP with HIP ..............................................<a href="#page-4">4</a>
      <a href="#section-3.1">3.1</a>. ESP Packet Format ..........................................<a href="#page-5">5</a>
      <a href="#section-3.2">3.2</a>. Conceptual ESP Packet Processing ...........................<a href="#page-5">5</a>
           <a href="#section-3.2.1">3.2.1</a>. Semantics of the Security Parameter Index (SPI) .....<a href="#page-6">6</a>
      <a href="#section-3.3">3.3</a>. Security Association Establishment and Maintenance .........<a href="#page-6">6</a>
           <a href="#section-3.3.1">3.3.1</a>. ESP Security Associations ...........................<a href="#page-6">6</a>
           <a href="#section-3.3.2">3.3.2</a>. Rekeying ............................................<a href="#page-7">7</a>
           <a href="#section-3.3.3">3.3.3</a>. Security Association Management .....................<a href="#page-8">8</a>
           <a href="#section-3.3.4">3.3.4</a>. Security Parameter Index (SPI) ......................<a href="#page-8">8</a>
           <a href="#section-3.3.5">3.3.5</a>. Supported Ciphers ...................................<a href="#page-8">8</a>
           <a href="#section-3.3.6">3.3.6</a>. Sequence Number .....................................<a href="#page-9">9</a>
           <a href="#section-3.3.7">3.3.7</a>. Lifetimes and Timers ................................<a href="#page-9">9</a>
      <a href="#section-3.4">3.4</a>. IPsec and HIP ESP Implementation Considerations ............<a href="#page-9">9</a>
           <a href="#section-3.4.1">3.4.1</a>. Data Packet Processing Considerations ..............<a href="#page-10">10</a>
           <a href="#section-3.4.2">3.4.2</a>. HIP Signaling Packet Considerations ................<a href="#page-10">10</a>
   <a href="#section-4">4</a>. The Protocol ...................................................<a href="#page-11">11</a>
      <a href="#section-4.1">4.1</a>. ESP in HIP ................................................<a href="#page-11">11</a>
           <a href="#section-4.1.1">4.1.1</a>. IPsec ESP Transport Format Type ....................<a href="#page-11">11</a>
           <a href="#section-4.1.2">4.1.2</a>. Setting Up an ESP Security Association .............<a href="#page-11">11</a>
           <a href="#section-4.1.3">4.1.3</a>. Updating an Existing ESP SA ........................<a href="#page-12">12</a>
   <a href="#section-5">5</a>. Parameter and Packet Formats ...................................<a href="#page-13">13</a>
      <a href="#section-5.1">5.1</a>. New Parameters ............................................<a href="#page-13">13</a>
           <a href="#section-5.1.1">5.1.1</a>. ESP_INFO ...........................................<a href="#page-13">13</a>
           <a href="#section-5.1.2">5.1.2</a>. ESP_TRANSFORM ......................................<a href="#page-15">15</a>
           <a href="#section-5.1.3">5.1.3</a>. NOTIFICATION Parameter .............................<a href="#page-16">16</a>
      <a href="#section-5.2">5.2</a>. HIP ESP Security Association Setup ........................<a href="#page-17">17</a>
           <a href="#section-5.2.1">5.2.1</a>. Setup during Base Exchange .........................<a href="#page-17">17</a>
      <a href="#section-5.3">5.3</a>. HIP ESP Rekeying ..........................................<a href="#page-18">18</a>
           <a href="#section-5.3.1">5.3.1</a>. Initializing Rekeying ..............................<a href="#page-19">19</a>
           <a href="#section-5.3.2">5.3.2</a>. Responding to the Rekeying Initialization ..........<a href="#page-19">19</a>
      <a href="#section-5.4">5.4</a>. ICMP Messages .............................................<a href="#page-20">20</a>
           <a href="#section-5.4.1">5.4.1</a>. Unknown SPI ........................................<a href="#page-20">20</a>
   <a href="#section-6">6</a>. Packet Processing ..............................................<a href="#page-20">20</a>
      <a href="#section-6.1">6.1</a>. Processing Outgoing Application Data ......................<a href="#page-20">20</a>
      <a href="#section-6.2">6.2</a>. Processing Incoming Application Data ......................<a href="#page-21">21</a>
      <a href="#section-6.3">6.3</a>. HMAC and SIGNATURE Calculation and Verification ...........<a href="#page-21">21</a>
      <a href="#section-6.4">6.4</a>. Processing Incoming ESP SA Initialization (R1) ............<a href="#page-22">22</a>
      <a href="#section-6.5">6.5</a>. Processing Incoming Initialization Reply (I2) .............<a href="#page-22">22</a>
      <a href="#section-6.6">6.6</a>. Processing Incoming ESP SA Setup Finalization (R2) ........<a href="#page-23">23</a>
      <a href="#section-6.7">6.7</a>. Dropping HIP Associations .................................<a href="#page-23">23</a>
      <a href="#section-6.8">6.8</a>. Initiating ESP SA Rekeying ................................<a href="#page-23">23</a>






<span class="grey">Jokela, et al.               Standards Track                    [Page 2]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-3" id="page-3" name="page-3"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


      <a href="#section-6.9">6.9</a>. Processing Incoming UPDATE Packets ........................<a href="#page-24">24</a>
           6.9.1. Processing UPDATE Packet: No Outstanding
                  Rekeying Request ...................................<a href="#page-25">25</a>
      <a href="#section-6.10">6.10</a>. Finalizing Rekeying ......................................<a href="#page-26">26</a>
      <a href="#section-6.11">6.11</a>. Processing NOTIFY Packets ................................<a href="#page-26">26</a>
   <a href="#section-7">7</a>. Keying Material ................................................<a href="#page-27">27</a>
   <a href="#section-8">8</a>. Security Considerations ........................................<a href="#page-27">27</a>
   <a href="#section-9">9</a>. IANA Considerations ............................................<a href="#page-28">28</a>
   <a href="#section-10">10</a>. References ....................................................<a href="#page-29">29</a>
      <a href="#section-10.1">10.1</a>. Normative References .....................................<a href="#page-29">29</a>
      <a href="#section-10.2">10.2</a>. Informative References ...................................<a href="#page-30">30</a>
   <a href="#appendix-A">Appendix A</a>. A Note on Implementation Options ......................<a href="#page-32">32</a>
   <a href="#appendix-B">Appendix B</a>. Bound End-to-End Tunnel Mode for ESP ..................<a href="#page-32">32</a>
     <a href="#appendix-B.1">B.1</a>. Protocol Definition ........................................<a href="#page-33">33</a>
          <a href="#appendix-B.1.1">B.1.1</a>. Changes to Security Association Data Structures .....<a href="#page-33">33</a>
          <a href="#appendix-B.1.2">B.1.2</a>. Packet Format .......................................<a href="#page-34">34</a>
          <a href="#appendix-B.1.3">B.1.3</a>. Cryptographic Processing ............................<a href="#page-36">36</a>
          <a href="#appendix-B.1.4">B.1.4</a>. IP Header Processing ................................<a href="#page-36">36</a>
          <a href="#appendix-B.1.5">B.1.5</a>. Handling of Outgoing Packets ........................<a href="#page-37">37</a>
          <a href="#appendix-B.1.6">B.1.6</a>. Handling of Incoming Packets ........................<a href="#page-38">38</a>
          <a href="#appendix-B.1.7">B.1.7</a>. Handling of IPv4 Options ............................<a href="#page-39">39</a>
   Acknowledgments ...................................................<a href="#page-40">40</a>
   Authors' Addresses ................................................<a href="#page-40">40</a>

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/1.%20%20Introduction"></a><a class="selflink" href="#section-1" name="section-1">1</a>.  Introduction</span>

   In the Host Identity Protocol Architecture [<a href="#ref-HIP-ARCH" title='"Host Identity Protocol Architecture"'>HIP-ARCH</a>], hosts are
   identified with public keys.  The Host Identity Protocol (HIP)
   [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>] base exchange allows any two HIP-supporting hosts to
   authenticate each other and to create a HIP association between
   themselves.  During the base exchange, the hosts generate a piece of
   shared keying material using an authenticated Diffie-Hellman
   exchange.

   The HIP base exchange specification [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>] does not describe any
   transport formats or methods for user data to be used during the
   actual communication; it only defines that it is mandatory to
   implement the Encapsulating Security Payload (ESP) [<a href="rfc4303.html" title='"IP Encapsulating Security Payload (ESP)"'>RFC4303</a>] based
   transport format and method.  This document specifies how ESP is used
   with HIP to carry actual user data.

   To be more specific, this document specifies a set of HIP protocol
   extensions and their handling.  Using these extensions, a pair of ESP
   Security Associations (SAs) is created between the hosts during the
   base exchange.  The resulting ESP Security Associations use keys
   drawn from the keying material (KEYMAT) generated during the base
   exchange.  After the HIP association and required ESP SAs have been




<span class="grey">Jokela, et al.               Standards Track                    [Page 3]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-4" id="page-4" name="page-4"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   established between the hosts, the user data communication is
   protected using ESP.  In addition, this document specifies methods to
   update an existing ESP Security Association.

   It should be noted that representations of Host Identity are not
   carried explicitly in the headers of user data packets.  Instead, the
   ESP Security Parameter Index (SPI) is used to indicate the right host
   context.  The SPIs are selected during the HIP ESP setup exchange.
   For user data packets, ESP SPIs (in possible combination with IP
   addresses) are used indirectly to identify the host context, thereby
   avoiding any additional explicit protocol headers.

   HIP and ESP traffic have known issues with middlebox traversal (<a href="rfc5207.html">RFC</a>
   <a href="rfc5207.html">5207</a> [<a href="rfc5207.html" title='"NAT and Firewall Traversal Issues of Host Identity Protocol (HIP) Communication"'>RFC5207</a>]).  Other specifications exist for operating HIP and
   ESP over UDP.  (<a href="rfc5770.html">RFC 5770</a> [<a href="rfc5770.html" title='"Basic Host Identity Protocol (HIP) Extensions for Traversal of Network Address Translators"'>RFC5770</a>] is an experimental specification,
   and others are being developed.)  Middlebox traversal is out of scope
   for this document.

   This document obsoletes <a href="rfc5202.html">RFC 5202</a>.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/2.%20%20Conventions%20Used%20in%20This%20Document"></a><a class="selflink" href="#section-2" name="section-2">2</a>.  Conventions Used in This Document</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <a href="rfc2119.html">RFC 2119</a> [<a href="rfc2119.html" title='"Key words for use in RFCs to Indicate Requirement Levels"'>RFC2119</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/3.%20%20Using%20ESP%20with%20HIP"></a><a class="selflink" href="#section-3" name="section-3">3</a>.  Using ESP with HIP</span>

   The HIP base exchange is used to set up a HIP association between two
   hosts.  The base exchange provides two-way host authentication and
   key material generation, but it does not provide any means for
   protecting data communication between the hosts.  In this document,
   we specify the use of ESP for protecting user data traffic after the
   HIP base exchange.  Note that this use of ESP is intended only for
   host-to-host traffic; security gateways are not supported.

   To support ESP use, the HIP base exchange messages require some minor
   additions to the parameters transported.  In the R1 packet, the
   Responder adds the possible ESP transforms in an ESP_TRANSFORM
   parameter before sending it to the Initiator.  The Initiator gets the
   proposed transforms, selects one of those proposed transforms, and
   adds it to the I2 packet in an ESP_TRANSFORM parameter.  In this I2
   packet, the Initiator also sends the SPI value that it wants to be
   used for ESP traffic flowing from the Responder to the Initiator.
   This information is carried using the ESP_INFO parameter.  When
   finalizing the ESP SA setup, the Responder sends its SPI value to the
   Initiator in the R2 packet, again using ESP_INFO.




<span class="grey">Jokela, et al.               Standards Track                    [Page 4]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-5" id="page-5" name="page-5"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.1.%20%20ESP%20Packet%20Format"></a><a class="selflink" href="#section-3.1" name="section-3.1">3.1</a>.  ESP Packet Format</span>

   The ESP specification [<a href="rfc4303.html" title='"IP Encapsulating Security Payload (ESP)"'>RFC4303</a>] defines the ESP packet format for
   IPsec.  The HIP ESP packet looks exactly the same as the IPsec ESP
   transport format packet.  The semantics, however, are a bit different
   and are described in more detail in the next subsection.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.2.%20%20Conceptual%20ESP%20Packet%20Processing"></a><a class="selflink" href="#section-3.2" name="section-3.2">3.2</a>.  Conceptual ESP Packet Processing</span>

   ESP packet processing can be implemented in different ways in HIP.
   It is possible to implement it in a way that a standards compliant,
   unmodified IPsec implementation [<a href="rfc4303.html" title='"IP Encapsulating Security Payload (ESP)"'>RFC4303</a>] can be used in conjunction
   with some additional transport checksum processing above it, and if
   IP addresses are used as indexes to the right host context.

   When a standards compliant IPsec implementation that uses IP
   addresses in the Security Policy Database (SPD) and Security
   Association Database (SAD) is used, the packet processing may take
   the following steps.  For outgoing packets, assuming that the
   upper-layer pseudo header has been built using IP addresses, the
   implementation recalculates upper-layer checksums using Host Identity
   Tags (HITs) and, after that, changes the packet source and
   destination addresses back to corresponding IP addresses.  The packet
   is sent to the IPsec ESP for transport mode handling, and from there
   the encrypted packet is sent to the network.  When an ESP packet is
   received, the packet is first put through the IPsec ESP transport
   mode handling, and after decryption, the source and destination IP
   addresses are replaced with HITs, and finally, upper-layer checksums
   are verified before passing the packet to the upper layer.

   An alternative way to implement packet processing is the BEET (Bound
   End-to-End Tunnel) mode (see <a href="#appendix-B">Appendix B</a>).  In BEET mode, the ESP
   packet is formatted as a transport mode packet, but the semantics of
   the connection are the same as for tunnel mode.  The "outer"
   addresses of the packet are the IP addresses, and the "inner"
   addresses are the HITs.  For outgoing traffic, after the packet has
   been encrypted, the packet's IP header is changed to a new one that
   contains IP addresses instead of HITs, and the packet is sent to the
   network.  When the ESP packet is received, the SPI value, together
   with the integrity protection, allow the packet to be securely
   associated with the right HIT pair.  The packet header is replaced
   with a new header containing HITs, and the packet is decrypted.  BEET
   mode is completely internal for a host and doesn't require that the
   corresponding host implement it; instead, the corresponding host can
   have ESP transport mode and do HIT IP conversions outside ESP.






<span class="grey">Jokela, et al.               Standards Track                    [Page 5]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-6" id="page-6" name="page-6"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.2.1.%20%20Semantics%20of%20the%20Security%20Parameter%20Index%20%28SPI%29"></a><a class="selflink" href="#section-3.2.1" name="section-3.2.1">3.2.1</a>.  Semantics of the Security Parameter Index (SPI)</span>

   SPIs are used in ESP to find the right Security Association for
   received packets.  The ESP SPIs have added significance when used
   with HIP; they are a compressed representation of a pair of HITs.
   Thus, SPIs MAY be used by intermediary systems in providing services
   like address mapping.  Note that since the SPI has significance at
   the receiver, only the &lt; DST, SPI &gt;, where DST is a destination IP
   address, uniquely identifies the receiver HIT at any given point of
   time.  The same SPI value may be used by several hosts.  A single
   &lt; DST, SPI &gt; value may denote different hosts and contexts at
   different points of time, depending on the host that is currently
   reachable at the DST.

   Each host selects for itself the SPI it wants to see in packets
   received from its peer.  This allows it to select different SPIs for
   different peers.  The SPI selection SHOULD be random; the rules of
   <a href="#section-2.1">Section 2.1</a> of the ESP specification [<a href="rfc4303.html" title='"IP Encapsulating Security Payload (ESP)"'>RFC4303</a>] must be followed.  A
   different SPI SHOULD be used for each HIP exchange with a particular
   host; this is to avoid a replay attack.  Additionally, when a host
   rekeys, the SPI MUST be changed.  Furthermore, if a host changes over
   to use a different IP address, it MAY change the SPI.

   One method for SPI creation that meets the above criteria would be to
   concatenate the HIT with a 32-bit random or sequential number, hash
   this (using SHA1), and then use the high-order 32 bits as the SPI.

   The selected SPI is communicated to the peer in the third (I2) and
   fourth (R2) packets of the base HIP exchange.  Changes in SPI are
   signaled with ESP_INFO parameters.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.3.%20%20Security%20Association%20Establishment%20and%20Maintenance"></a><a class="selflink" href="#section-3.3" name="section-3.3">3.3</a>.  Security Association Establishment and Maintenance</span>

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.3.1.%20%20ESP%20Security%20Associations"></a><a class="selflink" href="#section-3.3.1" name="section-3.3.1">3.3.1</a>.  ESP Security Associations</span>

   In HIP, ESP Security Associations are set up between the HIP nodes
   during the base exchange [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>].  Existing ESP SAs can be updated
   later using UPDATE messages.  The reason for updating the ESP SA
   later can be, for example, a need for rekeying the SA because of
   sequence number rollover.

   Upon setting up a HIP association, each association is linked to two
   ESP SAs, one for incoming packets and one for outgoing packets.  The
   Initiator's incoming SA corresponds with the Responder's outgoing
   one, and vice versa.  The Initiator defines the SPI for its incoming
   association, as defined in <a href="#section-3.2.1">Section 3.2.1</a>.  This SA is herein called





<span class="grey">Jokela, et al.               Standards Track                    [Page 6]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-7" id="page-7" name="page-7"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   SA-RI, and the corresponding SPI is called SPI-RI.  Respectively, the
   Responder's incoming SA corresponds with the Initiator's outgoing SA
   and is called SA-IR, with the SPI being called SPI-IR.

   The Initiator creates SA-RI as a part of R1 processing, before
   sending out the I2, as explained in <a href="#section-6.4">Section 6.4</a>.  The keys are
   derived from KEYMAT, as defined in <a href="#section-7">Section 7</a>.  The Responder creates
   SA-RI as a part of I2 processing; see <a href="#section-6.5">Section 6.5</a>.

   The Responder creates SA-IR as a part of I2 processing, before
   sending out R2; see <a href="#section-6.5">Section 6.5</a>.  The Initiator creates SA-IR when
   processing R2; see <a href="#section-6.6">Section 6.6</a>.

   The initial session keys are drawn from the generated keying
   material, KEYMAT, after the HIP keys have been drawn as specified in
   [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>].

   When the HIP association is removed, the related ESP SAs MUST also be
   removed.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.3.2.%20%20Rekeying"></a><a class="selflink" href="#section-3.3.2" name="section-3.3.2">3.3.2</a>.  Rekeying</span>

   After the initial HIP base exchange and SA establishment, both hosts
   are in the ESTABLISHED state.  There are no longer Initiator and
   Responder roles, and the association is symmetric.  In this
   subsection, the party that initiates the rekey procedure is denoted
   with I' and the peer with R'.

   An existing HIP-created ESP SA may need updating during the lifetime
   of the HIP association.  This document specifies the rekeying of an
   existing HIP-created ESP SA, using the UPDATE message.  The ESP_INFO
   parameter introduced above is used for this purpose.

   I' initiates the ESP SA updating process when needed (see
   <a href="#section-6.8">Section 6.8</a>).  It creates an UPDATE packet with required information
   and sends it to the peer node.  The old SAs are still in use, local
   policy permitting.

   R', after receiving and processing the UPDATE (see <a href="#section-6.9">Section 6.9</a>),
   generates new SAs: SA-I'R' and SA-R'I'.  It does not take the new
   outgoing SA into use, but still uses the old one, so there
   temporarily exist two SA pairs towards the same peer host.  The SPI
   for the new outgoing SA, SPI-R'I', is specified in the received
   ESP_INFO parameter in the UPDATE packet.  For the new incoming SA, R'
   generates the new SPI value, SPI-I'R', and includes it in the
   response UPDATE packet.





<span class="grey">Jokela, et al.               Standards Track                    [Page 7]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-8" id="page-8" name="page-8"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   When I' receives a response UPDATE from R', it generates new SAs, as
   described in <a href="#section-6.9">Section 6.9</a>: SA-I'R' and SA-R'I'.  It starts using the
   new outgoing SA immediately.

   R' starts using the new outgoing SA when it receives traffic on the
   new incoming SA or when it receives the UPDATE ACK confirming
   completion of rekeying.  After this, R' can remove the old SAs.
   Similarly, when the I' receives traffic from the new incoming SA, it
   can safely remove the old SAs.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.3.3.%20%20Security%20Association%20Management"></a><a class="selflink" href="#section-3.3.3" name="section-3.3.3">3.3.3</a>.  Security Association Management</span>

   An SA pair is indexed by the 2 SPIs and 2 HITs (both local and remote
   HITs since a system can have more than one HIT).  An inactivity timer
   is RECOMMENDED for all SAs.  If the state dictates the deletion of an
   SA, a timer is set to allow for any late arriving packets.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.3.4.%20%20Security%20Parameter%20Index%20%28SPI%29"></a><a class="selflink" href="#section-3.3.4" name="section-3.3.4">3.3.4</a>.  Security Parameter Index (SPI)</span>

   The SPIs in ESP provide a simple compression of the HIP data from all
   packets after the HIP exchange.  This does require a per HIT-pair
   Security Association (and SPI), and a decrease of policy granularity
   over other Key Management Protocols like Internet Key Exchange (IKE)
   [<a href="rfc7296.html" title='"Internet Key Exchange Protocol Version 2 (IKEv2)"'>RFC7296</a>].

   When a host updates the ESP SA, it provides a new inbound SPI to and
   gets a new outbound SPI from its peer.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.3.5.%20%20Supported%20Ciphers"></a><a class="selflink" href="#section-3.3.5" name="section-3.3.5">3.3.5</a>.  Supported Ciphers</span>

   All HIP implementations MUST support AES-128-CBC and AES-256-CBC
   [<a href="rfc3602.html" title='"The AES-CBC Cipher Algorithm and Its Use with IPsec"'>RFC3602</a>].  If the Initiator does not support any of the transforms
   offered by the Responder, it should abandon the negotiation and
   inform the peer with a NOTIFY message about a non-supported
   transform.

   In addition to AES-128-CBC, all implementations SHOULD implement the
   ESP NULL encryption algorithm.  When the ESP NULL encryption is used,
   it MUST be used together with SHA-256 authentication as specified in
   <a href="#section-5.1.2">Section 5.1.2</a>.

   When an authentication-only suite is used (NULL, AES-CMAC-96, and
   AES-GMAC are examples), the suite MUST NOT be accepted if offered by
   the peer unless the local policy configuration regarding the peer
   host is explicitly set to allow an authentication-only mode.  This is
   to prevent sessions from being downgraded to an authentication-only
   mode when one side's policy requests privacy for the session.




<span class="grey">Jokela, et al.               Standards Track                    [Page 8]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-9" id="page-9" name="page-9"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.3.6.%20%20Sequence%20Number"></a><a class="selflink" href="#section-3.3.6" name="section-3.3.6">3.3.6</a>.  Sequence Number</span>

   The Sequence Number field is MANDATORY when ESP is used with HIP.
   Anti-replay protection MUST be used in an ESP SA established with
   HIP.  When ESP is used with HIP, a 64-bit sequence number MUST be
   used.  This means that each host MUST rekey before its sequence
   number reaches 2^64.

   When using a 64-bit sequence number, the higher 32 bits are NOT
   included in the ESP header, but are simply kept local to both peers.
   See [<a href="rfc4301.html" title='"Security Architecture for the Internet Protocol"'>RFC4301</a>].

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.3.7.%20%20Lifetimes%20and%20Timers"></a><a class="selflink" href="#section-3.3.7" name="section-3.3.7">3.3.7</a>.  Lifetimes and Timers</span>

   HIP does not negotiate any lifetimes.  All ESP lifetimes are local
   policy.  The only lifetimes a HIP implementation MUST support are
   sequence number rollover (for replay protection), and SHOULD support
   timing out inactive ESP SAs.  An SA times out if no packets are
   received using that SA.  Implementations SHOULD support a
   configurable SA timeout value.  Implementations MAY support lifetimes
   for the various ESP transforms.  Each implementation SHOULD implement
   per-HIT configuration of the inactivity timeout, allowing statically
   configured HIP associations to stay alive for days, even when
   inactive.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.4.%20%20IPsec%20and%20HIP%20ESP%20Implementation%20Considerations"></a><a class="selflink" href="#section-3.4" name="section-3.4">3.4</a>.  IPsec and HIP ESP Implementation Considerations</span>

   When HIP is run on a node where a standards compliant IPsec is used,
   some issues have to be considered.

   The HIP implementation must be able to co-exist with other IPsec
   keying protocols.  When the HIP implementation selects the SPI value,
   it may lead to a collision if not implemented properly.  To avoid the
   possibility for a collision, the HIP implementation MUST ensure that
   the SPI values used for HIP SAs are not used for IPsec or other SAs,
   and vice versa.

   Incoming packets using an SA that is not negotiated by HIP MUST NOT
   be processed as described in <a href="#section-3.2">Section 3.2</a>, paragraph 2.  The SPI will
   identify the correct SA for packet decryption and MUST be used to
   identify that the packet has an upper-layer checksum that is
   calculated as specified in [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>].









<span class="grey">Jokela, et al.               Standards Track                    [Page 9]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-10" id="page-10" name="page-10"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.4.1.%20%20Data%20Packet%20Processing%20Considerations"></a><a class="selflink" href="#section-3.4.1" name="section-3.4.1">3.4.1</a>.  Data Packet Processing Considerations</span>

   For outbound traffic, the SPD (or coordinated SPDs, if there are two
   -- one for HIP and one for IPsec) MUST ensure that packets intended
   for HIP processing are given a HIP-enabled SA and that packets
   intended for IPsec processing are given an IPsec-enabled SA.  The SP
   then MUST be bound to the matching SA, and non-HIP packets will not
   be processed by this SA.  Data originating from a socket that is not
   using HIP MUST NOT have the checksum recalculated (as described in
   <a href="#section-3.2">Section 3.2</a>, paragraph 2), and data MUST NOT be passed to the SP or
   SA created by HIP.

   It is possible that in the case of overlapping policies, the outgoing
   packet would be handled by both IPsec and HIP.  In this case, it is
   possible that the HIP association is end to end, while the IPsec SA
   is for encryption between the HIP host and a security gateway.  In
   the case of a security gateway ESP association, the ESP always uses
   tunnel mode.

   In the case of IPsec tunnel mode, it is hard to see during the HIP SA
   processing if the IPsec ESP SA has the same final destination.  Thus,
   traffic MUST be encrypted with both the HIP ESP SA and the IPsec SA
   when the IPsec ESP SA is used in tunnel mode.

   In the case of IPsec transport mode, the connection endpoints are the
   same.  However, for HIP data packets it is not possible to avoid HIP
   SA processing, while mapping the HIP data packet's IP addresses to
   the corresponding HITs requires SPI values from the ESP header.  In
   the case of a transport mode IPsec SA, the IPsec encryption MAY be
   skipped to avoid double encryption, if the local policy allows.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.4.2.%20%20HIP%20Signaling%20Packet%20Considerations"></a><a class="selflink" href="#section-3.4.2" name="section-3.4.2">3.4.2</a>.  HIP Signaling Packet Considerations</span>

   In general, HIP signaling packets should follow the same processing
   as HIP data packets.

   In the case of IPsec tunnel mode, the HIP signaling packets are
   always encrypted using an IPsec ESP SA.  Note that this hides the HIP
   signaling packets from the eventual HIP middleboxes on the path
   between the originating host and the security gateway.

   In the case of IPsec transport mode, the HIP signaling packets MAY
   skip the IPsec ESP SA encryption if the local policy allows.  This
   allows the eventual HIP middleboxes to handle the passing HIP
   signaling packets.






<span class="grey">Jokela, et al.               Standards Track                   [Page 10]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-11" id="page-11" name="page-11"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/4.%20%20The%20Protocol"></a><a class="selflink" href="#section-4" name="section-4">4</a>.  The Protocol</span>

   In this section, the protocol for setting up an ESP association to be
   used with a HIP association is described.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.1.%20%20ESP%20in%20HIP"></a><a class="selflink" href="#section-4.1" name="section-4.1">4.1</a>.  ESP in HIP</span>

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/4.1.1.%20%20IPsec%20ESP%20Transport%20Format%20Type"></a><a class="selflink" href="#section-4.1.1" name="section-4.1.1">4.1.1</a>.  IPsec ESP Transport Format Type</span>

   The HIP handshake signals the TRANSPORT_FORMAT_LIST parameter in the
   R1 and I2 messages.  This parameter contains a list of the supported
   HIP transport formats of the sending host, in the order of
   preference.  The transport format type for IPsec ESP is the type
   number of the ESP_TRANSFORM parameter, i.e., 4095.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/4.1.2.%20%20Setting%20Up%20an%20ESP%20Security%20Association"></a><a class="selflink" href="#section-4.1.2" name="section-4.1.2">4.1.2</a>.  Setting Up an ESP Security Association</span>

   Setting up an ESP Security Association between hosts using HIP is
   performed by including parameters in the last three messages (R1, I2,
   and R2 messages) of the four-message HIP base exchange.

             Initiator                             Responder

                                   I1
                   ----------------------------------&gt;

                             R1: ESP_TRANSFORM
                   &lt;----------------------------------

                       I2: ESP_TRANSFORM, ESP_INFO
                   ----------------------------------&gt;

                               R2: ESP_INFO
                   &lt;----------------------------------

   The R1 message contains the ESP_TRANSFORM parameter, in which the
   sending host defines the possible ESP transforms it is willing to use
   for the ESP SA.

   Including the ESP_TRANSFORM parameter in the R1 message adds clarity
   to the TRANSPORT_FORMAT_LIST but may initiate negotiations for
   possibly unselected transforms.  However, resource-constrained
   devices will most likely restrict support to a single transform for
   the sake of minimizing ROM overhead, and the additional parameter
   adds negligible overhead with unconstrained devices.






<span class="grey">Jokela, et al.               Standards Track                   [Page 11]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-12" id="page-12" name="page-12"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   The I2 message contains the response to an ESP_TRANSFORM received in
   the R1 message.  The sender must select one of the proposed ESP
   transforms from the ESP_TRANSFORM parameter in the R1 message and
   include the selected one in the ESP_TRANSFORM parameter in the I2
   packet.  In addition to the transform, the host includes the ESP_INFO
   parameter containing the SPI value to be used by the peer host.

   In the R2 message, the ESP SA setup is finalized.  The packet
   contains the SPI information required by the Initiator for the
   ESP SA.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/4.1.3.%20%20Updating%20an%20Existing%20ESP%20SA"></a><a class="selflink" href="#section-4.1.3" name="section-4.1.3">4.1.3</a>.  Updating an Existing ESP SA</span>

   The update process is accomplished using three messages.  The HIP
   UPDATE message is used to update the parameters of an existing ESP
   SA.  The UPDATE mechanism and message are defined in [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>], and
   the additional parameters for updating an existing ESP SA are
   described here.

   The following picture shows a typical exchange when an existing ESP
   SA is updated.  Messages include SEQ and ACK parameters required by
   the UPDATE mechanism.

       H1                                                        H2
            UPDATE: SEQ, ESP_INFO [, DIFFIE_HELLMAN]
          -----------------------------------------------------&gt;

            UPDATE: SEQ, ACK, ESP_INFO [, DIFFIE_HELLMAN]
          &lt;-----------------------------------------------------

            UPDATE: ACK
          -----------------------------------------------------&gt;

   The host willing to update the ESP SA creates and sends an UPDATE
   message.  The message contains the ESP_INFO parameter containing the
   old SPI value that was used, the new SPI value to be used, and the
   index value for the keying material, giving the point from where the
   next keys will be drawn.  If new keying material must be generated,
   the UPDATE message will also contain the DIFFIE_HELLMAN parameter
   defined in [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>].

   The host receiving the UPDATE message requesting update of an
   existing ESP SA MUST reply with an UPDATE message.  In the reply
   message, the host sends the ESP_INFO parameter containing the
   corresponding values: old SPI, new SPI, and the keying material
   index.  If the incoming UPDATE contained a DIFFIE_HELLMAN parameter,
   the reply packet MUST also contain a DIFFIE_HELLMAN parameter.




<span class="grey">Jokela, et al.               Standards Track                   [Page 12]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-13" id="page-13" name="page-13"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/5.%20%20Parameter%20and%20Packet%20Formats"></a><a class="selflink" href="#section-5" name="section-5">5</a>.  Parameter and Packet Formats</span>

   In this section, new and modified HIP parameters are presented, as
   well as modified HIP packets.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/5.1.%20%20New%20Parameters"></a><a class="selflink" href="#section-5.1" name="section-5.1">5.1</a>.  New Parameters</span>

   Two HIP parameters are defined for setting up ESP transport format
   associations in HIP communication and for rekeying existing ones.
   Also, the NOTIFICATION parameter, described in [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>], has two
   error values defined for this specification.

      Parameter         Type  Length     Data

      ESP_INFO          65    12         Remote's old SPI,
                                         new SPI, and other info
      ESP_TRANSFORM     4095  variable   ESP Encryption and
                                         Authentication Transform(s)

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.1.1.%20%20ESP_INFO"></a><a class="selflink" href="#section-5.1.1" name="section-5.1.1">5.1.1</a>.  ESP_INFO</span>

   During the establishment and update of an ESP SA, the SPI value of
   both hosts must be transmitted between the hosts.  In addition, hosts
   need the index value to the KEYMAT when they are drawing keys from
   the generated keying material.  The ESP_INFO parameter is used to
   transmit the SPI values and the KEYMAT index information between the
   hosts.

   During the initial ESP SA setup, the hosts send the SPI value that
   they want the peer to use when sending ESP data to them.  The value
   is set in the NEW SPI field of the ESP_INFO parameter.  In the
   initial setup, an old value for the SPI does not exist; thus, the OLD
   SPI field value is set to zero.  The OLD SPI field value may also be
   zero when additional SAs are set up between HIP hosts, e.g., in the
   case of multihomed HIP hosts [<a href="rfc5206.html" title='"End-Host Mobility and Multihoming with the Host Identity Protocol"'>RFC5206</a>].  However, such use is beyond
   the scope of this specification.

   The KEYMAT index value points to the place in the KEYMAT from where
   the keying material for the ESP SAs is drawn.  The KEYMAT index value
   is zero only when the ESP_INFO is sent during a rekeying process and
   new keying material is generated.

   During the life of an SA established by HIP, one of the hosts may
   need to reset the Sequence Number to one and rekey.  The reason for
   rekeying might be an approaching sequence number wrap in ESP, or a
   local policy on the use of a key.  Rekeying ends the current SAs and
   starts new ones on both peers.




<span class="grey">Jokela, et al.               Standards Track                   [Page 13]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-14" id="page-14" name="page-14"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   During the rekeying process, the ESP_INFO parameter is used to
   transmit the changed SPI values and the keying material index.

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |             Type              |             Length            |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |           Reserved            |         KEYMAT Index          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                            OLD SPI                            |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                            NEW SPI                            |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

      Type           65
      Length         12
      KEYMAT Index   index, in bytes, where to continue to draw ESP keys
                     from KEYMAT.  If the packet includes a new
                     Diffie-Hellman key and the ESP_INFO is sent in an
                     UPDATE packet, the field MUST be zero.  If the
                     ESP_INFO is included in base exchange messages, the
                     KEYMAT Index must have the index value of the point
                     from where the ESP SA keys are drawn.  Note that
                     the length of this field limits the amount of
                     keying material that can be drawn from KEYMAT.  If
                     that amount is exceeded, the packet MUST contain
                     a new Diffie-Hellman key.
      OLD SPI        old SPI for data sent to address(es) associated
                     with this SA.  If this is an initial SA setup, the
                     OLD SPI value is zero.
      NEW SPI        new SPI for data sent to address(es) associated
                     with this SA.


















<span class="grey">Jokela, et al.               Standards Track                   [Page 14]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-15" id="page-15" name="page-15"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.1.2.%20%20ESP_TRANSFORM"></a><a class="selflink" href="#section-5.1.2" name="section-5.1.2">5.1.2</a>.  ESP_TRANSFORM</span>

   The ESP_TRANSFORM parameter is used during ESP SA establishment.  The
   first party sends a selection of transform families in the
   ESP_TRANSFORM parameter, and the peer must select one of the proposed
   values and include it in the response ESP_TRANSFORM parameter.

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |             Type              |             Length            |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |          Reserved             |           Suite ID #1         |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |          Suite ID #2          |           Suite ID #3         |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |          Suite ID #n          |             Padding           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

      Type           4095
      Length         length in octets, excluding Type, Length, and
                     padding.
      Reserved       zero when sent, ignored when received.
      Suite ID       defines the ESP Suite to be used.

   The following Suite IDs can be used:

            Suite ID                          Value

            RESERVED                          0   [<a href="rfc7402.html">RFC7402</a>]
            AES-128-CBC with HMAC-SHA1        1   [<a href="rfc3602.html" title='"The AES-CBC Cipher Algorithm and Its Use with IPsec"'>RFC3602</a>], [<a href="rfc2404.html" title='"The Use of HMAC-SHA-1-96 within ESP and AH"'>RFC2404</a>]
            DEPRECATED                        2   [<a href="rfc7402.html">RFC7402</a>]
            DEPRECATED                        3   [<a href="rfc7402.html">RFC7402</a>]
            DEPRECATED                        4   [<a href="rfc7402.html">RFC7402</a>]
            DEPRECATED                        5   [<a href="rfc7402.html">RFC7402</a>]
            DEPRECATED                        6   [<a href="rfc7402.html">RFC7402</a>]
            NULL with HMAC-SHA-256            7   [<a href="rfc2410.html" title='"The NULL Encryption Algorithm and Its Use With IPsec"'>RFC2410</a>], [<a href="rfc4868.html" title='"Using HMAC-SHA-256, HMAC-SHA-384, and HMAC-SHA-512 with IPsec"'>RFC4868</a>]
            AES-128-CBC with HMAC-SHA-256     8   [<a href="rfc3602.html" title='"The AES-CBC Cipher Algorithm and Its Use with IPsec"'>RFC3602</a>], [<a href="rfc4868.html" title='"Using HMAC-SHA-256, HMAC-SHA-384, and HMAC-SHA-512 with IPsec"'>RFC4868</a>]
            AES-256-CBC with HMAC-SHA-256     9   [<a href="rfc3602.html" title='"The AES-CBC Cipher Algorithm and Its Use with IPsec"'>RFC3602</a>], [<a href="rfc4868.html" title='"Using HMAC-SHA-256, HMAC-SHA-384, and HMAC-SHA-512 with IPsec"'>RFC4868</a>]
            AES-CCM-8                         10  [<a href="rfc4309.html" title='"Using Advanced Encryption Standard (AES) CCM Mode with IPsec Encapsulating Security Payload (ESP)"'>RFC4309</a>]
            AES-CCM-16                        11  [<a href="rfc4309.html" title='"Using Advanced Encryption Standard (AES) CCM Mode with IPsec Encapsulating Security Payload (ESP)"'>RFC4309</a>]
            AES-GCM with an 8-octet ICV       12  [<a href="rfc4106.html" title='"The Use of Galois/Counter Mode (GCM) in IPsec Encapsulating Security Payload (ESP)"'>RFC4106</a>]
            AES-GCM with a 16-octet ICV       13  [<a href="rfc4106.html" title='"The Use of Galois/Counter Mode (GCM) in IPsec Encapsulating Security Payload (ESP)"'>RFC4106</a>]
            AES-CMAC-96                       14  [<a href="rfc4493.html" title='"The AES-CMAC Algorithm"'>RFC4493</a>], [<a href="rfc4494.html" title='"The AES-CMAC-96 Algorithm and Its Use with IPsec"'>RFC4494</a>]
            AES-GMAC                          15  [<a href="rfc4543.html" title='"The Use of Galois Message Authentication Code (GMAC) in IPsec ESP and AH"'>RFC4543</a>]






<span class="grey">Jokela, et al.               Standards Track                   [Page 15]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-16" id="page-16" name="page-16"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   The sender of an ESP transform parameter MUST make sure that there
   are no more than six (6) Suite IDs in one ESP transform parameter.
   Conversely, a recipient MUST be prepared to handle received transform
   parameters that contain more than six Suite IDs.  The limited number
   of Suite IDs sets the maximum size of the ESP_TRANSFORM parameter.
   As the default configuration, the ESP_TRANSFORM parameter MUST
   contain at least one of the mandatory Suite IDs.  There MAY be a
   configuration option that allows the administrator to override this
   default.

   Mandatory implementations: AES-128-CBC with HMAC-SHA-256.  NULL with
   HMAC-SHA-256 SHOULD also be supported (see also <a href="#section-3.3.5">Section 3.3.5</a>).

   Under some conditions, it is possible to use Traffic Flow
   Confidentiality (TFC) [<a href="rfc4303.html" title='"IP Encapsulating Security Payload (ESP)"'>RFC4303</a>] with ESP in BEET mode.  However, the
   definition of such an operation is left for future work and must be
   done in a separate specification.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.1.3.%20%20NOTIFICATION%20Parameter"></a><a class="selflink" href="#section-5.1.3" name="section-5.1.3">5.1.3</a>.  NOTIFICATION Parameter</span>

   The HIP base specification defines a set of NOTIFICATION error types.
   The following error types are required for describing errors in ESP
   Transform crypto suites during negotiation.

         NOTIFICATION PARAMETER - ERROR TYPES     Value
         ------------------------------------     -----

         NO_ESP_PROPOSAL_CHOSEN                    18

            None of the proposed ESP Transform crypto suites was
            acceptable.

         INVALID_ESP_TRANSFORM_CHOSEN              19

            The ESP Transform crypto suite does not correspond to
            one offered by the Responder.















<span class="grey">Jokela, et al.               Standards Track                   [Page 16]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-17" id="page-17" name="page-17"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/5.2.%20%20HIP%20ESP%20Security%20Association%20Setup"></a><a class="selflink" href="#section-5.2" name="section-5.2">5.2</a>.  HIP ESP Security Association Setup</span>

   The ESP Security Association is set up during the base exchange.  The
   following subsections define the ESP SA setup procedure using both
   base exchange messages (R1, I2, R2) and UPDATE messages.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.2.1.%20%20Setup%20during%20Base%20Exchange"></a><a class="selflink" href="#section-5.2.1" name="section-5.2.1">5.2.1</a>.  Setup during Base Exchange</span>

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/5.2.1.1.%20%20Modifications%20in%20R1"></a><a class="selflink" href="#section-5.2.1.1" name="section-5.2.1.1">5.2.1.1</a>.  Modifications in R1</span>

   The ESP_TRANSFORM contains the ESP modes supported by the sender,
   in the order of preference.  All implementations MUST support
   AES-128-CBC [<a href="rfc3602.html" title='"The AES-CBC Cipher Algorithm and Its Use with IPsec"'>RFC3602</a>] with HMAC-SHA-256 [<a href="rfc4868.html" title='"Using HMAC-SHA-256, HMAC-SHA-384, and HMAC-SHA-512 with IPsec"'>RFC4868</a>].

   The following figure shows the resulting R1 packet layout.

      The HIP parameters for the R1 packet:

      IP ( HIP ( [ R1_COUNTER, ]
                 PUZZLE,
                 DIFFIE_HELLMAN,
                 HIP_CIPHER,
                 ESP_TRANSFORM,
                 HOST_ID,
                 [ ECHO_REQUEST, ]
                 HIP_SIGNATURE_2 )
                 [, ECHO_REQUEST ])

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/5.2.1.2.%20%20Modifications%20in%20I2"></a><a class="selflink" href="#section-5.2.1.2" name="section-5.2.1.2">5.2.1.2</a>.  Modifications in I2</span>

   The ESP_INFO contains the sender's SPI for this association as well
   as the KEYMAT index from where the ESP SA keys will be drawn.  The
   old SPI value is set to zero.

   The ESP_TRANSFORM contains the ESP mode selected by the sender of R1.
   All implementations MUST support AES-128-CBC [<a href="rfc3602.html" title='"The AES-CBC Cipher Algorithm and Its Use with IPsec"'>RFC3602</a>] with
   HMAC-SHA-256 [<a href="rfc4868.html" title='"Using HMAC-SHA-256, HMAC-SHA-384, and HMAC-SHA-512 with IPsec"'>RFC4868</a>].














<span class="grey">Jokela, et al.               Standards Track                   [Page 17]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-18" id="page-18" name="page-18"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   The following figure shows the resulting I2 packet layout.

      The HIP parameters for the I2 packet:

      IP ( HIP ( ESP_INFO,
                 [R1_COUNTER,]
                 SOLUTION,
                 DIFFIE_HELLMAN,
                 HIP_CIPHER,
                 ESP_TRANSFORM,
                 ENCRYPTED { HOST_ID },
                 [ ECHO_RESPONSE ,]
                 HMAC,
                 HIP_SIGNATURE
                 [, ECHO_RESPONSE] ) )

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/5.2.1.3.%20%20Modifications%20in%20R2"></a><a class="selflink" href="#section-5.2.1.3" name="section-5.2.1.3">5.2.1.3</a>.  Modifications in R2</span>

   The R2 contains an ESP_INFO parameter, which has the SPI value of the
   sender of the R2 for this association.  The ESP_INFO also has the
   KEYMAT index value specifying where the ESP SA keys are drawn.

   The following figure shows the resulting R2 packet layout.

      The HIP parameters for the R2 packet:

      IP ( HIP ( ESP_INFO, HMAC_2, HIP_SIGNATURE ) )

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/5.3.%20%20HIP%20ESP%20Rekeying"></a><a class="selflink" href="#section-5.3" name="section-5.3">5.3</a>.  HIP ESP Rekeying</span>

   In this section, the procedure for rekeying an existing ESP SA is
   presented.

   Conceptually, the process can be represented by the following message
   sequence using the host names I' and R' defined in <a href="#section-3.3.2">Section 3.3.2</a>.
   For simplicity, HMAC and HIP_SIGNATURE are not depicted, and
   DIFFIE_HELLMAN keys are optional.  The UPDATE with ACK_I need not be
   piggybacked with the UPDATE with SEQ_R; it may be ACKed separately
   (in which case the sequence would include four packets).

           I'                                  R'

                 UPDATE(ESP_INFO, SEQ_I, [DIFFIE_HELLMAN])
            -----------------------------------&gt;
                 UPDATE(ESP_INFO, SEQ_R, ACK_I, [DIFFIE_HELLMAN])
            &lt;-----------------------------------
                 UPDATE(ACK_R)
            -----------------------------------&gt;



<span class="grey">Jokela, et al.               Standards Track                   [Page 18]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-19" id="page-19" name="page-19"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   Below, the first two packets in this figure are explained.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.3.1.%20%20Initializing%20Rekeying"></a><a class="selflink" href="#section-5.3.1" name="section-5.3.1">5.3.1</a>.  Initializing Rekeying</span>

   When HIP is used with ESP, the UPDATE packet is used to initiate
   rekeying.  The UPDATE packet MUST carry an ESP_INFO and MAY carry a
   DIFFIE_HELLMAN parameter.

   Intermediate systems that use the SPI will have to inspect HIP
   packets for those that carry rekeying information.  The packet is
   signed for the benefit of the intermediate systems.  Since
   intermediate systems may need the new SPI values, the contents cannot
   be encrypted.

   The following figure shows the contents of a rekeying initialization
   UPDATE packet.

      The HIP parameters for the UPDATE packet initiating rekeying:

      IP ( HIP ( ESP_INFO,
                 SEQ,
                 [DIFFIE_HELLMAN, ]
                 HMAC,
                 HIP_SIGNATURE ) )

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.3.2.%20%20Responding%20to%20the%20Rekeying%20Initialization"></a><a class="selflink" href="#section-5.3.2" name="section-5.3.2">5.3.2</a>.  Responding to the Rekeying Initialization</span>

   The UPDATE ACK is used to acknowledge the received UPDATE rekeying
   initialization.  The acknowledgment UPDATE packet MUST carry an
   ESP_INFO and MAY carry a DIFFIE_HELLMAN parameter.

   Intermediate systems that use the SPI will have to inspect HIP
   packets for packets carrying rekeying information.  The packet is
   signed for the benefit of the intermediate systems.  Since
   intermediate systems may need the new SPI values, the contents cannot
   be encrypted.

   The following figure shows the contents of a rekeying acknowledgment
   UPDATE packet.

      The HIP parameters for the UPDATE packet:

      IP ( HIP ( ESP_INFO,
                 SEQ,
                 ACK,
                 [ DIFFIE_HELLMAN, ]
                 HMAC,
                 HIP_SIGNATURE ) )



<span class="grey">Jokela, et al.               Standards Track                   [Page 19]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-20" id="page-20" name="page-20"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/5.4.%20%20ICMP%20Messages"></a><a class="selflink" href="#section-5.4" name="section-5.4">5.4</a>.  ICMP Messages</span>

   ICMP message handling is mainly described in the HIP base
   specification [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>].  In this section, we describe the actions
   related to ESP security associations.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.4.1.%20%20Unknown%20SPI"></a><a class="selflink" href="#section-5.4.1" name="section-5.4.1">5.4.1</a>.  Unknown SPI</span>

   If a HIP implementation receives an ESP packet that has an
   unrecognized SPI number, it MAY respond (subject to rate limiting the
   responses) with an ICMP packet with type "Parameter Problem", with
   the pointer pointing to the beginning of the SPI field in the ESP
   header.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/6.%20%20Packet%20Processing"></a><a class="selflink" href="#section-6" name="section-6">6</a>.  Packet Processing</span>

   Packet processing is mainly defined in the HIP base specification
   [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>].  This section describes the changes and new requirements
   for packet handling when the ESP transport format is used.  Note that
   all HIP packets (currently protocol 139) MUST bypass ESP processing.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.1.%20%20Processing%20Outgoing%20Application%20Data"></a><a class="selflink" href="#section-6.1" name="section-6.1">6.1</a>.  Processing Outgoing Application Data</span>

   Outgoing application data handling is specified in the HIP base
   specification [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>].  When the ESP transport format is used, and
   there is an active HIP session for the given &lt; source, destination &gt;
   HIT pair, the outgoing datagram is protected using the ESP security
   association.  The following additional steps define the conceptual
   processing rules for outgoing ESP protected datagrams.

   1.  Detect the proper ESP SA using the HITs in the packet header or
       other information associated with the packet.

   2.  Process the packet normally, as if the SA was a transport
       mode SA.

   3.  Ensure that the outgoing ESP protected packet has proper IP
       header format, depending on the used IP address family, and
       proper IP addresses in its IP header, e.g., by replacing HITs
       left by the ESP processing.  Note that this placement of proper
       IP addresses MAY also be performed at some other point in the
       stack, e.g., before ESP processing.









<span class="grey">Jokela, et al.               Standards Track                   [Page 20]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-21" id="page-21" name="page-21"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.2.%20%20Processing%20Incoming%20Application%20Data"></a><a class="selflink" href="#section-6.2" name="section-6.2">6.2</a>.  Processing Incoming Application Data</span>

   Incoming HIP user data packets arrive as ESP protected packets.  In
   the usual case, the receiving host has a corresponding ESP security
   association, identified by the SPI and destination IP address in the
   packet.  However, if the host has crashed or otherwise lost its HIP
   state, it may not have such an SA.

   The basic incoming data handling is specified in the HIP base
   specification.  Additional steps are required when ESP is used for
   protecting the data traffic.  The following steps define the
   conceptual processing rules for incoming ESP protected datagrams
   targeted to an ESP security association created with HIP.

   1.  Detect the proper ESP SA using the SPI.  If the resulting SA is a
       non-HIP ESP SA, process the packet according to standard IPsec
       rules.  If there are no SAs identified with the SPI, the host MAY
       send an ICMP packet as defined in <a href="#section-5.4">Section 5.4</a>.  How to handle
       lost state is an implementation issue.

   2.  If the SPI matches with an active HIP-based ESP SA, the IP
       addresses in the datagram are replaced with the HITs associated
       with the SPI.  Note that this IP-address-to-HIT conversion step
       MAY also be performed at some other point in the stack, e.g.,
       after ESP processing.  Note also that if the incoming packet has
       IPv4 addresses, the packet must be converted to IPv6 format
       before replacing the addresses with HITs (such that the transport
       checksum will pass if there are no errors).

   3.  The transformed packet is next processed normally by ESP, as if
       the packet were a transport mode packet.  The packet may be
       dropped by ESP, as usual.  In a typical implementation, the
       result of successful ESP decryption and verification is a
       datagram with the associated HITs as source and destination.

   4.  The datagram is delivered to the upper layer.  Demultiplexing the
       datagram to the right upper-layer socket is performed as usual,
       except that the HITs are used in place of IP addresses during the
       demultiplexing.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.3.%20%20HMAC%20and%20SIGNATURE%20Calculation%20and%20Verification"></a><a class="selflink" href="#section-6.3" name="section-6.3">6.3</a>.  HMAC and SIGNATURE Calculation and Verification</span>

   The new HIP parameters described in this document, ESP_INFO and
   ESP_TRANSFORM, must be protected using HMAC and signature
   calculations.  In a typical implementation, they are included in R1,
   I2, R2, and UPDATE packet HMAC and SIGNATURE calculations as
   described in [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>].




<span class="grey">Jokela, et al.               Standards Track                   [Page 21]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-22" id="page-22" name="page-22"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.4.%20%20Processing%20Incoming%20ESP%20SA%20Initialization%20%28R1%29"></a><a class="selflink" href="#section-6.4" name="section-6.4">6.4</a>.  Processing Incoming ESP SA Initialization (R1)</span>

   The ESP SA setup is initialized in the R1 message.  The receiving
   host (Initiator) selects one of the ESP transforms from the presented
   values.  If no suitable value is found, the negotiation is
   terminated.  The selected values are subsequently used when
   generating and using encryption keys, and when sending the reply
   packet.  If the proposed alternatives are not acceptable to the
   system, it may abandon the ESP SA establishment negotiation, or it
   may resend the I1 message within the retry bounds.

   After selecting the ESP transform and performing other R1
   processing, the system prepares and creates an incoming ESP security
   association.  It may also prepare a security association for outgoing
   traffic, but since it does not have the correct SPI value yet, it
   cannot activate it.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.5.%20%20Processing%20Incoming%20Initialization%20Reply%20%28I2%29"></a><a class="selflink" href="#section-6.5" name="section-6.5">6.5</a>.  Processing Incoming Initialization Reply (I2)</span>

   The following steps are required to process the incoming ESP SA
   initialization replies in I2.  The steps below assume that the I2 has
   been accepted for processing (e.g., has not been dropped due to HIT
   comparisons as described in [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>]).

   o  The ESP_TRANSFORM parameter is verified, and it MUST contain a
      single value in the parameter; and it MUST match one of the values
      offered in the initialization packet.

   o  The ESP_INFO NEW SPI field is parsed to obtain the SPI that will
      be used for the Security Association outbound from the Responder
      and inbound to the Initiator.  For this initial ESP SA
      establishment, the old SPI value MUST be zero.  The KEYMAT Index
      field MUST contain the index value to the KEYMAT from where the
      ESP SA keys are drawn.

   o  The system prepares and creates both incoming and outgoing ESP
      security associations.

   o  Upon successful processing of the initialization reply message,
      the possible old Security Associations (as left over from an
      earlier incarnation of the HIP association) are dropped and the
      new ones are installed, and a finalizing packet, R2, is sent.
      Possible ongoing rekeying attempts are dropped.








<span class="grey">Jokela, et al.               Standards Track                   [Page 22]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-23" id="page-23" name="page-23"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.6.%20%20Processing%20Incoming%20ESP%20SA%20Setup%20Finalization%20%28R2%29"></a><a class="selflink" href="#section-6.6" name="section-6.6">6.6</a>.  Processing Incoming ESP SA Setup Finalization (R2)</span>

   Before the ESP SA can be finalized, the ESP_INFO NEW SPI field is
   parsed to obtain the SPI that will be used for the ESP Security
   Association inbound to the sender of the finalization message R2.
   The system uses this SPI to create or activate the outgoing ESP
   security association used for sending packets to the peer.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.7.%20%20Dropping%20HIP%20Associations"></a><a class="selflink" href="#section-6.7" name="section-6.7">6.7</a>.  Dropping HIP Associations</span>

   When the system drops a HIP association, as described in the HIP base
   specification, the associated ESP SAs MUST also be dropped.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.8.%20%20Initiating%20ESP%20SA%20Rekeying"></a><a class="selflink" href="#section-6.8" name="section-6.8">6.8</a>.  Initiating ESP SA Rekeying</span>

   During ESP SA rekeying, the hosts draw new keys from the existing
   keying material, or new keying material is generated from where the
   new keys are drawn.

   A system may initiate the SA rekeying procedure at any time.  It MUST
   initiate a rekey if its incoming ESP sequence counter is about to
   overflow.  The system MUST NOT replace its keying material until the
   rekeying packet exchange successfully completes.

   Optionally, a system may include a new Diffie-Hellman key for use in
   new KEYMAT generation.  New KEYMAT generation occurs prior to drawing
   the new keys.

   The rekeying procedure uses the UPDATE mechanism defined in
   [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>].  Because each peer must update its half of the security
   association pair (including new SPI creation), the rekeying process
   requires that each side both send and receive an UPDATE.  A system
   will then rekey the ESP SA when it has sent parameters to the peer
   and has received both an ACK of the relevant UPDATE message and
   corresponding peer's parameters.  It may be that the ACK and the
   required HIP parameters arrive in different UPDATE messages.  This is
   always true if a system does not initiate an ESP SA update but
   responds to an update request from the peer, and may also occur if
   two systems initiate update nearly simultaneously.  In such a case,
   if the system has an outstanding update request, it saves the one
   parameter and waits for the other before completing rekeying.










<span class="grey">Jokela, et al.               Standards Track                   [Page 23]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-24" id="page-24" name="page-24"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   The following steps define the processing rules for initiating an ESP
   SA update:

   1.  The system decides whether to continue to use the existing KEYMAT
       or to generate a new KEYMAT.  In the latter case, the system MUST
       generate a new Diffie-Hellman public key.

   2.  The system creates an UPDATE packet, which contains the ESP_INFO
       parameter.  In addition, the host may include the optional
       DIFFIE_HELLMAN parameter.  If the UPDATE contains the
       DIFFIE_HELLMAN parameter, the KEYMAT Index in the ESP_INFO
       parameter MUST be zero, and the Diffie-Hellman Group ID must be
       unchanged from that used in the initial handshake.  If the UPDATE
       does not contain DIFFIE_HELLMAN, the ESP_INFO KEYMAT Index MUST
       be greater than or equal to the index of the next byte to be
       drawn from the current KEYMAT.

   3.  The system sends the UPDATE packet.  For reliability, the
       underlying UPDATE retransmission mechanism MUST be used.

   4.  The system MUST NOT delete its existing SAs, but continue using
       them if its policy still allows.  The rekeying procedure SHOULD
       be initiated early enough to make sure that the SA replay
       counters do not overflow.

   5.  In case a protocol error occurs and the peer system acknowledges
       the UPDATE but does not itself send an ESP_INFO, the system may
       not finalize the outstanding ESP SA update request.  To guard
       against this, a system MAY re-initiate the ESP SA update
       procedure after some time waiting for the peer to respond, or it
       MAY decide to abort the ESP SA after waiting for an
       implementation-dependent time.  The system MUST NOT keep an
       outstanding ESP SA update request for an indefinite time.

   To simplify the state machine, a host MUST NOT generate new UPDATEs
   while it has an outstanding ESP SA update request, unless it is
   restarting the update process.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.9.%20%20Processing%20Incoming%20UPDATE%20Packets"></a><a class="selflink" href="#section-6.9" name="section-6.9">6.9</a>.  Processing Incoming UPDATE Packets</span>

   When a system receives an UPDATE packet, it must be processed if the
   following conditions hold (in addition to the generic conditions
   specified for UPDATE processing in <a href="rfc7401.html#section-6.12">Section 6.12 of [RFC7401]</a>):

   1.  A corresponding HIP association must exist.  This is usually
       ensured by the underlying UPDATE mechanism.

   2.  The state of the HIP association is ESTABLISHED or R2-SENT.



<span class="grey">Jokela, et al.               Standards Track                   [Page 24]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-25" id="page-25" name="page-25"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   If the above conditions hold, the following steps define the
   conceptual processing rules for handling the received UPDATE packet:

   1.  If the received UPDATE contains a DIFFIE_HELLMAN parameter, the
       received KEYMAT Index MUST be zero and the Group ID must match
       the Group ID in use on the association.  If this test fails, the
       packet SHOULD be dropped and the system SHOULD log an error
       message.

   2.  If there is no outstanding rekeying request, the packet
       processing continues as specified in <a href="#section-6.9.1">Section 6.9.1</a>.

   3.  If there is an outstanding rekeying request, the UPDATE MUST be
       acknowledged, the received ESP_INFO (and possibly DIFFIE_HELLMAN)
       parameters must be saved, and the packet processing continues as
       specified in <a href="#section-6.10">Section 6.10</a>.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/6.9.1.%20%20Processing%20UPDATE%20Packet%3A%20No%20Outstanding%20Rekeying%20Request"></a><a class="selflink" href="#section-6.9.1" name="section-6.9.1">6.9.1</a>.  Processing UPDATE Packet: No Outstanding Rekeying Request</span>

   The following steps define the conceptual processing rules for
   handling a received UPDATE packet with the ESP_INFO parameter:

   1.  The system consults its policy to see if it needs to generate a
       new Diffie-Hellman key, and generates a new key (with same
       Group ID) if needed.  The system records any newly generated or
       received Diffie-Hellman keys for use in KEYMAT generation upon
       finalizing the ESP SA update.

   2.  If the system generated a new Diffie-Hellman key in the previous
       step, or if it received a DIFFIE_HELLMAN parameter, it sets the
       ESP_INFO KEYMAT Index to zero.  Otherwise, the ESP_INFO KEYMAT
       Index MUST be greater than or equal to the index of the next byte
       to be drawn from the current KEYMAT.  In this case, it is
       RECOMMENDED that the host use the KEYMAT Index requested by the
       peer in the received ESP_INFO.

   3.  The system creates an UPDATE packet, which contains an ESP_INFO
       parameter and the optional DIFFIE_HELLMAN parameter.  This UPDATE
       would also typically acknowledge the peer's UPDATE with an ACK
       parameter, although a separate UPDATE ACK may be sent.

   4.  The system sends the UPDATE packet and stores any received
       ESP_INFO and DIFFIE_HELLMAN parameters.  At this point, it only
       needs to receive an acknowledgment for the newly sent UPDATE to
       finish the ESP SA update.  In the usual case, the acknowledgment
       is handled by the underlying UPDATE mechanism.





<span class="grey">Jokela, et al.               Standards Track                   [Page 25]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-26" id="page-26" name="page-26"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.10.%20%20Finalizing%20Rekeying"></a><a class="selflink" href="#section-6.10" name="section-6.10">6.10</a>.  Finalizing Rekeying</span>

   A system finalizes rekeying when it has both received the
   corresponding UPDATE acknowledgment packet from the peer and
   successfully received the peer's UPDATE.  The following steps
   are taken:

   1.  If the received UPDATE messages contain a new Diffie-Hellman key,
       the system has a new Diffie-Hellman key due to initiating an ESP
       SA update, or both, the system generates a new KEYMAT.  If there
       is only one new Diffie-Hellman key, the old existing key is used
       as the other key.

   2.  If the system generated a new KEYMAT in the previous step, it
       sets the KEYMAT Index to zero, independent of whether the
       received UPDATE included a Diffie-Hellman key or not.  If the
       system did not generate a new KEYMAT, it uses the greater KEYMAT
       Index of the two (sent and received) ESP_INFO parameters.

   3.  The system draws keys for new incoming and outgoing ESP SAs,
       starting from the KEYMAT Index, and prepares new incoming and
       outgoing ESP SAs.  The SPI for the outgoing SA is the new SPI
       value received in an ESP_INFO parameter.  The SPI for the
       incoming SA was generated when the ESP_INFO was sent to the peer.
       The order of the keys retrieved from the KEYMAT during the
       rekeying process is similar to that described in <a href="#section-7">Section 7</a>.  Note
       that only IPsec ESP keys are retrieved during the rekeying
       process, not the HIP keys.

   4.  The system starts to send to the new outgoing SA and prepares to
       start receiving data on the new incoming SA.  Once the system
       receives data on the new incoming SA, it may safely delete the
       old SAs.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.11.%20%20Processing%20NOTIFY%20Packets"></a><a class="selflink" href="#section-6.11" name="section-6.11">6.11</a>.  Processing NOTIFY Packets</span>

   The processing of NOTIFY packets is described in the HIP base
   specification.













<span class="grey">Jokela, et al.               Standards Track                   [Page 26]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-27" id="page-27" name="page-27"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/7.%20%20Keying%20Material"></a><a class="selflink" href="#section-7" name="section-7">7</a>.  Keying Material</span>

   The keying material is generated as described in the HIP base
   specification.  During the base exchange, the initial keys are drawn
   from the generated material.  After the HIP association keys have
   been drawn, the ESP keys are drawn in the following order:

      SA-gl ESP encryption key for HOST_g's outgoing traffic

      SA-gl ESP authentication key for HOST_g's outgoing traffic

      SA-lg ESP encryption key for HOST_l's outgoing traffic

      SA-lg ESP authentication key for HOST_l's outgoing traffic

   HOST_g denotes the host with the greater HIT value, and HOST_l
   denotes the host with the lower HIT value.  When HIT values are
   compared, they are interpreted as positive (unsigned) 128-bit
   integers in network byte order.

   The four HIP keys are only drawn from KEYMAT during a HIP I1-&gt;R2
   exchange.  Subsequent rekeys using UPDATE will only draw the four ESP
   keys from KEYMAT.  <a href="#section-6.9">Section 6.9</a> describes the rules for reusing or
   regenerating KEYMAT based on the rekeying.

   The number of bits drawn for a given algorithm is the "natural" size
   of the keys, as specified in <a href="rfc7401.html#section-6.5">Section 6.5 of [RFC7401]</a>.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/8.%20%20Security%20Considerations"></a><a class="selflink" href="#section-8" name="section-8">8</a>.  Security Considerations</span>

   In this document, the usage of ESP [<a href="rfc4303.html" title='"IP Encapsulating Security Payload (ESP)"'>RFC4303</a>] between HIP hosts to
   protect data traffic is introduced.  The security considerations for
   ESP are discussed in the ESP specification.

   There are different ways to establish an ESP Security Association
   between two nodes.  This can be done, e.g., using IKE [<a href="rfc7296.html" title='"Internet Key Exchange Protocol Version 2 (IKEv2)"'>RFC7296</a>].
   This document specifies how the Host Identity Protocol is used to
   establish ESP Security Associations.

   The following issues are new or have changed from the standard ESP
   usage:

   o  Initial keying material generation

   o  Updating the keying material






<span class="grey">Jokela, et al.               Standards Track                   [Page 27]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-28" id="page-28" name="page-28"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   The initial keying material is generated using the Host Identity
   Protocol [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>] using the Diffie-Hellman procedure.  This document
   extends the usage of the UPDATE packet, defined in the base
   specification, to modify existing ESP SAs.  The hosts may rekey,
   i.e., force the generation of new keying material using the
   Diffie-Hellman procedure.  The initial setup of ESP SAs between the
   hosts is done during the base exchange, and the message exchange is
   protected using methods provided by the base exchange.  Changes in
   connection parameters basically mean that the old ESP SA is removed
   and a new one is generated once the UPDATE message exchange has been
   completed.  The message exchange is protected using the HIP
   association keys.  Both HMAC and signing of packets are used.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/9.%20%20IANA%20Considerations"></a><a class="selflink" href="#section-9" name="section-9">9</a>.  IANA Considerations</span>

   The following changes to the "Host Identity Protocol (HIP)
   Parameters" registries have been made.  In all cases, the changes
   updated the reference from [<a href="rfc5202.html" title='"Using the Encapsulating Security Payload (ESP) Transport Format with the Host Identity Protocol (HIP)"'>RFC5202</a>] to this specification.

   This document defines two Parameter Types and two NOTIFY Message
   Types for the Host Identity Protocol [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>].

   The parameters and their type numbers are defined in Sections <a href="#section-5.1.1">5.1.1</a>
   and 5.1.2, and they have been added to the "Parameter Types"
   namespace created by [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>].  No new action regarding these values
   is required by this specification, other than updating the reference
   from [<a href="rfc5202.html" title='"Using the Encapsulating Security Payload (ESP) Transport Format with the Host Identity Protocol (HIP)"'>RFC5202</a>] to this specification.

   The new NOTIFICATION error types and their values are defined in
   <a href="#section-5.1.3">Section 5.1.3</a>, and they have been added to the "Notify Message Types"
   namespace created by [<a href="rfc7401.html" title='"Host Identity Protocol Version 2 (HIPv2)"'>RFC7401</a>].  No new action regarding these values
   is required by this specification, other than updating the reference
   from [<a href="rfc5202.html" title='"Using the Encapsulating Security Payload (ESP) Transport Format with the Host Identity Protocol (HIP)"'>RFC5202</a>] to this specification.

   <a href="#section-5.1.2">Section 5.1.2</a> of this document defines values for "ESP Transform
   Suite IDs", which are registered in a new IANA registry, with an
   "IETF Review" registration procedure [<a href="rfc5226.html" title='"Guidelines for Writing an IANA Considerations Section in RFCs"'>RFC5226</a>] for new values.














<span class="grey">Jokela, et al.               Standards Track                   [Page 28]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-29" id="page-29" name="page-29"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/10.%20%20References"></a><a class="selflink" href="#section-10" name="section-10">10</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/10.1.%20%20Normative%20References"></a><a class="selflink" href="#section-10.1" name="section-10.1">10.1</a>.  Normative References</span>

   [<a id="ref-RFC2119" name="ref-RFC2119">RFC2119</a>]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", <a href="https://tools.ietf.org/html/bcp14">BCP 14</a>, <a href="rfc2119.html">RFC 2119</a>, March 1997,
              &lt;<a href="http://www.rfc-editor.org/info/rfc2119">http://www.rfc-editor.org/info/rfc2119</a>&gt;.

   [<a id="ref-RFC2404" name="ref-RFC2404">RFC2404</a>]  Madson, C. and R. Glenn, "The Use of HMAC-SHA-1-96 within
              ESP and AH", <a href="rfc2404.html">RFC 2404</a>, November 1998,
              &lt;<a href="http://www.rfc-editor.org/info/rfc2404">http://www.rfc-editor.org/info/rfc2404</a>&gt;.

   [<a id="ref-RFC2410" name="ref-RFC2410">RFC2410</a>]  Glenn, R. and S. Kent, "The NULL Encryption Algorithm and
              Its Use With IPsec", <a href="rfc2410.html">RFC 2410</a>, November 1998,
              &lt;<a href="http://www.rfc-editor.org/info/rfc2410">http://www.rfc-editor.org/info/rfc2410</a>&gt;.

   [<a id="ref-RFC3602" name="ref-RFC3602">RFC3602</a>]  Frankel, S., Glenn, R., and S. Kelly, "The AES-CBC Cipher
              Algorithm and Its Use with IPsec", <a href="rfc3602.html">RFC 3602</a>,
              September 2003, &lt;<a href="http://www.rfc-editor.org/info/rfc3602">http://www.rfc-editor.org/info/rfc3602</a>&gt;.

   [<a id="ref-RFC4106" name="ref-RFC4106">RFC4106</a>]  Viega, J. and D. McGrew, "The Use of Galois/Counter Mode
              (GCM) in IPsec Encapsulating Security Payload (ESP)",
              <a href="rfc4106.html">RFC 4106</a>, June 2005, &lt;<a href="http://www.rfc-editor.org/info/rfc4106">http://www.rfc-editor.org/</a>
              <a href="http://www.rfc-editor.org/info/rfc4106">info/rfc4106</a>&gt;.

   [<a id="ref-RFC4303" name="ref-RFC4303">RFC4303</a>]  Kent, S., "IP Encapsulating Security Payload (ESP)",
              <a href="rfc4303.html">RFC 4303</a>, December 2005, &lt;<a href="http://www.rfc-editor.org/info/rfc4303">http://www.rfc-editor.org/</a>
              <a href="http://www.rfc-editor.org/info/rfc4303">info/rfc4303</a>&gt;.

   [<a id="ref-RFC4309" name="ref-RFC4309">RFC4309</a>]  Housley, R., "Using Advanced Encryption Standard (AES) CCM
              Mode with IPsec Encapsulating Security Payload (ESP)",
              <a href="rfc4309.html">RFC 4309</a>, December 2005, &lt;<a href="http://www.rfc-editor.org/info/rfc4309">http://www.rfc-editor.org/</a>
              <a href="http://www.rfc-editor.org/info/rfc4309">info/rfc4309</a>&gt;.

   [<a id="ref-RFC4493" name="ref-RFC4493">RFC4493</a>]  Song, JH., Poovendran, R., Lee, J., and T. Iwata, "The
              AES-CMAC Algorithm", <a href="rfc4493.html">RFC 4493</a>, June 2006,
              &lt;<a href="http://www.rfc-editor.org/info/rfc4493">http://www.rfc-editor.org/info/rfc4493</a>&gt;.

   [<a id="ref-RFC4494" name="ref-RFC4494">RFC4494</a>]  Song, JH., Poovendran, R., and J. Lee, "The AES-CMAC-96
              Algorithm and Its Use with IPsec", <a href="rfc4494.html">RFC 4494</a>, June 2006,
              &lt;<a href="http://www.rfc-editor.org/info/rfc4494">http://www.rfc-editor.org/info/rfc4494</a>&gt;.

   [<a id="ref-RFC4543" name="ref-RFC4543">RFC4543</a>]  McGrew, D. and J. Viega, "The Use of Galois Message
              Authentication Code (GMAC) in IPsec ESP and AH", <a href="rfc4543.html">RFC 4543</a>,
              May 2006, &lt;<a href="http://www.rfc-editor.org/info/rfc4543">http://www.rfc-editor.org/info/rfc4543</a>&gt;.






<span class="grey">Jokela, et al.               Standards Track                   [Page 29]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-30" id="page-30" name="page-30"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   [<a id="ref-RFC4868" name="ref-RFC4868">RFC4868</a>]  Kelly, S. and S. Frankel, "Using HMAC-SHA-256,
              HMAC-SHA-384, and HMAC-SHA-512 with IPsec", <a href="rfc4868.html">RFC 4868</a>,
              May 2007, &lt;<a href="http://www.rfc-editor.org/info/rfc4868">http://www.rfc-editor.org/info/rfc4868</a>&gt;.

   [<a id="ref-RFC7401" name="ref-RFC7401">RFC7401</a>]  Moskowitz, R., Ed., Heer, T., Jokela, P., and T.
              Henderson, "Host Identity Protocol Version 2 (HIPv2)",
              <a href="rfc7401.html">RFC 7401</a>, April 2015, &lt;<a href="http://www.rfc-editor.org/info/rfc7401">http://www.rfc-editor.org/</a>
              <a href="http://www.rfc-editor.org/info/rfc7401">info/rfc7401</a>&gt;.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/10.2.%20%20Informative%20References"></a><a class="selflink" href="#section-10.2" name="section-10.2">10.2</a>.  Informative References</span>

   [<a id="ref-HIP-ARCH" name="ref-HIP-ARCH">HIP-ARCH</a>] Moskowitz, R., Ed., and M. Komu, "Host Identity Protocol
              Architecture", Work in Progress,
              <a href="https://tools.ietf.org/html/draft-ietf-hip-rfc4423-bis-09">draft-ietf-hip-rfc4423-bis-09</a>, October 2014.

   [<a id="ref-RFC0791" name="ref-RFC0791">RFC0791</a>]  Postel, J., "Internet Protocol", STD 5, <a href="rfc791.html">RFC 791</a>,
              September 1981, &lt;<a href="http://www.rfc-editor.org/info/rfc791">http://www.rfc-editor.org/info/rfc791</a>&gt;.

   [<a id="ref-RFC4301" name="ref-RFC4301">RFC4301</a>]  Kent, S. and K. Seo, "Security Architecture for the
              Internet Protocol", <a href="rfc4301.html">RFC 4301</a>, December 2005,
              &lt;<a href="http://www.rfc-editor.org/info/rfc4301">http://www.rfc-editor.org/info/rfc4301</a>&gt;.

   [<a id="ref-RFC5202" name="ref-RFC5202">RFC5202</a>]  Jokela, P., Moskowitz, R., and P. Nikander, "Using the
              Encapsulating Security Payload (ESP) Transport Format with
              the Host Identity Protocol (HIP)", <a href="rfc5202.html">RFC 5202</a>, April 2008,
              &lt;<a href="http://www.rfc-editor.org/info/rfc5202">http://www.rfc-editor.org/info/rfc5202</a>&gt;.

   [<a id="ref-RFC5206" name="ref-RFC5206">RFC5206</a>]  Nikander, P., Henderson, T., Vogt, C., and J. Arkko,
              "End-Host Mobility and Multihoming with the Host Identity
              Protocol", <a href="rfc5206.html">RFC 5206</a>, April 2008,
              &lt;<a href="http://www.rfc-editor.org/info/rfc5206">http://www.rfc-editor.org/info/rfc5206</a>&gt;.

   [<a id="ref-RFC5207" name="ref-RFC5207">RFC5207</a>]  Stiemerling, M., Quittek, J., and L. Eggert, "NAT and
              Firewall Traversal Issues of Host Identity Protocol (HIP)
              Communication", <a href="rfc5207.html">RFC 5207</a>, April 2008,
              &lt;<a href="http://www.rfc-editor.org/info/rfc5207">http://www.rfc-editor.org/info/rfc5207</a>&gt;.

   [<a id="ref-RFC5226" name="ref-RFC5226">RFC5226</a>]  Narten, T. and H. Alvestrand, "Guidelines for Writing an
              IANA Considerations Section in RFCs", <a href="https://tools.ietf.org/html/bcp26">BCP 26</a>, <a href="rfc5226.html">RFC 5226</a>,
              May 2008, &lt;<a href="http://www.rfc-editor.org/info/rfc5226">http://www.rfc-editor.org/info/rfc5226</a>&gt;.











<span class="grey">Jokela, et al.               Standards Track                   [Page 30]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-31" id="page-31" name="page-31"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   [<a id="ref-RFC5770" name="ref-RFC5770">RFC5770</a>]  Komu, M., Henderson, T., Tschofenig, H., Melen, J., and A.
              Keranen, "Basic Host Identity Protocol (HIP) Extensions
              for Traversal of Network Address Translators", <a href="rfc5770.html">RFC 5770</a>,
              April 2010, &lt;<a href="http://www.rfc-editor.org/info/rfc5770">http://www.rfc-editor.org/info/rfc5770</a>&gt;.

   [<a id="ref-RFC7296" name="ref-RFC7296">RFC7296</a>]  Kaufman, C., Hoffman, P., Nir, Y., Eronen, P., and T.
              Kivinen, "Internet Key Exchange Protocol Version 2
              (IKEv2)", STD 79, <a href="rfc7296.html">RFC 7296</a>, October 2014,
              &lt;<a href="http://www.rfc-editor.org/info/rfc7296">http://www.rfc-editor.org/info/rfc7296</a>&gt;.










































<span class="grey">Jokela, et al.               Standards Track                   [Page 31]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-32" id="page-32" name="page-32"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/Appendix%20A.%20%20A%20Note%20on%20Implementation%20Options"></a><a class="selflink" href="#appendix-A" name="appendix-A">Appendix A</a>.  A Note on Implementation Options</span>

   It is possible to implement this specification in multiple different
   ways.  As noted above, one possible way of implementing this is to
   rewrite IP headers below IPsec.  In such an implementation, IPsec is
   used as if it was processing IPv6 transport mode packets, with the
   IPv6 header containing HITs instead of IP addresses in the source and
   destination address fields.  In outgoing packets, after IPsec
   processing, the HITs are replaced with actual IP addresses, based on
   the HITs and the SPI.  In incoming packets, before IPsec processing,
   the IP addresses are replaced with HITs, based on the SPI in the
   incoming packet.  In such an implementation, all IPsec policies are
   based on HITs and the upper layers only see packets with HITs in the
   place of IP addresses.  Consequently, support of HIP does not
   conflict with other uses of IPsec as long as the SPI spaces are kept
   separate.  <a href="#appendix-B">Appendix B</a> describes another way to implement this
   specification.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/Appendix%20B.%20%20Bound%20End-to-End%20Tunnel%20Mode%20for%20ESP"></a><a class="selflink" href="#appendix-B" name="appendix-B">Appendix B</a>.  Bound End-to-End Tunnel Mode for ESP</span>

   This section introduces an alternative way of implementing the
   necessary functions for HIP ESP transport.  Compared to the option of
   implementing the required address rewrites outside of IPsec, BEET has
   one implementation-level benefit.  In a BEET-mode-based
   implementation, the address-rewriting information is kept in one
   place, at the SAD.  On the other hand, when address rewriting is
   implemented separately, the implementation MUST make sure that the
   information in the SAD and the information in the separate
   address-rewriting database are kept in synchrony.  As a result, the
   BEET-mode-based way of implementing this specification is RECOMMENDED
   over the separate implementation, as it binds the identities,
   encryption, and locators tightly together.  It should be noted that
   implementing BEET mode doesn't require that corresponding hosts
   implement it, as the behavior is only visible internally in a host.

   BEET mode is a combination of IPsec tunnel and transport modes, and
   it provides some of the features from both.  HIP uses HITs as the
   "inner" addresses and IP addresses as "outer" addresses, like IP
   addresses are used in tunnel mode.  Instead of tunneling packets
   between hosts, a conversion between inner and outer addresses is made
   at end hosts, and the inner address is never sent on the wire after
   the initial HIP negotiation.  BEET provides IPsec transport mode
   syntax (no inner headers) with limited tunnel mode semantics (fixed
   logical inner addresses -- the HITs -- and changeable outer IP
   addresses).






<span class="grey">Jokela, et al.               Standards Track                   [Page 32]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-33" id="page-33" name="page-33"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/B.1.%20%20Protocol%20Definition"></a><a class="selflink" href="#appendix-B.1" name="appendix-B.1">B.1</a>.  Protocol Definition</span>

   In this section, we define the exact protocol formats and operations.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/B.1.1.%20%20Changes%20to%20Security%20Association%20Data%20Structures"></a><a class="selflink" href="#appendix-B.1.1" name="appendix-B.1.1">B.1.1</a>.  Changes to Security Association Data Structures</span>

   A BEET mode Security Association contains the same data as a regular
   tunnel mode Security Association, with the exception that the inner
   selectors must be single addresses and cannot be subnets.  The data
   includes the following:

   o  A pair of inner IP addresses.

   o  A pair of outer IP addresses.

   o  Cryptographic keys and other data as defined in <a href="rfc4301.html#section-4.4.2">Section 4.4.2 of
      RFC 4301</a> [<a href="rfc4301.html" title='"Security Architecture for the Internet Protocol"'>RFC4301</a>].

   A conforming implementation MAY store the data in a way similar to a
   regular tunnel mode Security Association.

   Note that in a conforming implementation the inner and outer
   addresses MAY belong to different address families.  All
   implementations that support both IPv4 and IPv6 SHOULD support both
   IPv4-over-IPv6 and IPv6-over-IPv4 tunneling.


























<span class="grey">Jokela, et al.               Standards Track                   [Page 33]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-34" id="page-34" name="page-34"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/B.1.2.%20%20Packet%20Format"></a><a class="selflink" href="#appendix-B.1.2" name="appendix-B.1.2">B.1.2</a>.  Packet Format</span>

   The wire packet format is identical to the ESP transport mode wire
   format as defined in <a href="rfc4303.html#section-3.1.1">Section 3.1.1 of [RFC4303]</a>.  However, the
   resulting packet contains outer IP addresses instead of the inner IP
   addresses received from the upper layer.  The construction of the
   outer headers is defined in <a href="rfc4301.html#section-5.1.2">Section 5.1.2 of RFC 4301</a> [<a href="rfc4301.html" title='"Security Architecture for the Internet Protocol"'>RFC4301</a>].  The
   following diagram illustrates ESP BEET mode positioning for typical
   IPv4 and IPv6 packets.

   IPv4 INNER ADDRESSES
   --------------------

         BEFORE APPLYING ESP
    ------------------------------
    | inner IP hdr  |     |      |
    |               | TCP | Data |
    ------------------------------

         AFTER APPLYING ESP, OUTER v4 ADDRESSES
    ----------------------------------------------------
    | outer IP hdr  |     |     |      |   ESP   | ESP |
    | (any options) | ESP | TCP | Data | Trailer | ICV |
    ----------------------------------------------------
                          |&lt;---- encryption ----&gt;|
                    |&lt;-------- integrity -------&gt;|

         AFTER APPLYING ESP, OUTER v6 ADDRESSES
    ------------------------------------------------------
    | outer  | new ext |     |     |      |  ESP   | ESP |
    | IP hdr | hdrs    | ESP | TCP | Data | Trailer| ICV |
    ------------------------------------------------------
                             |&lt;--- encryption ----&gt;|
                       |&lt;------- integrity -------&gt;|

















<span class="grey">Jokela, et al.               Standards Track                   [Page 34]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-35" id="page-35" name="page-35"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   IPv4 INNER ADDRESSES with options
   ---------------------------------

         BEFORE APPLYING ESP
    ------------------------------
    | inner IP hdr  |     |      |
    |  + options    | TCP | Data |
    ------------------------------

         AFTER APPLYING ESP, OUTER v4 ADDRESSES
    ----------------------------------------------------------
    | outer IP hdr  |     |     |     |      |   ESP   | ESP |
    | (any options) | ESP | PH  | TCP | Data | Trailer | ICV |
    ----------------------------------------------------------
                          |&lt;------- encryption -------&gt;|
                    |&lt;----------- integrity ----------&gt;|

         AFTER APPLYING ESP, OUTER v6 ADDRESSES
    ------------------------------------------------------------
    | outer  | new ext |     |     |     |      |  ESP   | ESP |
    | IP hdr | hdrs    | ESP | PH  | TCP | Data | Trailer| ICV |
    ------------------------------------------------------------
                             |&lt;------ encryption -------&gt;|
                       |&lt;---------- integrity ----------&gt;|

                               PH    Pseudo Header for IPv4 options

























<span class="grey">Jokela, et al.               Standards Track                   [Page 35]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-36" id="page-36" name="page-36"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   IPv6 INNER ADDRESSES
   --------------------

         BEFORE APPLYING ESP
    ------------------------------------------
    |              |  ext hdrs  |     |      |
    | inner IP hdr | if present | TCP | Data |
    ------------------------------------------

         AFTER APPLYING ESP, OUTER v6 ADDRESSES
    --------------------------------------------------------------
    | outer  | new ext |     | dest |     |      |  ESP    | ESP |
    | IP hdr | hdrs    | ESP | opts.| TCP | Data | Trailer | ICV |
    --------------------------------------------------------------
                                    |&lt;---- encryption ----&gt;|
                                |&lt;------- integrity ------&gt;|

         AFTER APPLYING ESP, OUTER v4 ADDRESSES
    ----------------------------------------------------
    | outer  |     | dest |     |      |  ESP    | ESP |
    | IP hdr | ESP | opts.| TCP | Data | Trailer | ICV |
    ----------------------------------------------------
                   |&lt;------- encryption --------&gt;|
             |&lt;----------- integrity -----------&gt;|

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/B.1.3.%20%20Cryptographic%20Processing"></a><a class="selflink" href="#appendix-B.1.3" name="appendix-B.1.3">B.1.3</a>.  Cryptographic Processing</span>

   The outgoing packets MUST be protected exactly as in ESP transport
   mode [<a href="rfc4303.html" title='"IP Encapsulating Security Payload (ESP)"'>RFC4303</a>].  That is, the upper-layer protocol packet is wrapped
   into an ESP header, encrypted, and authenticated exactly as if
   regular transport mode was used.  The resulting ESP packet is subject
   to IP header processing as defined in Appendices B.1.4 and B.1.5.
   The incoming ESP protected messages are verified and decrypted
   exactly as if regular transport mode was used.  The resulting
   cleartext packet is subject to IP header processing as defined in
   Appendices B.1.4 and B.1.6.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/B.1.4.%20%20IP%20Header%20Processing"></a><a class="selflink" href="#appendix-B.1.4" name="appendix-B.1.4">B.1.4</a>.  IP Header Processing</span>

   The biggest difference between BEET mode and the other two modes is
   in IP header processing.  In the regular transport mode, the IP
   header is kept intact.  In the regular tunnel mode, an outer IP
   header is created on output and discarded on input.  In BEET mode,
   the IP header is replaced with another one on both input and output.







<span class="grey">Jokela, et al.               Standards Track                   [Page 36]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-37" id="page-37" name="page-37"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


   On the BEET mode output side, the IP header processing MUST first
   ensure that the IP addresses in the original IP header contain the
   inner addresses as specified in the SA.  This MAY be ensured by
   proper policy processing, and it is possible that no checks are
   needed at the time of SA processing.  Once the IP header has been
   verified to contain the right IP inner addresses, it is discarded.  A
   new IP header is created, using the fields of the discarded inner
   header (except the IP addresses) to populate the fields of the new
   outer header.  The IP addresses in the new header MUST be the outer
   tunnel addresses.

   On the input side, the received IP header is simply discarded.  Since
   the packet has been decrypted and verified, no further checks are
   necessary.  A new IP header corresponding to a BEET mode inner header
   is created, using the fields of the discarded outer header (except
   the IP addresses) to populate the fields of the new inner header.
   The IP addresses in the new header MUST be the inner addresses.

   As the outer header fields are used as a hint for creating the inner
   header, it must be noted that the inner header differs as compared to
   a tunnel mode inner header.  In BEET mode, the inner header will have
   the Time to Live (TTL), Don't Fragment (DF) bit, and other option
   values from the outer header.  The TTL, DF bit, and other option
   values of the inner header MUST be processed by the stack.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/B.1.5.%20%20Handling%20of%20Outgoing%20Packets"></a><a class="selflink" href="#appendix-B.1.5" name="appendix-B.1.5">B.1.5</a>.  Handling of Outgoing Packets</span>

   The outgoing BEET mode packets are processed as follows:

   1.  The system MUST verify that the IP header contains the inner
       source and destination addresses, exactly as defined in the SA.
       This verification MAY be explicit, or it MAY be implicit, for
       example, as a result of prior policy processing.  Note that in
       some implementations there may be no real IP header at this time
       but the source and destination addresses may be carried out of
       band.  If the source address is still unassigned, it SHOULD be
       ensured that the designated inner source address would be
       selected at a later stage.

   2.  The IP payload (the contents of the packet beyond the IP header)
       is wrapped into an ESP header as defined in <a href="rfc4303.html#section-3.3">Section 3.3 of
       [RFC4303]</a>.

   3.  A new IP header is constructed, replacing the original one.  The
       new IP header MUST contain the outer source and destination
       addresses, as defined in the SA.  Note that in some
       implementations there may be no real IP header at this time but
       the source and destination addresses may be carried out of band.



<span class="grey">Jokela, et al.               Standards Track                   [Page 37]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-38" id="page-38" name="page-38"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


       In the case where the source address must be left unassigned, it
       SHOULD be ensured that the right source address is selected at a
       later stage.  Other than the addresses, it is RECOMMENDED that
       the new IP header copies the fields from the original IP header.

   4.  If there are any IPv4 options in the original packet, it is
       RECOMMENDED that they are discarded.  If the inner header
       contains one or more options that need to be transported between
       the tunnel endpoints, the sender MUST encapsulate the options as
       defined in <a href="#appendix-B.1.7">Appendix B.1.7</a>.

   Instead of literally discarding the IP header and constructing a new
   one, a conforming implementation MAY simply replace the addresses in
   an existing header.  However, if the RECOMMENDED feature of allowing
   the inner and outer addresses from different address families is
   used, this simple strategy does not work.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/B.1.6.%20%20Handling%20of%20Incoming%20Packets"></a><a class="selflink" href="#appendix-B.1.6" name="appendix-B.1.6">B.1.6</a>.  Handling of Incoming Packets</span>

   The incoming BEET mode packets are processed as follows:

   1.  The system MUST verify and decrypt the incoming packet
       successfully, as defined in <a href="rfc4303.html#section-3.4">Section 3.4 of [RFC4303]</a>.  If the
       verification or decryption fails, the packet MUST be discarded.

   2.  The original IP header is simply discarded, without any checks.
       Since the ESP verification succeeded, the packet can be safely
       assumed to have arrived from the right sender.

   3.  A new IP header is constructed, replacing the original one.  The
       new IP header MUST contain the inner source and destination
       addresses, as defined in the SA.  If the sender has set the ESP
       Next Header field to 94 and included the pseudo header as
       described in <a href="#appendix-B.1.7">Appendix B.1.7</a>, the receiver MUST include the
       options after the constructed IP header.  Note that in some
       implementations the real IP header may have already been
       discarded and the source and destination addresses are carried
       out of band.  In such a case, the out-of-band addresses MUST be
       the inner addresses.  Other than the addresses, it is RECOMMENDED
       that the new IP header copies the fields from the original IP
       header.

   Instead of literally discarding the IP header and constructing a new
   one, a conforming implementation MAY simply replace the addresses in
   an existing header.  However, if the RECOMMENDED feature of allowing
   the inner and outer addresses from different address families is
   used, this simple strategy does not work.




<span class="grey">Jokela, et al.               Standards Track                   [Page 38]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-39" id="page-39" name="page-39"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/B.1.7.%20%20Handling%20of%20IPv4%20Options"></a><a class="selflink" href="#appendix-B.1.7" name="appendix-B.1.7">B.1.7</a>.  Handling of IPv4 Options</span>

   In BEET mode, if IPv4 options are transported inside the tunnel, the
   sender MUST include a pseudo header after the ESP header.  The
   pseudo header indicates that IPv4 options from the original packet
   are to be applied to the packet on the input side.

   The sender MUST set the Next Header field in the ESP header to 94.
   The resulting pseudo header, including the IPv4 options, MUST be
   padded to an 8-octet boundary.  The padding length is expressed in
   octets; valid padding lengths are 0 or 4 octets, as the original IPv4
   options are already padded to a 4-octet boundary.  The padding MUST
   be filled with No Operation (NOP) options as defined in <a href="#section-3.1">Section 3.1</a>
   ("Internet Header Format") of [<a href="https://tools.ietf.org/html/rfc0791" title='"Internet Protocol"'>RFC0791</a>] ("Internet Protocol").  The
   padding is added in front of the original options to ensure that the
   receiver is able to reconstruct the original IPv4 datagram.  The
   Header Length field contains the length of the IPv4 options, and
   padding in 8-octet units.

    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Next Header  |   Header Len  |    Pad Len    |   Reserved    |
   +---------------+---------------+-------------------------------+
   |                       Padding (if needed)                     |
   +---------------------------------------------------------------+
   |                            IPv4 options ...                   |
   |                                                               |
   +---------------------------------------------------------------+

      Next Header          identifies the data following this header.
      Length in octets     8-bit unsigned integer.  Length of the
                           pseudo header in 8-octet units, not
                           including the first 8 octets.

   The receiver MUST remove this pseudo header and padding as a part of
   BEET processing, in order to reconstruct the original IPv4 datagram.
   The IPv4 options included in the pseudo header MUST be added after
   the reconstructed IPv4 (inner) header on the receiving side.












<span class="grey">Jokela, et al.               Standards Track                   [Page 39]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-40" id="page-40" name="page-40"> </a>
<span class="grey"><a href="rfc7402.html">RFC 7402</a>         Using the ESP Transport Format with HIP      April 2015</span>


Acknowledgments

   This document was separated from the base Host Identity Protocol
   specification in the beginning of 2005.  Since then, a number of
   people have contributed to the text by providing comments and
   modification proposals.  The list of people includes Tom Henderson,
   Jeff Ahrenholz, Jan Melen, Jukka Ylitalo, and Miika Komu.
   Especially, the authors want to thank Pekka Nikander for his
   invaluable contributions to the document since the first draft
   version.  The authors also want to thank Charlie Kaufman for
   reviewing the document with his eye on the usage of crypto
   algorithms.

   Due to the history of this document, most of the ideas are inherited
   from the base Host Identity Protocol specification.  Thus, the list
   of people in the Acknowledgments section of that specification is
   also valid for this document.  Many people have given valuable
   feedback, and our apologies to anyone whose name is missing.

Authors' Addresses

   Petri Jokela
   Ericsson Research NomadicLab
   JORVAS  FIN-02420
   Finland

   Phone: +358 9 299 1
   EMail: petri.jokela@nomadiclab.com


   Robert Moskowitz
   HTT Consulting
   Oak Park, MI
   United States

   EMail: rgm@labs.htt-consult.com


   Jan Melen
   Ericsson Research NomadicLab
   JORVAS  FIN-02420
   Finland

   Phone: +358 9 299 1
   EMail: jan.melen@nomadiclab.com






Jokela, et al.               Standards Track                   [Page 40]

</pre><br/>
    <span class="noprint"><small><small>Html markup produced by rfcmarkup 1.126, available from
      <a href="https://tools.ietf.org/tools/rfcmarkup/">https://tools.ietf.org/tools/rfcmarkup/</a>
    </small></small></span>
  </div>




</body><!-- Mirrored from tools.ietf.org/html/rfc7402 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Mar 2018 23:18:21 GMT --></html>