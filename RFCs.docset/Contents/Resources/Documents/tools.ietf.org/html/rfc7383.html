<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<!-- Mirrored from tools.ietf.org/html/rfc7383 by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 28 Jul 2019 12:31:34 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head profile="http://dublincore.org/documents/2008/08/04/dc-html/">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="robots" content="index,follow" />
    <meta name="creator" content="rfcmarkup version 1.129c" />
    <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" />
<meta name="DC.Relation.Replaces" content="draft-smyslov-ipsecme-ikev2-fragmentation" />
<meta name="DC.Identifier" content="urn:ietf:rfc:7383" />
<meta name="DC.Date.Issued" content="November, 2014" />
<meta name="DC.Creator" content="Valery Smyslov &lt;svan@elvis.ru&gt;" />
<meta name="DC.Description.Abstract" content="This document describes a way to avoid IP fragmentation of large
Internet Key Exchange Protocol version 2 (IKEv2) messages. This allows
IKEv2 messages to traverse network devices that do not allow IP
fragments to pass through." />
<meta name="DC.Title" content="Internet Key Exchange Protocol Version 2 (IKEv2) Message Fragmentation" />

    <link rel="icon" href="https://tools.ietf.org/images/rfc.png" type="image/png" />
    <link rel="shortcut icon" href="https://tools.ietf.org/images/rfc.png" type="image/png" />
    <title>RFC 7383 - Internet Key Exchange Protocol Version 2 (IKEv2) Message Fragmentation</title>
    
    
    <style type="text/css">
	@media only screen 
	  and (min-width: 992px)
	  and (max-width: 1199px) {
	    body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 768px)
	  and (max-width: 991px) {
            body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 480px)
	  and (max-width: 767px) {
            body { font-size: 11pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (max-width: 479px) {
            body { font-size: 8pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-device-width : 375px) 
	  and (max-device-width : 667px) {
            body { font-size: 9.5pt; }
            div.content { width: 96ex; margin: 0; }
        }
	@media only screen 
	  and (min-device-width: 1200px) {
            body { font-size: 10pt; margin: 0 4em; }
            div.content { width: 96ex; margin: 0; }
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        a.selflink {
          color: black;
          text-decoration: none;
        }
        @media print {
            body {
                font-family: monospace;
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 1em;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>                   <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>                     <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>             <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>              <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td>      <td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td>         <td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard (old designation):</td> <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Internet Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>                  <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>                  <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
  <div class="content">
   <div style="height: 13px;">
      <div onmouseover="this.style.cursor='pointer';"
         onclick="showElem('legend');"
         onmouseout="hideElem('legend')"
	 style="height: 6px; position: absolute;"
         class="pre noprint docinfo bgblue"
         title="Click for colour legend." >                                                                        </div>
      <div id="legend"
           class="docinfo noprint pre legend"
           style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; "
           onmouseover="showElem('legend');"
           onmouseout="hideElem('legend');">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="index.html" title="Document search and retrieval page">Docs</a>] [<a href="https://tools.ietf.org/rfc/rfc7383.txt" title="Plaintext version of this document">txt</a>|<a href="https://tools.ietf.org/pdf/rfc7383" title="PDF version of this document">pdf</a>] [<a href="https://tools.ietf.org/html/draft-ietf-ipsecme-ikev2-fragmentation" title="draft-ietf-ipsecme-ikev2-fragmentation">draft-ietf-ipse...</a>] [<a href='https://datatracker.ietf.org/doc/rfc7383' title='IESG Datatracker information for this document'>Tracker</a>] [<a href="https://tools.ietf.org/rfcdiff?difftype=--hwdiff&amp;url2=rfc7383" title="Inline diff (wdiff)">Diff1</a>] [<a href="https://tools.ietf.org/rfcdiff?url2=rfc7383" title="Side-by-side diff">Diff2</a>]         </span><br />
<span class="pre noprint docinfo">                                                                        </span><br />
<span class="pre noprint docinfo">                                                       PROPOSED STANDARD</span><br />
<span class="pre noprint docinfo">                                                                        </span><br />
<pre>
Internet Engineering Task Force (IETF)                        V. Smyslov
Request for Comments: 7383                                    ELVIS-PLUS
Category: Standards Track                                  November 2014
ISSN: 2070-1721


 <span class="h1">Internet Key Exchange Protocol Version 2 (IKEv2) Message Fragmentation</span>

Abstract

   This document describes a way to avoid IP fragmentation of large
   Internet Key Exchange Protocol version 2 (IKEv2) messages.  This
   allows IKEv2 messages to traverse network devices that do not allow
   IP fragments to pass through.

Status of This Memo

   This is an Internet Standards Track document.

   This document is a product of the Internet Engineering Task Force
   (IETF).  It represents the consensus of the IETF community.  It has
   received public review and has been approved for publication by the
   Internet Engineering Steering Group (IESG).  Further information on
   Internet Standards is available in <a href="rfc5741.html#section-2">Section&nbsp;2 of RFC 5741</a>.

   Information about the current status of this document, any errata,
   and how to provide feedback on it may be obtained at
   <a href="http://www.rfc-editor.org/info/rfc7383">http://www.rfc-editor.org/info/rfc7383</a>.

Copyright Notice

   Copyright (c) 2014 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="https://tools.ietf.org/html/bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.








<span class="grey">Smyslov                      Standards Track                    [Page 1]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-2" id="page-2" href="#page-2" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


Table of Contents

   <a href="#section-1">1</a>. Introduction ....................................................<a href="#page-2">2</a>
      <a href="#section-1.1">1.1</a>. Problem Description ........................................<a href="#page-2">2</a>
      <a href="#section-1.2">1.2</a>. Proposed Solution ..........................................<a href="#page-3">3</a>
      <a href="#section-1.3">1.3</a>. Conventions Used in This Document ..........................<a href="#page-4">4</a>
   <a href="#section-2">2</a>. Protocol Details ................................................<a href="#page-4">4</a>
      <a href="#section-2.1">2.1</a>. Overview ...................................................<a href="#page-4">4</a>
      <a href="#section-2.2">2.2</a>. Limitations ................................................<a href="#page-4">4</a>
      <a href="#section-2.3">2.3</a>. Negotiation ................................................<a href="#page-5">5</a>
      <a href="#section-2.4">2.4</a>. Using IKE Fragmentation ....................................<a href="#page-5">5</a>
      <a href="#section-2.5">2.5</a>. Fragmenting Message ........................................<a href="#page-6">6</a>
           <a href="#section-2.5.1">2.5.1</a>. Selecting Fragment Size .............................<a href="#page-8">8</a>
           <a href="#section-2.5.2">2.5.2</a>. PMTU Discovery ......................................<a href="#page-9">9</a>
           2.5.3. Fragmenting Messages Containing Unprotected
                  Payloads ...........................................<a href="#page-11">11</a>
      <a href="#section-2.6">2.6</a>. Receiving IKE Fragment Message ............................<a href="#page-11">11</a>
           <a href="#section-2.6.1">2.6.1</a>. Replay Detection and Retransmissions ...............<a href="#page-13">13</a>
   <a href="#section-3">3</a>. Interaction with Other IKE Extensions ..........................<a href="#page-14">14</a>
   <a href="#section-4">4</a>. Transport Considerations .......................................<a href="#page-14">14</a>
   <a href="#section-5">5</a>. Security Considerations ........................................<a href="#page-15">15</a>
   <a href="#section-6">6</a>. IANA Considerations ............................................<a href="#page-16">16</a>
   <a href="#section-7">7</a>. References .....................................................<a href="#page-16">16</a>
      <a href="#section-7.1">7.1</a>. Normative References ......................................<a href="#page-16">16</a>
      <a href="#section-7.2">7.2</a>. Informative References ....................................<a href="#page-16">16</a>
   <a href="#appendix-A">Appendix A</a>. Design Rationale ......................................<a href="#page-19">19</a>
   <a href="#appendix-B">Appendix B</a>. Correlation between IP Datagram Size and Encrypted
               Payload Content Size ..................................<a href="#page-19">19</a>
   Acknowledgements ..................................................<a href="#page-20">20</a>
   Author's Address ..................................................<a href="#page-20">20</a>

<span class="h2"><a class="selflink" name="section-1" href="#section-1">1</a>.  Introduction</span>

<span class="h3"><a class="selflink" name="section-1.1" href="#section-1.1">1.1</a>.  Problem Description</span>

   The Internet Key Exchange Protocol version 2 (IKEv2), specified in
   [<a href="rfc7296.html" title="&quot;Internet Key Exchange Protocol Version 2 (IKEv2)&quot;">RFC7296</a>], uses UDP as a transport for its messages.  Most IKEv2
   messages are relatively small, usually below several hundred bytes.
   A notable exception is the IKE_AUTH exchange, which requires fairly
   large messages, up to several KB, especially when certificates are
   transferred.  When the IKE message size exceeds the path MTU, it gets
   fragmented at the IP level.  The problem is that some network
   devices, specifically some NAT boxes, do not allow IP fragments to
   pass through.  This apparently blocks IKE communication and,
   therefore, prevents peers from establishing an IPsec Security
   Association (SA).  <a href="rfc7296.html#section-2">Section&nbsp;2 of [RFC7296]</a> discusses the impact of IP
   fragmentation on IKEv2 and acknowledges this problem.




<span class="grey">Smyslov                      Standards Track                    [Page 2]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-3" id="page-3" href="#page-3" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


   Widespread deployment of Carrier-Grade NATs (CGNs) introduces new
   challenges.  [<a href="rfc6888.html" title="&quot;Common Requirements for Carrier-Grade NATs (CGNs)&quot;">RFC6888</a>] describes requirements for CGNs.  It states
   that CGNs must comply with <a href="rfc4787.html#section-11">Section&nbsp;11 of [RFC4787]</a>, which requires
   NATs to support receiving IP fragments (REQ-14).  In real life,
   fulfillment of this requirement creates an additional burden in terms
   of memory, especially for high-capacity devices used in CGNs.  It was
   found by people deploying IKE that more and more ISPs use equipment
   that drops IP fragments, thereby violating this requirement.

   Security researchers have found, and continue to find, attack vectors
   that rely on IP fragmentation.  For these reasons, and also as
   articulated in [<a href="#ref-FRAGDROP" title="&quot;Why Operators Filter Fragments and What It Implies&quot;">FRAGDROP</a>], many network operators filter all IPv6
   fragments.  Also, the default behavior of many currently deployed
   firewalls is to discard IPv6 fragments.

   In one recent study [<a href="#ref-BLACKHOLES" title="&quot;Discovering Path MTU black holes on the Internet using RIPE Atlas&quot;">BLACKHOLES</a>], two researchers utilized a
   measurement network to measure fragment filtering.  They sent
   packets, fragmented to the minimum MTU of 1280, to 502 IPv6-enabled
   and reachable probes.  They found that during any given trial period,
   ten percent of the probes did not receive fragmented packets.

   Thus, this problem is valid for both IPv4 and IPv6 and may be caused
   by either deficiency of network devices or operational choice.

<span class="h3"><a class="selflink" name="section-1.2" href="#section-1.2">1.2</a>.  Proposed Solution</span>

   The solution to the problem described in this document is to perform
   fragmentation of large messages by IKEv2 itself and replace them with
   a series of smaller messages.  In this case, the resulting IP
   datagrams will be small enough so that no fragmentation at the IP
   level will take place.

   The primary goal of this solution is to allow IKEv2 to operate in
   environments that might block IP fragments.  This goal does not
   assume that IP fragmentation should be avoided completely, but only
   in those cases when it interferes with IKE operations.  However, this
   solution could be used to avoid IP fragmentation in all situations
   where fragmentation within IKE is applicable, as recommended in
   <a href="rfc5405.html#section-3.2">Section&nbsp;3.2 of [RFC5405]</a>.  Avoiding IP fragmentation would be
   beneficial for IKEv2 in general.  The Security Considerations section
   of [<a href="rfc7296.html" title="&quot;Internet Key Exchange Protocol Version 2 (IKEv2)&quot;">RFC7296</a>] mentions exhaustion of the IP reassembly buffers as one
   of the possible attacks on the protocol.  In [<a href="#ref-DOSUDPPROT" title="&quot;DoS protection for UDP-based protocols&quot;">DOSUDPPROT</a>], several
   aspects of attacks on IKE using IP fragmentation are discussed, and
   one of the defenses it proposes is to perform fragmentation within
   IKE, similar to the solution described in this document.






<span class="grey">Smyslov                      Standards Track                    [Page 3]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-4" id="page-4" href="#page-4" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


<span class="h3"><a class="selflink" name="section-1.3" href="#section-1.3">1.3</a>.  Conventions Used in This Document</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in [<a href="rfc2119.html" title="&quot;Key words for use in RFCs to Indicate Requirement Levels&quot;">RFC2119</a>].

<span class="h2"><a class="selflink" name="section-2" href="#section-2">2</a>.  Protocol Details</span>

<span class="h3"><a class="selflink" name="section-2.1" href="#section-2.1">2.1</a>.  Overview</span>

   The idea of the protocol described in this document is to split large
   IKEv2 messages into a set of smaller ones, called IKE Fragment
   messages.  Fragmentation takes place before the original message is
   encrypted and authenticated, so that each IKE Fragment message
   receives individual protection.  On the receiving side, IKE Fragment
   messages are collected, verified, decrypted, and merged together to
   get the original message before encryption.  See <a href="#appendix-A">Appendix A</a> for
   details on design rationale.

<span class="h3"><a class="selflink" name="section-2.2" href="#section-2.2">2.2</a>.  Limitations</span>

   Since IKE Fragment messages are cryptographically protected, SK_a and
   SK_e must already be calculated.  In general, it means that the
   original message can be fragmented if and only if it contains an
   Encrypted payload.

   This implies that messages of the IKE_SA_INIT exchange cannot be
   fragmented.  In most cases, this is not a problem because IKE_SA_INIT
   messages are usually small enough to avoid IP fragmentation.  But in
   some cases (advertising a badly structured long list of algorithms,
   using large Modular Exponentiation (MODP) groups, etc.), these
   messages may become fairly large and get fragmented at the IP level.
   In this case, the solution described in this document will not help.

   Among existing IKEv2 extensions, messages of an IKE_SESSION_RESUME
   exchange, as defined in [<a href="rfc5723.html" title="&quot;Internet Key Exchange Protocol Version 2 (IKEv2) Session Resumption&quot;">RFC5723</a>], cannot be fragmented either.  See
   <a href="#section-3">Section 3</a> for details.

   Another limitation is that the minimum size of an IP datagram bearing
   an IKE Fragment message is about 100 bytes, depending on the
   algorithms employed.  According to [<a href="https://tools.ietf.org/html/rfc0791" title="&quot;Internet Protocol&quot;">RFC0791</a>], the minimum IPv4
   datagram size that is guaranteed not to be further fragmented is
   68 bytes.  So, even the smallest IKE Fragment messages could be
   fragmented at the IP level in some circumstances.  But such extremely
   small Path MTU (PMTU) sizes are very rare in real life.






<span class="grey">Smyslov                      Standards Track                    [Page 4]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-5" id="page-5" href="#page-5" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


<span class="h3"><a class="selflink" name="section-2.3" href="#section-2.3">2.3</a>.  Negotiation</span>

   The initiator indicates its support for IKE fragmentation and
   willingness to use it by including a Notification payload of type
   IKEV2_FRAGMENTATION_SUPPORTED in the IKE_SA_INIT request message.  If
   the responder also supports this extension and is willing to use it,
   it includes this notification in the response message.

   Initiator                   Responder
   -----------                 -----------
   HDR, SAi1, KEi, Ni,
      [N(IKEV2_FRAGMENTATION_SUPPORTED)]  --&gt;

                       &lt;--   HDR, SAr1, KEr, Nr, [CERTREQ],
                                  [N(IKEV2_FRAGMENTATION_SUPPORTED)]

   The Notify payload is formatted as follows:

                        1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | Next Payload  |C|  RESERVED   |         Payload Length        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Protocol ID(=0)| SPI Size (=0) |      Notify Message Type      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   o  Protocol ID (1 octet) - MUST be 0.

   o  SPI Size (1 octet) - MUST be 0, meaning no Security Parameter
      Index (SPI) is present.

   o  Notify Message Type (2 octets) - MUST be 16430, the value assigned
      for the IKEV2_FRAGMENTATION_SUPPORTED notification.

   This notification contains no data.

<span class="h3"><a class="selflink" name="section-2.4" href="#section-2.4">2.4</a>.  Using IKE Fragmentation</span>

   IKE fragmentation MUST NOT be used unless both peers have indicated
   their support for it.  After that, it is up to the initiator of each
   exchange to decide whether or not to use it.  The responder usually
   replies in the same form as the request message, but other
   considerations might override this.

   The initiator can employ various policies regarding the use of IKE
   fragmentation.  It might first try to send an unfragmented message
   and resend it as fragmented only if no complete response is received
   even after several retransmissions.  Alternatively, it might choose



<span class="grey">Smyslov                      Standards Track                    [Page 5]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-6" id="page-6" href="#page-6" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


   to always send fragmented messages (however, see <a href="#section-3">Section 3</a>), or it
   might fragment only large messages and messages that are expected to
   result in large responses.

   The following general guidelines apply:

   o  If either peer has information that a part of the transaction is
      likely to be fragmented at the IP layer, causing interference with
      the IKE exchange, that peer SHOULD use IKE fragmentation.  This
      information might be passed from a lower layer, provided by
      configuration, or derived through heuristics.  Examples of
      heuristics are the lack of a complete response after several
      retransmissions for the initiator, and receiving repeated
      retransmissions of the request for the responder.

   o  If either peer knows that IKE fragmentation has been used in a
      previous exchange in the context of the current IKE SA, that peer
      SHOULD continue to use IKE fragmentation for the messages that are
      larger than the current fragmentation threshold (see
      <a href="#section-2.5.1">Section 2.5.1</a>).

   o  IKE fragmentation SHOULD NOT be used in cases where IP-layer
      fragmentation of both the request and response messages is
      unlikely.  For example, there is no point in fragmenting liveness
      check messages.

   o  If none of the above apply, the responder SHOULD respond in the
      same form (fragmented or not) as the request message to which it
      is responding.  Note that the other guidelines might override this
      because of information or heuristics available to the responder.

   In most cases, IKE fragmentation will be used in the IKE_AUTH
   exchange, especially if certificates are employed.

<span class="h3"><a class="selflink" name="section-2.5" href="#section-2.5">2.5</a>.  Fragmenting Message</span>

   Only messages that contain an Encrypted payload are subject to IKE
   fragmentation.  For the purpose of construction of IKE Fragment
   messages, the original (unencrypted) content of the Encrypted payload
   is split into chunks.  The content is treated as a binary blob and is
   split regardless of the boundaries of inner payloads.  Each of the
   resulting chunks is treated as an original content of the Encrypted
   Fragment payload and is then encrypted and authenticated.  Thus, the
   Encrypted Fragment payload contains a chunk of the original content
   of the Encrypted payload in encrypted form.  The cryptographic
   processing of the Encrypted Fragment payload is identical to that





<span class="grey">Smyslov                      Standards Track                    [Page 6]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-7" id="page-7" href="#page-7" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


   described in <a href="rfc7296.html#section-3.14">Section&nbsp;3.14 of [RFC7296]</a>, as well as documents updating
   such processing for particular algorithms or modes, such as
   [<a href="rfc5282.html" title="&quot;Using Authenticated Encryption Algorithms with the Encrypted Payload of the Internet Key Exchange version 2 (IKEv2) Protocol&quot;">RFC5282</a>].

   As is the case for the Encrypted payload, the Encrypted Fragment
   payload, if present in a message, MUST be the last payload in the
   message.

   The Encrypted Fragment payload is denoted SKF{...}, and its payload
   type is 53.  This payload is also called the "Encrypted and
   Authenticated Fragment" payload.

                        1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | Next Payload  |C|  RESERVED   |         Payload Length        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |        Fragment Number        |        Total Fragments        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                     Initialization Vector                     |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   ~                      Encrypted content                        ~
   +               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |               |             Padding (0-255 octets)            |
   +-+-+-+-+-+-+-+-+                               +-+-+-+-+-+-+-+-+
   |                                               |  Pad Length   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   ~                    Integrity Checksum Data                    ~
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

                        Encrypted Fragment Payload

   o  Next Payload (1 octet) - in the very first fragment (with Fragment
      Number equal to 1), this field MUST be set to the payload type of
      the first inner payload (the same as for the Encrypted payload).
      In the rest of the Fragment messages (with Fragment Number greater
      than 1), this field MUST be set to zero.

   o  Fragment Number (2 octets, unsigned integer) - current Fragment
      message number, starting from 1.  This field MUST be less than or
      equal to the next field (Total Fragments).  This field MUST NOT be
      zero.

   o  Total Fragments (2 octets, unsigned integer) - number of Fragment
      messages into which the original message was divided.  This field
      MUST NOT be zero.  With PMTU discovery, this field plays an
      additional role.  See <a href="#section-2.5.2">Section 2.5.2</a> for details.




<span class="grey">Smyslov                      Standards Track                    [Page 7]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-8" id="page-8" href="#page-8" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


   The other fields are identical to those specified in <a href="rfc7296.html#section-3.14">Section&nbsp;3.14 of
   [RFC7296]</a>.

   When prepending the IKE header to the IKE Fragment messages, it MUST
   be taken intact from the original message, except for the Length and
   Next Payload fields.  The Length field is adjusted to reflect the
   length of the IKE Fragment message being constructed, and the Next
   Payload field is set to the payload type of the first payload in that
   message (in most cases, it will be the Encrypted Fragment payload).
   After prepending the IKE header and all payloads that possibly
   precede the Encrypted payload in the original message (if any; see
   <a href="#section-2.5.3">Section 2.5.3</a>), the resulting messages are sent to the peer.

   Below is an example of fragmenting a message.

   HDR(MID=n), SK(NextPld=PLD1) {PLD1 ... PLDN}

                             Original Message


   HDR(MID=n), SKF(NextPld=PLD1, Frag#=1, TotalFrags=m) {...},
   HDR(MID=n), SKF(NextPld=0, Frag#=2, TotalFrags=m) {...},
   ...
   HDR(MID=n), SKF(NextPld=0, Frag#=m, TotalFrags=m) {...}

                           IKE Fragment Messages

<span class="h4"><a class="selflink" name="section-2.5.1" href="#section-2.5.1">2.5.1</a>.  Selecting Fragment Size</span>

   When splitting the content of an Encrypted payload into chunks, the
   sender SHOULD choose their size so that the resulting IP datagrams
   will be smaller than some fragmentation threshold.  Implementations
   may calculate the fragmentation threshold using various sources of
   information.

   If the sender has information about the PMTU size, it SHOULD use it.
   The responder in the exchange may use the maximum size of the
   received IKE Fragment message IP datagrams as a threshold when
   constructing a fragmented response.  Successful completion of
   previous exchanges (including those exchanges that cannot employ IKE
   fragmentation, e.g., IKE_SA_INIT) may be an indication that the
   fragmentation threshold can be set to the size of the largest message
   of those messages already sent.

   Otherwise, for messages to be sent over IPv6, it is RECOMMENDED that
   a value of 1280 bytes as a maximum IP datagram size be used
   ([<a href="rfc2460.html" title="&quot;Internet Protocol, Version 6 (IPv6) Specification&quot;">RFC2460</a>]).  For messages to be sent over IPv4, it is RECOMMENDED
   that a value of 576 bytes as a maximum IP datagram size be used.  The



<span class="grey">Smyslov                      Standards Track                    [Page 8]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-9" id="page-9" href="#page-9" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


   presence of tunnels on the path may reduce these values.
   Implementations may use other values if they are appropriate in the
   current environment.

   According to [<a href="https://tools.ietf.org/html/rfc0791" title="&quot;Internet Protocol&quot;">RFC0791</a>], the minimum IPv4 datagram size that is
   guaranteed not to be further fragmented is 68 bytes, but it is
   generally impossible to use such a small value for the solution
   described in this document.  Using 576 bytes is a compromise -- the
   value is large enough for the presented solution and small enough to
   avoid IP fragmentation in most situations.  Several other UDP-based
   protocols (Syslog, DNS, etc.) use 576 bytes as a safe low limit for
   IP datagram size.

   See <a href="#appendix-B">Appendix B</a> for correlation between IP datagram size and Encrypted
   payload content size.

<span class="h4"><a class="selflink" name="section-2.5.2" href="#section-2.5.2">2.5.2</a>.  PMTU Discovery</span>

   The amount of traffic that the IKE endpoint produces during the
   lifetime of an IKE SA is fairly modest -- it is usually below 100 KB
   within a period of several hours.  Most of this traffic consists of
   relatively short messages -- usually below several hundred bytes.  In
   most cases, the only time when IKE endpoints exchange messages of
   several KB in size is IKE SA establishment, and often each endpoint
   sends exactly one such message.

   For the reasons articulated above, implementing PMTU discovery in IKE
   is OPTIONAL.  It is believed that using the values recommended in
   <a href="#section-2.5.1">Section 2.5.1</a> as a fragmentation threshold will be sufficient in most
   cases.  Using these values could lead to suboptimal fragmentation,
   but it is acceptable given the amount of traffic IKE produces.
   Implementations may support PMTU discovery if there are good reasons
   to do it (for example, if they are intended to be used in
   environments where the MTU size might be less than the values listed
   in <a href="#section-2.5.1">Section 2.5.1</a>).

   PMTU discovery in IKE follows recommendations given in <a href="rfc4821.html#section-10.4">Section&nbsp;10.4
   of [RFC4821]</a> with some modifications, induced by the distinctive
   features of IKE listed above.  The difference is that the PMTU search
   is performed downward, while in [<a href="rfc4821.html" title="&quot;Packetization Layer Path MTU Discovery&quot;">RFC4821</a>] it is performed upward.
   The reason for this change is that IKE usually sends large messages
   only when the IKE SA is being established, and in many cases there is
   only one such message.  If the probing were performed upward, this
   message would be fragmented using the smallest allowable threshold,
   and usually all other messages are small enough to avoid IP
   fragmentation, so continued probing would be of little value.





<span class="grey">Smyslov                      Standards Track                    [Page 9]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-10" id="page-10" href="#page-10" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


   It is the initiator of the exchange who performs PMTU discovery.
   This is done by probing several values of fragmentation threshold.
   Implementations MUST be prepared to probe in every exchange that
   utilizes IKE fragmentation to deal with possible changes in path MTU
   over time.  While doing probes, it MUST start from larger values and
   refragment the original message, using the next smaller value of the
   threshold if it did not receive a response in a reasonable time after
   several retransmissions.  The exact number of retransmissions and
   length of timeouts are not covered in this specification because they
   do not affect interoperability.  However, the timeout interval is
   supposed to be relatively short, so that unsuccessful probes would
   not delay IKE operations too much.  Performing a few retries within
   several seconds for each probe seems appropriate, but different
   environments may require different rules.  When starting a new probe,
   the node MUST reset its retransmission timers so that if it employs
   exponential back-off the timers will start over.  After reaching the
   smallest allowed value for the fragmentation threshold, an
   implementation MUST continue retransmitting until the exchange either
   completes or times out using some timeout interval as discussed in
   <a href="rfc7296.html#section-2.4">Section&nbsp;2.4 of [RFC7296]</a>.

   PMTU discovery in IKE is supposed to be coarse-grained, i.e., it is
   expected that a node will try only a few fragmentation thresholds in
   order to minimize delays caused by unsuccessful probes.  If path MTU
   information is not yet available, the endpoint may use the link MTU
   size when it starts probing.  In subsequent exchanges, the node
   should start with the current value of the fragmentation threshold.

   If an implementation is capable of receiving ICMP error messages, it
   can additionally utilize classic PMTU discovery methods, as described
   in [<a href="rfc1191.html" title="&quot;Path MTU discovery&quot;">RFC1191</a>] and [<a href="rfc1981.html" title="&quot;Path MTU Discovery for IP version 6&quot;">RFC1981</a>].  In particular, if the initiator receives
   a Packet Too Big error in response to the probe, and it contains a
   smaller value than the current fragmentation threshold, then the
   initiator SHOULD stop retransmitting the probe and SHOULD select a
   new value for the fragmentation threshold that is less than or equal
   to the value from the ICMP message and meets the requirements listed
   below.

   In the case of PMTU discovery, the Total Fragments field is used to
   distinguish between different sets of fragments, i.e., the sets that
   were created by fragmenting the original message using different
   fragmentation thresholds.  Since the sender starts from larger
   fragments and then makes them smaller, the value in the Total
   Fragments field increases with each new probe.  When selecting the
   next smaller value for the fragmentation threshold, the sender MUST
   ensure that the value in the Total Fragments field is really
   increased.  This requirement should not be a problem for the sender,
   because PMTU discovery in IKE is supposed to be coarse-grained, so



<span class="grey">Smyslov                      Standards Track                   [Page 10]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-11" id="page-11" href="#page-11" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


   the difference between previous and next fragmentation thresholds
   should be significant anyway.  The need to distinguish between the
   sets is vital for the receiver, since receiving a valid fragment from
   a newer set means that it has to start the reassembly process over
   and not mix fragments from different sets.

<span class="h4"><a class="selflink" name="section-2.5.3" href="#section-2.5.3">2.5.3</a>.  Fragmenting Messages Containing Unprotected Payloads</span>

   Currently, there are no IKEv2 exchanges that define messages,
   containing both unprotected payloads and payloads, that are protected
   by the Encrypted payload.  However, IKEv2 does not prohibit such
   construction.  If some future IKEv2 extension defines such a message
   and it needs to be fragmented, all unprotected payloads MUST be
   placed in the first fragment (with the Fragment Number field equal to
   1), along with the Encrypted Fragment payload, which MUST be present
   in every IKE Fragment message and be the last payload in it.

   Below is an example of a fragmenting message that contains both
   protected and unprotected payloads.

   HDR(MID=n), PLD0, SK(NextPld=PLD1) {PLD1 ... PLDN}

                             Original Message


   HDR(MID=n), PLD0, SKF(NextPld=PLD1, Frag#=1, TotalFrags=m) {...},
   HDR(MID=n), SKF(NextPld=0, Frag#=2, TotalFrags=m) {...},
   ...
   HDR(MID=n), SKF(NextPld=0, Frag#=m, TotalFrags=m) {...}

                           IKE Fragment Messages

   Note that the size of each IP datagram bearing IKE Fragment messages
   should not exceed the fragmentation threshold, including the first
   one, that contains unprotected payloads.  This will reduce the size
   of the Encrypted Fragment payload content in the first IKE Fragment
   message to accommodate all unprotected payloads.  In an extreme case,
   the Encrypted Fragment payload will contain no data, but it still
   must be present in the message, because only its presence allows the
   receiver to determine that the sender has used IKE fragmentation.

<span class="h3"><a class="selflink" name="section-2.6" href="#section-2.6">2.6</a>.  Receiving IKE Fragment Message</span>

   The receiver identifies the IKE Fragment message by the presence of
   an Encrypted Fragment payload in it.  In most cases, it will be the
   first and only payload in the message; however, this may not be true
   for some hypothetical IKE exchanges (see <a href="#section-2.5.3">Section 2.5.3</a>).




<span class="grey">Smyslov                      Standards Track                   [Page 11]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-12" id="page-12" href="#page-12" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


   Upon receiving the IKE Fragment message, the following actions are
   performed:

   o  Check message validity - in particular, check whether the values
      in the Fragment Number and the Total Fragments fields in the
      Encrypted Fragment payload are valid.  The following tests need to
      be performed.

      *  check that the Fragment Number and the Total Fragments fields
         contain non-zero values

      *  check that the value in the Fragment Number field is less than
         or equal to the value in the Total Fragments field

      *  if reassembling has already started, check that the value in
         the Total Fragments field is equal to or greater than the Total
         Fragments field in the fragments that have already been stored
         in the reassembling queue

      If any of these tests fail, the message MUST be silently
      discarded.

   o  Check that this IKE Fragment message is new for the receiver and
      not a replay.  If an IKE Fragment message with the same Message
      ID, Fragment Number, and Total Fragments fields is already present
      in the reassembling queue, this message is considered a replay and
      MUST be silently discarded.

   o  Verify IKE Fragment message authenticity by checking the Integrity
      Check Value (ICV) in the Encrypted Fragment payload.  If the ICV
      check fails, the message MUST be silently discarded.

   o  If reassembling is not finished yet and the Total Fragments field
      in the received fragment is greater than the Total Fragments field
      in those fragments that are in the reassembling queue, the
      receiver MUST discard all received fragments and start the
      reassembly process over with just the received IKE Fragment
      message.

   o  Store the message in the reassembling queue waiting for the rest
      of the fragments to arrive.

   When all IKE Fragment messages (as indicated in the Total Fragments
   field) are received, the decrypted content of all Encrypted Fragment
   payloads is merged together to form the content of the original
   Encrypted payload and, therefore, along with the IKE header and





<span class="grey">Smyslov                      Standards Track                   [Page 12]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-13" id="page-13" href="#page-13" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


   unprotected payloads (if any), the original message.  Then, it is
   processed as if it was received, verified, and decrypted as a regular
   IKE message.

   If the receiver does not get all IKE fragments needed to reassemble
   the original message within a timeout interval, it MUST discard all
   IKE Fragment messages received so far for the exchange.  The next
   actions depend on the role of the receiver in the exchange.

   o  The initiator acts as described in <a href="rfc7296.html#section-2.1">Section&nbsp;2.1 of [RFC7296]</a>.  It
      either retransmits the fragmented request message or deems the IKE
      SA to have failed and deletes it.  The number of retransmits and
      length of timeouts for the initiator are not covered in this
      specification, since they are assumed to be the same as in a
      regular IKEv2 exchange and are discussed in <a href="rfc7296.html#section-2.4">Section&nbsp;2.4 of
      [RFC7296]</a>.

   o  The responder in this case acts as if no request message was
      received.  It would delete any memory of the incomplete request
      message and not treat it as an IKE SA failure.  It is RECOMMENDED
      that the reassembling timeout for the responder be equal to the
      time interval that the implementation waits before completely
      giving up when acting as the initiator of an exchange.
      <a href="rfc7296.html#section-2.4">Section&nbsp;2.4 of [RFC7296]</a> gives recommendations for selecting this
      interval.  Implementations can use a shorter timeout to conserve
      memory.

<span class="h4"><a class="selflink" name="section-2.6.1" href="#section-2.6.1">2.6.1</a>.  Replay Detection and Retransmissions</span>

   According to <a href="rfc7296.html#section-2.2">Section&nbsp;2.2 of [RFC7296]</a>, the Message ID is used, in
   particular, to identify retransmissions of IKE messages.  Each
   request or response message, sent by either side, must have a unique
   Message ID, or be considered a retransmission otherwise.  This logic
   has already been updated by [<a href="rfc6311.html" title="&quot;Protocol Support for High Availability of IKEv2/ IPsec&quot;">RFC6311</a>], which deliberately allows any
   number of messages with zero Message ID.  This document also updates
   this logic for those situations where IKE fragmentation is in use.

   If an incoming message contains an Encrypted Fragment payload, the
   values of the Fragment Number and Total Fragments fields MUST be used
   along with the Message ID to detect retransmissions and replays.

   If the responder receives a retransmitted fragment of a request when
   it has already processed that request and has sent back a response,
   that event MUST only trigger a retransmission of the response message
   (fragmented or not) if the Fragment Number field in the received
   fragment is set to 1; otherwise, it MUST be ignored.





<span class="grey">Smyslov                      Standards Track                   [Page 13]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-14" id="page-14" href="#page-14" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


<span class="h2"><a class="selflink" name="section-3" href="#section-3">3</a>.  Interaction with Other IKE Extensions</span>

   IKE fragmentation is compatible with most IKE extensions, such as IKE
   Session Resumption ([<a href="rfc5723.html" title="&quot;Internet Key Exchange Protocol Version 2 (IKEv2) Session Resumption&quot;">RFC5723</a>]), the Quick Crash Detection Method
   ([<a href="rfc6290.html" title="&quot;A Quick Crash Detection Method for the Internet Key Exchange Protocol (IKE)&quot;">RFC6290</a>]), and so on.  It neither affects their operation nor is
   affected by them.  It is believed that IKE fragmentation will also be
   compatible with future IKE extensions, if they follow general
   principles of formatting, sending, and receiving IKE messages, as
   described in [<a href="rfc7296.html" title="&quot;Internet Key Exchange Protocol Version 2 (IKEv2)&quot;">RFC7296</a>].

   When IKE fragmentation is used with IKE Session Resumption
   ([<a href="rfc5723.html" title="&quot;Internet Key Exchange Protocol Version 2 (IKEv2) Session Resumption&quot;">RFC5723</a>]), messages of an IKE_SESSION_RESUME exchange cannot be
   fragmented, since they do not contain an Encrypted payload.  These
   messages may be large due to the ticket size.  To avoid IP
   fragmentation in this situation, it is recommended that smaller
   tickets be used, e.g., by utilizing a "ticket by reference" approach
   instead of "ticket by value".

   Protocol Support for High Availability of IKEv2/IPsec, described in
   [<a href="rfc6311.html" title="&quot;Protocol Support for High Availability of IKEv2/ IPsec&quot;">RFC6311</a>], requires special care when deciding whether to fragment an
   IKE message or not.  Since it deliberately allows any number of
   synchronization exchanges to have the same Message ID, namely zero,
   standard IKEv2 replay detection logic, based on checking the Message
   ID, is not applicable for such messages, and the receiver has to
   check message content to detect replays.  When implementing IKE
   fragmentation along with [<a href="rfc6311.html" title="&quot;Protocol Support for High Availability of IKEv2/ IPsec&quot;">RFC6311</a>], IKE Message ID Synchronization
   messages MUST NOT be sent fragmented, to simplify the receiver's task
   of detecting replays.  Fortunately, these messages are small, and
   there is no point in fragmenting them anyway.

<span class="h2"><a class="selflink" name="section-4" href="#section-4">4</a>.  Transport Considerations</span>

   With IKE fragmentation, if any single IKE Fragment message gets lost,
   the receiver becomes unable to reassemble the original message.  So,
   in general, using IKE fragmentation implies a higher probability that
   the message will not be delivered to the peer.  Although in most
   network environments the difference will be insignificant, on some
   lossy networks it may become noticeable.  When using IKE
   fragmentation, implementations MAY use longer timeouts and do more
   retransmits than usual before considering the peer dead.

   Note that Fragment messages are not individually acknowledged.  The
   response Fragment messages are all sent back together only when all
   fragments of the request are received, and the original request
   message is reassembled and successfully processed.






<span class="grey">Smyslov                      Standards Track                   [Page 14]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-15" id="page-15" href="#page-15" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


<span class="h2"><a class="selflink" name="section-5" href="#section-5">5</a>.  Security Considerations</span>

   Most of the security considerations for IKE fragmentation are the
   same as those for the base IKEv2 protocol described in [<a href="rfc7296.html" title="&quot;Internet Key Exchange Protocol Version 2 (IKEv2)&quot;">RFC7296</a>].
   This extension introduces the Encrypted Fragment payload to protect
   the content of an IKE Message Fragment.  This allows the receiver to
   individually check the authenticity of fragments, thus protecting
   peers from a DoS attack.

   The Security Considerations section of [<a href="rfc7296.html" title="&quot;Internet Key Exchange Protocol Version 2 (IKEv2)&quot;">RFC7296</a>] mentions a possible
   attack on IKE where an attacker could prevent an exchange from
   completing by exhausting the IP reassembly buffers.  The mechanism
   described in this document allows IKE to avoid IP fragmentation and
   therefore increases its robustness to DoS attacks.

   The following attack is possible with IKE fragmentation.  An attacker
   can initiate an IKE_SA_INIT exchange, complete it, compute SK_a and
   SK_e, and then send a large but still incomplete set of IKE_AUTH
   fragments.  These fragments will pass the ICV check and will be
   stored in reassembly buffers, but since the set is incomplete, the
   reassembling will never succeed and eventually will time out.  If the
   set is large, this attack could potentially exhaust the receiver's
   memory resources.

   To mitigate the impact of this attack, it is RECOMMENDED that the
   receiver limit the number of fragments it stores in the reassembling
   queue so that the sum of the sizes of Encrypted Fragment payload
   contents (after decryption) for fragments that are already placed
   into the reassembling queue is less than some value that is
   reasonable for the implementation.  If the peer sends so many
   fragments that the above condition is not met, the receiver can
   consider this situation to be either an attack or a broken sender
   implementation.  In either case, the receiver SHOULD drop the
   connection and discard all the received fragments.

   This value can be predefined, can be a configurable option, or can be
   calculated dynamically, depending on the receiver's memory load.
   Some care should be taken when selecting this value because if it is
   too small it might prevent a legitimate peer from establishing an IKE
   SA if the size of messages it sends exceeds this value.  It is NOT
   RECOMMENDED for this value to exceed 64 KB because any IKE message
   before fragmentation would likely be shorter than that.

   If IKE fragments arrive in order, it is possible, but not advised,
   for the receiver to parse the beginning of the message that is being
   reassembled and extract the already-available payloads before the
   reassembly is complete.  It can be dangerous to take any action based
   on the content of these payloads, because the fragments that have not



<span class="grey">Smyslov                      Standards Track                   [Page 15]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-16" id="page-16" href="#page-16" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


   yet been received might contain payloads that could change the
   meaning of them (or could even make the whole message invalid), and
   this can potentially be exploited by an attacker.  It is important to
   address this threat by ensuring that all the fragments are received
   prior to parsing the reassembled message, as described in
   <a href="#section-2.6">Section 2.6</a>.

<span class="h2"><a class="selflink" name="section-6" href="#section-6">6</a>.  IANA Considerations</span>

   This document defines a new payload in the "IKEv2 Payload Types"
   registry:

     53       Encrypted and Authenticated Fragment      SKF

   This document also defines a new Notify Message Type in the "IKEv2
   Notify Message Types - Status Types" registry:

     16430       IKEV2_FRAGMENTATION_SUPPORTED

<span class="h2"><a class="selflink" name="section-7" href="#section-7">7</a>.  References</span>

<span class="h3"><a class="selflink" name="section-7.1" href="#section-7.1">7.1</a>.  Normative References</span>

   [<a name="ref-RFC2119" id="ref-RFC2119">RFC2119</a>]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", <a href="https://tools.ietf.org/html/bcp14">BCP 14</a>, <a href="rfc2119.html">RFC 2119</a>, March 1997,
              &lt;<a href="http://www.rfc-editor.org/info/rfc2119">http://www.rfc-editor.org/info/rfc2119</a>&gt;.

   [<a name="ref-RFC7296" id="ref-RFC7296">RFC7296</a>]  Kaufman, C., Hoffman, P., Nir, Y., Eronen, P., and T.
              Kivinen, "Internet Key Exchange Protocol Version 2
              (IKEv2)", STD 79, <a href="rfc7296.html">RFC 7296</a>, October 2014,
              &lt;<a href="http://www.rfc-editor.org/info/rfc7296">http://www.rfc-editor.org/info/rfc7296</a>&gt;.

   [<a name="ref-RFC6311" id="ref-RFC6311">RFC6311</a>]  Singh, R., Kalyani, G., Nir, Y., Sheffer, Y., and D.
              Zhang, "Protocol Support for High Availability of IKEv2/
              IPsec", <a href="rfc6311.html">RFC 6311</a>, July 2011,
              &lt;<a href="http://www.rfc-editor.org/info/rfc6311">http://www.rfc-editor.org/info/rfc6311</a>&gt;.

<span class="h3"><a class="selflink" name="section-7.2" href="#section-7.2">7.2</a>.  Informative References</span>

   [<a name="ref-RFC0791" id="ref-RFC0791">RFC0791</a>]  Postel, J., "Internet Protocol", STD 5, <a href="rfc791.html">RFC 791</a>,
              September 1981, &lt;<a href="http://www.rfc-editor.org/info/rfc791">http://www.rfc-editor.org/info/rfc791</a>&gt;.

   [<a name="ref-RFC1191" id="ref-RFC1191">RFC1191</a>]  Mogul, J. and S. Deering, "Path MTU discovery", <a href="rfc1191.html">RFC 1191</a>,
              November 1990, &lt;<a href="http://www.rfc-editor.org/info/rfc1191">http://www.rfc-editor.org/info/rfc1191</a>&gt;.

   [<a name="ref-RFC1981" id="ref-RFC1981">RFC1981</a>]  McCann, J., Deering, S., and J. Mogul, "Path MTU Discovery
              for IP version 6", <a href="rfc1981.html">RFC 1981</a>, August 1996,
              &lt;<a href="http://www.rfc-editor.org/info/rfc1981">http://www.rfc-editor.org/info/rfc1981</a>&gt;.



<span class="grey">Smyslov                      Standards Track                   [Page 16]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-17" id="page-17" href="#page-17" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


   [<a name="ref-RFC2460" id="ref-RFC2460">RFC2460</a>]  Deering, S. and R. Hinden, "Internet Protocol, Version 6
              (IPv6) Specification", <a href="rfc2460.html">RFC 2460</a>, December 1998,
              &lt;<a href="http://www.rfc-editor.org/info/rfc2460">http://www.rfc-editor.org/info/rfc2460</a>&gt;.

   [<a name="ref-RFC4787" id="ref-RFC4787">RFC4787</a>]  Audet, F. and C. Jennings, "Network Address Translation
              (NAT) Behavioral Requirements for Unicast UDP", <a href="https://tools.ietf.org/html/bcp127">BCP 127</a>,
              <a href="rfc4787.html">RFC 4787</a>, January 2007,
              &lt;<a href="http://www.rfc-editor.org/info/rfc4787">http://www.rfc-editor.org/info/rfc4787</a>&gt;.

   [<a name="ref-RFC4821" id="ref-RFC4821">RFC4821</a>]  Mathis, M. and J. Heffner, "Packetization Layer Path MTU
              Discovery", <a href="rfc4821.html">RFC 4821</a>, March 2007,
              &lt;<a href="http://www.rfc-editor.org/info/rfc4821">http://www.rfc-editor.org/info/rfc4821</a>&gt;.

   [<a name="ref-RFC5282" id="ref-RFC5282">RFC5282</a>]  Black, D. and D. McGrew, "Using Authenticated Encryption
              Algorithms with the Encrypted Payload of the Internet Key
              Exchange version 2 (IKEv2) Protocol", <a href="rfc5282.html">RFC 5282</a>,
              August 2008, &lt;<a href="http://www.rfc-editor.org/info/rfc5282">http://www.rfc-editor.org/info/rfc5282</a>&gt;.

   [<a name="ref-RFC5405" id="ref-RFC5405">RFC5405</a>]  Eggert, L. and G. Fairhurst, "Unicast UDP Usage Guidelines
              for Application Designers", <a href="https://tools.ietf.org/html/bcp145">BCP 145</a>, <a href="rfc5405.html">RFC 5405</a>,
              November 2008, &lt;<a href="http://www.rfc-editor.org/info/rfc5405">http://www.rfc-editor.org/info/rfc5405</a>&gt;.

   [<a name="ref-RFC5723" id="ref-RFC5723">RFC5723</a>]  Sheffer, Y. and H. Tschofenig, "Internet Key Exchange
              Protocol Version 2 (IKEv2) Session Resumption", <a href="rfc5723.html">RFC 5723</a>,
              January 2010, &lt;<a href="http://www.rfc-editor.org/info/rfc5723">http://www.rfc-editor.org/info/rfc5723</a>&gt;.

   [<a name="ref-RFC6290" id="ref-RFC6290">RFC6290</a>]  Nir, Y., Wierbowski, D., Detienne, F., and P. Sethi, "A
              Quick Crash Detection Method for the Internet Key Exchange
              Protocol (IKE)", <a href="rfc6290.html">RFC 6290</a>, June 2011,
              &lt;<a href="http://www.rfc-editor.org/info/rfc6290">http://www.rfc-editor.org/info/rfc6290</a>&gt;.

   [<a name="ref-RFC6888" id="ref-RFC6888">RFC6888</a>]  Perreault, S., Yamagata, I., Miyakawa, S., Nakagawa, A.,
              and H. Ashida, "Common Requirements for Carrier-Grade NATs
              (CGNs)", <a href="https://tools.ietf.org/html/bcp127">BCP 127</a>, <a href="rfc6888.html">RFC 6888</a>, April 2013,
              &lt;<a href="http://www.rfc-editor.org/info/rfc6888">http://www.rfc-editor.org/info/rfc6888</a>&gt;.

   [<a name="ref-FRAGDROP" id="ref-FRAGDROP">FRAGDROP</a>] Jaeggli, J., Colitti, L., Kumari, W., Vyncke, E., Kaeo,
              M., and T. Taylor, "Why Operators Filter Fragments and
              What It Implies", Work in Progress, <a href="https://tools.ietf.org/html/draft-taylor-v6ops-fragdrop-02">draft-taylor-v6ops-</a>
              <a href="https://tools.ietf.org/html/draft-taylor-v6ops-fragdrop-02">fragdrop-02</a>, December 2013.











<span class="grey">Smyslov                      Standards Track                   [Page 17]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-18" id="page-18" href="#page-18" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


   [<a name="ref-BLACKHOLES" id="ref-BLACKHOLES">BLACKHOLES</a>]
              De Boer, M. and J. Bosma, "Discovering Path MTU black
              holes on the Internet using RIPE Atlas", July 2012,
              &lt;<a href="http://www.nlnetlabs.nl/downloads/publications/pmtu-black-holes-msc-thesis.pdf">http://www.nlnetlabs.nl/downloads/publications/</a>
              <a href="http://www.nlnetlabs.nl/downloads/publications/pmtu-black-holes-msc-thesis.pdf">pmtu-black-holes-msc-thesis.pdf</a>&gt;.

   [<a name="ref-DOSUDPPROT" id="ref-DOSUDPPROT">DOSUDPPROT</a>]
              Kaufman, C., Perlman, R., and B. Sommerfeld, "DoS
              protection for UDP-based protocols", ACM Conference on
              Computer and Communications Security, October 2003.









































<span class="grey">Smyslov                      Standards Track                   [Page 18]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-19" id="page-19" href="#page-19" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


<span class="h2"><a class="selflink" name="appendix-A" href="#appendix-A">Appendix A</a>.  Design Rationale</span>

   The simplest approach to IKE fragmentation would have been to
   fragment a message that is fully formed and ready to be sent.
   However, if a message got fragmented after being encrypted and
   authenticated, this could make a simple DoS attack possible.  The
   attacker could infrequently emit forged but valid-looking fragments
   into the network, and some of these fragments would be fetched by the
   receiver into the reassembling queue.  The receiver would not be able
   to distinguish forged fragments from valid ones and would only be
   able to determine that some of the received fragments were forged
   after the whole message was reassembled and its authenticity check
   failed.

   To prevent this kind of attack and also reduce vulnerability to some
   other kinds of DoS attacks, it was decided to perform fragmentation
   before applying cryptographic protection to the message.  In this
   case, each Fragment message becomes individually encrypted and
   authenticated; this allows the receiver to determine forged fragments
   and not store them in the reassembling queue.

<span class="h2"><a class="selflink" name="appendix-B" href="#appendix-B">Appendix B</a>.  Correlation between IP Datagram Size and Encrypted Payload</span>
             Content Size

   In the case of IPv4, the content size of the Encrypted Payload is
   less than the IP datagram size by the sum of the following values:

   o  IPv4 header size (typically 20 bytes, up to 60 if IP options are
      present)

   o  UDP header size (8 bytes)

   o  non-ESP (Encapsulating Security Payload) marker size (4 bytes if
      present)

   o  IKE header size (28 bytes)

   o  Encrypted payload header size (4 bytes)

   o  initialization vector (IV) size (variable)

   o  padding and its size (at least 1 byte)

   o  ICV size (variable)

   The sum may be estimated as 61..105 bytes + IV + ICV + padding.





<span class="grey">Smyslov                      Standards Track                   [Page 19]</span></pre>
<hr class='noprint' style='width: 96ex;' align='left'/><!--NewPage--><pre class='newpage'><a name="page-20" id="page-20" href="#page-20" class="invisible"> </a>
<span class="grey"><a href="rfc7383.html">RFC 7383</a>                   IKEv2 Fragmentation             November 2014</span>


   In the case of IPv6, the content size of the Encrypted Payload is
   less than the IP datagram size by the sum of the following values:

   o  IPv6 header size (40 bytes)

   o  IPv6 extension headers (optional; size varies)

   o  UDP header size (8 bytes)

   o  non-ESP marker size (4 bytes if present)

   o  IKE header size (28 bytes)

   o  Encrypted payload header size (4 bytes)

   o  IV size (variable)

   o  padding and its size (at least 1 byte)

   o  ICV size (variable)

   If no extension header is present, the sum may be estimated as
   81..85 bytes + IV + ICV + padding.  If extension headers are present,
   the payload content size is further reduced by the sum of the size of
   the extension headers.  The length of each extension header can be
   calculated as 8 * (Hdr Ext Len) bytes, except for the fragment
   header, which is always 8 bytes in length.

Acknowledgements

   The author would like to thank Tero Kivinen, Yoav Nir, Paul Wouters,
   Yaron Sheffer, Joe Touch, Derek Atkins, Ole Troan, and others for
   their reviews and valuable comments.  Thanks to Ron Bonica for
   contributing text to the Introduction section.  Thanks to Paul
   Hoffman and Barry Leiba for improving text clarity.

Author's Address

   Valery Smyslov
   ELVIS-PLUS
   PO Box 81
   Moscow (Zelenograd)  124460
   Russian Federation

   Phone: +7 495 276 0211
   EMail: svan@elvis.ru





Smyslov                      Standards Track                   [Page 20]

</pre><br />
    <span class="noprint"><small><small>Html markup produced by rfcmarkup 1.129c, available from
      <a href="https://tools.ietf.org/tools/rfcmarkup/">https://tools.ietf.org/tools/rfcmarkup/</a>
    </small></small></span>
  </div>
</body>

<!-- Mirrored from tools.ietf.org/html/rfc7383 by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 28 Jul 2019 12:31:34 GMT -->
</html>
