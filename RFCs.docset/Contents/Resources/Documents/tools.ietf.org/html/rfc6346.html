<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><!-- Mirrored from tools.ietf.org/html/rfc6346 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Mar 2018 23:18:30 GMT --><!-- Added by HTTrack --><head><meta content="text/html;charset=utf-8" http-equiv="content-type"/><!-- /Added by HTTrack -->

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <meta content="index,follow" name="robots"/>
    <meta content="rfcmarkup version 1.126" name="creator"/>
    <link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/>
<meta content="draft-boucadair-behave-ipv6-portrange" name="DC.Relation.Replaces"/>
<meta content="urn:ietf:rfc:6346" name="DC.Identifier"/>
<meta content="August, 2011" name="DC.Date.Issued"/>
<meta content="Cittadini, Luca" name="DC.Creator"/>
<meta content="Maennel, Olaf" name="DC.Creator"/>
<meta content="Bush, Randy" name="DC.Creator"/>
<meta content="Bellovin, Steven M." name="DC.Creator"/>
<meta content="We are facing the exhaustion of the IANA IPv4 free IP address pool.
Unfortunately, IPv6 is not yet deployed widely enough to fully replace
IPv4, and it is unrealistic to expect that this is going to change
before we run out of IPv4 addresses. Letting hosts seamlessly
communicate in an IPv4-world without assigning a unique globally
routable IPv4 address to each of them is a challenging problem. This
draft discusses the possibility address sharing by treating some of
the port number bits as part of an extended IPv4 address (Address plus
Port, or A+P). Instead of assigning a single IPv4 address to a device,
we propose to extended the address by &quot;stealing&quot; bits from the port
number in the TCP/UDP header, leaving the applications a reduced range
of ports. This means assigning the same IP to different clients (e.g.,
CPE's, mobile phones), each with its port- range. In the face of
IPv4 address exhaustion, the need for addresses is stronger than the
need to be able to address thousands of applications on a single host.
This document discusses overall constraints that apply to address
sharing proposals. [I-D.levis-behave-ipv4-shortage-framework] gives an
overview over the solution space and questions that need to be
addressed, while [I-D.durand-softwire-dual-stack-lite], [I-D
.boucadair-port-range], [I-D.boucadair-dhc-port-range], [I-D.bajko-
v6ops-port-restricted-ipaddr-assign], suggest various ways of
overcoming the problems of shared addresses." name="DC.Description.Abstract"/>
<meta content="The A+P Approach to the IPv4 Address Shortage" name="DC.Title"/>

    <link href="https://tools.ietf.org/images/rfc.png" rel="icon" type="image/png"/>
    <link href="https://tools.ietf.org/images/rfc.png" rel="shortcut icon" type="image/png"/>
    <title>RFC 6346 - The A+P Approach to the IPv4 Address Shortage</title>
    
    
    <style type="text/css">
	@media only screen 
	  and (min-width: 992px)
	  and (max-width: 1199px) {
	    body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 768px)
	  and (max-width: 991px) {
            body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 480px)
	  and (max-width: 767px) {
            body { font-size: 11pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (max-width: 479px) {
            body { font-size: 8pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-device-width : 375px) 
	  and (max-device-width : 667px) {
            body { font-size: 9.5pt; }
            div.content { width: 96ex; margin: 0 1px; }
        }
	@media only screen 
	  and (min-device-width: 1200px) {
            body { font-size: 10pt; margin: 0 4em; }
            div.content { width: 96ex; margin: 0; }
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        a.selflink {
          color: black;
          text-decoration: none;
        }
        @media print {
            body {
                font-family: monospace;
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 1em;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>                   <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>                     <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>             <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>              <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td>      <td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td>         <td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard (old designation):</td> <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Internet Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>                  <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>                  <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
  <div class="content">
   <div style="height: 13px;">
      <div class="pre noprint docinfo bgyellow" onclick="showElem('legend');" onmouseout="hideElem('legend')" onmouseover="this.style.cursor='pointer';" style="height: 6px; position: absolute;" title="Click for colour legend.">                                                                        </div>
      <div class="docinfo noprint pre legend" id="legend" onmouseout="hideElem('legend');" onmouseover="showElem('legend');" style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; ">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="index.html" title="Document search and retrieval page">Docs</a>] [<a href="https://tools.ietf.org/rfc/rfc6346.txt" title="Plaintext version of this document">txt</a>|<a href="https://tools.ietf.org/pdf/rfc6346" title="PDF version of this document">pdf</a>] [<a href="https://tools.ietf.org/html/draft-ymbk-aplusp" title="draft-ymbk-aplusp">draft-ymbk-aplusp</a>] [<a href="https://datatracker.ietf.org/doc/rfc6346" title="IESG Datatracker information for this document">Tracker</a>] [<a href="https://tools.ietf.org/rfcdiff?difftype=--hwdiff&amp;url2=rfc6346" title="Inline diff (wdiff)">Diff1</a>] [<a href="https://tools.ietf.org/rfcdiff?url2=rfc6346" title="Side-by-side diff">Diff2</a>]          </span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<span class="pre noprint docinfo">                                                            EXPERIMENTAL</span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<pre>Internet Engineering Task Force (IETF)                      R. Bush, Ed.
Request for Comments: 6346                     Internet Initiative Japan
Category: Experimental                                       August 2011
ISSN: 2070-1721


   <span class="h1">The Address plus Port (A+P) Approach to the IPv4 Address Shortage</span>

Abstract

   We are facing the exhaustion of the IANA IPv4 free IP address pool.
   Unfortunately, IPv6 is not yet deployed widely enough to fully
   replace IPv4, and it is unrealistic to expect that this is going to
   change before the depletion of IPv4 addresses.  Letting hosts
   seamlessly communicate in an IPv4 world without assigning a unique
   globally routable IPv4 address to each of them is a challenging
   problem.

   This document proposes an IPv4 address sharing scheme, treating some
   of the port number bits as part of an extended IPv4 address (Address
   plus Port, or A+P).  Instead of assigning a single IPv4 address to a
   single customer device, we propose to extend the address field by
   using bits from the port number range in the TCP/UDP header as
   additional endpoint identifiers, thus leaving a reduced range of
   ports available to applications.  This means assigning the same IPv4
   address to multiple clients (e.g., Customer Premises Equipment (CPE),
   mobile phones), each with its assigned port range.  In the face of
   IPv4 address exhaustion, the need for addresses is stronger than the
   need to be able to address thousands of applications on a single
   host.  If address translation is needed, the end-user should be in
   control of the translation process -- not some smart boxes in the
   core.



















<span class="grey">Bush                          Experimental                      [Page 1]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-2" id="page-2" name="page-2"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


Status of This Memo

   This document is not an Internet Standards Track specification; it is
   published for examination, experimental implementation, and
   evaluation.

   This document defines an Experimental Protocol for the Internet
   community.  This document is a product of the Internet Engineering
   Task Force (IETF).  It represents the consensus of the IETF
   community.  It has received public review and has been approved for
   publication by the Internet Engineering Steering Group (IESG).  Not
   all documents approved by the IESG are a candidate for any level of
   Internet Standard; see <a href="rfc5741.html#section-2">Section 2 of RFC 5741</a>.

   Information about the current status of this document, any errata,
   and how to provide feedback on it may be obtained at
   <a href="http://www.rfc-editor.org/info/rfc6346">http://www.rfc-editor.org/info/rfc6346</a>.

Copyright Notice

   Copyright (c) 2011 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="https://tools.ietf.org/html/bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.



















<span class="grey">Bush                          Experimental                      [Page 2]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-3" id="page-3" name="page-3"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


Table of Contents

   <a href="#section-1">1</a>.  Introduction . . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-4">4</a>
     <a href="#section-1.1">1.1</a>.  Problems with Carrier Grade NATs . . . . . . . . . . . . .  <a href="#page-4">4</a>
     <a href="#section-1.2">1.2</a>.  Requirements Language  . . . . . . . . . . . . . . . . . .  <a href="#page-5">5</a>
   <a href="#section-2">2</a>.  Terminology  . . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-5">5</a>
   <a href="#section-3">3</a>.  Design Constraints and Functions . . . . . . . . . . . . . . .  <a href="#page-6">6</a>
     <a href="#section-3.1">3.1</a>.  Design Constraints . . . . . . . . . . . . . . . . . . . .  <a href="#page-6">6</a>
     <a href="#section-3.2">3.2</a>.  A+P Functions  . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-7">7</a>
     <a href="#section-3.3">3.3</a>.  Overview of the A+P Solution . . . . . . . . . . . . . . .  <a href="#page-8">8</a>
       <a href="#section-3.3.1">3.3.1</a>.  Signaling  . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-9">9</a>
       <a href="#section-3.3.2">3.3.2</a>.  Address Realm  . . . . . . . . . . . . . . . . . . . . <a href="#page-11">11</a>
       <a href="#section-3.3.3">3.3.3</a>.  Reasons for Allowing Multiple A+P Gateways . . . . . . <a href="#page-15">15</a>
       <a href="#section-3.3.4">3.3.4</a>.  Overall A+P Architecture . . . . . . . . . . . . . . . <a href="#page-16">16</a>
     <a href="#section-3.4">3.4</a>.  A+P Experiments  . . . . . . . . . . . . . . . . . . . . . <a href="#page-17">17</a>
   <a href="#section-4">4</a>.  Stateless A+P Mapping Function . . . . . . . . . . . . . . . . <a href="#page-18">18</a>
     4.1.  Stateless A+P Mapping (SMAP) Gateway Function
           Description  . . . . . . . . . . . . . . . . . . . . . . . <a href="#page-18">18</a>
     <a href="#section-4.2">4.2</a>.  Implementation Mode  . . . . . . . . . . . . . . . . . . . <a href="#page-20">20</a>
     <a href="#section-4.3">4.3</a>.  Towards IPv6-Only Networks . . . . . . . . . . . . . . . . <a href="#page-22">22</a>
     <a href="#section-4.4">4.4</a>.  PRR: On Stateless and Binding Table Modes  . . . . . . . . <a href="#page-22">22</a>
     <a href="#section-4.5">4.5</a>.  General Recommendations on SMAP  . . . . . . . . . . . . . <a href="#page-23">23</a>
   <a href="#section-5">5</a>.  Deployment Scenarios . . . . . . . . . . . . . . . . . . . . . <a href="#page-24">24</a>
     <a href="#section-5.1">5.1</a>.  A+P Deployment Models  . . . . . . . . . . . . . . . . . . <a href="#page-24">24</a>
       <a href="#section-5.1.1">5.1.1</a>.  A+P for Broadband Providers  . . . . . . . . . . . . . <a href="#page-24">24</a>
       <a href="#section-5.1.2">5.1.2</a>.  A+P for Mobile Providers . . . . . . . . . . . . . . . <a href="#page-24">24</a>
       <a href="#section-5.1.3">5.1.3</a>.  A+P from the Provider Network Perspective  . . . . . . <a href="#page-25">25</a>
     <a href="#section-5.2">5.2</a>.  Dynamic Allocation of Port Ranges  . . . . . . . . . . . . <a href="#page-27">27</a>
     <a href="#section-5.3">5.3</a>.  Example of A+P-Forwarded Packets . . . . . . . . . . . . . <a href="#page-28">28</a>
       <a href="#section-5.3.1">5.3.1</a>.  Forwarding of Standard Packets . . . . . . . . . . . . <a href="#page-32">32</a>
       <a href="#section-5.3.2">5.3.2</a>.  Handling ICMP  . . . . . . . . . . . . . . . . . . . . <a href="#page-32">32</a>
       <a href="#section-5.3.3">5.3.3</a>.  Fragmentation  . . . . . . . . . . . . . . . . . . . . <a href="#page-33">33</a>
       <a href="#section-5.3.4">5.3.4</a>.  Limitations of the A+P Approach  . . . . . . . . . . . <a href="#page-33">33</a>
       <a href="#section-5.3.5">5.3.5</a>.  Port Allocation Strategy Agnostic  . . . . . . . . . . <a href="#page-34">34</a>
   <a href="#section-6">6</a>.  Security Considerations  . . . . . . . . . . . . . . . . . . . <a href="#page-34">34</a>
   <a href="#section-7">7</a>.  Acknowledgments  . . . . . . . . . . . . . . . . . . . . . . . <a href="#page-35">35</a>
   <a href="#section-8">8</a>.  References . . . . . . . . . . . . . . . . . . . . . . . . . . <a href="#page-35">35</a>
     <a href="#section-8.1">8.1</a>.  Normative References . . . . . . . . . . . . . . . . . . . <a href="#page-35">35</a>
     <a href="#section-8.2">8.2</a>.  Informative References . . . . . . . . . . . . . . . . . . <a href="#page-35">35</a>
   <a href="#section-9">9</a>.  Contributing Authors . . . . . . . . . . . . . . . . . . . . . <a href="#page-37">37</a>











<span class="grey">Bush                          Experimental                      [Page 3]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-4" id="page-4" name="page-4"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/1.%20%20Introduction"></a><a class="selflink" href="#section-1" name="section-1">1</a>.  Introduction</span>

   This document describes a technique to deal with the imminent IPv4
   address space exhaustion.  Many large Internet Service Providers
   (ISPs) face the problem that their networks' customer edges are so
   large that it will soon not be possible to provide each customer with
   a unique public IPv4 address.  Therefore, although undesirable,
   address sharing, in the same molds as NAT, is inevitable.

   To allow end-to-end connectivity between IPv4-speaking applications,
   we propose to extend the semantics of the IPv4 address with bits from
   the UDP/TCP header.  Assuming we could limit the applications' port
   addressing to any number of bits lower than 16, we can increase the
   effective size of an IPv4 address by remaining additional bits of up
   to 16.  In this scenario, 1 to 65536 customers could be multiplexed
   on the same IPv4 address, while allowing them a fixed or dynamic
   range of 1 to 65536 ports.  Customers could, for example, receive an
   initial fixed port range, defined by the operator, and dynamically
   request additional blocks, depending on their contract.  We call this
   "extended addressing" or "A+P" (Address plus Port) addressing.  The
   main advantage of A+P is that it preserves the Internet "end-to-end"
   paradigm by not requiring translation (at least for some ports) of an
   IP address.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/1.1.%20%20Problems%20with%20Carrier%20Grade%20NATs"></a><a class="selflink" href="#section-1.1" name="section-1.1">1.1</a>.  Problems with Carrier Grade NATs</span>

   Various forms of NATs will be installed at different levels and
   places in the IPv4 Internet to achieve address compression.  This
   document argues for mechanisms where this happens as close to the
   edge of the network as possible, thereby minimizing damage to the
   End-to-End Principle and allowing end-customers to retain control
   over the address and port translation.  Therefore, it is essential to
   create mechanisms to "bypass" NATs in the core, when applicable, and
   keep the control at the end-user.

   With Carrier Grade NATs (CGNs) in the core of the network, the user
   is trapped behind unchangeable application policies, and the
   deployment of new applications is hindered by the need to implement
   the corresponding Application Level Gateways (ALGs) on the CGNs.
   This is the opposite of the "end-to-end" model of the Internet.

   With the smarts at the edges, one can easily deploy new applications
   between consenting endpoints by merely tweaking the NATs at the
   corresponding CPE, or even upgrading them to a new version that
   supports a specific ALG.






<span class="grey">Bush                          Experimental                      [Page 4]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-5" id="page-5" name="page-5"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   Today's NATs are typically mitigated by offering the customers
   limited control over them, e.g., port forwarding, Universal Plug and
   Play or the NAT Port Mapping Protocol (UPnP/NAT-PMP).  However, this
   is not expected to work with CGNs.  CGN proposals -- other than
   DS-Lite [<a href="rfc6333.html" title='"Dual- Stack Lite Broadband Deployments Following IPv4 Exhaustion"'>RFC6333</a>] with A+P or the Port Control Protocol (PCP)
   [<a href="#ref-PCP-BASE">PCP-BASE</a>] -- admit that it is not expected that applications that
   require specific port assignment or port mapping from the NAT box
   will keep working.

   Another issue with CGNs is the trade-off between session state and
   network placement.  The farther from the edge the CGN is placed, the
   more session state needs to be kept due to larger subscriber
   aggregation and the more disruption that occurs in the case of a
   failure.  In order to reduce the state, CGNs would end up somewhere
   closer to the edge.  Thus, the CGN trades scalability for the amount
   of state that needs to be kept, which makes optimally placing a CGN a
   hard engineering problem.

   In some deployment scenarios, a CGN can be seen as the single point
   of failure, and therefore the availability of delivered services can
   be impacted by a single CGN device.  Means to ensure state
   synchronization and failover would be required to allow for service
   continuity whenever a failure occurs.

   Intra-domain paths may not be optimal for communications between two
   nodes connected to the same domain deploying CGNs; they may lead to
   path stretches.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/1.2.%20%20Requirements%20Language"></a><a class="selflink" href="#section-1.2" name="section-1.2">1.2</a>.  Requirements Language</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <a href="rfc2119.html">RFC 2119</a> [<a href="rfc2119.html" title='"Key words for use in RFCs to Indicate Requirement Levels"'>RFC2119</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/2.%20%20Terminology"></a><a class="selflink" href="#section-2" name="section-2">2</a>.  Terminology</span>

   This document makes use of the following terms:

      Public Realm: This realm contains only public routable IPv4
      addresses.  Packets in this realm are forwarded based on the
      destination IPv4 address.

      A+P Realm: This realm contains both public routable IPv4 and A+P
      addresses.

      A+P Packet: A regular IPv4 packet is forwarded based on the
      destination IPv4 address and the TCP/UDP port numbers.




<span class="grey">Bush                          Experimental                      [Page 5]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-6" id="page-6" name="page-6"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


      Private Realm: This realm contains IPv4 addresses that are not
      globally routed.  They may be taken from the [<a href="rfc1918.html" title='"Address Allocation for Private Internets"'>RFC1918</a>] range.
      However, this document does not make such an assumption.  We
      regard as private address space any IPv4 address that needs to be
      translated in order to gain global connectivity, irrespective of
      whether or not it falls in [<a href="rfc1918.html" title='"Address Allocation for Private Internets"'>RFC1918</a>] space.

      Port-Range Router (PRR): A device that forwards A+P packets.

      Customer Premises Equipment (CPE): cable or DSL modem.

      Provider Edge (PE) Router: Customer aggregation router.

      Provider Border Router (BR): Provider's edge to other providers.

      Network Core Routers (Core): Provider routers that are not at the
      edges.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/3.%20%20Design%20Constraints%20and%20Functions"></a><a class="selflink" href="#section-3" name="section-3">3</a>.  Design Constraints and Functions</span>

   The problem of address space shortage is first felt by providers with
   a very large end-user customer base, such as broadband providers and
   mobile service providers.  Though the cases and requirements are
   slightly different, they share many commonalities.  In the following
   text, we develop a set of overall design constraints for solutions
   addressing the IPv4 address shortage problem.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.1.%20%20Design%20Constraints"></a><a class="selflink" href="#section-3.1" name="section-3.1">3.1</a>.  Design Constraints</span>

   We regard several constraints as important for our design:

   1)  End-to-end is under customer control: Customers shall have the
       ability to deploy new application protocols at will.  IPv4
       address shortage should not be a license to break the Internet's
       end-to-end paradigm.

   2)  Backward compatibility: Approaches should be transparent to
       unaware users.  Devices or existing applications should be able
       to work without modification.  Emergence of new applications
       should not be limited.

   3)  Highly scalable and minimal state core: Minimal state should be
       kept inside the ISP's network.  If the operator is rolling out
       A+P incrementally, it is understood there may be state in the
       core in the non-A+P part of such a roll-out.






<span class="grey">Bush                          Experimental                      [Page 6]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-7" id="page-7" name="page-7"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   4)  Efficiency versus complexity: Operators should have the
       flexibility to trade off port multiplexing efficiency and
       scalability and end-to-end transparency.

   5)  "Double-NAT" should be avoided: Multiple gateway devices might be
       present in a path, and once one has done some translation, those
       packets should not be retranslated.

   6)  Legal traceability: ISPs must be able to provide the identity of
       a customer from the knowledge of the IPv4 public address and the
       port.  This should have as low an impact as is reasonable on
       storage by the ISP.  We assume that NATs on customer premises do
       not pose much of a problem, while provider NATs need to keep
       additional logs.

   7)  IPv6 deployment should be encouraged.  NAT444 strongly biases the
       users to the deployment of <a href="rfc1918.html">RFC 1918</a> addressing.

   Constraint 5 is important: while many techniques have been deployed
   to allow applications to work through a NAT, traversing cascaded NATs
   is crucial if NATs are being deployed in the core of a provider
   network.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.2.%20%20A%2BP%20Functions"></a><a class="selflink" href="#section-3.2" name="section-3.2">3.2</a>.  A+P Functions</span>

   The A+P architecture can be split into three distinct functions:
   encaps/decaps, NAT, and signaling.

   Encaps/decaps function: is used to forward port-restricted A+P
   packets over intermediate legacy devices.  The encapsulation function
   takes an IPv4 packet, looks up the IP and TCP/UDP headers, and puts
   the packet into the appropriate tunnel.  The state needed to perform
   this action is comparable to a forwarding table.  The decapsulation
   device SHOULD check if the source address and port of packets coming
   out of the tunnel are legitimate (e.g., see [<a href="#ref-BCP38" title='"Network Ingress Filtering: Defeating Denial of Service Attacks which employ IP Source Address Spoofing"'>BCP38</a>]).  Based on the
   result of such a check, the packet MAY be forwarded untranslated, MAY
   be discarded, or MAY be NATed.  In this document, we refer to a
   device that provides this encaps/decaps functionality as a Port-Range
   Router (PRR).

   Network Address Translation (NAT) function: is used to connect legacy
   end-hosts.  Unless upgraded, end-hosts or end-systems are not aware
   of A+P restrictions and therefore assume a full IP address.  The NAT
   function performs any address or port translation, including
   Application Level Gateways (ALGs) whenever required.  The state that
   has to be kept to implement this function is the mapping for which
   external addresses and ports have been mapped to which internal
   addresses and ports, just as in CPEs embedding NAT today.  A subtle,



<span class="grey">Bush                          Experimental                      [Page 7]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-8" id="page-8" name="page-8"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   but very important, difference should be noted here: the customer has
   control over the NATing process or might choose to "bypass" the NAT.
   If this is done, we call the NAT a Large-Scale NAT (LSN).  However,
   if the NAT does NOT allow the customer to control the translation
   process, we call it a CGN.

   Signaling function: is used to allow A+P-aware devices to get to know
   which ports are assigned to be passed through untranslated and what
   will happen to packets outside the assigned port range (e.g., could
   be NATed or discarded).  Signaling may also be used to learn the
   encapsulation method and any endpoint information needed.  In
   addition, the signaling function may be used to dynamically assign
   the requested port range.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.3.%20%20Overview%20of%20the%20A%2BP%20Solution"></a><a class="selflink" href="#section-3.3" name="section-3.3">3.3</a>.  Overview of the A+P Solution</span>

   As mentioned above, the core architectural elements of the A+P
   solution are three separated and independent functions: the NAT
   function, the encaps/decaps function, and the signaling function.
   The NAT function is similar to a NAT as we know it today: it performs
   a translation between two different address realms.  When the
   external realm is public IPv4 address space, we assume that the
   translation is many-to-one, in order to multiplex many customers on a
   single public IPv4 address.  The only difference with a traditional
   NAT (Figure 1) is that the translator might only be able to use a
   restricted range of ports when mapping multiple internal addresses
   onto an external one, e.g., the external address realm might be port-
   restricted.

                   "internal-side"          "external-side"
                                   +-----+
                      internal     |  N  |     external
                      address  &lt;---|  A  |---&gt; address
                       realm       |  T  |      realm
                                   +-----+

                         Figure 1: Traditional NAT

   The encaps/decaps function, on the other hand, is the ability to
   establish a tunnel with another endpoint providing the same function.
   This implies some form of signaling to establish a tunnel.  Such
   signaling can be viewed as integrated with DHCP or as a separate
   service.  <a href="#section-3.3.1">Section 3.3.1</a> discusses the constraints of this signaling
   function.  The tunnel can be an IPv6 or IPv4 encapsulation, a layer-2
   tunnel, or some other form of softwire.  Note that the presence of a
   tunnel allows unmodified, naive, or even legacy devices between the
   two endpoints.




<span class="grey">Bush                          Experimental                      [Page 8]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-9" id="page-9" name="page-9"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   Two or more devices that provide the encaps/decaps function are
   linked by tunnels to form an A+P subsystem.  The function of each
   gateway is to encapsulate and decapsulate, respectively.  Figure 2

   depicts the simplest possible A+P subsystem, that is, two devices
   providing the encaps/decaps function.

                      +------------------------------------+
           Private    | +----------+  tunnel  +----------+ |   Public
           address  --|-| gateway  |==========| gateway  |-|-- address
           realm      | +----------+          +----------+ |    realm
                      +------------------------------------+
                                   A+P subsystem

                     Figure 2: A Simple A+P Subsystem

   Within an A+P subsystem, the public address realm is extended by
   using bits from the port number when forwarding packets.  Each device
   is assigned one address from the external realm and a range of port
   numbers.  Hence, devices that are part of an A+P subsystem can
   communicate with the public realm without the need for address
   translation (i.e., preserving end-to-end packet integrity): an A+P
   packet originated from within the A+P subsystem can be simply
   forwarded over tunnels up to the endpoint, where it gets decapsulated
   and routed in the external realm.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.3.1.%20%20Signaling"></a><a class="selflink" href="#section-3.3.1" name="section-3.3.1">3.3.1</a>.  Signaling</span>

   The following information needs to be available on all the gateways
   in the A+P subsystem.  It is expected that there will be a signaling
   protocols such as [<a href="#ref-PR-ADDR-ASSIGN">PR-ADDR-ASSIGN</a>], [<a href="#ref-SHARED-ADDR-OPT">SHARED-ADDR-OPT</a>],
   [<a href="#ref-PORT-RANGE-OPT">PORT-RANGE-OPT</a>], or [<a href="#ref-PCP-BASE">PCP-BASE</a>].

   The information that needs to be shared is the following:

   o  a set of public IPv4 addresses,

   o  for each IPv4 address, a starting point for the allocated port
      range,

   o  the number of delegated ports,

   o  the optional key that enables partial or full preservation of
      entropy in port randomization -- see [<a href="#ref-PR-ADDR-ASSIGN">PR-ADDR-ASSIGN</a>],

   o  the lifetime for each IPv4 address and set of allocated ports,

   o  the tunneling technology to be used (e.g., "IPv6-encapsulation"),



<span class="grey">Bush                          Experimental                      [Page 9]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-10" id="page-10" name="page-10"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   o  addresses of the tunnel endpoints (e.g., IPv6 address of tunnel
      endpoints),

   o  whether or not NAT function is provided by the gateway,

   o  a device identification number and some authentication mechanisms,
      and

   o  a version number and some reserved bits for future use.

   Note that the functions of encapsulation and decapsulation have been
   separated from the NAT function.  However, to accommodate legacy
   hosts, NATing is likely to be provided at some point in the path;
   therefore, the availability or absence of NATing MUST be communicated
   in signaling, as A+P is agnostic about NAT placement.

   The port ranges can be allocated in two different ways:

   o  If applications or end-hosts behind the CPE are not UPnPv2/
      NAT-PMP-aware, then the CPE SHOULD request ports via mechanisms,
      e.g., as described in [<a href="#ref-PR-ADDR-ASSIGN">PR-ADDR-ASSIGN</a>] and [<a href="#ref-PORT-RANGE-OPT">PORT-RANGE-OPT</a>].  Note
      that different port ranges can have different lifetimes, and the
      CPE is not entitled to use them after they expire -- unless it
      refreshes those ranges.  It is up to the ISP to put mechanisms in
      place (to prevent denial-of-service attacks) that determine what
      percentage of already allocated port ranges should be exhausted
      before a CPE may request additional ranges, how often the CPE can
      request additional ranges, and so on.

   o  If applications behind the CPE are UPnPv2/NAT-PMP-aware,
      additional ports MAY be requested through that mechanism.  In this
      case, the CPE should forward those requests to the LSN, and the
      LSN should reply reporting if the requested ports are available or
      not (and if they are not available, some alternatives should be
      offered).  Here again, to prevent potential denial-of-service
      attacks, mechanisms should be in place to prevent UPnPv2/NAT-PMP
      packet storms and fast port allocation.  A detailed description of
      this mechanism, called PCP, is in [<a href="#ref-PCP-BASE">PCP-BASE</a>].

   Whatever signaling mechanism is used inside the tunnels -- DHCP, IP
   Control Protocol (IPCP), or PCP based, synchronization between the
   signaling server and PRR must be established in both directions.  For
   example, if we use DHCP as the signaling mechanism, the PRR must
   communicate to the DHCP server at least its IP range.  The DHCP
   server then starts to allocate IP addresses and port ranges to CPEs
   and communicates back to the PRR which IP and port range have been
   allocated to which CPE, so the PRR knows to which tunnel to redirect
   incoming traffic.  In addition, DHCP MUST also communicate lifetimes



<span class="grey">Bush                          Experimental                     [Page 10]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-11" id="page-11" name="page-11"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   of port ranges assigned to CPE via the PRR.  DHCP server may be co-
   located with the PRR function to ease address management and also to
   avoid the need to introduce a communication protocol between the PRR
   and DHCP.

   If UPnPv2/NAT-PMP is used as the dynamic port allocation mechanism,
   the PRR must also communicate to the DHCP (or IPCP) server to avoid
   those ports.  The PRR must somehow (e.g., using DHCP or IPCP options)
   communicate back to CPE that the allocation of ports was successful,
   so CPE adds those ports to existing port ranges.

   Note that operation can be even simplified if a fixed length of port
   ranges is assigned to all customers and no differentiation is
   implemented based on port-range length.  In such case, the binding
   table maintained by the PRR can be dynamically built upon the receipt
   of a first packet from a port-restricted device.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.3.2.%20%20Address%20Realm"></a><a class="selflink" href="#section-3.3.2" name="section-3.3.2">3.3.2</a>.  Address Realm</span>

   Each gateway within the A+P subsystem manages a certain portion of
   A+P address space; that is, a portion of IPv4 space that is extended
   by borrowing bits from the port number.  This address space may be a
   single, port-restricted IPv4 address.  The gateway MAY use its
   managed A+P address space for several purposes:

   o  Allocation of a sub-portion of the A+P address space to other
      authenticated A+P gateways in the A+P subsystem (referred to as
      delegation).  We call the allocated sub-portion delegated address
      space.

   o  Exchange of (untranslated) packets with the external address
      realm.  For this to work, such packets MUST use a source address
      and port belonging to the non-delegated address space.

   If the gateway is also capable of performing the NAT function, it MAY
   translate packets arriving on an internal interface that are outside
   of its managed A+P address space into non-delegated address space.

   Hence, a provider may have 'islands' of A+P as they slowly deploy
   over time.  The provider does not have to replace CPE until they want
   to provide the A+P function to an island of users or even to one
   particular user in a sea of non-A+P users.

   An A+P gateway ("A"), accepts incoming connections from other A+P
   gateways ("B").  Upon connection establishment (provided appropriate
   authentication), B would "ask" A for delegation of an A+P address.
   In turn, A will inform B about its public IPv4 address and will




<span class="grey">Bush                          Experimental                     [Page 11]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-12" id="page-12" name="page-12"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   delegate a portion of its port range to B.  In addition, A will also
   negotiate the encaps/decaps function with B (e.g., let B know the
   address of the decaps device at the endpoint of the tunnel).

   This could be implemented, for example, via a NAT-PMP- or DHCP-like
   solution.  In general, the following rule applies: a sub-portion of
   the managed A+P address space is delegated as long as devices below
   ask for it; otherwise, private IPv4 is provided to support legacy
   hosts.

   The following examples use an IPv4 address from the blocks reserved
   for documentation as defined in [<a href="rfc5737.html" title='"IPv4 Address Blocks Reserved for Documentation"'>RFC5737</a>].

              private    +-----+          +-----+     public
              address ---|  B  |==========|  A  |---  Internet
               realm     +-----+          +-----+

                         Address space realm of A:
                         public IPv4 address = 192.0.2.1
                         port range = 0-65535

                         Address space realm of B:
                         public IPv4 address = 192.0.2.1
                         port range = 2560-3071

                      Figure 3: Configuration Example

   Figure 3 illustrates a sample configuration.  Note that A might
   actually consist of three different devices: one that handles
   signaling requests from B; one that performs encapsulation and
   decapsulation; and, if provided, one device that performs the NATing
   function (e.g., an LSN).  Packet forwarding is assumed to be as
   follows: in the "outbound" case, a packet arrives from the private
   address realm to B.  As stated above, B has two options: it can
   either apply or not apply the NAT function.  The decision depends
   upon the specific configuration and/or the capabilities of A and B.
    Note that NAT functionality is required to support legacy hosts;
   however, this can be done at either of the two devices A or B.  The
   term "NAT" refers to translating the packet into the managed A+P
   address (B has address 192.0.2.1 and ports 2560-3071 in the example
   above).  We then have two options:

   1)  B NATs the packet.  The translated packet is then tunneled to A.
       A recognizes that the packet has already been translated because
       the source address and port match the delegated space.  A
       decapsulates the packet and releases it in the public Internet.





<span class="grey">Bush                          Experimental                     [Page 12]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-13" id="page-13" name="page-13"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   2)  B does not NAT the packet.  The untranslated packet is then
       tunneled to A.  A recognizes that the packet has not been
       translated, so A forwards the packet to a co-located NATing
       device, which translates the packet and routes it in the public
       Internet.  This device, e.g., an LSN, has to store the mapping
       between the source port used to NAT and the tunnel where the
       packet came from, in order to correctly route the reply.  Note
       that A cannot use a port number from the range that has been
       delegated to B.  As a consequence, A has to assign a part of its
       non-delegated address space to the NATing function.

   "Inbound" packets are handled in the following way: a packet from the
   public realm arrives at A.  A analyzes the destination port number to
   understand whether or not the packet needs to be NATed.

   1)  If the destination port number belongs to the range that A
       delegated to B, then A tunnels the packet to B.  B NATs the
       packet using its stored mapping and forwards the translated
       packet to the private domain.

   2)  If the destination port number is from the address space of the
       LSN, then A passes the packet on to the co-located LSN, which
       uses its stored mapping to NAT the packet into the private
       address realm of B.  The appropriate tunnel is stored as well in
       the mapping of the initial NAT.  The LSN then encapsulates the
       packet to B, which decapsulates it and normally routes it within
       its private realm.

   3)  Finally, if the destination port number falls in neither a
       delegated range nor the address range of the LSN, A discards the
       packet.  If the packet is passed to the LSN, but no mapping can
       be found, the LSN discards the packet.

   Observe that A must be able to receive all IPv4 packets destined to
   the public IPv4 address (192.0.2.1 in the example), so that it can
   make routing decisions according to the port number.  On the other
   hand, B receives IPv4 packets destined to the public IPv4 address
   only via the established tunnel with A.  In other words, B uses the
   public IPv4 address just for translation purposes, but it is not used
   to make routing decisions.  This allows us to keep the routing logic
   at B as simple as described above, while enabling seamless
   communication between A+P devices sharing the same public IPv4
   address.








<span class="grey">Bush                          Experimental                     [Page 13]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-14" id="page-14" name="page-14"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


              private    +-----+          +-----+     public
              address ---|  B  |==========|  A  |---  Internet
              realm 1    +-----+          +-----+
                                            |
              private    +-----+            |
              address ---|  C  |============/
              realm 2    +-----+

                         Address space realm of A:
                         public IPv4 address = 192.0.2.1
                         port range = 0-65535

                         Address space realm of B:
                         public IPv4 address = 192.0.2.1
                         port range = 2560-3071

                         Address space realm of C:
                         public IPv4 address = 192.0.2.1
                         port range = 0-2559

                        Figure 4: Hierarchical A+P

   Consider the example shown in Figure 4.  Here, both B and C use the
   encaps/decaps function to establish a tunnel with A, and they are
   assigned the same public IPv4 address with different, non-overlapping
   port ranges.  Assume that a host in B's private realm sends a packet
   destined to address 192.0.2.1 and port 2000, and that B has been
   instructed to NAT all packets destined to 192.0.2.1.  Under these
   assumptions, B receives the packet and NATs it using its own public
   IPv4 address (192.0.2.1) and a port selected from its configured port
   range (e.g., 3000).  B then tunnels the translated packet to A.  When
   A receives the packet via the tunnel, it looks at the destination
   address and port, recognizes C's delegated range, and then tunnels
   the packet to C.  Observe that, apart from stripping the tunnel
   header, A handles the packet as if it came from the public Internet.
   When C receives the packet, it NATs the destination address into one
   address chosen from its private address realm, while keeping the
   source address (192.0.2.1) and port (3000) untranslated.  Return
   traffic is handled the same way.  Such a mechanism allows hosts
   behind A+P devices to communicate seamlessly even when they share the
   same public IPv4 address.

   Please refer to <a href="#section-4">Section 4</a> for a discussion of an alternative A+P
   mechanism that does not incur path-stretch penalties for intra-domain
   communication.






<span class="grey">Bush                          Experimental                     [Page 14]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-15" id="page-15" name="page-15"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.3.3.%20%20Reasons%20for%20Allowing%20Multiple%20A%2BP%20Gateways"></a><a class="selflink" href="#section-3.3.3" name="section-3.3.3">3.3.3</a>.  Reasons for Allowing Multiple A+P Gateways</span>

   Since each device in an A+P subsystem provides the encaps/decaps
   function, new devices can establish tunnels and become in turn part
   of an A+P subsystem.  As noted above, being part of an A+P subsystem
   implies the capability of talking to the external address realm
   without any translation.  In particular, as described in the previous
   section, a device X in an A+P subsystem can be reached from the
   external domain by simply using the public IPv4 address and a port
   that has been delegated to X.  Figure 5 shows an example where three
   devices are connected in a chain.  In other words, A+P signaling can
   be used to extend end-to-end connectivity to the devices that are in
   an A+P subsystem.  This allows A+P-aware applications (or OSes)
   running on end-hosts to enter an A+P subsystem and exploit
   untranslated connectivity.

   There are two modes for end-hosts to gain fine-grained control of
   end-to-end connectivity.  The first is where actual end-hosts perform
   the NAT function and the encaps/decaps function that is required to
   join the A+P subsystem.  This option works in a similar way to the
   NAT-in-the-host trick employed by virtualization software such as
   VMware, where the guest operating system is connected via a NAT to
   the host operating system.  The second mode is when applications
   autonomously ask for an A+P address and use it to join the A+P
   subsystem.  This capability is necessary for some applications that
   require end-to-end connectivity (e.g., applications that need to be
   contacted from outside).

               +---------+      +---------+      +---------+
     internal  | gateway |      | gateway |      | gateway |  external
     realm   --|    1    |======|    2    |======|    3    |-- realm
               +---------+      +---------+      +---------+

             Figure 5: An A+P Subsystem with Multiple Devices

   Whatever the reasons might be, the Internet was built on a paradigm
   that end-to-end connectivity is important.  A+P makes this still
   possible in a time where address shortage forces ISPs to use NATs at
   various levels.  In that sense, A+P can be regarded as a way to
   bypass NATs.











<span class="grey">Bush                          Experimental                     [Page 15]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-16" id="page-16" name="page-16"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


              +---+          (customer2)
              |A+P|-.         +---+
              +---+  \     NAT|A+P|-.
                      \       +---+ |
                       \            |       forward if in range
              +---+     \+---+    +---+    /
              |A+P|------|A+P|----|A+P|----
              +---+     /+---+    +---+    \
                       /                    NAT if necessary
                      / (cust1)   (prov.    (e.g., provider NAT)
              +---+  /            router)
              |A+P|-'
              +---+

                     Figure 6: A Complex A+P Subsystem

   Figure 6 depicts a complex scenario, where the A+P subsystem is
   composed of multiple devices organized in a hierarchy.  Each A+P
   gateway decapsulates the packet and then re-encapsulates it again to
   the next tunnel.

   A packet can be NATed either when it enters the A+P subsystem, at
   intermediate devices, or when it exits the A+P subsystem.  This could
   be, for example, a gateway installed within the provider's network,
   together with an LSN.  Then, each customer operates its own CPE.
   However, behind the CPE, applications might also be A+P-aware and run
   their own A+P-gateways; this enables them to have end-to-end
   connectivity.

   One limitation applies when "delayed translation" is used (e.g.,
   translation at the LSN instead of the CPE).  If devices using
   "delayed translation" want to talk to each other, they SHOULD use A+P
   addresses or out-of-band addressing.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.3.4.%20%20Overall%20A%2BP%20Architecture"></a><a class="selflink" href="#section-3.3.4" name="section-3.3.4">3.3.4</a>.  Overall A+P Architecture</span>

                           A+P architecture

         IPv4         Full-A+P          AFTR             CGN
          |              |               |                |
   &lt;-- Full IPv4 ---- Port range ---- Port range  ---- Provider ---&gt;
       allocated      &amp; dynamic         &amp; LSN          NAT ONLY
                      allocation      (NAT on CPE      (No mechanism)
       (no NAT)      (NAT on CPE)     and on LSN)      for customer to
                                                       bypass CGN)

                    Figure 7: A+P Overall Architecture




<span class="grey">Bush                          Experimental                     [Page 16]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-17" id="page-17" name="page-17"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   The A+P architecture defines various deployment options within an
   ISP.  Figure 7 shows the spectrum of deployment options.  On the far
   left is the common deployment method for broadband subscribers today,
   an IPv4 address unrestricted with full port range.  Full-A+P refers
   to a port-range allocation from the ISP.  The customer must operate
   an A+P-aware CPE device, and no NATing functionality is provided by
   the ISP.  The Address Family Transition Router (AFTR), such as
   DS-Lite [<a href="rfc6333.html" title='"Dual- Stack Lite Broadband Deployments Following IPv4 Exhaustion"'>RFC6333</a>], is a hybrid.  There is NAT present in the core (in
   this document, referred to as LSN), but the user has the option to
   "bypass" that NAT in one form or an other, for example, via A+P,
   NAT-PMP, etc.  Finally, a service provider that only deploys CGN will
   place a NAT in the provider's core and does not allow the customer to
   "bypass" the translation process or modify ALGs on the NAT.  The
   customer is provider-locked.  Notice that all options (besides full
   IPv4) require some form of tunneling mechanism (e.g., 4in6) and a
   signaling mechanism (see <a href="#section-3.3.1">Section 3.3.1</a>).

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.4.%20%20A%2BP%20Experiments"></a><a class="selflink" href="#section-3.4" name="section-3.4">3.4</a>.  A+P Experiments</span>

   There are implementations of A+P as well as documented experiments.
   France Telecom did experiments that are described in
   [A+P-EXPERIMENTS].  As seen in that experiment, most tested
   applications are unaffected.  There are problems with torrent
   protocol and applications, as the listening port is out of A+P port
   range and some UPnP may be required to make it work with A+P.

   Problems with BitTorrent have already been experienced in the wild by
   users trapped behind a non-UPnP-capable CPE.  The current workaround
   for the end-user is to statically map ports, which can be done in the
   A+P scenario as well.

   BitTorrent tests and experiments in shared IP and port-range
   environments are well described in [<a href="#ref-BITTORRENT-ADDR-SHARING">BITTORRENT-ADDR-SHARING</a>].
   Conclusions in that document tell us that two limitations were
   experienced.  The first occurred when two clients sharing the same IP
   address tried to simultaneously retrieve the SAME file located in a
   SINGLE remote peer.  The second limitation occurred when a client
   tried to download a file located on several seeders, when those
   seeders shared the same IP address.  Mutual file sharing between
   hosts having the same IP address has been checked.  Indeed, machines
   having the same IP address can share files with no alteration
   compared to current IP architectures.

   Working implementations of A+P can be found in:

   o  Internet Systems Consortium AFTR
      (<a href="http://www.isc.org/software/aftr">http://www.isc.org/software/aftr</a>),




<span class="grey">Bush                          Experimental                     [Page 17]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-18" id="page-18" name="page-18"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   o  FT Orange opensource A+P (<a href="http://opensourceaplusp.weebly.com/">http://opensourceaplusp.weebly.com/</a>)
      developed by Xiaoyu Zhao, Xiaohong Deng, Tao Zheng, and

   o  4rd (IPv4 Residual Deployment) from ipinfusion.com, which is
      stateless A+P.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/4.%20%20Stateless%20A%2BP%20Mapping%20Function"></a><a class="selflink" href="#section-4" name="section-4">4</a>.  Stateless A+P Mapping Function</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.1.%20%20Stateless%20A%2BP%20Mapping%20%28SMAP%29%20Gateway%20Function%20Description"></a><a class="selflink" href="#section-4.1" name="section-4.1">4.1</a>.  Stateless A+P Mapping (SMAP) Gateway Function Description</span>

   SMAP stands for Stateless A+P Mapping.  This function is responsible
   for, in a stateless scheme, encapsulating IPv4 packets in IPv6 ones
   as well as decapsulating IPv4 packets from IPv6 ones.  An SMAP
   function may be hosted in a PRR, end-user device, etc.

   As mentioned in <a href="rfc6052.html#section-4.1">Section 4.1 of [RFC6052]</a>, the suffix part may enclose
   the port.

   The Stateless A+P Mapping (SMAP) gateway consists in two basic
   functions as described in Figure 8.

   1.  SMAP encapsulates an IPv4 packet, destined to a shared IPv4
       address, in an IPv6 one.  The IPv6 source address is constructed
       using an IPv4-embedded IPv6 address [<a href="rfc6052.html" title='"IPv6 Addressing of IPv4/IPv6 Translators"'>RFC6052</a>] from the IPv4
       source address and port number plus the IPv6 prefix that has been
       provisioned to the node performing the SMAP function.  The
       destination IPv6 address is constructed using the shared IPv4
       destination address and port number plus the IPv6 prefix that has
       been provisioned to the SMAP function and that is dedicated to
       IPv4 destination addresses.

   2.  SMAP extracts IPv4 incoming packets from IPv6 incoming ones that
       have IPv6 source addresses belonging to the prefix of the node
       performing the SMAP function.  Extracted IPv4 packets are then
       forwarded to the point identified by the IPv4 destination address
       and port number.















<span class="grey">Bush                          Experimental                     [Page 18]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-19" id="page-19" name="page-19"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


                           +-------------------+
                           |                   |----IPv6---\
               ----IPv4---\|                   |----IPv4---\\
               -----------/|                   |-----------//
                           |                   |-----------/
                           |       SMAP        |
                           |                   | /--IPv6-----
               /---IPv4----|                   |//---IPv4----
               \-----------|                   |\\-----------
                           |                   | \-----------
                           +-------------------+

             Figure 8: Stateless A+P Mapping Gateway Function

   An SMAP-enabled node will perform the stateless 6/4 mapping function
   for all public shared IPv4 addresses for which it was designated as a
   stateless 6/4 mapping gateway.

   To perform the stateless 6/4 mapping function, an SMAP gateway must:

   o  be provided with an IPv6 prefix (i.e., Pref6).  The SMAP gateway
      uses this prefix to construct IPv6 source addresses for all IPv4
      shared addresses for which it was designated as an SMAP gateway.
      The IPv6 prefix may be provisioned statically or dynamically
      (e.g., DHCP).

   o  be able to know the IPv6 prefix of the node serving as another
      SMAP gateway for IPv4 destination addresses.  This prefix may be
      known in various ways:

      *  Default or Well-Known Prefix (i.e., 64:ff9b::/96) that was
         provisioned statically or dynamically;

      *  Retained at the reception of incoming IPv4-in-IPv6 encapsulated
         packets;

      *  Discovered at the start of communication, thanks to mechanisms
         such as DNS resolution, for example.

   When the SMAP-enabled node receives IPv4 packets with IPv4 source
   addresses for which it was not designated as an smap gateway, it will
   not perform stateless 6/4 mapping function for those packets.  Those
   packets will be handled in a classical way (i.e., forwarded, dropped,
   or locally processed).







<span class="grey">Bush                          Experimental                     [Page 19]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-20" id="page-20" name="page-20"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   When the SMAP-enabled node receives IPv6 packets with IPv6 addresses
   that do not match with its IPv6 prefix, it will not perform the
   stateless 6/4 mapping function for those packets.  Those packets will
   be handled in a classical way (i.e., forwarded, dropped, or locally
   processed).

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.2.%20%20Implementation%20Mode"></a><a class="selflink" href="#section-4.2" name="section-4.2">4.2</a>.  Implementation Mode</span>

   In this configuration, the node A performs the stateless mapping
   function on the received IPv4 traffic (encapsulated in IPv6 packets)
   before forwarding to the node B.  The node B performs the stateless
   mapping function on the received IPv6 traffic (extracting IPv4
   packets) before forwarding the IPv4 traffic to the destination
   identified by the IPv4 destination address and port number.  In the
   opposite direction, and as previously, the node B performs the
   stateless mapping function on the received IPv4 traffic
   (encapsulating in IPv6 packets) before forwarding to the node A.  The
   node A performs the stateless mapping function on the received IPv6
   traffic (extracting IPv4 packets) before forwarding the IPv4 traffic
   to the point identified by the IPv4 destination address and port
   number.  In this case, only IPv6 traffic is managed in the network
   segment between the nodes A and B.

                       +------+             +------+
                       |      |----IPv6---\ |      |
           ----IPv4---\|      |----IPv4---\\|      |----IPv4---\
           -----------/|      |-----------//|      |-----------/
                       |      |-----------/ |      |
                       | SMAP |             | SMAP |
                       |      | /----IPv6---|      |
           /---IPv4----|      |//---IPv4----|      |/---IPv4----
           \-----------|      |\\-----------|      |\-----------
                       |      | \-----------|      |
                       +------+             +------+
                        node A               node B

                                 Figure 9

   Several deployment scenarios of the SMAP function may be envisaged in
   the context of port-range-based solutions:

   o  An SMAP function is embedded in a port-restricted device.  Other
      SMAP-enabled nodes are deployed in the boundaries between IPv6-
      enabled realms and IPv4 ones.  This scenario may be deployed
      particularly for intra-domain communications so as to interconnect
      heterogeneous realms (i.e., IPv6/IPv4) within the same Autonomous
      System (AS).




<span class="grey">Bush                          Experimental                     [Page 20]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-21" id="page-21" name="page-21"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   o  An SMAP function is embedded in a port-restricted device.  Other
      SMAP-enabled nodes are deployed in the interconnection segment
      (with adjacent IPv4-only ones) of a given AS.  This deployment
      scenario is more suitable for service providers targeting the
      deployment of IPv6 since it eases the migration to full IPv6.
      Core nodes are not required to continue to activate both IPv4 and
      IPv6 transfer capabilities.

   Other considerations regarding the interconnection of SMAP-enabled
   domains should be elaborated.  The following provides a non-
   exhaustive list of interconnection schemes.

   o  The interconnection of two domains implementing the SMAP function
      may be deployed via IPv4 Internet (Figure 10): this means that
      IPv4 packets encapsulated in IPv6 packets are transferred using
      IPv6 until reaching the first SMAP-enabled node.  Then, these
      packets are decapsulated and are forwarded using IPv4 transfer
      capabilities.  A remote SMAP-enabled node will receive those
      packets and proceed to an IPv4-in-IPv6 encapsulation.  These
      packets are then routed normally until reaching the port-
      restricted devices that decapsulate the packets.

   +------+          +------+   +--------+   +------+           +------+
   |      |--IPv6--\ |      |   |        |   |      |---IPv6--\ |      |
   |      |--IPv4--\\|      |---|-IPv4---|--\|      |---IPv4--\\|      |
   |      |--------//|      |---|--------|--/|      |---------//|      |
   |      |--------/ |      |   |Internet|   |      |---------/ |      |
   | SMAP |          | SMAP |   |  IPv4  |   | SMAP |           | SMAP |
   |      | /--IPv6--|      |   |        |   |      | /---IPv6--|      |
   |      |//--IPv4--|      |/--|-IPv4---|---|      |//--IPv4---|      |
   |      |\\--------|      |\--|--------|---|      |\\---------|      |
   |      | \--------|      |   |        |   |      | \---------|      |
   +------+          +------+   +--------+   +------+           +------+
    Source           node A                  node B          Destination

                    Figure 10: Interconnection Scenario 1

   o  A second scheme is to use IPv6 to interconnect two realms that
      implement the SMAP function (Figure 11).  An IPv6 prefix (i.e.,
      Pref6) assigned by IANA is used for this service.  If appropriate
      routing configurations have been enforced, then the IPv6-
      encapsulated packets will be routed until the final destination.
      In order to implement this model, IPv4-inferred IPv6 prefixes are
      required to be injected in the IPv6 inter-domain routing tables.







<span class="grey">Bush                          Experimental                     [Page 21]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-22" id="page-22" name="page-22"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


        +------+             +------------+              +------+
        |      |             |            |              |      |
        |      |----IPv6-----|----IPv6----|----IPv6----\ |      |
        |      |----IPv4-----|------------|----IPv4----\\|      |
        |      |-------------|------------|------------//|      |
        |      |-------------|------------|------------/ |      |
        | SMAP |             | Internet v6|              | SMAP |
        |      | /-----IPv6--|------------|-----IPv6-----|      |
        |      |//---IPv4----|------------|-------IPv4---|      |
        |      |\\-----------|------------|--------------|      |
        |      | \-----------|------------|--------------|      |
        |      |             |            |              |      |
        +------+             +------------+              +------+
         Source                                            Destination

                   Figure 11: Interconnection Scenario 2

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.3.%20%20Towards%20IPv6-Only%20Networks"></a><a class="selflink" href="#section-4.3" name="section-4.3">4.3</a>.  Towards IPv6-Only Networks</span>

   The deployment of the SMAP function allows for smooth migration of
   networks to an IPv6-only scheme while maintaining the delivery of
   IPv4 connectivity services to customers.  The delivery of IPv4
   connectivity services over an IPv6-only network does not require any
   stateful function to be deployed on the core network.  Owing to this
   A+P mode, both the IPv4 service continuity and the migration to an
   IPv6-only deployment model are facilitated.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.4.%20%20PRR%3A%20On%20Stateless%20and%20Binding%20Table%20Modes"></a><a class="selflink" href="#section-4.4" name="section-4.4">4.4</a>.  PRR: On Stateless and Binding Table Modes</span>

   The SMAP section (<a href="#section-4">Section 4</a>) discusses two modes: the binding and the
   stateless modes.  Dynamic port allocation is not a feature of the
   stateless mode, but it is supported in the binding mode.  In the
   binding mode, distinct external IPv4 addresses may be used, but this
   is not recommended.

   o  Stateless Mode

      Complete stateless mapping implies that the IPv4 address and the
      significant bits coding the port range are reflected inside the
      IPv6 prefix assigned to the port-restricted device.  This can be
      achieved either by embedding the full IPv4 address and the
      significant bits in the IPv6 prefix or by applying an algorithmic
      approach.  Two alternatives are offered when such a stateless
      mapping is to be enabled:

      -  use the IPv6 prefix already used for native IPv6 traffic, or





<span class="grey">Bush                          Experimental                     [Page 22]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-23" id="page-23" name="page-23"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


      -  provide two prefixes to the port-restricted device: one for the
         native IPv6 traffic and one for the IPv4 traffic.

      Note that:

      -  Providing two IPv6 prefixes has the advantages of allowing a
         /64 prefix for the port-restricted device along with another
         prefix (e.g., a /56 or /64) for native IPv6 traffic.  This
         alternative allows the service provider to relate the native
         IPv6 traffic addressing plan to the IPv4 addressing plan.  The
         drawback is having to allocate two prefixes to each port-
         restricted device and to route them.  In addition, an address
         selection issue may be encountered.

      -  Providing one prefix for both needs (e.g., a /56 or a /64)
         allows the service provider to handle two types of IPv6 prefix
         for the port-restricted device and in routing tables.  But the
         drawback is that it strongly links the IPv4 addressing plan to
         the allocated IPv6 prefixes.

      As mentioned in <a href="rfc6052.html#section-4.1">Section 4.1 of [RFC6052]</a>, the suffix part may
      enclose the port.

   o  Binding Table Mode

      Another alternative is to assign a "normal" IPv6 prefix to the
      port-restricted device and to use a binding table, which can be
      hosted by a service node to correlate the (shared IPv4 address,
      port range) with an IPv6 address part of the assigned IPv6 prefix.
      For scalability reasons, this table should be instantiated within
      PRR-enabled nodes that are close to the port-restricted devices.
      The number of required entries if hosted at the interconnection
      segment would be equal to the amount of subscribed users (one per
      port-restricted device).

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.5.%20%20General%20Recommendations%20on%20SMAP"></a><a class="selflink" href="#section-4.5" name="section-4.5">4.5</a>.  General Recommendations on SMAP</span>

   If a Stateless A+P Mapping (SMAP) type of implementation is deployed
   over intermediate IPv6-only-capable devices, it is recommended that
   default routes are configured, and the IPv4 routing table is not
   "leaked" into the IPv6 routing table in terms of having reachability
   for the packets going towards the Internet.

   One of the stateless A+P variants is 4rd [<a href="#ref-4rd" title="&quot;IPv4 Residual Deployment across IPv6-Service networks (4rd) ISP-NAT's made optional&quot;">4rd</a>].







<span class="grey">Bush                          Experimental                     [Page 23]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-24" id="page-24" name="page-24"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/5.%20%20Deployment%20Scenarios"></a><a class="selflink" href="#section-5" name="section-5">5</a>.  Deployment Scenarios</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/5.1.%20%20A%2BP%20Deployment%20Models"></a><a class="selflink" href="#section-5.1" name="section-5.1">5.1</a>.  A+P Deployment Models</span>

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.1.1.%20%20A%2BP%20for%20Broadband%20Providers"></a><a class="selflink" href="#section-5.1.1" name="section-5.1.1">5.1.1</a>.  A+P for Broadband Providers</span>

   Some large broadband providers will not have enough public IPv4
   address space to provide every customer with a single IP address.
   The natural solution is sharing a single IP address among many
   customers.  Multiplexing customers is usually accomplished by
   allocating different port numbers to different customers somewhere
   within the network of the provider.

   It is expected that, when the provider wishes to enable A+P for a
   customer or a range of customers, the CPE can be upgraded or replaced
   to support A+P encaps/decaps functionality.  Ideally, the CPE also
   provides NATing functionality.  Further, it is expected that at least
   another component in the ISP network provides the corresponding A+P
   functionality, and hence is able to establish an A+P subsystem with
   the CPE.  This device is referred to as an A+P router or Port-Range
   Router (PRR), and could be located close to PE routers.  The core of
   the network MUST support the tunneling protocol (which SHOULD be
   IPv6, as per Constraint 7) but MAY be another tunneling technology
   when necessary.  In addition, we do not wish to restrict any
   initiative of customers who might want to run an A+P-capable network
   on or behind their CPE.  To satisfy both Constraints 1 and 2,
   unmodified legacy hosts should keep working seamlessly, while
   upgraded/new end-systems should be given the opportunity to exploit
   enhanced features.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.1.2.%20%20A%2BP%20for%20Mobile%20Providers"></a><a class="selflink" href="#section-5.1.2" name="section-5.1.2">5.1.2</a>.  A+P for Mobile Providers</span>

   In the case of mobile service providers, the situation is slightly
   different.  The A+P border is assumed to be the gateway (e.g.,
   Gateway GPRS Support Node (GGSN) / Packet Data Network (PDN) gateway
   (GW) of 3GPP, or Access Service Network (ASN) GW of Worldwide
   Interoperability for Microwave Access (WiMAX)).  The need to extend
   the address is not within the provider network, but on the edge
   between the mobile phone devices and the gateway.  While desirable,
   IPv6 connectivity may or may not be provided.

   For mobile providers, we use the following terms and assumptions:

   1.  provider network (PN)

   2.  gateway (GW)

   3.  mobile phone device (phone)



<span class="grey">Bush                          Experimental                     [Page 24]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-25" id="page-25" name="page-25"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   4.  devices behind the phone, e.g., laptop computer connecting via
       phone to Internet

   We expect that the gateway has a pool of IPv4 addresses and is always
   in the data-path of the packets.  Transport between the gateway and
   phone devices is assumed to be an end-to-end layer-2 tunnel.  We
   assume that the phone as well as gateway can be upgraded to support
   A+P.  However, some applications running on the phone or devices
   behind the phone (such as laptop computers connecting via the phone)
   are not expected to be upgraded.  Again, while we do not expect that
   devices behind the phone will be A+P-aware or upgraded, we also do
   not want to hinder their evolution.  In this sense, the mobile phone
   would be comparable to the CPE in the broadband provider case; it
   would be the gateway to the PRR/LSN box in the network of the
   broadband provider.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.1.3.%20%20A%2BP%20from%20the%20Provider%20Network%20Perspective"></a><a class="selflink" href="#section-5.1.3" name="section-5.1.3">5.1.3</a>.  A+P from the Provider Network Perspective</span>

   ISPs suffering from IPv4 address space exhaustion are interested in
   achieving a high address space compression ratio.  In this respect,
   an A+P subsystem allows much more flexibility than traditional NATs:
   the NAT can be placed at the customer and/or in the provider network.
   In addition, hosts or applications can request ports and thus have
   untranslated end-to-end connectivity.

                   +---------------------------+
       private     | +------+  A+P-in  +-----+ |   dual-stacked
      (<a href="rfc1918.html">RFC 1918</a>) --|-| CPE  |==-IPv6-==| PRR |-|-- network
        space      | +------+  tunnel  +-----+ |   (public addresses)
                   |    ^              +-----+ |
                   |    |  IPv6-only   | LSN | |
                   |    |   network    +-----+ |
                   +----+----------------- ^ --+
                        |                  |
                   on customer        within provider
              premises and control      network

                 Figure 12: A Simple A+P Subsystem Example

   Consider the deployment scenario in Figure 12, where an A+P subsystem
   is formed by the CPE and a PRR within the ISP core network and
   preferably is close to the customer edge.  Inside the subsystem,
   packets are forwarded based on address and port.  The provider MAY
   deploy an LSN co-located with the PRR to handle packets that have not
   been translated by the CPE.  In such a configuration, the ISP allows
   the customer to freely decide whether the translation is done at the





<span class="grey">Bush                          Experimental                     [Page 25]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-26" id="page-26" name="page-26"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   CPE or at the LSN.  In order to establish the A+P subsystem, the CPE
   will be configured automatically (e.g., via a signaling protocol that
   conforms to the requirements stated above).

   Note that the CPE in the example above is provisioned with only an
   IPv6 address on the external interface.

    +------------ IPv6-only transport ------------+
    | +---------------+ |              |          |
    | |A+P-application| |  +--------+  |  +-----+ |   dual-stacked
    | | on end-host   |=|==| CPE w/ |==|==| PRR |-|-- network
    | +---------------+ |  +--------+  |  +-----+ |   (public addresses)
    +---------------+   |  +--------+  |  +-----+ |
      private IPv4 &lt;-*--+-&gt;| NAT    |  |  | LSN | |
      address space   \ |  +--------+  |  +-----+ |
      for legacy       +|--------------|----------+
        hosts           |              |
                        |              |
      end-host with     |  CPE device  |  provider
        upgraded        |  on customer |  network
       application      |   premises   |

   Figure 13: An Extended A+P Subsystem with End-Host Running A+P-Aware
                               Applications

   Figure 13 shows an example of how an upgraded application running on
   a legacy end-host can connect to another host in the public realm.
   The legacy host is provisioned with a private IPv4 address allocated
   by the CPE.  Any packet sent from the legacy host will be NATed
   either at the CPE (if configured to do so) or at the LSN (if
   available).

   An A+P-aware application running on the end-host MAY use the
   signaling described in <a href="#section-3.3.1">Section 3.3.1</a> to connect to the A+P subsystem.
   In this case, the application will be delegated some space in the A+P
   address realm, and will be able to contact the public realm (i.e.,
   the public Internet) without the need for translation.

   Note that part of A+P signaling is that the NATs are optional.
   However, if neither the CPE nor the PRR provides NATing
   functionality, then it will not be possible to connect legacy end-
   hosts.

   To enable packet forwarding with A+P, the ISP MUST install at its A+P
   border a PRR that encaps/decaps packets.  However, to achieve a
   higher address space compression ratio and/or to support CPEs without
   NATing functionality, the ISP MAY decide to provide an LSN as well.
   If no LSN is installed in some part of the ISP's topology, all CPEs



<span class="grey">Bush                          Experimental                     [Page 26]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-27" id="page-27" name="page-27"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   in that part of the topology MUST support NAT functionality.  For
   reasons of scalability, it is assumed that the PRR is located within
   the access portion of the network.  The CPE would be configured
   automatically (e.g., via an extended DHCP or NAT-PMP, which has the
   signaling requirements stated above) with the address of the PRR and
   of the LSN (if one is being provided).  Figure 12 illustrates a
   possible deployment scenario.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/5.2.%20%20Dynamic%20Allocation%20of%20Port%20Ranges"></a><a class="selflink" href="#section-5.2" name="section-5.2">5.2</a>.  Dynamic Allocation of Port Ranges</span>

   Allocating a fixed number of ports to all CPEs may lead to exhaustion
   of ports for high-usage customers.  This is a perfect recipe for
   upsetting more demanding customers.  On the other hand, allocating to
   all customers ports sufficiently to match the needs of peak users
   will not be very efficient.  A mechanism for dynamic allocation of
   port ranges allows the ISP to achieve two goals: a more efficient
   compression ratio of the number of customers on one IPv4 address and,
   on the other hand, no limit of the more demanding customers'
   communication.

   Additional allocation of ports or port ranges may be made after an
   initial static allocation of ports.

   The mechanism would prefer allocations of port ranges from the same
   IP address as the initial allocation.  If it is not possible to
   allocate an additional port range from the same IP, then the
   mechanism can allocate a port range from another IP within the same
   subnet.  With every additional port range allocation, the PRR updates
   its routing table.  The mechanism for allocating additional port
   ranges may be part of normal signaling that is used to authenticate
   the CPE to the ISP.

   The ISP controls the dynamic allocation of port ranges by the PRR by
   setting the initial allocation size and maximum number of allocations
   per CPE, or the maximum allocations per subscription, depending on
   subscription level.  There is a general observation that the more
   demanding customer uses around 1024 ports when heavily communicating.
   So, for example, a first suggestion might be 128 ports initially and
   then dynamic allocations of ranges of 128 ports up to 511 more
   allocations maximum.  A configured maximum number of allocations
   could be used to prevent one customer acting in a destructive manner
   should they become infected.  The maximum number of allocations might
   also be more finely grained, with parameters of how many allocations
   a user may request per some time frame.  If this is used, evasive
   applications may need to be limited in their bad behavior; for
   example, one additional allocation per minute would considerably slow
   a port request storm.




<span class="grey">Bush                          Experimental                     [Page 27]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-28" id="page-28" name="page-28"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   There is likely no minimum request size.  This is because A+P-aware
   applications running on end-hosts MAY request a single port (or a few
   ports) for the CPE to be contacted on (e.g., Voice over IP (VoIP)
   clients register a public IP and a single delegated port from the
   CPE, and accept incoming calls on that port).  The implementation on
   the CPE or PRR will dictate how to handle such requests for smaller
   blocks: for example, half of available blocks might be used for
   "block-allocations", 1/6 for single port requests, and the rest for
   NATing.

   Another possible mechanism to allocate additional ports is UPnP/
   NAT-PMP (as defined in <a href="#section-3.3.1">Section 3.3.1</a>), if applications behind CPE
   support it.  In the case of the LSN implementation (DS-Lite), as
   described in <a href="#section-3.3.4">Section 3.3.4</a> about the A+P overall architecture,
   signaling packets are simply forwarded by the CPE to the LSN and back
   to the host running the application that requested the ports, and the
   PRR allocates the requested port to the appropriate CPE.  The same
   behavior may be chosen with AFTR, if requested ports are outside of
   the static initial port allocation.  If a full A+P implementation is
   selected, then UPnPv2/NAT-PMP packets are accepted by the CPE,
   processed, and the requested port number is communicated through the
   normal signaling mechanism between CPE and PRR tunnel endpoints
   (PCP).

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/5.3.%20%20Example%20of%20A%2BP-Forwarded%20Packets"></a><a class="selflink" href="#section-5.3" name="section-5.3">5.3</a>.  Example of A+P-Forwarded Packets</span>

   This section provides a detailed example of A+P setup, configuration,
   and packet flow from an end-host connected to an A+P service provider
   to any host in the IPv4 Internet, and how the return packets flow
   back.  The following example discusses an A+P-unaware end-host, where
   the NATing is done at the CPE.  Figure 14 illustrates how the CPE
   receives an IPv4 packet from the end-user device.  We first describe
   the case where the CPE has been configured to provide the NAT
   functionality (e.g., by the customer through interaction with a
   website or by automatic signaling).  In the following, we call a
   packet that is translated at the CPE an "A+P-forwarded packet", an
   analogy with the port-forwarding function employed in today's CPEs.
   Upon receiving a packet from the internal interface, the CPE
   translates, encapsulates, and forwards it to the PRR.  The NAT on the
   CPE is assumed to have a default route to the public realm through
   its tunnel interface.

   When the PRR receives the A+P-forwarded packet, it decapsulates the
   inner IPv4 packet and checks the source address.  If the source
   address does match the range assigned to A+P-enabled CPEs, then the
   PRR simply forwards the decapsulated packet onward.  This is always
   the case for A+P-forwarded packets.  Otherwise, the PRR assumes that
   the packet is not A+P-forwarded and passes it to the LSN function,



<span class="grey">Bush                          Experimental                     [Page 28]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-29" id="page-29" name="page-29"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   which in turn translates and forwards the packet based on the
   destination address.  Figure 14 shows the packet flow for an outgoing
   A+P-forwarded packet.

                   +-----------+
                   |    Host   |
                   +-----+-----+
                      |  |  198.51.100.2
      IPv4 datagram 1 |  |
                      |  |
                      v  |  198.51.100.1
               +---------|---------+
               |CPE      |         |
               +--------|||--------+
                      | |||     2001:db8::2
                      | ||| 192.0.2.3 (100-200)
       IPv6 datagram 2| |||
                      | |||&lt;-IPv4-in-IPv6
                      | |||
                 -----|-|||-------
               /      | |||        \
              |  ISP access network |
               \      | |||        /
                 -----|-|||-------
                      | |||
                      v |||     2001:db8::1
               +--------|||--------+
               |PRR     |||        |
               +---------|---------+
                      |  |  192.0.2.1
      IPv4 datagram 3 |  |
                 -----|--|--------
               /      |  |         \
              |   ISP network /     |
               \      Internet     /
                 -----|--|--------
                      |  |
                      v  | 203.0.113.1
                   +-----+-----+
                   | IPv4 Host |
                   +-----------+

          Figure 14: Forwarding of Outgoing A+P-Forwarded Packets








<span class="grey">Bush                          Experimental                     [Page 29]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-30" id="page-30" name="page-30"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


     +-----------------+--------------+-----------------------------+
     |        Datagram | Header field | Contents                    |
     +-----------------+--------------+-----------------------------+
     | IPv4 datagram 1 |     IPv4 Dst | 203.0.113.1                 |
     |                 |     IPv4 Src | 198.51.100.2                |
     |                 |      TCP Dst | 80                          |
     |                 |      TCP Src | 8000                        |
     | --------------- | ------------ | --------------------------- |
     | IPv6 datagram 2 |     IPv6 Dst | 2001:db8::1                 |
     |                 |     IPv6 Src | 2001:db8::2                 |
     |                 |     IPv4 Dst | 203.0.113.1                 |
     |                 |     IPv4 Src | 192.0.2.3                   |
     |                 |      TCP Dst | 80                          |
     |                 |      TCP Src | 100                         |
     | --------------- | ------------ | --------------------------- |
     | IPv4 datagram 3 |     IPv4 Dst | 203.0.113.1                 |
     |                 |     IPv4 Src | 192.0.2.3                   |
     |                 |      TCP Dst | 80                          |
     |                 |      TCP Src | 100                         |
     +-----------------+--------------+-----------------------------+

                         Datagram Header Contents

   An incoming packet undergoes the reverse process.  When the PRR
   receives an IPv4 packet on an external interface, it first checks
   whether or not the destination address falls within the A+P CPE
   delegated range.  If the address space was delegated, then the PRR
   encapsulates the incoming packet and forwards it through the
   appropriate tunnel for that IP/port range.  If the address space was
   not delegated, the packet would be handed to the LSN to check if a
   mapping is available.

   Figure 15 shows how an incoming packet is forwarded, under the
   assumption that the port number matches the port range that was
   delegated to the CPE.
















<span class="grey">Bush                          Experimental                     [Page 30]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-31" id="page-31" name="page-31"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


                   +-----------+
                   |    Host   |
                   +-----+-----+
                      ^  |  198.51.100.2
      IPv4 datagram 3 |  |
                      |  |
                      |  |  198.51.100.1
               +---------|---------+
               |CPE      |         |
               +--------|||--------+
                      ^ |||     2001:db8::2
                      | ||| 192.0.2.3 (100-200)
       IPv6 datagram 2| |||
                      | |||&lt;-IPv4-in-IPv6
                      | |||
                 -----|-|||-------
               /      | |||        \
              | ISP access network  |
               \      | |||        /
                 -----|-|||-------
                      | |||
                      | |||     2001:db8::1
               +--------|||--------+
               |PRR     |||        |
               +---------|---------+
                      ^  |  192.0.2.1
      IPv4 datagram 1 |  |
                 -----|--|--------
               /      |  |         \
              |  ISP network /      |
               \      Internet     /
                 -----|--|--------
                      |  |
                      |  | 203.0.113.1
                   +-----+-----+
                   | IPv4 Host |
                   +-----------+

          Figure 15: Forwarding of Incoming A+P-Forwarded Packets












<span class="grey">Bush                          Experimental                     [Page 31]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-32" id="page-32" name="page-32"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


     +-----------------+--------------+-----------------------------+
     |        Datagram | Header field | Contents                    |
     +-----------------+--------------+-----------------------------+
     | IPv4 datagram 1 |     IPv4 Dst | 198.51.100.3                |
     |                 |     IPv4 Src | 203.0.113.1                 |
     |                 |      TCP Dst | 100                         |
     |                 |      TCP Src | 80                          |
     | --------------- | ------------ | --------------------------- |
     | IPv6 datagram 2 |     IPv6 Dst | 2001:db8::2                 |
     |                 |     IPv6 Src | 2001:db8::1                 |
     |                 |     IPv4 Dst | 198.51.100.3                |
     |                 |       IP Src | 203.0.113.1                 |
     |                 |      TCP Dst | 100                         |
     |                 |      TCP Src | 80                          |
     | --------------- | ------------ | --------------------------- |
     | IPv4 datagram 3 |     IPv4 Dst | 198.51.100.2                |
     |                 |     IPv4 Src | 203.0.113.1                 |
     |                 |      TCP Dst | 8000                        |
     |                 |      TCP Src | 80                          |
     +-----------------+--------------+-----------------------------+

                         Datagram Header Contents

   Note that datagram 1 travels untranslated up to the CPE; thus, the
   customer has the same control over the translation as he has today --
   a home gateway with customizable port-forwarding.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.3.1.%20%20Forwarding%20of%20Standard%20Packets"></a><a class="selflink" href="#section-5.3.1" name="section-5.3.1">5.3.1</a>.  Forwarding of Standard Packets</span>

   Packets for which the CPE does not have a corresponding port-
   forwarding rule are tunneled to the PRR that provides the LSN
   function.  We underline that the LSN MUST NOT use the delegated space
   for NATing.  See [<a href="rfc6333.html" title='"Dual- Stack Lite Broadband Deployments Following IPv4 Exhaustion"'>RFC6333</a>] for network diagrams that illustrate the
   packet flow in this case.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.3.2.%20%20Handling%20ICMP"></a><a class="selflink" href="#section-5.3.2" name="section-5.3.2">5.3.2</a>.  Handling ICMP</span>

   ICMP is problematic for all NATs because it lacks port numbers.  A+P
   routing exacerbates the problem.

   Most ICMP messages fall into one of two categories: error reports or
   ECHO/ECHO replies (commonly known as "pings").  For error reports,
   the offending packet header is embedded within the ICMP packet; NAT
   devices can then rewrite that portion and route the packet to the
   actual destination host.  This functionality will remain the same
   with A+P; however, the PRR will need to examine the embedded header
   to extract the port number, while the A+P gateway will do the
   necessary rewriting.



<span class="grey">Bush                          Experimental                     [Page 32]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-33" id="page-33" name="page-33"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   ECHO and ECHO replies are more problematic.  For ECHO, the A+P
   gateway device must rewrite the "Identifier" and perhaps "Sequence
   Number" fields in the ICMP request, treating them as if they were
   port numbers.  This way, the PRR can build the correct A+P address
   for the returning ECHO replies, so they can be correctly routed back
   to the appropriate host in the same way as TCP/UDP packets.  Pings
   originated from the public realm (Internet) towards an A+P device are
   not supported.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.3.3.%20%20Fragmentation"></a><a class="selflink" href="#section-5.3.3" name="section-5.3.3">5.3.3</a>.  Fragmentation</span>

   In order to deliver a fragmented IP packet to its final destination
   (among those having the same IP address), the PRR should activate a
   dedicated procedure similar to the one used by [<a href="rfc6146.html" title='"Stateful NAT64: Network Address and Protocol Translation from IPv6 Clients to IPv4 Servers"'>RFC6146</a>], <a href="#section-3.5">Section</a>
   <a href="#section-3.5">3.5</a>, in the sense that it should reassemble the fragments in order to
   look at the destination port number.

   Note that it is recommended to use a Path MTU Discovery (PMTUD)
   mechanism (e.g., [<a href="rfc1191.html" title='"Path MTU discovery"'>RFC1191</a>]).

   Security issues related to fragmentation are out of scope of this
   document.  For more details, refer to [<a href="rfc1858.html" title='"Security Considerations for IP Fragment Filtering"'>RFC1858</a>].

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.3.4.%20%20Limitations%20of%20the%20A%2BP%20Approach"></a><a class="selflink" href="#section-5.3.4" name="section-5.3.4">5.3.4</a>.  Limitations of the A+P Approach</span>

   One limitation that A+P shares with any other IP-address-sharing
   mechanism is the availability of well-known ports.  In fact, services
   run by customers that share the same IP address will be distinguished
   by the port number.  As a consequence, it will be impossible for two
   customers who share the same IP address to run services on the same
   port (e.g., port 80).  Unfortunately, working around this limitation
   usually implies application-specific hacks (e.g., HTTP and HTTPS
   redirection), discussion of which is out of the scope of this
   document.  Of course, a provider might charge more for giving a
   customer the well-known port range, 0..1024, thus allowing the
   customer to provide externally available services.  Many applications
   require the availability of well-known ports.  However, those
   applications are not expected to work in an A+P environment unless
   they can adapt to work with different ports.  Such applications do
   not work behind today's NATs either.

   Another problem that is common to all NATs is coexistence with IPsec.
   In fact, a NAT that also translates port numbers prevents the
   Authentication Header (AH) and Encapsulating Security Payload (ESP)
   from functioning properly, both in tunnel and in transport mode.  In
   this respect, we stress that, since an A+P subsystem exhibits the
   same external behavior as a NAT, well-known workarounds (such as
   [<a href="rfc3715.html" title='"IPsec-Network Address Translation (NAT) Compatibility Requirements"'>RFC3715</a>]) can be employed.



<span class="grey">Bush                          Experimental                     [Page 33]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-34" id="page-34" name="page-34"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   A+P, as all other port-sharing solutions, suffers from the issues
   documented in [<a href="rfc6269.html" title='"Issues with IP Address Sharing"'>RFC6269</a>], but that's something we'll have to live
   with.

   For the host-based A+P, issues related to application conflicts when
   trying to bind to an out-of-range port are to be further assessed.
   Note that extensions to the host-based model have been proposed in
   the past (e.g., the Port-Enhanced Address Resolution Protocol (ARP)
   extension documented in <a href="http://software.merit.edu/pe-arp/">http://software.merit.edu/pe-arp/</a>).

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/5.3.5.%20%20Port%20Allocation%20Strategy%20Agnostic"></a><a class="selflink" href="#section-5.3.5" name="section-5.3.5">5.3.5</a>.  Port Allocation Strategy Agnostic</span>

   Issues raised by [<a href="#ref-PR-IP-ISSUES">PR-IP-ISSUES</a>] have been analyzed in
   [<a href="#ref-STATELESS-4v6">STATELESS-4v6</a>].  As seen in that document, most of the issues apply
   to host-based port-sharing solutions.  A+P is not intended to be a
   host-based port-sharing solution.

   The conclusion of [<a href="#ref-STATELESS-4v6">STATELESS-4v6</a>] is that the set of issues
   specifically attributed to A+P either do not apply to CPE-based
   flavors or can be mitigated.  The A+P solution represents a
   reasonable trade-off compared to alternatives in areas such as
   binding logging (for data storage purposes) and ease of deployment
   and operations, all of which are actually facilitated by such a
   solution.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/6.%20%20Security%20Considerations"></a><a class="selflink" href="#section-6" name="section-6">6</a>.  Security Considerations</span>

   With CGNs/LSNs, tracing hackers, spammers, and other criminals will
   be difficult, requiring logging, recording, and storing of all
   connection-based mapping information.  The need for storage implies a
   trade-off.  On one hand, the LSNs can manage addresses and ports as
   dynamically as possible in order to maximize aggregation.  On the
   other hand, the more quickly the mapping between private and public
   space changes, the more information needs to be recorded.  This would
   cause concern not only for law enforcement services, but also for
   privacy advocates.

   A+P offers a better set of trade-offs.  All that needs to be logged
   is the allocation of a range of port numbers to a customer.  By
   design, this will be done rarely, improving scalability.  If the NAT
   functionality is moved further up the tree, the logging requirement
   will be as well, increasing the load on one node, but giving it more
   resources to allocate to a busy customer, perhaps decreasing the
   frequency of allocation requests.







<span class="grey">Bush                          Experimental                     [Page 34]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-35" id="page-35" name="page-35"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   The other extreme is A+P NAT on the customer premises.  Such a node
   would be no different than today's NAT boxes, which do no such
   logging.  We thus conclude that A+P is no worse than today's
   situation, while being considerably better than CGNs.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/7.%20%20Acknowledgments"></a><a class="selflink" href="#section-7" name="section-7">7</a>.  Acknowledgments</span>

   The authors wish to especially thank Remi Despres and Pierre Levis
   for their help on the development of the A+P approach.  We also thank
   David Ward for review, constructive criticism, and interminable
   questions, and Dave Thaler for useful criticism on "stackable" A+P
   gateways.  We would also like to thank the following persons for
   their feedback on earlier versions of this work: Rob Austein, Gert
   Doering, Dino Farinacci, Russ Housley, Ruediger Volk, Tina Tsou, and
   Pasi Sarolahti.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/8.%20%20References"></a><a class="selflink" href="#section-8" name="section-8">8</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/8.1.%20%20Normative%20References"></a><a class="selflink" href="#section-8.1" name="section-8.1">8.1</a>.  Normative References</span>

   [<a id="ref-RFC2119" name="ref-RFC2119">RFC2119</a>]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", <a href="https://tools.ietf.org/html/bcp14">BCP 14</a>, <a href="rfc2119.html">RFC 2119</a>, March 1997.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/8.2.%20%20Informative%20References"></a><a class="selflink" href="#section-8.2" name="section-8.2">8.2</a>.  Informative References</span>

   [<a id="ref-4rd" name="ref-4rd">4rd</a>]      Despres, R., Matsushima, S., Murakami, T., and O. Troan,
              "IPv4 Residual Deployment across IPv6-Service networks
              (4rd) ISP-NAT's made optional", Work in Progress,
              March 2011.

   [A+P-EXPERIMENTS]
              Deng, X., Boucadair, M., and F. Telecom, "Implementing A+P
              in the provider's IPv6-only network", Work in Progress,
              March 2011.

   [<a id="ref-BCP38" name="ref-BCP38">BCP38</a>]    Ferguson, P. and D. Senie, "Network Ingress Filtering:
              Defeating Denial of Service Attacks which employ IP Source
              Address Spoofing", <a href="https://tools.ietf.org/html/bcp38">BCP 38</a>, <a href="rfc2827.html">RFC 2827</a>, May 2000.

   [<a id="ref-BITTORRENT-ADDR-SHARING" name="ref-BITTORRENT-ADDR-SHARING">BITTORRENT-ADDR-SHARING</a>]
              Boucadair, M., Grimault, J., Levis, P., and A.
              Villefranque, "Behavior of BitTorrent service in an IP
              Shared Address Environment", Work in Progress, March 2011.

   [<a id="ref-PCP-BASE" name="ref-PCP-BASE">PCP-BASE</a>]
              Wing, D., Cheshire, S., Boucadair, M., Penno, R., and P.
              Selkirk, "Port Control Protocol (PCP)", Work in Progress,
              July 2011.



<span class="grey">Bush                          Experimental                     [Page 35]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-36" id="page-36" name="page-36"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   [<a id="ref-PORT-RANGE-OPT" name="ref-PORT-RANGE-OPT">PORT-RANGE-OPT</a>]
              Boucadair, M., Levis, P., Bajko, G., Savolainen, T., and
              T. ZOU), "Huawei Port Range Configuration Options for PPP
              IPCP", Work in Progress, June 2011.

   [<a id="ref-PR-ADDR-ASSIGN" name="ref-PR-ADDR-ASSIGN">PR-ADDR-ASSIGN</a>]
              Bajko, G., Savolainen, T., Boucadair, M., and P. Levis,
              "Port Restricted IP Address Assignment", Work in Progress,
              September 2010.

   [<a id="ref-PR-IP-ISSUES" name="ref-PR-IP-ISSUES">PR-IP-ISSUES</a>]
              Thaler, D., <a href="https://www.google.com/search?sitesearch=tools.ietf.org%2Fhtml%2F&amp;q=inurl:draft-+%22Issues+With+Port-Restricted+IP+Addresses%22" style="text-decoration: none">"Issues With Port-Restricted IP Addresses"</a>,
              Work in Progress, February 2010.

   [<a id="ref-RFC1191" name="ref-RFC1191">RFC1191</a>]  Mogul, J. and S. Deering, "Path MTU discovery", <a href="rfc1191.html">RFC 1191</a>,
              November 1990.

   [<a id="ref-RFC1858" name="ref-RFC1858">RFC1858</a>]  Ziemba, G., Reed, D., and P. Traina, "Security
              Considerations for IP Fragment Filtering", <a href="rfc1858.html">RFC 1858</a>,
              October 1995.

   [<a id="ref-RFC1918" name="ref-RFC1918">RFC1918</a>]  Rekhter, Y., Moskowitz, R., Karrenberg, D., Groot, G., and
              E. Lear, "Address Allocation for Private Internets",
              <a href="https://tools.ietf.org/html/bcp5">BCP 5</a>, <a href="rfc1918.html">RFC 1918</a>, February 1996.

   [<a id="ref-RFC3715" name="ref-RFC3715">RFC3715</a>]  Aboba, B. and W. Dixon, "IPsec-Network Address Translation
              (NAT) Compatibility Requirements", <a href="rfc3715.html">RFC 3715</a>, March 2004.

   [<a id="ref-RFC5737" name="ref-RFC5737">RFC5737</a>]  Arkko, J., Cotton, M., and L. Vegoda, "IPv4 Address Blocks
              Reserved for Documentation", <a href="rfc5737.html">RFC 5737</a>, January 2010.

   [<a id="ref-RFC6052" name="ref-RFC6052">RFC6052</a>]  Bao, C., Huitema, C., Bagnulo, M., Boucadair, M., and X.
              Li, "IPv6 Addressing of IPv4/IPv6 Translators", <a href="rfc6052.html">RFC 6052</a>,
              October 2010.

   [<a id="ref-RFC6146" name="ref-RFC6146">RFC6146</a>]  Bagnulo, M., Matthews, P., and I. van Beijnum, "Stateful
              NAT64: Network Address and Protocol Translation from IPv6
              Clients to IPv4 Servers", <a href="rfc6146.html">RFC 6146</a>, April 2011.

   [<a id="ref-RFC6269" name="ref-RFC6269">RFC6269</a>]  Ford, M., Boucadair, M., Durand, A., Levis, P., and P.
              Roberts, "Issues with IP Address Sharing", <a href="rfc6269.html">RFC 6269</a>,
              June 2011.

   [<a id="ref-RFC6333" name="ref-RFC6333">RFC6333</a>]  Durand, A., Droms, R., Woodyatt, J., and Y. Lee, "Dual-
              Stack Lite Broadband Deployments Following IPv4
              Exhaustion", <a href="rfc6333.html">RFC 6333</a>, August 2011.





<span class="grey">Bush                          Experimental                     [Page 36]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-37" id="page-37" name="page-37"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   [<a id="ref-SHARED-ADDR-OPT" name="ref-SHARED-ADDR-OPT">SHARED-ADDR-OPT</a>]
              Boucadair, M., Levis, P., Grimault, J., Savolainen, T.,
              and G. Bajko, "Dynamic Host Configuration Protocol
              (DHCPv6) Options for Shared IP Addresses Solutions",
              Work in Progress, December 2009.

   [<a id="ref-STATELESS-4v6" name="ref-STATELESS-4v6">STATELESS-4v6</a>]
              Dec, W., Asati, R., Bao, C., and H. Deng, "Stateless 4Via6
              Address Sharing", Work in Progress, July 2011.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/9.%20%20Contributing%20Authors"></a><a class="selflink" href="#section-9" name="section-9">9</a>.  Contributing Authors</span>

   This document has nine primary authors.

   Gabor Bajko
   Nokia
   EMail: gabor.bajko@nokia.com

   Mohamed Boucadair
   France Telecom
   3, Av Francois Chateaux
   Rennes  35000
   France
   EMail: mohamed.boucadair@orange-ftgroup.co

   Steven M. Bellovin
   Columbia University
   1214 Amsterdam Avenue
   MC 0401
   New York, NY  10027
   US
   Phone: +1 212 939 7149
   EMail: bellovin@acm.org

   Randy Bush
   Internet Initiative Japan
   5147 Crystal Springs
   Bainbridge Island, Washington  98110
   US
   Phone: +1 206 780 0431 x1
   EMail: randy@psg.com










<span class="grey">Bush                          Experimental                     [Page 37]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-38" id="page-38" name="page-38"> </a>
<span class="grey"><a href="rfc6346.html">RFC 6346</a>                A+P Addressing Extension             August 2011</span>


   Luca Cittadini
   Universita' Roma Tre
   via della Vasca Navale, 79
   Rome,   00146
   Italy
   Phone: +39 06 5733 3215
   EMail: luca.cittadini@gmail.com

   Olaf Maennel
   Loughborough University
   Department of Computer Science - N.2.03
   Loughborough
   United Kingdom
   Phone: +44 115 714 0042
   EMail: o@maennel.net

   Reinaldo Penno
   Juniper Networks
   1194 North Mathilda Avenue
   Sunnyvale, California  94089
   US
   EMail: rpenno@juniper.net

   Teemu Savolainen
   Nokia
   Hermiankatu 12 D
   TAMPERE, FI-33720
   Finland
   EMail: teemu.savolainen@nokia.com

   Jan Zorz
   Go6 Institute Slovenia
   Frankovo naselje 165
   Skofja Loka,  4220
   Slovenia
   EMail: jan@go6.si

Editor's Address

   Randy Bush (editor)
   Internet Initiative Japan
   5147 Crystal Springs
   Bainbridge Island, Washington  98110
   US

   Phone: +1 206 780 0431 x1
   EMail: randy@psg.com




Bush                          Experimental                     [Page 38]

</pre><br/>
    <span class="noprint"><small><small>Html markup produced by rfcmarkup 1.126, available from
      <a href="https://tools.ietf.org/tools/rfcmarkup/">https://tools.ietf.org/tools/rfcmarkup/</a>
    </small></small></span>
  </div>




</body><!-- Mirrored from tools.ietf.org/html/rfc6346 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Mar 2018 23:18:30 GMT --></html>