<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><!-- Mirrored from tools.ietf.org/html/rfc3215 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 28 Apr 2015 16:02:18 GMT --><!-- Added by HTTrack --><head><meta content="text/html;charset=utf-8" http-equiv="content-type"/><!-- /Added by HTTrack -->

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <meta content="index,follow" name="robots"/>
    <meta content="rfcmarkup version 1.111" name="creator"/>
    <link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/>
<meta content="draft-wu-mpls-ldp-state" name="DC.Relation.Replaces"/>
<meta content="urn:ietf:rfc:3215" name="DC.Identifier"/>
<meta content="January, 2002" name="DC.Date.Issued"/>
<meta content="Cheval, Pierrick" name="DC.Creator"/>
<meta content="Gray, Eric" name="DC.Creator"/>
<meta content="Boscher, Christophe" name="DC.Creator"/>
<meta content="Wu, Liwen" name="DC.Creator"/>
<meta content="This document provides state machine tables for ATM (Asynchronous
Transfer Mode) switch LSRs. In the current LDP specification, there is
no state machine specified for processing LDP messages. We think that
defining a common state machine is very important for interoperability
between different LDP and CR-LDP implementations. This memo provides
information for the Internet community." name="DC.Description.Abstract"/>
<meta content="LDP State Machine" name="DC.Title"/>

    <link href="http://tools.ietf.org/images/rfc.png" rel="icon" type="image/png"/>
    <link href="http://tools.ietf.org/images/rfc.png" rel="shortcut icon" type="image/png"/>
    <title>RFC 3215 - LDP State Machine</title>
    
    
    <style type="text/css">
	body {
	    margin: 0px 8px;
            font-size: 1em;
	}
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        a.selflink {
          color: black;
          text-decoration: none;
        }
        @media print {
            body {
                font-family: monospace;
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 1em;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>                   <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>                     <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>             <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>              <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td>      <td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td>         <td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard (old designation):</td> <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Internet Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>                  <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>                  <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
   <div style="height: 13px;">
      <div class="pre noprint docinfo bgorange" onclick="showElem('legend');" onmouseout="hideElem('legend')" onmouseover="this.style.cursor='pointer';" style="height: 6px; position: absolute;" title="Click for colour legend.">                                                                        </div>
      <div class="docinfo noprint pre legend" id="legend" onmouseout="hideElem('legend');" onmouseover="showElem('legend');" style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; ">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="index.html" title="Document search and retrieval page">Docs</a>] [<a href="http://tools.ietf.org/rfc/rfc3215.txt" title="Plaintext version of this document">txt</a>|<a href="http://tools.ietf.org/pdf/rfc3215" title="PDF version of this document">pdf</a>] [<a href="http://tools.ietf.org/html/draft-ietf-mpls-ldp-state" title="draft-ietf-mpls-ldp-state">draft-ietf-mpls-l...</a>] [<a href="http://tools.ietf.org/rfcdiff?difftype=--hwdiff&amp;url2=rfc3215" title="Inline diff (wdiff)">Diff1</a>] [<a href="http://tools.ietf.org/rfcdiff?url2=rfc3215" title="Side-by-side diff">Diff2</a>]                 </span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<span class="pre noprint docinfo">                                                           INFORMATIONAL</span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<pre>Network Working Group                                         C. Boscher
Request for Comments: 3215                                     P. Cheval
Category: Informational                                          Alcatel
                                                                   L. Wu
                                                                   Cisco
                                                                 E. Gray
                                                               Sandburst
                                                            January 2002


                           <span class="h1">LDP State Machine</span>

Status of this Memo

   This memo provides information for the Internet community.  It does
   not specify an Internet standard of any kind.  Distribution of this
   memo is unlimited.

Copyright Notice

   Copyright (C) The Internet Society (2002).  All Rights Reserved.

Abstract

   This document provides state machine tables for ATM (Asynchronous
   Transfer Mode) switch LSRs.  In the current LDP specification, there
   is no state machine specified for processing LDP messages. We think
   that defining a common state machine is very important for
   interoperability between different LDP and CR-LDP implementations.

   We begin in <a href="#section-1">section 1</a> by defining a list of terminologies.  Then in
   <a href="#section-2">section 2</a>, we propose two sets of state machine tables for ATM switch
   LSRs that use downstream-on-demand mode, one method can be used for
   non-vc merge capable ATM LSRs, while the other one can be used for
   the vc-merge capable ATM LSRs.  In <a href="#section-3">section 3</a>, we provides a state
   machine for downstream unsolicited mode ATM LSRs.

   We focus on the LDP state machines and the associated control blocks
   used for establishing and maintaining LSPs.  We do not describe state
   machines for the "LDP controller" that is in charge of LDP session
   initialization, address mapping messages management, routing
   interface, etc. that is defined in the LDP specification.

   Even though the state machines in this document are specific for
   ATM-LSR, they can be easily adapted for other types of LSRs.






<span class="grey">Boscher, et al.              Informational                      [Page 1]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-2" id="page-2" name="page-2"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


Table Of Contents

   <a href="#section-1">1</a>. Terminology ...................................................  <a href="#page-4">4</a>
   <a href="#section-2">2</a>. State Machine for Downstream-on-Demand Mode ...................  <a href="#page-4">4</a>
   <a href="#section-2.1">2.1</a> An LSR's Behavior in the Case of a Next Hop Change ...........  <a href="#page-4">4</a>
   <a href="#section-2.2">2.2</a>. ATM Switch LSR with No VC-merge Capability ..................  <a href="#page-5">5</a>
   <a href="#section-2.2.1">2.2.1</a> LSP Control Block ..........................................  <a href="#page-5">5</a>
   <a href="#section-2.2.2">2.2.2</a> States .....................................................  <a href="#page-7">7</a>
   <a href="#section-2.2.3">2.2.3</a> Events .....................................................  <a href="#page-8">8</a>
   <a href="#section-2.2.4">2.2.4</a> State Transitions ..........................................  <a href="#page-9">9</a>
   <a href="#section-2.2.5">2.2.5</a> State Machine .............................................. <a href="#page-10">10</a>
   <a href="#section-2.2.5.1">2.2.5.1</a> State -- "IDLE" .......................................... <a href="#page-10">10</a>
   <a href="#section-2.2.5.2">2.2.5.2</a> State -- "RESPONSE_AWAITED" .............................. <a href="#page-13">13</a>
   <a href="#section-2.2.5.3">2.2.5.3</a> State -- "ESTABLISHED" ................................... <a href="#page-16">16</a>
   <a href="#section-2.2.5.4">2.2.5.4</a> State -- "RELEASE_AWAITED" ............................... <a href="#page-21">21</a>
   <a href="#section-2.2.6">2.2.6</a> Handling the Next Hop Change ............................... <a href="#page-23">23</a>
   <a href="#section-2.2.6.1">2.2.6.1</a> Next Hop Trigger Control Block ........................... <a href="#page-24">24</a>
   <a href="#section-2.2.6.2">2.2.6.2</a> States ................................................... <a href="#page-24">24</a>
   <a href="#section-2.2.6.3">2.2.6.3</a> Events ................................................... <a href="#page-24">24</a>
   <a href="#section-2.2.6.4">2.2.6.4</a> State Transition for next hop change ..................... <a href="#page-25">25</a>
   <a href="#section-2.2.6.5">2.2.6.5</a> State Machine ............................................ <a href="#page-25">25</a>
   <a href="#section-2.2.6.5.1">2.2.6.5.1</a> State -- "IDLE" ........................................ <a href="#page-25">25</a>
   <a href="#section-2.2.6.5.2">2.2.6.5.2</a> State -- "NEW_NH_RETRY" ................................ <a href="#page-27">27</a>
   <a href="#section-2.2.6.5.3">2.2.6.5.3</a> State -- "NEW_NH_RESPONSE_AWAITED" ..................... <a href="#page-28">28</a>
   <a href="#section-2.2.7">2.2.7</a> LDP Related Message Handling ............................... <a href="#page-29">29</a>
   <a href="#section-2.3">2.3</a>. ATM Switch LSR with VC-merge ................................ <a href="#page-31">31</a>
   <a href="#section-2.3.1">2.3.1</a> VC-merge ................................................... <a href="#page-31">31</a>
   <a href="#section-2.3.2">2.3.2</a> Control Block .............................................. <a href="#page-31">31</a>
   <a href="#section-2.3.3">2.3.3</a>   State Machines for Downstream-on-demand Mode ............. <a href="#page-34">34</a>
   2.3.3.1 State of the Upstream LSP Control Block's State Machine
           for Downstream-on-demand Mode ............................ <a href="#page-34">34</a>
   2.3.3.2 Events of the Upstream LSP Control Block's State Machine
           for Downstream-on-demand Mode ............................ <a href="#page-35">35</a>
   2.3.3.3 State Transitions of the Upstream LSP Control Block's State
           Machine for Downstream-on-demand Mode .................... <a href="#page-36">36</a>
   2.3.3.4 Upstream LSP Control Block's State Machine
           for Downstream-on-demand Mode ............................ <a href="#page-37">37</a>
   <a href="#section-2.3.3.4.1">2.3.3.4.1</a> State -- "IDLE" ........................................ <a href="#page-37">37</a>
   <a href="#section-2.3.3.4.2">2.3.3.4.2</a> State -- "RESPONSE_AWAITED" ............................ <a href="#page-39">39</a>
   <a href="#section-2.3.3.4.3">2.3.3.4.3</a> State -- "ESTABLISHED" ................................. <a href="#page-42">42</a>
   <a href="#section-2.3.3.4.4">2.3.3.4.4</a> State -- "RELEASE_AWAITED" ............................. <a href="#page-45">45</a>
   2.3.3.5 State of the Downstream LSP Control Block's State Machine
           for Downstream-on-demand Mode ............................ <a href="#page-47">47</a>
   2.3.3.6 Events of the Downstream LSP Control Block's State Machine
           for Downstream-on-demand Mode ............................ <a href="#page-47">47</a>
   2.3.3.7 State Transitions of the Downstream LSP Control Block's
           State Machine for Downstream-on-demand mode .............. <a href="#page-48">48</a>




<span class="grey">Boscher, et al.              Informational                      [Page 2]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-3" id="page-3" name="page-3"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   2.3.3.8 Downstream LSP Control Block's State Machine for
           Downstream-on-demand Mode ................................ <a href="#page-49">49</a>
   <a href="#section-2.3.3.8.1">2.3.3.8.1</a> State -- "IDLE" ........................................ <a href="#page-48">48</a>
   <a href="#section-2.3.3.8.2">2.3.3.8.2</a> State -- "RESPONSE_AWAITED" ............................ <a href="#page-50">50</a>
   <a href="#section-2.3.3.8.3">2.3.3.8.3</a> State -- "ESTABLISHED" ................................. <a href="#page-52">52</a>
   2.3.3.9 State of the Next_Hop_Trigger_Control_Block's State
           Machine for Downstream-on-demand Mode .................... <a href="#page-53">53</a>
   2.3.3.10 Events of the Next_Hop_Trigger_Control_Block's State
            Machine for Downstream-on-demand Mode ................... <a href="#page-53">53</a>
   2.3.3.11 State Transitions of the Next_Hop_Trigger_Control_Block's
            State Machine for Downstream-on-demand Mode ............. <a href="#page-55">55</a>
   <a href="#section-2.3.3.12">2.3.3.12</a> State Machine ........................................... <a href="#page-55">55</a>
   <a href="#section-2.3.3.12.1">2.3.3.12.1</a> State -- "IDLE" ....................................... <a href="#page-55">55</a>
   <a href="#section-2.3.3.12.2">2.3.3.12.2</a> State -- "NEW_NH_RETRY" ............................... <a href="#page-57">57</a>
   <a href="#section-2.3.3.12.3">2.3.3.12.3</a> State -- "NEW_NH_RESPONSE_AWAITED" .................... <a href="#page-58">58</a>
   <a href="#section-2.3.4">2.3.4</a> LDP Related Message Processing ............................. <a href="#page-59">59</a>
   <a href="#section-3">3</a>. State Machine for Downstream Unsolicited ...................... <a href="#page-61">61</a>
   <a href="#section-3.1">3.1</a> Control Block ................................................ <a href="#page-61">61</a>
   3.2 States of the Upstream LSP Control Block's State Machine
       for Downstream Mode .......................................... <a href="#page-62">62</a>
   3.3 Events of the Upstream LSP Control Block's State Machine
       for Downstream Mode .......................................... <a href="#page-62">62</a>
   3.4 State Transitions of Upstream LSP Control Block's State
       Machine for Downstream Mode .................................. <a href="#page-64">64</a>
   3.5 Upstream LSP Control Block's State Machine for
       Downstream Mode .............................................. <a href="#page-65">65</a>
   <a href="#section-3.5.1">3.5.1</a> : State -- "IDLE" .......................................... <a href="#page-65">65</a>
   <a href="#section-3.5.2">3.5.2</a> : State -- "ESTABLISHED" ................................... <a href="#page-66">66</a>
   <a href="#section-3.5.3">3.5.3</a> : State -- "RELEASE_AWAITED" ............................... <a href="#page-67">67</a>
   <a href="#section-3.5.4">3.5.4</a> : State -- "RESOURCE_AWAITED" .............................. <a href="#page-69">69</a>
   3.6 State of the Downstream LSP Control Block's State Machine
       for Downstream Mode .......................................... <a href="#page-70">70</a>
   3.7 Events of the Downstream LSP Control Block's State Machine
       for Downstream Mode .......................................... <a href="#page-70">70</a>
   3.8 State Transitions of Downstream LSP Control Block's State
       Machine for Downstream Mode .................................. <a href="#page-71">71</a>
   3.9 Downstream LSP Control Block's State Machine
       for Downstream Mode .......................................... <a href="#page-71">71</a>
   <a href="#section-3.9.1">3.9.1</a> : State -- "IDLE" .......................................... <a href="#page-71">71</a>
   <a href="#section-3.9.2">3.9.2</a> : State -- "ESTABLISHED" ................................... <a href="#page-73">73</a>
   <a href="#section-3.10">3.10</a> LDP Related Message Processing for downstream mode .......... <a href="#page-74">74</a>
   <a href="#section-4">4</a>. Security Considerations ....................................... <a href="#page-75">75</a>
   <a href="#section-5">5</a>. Acknowledgements .............................................. <a href="#page-76">76</a>
   <a href="#section-6">6</a>. References .................................................... <a href="#page-76">76</a>
   <a href="#section-7">7</a>. Authors' Address .............................................. <a href="#page-77">77</a>
   <a href="#section-8">8</a>. Full Copyright Statement ...................................... <a href="#page-78">78</a>





<span class="grey">Boscher, et al.              Informational                      [Page 3]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-4" id="page-4" name="page-4"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/1.%20Terminology"></a><a class="selflink" href="#section-1" name="section-1">1</a>. Terminology</span>

   -  LDP-REQUEST: LDP Label Request message

   -  LDP-MAPPING: LDP Label Mapping message

   -  LDP-WITHDRAW: LDP Label Withdraw message

   -  LDP-RELEASE: LDP Label Release message

   -  LDP-ABORT: LDP Abort message used to abort a LSP setup.

   -  LDP-NAK: LDP Notification message used to reject an LDP message.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/2.%20State%20Machine%20for%20Downstream-on-Demand%20Mode"></a><a class="selflink" href="#section-2" name="section-2">2</a>. State Machine for Downstream-on-Demand Mode</span>

   In this document, we provide two sets of state machines: one for the
   ATM LSR that does not have VC-merge capability, and the other for the
   ATM LSR that does have VC-merge capability.

   State machine descriptions are given in terms of control blocks,
   states, events, response actions and state transitions.  Control
   blocks contain the information that is required to support handling
   of events.  A control block may also contain any additional
   information that is required either of any specific implementation or
   in support of other required functions.  In every case, additional
   information required to support the procedures defined in the LDP
   specification [<a href="#ref-4" title='"LDP Specification"'>4</a>] or management objects defined in the LDP MIB [<a href="#ref-3" title='"Definition of Managed Objects for the Multiprotocol Label Switching, Label Distribution Protocol (LDP)"'>3</a>]
   would be stored in a specific LDP implementation - either as part of
   the control block structure or in some other way.

   The state machines cover both independent LSP control and ordered LSP
   control.

   Loop detection and loop prevention messages will be processed as
   specified in [<a href="#ref-4" title='"LDP Specification"'>4</a>].  The impact of loop detection and loop prevention
   messages on state transitions is left for further study.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/2.1%20An%20LSR%27s%20Behavior%20in%20the%20Case%20of%20a%20Next%20Hop%20Change"></a><a class="selflink" href="#section-2.1" name="section-2.1">2.1</a> An LSR's Behavior in the Case of a Next Hop Change</span>

   When there is a topology change and an LSR detects a new better next
   hop for an LSP, it may behave in 2 different ways:

   1) It tries to do a "local repair".  This means that it extends the
      LSP through the new next hop, releases the old path from this LSR
      forward and then splices into this newly extended LSP.





<span class="grey">Boscher, et al.              Informational                      [Page 4]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-5" id="page-5" name="page-5"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   2) If the LSP is created with the "pinned" option (CR-LDP[5]), the
      LSR ignores the new next hop change, and the LSP stays unchanged.
      The LSR may decide to send an LDP-MAPPING containing attributes
      for this New Next Hop (NH) that have changed.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/2.2.%20ATM%20Switch%20LSR%20with%20No%20VC-merge%20Capability"></a><a class="selflink" href="#section-2.2" name="section-2.2">2.2</a>. ATM Switch LSR with No VC-merge Capability</span>

   In an MPLS domain where some ATM LSRs do not have VC-merge
   capability, downstream-on-demand mode is required for these ATM LSRs
   [<a href="#ref-1" title='"MPLS Using LDP and ATM Switching"'>1</a>].  Also, "conservative label retention mode" is required in this
   case [<a href="#ref-1" title='"MPLS Using LDP and ATM Switching"'>1</a>].

   For each LSP, there are 2 kinds of state machines involved:

   1) the LSP Control Block and its state machine that can be used to
      handle normal LSP setup.  It is created when the LSR receives a
      new LDP Request and it is deleted when the LSP of this request is
      torn down.

   2) the Next Hop Trigger Control Block and its state machine that is
      used to handle switching over to a better LSP through a different
      next hop.  It is created when the LSR decides to switch over to a
      better next hop and it is deleted when the LSR finishes switching
      over to the better next hop.  This state machine uses a timer (and
      has corresponding states) to ensure that switch over occurs in a
      timely fashion after a routing transient has had time to
      stabilize.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/2.2.1%20LSP%20Control%20Block"></a><a class="selflink" href="#section-2.2.1" name="section-2.2.1">2.2.1</a> LSP Control Block</span>

   For each LSP, an LSP Control Block is defined that may contain the
   following information:

      -  Upstream Label Request ID (assigned by the upstream LSR), that
         is the 'Message Id' in the Label Request Message received from
         the upstream LSR.

      -  Downstream Label Request ID (assigned by this LSR itself), that
         is 'Message Id' in the Label Request Message sent to the
         downstream LSR.

      -  Upstream LDP Identifier

      -  Downstream LDP Identifier

      -  State

      -  FEC



<span class="grey">Boscher, et al.              Informational                      [Page 5]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-6" id="page-6" name="page-6"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


      -  Upstream Label (assigned by this LSR)

      -  Downstream Label (assigned by the downstream LSR)

      -  Trigger Control Block Pointer, (Only used at the ingress LSR of
         a LSP) that points to the control block that triggers setting
         up this LSP or tearing down this LSP.

      -  Next Hop Control Block Pointer, that points to the control
         block that is used for switching over to a better LSP.

   The following index combinations can be used to locate a unique LSP
   Control Block:

      -  Downstream Label and Downstream LDP Identifier, or

      -  Upstream Label and Upstream LDP Identifier, or

      -  Downstream Label Request ID and Downstream LDP Identifier

      -  Upstream Label Request ID and Upstream LDP Identifier

   Here is the relationship between different control blocks, the detail
   definition of Next Hop Trigger Control Block is described in <a href="#section-2.2.6">section</a>
   <a href="#section-2.2.6">2.2.6</a>.

   For example, an LSP that transits through (LSR-A, LSR-B, LSR-C, LSR-
   D):

      LSR-A ----&gt; LSR-B ---&gt; LSR-C ---&gt; LSR-D

   The control blocks in LSR-A are:

                  +-----------------------+
                  | Trigger Control Block |
                  |  (e.g, by config)     |
                  +-----------------------+
                             ^
                             |(Trigger Control block pointer)
                             |
                             |
                  +-----------------------+
                  | LSP Control Block     |
                  +-----------------------+

   When LSR-B detects a better next hop to LSR-D through LSR-E,  and  it
   decides to switch over to it, so control blocks in LSR-B are:




<span class="grey">Boscher, et al.              Informational                      [Page 6]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-7" id="page-7" name="page-7"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


                +-----------------------+
                | LSP Control Block     |
                | (original LSP)        |
                +-----------------------+
             (LSP      ^  |
              Control  |  | (Next Hop Trigger Control Block Pointer)
              Block    |  |
              Pointer) |  v
                +--------------------------------+
                | Next Hop Trigger Control Block |
                +--------------------------------+
                       ^  |
             (Trigger  |  | (New Next Hop LSP
               Control |  |  Control Block Pointer)
               Block   |  |
               Pointer)|  |
                       |  v
                +------------------------+
                | LSP Control Block      |
                | (for LSP: LSR-B, LSR-E,|
                |   LSR-D)               |
                +------------------------+

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/2.2.2%20%20%20States"></a><a class="selflink" href="#section-2.2.2" name="section-2.2.2">2.2.2</a>   States</span>

   This section describes the various states that are used in the state
   machine for the ATM non VC-merge LSR.

   -- IDLE

   This is the initial LSP state, when the LSP Control Block is created.

   -- RESPONSE_AWAITED

   This state means that the LSR has received and processed an LDP-
   REQUEST from an upstream LSR, or it has received an internal set up
   request.  It has sent a new LDP-REQUEST towards a downstream LSR.
   The LSR is waiting for the LDP-MAPPING from the downstream LSR.

   -- ESTABLISHED

   This state means that the LSR has received the LDP-MAPPING from the
   downstream LSR and the LSP is up and operational.

   -- RELEASE_AWAITED

   This state means that the LSR has sent a LDP-WITHDRAW upstream and is
   waiting for the LDP-RELEASE before freeing up the label resource.



<span class="grey">Boscher, et al.              Informational                      [Page 7]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-8" id="page-8" name="page-8"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/2.2.3%20Events"></a><a class="selflink" href="#section-2.2.3" name="section-2.2.3">2.2.3</a> Events</span>

   -- LDP Request

   The LSR receives an LDP-REQUEST from an upstream LSR.

   -- LDP Mapping

   The LSR receives an LDP-MAPPING from a downstream LSR.

   -- LDP Release

   The LSR receives an LDP-RELEASE from an upstream LSR.

   -- LDP Withdraw

   The LSR receives an LDP-WITHDRAW from a downstream LSR.

   -- LDP Upstream Abort

   The LSR receives an LDP-ABORT from an upstream LSR.

   -- LDP Downstream NAK The LSR receives an LDP-NAK (notification) from
   an downstream LSR.

   -- Upstream Lost

   The LSR loses its LDP session with an upstream LDP peer.

   -- Downstream Lost

   The LSR loses its LDP session with a downstream LDP peer.

   -- Internal SetUp

   For some reason, e.g. a configuration request of a traffic
   engineering tunnel, or recognizing a new FEC could trigger an
   Internal SetUp event to set up a new LSP from this node.

   -- Internal Destroy

   The LSR send an Internal Destroy event to tear down an LSP.

   -- Internal Cross-Connect

   The LSR send an Internal Cross-Connect to splice two LSPs into one
   LSP.  This happens when a LSR switches over to a better next hop.




<span class="grey">Boscher, et al.              Informational                      [Page 8]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-9" id="page-9" name="page-9"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   -- Internal New NH

   The LSR decides to switch over the better next hop.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/2.2.4%20State%20Transitions"></a><a class="selflink" href="#section-2.2.4" name="section-2.2.4">2.2.4</a> State Transitions</span>

   The following diagram describes briefly the state transitions.

             +-------------------+
             |                   |&lt;-------------------+
   +--------&gt;|  IDLE             |                    |
   |         |                   |----------+         |
   |         +-------------------+          |         |
   |(LDP Release)      |                    |         |
   |(LDP Upstream      |(LDP Request 1)     |         | (LDP Release)
   | Abort             |(Internal SetUp)    |         | (Upstream Lost)
   |(Internal Destroy) |                    |         |
   |(Upstream Lost)    v                    |         |
   |         +-------------------+          |         |
   +---------|                   |          |         |
             |  RESPONSE_AWAITED |          |         |
   +---------|                   |          |         |
   |         +-------------------+          |         |
   |                  |                     |         |
   |(Downstream Lost) |(LDP Mapping)        |         |
   |(LDP Downstream   |                     |         |
   | NAK)             |     +---------------+         |
   |                  |     | (LDP Request 2)         |
   |                  |     |                         |
   |                  v     v                         |
   |         +-------------------+ (LDP Withdraw 1)   |
   |         |                   | (Internal Destroy) |
   |         |  ESTABLISHED      |------------&gt;-------+
   |         |                   |                    |
   |         +-------------------+                    |
   |                  |                               |
   |                  |                               |
   |                  |(LDP Withdraw 2)               | (LDP Upstream
   |                  |(Downstream Lost)              |  Abort)
   |                  |                               |
   |                  v                               |
   |         +-------------------+                    |
   |         |                   |                    |
   +--------&gt;| RELEASE_AWAITED   |------------&gt;-------+
             |                   |
             +-------------------+





<span class="grey">Boscher, et al.              Informational                      [Page 9]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-10" id="page-10" name="page-10"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/2.2.5%20State%20Machine"></a><a class="selflink" href="#section-2.2.5" name="section-2.2.5">2.2.5</a> State Machine</span>

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.2.5.1%20State%20--%20%22IDLE%22"></a><a class="selflink" href="#section-2.2.5.1" name="section-2.2.5.1">2.2.5.1</a> State -- "IDLE"</span>

   State:          IDLE

   Event:          LDP Request

   New State:      Depends upon the action routine.

   Actions:

      If this LSR is the LSP Egress or Proxy Egress [<a href="#ref-2" title='"Multiprotocol Label Switching Architecture"'>2</a>]

   Then:
      Choose an upstream label, connect this upstream label to the local
      IP forwarding module, allocate the resources, send the LDP-MAPPING
      upstream with the upstream label, and go to the new state
      `ESTABLISHED'.

   else
      Obtain a next hop (or interface) with the FEC specified in the
      LDP-REQUEST, propagate the LDP-REQUEST, with newly assigned
      Message ID by this LSR, towards the obtained next hop, and go to
      the new state `RESPONSE_AWAITED'.

      If the LSR uses the independent control mode [<a href="#ref-2" title='"Multiprotocol Label Switching Architecture"'>2</a>], choose an
      upstream label, connect this upstream label to the local IP
      forwarding module, go to the ESTABLISHED state and send an LDP-
      MAPPING upstream with the upstream label.

   If unable to process the request for any reason, issue an LDP-NAK to
   the sender with the appropriate error code, go to IDLE and delete the
   LSP Control Block.

   State:          IDLE

   Event:          LDP Mapping

   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          LDP Release



<span class="grey">Boscher, et al.              Informational                     [Page 10]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-11" id="page-11" name="page-11"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          LDP Withdraw

   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          LDP Upstream Abort

   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          LDP Downstream NAK

   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          Upstream Lost

   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          IDLE




<span class="grey">Boscher, et al.              Informational                     [Page 11]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-12" id="page-12" name="page-12"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Event:          Downstream Lost

   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          Internal SetUp

   New State:      RESPONSE_AWAITED

   Actions:

      Set up the Trigger Control Block pointer,

      Obtain a next hop (or interface) with the FEC specified in the
      Internal SetUp message, send a LDP-REQUEST towards the obtained
      next hop, and go to the new state `RESPONSE_AWAITED'.

   State:          IDLE

   Event:          Internal Destroy

   New State:      IDLE

   Actions:

      Ignore.  It is an internal implementation error.

   State:          IDLE

   Event:          Internal Cross-Connect

   New State:      IDLE

   Actions:

      Ignore.  It is an internal implementation error.

   State:          IDLE

   Event:          Internal New NH

   New State:      IDLE




<span class="grey">Boscher, et al.              Informational                     [Page 12]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-13" id="page-13" name="page-13"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Actions:

      Ignore.  It is an internal implementation error.

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.2.5.2%20State%20--%20%22RESPONSE_AWAITED%22"></a><a class="selflink" href="#section-2.2.5.2" name="section-2.2.5.2">2.2.5.2</a> State -- "RESPONSE_AWAITED"</span>

   State:          RESPONSE_AWAITED

   Event:          LDP Request

   New State:      RESPONSE_AWAITED

   Actions:

      Ignore the event.  It is an internal implementation error.  A non
      VC merge ATM LSR must create a new LSP control block for a new LDP
      request.

   State:          RESPONSE_AWAITED

   Event:          LDP Mapping

   New State:      ESTABLISHED

   Actions:

      1) If the LSP is triggered by the local router (Trigger Control
         Block Pointer is not zero), send event `Internal LSP UP' to the
         Trigger control block.

      2) Else If the LSR uses the ordered control mode, choose an
         upstream label.

      3) Connect the upstream label to the downstream label.  Allocate
         the resources.  Propagate the LDP-MAPPING upstream with the
         upstream label.

      If unable to process the message, disconnect the upstream label
      from the downstream label, free the upstream label, release the
      resources, send an LDP-RELEASE downstream and an LDP-NAK upstream
      with status (No Label Resources [<a href="#ref-4" title='"LDP Specification"'>4</a>]), go to IDLE and delete the
      LSP Control Block.

   State:          RESPONSE_AWAITED

   Event:          LDP Release

   New State:      IDLE



<span class="grey">Boscher, et al.              Informational                     [Page 13]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-14" id="page-14" name="page-14"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Actions:

      If the LSR uses the independent control mode, free the upstream
      label.

      Send an LDP-ABORT downstream, go to IDLE and delete the LSP
      Control Block.

      Note: This should only occur if the LSR uses the independent
      control mode.  In the ordered control mode, no upstream label
      mapping will have been sent corresponding to this LSP while
      waiting for a label mapping from downstream.

   State:          RESPONSE_AWAITED

   Event:          LDP Withdraw

   New State:      RESPONSE_AWAITED

   Actions:

      Ignore the event.  It's a protocol error from the downstream LSR.

   State:          RESPONSE_AWAITED

   Event:          LDP Upstream Abort

   New State:      IDLE

   Actions:

      If the LSR uses the independent control mode, free the upstream
      label.

      Send an LDP-ABORT downstream.

      Delete the LSP Control Block.

   State:          RESPONSE_AWAITED

   Event:          LDP Downstream NAK

   New State:      Depends on the action routine.








<span class="grey">Boscher, et al.              Informational                     [Page 14]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-15" id="page-15" name="page-15"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Actions:

      1. If the LSP is triggered by the local router (Trigger Control
         Block Pointer is not zero), send event `Internal LSP DOWN' to
         the Trigger control block, go to IDLE and delete the LSP
         Control Block.

      2. Else If the LSR uses the independent control mode, send an LDP-
         WITHDRAW upstream and go to state `RELEASE_AWAITED'.

      If the LSR uses the ordered control mode, send an LDP-NAK
      upstream, go to IDLE and delete the LSP Control Block.

   State:          RESPONSE_AWAITED

   Event:          Upstream Lost

   New State:      IDLE

   Actions:

      If the LSR uses the independent control mode, free the upstream
      label.

      Send an LDP-ABORT downstream, go to IDLE and delete the LSP
      Control Block.

   State:          RESPONSE_AWAITED

   Event:          Downstream Lost

   New State:      Depends on the action routine.

   Actions:

      1. If the LSP is triggered by the local router (Trigger Control
         Block Pointer is not zero), send event `Internal LSP DOWN' to
         the trigger control block, go to IDLE and delete the LSP
         Control Block.

      2. Else, If the LSR uses the independent control mode, free the
         upstream label and send an LDP-WITHDRAW upstream and go to
         state `RELEASE_AWAITED'.

      If the LSR uses the ordered control mode, send an LDP-NAK upstream
      (with a status `No Route' [<a href="#ref-4" title='"LDP Specification"'>4</a>]), go to IDLE and delete the LSP
      Control Block.




<span class="grey">Boscher, et al.              Informational                     [Page 15]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-16" id="page-16" name="page-16"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   State:          RESPONSE_AWAITED

   Event:          Internal SetUp

   New State:      RESPONSE_AWAITED

   Actions:

      Ignore, it is an internal implementation error.

   State:          RESPONSE_AWAITED

   Event:          Internal Destroy

   New State:      IDLE

   Actions:

      Send an LDP-ABORT downstream, go to IDLE and delete the LSP
      Control Block.

   State:          RESPONSE_AWAITED

   Event:          Internal Cross-Connect

   New State:      RESPONSE_AWAITED

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          RESPONSE_AWAITED

   Event:          Internal New NH

   New State:      RESPONSE_AWAITED

   Actions:

      Send LDP-ABORT to the old downstream, and send LDP-REQUEST to the
      new next hop.

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.2.5.3%20State%20--%20%22ESTABLISHED%22"></a><a class="selflink" href="#section-2.2.5.3" name="section-2.2.5.3">2.2.5.3</a> State -- "ESTABLISHED"</span>

   State:          ESTABLISHED

   Event:          LDP Request




<span class="grey">Boscher, et al.              Informational                     [Page 16]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-17" id="page-17" name="page-17"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   New State:      ESTABLISHED

   Actions:

      Ignore the event.  It's an internal implementation error.  For non
      VC-merge ATM LSR, a new LSP control block is always created for
      each LDP request.

   State:          ESTABLISHED

   Event:          LDP Mapping

   New State:      ESTABLISHED

   Actions:

      Process the LDP-MAPPING, that may contain the new attributes of
      the label mapping and then propagate the LDP-MAPPING upstream.

   State:          ESTABLISHED

   Event:          LDP Release

   New State:      IDLE

   Actions:

      Disconnect the upstream label from the downstream label.

      Free the upstream label.

      Free the resources.

      Send event `Internal Destroy' to the Next Hop Trigger Control
      Block if it was in the middle of switching over to the better next
      hop.

      Propagate the LDP-RELEASE downstream if the LSR is not the egress
      for the LSP, go to IDLE and delete the LSP Control Block.

   State:          ESTABLISHED

   Event:          LDP Withdraw

   New State:      Depends on the action routine.






<span class="grey">Boscher, et al.              Informational                     [Page 17]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-18" id="page-18" name="page-18"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Actions:

      1) Free the resources and send LDP-RELEASE downstream.

      2) If it is independent control mode, set the state to `IDLE',
         create a internal LDP Request with the information in the LSP
         Control Block, and pass event `LDP Request' to its own state
         machine.

      3) Else for the ordered control mode

         3.1) If the LSP is triggered to be setup by itself (e.g it is
              the ingress LSR of this LSP), send event `Internal LSP
              Down' to the trigger control block, go to IDLE and delete
              the LSP Control Block.

         3.2) Else, if it is triggered by the incoming LDP Request,
              Disconnect the upstream label from the downstream label.
              Propagate the LDP-WITHDRAW upstream and go to state
              `RELEASE_AWAITED'.

         3.3) If the LSP is in the middle of switching over to a better
              LSP, send event `Internal Destroy' to the state machine of
              its New Next Hop LSP Control Block, go to IDLE and delete
              the LSP Control Block.

   State:          ESTABLISHED

   Event:          LDP Upstream Abort

   New State:      ESTABLISHED

   Actions:

      Ignore the event.

      Note: This scenario can occur if the upstream LSR sends a LDP-
      ABORT at about the same time as the local LSR sends a LDP-MAPPING.
      In this situation, it should be up to exactly one of the two LSRs
      as to whether or not the label that was sent remains valid.  The
      LDP specification [<a href="#ref-4" title='"LDP Specification"'>4</a>] procedures leave the choice to the upstream
      LSR that must send an LDP-RELEASE if it will not use the label
      provided.

   State:          ESTABLISHED

   Event:          LDP Downstream NAK




<span class="grey">Boscher, et al.              Informational                     [Page 18]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-19" id="page-19" name="page-19"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   New State:      ESTABLISHED

   Actions:

      Ignore the event.  It is a protocol error from the downstream LSR.
      The downstream LSR should always LSP-WITHDRAW to tear down the LSP
      when the LSP is established.

   State:          ESTABLISHED

   Event:          Upstream Lost

   New State:      IDLE

   Actions:

      Disconnect the upstream label from the downstream label.

      Free the upstream label.

      Send event `Internal Destroy' to the Next Hop Trigger Control
      Block if it was in the middle of switching over to the better next
      hop.

      Free the resources.

      Propagate an LDP-RELEASE downstream, go to IDLE and delete the LSP
      Control Block.

   State:          ESTABLISHED

   Event:          Downstream Lost

   New State:      Depends on the action routine.

   Actions:

      1) If the LSP is triggered by the local router (Trigger Control
         Block Pointer is not zero), send event `Internal LSP NAK' to
         the Trigger control block, go to IDLE and delete the LSP
         Control Block.

      2) Else, disconnect the upstream label from the downstream label.
         Propagate an LDP-WITHDRAW upstream and go to `RELEASE_AWAITED'
         state.






<span class="grey">Boscher, et al.              Informational                     [Page 19]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-20" id="page-20" name="page-20"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


      3) Send event `Internal Destroy' to the Next Hop Trigger Control
         Block if it was in the middle of switching over to the better
         next hop.

   State:          ESTABLISHED

   Event:          Internal Setup

   New State:      ESTABLISHED

   Actions:

      Ignore, it is an internal implementation error.

   State:          ESTABLISHED

   Event:          Internal Destroy

   New State:      IDLE

   Actions:

      Disconnect the upstream label from the downstream label if it is
      not the ingress of the LSP.

      Free the resources.

      Send an LDP-RELEASE downstream, go to IDLE and delete the LSP
      Control Block.

   State:          ESTABLISHED

   Event:          Internal Cross-Connect

   New State:      ESTABLISHED

   Actions:

      Connect the upstream label to the downstream label

      May need to send a new LDP-MAPPING upstream with the attributes
      from the new next hop.

      Reset Trigger Control Block Pointer to zero.

   State:          ESTABLISHED

   Event:          Internal New NH



<span class="grey">Boscher, et al.              Informational                     [Page 20]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-21" id="page-21" name="page-21"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   New State:      ESTABLISHED

   Actions:

      1) If the LSR was in the middle of switching over to a better next
         hop (Next Hop Trigger Control Block Pointer is not zero), it
         send `Internal New NH' to that control block.

      2) Else, create a new Next Hop Trigger Control Block, set Next Hop
         Trigger Control Block pointer to point to this control block,
         and pass 'Internal New NH' to this control block.

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.2.5.4%20State%20--%20%22RELEASE_AWAITED%22"></a><a class="selflink" href="#section-2.2.5.4" name="section-2.2.5.4">2.2.5.4</a> State -- "RELEASE_AWAITED"</span>

   State:          RELEASE_AWAITED

   Event:          LDP Request

   New State:      RELEASE_AWAITED

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          RELEASE_AWAITED

   Event:          LDP Mapping

   New State:      RELEASE_AWAITED

   Actions:

      It is a protocol error from the downstream LDP peer, but anyway
      send a LDP-RELEASE downstream.

   State:          RELEASE_AWAITED

   Event:          LDP Release

   New State:      IDLE

   Actions:

      1) Free the upstream label

      2) Delete the control block.

   State:          RELEASE_AWAITED



<span class="grey">Boscher, et al.              Informational                     [Page 21]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-22" id="page-22" name="page-22"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Event:          LDP Withdraw

   New State:      RELEASE_AWAITED

   Actions:

      It is a protocol error from the downstream LDP peer, but send a
      LDP- RELEASE anyway.

   State:          RELEASE_AWAITED

   Event:          LDP Upstream Abort

   New State:      IDLE

   Actions:

      1) Free the upstream label

      2) Delete the control block.

   State:          RELEASE_AWAITED

   Event:          LDP Downstream NAK

   New State:      RELEASE_AWAITED

   Actions:

      Ignore the event.  Continue waiting for the LDP-RELEASE from
      upstream.

   State:          RELEASE_AWAITED

   Event:          Upstream Lost

   New State:      IDLE

   Actions:

      1) Free the upstream label

      2) Delete the control block.

   State:          RELEASE_AWAITED

   Event:          Downstream Lost




<span class="grey">Boscher, et al.              Informational                     [Page 22]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-23" id="page-23" name="page-23"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   New State:      RELEASE_AWAITED

   Actions:

      Ignore the event.  Continue waiting for the LDP-RELEASE from
      upstream.

   State:          RELEASE_AWAITED

   Event:          Internal SetUp

   New State:      RELEASE_AWAITED

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          RELEASE_AWAITED

   Event:          Internal Destroy

   New State:      RELEASE_AWAITED

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          RELEASE_AWAITED

   Event:          Internal Cross-Connect

   New State:      RELEASE_AWAITED

   Actions:

   Ignore the event.  It is an internal implementation error.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/2.2.6%20Handling%20the%20Next%20Hop%20Change"></a><a class="selflink" href="#section-2.2.6" name="section-2.2.6">2.2.6</a> Handling the Next Hop Change</span>

   When an LSR detects a better next hop, it may decides to establish a
   new LSP through this next hop.  For example, an LSR is configured as
   "local repair", or the LSR is configured as "global repair" and it is
   the ingress end of a LSP.  It can then create a Next Hop Trigger
   Control Block and use the state machine of Next Hop Trigger Control
   Block to establish a new LSP through the better next hop.






<span class="grey">Boscher, et al.              Informational                     [Page 23]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-24" id="page-24" name="page-24"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.2.6.1%20Next%20Hop%20Trigger%20Control%20Block"></a><a class="selflink" href="#section-2.2.6.1" name="section-2.2.6.1">2.2.6.1</a> Next Hop Trigger Control Block</span>

   -- State

   -- LSP Control Block Pointer, that points to the original LSP control
   block.

   -- New Next Hop LSP Control Block Pointer, that points to the LSP
   Control Block that is setting up an LSP through the new next hop.

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.2.6.2%20States"></a><a class="selflink" href="#section-2.2.6.2" name="section-2.2.6.2">2.2.6.2</a> States</span>

   -- IDLE

   This is the initial LSP state, when the Trigger_Control_Block is
   created.

   -- NEW_NH_RETRY

   This is the state where an LSR waits for a retry timer to expire and
   then tries to establish an LSP through a new next hop.

   -- NEW_NH_RESPONSE_AWAITED

   This is the state where an LSR is in the middle of establishing a new
   LSP through a new next hop.  It has triggered a LSP control block to
   send an LDP-REQUEST towards the new next hop and is waiting for the
   LDP-MAPPING.

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.2.6.3%20Events"></a><a class="selflink" href="#section-2.2.6.3" name="section-2.2.6.3">2.2.6.3</a> Events</span>

   -- Internal New NH

   The LSR detects there is a new next hop for a FEC.

   -- Internal Retry Timeout

   The LSP retry timer expires.

   -- Internal LSP UP

   The LSP to the new Next Hop is UP

   -- Internal LSP NAK

   The LSP through the new next hop could not get set up





<span class="grey">Boscher, et al.              Informational                     [Page 24]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-25" id="page-25" name="page-25"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   -- Internal Destroy

   This event is triggered when the LSR lost the LDP session with its
   upstream neighbor.

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.2.6.4%20State%20Transition%20for%20next%20hop%20change"></a><a class="selflink" href="#section-2.2.6.4" name="section-2.2.6.4">2.2.6.4</a> State Transition for next hop change</span>

                     +---------------------+
                     |                     |
                     |     IDLE            |&lt;------------+
                     |                     |             |
                     +---------------------+             |
                              |                          |
                              |                          |
                              | (Internal New NH)        |
                              |                          |
                              v                          |
                     +---------------------+             |
                     |                     |             |
                     |   NEW_NH_RETRY      |-----------&gt;-+
                     |                     | (Internal   |
                     +---------------------+  Destroy)   |
                              |                          |
                              |                          |
                              | (Internal retry timeout) |
                              |                          |
                              v                          |
                     +---------------------+             |
                     |                     | (Internal   |
                     | NEW_NH_RESPONSE     |  Destroy)   |
                     | _AWAITED            |-----------&gt;-+
                     |                     |             |
                     +---------------------+             |
                              |                          |
                              | (Internal LSP UP)        |
                              | (Internal LSP NAK)       |
                              +------------------------&gt;-+

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.2.6.5%20State%20Machine"></a><a class="selflink" href="#section-2.2.6.5" name="section-2.2.6.5">2.2.6.5</a> State Machine</span>

<span class="h6"><a class="dashAnchor" name="//apple_ref/Section/2.2.6.5.1%20State%20--%20%22IDLE%22"></a><a class="selflink" href="#section-2.2.6.5.1" name="section-2.2.6.5.1">2.2.6.5.1</a> State -- "IDLE"</span>

   State:          IDLE

   Event:          Internal New NH

   New State:      NEW_NH_RETRY




<span class="grey">Boscher, et al.              Informational                     [Page 25]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-26" id="page-26" name="page-26"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Actions:

      Start the LSP retry timer and go to the `NEW_NH_RETRY' state.

   State:          IDLE

   Event:          Internal retry timeout

   New State:      IDLE

   Actions:

      Ignore.  It is an internal implementation error.

   State:          IDLE

   Event:          Internal LSP UP

   New State:      IDLE

   Actions:

      Ignore.  It is an internal implementation error.

   State:          IDLE

   Event:          Internal LSP NAK

   New State:      IDLE

   Actions:

      Ignore.  It is an internal implementation error.

   State:          IDLE

   Event:          Internal destroy

   New State:      IDLE

   Actions:

      Ignore.  It is an internal implementation error.








<span class="grey">Boscher, et al.              Informational                     [Page 26]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-27" id="page-27" name="page-27"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h6"><a class="dashAnchor" name="//apple_ref/Section/2.2.6.5.2%20State%20--%20%22NEW_NH_RETRY%22"></a><a class="selflink" href="#section-2.2.6.5.2" name="section-2.2.6.5.2">2.2.6.5.2</a> State -- "NEW_NH_RETRY"</span>

   State:          NEW_NH_RETRY

   Event:          Internal New NH

   New State:      NEW_NH_RETRY

   Actions:

      Restart the LSP retry timer.

   State:          NEW_NH_RETRY

   Event:          Internal retry timeout

   New State:      Depends on action routine.

   Actions:

      If the new next hop is the same one as the old next hop, go to
      IDLE and delete the control block.

      Otherwise, create an LSP control block that will try to establish
      a new LSP through the new next hop, send event `Internal Setup' to
      its state machine and go to NEW_NH_RESPONSE_AWAITED.

   State:          NEW_NH_RETRY

   Event:          Internal LSP UP

   New State:      NEW_NH_RETRY

   Actions:

      Ignore.  It is an internal implementation error.

   State:          NEW_NH_RETRY

   Event:          Internal LSP NAK

   New State:      NEW_NH_RETRY

   Actions:

      Ignore.  It is an internal implementation error.

   State:          NEW_NH_RETRY



<span class="grey">Boscher, et al.              Informational                     [Page 27]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-28" id="page-28" name="page-28"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Event:          Internal destroy

   New State:      IDLE

   Actions:

      Stop the timer, go to IDLE and delete the control block.

<span class="h6"><a class="dashAnchor" name="//apple_ref/Section/2.2.6.5.3%20State%20--%20%22NEW_NH_RESPONSE_AWAITED%22"></a><a class="selflink" href="#section-2.2.6.5.3" name="section-2.2.6.5.3">2.2.6.5.3</a> State -- "NEW_NH_RESPONSE_AWAITED"</span>

   State:          NEW_NH_RESPONSE_AWAITED

   Event:          Internal New NH

   New State:      NEW_NH_RETRY

   Actions:

      Restart the LSP retry timer, send `Internal destroy' to the
      control block of the LSP for the new next hop and go to the
      `NEW_NH_RETRY' state.

   State:          NEW_NH_RESPONSE_AWAITED

   Event:          Internal retry timeout

   New State:      NEW_NH_RESPONSE_AWAITED

   Actions:

      Ignore.  It is an internal implementation error.

   State:          NEW_NH_RESPONSE_AWAITED

   Event:          Internal LSP UP

   New State:      IDLE

   Actions:

      Send event `Internal cross-connect' event to the LSP control block
      of the new next hop.

      Send event `Internal destroy' event to the original LSP control
      block.

      Then go to IDLE and delete the control block.




<span class="grey">Boscher, et al.              Informational                     [Page 28]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-29" id="page-29" name="page-29"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   State:          NEW_NH_RESPONSE_AWAITED

   Event:          Internal LSP NAK

   New State:      IDLE

   Actions:

      Delete the control block.

   State:          NEW_NH_RESPONSE_AWAITED

   Event:          Internal destroy

   New State:      IDLE

   Actions:

      Send event `Internal destroy' the control block for the new LSP
      through the new next hop.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/2.2.7%20LDP%20Related%20Message%20Handling"></a><a class="selflink" href="#section-2.2.7" name="section-2.2.7">2.2.7</a> LDP Related Message Handling</span>

   -  If an LSR receives an LDP-REQUEST from an upstream LSR:

      a) If this is a duplicate request, discard the message.  A
         duplicate request means that there is a LSP Control Block that
         has the same FEC, Upstream Label Request ID and Upstream Label
         Request ID and same Upstream LDP Session Identifier.

      b) Otherwise, create a new LSP Control Block, store the relevant
         information from the message into the control block, then pass
         the event `LDP Request' to its state machine.

   -  If an LSR receives an LDP-MAPPING from a downstream LSR:

      a) Extract the 'Label Request Message ID' field and from the LDP-
         MAPPING.

      b) Find an LSP Control Block that has the same Downstream Label
         Request ID and the same Downstream LDP Session Identifier.

      c) If an LSP Control Block is found, pass the event `LDP Mapping'
         to its state machine.

      d) If there is no matching LSP Control Block found, then try to
         find an LSP Control Block that has the same Downstream Label
         and the same Downstream LDP Session Identifier.



<span class="grey">Boscher, et al.              Informational                     [Page 29]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-30" id="page-30" name="page-30"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


      e) If an LSP Control Block is found, pass the event `LDP Mapping'
         to its state machine.

      f) Otherwise, ignore the LDP-MAPPING and send a LDP-RELEASE
         downstream.

   -  If an LSR receives an LDP-RELEASE from an upstream LSR:

      a) Find an LSP Control Block that has the same Upstream Label and
         the same Upstream LDP Session Identifier.

      b) If an LSP Control Block is found, pass the event `LDP Release'
         to its state machine.

      c) Otherwise, ignore the message.

   -  If an LSR receives an LDP-WITHDRAW from a downstream LSR:

      a) Find an LSP Control Block that has the same Downstream Label
         and the same Downstream LDP Session Identifier.

      b) If an LSP Control Block is found, pass the event `LDP Withdraw'
         to its state machine.

      c) Otherwise, ignore the LDP-WITHDRAW and send a LDP-RELEASE
         downstream.

   -  If an upstream LDP peer is lost:

      a) Find all the LSP Control Blocks whose upstream LDP peer is that
         LSR.

      b) Then pass the event `Upstream Lost' to their state machines.

   -  If a downstream LDP peer is lost:

      a) Find all the LSP Control Blocks whose downstream LDP peer is
         that LSR.

      b) Then pass the event `Downstream Lost' to their state machines.

   -  If the LSR detects a new next hop for an FEC:

      For each LSP that needs "local repair", or it needs "global
      repair" and it is the ingress of the LSP, pass event "Internal New
      NH" to its state machine.





<span class="grey">Boscher, et al.              Informational                     [Page 30]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-31" id="page-31" name="page-31"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   -  If an LSR receives an LDP-Abort from an upstream LSR:

      a) Extract the LDP Request ID value from the LDP-Abort message.

      b) Find an LSP Control Block that has the same Upstream Label
         Request ID and the same Upstream LDP Session Identifier.

      c) If an LSP Control Block is found, pass the event `LDP Upstream
         Abort' to its state machine.

      d) Otherwise, ignore the message.

   -  If the LSR receives an LDP-NAK from a downstream LSR:

      a) Extract the LDP Request ID value from the LDP-NAK.

      b) Find an LSP Control Block that has the same Downstream Label
         Request ID and the same Downstream LDP Session Identifier.

      c) If an LSP Control Block is found, pass the event `LDP
         Downstream NAK' to its state machine.

      d) Otherwise, ignore the message.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/2.3.%20ATM%20Switch%20LSR%20with%20VC-merge"></a><a class="selflink" href="#section-2.3" name="section-2.3">2.3</a>. ATM Switch LSR with VC-merge</span>

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/2.3.1%20VC-merge"></a><a class="selflink" href="#section-2.3.1" name="section-2.3.1">2.3.1</a> VC-merge</span>

   A VC-merge capable LSR can map multiple incoming labels (VPI/VCI)
   into one outgoing label.  It is possible that this LSR can only merge
   a limited number of incoming labels into a single outgoing label.  As
   described in [<a href="#ref-2" title='"Multiprotocol Label Switching Architecture"'>2</a>], suppose, for example, that due to some hardware
   limitation a node is capable of merging four incoming labels into a
   single outgoing label.  Suppose however, that this particular node
   has six incoming labels arriving at it for a particular FEC.  In this
   case, this node may merge these into two outgoing labels.

   When an upstream LSR has a limited merging capability, it is
   difficult for a downstream LSR to know how many labels should be
   assigned to each FEC.  In this case, downstream-on-demand is
   recommended.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/2.3.2%20Control%20Block"></a><a class="selflink" href="#section-2.3.2" name="section-2.3.2">2.3.2</a> Control Block</span>

   There are 3 types of control blocks involved: Upstream LSP Control
   Block, Downstream LSP Control Block, and Next Hop Trigger Control
   Block.




<span class="grey">Boscher, et al.              Informational                     [Page 31]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-32" id="page-32" name="page-32"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   There is one Upstream LSP Control Block for each LDP-REQUEST
   received.

   There is one Downstream LSP Control Block for each unique LDP-REQUEST
   sent to a downstream LSR.  There can be multiple Downstream LSP
   Control Blocks per FEC in an LSR.  This can be the result of an
   upstream LSR asking for a label for an FEC.  This LSR must assign a
   unique upstream label and it can not merge this upstream label into
   an existing downstream label for this FEC.

   There is one Next Hop Trigger Control Block for each FEC for which a
   better next hop has been detected and the LSR has decided to switch
   to this better next hop.  It could be the result of "local repair" or
   "global repair" if the LSR is the ingress LSR of the LSP.

   A Downstream LSP Control Block contains a list of pointers to
   Upstream LSP Control Blocks or the Next Hop Trigger Control Block.
   This means that this LSR has decided to map the multiple labels
   listed in the Upstream LSP Control Blocks and the Next Hop Trigger
   Control Block into a single label listed in the Downstream LSP
   Control Block.

   An Upstream LSP Control Block may contain the following information:

      -  Upstream LDP Session Identifier

      -  State

      -  Upstream Label (assigned by this LSR)

      -  Downstream LSP Control Block pointer

      -  Upstream LDP Request ID (assigned by the upstream LSR in
         downstream-on-demand mode)

      -  Next_Hop_Trigger_Block pointer

   Upstream Label and Upstream LDP Session Identifier can be used to
   locate a unique Upstream LSP Control Block.

   If an LSR is using downstream-on-demand mode, it can use the Upstream
   LDP Request ID and the Upstream LDP Session Identifier to locate a
   unique Upstream LSP Control Block.








<span class="grey">Boscher, et al.              Informational                     [Page 32]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-33" id="page-33" name="page-33"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   An Next_Hop_Trigger LSP Control Block may contain the following
   information:

      -  Upstream LSP Control Block pointer, that points to the one that
         is needed to switch over to the better next hop

      -  State

      -  Downstream LSP Control Block pointer

   A Downstream LSP Control Block may contain the following information:

      -  FEC

      -  State

      -  Downstream LDP Session Identifier

      -  list of pointers to the Upstream LSP Control Blocks or the
         Trigger_Control_Blocks that are merged at this LSR for this FEC

      -  Downstream Label (assigned by the downstream LSR)

      -  Downstream Label Request ID (assigned by the LSR itself if it
         is using downstream-on-demand mode)

   Downstream Label, Downstream LDP Session Identifier can be used to
   locate a unique Downstream LSP Control Block.

   If an LSR is using downstream-on-demand mode, it can also use the
   Downstream Label Request ID and the Downstream LDP Session Identifier
   to locate a unique Downstream LSP Control Block.

   The following diagram details the relationship between these 2 types
   of control blocks:

   For example, the LSR has decided to merge 3 LDP-REQUESTs of a FEC
   from upstream LSR1, LSR2, LSR3 into one LDP-REQUEST and sent it to a
   downstream LSR4.












<span class="grey">Boscher, et al.              Informational                     [Page 33]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-34" id="page-34" name="page-34"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   +---------------------+
   |                     |
   | Upstream_LSP_Control|
   | _Block  for Upstream|------+
   | LSR1                |      |
   +---------------------+      |
                                |
   +---------------------+      |
   |                     |      |
   | Upstream_LSP_Control|      | (merged into)
   | _Block for Upstream |------+
   |  LSR2               |      |
   +---------------------+      |    +------------------------------+
                                |    |                              |
   +---------------------+      +---&gt;| Downstream LSP Control Block |
   | Next_Hop_Trigger_   |      |    |   for Downstream LSR4        |
   | LSP Control Block   |------+    |                              |
   |                     |           +------------------------------+
   +---------------------+

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/2.3.3%20%20%20State%20Machines%20for%20Downstream-on-demand%20Mode"></a><a class="selflink" href="#section-2.3.3" name="section-2.3.3">2.3.3</a>   State Machines for Downstream-on-demand Mode</span>

   The following sections describe the state machines used in
   downstream-on-demand mode.

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.1%20State%20of%20the%20Upstream%20LSP%20Control%20Block%27s%20State%20Machine%20for"></a><a class="selflink" href="#section-2.3.3.1" name="section-2.3.3.1">2.3.3.1</a> State of the Upstream LSP Control Block's State Machine for</span>
<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/Downstream-on-demand%20Mode"></a>        Downstream-on-demand Mode</span>

   -- IDLE

   This is the initial LSP state.

   -- RESPONSE_AWAITED

   This state means that the LSR has received and processed an LDP-
   REQUEST from an upstream LSR, and has sent a new LDP-REQUEST towards
   a downstream LSR.  The LSR is waiting for the LDP-MAPPING from the
   downstream LSR.

   -- ESTABLISHED

   This state means that the LSR has received the LDP-MAPPING from the
   downstream LSR and the LSP is up and operational.

   -- RELEASE_AWAITED

   This state means that the LSR has sent a LDP-WITHDRAW upstream and is
   waiting for the LDP-RELEASE before freeing up the label resource.



<span class="grey">Boscher, et al.              Informational                     [Page 34]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-35" id="page-35" name="page-35"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.2%20Events%20of%20the%20Upstream%20LSP%20Control%20Block%27s%20State%20Machine%20for"></a><a class="selflink" href="#section-2.3.3.2" name="section-2.3.3.2">2.3.3.2</a> Events of the Upstream LSP Control Block's State Machine for</span>
<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/Downstream-on-demand%20Mode"></a>        Downstream-on-demand Mode</span>

   -- LDP Request

   The LSR receives an LDP-REQUEST from an upstream LSR.

   -- Internal Downstream Mapping

   This event is sent by one Downstream LSP Control Block's state
   machine.  This Downstream LSP Control Block is the merged Downstream
   LSP Control Block of this Upstream LSP Control Block.  The event is
   the result of receiving an LDP-MAPPING by the Downstream LSP Control
   Block's state machine.

   -- LDP Release

   The LSR receives an LDP-RELEASE from an upstream LSR.

   -- Internal Downstream Withdraw

   This event is sent by one Downstream LSP Control Block's state
   machine.  This Downstream LSP Control Block is the merged Downstream
   LSP Control Block of this Upstream LSP Control Block.  The event is
   the result of receiving an LDP-WITHDRAW by the Downstream LSP Control
   Block's state machine.

   -- LDP Upstream Abort

   The LSR receives an LDP-ABORT from an upstream LSR.

   -- Internal Downstream NAK

   This event is sent by one Downstream LSP Control Block's state
   machine.  This Downstream LSP Control Block is the merged Downstream
   LSP Control Block of this Upstream LSP Control Block.  The event is
   the result of receiving an LDP-NAK by the Downstream LSP Control
   Block's state machine, or it detects an error.

   -- Upstream Lost

   The LSR loses the LDP session with its upstream LDP peer.

   -- Internal New NH

   The LSR detects there is better next hop and decides to establish the
   lsp through this better next hop.




<span class="grey">Boscher, et al.              Informational                     [Page 35]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-36" id="page-36" name="page-36"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   -- Internal Re-Cross-Connect

   This event is used to trigger splicing into a different downstream
   LSP.  This can happens when it is switched over to a better LSP
   through the new next hop.

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.3%20State%20Transitions%20of%20the%20Upstream%20LSP%20Control%20Block%27s%20State"></a><a class="selflink" href="#section-2.3.3.3" name="section-2.3.3.3">2.3.3.3</a> State Transitions of the Upstream LSP Control Block's State</span>
<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/Machine%20for%20Downstream-on-demand%20Mode"></a>        Machine for Downstream-on-demand Mode</span>

                      +-------------------+
                      |                   |
            +--------&gt;|  IDLE             |&lt;-------------------+
            |         |                   |                    |
            |         +-------------------+                    |
            |(LDP Abort)       |                               |
            |(Internal         |(LDP Request)                  |
            | Downstream NAK)  |                               |
            |(Upstream Lost)   |               (Upstream Lost) |
            |                  v                 (LDP Release) |
            |         +-------------------+                    |
            |         |                   |                    |
            +---------|  RESPONSE_AWAITED |                    |
                      |                   |                    |
                      +-------------------+                    |
                               |                               |
                               |(Internal Downstream           |
                               |  mapping)                     |
                               |                               |
                               v                               |
                      +-------------------+                    |
                      |                   |                    |
                      |  ESTABLISHED      |-------&gt;------------+
                      |                   |                    |
                      +-------------------+                    |
                               |                               |
                               |                               |
                               |(Internal Downstream Withdraw) |
                               |(Internal Downstream NAK)      |
                               v                               |
                      +-------------------+    (LDP Upstream   |
                      |                   |     Abort)         |
                      |RELEASE_AWAITED    |-------&gt;------------+
                      |                   |
                      +-------------------+







<span class="grey">Boscher, et al.              Informational                     [Page 36]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-37" id="page-37" name="page-37"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.4%20Upstream%20LSP%20Control%20Block%27s%20State%20Machine%20for%20Downstream-on-"></a><a class="selflink" href="#section-2.3.3.4" name="section-2.3.3.4">2.3.3.4</a> Upstream LSP Control Block's State Machine for Downstream-on-</span>
<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/demand%20Mode"></a>        demand Mode</span>

<span class="h6"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.4.1%20State%20--%20%22IDLE%22"></a><a class="selflink" href="#section-2.3.3.4.1" name="section-2.3.3.4.1">2.3.3.4.1</a> State -- "IDLE"</span>

   State:          IDLE

   Event:          LDP Request

   New State:      Depends upon the action routine.

   Actions:

      If this LSR is the LSP Egress or Proxy Egress [<a href="#ref-2" title='"Multiprotocol Label Switching Architecture"'>2</a>],

      Then:
         choose an upstream label, allocate the resources, connect this
         upstream label to the local IP forwarding module, send an LDP-
         MAPPING upstream with the upstream label and go to the state
         `ESTABLISHED'.

      else
         Obtain a next hop (or interface).  Find a Downstream LSP
         Control Block that has the same FEC and the same next hop and
         also is able to merge more input labels.  If not found, create
         a new Downstream LSP Control Block with the state `IDLE'.

         If the state of the Downstream LSP Control Block is
         `ESTABLISHED', choose an upstream label, connect the upstream
         label with the downstream label and send an LDP-MAPPING
         upstream with the upstream label, and go to the state
         `ESTABLISHED'.

         If the state of Downstream LSP Control Block is not
         `ESTABLISHED', set the state of the Upstream LSP Control Block
         to `RESPONSE_AWAITED'.  If the LSR use the independent control
         mode [<a href="#ref-2" title='"Multiprotocol Label Switching Architecture"'>2</a>], choose an upstream label, and send an LDP-MAPPING
         upstream.

         Pass the event `Internal AddUpstream' to the Downstream LSP
         Control Block's state machine.

      If unable to process the request for any reason, issue an LDP-NAK
      to the sender with the appropriate error code, go to IDLE and
      delete the control block.

   State:          IDLE




<span class="grey">Boscher, et al.              Informational                     [Page 37]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-38" id="page-38" name="page-38"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Event:          Internal Downstream Mapping

   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          LDP Release

   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          Internal Downstream Withdraw

   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          LDP Upstream Abort

   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          Internal Downstream NAK

   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.




<span class="grey">Boscher, et al.              Informational                     [Page 38]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-39" id="page-39" name="page-39"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   State:          IDLE

   Event:          Upstream Lost

   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          Internal Re-Cross-Connect

   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          Internal New NH

   New State:      IDLE

   Actions:

      Ignore the event.  It is an internal implementation error.

<span class="h6"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.4.2%20State%20--%20%22RESPONSE_AWAITED%22"></a><a class="selflink" href="#section-2.3.3.4.2" name="section-2.3.3.4.2">2.3.3.4.2</a> State -- "RESPONSE_AWAITED"</span>

   State:          RESPONSE_AWAITED

   Event:          LDP Request

   New State:      RESPONSE_AWAITED

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          RESPONSE_AWAITED

   Event:          Internal Downstream Mapping

   New State:      Depends on the action routine.




<span class="grey">Boscher, et al.              Informational                     [Page 39]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-40" id="page-40" name="page-40"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Actions:

      If the LSR uses the ordered control mode, assign an upstream
      label, connect the upstream label to the downstream label and
      allocate the resources, send an LDP-MAPPING upstream with the
      upstream label and go to `ESTABLISHED'.

      If unable to process the message for any reason, issue an LDP-NAK
      upstream and an LDP-RELEASE downstream, go to IDLE and delete the
      control block.

   State:          RESPONSE_AWAITED

   Event:          LDP Release

   New State:      RESPONSE_AWAITED

   Actions

      Ignore the event.  It is a protocol error from the upstream peer.

   State:          RESPONSE_AWAITED

   Event:          Internal Downstream Withdraw

   New State:      RESPONSE_AWAITED

   Actions

      Ignore the event.  It is an internal implementation error.

   State:          RESPONSE_AWAITED

   Event:          LDP Upstream Abort

   New State:      IDLE

   Actions

      If the LSR uses the independent control mode, free the upstream
      label and the resources.

      Send the event `Internal DeleteUpstream' to its Downstream LSP
      Control Block's state machine.

      Delete the control block.

   State:          RESPONSE_AWAITED



<span class="grey">Boscher, et al.              Informational                     [Page 40]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-41" id="page-41" name="page-41"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Event:          Internal Downstream NAK

   New State:      IDLE

   Actions:

      If the LSR uses the independent control mode, free the upstream
      label and the resources.  Then, send an LDP-WITHDRAW upstream.

      If the LSR uses the ordered control mode, propagate the LDP-NAK
      upstream.

      Delete the control block.

   State:          RESPONSE_AWAITED

   Event:          Upstream Lost

   New State:      IDLE

   Actions

      If the LSR uses the independent control mode, free the upstream
      label and the resources.

      Send the event `Internal DeleteUpstream' to its Downstream LSP
      Control Block's state machine.

      Delete the control block.

   State:          RESPONSE_AWAITED

   Event:          Internal Re-Cross-Connect

   New State:      RESPONSE_AWAITED

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          RESPONSE_AWAITED

   Event:          Internal New NH

   New State:      depends on the actions






<span class="grey">Boscher, et al.              Informational                     [Page 41]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-42" id="page-42" name="page-42"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Actions:

      Send event `Internal DeleteUpstream' to its old downstream control
      block.

      Find a Downstream LSP Control Block that has the same FEC and the
      same next hop and also is able to merge more input labels.  If not
      found, create a new Downstream LSP Control Block with the state
      `IDLE'.

      If the state of the Downstream LSP Control Block is `ESTABLISHED',
      choose an upstream label, connect the upstream label with the
      downstream label and send an LDP-MAPPING upstream with the
      upstream label, and go to the state `ESTABLISHED'.

      If the state of Downstream LSP Control Block is not `ESTABLISHED',
      set the state of the Upstream LSP Control Block to
      `RESPONSE_AWAITED'.

      Pass the event `Internal AddUpstream' to the new Downstream LSP
      Control Block's state machine.

<span class="h6"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.4.3%20State%20--%20%22ESTABLISHED%22"></a><a class="selflink" href="#section-2.3.3.4.3" name="section-2.3.3.4.3">2.3.3.4.3</a> State -- "ESTABLISHED"</span>

   State:          ESTABLISHED

   Event:          LDP Request

   New State:      ESTABLISHED

   Actions

      Ignore the event.  It is an internal implementation error.

   State:          ESTABLISHED

   Event:          Internal Downstream Mapping

   New State:      ESTABLISHED

   Actions

      Process the new attributes of the mapping and then propagate the
      LDP-MAPPING upstream.

   State:          ESTABLISHED

   Event:          LDP Release



<span class="grey">Boscher, et al.              Informational                     [Page 42]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-43" id="page-43" name="page-43"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   New State:      IDLE

   Actions

      Disconnect the upstream label from the downstream label, free the
      upstream label and resources.

      Send the event `Internal DeleteUpstream' to its Downstream LSP
      Control Block's state machine.

      Send the event `Internal Destroy' to the Next_Hop_Trigger_Block's
      state machine if the LSR was in the middle of switching over to
      the better next hop.

      Delete the control block.

   State:          ESTABLISHED

   Event:          Internal Downstream Withdraw

   New State:      Depends on the action routine.

   Actions

      If it uses independent mode, set its state to `IDLE' and create a
      internal `LDP Request' and send to its own state machine.

      Else
         Disconnect the upstream label from the downstream label.

         Propagate the LDP-WITHDRAW upstream and go to state
         `RELEASE_AWAITED'.

      Send the event `Internal Destroy' to the Next_Hop_Trigger_Block's
      state machine if the LSR was in the middle of switching over to
      the better next hop.

   State:          ESTABLISHED

   Event:          LDP Upstream Abort

   New State:      ESTABLISHED

   Actions

      Ignore the event.





<span class="grey">Boscher, et al.              Informational                     [Page 43]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-44" id="page-44" name="page-44"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


      Note: This scenario can occur if the upstream LSR sends a LDP-
      ABORT at about the same time as the local LSR sends a LDP-MAPPING.
      In this situation, it should be up to exactly one of the two LSRs
      as to whether or not the label that was sent remains valid.  The
      LDP specification [<a href="#ref-4" title='"LDP Specification"'>4</a>] procedures leave the choice to the upstream
      LSR that must send an LDP-RELEASE if it will not use the label
      provided.

   State:          ESTABLISHED

   Event:          Internal Downstream NAK

   New State:      Depends on the action routine.

   Actions:

      If it uses independent mode, set its state to `IDLE' and create a
      internal `LDP Request' and send to its own state machine.

      Else
         Disconnect the upstream label from the downstream label

         Send an LDP-WITHDRAW upstream and go to state
         `RELEASE_AWAITED'.

      Send the event `Internal Destroy' to the Next_Hop_Trigger_Block's
      state machine if the LSR was in the middle of switching over to
      the better next hop.

   State:          ESTABLISHED

   Event:          Upstream Lost

   New State:      IDLE

   Actions:

      Disconnect the upstream label from the downstream label, free the
      upstream label and the resources.

      Send the event `Internal DeleteUpstream' to its Downstream LSP
      Control Block's state machine.

      Send the event `Internal Destroy' to the Next_Hop_Trigger_Block's
      state machine if the LSR was in the middle of switching over to
      the better next hop.

      Delete the control block.



<span class="grey">Boscher, et al.              Informational                     [Page 44]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-45" id="page-45" name="page-45"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   State:          ESTABLISH

   Event:          Internal Re-Cross-Connect

   New State:      ESTABLISH

   Actions:

      Reconnect the upstream label to the new downstream label.

      Send the event `Internal DeleteUpstream' to its old Downstream LSP
      Control Block's state machine.

   State:          ESTABLISH

   Event:          Internal New NH

   New State:      ESTABLISH

   Actions:

      Create a new Next_Hop_Trigger_Control_Block and pass event
      `Internal New NH' to its state machine.

<span class="h6"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.4.4%20State%20--%20%22RELEASE_AWAITED%22"></a><a class="selflink" href="#section-2.3.3.4.4" name="section-2.3.3.4.4">2.3.3.4.4</a> State -- "RELEASE_AWAITED"</span>

   State:          RELEASE_AWAITED

   Event:          LDP Request

   New State:      RELEASE_AWAITED

   Actions:

      Ignore the event.  It is a protocol error from the upstream LSR.

   State:          RELEASE_AWAITED

   Event:          Internal Downstream Mapping

   New State:      RELEASE_AWAITED

   Actions:

      Ignore the event.  It is an internal implementation error.

   State:          RELEASE_AWAITED




<span class="grey">Boscher, et al.              Informational                     [Page 45]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-46" id="page-46" name="page-46"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Event:          LDP Release

   New State:      IDLE

   Actions:

      Free the upstream label resource and delete the control block.

   State:          RELEASE_AWAITED

   Event:          Internal Downstream Withdraw

   New State:      RELEASE_AWAITED

   Actions:

      Ignore the event.  It is a protocol error from the downstream LSR.

   State:          RELEASE_AWAITED

   Event:          LDP Upstream Abort

   New State:      IDLE

   Actions:

      Free the upstream label resource and delete the control block.

   State:          RELEASE_AWAITED

   Event:          Internal Downstream NAK

   New State:      RELEASE_AWAITED

   Actions:

      Ignore the event.  And continue waiting for the LDP-RELEASE.

   State:          RELEASE_AWAITED

   Event:          Upstream Lost

   New State:      IDLE

   Actions:

      Free the upstream label resource and delete the control block.




<span class="grey">Boscher, et al.              Informational                     [Page 46]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-47" id="page-47" name="page-47"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   State:          RELEASE_AWAITED

   Event:          Internal New NH

   New State:      RELEASE_AWAITED

   Actions:

      Ignore the event.  And continue waiting for the LDP-RELEASE.

   State:          RELEASE_AWAITED

   Event:          Internal Re-Cross-Connect

   New State:      RELEASE_AWAITED

   Actions:

      Ignore the event.  It is an internal implementation error.

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.5%20State%20of%20the%20Downstream%20LSP%20Control%20Block%27s%20State%20Machine%20for"></a><a class="selflink" href="#section-2.3.3.5" name="section-2.3.3.5">2.3.3.5</a> State of the Downstream LSP Control Block's State Machine for</span>
<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/Downstream-on-demand%20Mode"></a>        Downstream-on-demand Mode</span>

   -- IDLE

   This is the initial LSP state.

   -- RESPONSE_AWAITED

   This state means that the LSR has received an LDP-REQUEST from an
   upstream LSR, has processed the LDP-REQUEST, and has sent a new LDP-
   REQUEST towards a downstream LSR.  The LSR is waiting for the LDP-
   MAPPING from the downstream LSR.

   -- ESTABLISHED

   This state means that the LSR has received the LDP-MAPPING from the
   downstream LSR and the LSP is up and operational.

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.6%20Events%20of%20the%20Downstream%20LSP%20Control%20Block%27s%20State%20Machine%20for"></a><a class="selflink" href="#section-2.3.3.6" name="section-2.3.3.6">2.3.3.6</a> Events of the Downstream LSP Control Block's State Machine for</span>
<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/Downstream-on-demand%20Mode"></a>        Downstream-on-demand Mode</span>

   -- Internal AddUpstream

   This event is sent by an Upstream LSP Control Block's state machine
   when it is created.





<span class="grey">Boscher, et al.              Informational                     [Page 47]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-48" id="page-48" name="page-48"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   -- Internal DeleteUpstream

   This event is sent by an Upstream LSP Control Block's state machine
   when it is deleted.

   -- LDP Mapping

   The LSR receives an LDP-MAPPING from a downstream LSR.

   -- LDP Withdraw

   The LSR receives an LDP-WITHDRAW from a downstream LSR.

   -- LDP Downstream NAK

   The LSR receives an LDP-NAK from a downstream LSR.

   -- Downstream Lost

   The LSR loses the LDP session with its downstream LSR.

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.7%20State%20Transitions%20of%20the%20Downstream%20LSP%20Control%20Block%27s%20State"></a><a class="selflink" href="#section-2.3.3.7" name="section-2.3.3.7">2.3.3.7</a> State Transitions of the Downstream LSP Control Block's State</span>
<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/Machine%20for%20Downstream-on-demand%20mode"></a>        Machine for Downstream-on-demand mode</span>

               +-------------------+
               |                   |
               |  IDLE             |&lt;--------------+
               |                   |               |(last Internal
               +-------------------+               | DeleteUpstream)
                        |                          |(LDP Withdraw)
                        |(1st Internal AddUpstream)|
                        |                          |(LDP Downstream
                        v                          | NAK)
               +-------------------+               |(Downstream
               |                   |               |   Lost)
               |  RESPONSE_AWAITED |----------&gt;----+
               |                   |               |
               +-------------------+               |
                        |                          |
                        |(LDP Mapping)             |
                        |                          |
                        v                          |
               +-------------------+               |
               |                   |               |
               |  ESTABLISHED      |--------&gt;------+
               |                   |
               +-------------------+




<span class="grey">Boscher, et al.              Informational                     [Page 48]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-49" id="page-49" name="page-49"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.8%20Downstream%20LSP%20Control%20Block%27s%20State%20Machine%20for%20Downstream-on-"></a><a class="selflink" href="#section-2.3.3.8" name="section-2.3.3.8">2.3.3.8</a> Downstream LSP Control Block's State Machine for Downstream-on-</span>
<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/demand%20Mode."></a>        demand Mode.</span>

<span class="h6"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.8.1%20State%20--%20%22IDLE%22"></a><a class="selflink" href="#section-2.3.3.8.1" name="section-2.3.3.8.1">2.3.3.8.1</a> State -- "IDLE"</span>

   State:          IDLE

   Event:          Internal AddUpstream

   New State:      RESPONSE_AWAITED

   Actions

      Initialize the list of pointers in the Upstream LSP Control Block
      to contain the newly added upstream pointer.

      Send a new LDP-REQUEST downstream and go to the state
      `RESPONSE_AWAITED'.

   State:          IDLE

   Event:          Internal DeleteUpstream

   New State:      IDLE

   Actions

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          LDP Mapping

   New State:      IDLE

   Actions

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          LDP Withdraw

   New State:      IDLE

   Actions

      Ignore the event.  It is an internal implementation error.



<span class="grey">Boscher, et al.              Informational                     [Page 49]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-50" id="page-50" name="page-50"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   State:          IDLE

   Event:          LDP Downstream NAK

   New State:      IDLE

   Actions

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          Downstream Lost

   New State:      IDLE

   Actions

      Ignore the event.  It is an internal implementation error.

<span class="h6"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.8.2%20State%20--%20%22RESPONSE_AWAITED%22"></a><a class="selflink" href="#section-2.3.3.8.2" name="section-2.3.3.8.2">2.3.3.8.2</a> State -- "RESPONSE_AWAITED"</span>

   State:          RESPONSE_AWAITED

   Event:          Internal AddUpstream

   New State:      RESPONSE_AWAITED

   Actions

      Add the pointer to new Upstream LSP Control Block to the Upstream
      LSP Control Blocks pointer list.

   State:          RESPONSE_AWAITED

   Event:          Internal DeleteUpstream

   New State:      Depend on the action routine

   Actions

      Delete the Upstream LSP Control Block pointer from the Upstream
      LSP Control Block pointers list.

      If the list becomes empty, release the resources, send an LDP-
      Abort downstream, go to IDLE and then delete the control block.

   State:          RESPONSE_AWAITED



<span class="grey">Boscher, et al.              Informational                     [Page 50]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-51" id="page-51" name="page-51"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Event:          LDP Mapping

   New State:      ESTABLISHED

   Actions

      For each Upstream LSP Control Block in the Upstream LSP Control
      Block pointers list, pass the event `Internal Downstream Mapping'
      to its state machine.

   State:          RESPONSE_AWAITED

   Event:          LDP Withdraw

   New State:      RESPONSE_AWAITED

   Actions

      It is a protocol error from the downstream LDP peer; send a LDP-
      RELEASE downstream

   State:          RESPONSE_AWAITED

   Event:          LDP Downstream NAK

   New State:      IDLE

   Actions

      For each Upstream LSP Control Block in the Upstream LSP Control
      Block pointers list, pass the event `Internal Downstream NAK' to
      its state machine.

      Release the resources, and delete the control block.

   State:          RESPONSE_AWAITED

   Event:          Downstream Lost

   New State:      IDLE

   Actions

      For each Upstream LSP Control Block in the Upstream LSP Control
      Block pointers list, pass the event `Internal Downstream NAK' to
      its state machine.

      Release the resources, and delete the control block.



<span class="grey">Boscher, et al.              Informational                     [Page 51]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-52" id="page-52" name="page-52"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h6"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.8.3%20State%20--%20%22ESTABLISHED%22"></a><a class="selflink" href="#section-2.3.3.8.3" name="section-2.3.3.8.3">2.3.3.8.3</a> State -- "ESTABLISHED"</span>

   State:          ESTABLISHED

   Event:          Internal AddUpstream

   New State:      ESTABLISHED

   Actions

      Add the pointer to new Upstream LSP Control Block to the Upstream
      LSP Control Block pointers list.

   State:          ESTABLISHED

   Event:          Internal DeleteUpstream

   New State:      Depends on the action routine.

   Actions

      Delete the pointer of Upstream LSP Control Block from its Upstream
      LSP Control Block pointers list.

      If the list becomes empty, release the resources, send an LDP-
      RELEASE downstream, go to IDLE and then delete the control block.

      Otherwise, remain in the ESTABLISHED state.

   State:          ESTABLISHED

   Event:          LDP Mapping

   New State:      ESTABLISHED

   Actions

      For each Upstream LSP Control Block in the Upstream LSP Control
      Block pointers list, pass the event `Internal Downstream mapping'
      to its state machine.

   State:          ESTABLISHED

   Event:          LDP Withdraw

   New State:      IDLE





<span class="grey">Boscher, et al.              Informational                     [Page 52]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-53" id="page-53" name="page-53"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Actions

      For each Upstream LSP Control Block in the Upstream LSP Control
      Block pointers list, pass the event `Internal Downstream withdraw'
      to its state machine.

      Release the resources, and delete the control block and send LDP-
      RELEASE downstream.

   State:          ESTABLISHED

   Event:          LDP Downstream NAK

   New State:      ESTABLISHED

   Actions

      It is a protocol error from the downstream LDP peer.

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.9%20State%20of%20the%20Next_Hop_Trigger_Control_Block%27s%20State%20Machine%20for"></a><a class="selflink" href="#section-2.3.3.9" name="section-2.3.3.9">2.3.3.9</a> State of the Next_Hop_Trigger_Control_Block's State Machine for</span>
<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/Downstream-on-demand%20Mode"></a>        Downstream-on-demand Mode</span>

   -- IDLE

   This is the initial LSP state.

   -- NEW_NH_RETRY

   This is the state where an LSR waits for a retry timer to expire and
   then tries to establish an LSP through a new next hop.

   -- NEW_NH_RESPONSE_AWAITED

   This state means that the LSR has sent a new LDP-REQUEST towards a
   downstream LSR.  The LSR is waiting for the LDP-MAPPING from the
   downstream LSR.

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.10%20Events%20of%20the%20Next_Hop_Trigger_Control_Block%27s%20State%20Machine"></a><a class="selflink" href="#section-2.3.3.10" name="section-2.3.3.10">2.3.3.10</a> Events of the Next_Hop_Trigger_Control_Block's State Machine</span>
<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/for%20Downstream-on-demand%20Mode"></a>         for Downstream-on-demand Mode</span>

   -- Internal New NH

   Trigger to setup an LSP through a better next hop.








<span class="grey">Boscher, et al.              Informational                     [Page 53]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-54" id="page-54" name="page-54"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   -- Internal Downstream Mapping

   This event is sent by one Downstream LSP Control Block's state
   machine.  This Downstream LSP Control Block is the merged Downstream
   LSP Control Block of this Upstream LSP Control Block.  The event is
   the result of receiving an LDP-MAPPING by the Downstream LSP Control
   Block's state machine.

   -- Internal Downstream NAK

   This event is sent by one Downstream LSP Control Block's state
   machine.  This Downstream LSP Control Block is the merged Downstream
   LSP Control Block of this Upstream LSP Control Block.  The event is
   the result of receiving an LDP-NAK by the Downstream LSP Control
   Block's state machine, or it detects an error.

   -- Internal Destroy This event is used to stop the procedure of
   switching over to the better next hop.

































<span class="grey">Boscher, et al.              Informational                     [Page 54]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-55" id="page-55" name="page-55"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.11%20State%20Transitions%20of%20the%20Next_Hop_Trigger_Control_Block%27s%20State"></a><a class="selflink" href="#section-2.3.3.11" name="section-2.3.3.11">2.3.3.11</a> State Transitions of the Next_Hop_Trigger_Control_Block's State</span>
<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/Machine%20for%20Downstream-on-demand%20Mode"></a>         Machine for Downstream-on-demand Mode</span>

                     +---------------------+
                     |                     |
                     |     IDLE            |&lt;------------+
                     |                     |             |
                     +---------------------+             |
                              |                          |
                              |                          |
                              | (Internal New NH)        |
                              |                          |
                              v                          |
                     +---------------------+             |
                     |                     |             |
                     |   NEW_NH_RETRY      |-----------&gt;-+
                     |                     | (Internal   |
                     +---------------------+  Destroy)   |
                              |                          |
                              |                          |
                              | (Internal retry timeout) |
                              |                          |
                              v                          |
                     +---------------------+             |
                     |                     | (Internal   |
                     | NEW_NH_RESPONSE     |  Destroy)   |
                     | _AWAITED            |-----------&gt;-+
                     |                     |             |
                     +---------------------+             |
                              |                          |
                              | (Internal Downstream     |
                              |   Mapping                |
                              | (Internal Downstream     |
                              |    NAK)                  |
                              +------------------------&gt;-+

<span class="h5"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.12%20State%20Machine"></a><a class="selflink" href="#section-2.3.3.12" name="section-2.3.3.12">2.3.3.12</a> State Machine</span>

<span class="h6"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.12.1%20State%20--%20%22IDLE%22"></a><a class="selflink" href="#section-2.3.3.12.1" name="section-2.3.3.12.1">2.3.3.12.1</a> State -- "IDLE"</span>

   State:          IDLE

   Event:          Internal New NH

   New State:      NEW_NH_RETRY






<span class="grey">Boscher, et al.              Informational                     [Page 55]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-56" id="page-56" name="page-56"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Actions:

      Start the LSP retry timer and go to the `NEW_NH_RETRY' state.

   State:          IDLE

   Event:          Internal retry timeout

   New State:      IDLE

   Actions:

      Ignore.  It is an internal implementation error.

   State:          IDLE

   Event:          Internal Downstream Mapping

   New State:      IDLE

   Actions:

      Ignore.  It is an internal implementation error.

   State:          IDLE

   Event:          Internal Downstream NAK

   New State:      IDLE

   Actions:

      Ignore.  It is an internal implementation error.

   State:          IDLE

   Event:          Internal destroy

   New State:      IDLE

   Actions:

      Ignore.  It is an internal implementation error.








<span class="grey">Boscher, et al.              Informational                     [Page 56]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-57" id="page-57" name="page-57"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h6"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.12.2%20State%20--%20%22NEW_NH_RETRY%22"></a><a class="selflink" href="#section-2.3.3.12.2" name="section-2.3.3.12.2">2.3.3.12.2</a> State -- "NEW_NH_RETRY"</span>

   State:          NEW_NH_RETRY

   Event:          Internal New NH

   New State:      NEW_NH_RETRY

   Actions:

      Restart the LSP retry timer.

   State:          NEW_NH_RETRY

   Event:          Internal retry timeout

   New State:      Depends on the action routine.

   Actions:

      If the new next hop is the same one as the old next hop, go to
      IDLE and delete the control block.

      Otherwise, go to NEW_NH_RESPONSE_AWAITED, find a downstream LSP
      control block that goes through the same next hop for the same
      FEC, if there are none, create one, and pass 'Internal
      AddUpstream' event to its state machine.

   State:          NEW_NH_RETRY

   Event:          Internal Downstream Mapping

   New State:      NEW_NH_RETRY

   Actions:

      Ignore.  It is an internal implementation error.

   State:          NEW_NH_RETRY

   Event:          Internal Downstream NAK

   New State:      NEW_NH_RETRY

   Actions:

      Ignore.  It is an internal implementation error.




<span class="grey">Boscher, et al.              Informational                     [Page 57]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-58" id="page-58" name="page-58"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   State:          NEW_NH_RETRY

   Event:          Internal destroy

   New State:      IDLE

   Actions:

      Stop the timer and delete the control block.

<span class="h6"><a class="dashAnchor" name="//apple_ref/Section/2.3.3.12.3%20State%20--%20%22NEW_NH_RESPONSE_AWAITED%22"></a><a class="selflink" href="#section-2.3.3.12.3" name="section-2.3.3.12.3">2.3.3.12.3</a> State -- "NEW_NH_RESPONSE_AWAITED"</span>

   State:          NEW_NH_RESPONSE_AWAITED

   Event:          Internal New NH

   New State:      NEW_NH_RETRY

   Actions:

      Restart the LSP retry timer and send event `Internal destroy' to
      the control block of the LSP for the new next hop.

   State:          NEW_NH_RESPONSE_AWAITED

   Event:          Internal retry timeout

   New State:      NEW_NH_RESPONSE_AWAITED

   Actions:

      Ignore.  It is an internal implementation error.

   State:          NEW_NH_RESPONSE_AWAITED

   Event:          Internal Downstream Mapping

   New State:      IDLE

   Actions:

      Send event `Internal Re-cross-connect' event to the upstream LSP
      control block of the new next hop.

      Send event `DeleteUpstream' event to the downstream LSP control
      block of the the new next hop, since the upstream has spliced into
      the new next hop.




<span class="grey">Boscher, et al.              Informational                     [Page 58]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-59" id="page-59" name="page-59"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


      Delete the control block.

   State:          NEW_NH_RESPONSE_AWAITED

   Event:          Internal Downstream NAK

   New State:      IDLE

   Actions:

      Delete the control block.

   State:          NEW_NH_RESPONSE_AWAITED

   Event:          Internal destroy

   New State:      IDLE

   Actions:

      Send event `Internal DeleteUpstream' the control block for the new
      LSP through the new next hop.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/2.3.4%20LDP%20Related%20Message%20Processing"></a><a class="selflink" href="#section-2.3.4" name="section-2.3.4">2.3.4</a> LDP Related Message Processing</span>

   -  If an LSR receives an LDP-REQUEST:

      a) If this is a duplicate request, discard the message.  A
         duplicate request means that there is a LSP Control Block that
         has the same FEC, Upstream Label Request ID and Upstream LDP
         Session Identifier.

      b) Otherwise, create a new Upstream LSP Control Block.  Then pass
         the event `LDP Request' to this Upstream LSP Control Block's
         state machine.

   -  If an LSR receives an LDP-MAPPING:

      Locate a Downstream LSP Control Block that has the same FEC, the
      same Downstream LDP Session Identifier and the same Downstream
      Label.  If a Downstream LSP Control Block is found, pass the event
      `LDP Mapping' to its state table.  This could mean that the
      attributes of label binding have changed.

      Otherwise, use the Downstream LDP request ID (the 'Label Request
      Message ID' field in the LDP-MAPPING) and Downstream LDP Session
      Identifier to locate the Downstream LSP Control Block and pass the




<span class="grey">Boscher, et al.              Informational                     [Page 59]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-60" id="page-60" name="page-60"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


      event `LDP Mapping' to its state machine.  If no Downstream LSP
      Control Block is found, ignore the message.

   -  If an LSR receives an LDP-RELEASE:

      Locate an Upstream LSP Control Block that has the same FEC, the
      same Upstream Label, the same Upstream LDP Session Identifier.  If
      no Upstream LSP Control Block is found, ignore the message.  If an
      Upstream LSP Control Block is found, send the event `LDP Release'
      to its state machine.

   -  If an LSR receives an LDP-WITHDRAW:

      Find a Downstream LSP Control Block that has the same FEC, the
      same Downstream LDP Session Identifier and the same Downstream
      Label.  Pass the event `LDP Withdraw' to its state machines.

   -  If an Upstream LDP peer is lost:

      Pass the event `Upstream Lost' to the state machines of all the
      Upstream LSP Control Blocks whose upstream LDP peer is that LSR.

   -  If a Downstream LDP peer is lost:

      Pass the event `Downstream Lost' to the state machines of all the
      Downstream LSP Control Blocks whose downstream LDP peer is that
      LSR.

   -  If a next hop of an FEC is changed:

      For all the Upstream LSP Control Blocks that are affected by this
      change, pass the event `Internal New NH' to their state machines.

   -  If an LSR receives an LDP-ABORT from an upstream LSR:

      Use the Upstream LDP Request ID and Upstream LDP Session
      Identifier to locate the Upstream LSP Control Block and pass the
      event `LDP Abort' to its state machine.

   -  If an LSR receives an LDP-NAK from a downstream LSR:

      Use the Downstream LDP Request ID and Downstream Session
      Identifier to locate a Downstream_LSP_control_block and pass the
      event `LDP Downstream NAK' to its state machine.







<span class="grey">Boscher, et al.              Informational                     [Page 60]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-61" id="page-61" name="page-61"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/3.%20State%20Machine%20for%20Downstream%20Unsolicited"></a><a class="selflink" href="#section-3" name="section-3">3</a>. State Machine for Downstream Unsolicited</span>

   The following sections describe the state machines for the ATM-LSR
   that uses downstream unsolicited mode.

   While both independent LSP control and ordered LSP control modes are
   possible, only the ordered mode is taken into account, because the
   independent LSP control mode uses the liberal label retention mode
   and so is considered burning too many ATM resources.

   In downstream unsolicited mode, multiple path is not supported in
   this version and will be For Further Study (FFS).  We suspect with
   multiple next hops and Downstream mode, it is easy to get into a loop
   condition.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.1%20Control%20Block"></a><a class="selflink" href="#section-3.1" name="section-3.1">3.1</a> Control Block</span>

   There are 2 types of control blocks involved: Upstream LSP Control
   Block, Downstream LSP Control Block.

   There is a list of Upstream LSP Control Blocks for each FEC in the
   routing table, with each one corresponding to a LDP peer.  A Upstream
   LSP Control Block is created for each FEC when there is a label ready
   to be distributed to that upstream.  It is deleted when the FEC is
   deleted from the FEC table, or the LDP peer disappears, or the
   downstream label is withdrawn.

   There is one Downstream LSP Control Blocks for each FEC in the
   routing table.  It is created when the FEC is inserted into the
   forwarding table and deleted when the FEC is removed from the
   forwarding table.

   An Upstream LSP Control Block may contain the following information:

      -  Upstream LDP Session Identifier

      -  State

      -  Upstream Label (assigned by this LSR)

      -  FEC

   Upstream Label and Upstream LDP Session Identifier, or FEC and
   Upstream LDP Session Identifier can be used to locate a unique
   Upstream LSP Control Block.






<span class="grey">Boscher, et al.              Informational                     [Page 61]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-62" id="page-62" name="page-62"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   A Downstream LSP Control Block may contain the following information:

      -  FEC

      -  State

      -  Downstream LDP Session Identifier

      -  Downstream Label (assigned by the downstream LSR)

      -  Downstream Label Request ID (assigned by the LSR itself)

   Downstream Label and Downstream LDP Session Identifier, or FEC and
   Downstream LDP Session Identifier can be used to locate a unique
   Downstream LSP Control Block.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.2%20States%20of%20the%20Upstream%20LSP%20Control%20Block%27s%20State%20Machine%20for"></a><a class="selflink" href="#section-3.2" name="section-3.2">3.2</a> States of the Upstream LSP Control Block's State Machine for</span>
<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/Downstream%20Mode"></a>    Downstream Mode</span>

   -- IDLE

   This is the initial LSP state.

   -- ESTABLISHED

   This state means that the LSR has received the LDP-MAPPING from the
   downstream LSR and the LSP is up and operational.

   -- RELEASE_AWAITED

   This state means that the LSR is waiting for the LDP-RELEASE in
   respond to the LDP-WITHDRAW sent by this LSR.

   -- RESOURCES_AWAITED

   This state means that the LSR is waiting for the label resources.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.3%20Events%20of%20the%20Upstream%20LSP%20Control%20Block%27s%20State%20Machine%20for"></a><a class="selflink" href="#section-3.3" name="section-3.3">3.3</a> Events of the Upstream LSP Control Block's State Machine for</span>
<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/Downstream%20Mode"></a>    Downstream Mode</span>

   -- Internal Downstream Mapping

   This event is sent by one Downstream LSP Control Block's state
   machine.  The event is the result of receiving an LDP-MAPPING by the
   Downstream LSP Control Block's state machine.  Or when the LDP peer
   is discovered and there is a downstream Label available for this FEC.





<span class="grey">Boscher, et al.              Informational                     [Page 62]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-63" id="page-63" name="page-63"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   -- LDP Release

   The LSR receives an LDP-RELEASE from an upstream LSR.

   -- Internal Withdraw

   This event is sent by Downstream LSP Control Block's state machine.
   The event is the result of receiving an LDP-WITHDRAW by the
   Downstream LSP Control Block's state machine.

   -- Resource Available

   This event means the local resource (such as label) becomes
   available.

   -- Delete FEC

   This event means that the FEC is removed from the forwarding table.

   -- Upstream Lost

   This event means that the upstream LDP peer is lost.





























<span class="grey">Boscher, et al.              Informational                     [Page 63]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-64" id="page-64" name="page-64"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.4%20State%20Transitions%20of%20Upstream%20LSP%20Control%20Block%27s%20State%20Machine%20for"></a><a class="selflink" href="#section-3.4" name="section-3.4">3.4</a> State Transitions of Upstream LSP Control Block's State Machine for</span>
<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/Downstream%20Mode"></a>    Downstream Mode</span>

                            |
                            |(created when
                            |a label is to be distributed
                            | to the LDP peer)
                            v
                  +-------------------+
                  |                   |
                  |  IDLE             |&lt;--------------+
                  |                   |               |
                  +-------------------+               |
                           |                          |(LDP Release)
                           |                          |
                           |                          |
                           |                          |
                           |(Internal Downstream      |
       +-------------------|  Mapping)                |
       |                   |                          |
       |(no label resource)v                          |
       |          +-------------------+               |
       |          |                   |               |
       |    +-----|  ESTABLISHED      |---------------+
       |    |     |                   |               ^
       |    |     +-------------------+               |
       |    |(delete FEC)   ^                         |
       |    |(Internal      |(Resource Available)     | (LDP Release)
       |    |  Withdraw)    |                         | (Internal
       |    |               |                         |  Downstream
       |    |               |                         |    Withdraw)
       |    |     +-------------------+               |
       +---------&gt;|                   |               |
            |     |RESOURCES_AWAITED  |---------------+
            |     |                   |               |
            |     +-------------------+               |
            |                                         |
            | (Internal Downstream Withdraw)          |(LDP Release)
            |     +-------------------+               |
            |     |                   |               |
            +----&gt;|  RELEASE_AWAITED  |---------------+
                  |                   |
                  +-------------------+








<span class="grey">Boscher, et al.              Informational                     [Page 64]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-65" id="page-65" name="page-65"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.5%20Upstream%20LSP%20Control%20Block%27s%20State%20Machine%20for%20Downstream%20Mode"></a><a class="selflink" href="#section-3.5" name="section-3.5">3.5</a> Upstream LSP Control Block's State Machine for Downstream Mode</span>

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.5.1%20%3A%20State%20--%20%22IDLE%22"></a><a class="selflink" href="#section-3.5.1" name="section-3.5.1">3.5.1</a> : State -- "IDLE"</span>

   State:          IDLE

   Event:          Internal Downstream mapping

   New State:      Depends on the action routine.

   Actions

      Choose an upstream label, connect the upstream label with the
      downstream label, propagate the LDP-MAPPING upstream and go to
      state `ESTABLISHED'

      If there is no resource for the upstream label, go to state
      `RESOURCE_AWAITED'.

   State:          IDLE

   Event:          LDP Release

   New State:      IDLE

   Actions

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          Internal Downstream Withdraw

   New State:      IDLE

   Actions

      Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          Resource Available

   New State:      IDLE

   Actions

      Ignore the event.  It is an internal implementation error.



<span class="grey">Boscher, et al.              Informational                     [Page 65]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-66" id="page-66" name="page-66"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   State:          IDLE

   Event:          Delete FEC

   New State:      IDLE

   Actions

      Delete the control block.

   State:          IDLE

   Event:          Upstream Lost

   New State:      IDLE

   Actions

      Delete the control block.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.5.2%20%3A%20State%20--%20%22ESTABLISHED%22"></a><a class="selflink" href="#section-3.5.2" name="section-3.5.2">3.5.2</a> : State -- "ESTABLISHED"</span>

   State:          ESTABLISHED

   Event:          Internal Downstream Mapping

   New State:      ESTABLISHED

   Actions

      Process the new attributes of the new mapping message.

      Propagate the LDP-MAPPING upstream.

   State:          ESTABLISHED

   Event:          LDP Release

   New State:      IDLE

   Actions

      Disconnect upstream label from downstream label.

      Release the upstream label resource

      Delete the control block.




<span class="grey">Boscher, et al.              Informational                     [Page 66]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-67" id="page-67" name="page-67"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   State:          ESTABLISHED

   Event:          Internal Downstream Withdraw

   New State:      RELEASE_AWAITED

   Actions

      Disconnect upstream label from downstream label.

      Propagate the LDP-WITHDRAW upstream.

   State:          ESTABLISHED

   Event:          Resource Available

   New State:      ESTABLISHED

   Actions

      Ignore the event.  It is an internal implementation error.

   State:          ESTABLISHED

   Event:          Delete FEC

   New State:      RELEASE_AWAITED

   Actions

      Send a LDP-WITHDRAW upstream.

   State:          ESTABLISHED

   Event:          Upstream Lost

   New State:      IDLE

   Actions

      Release the upstream label and delete the control block.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.5.3%20%3A%20State%20--%20%22RELEASE_AWAITED%22"></a><a class="selflink" href="#section-3.5.3" name="section-3.5.3">3.5.3</a> : State -- "RELEASE_AWAITED"</span>

   State:          RELEASE_AWAITED

   Event:          Internal Downstream Mapping




<span class="grey">Boscher, et al.              Informational                     [Page 67]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-68" id="page-68" name="page-68"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   New State:      RELEASE_AWAITED

   Actions

      Ignore the message.

   State:          RELEASE_AWAITED

   Event:          LDP Release

   New State:      IDLE

   Actions

      Release the upstream label and delete the control block.

   State:          RELEASE_AWAITED

   Event:          Internal Downstream Withdraw

   New State:      RELEASE_AWAITED

   Actions

      Ignore the event.

   State:          RELEASE_AWAITED

   Event:          Resource Available

   New State:      RELEASE_AWAITED

   Actions

      Ignore the event.  It is an internal implementation error.

   State:          RELEASE_AWAITED

   Event:          Delete FEC

   New State:      RELEASE_AWAITED

   Actions

      Do nothing.

   State:          RELEASE_AWAITED




<span class="grey">Boscher, et al.              Informational                     [Page 68]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-69" id="page-69" name="page-69"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Event:          Upstream Lost

   New State:      IDLE

   Actions

      Release the upstream label and delete the control block.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.5.4%20%3A%20State%20--%20%22RESOURCE_AWAITED%22"></a><a class="selflink" href="#section-3.5.4" name="section-3.5.4">3.5.4</a> : State -- "RESOURCE_AWAITED"</span>

   State:          RESOURCE_AWAITED

   Event:          Internal Downstream Mapping

   New State:      RESOURCE_AWAITED

   Actions

      Ignore the message.

   State:          RESOURCE_AWAITED

   Event:          LDP Release

   New State:      RESOURCE_AWAITED

   Actions

      Ignore the message.  It is an internal implementation error.

   State:          RESOURCE_AWAITED

   Event:          Internal Downstream Withdraw

   New State:      IDLE

   Actions

      Delete the control block.

   State:          RESOURCE_AWAITED

   Event:          Resource Available

   New State:      ESTABLISHED






<span class="grey">Boscher, et al.              Informational                     [Page 69]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-70" id="page-70" name="page-70"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Actions

      Allocate an upstream label, connect the upstream label with the
      downstream label, and send LDP-MAPPING upstream.

   State:          RESOURCE_AWAITED

   Event:          Delete FEC

   New State:      IDLE

   Actions

      Delete the control block.

   State:          RESOURCE_AWAITED

   Event:          Upstream Lost

   New State:      IDLE

   Actions

      Delete the control block.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.6%20State%20of%20the%20Downstream%20LSP%20Control%20Block%27s%20State%20Machine%20for"></a><a class="selflink" href="#section-3.6" name="section-3.6">3.6</a> State of the Downstream LSP Control Block's State Machine for</span>
<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/Downstream%20Mode"></a>    Downstream Mode</span>

   -- IDLE

   This is the initial LSP state.


   -- ESTABLISHED

   This state means that the LSR has received the LDP-MAPPING from the
   downstream LSR.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.7%20Events%20of%20the%20Downstream%20LSP%20Control%20Block%27s%20State%20Machine%20for"></a><a class="selflink" href="#section-3.7" name="section-3.7">3.7</a> Events of the Downstream LSP Control Block's State Machine for</span>
<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/Downstream%20Mode"></a>    Downstream Mode</span>

   -- LDP Mapping

   The LSR receives an LDP-MAPPING from a downstream LSR.

   -- LDP Withdraw

   The LSR receives an LDP-WITHDRAW from a downstream LSR.



<span class="grey">Boscher, et al.              Informational                     [Page 70]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-71" id="page-71" name="page-71"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   -- Delete FEC

   The FEC is deleted from the forwarding table.

   -- Next Hop Change

   The next hop for this FEC is change to different LSR.

   -- Downstream Lost

   The downstream peer is gone.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.8%20State%20Transitions%20of%20Downstream%20LSP%20Control%20Block%27s%20State%20Machine"></a><a class="selflink" href="#section-3.8" name="section-3.8">3.8</a> State Transitions of Downstream LSP Control Block's State Machine</span>
<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/for%20Downstream%20Mode"></a>    for Downstream Mode</span>

                  |
                  |(FEC is being added into the forwarding table)
                  v
         +-------------------+
         |                   |
         |  IDLE             |&lt;--------------+
         |                   |               |
         +-------------------+               |
                  |                          |
                  |                          |(LDP Withdraw)
                  |                          |(Internal New NH)
                  |                          |(Downstream Lost)
                  |  (LDP Mapping)           |
                  |                          |
                  v                          |
         +-------------------+               |
         |                   |               |
         |  ESTABLISHED      |---------------+
         |                   |
         +-------------------+
                  |
                  |(FEC is deleted from the forwarding table)
                  v

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.9%20Downstream%20LSP%20Control%20Block%27s%20State%20Machine%20for%20Downstream%20Mode"></a><a class="selflink" href="#section-3.9" name="section-3.9">3.9</a> Downstream LSP Control Block's State Machine for Downstream Mode</span>

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.9.1%20%3A%20State%20--%20%22IDLE%22"></a><a class="selflink" href="#section-3.9.1" name="section-3.9.1">3.9.1</a> : State -- "IDLE"</span>

   State:          IDLE

   Event:          LDP mapping

   New State:      ESTABLISHED



<span class="grey">Boscher, et al.              Informational                     [Page 71]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-72" id="page-72" name="page-72"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   Actions

      For all the LDP peers except the downstream LSR that assigned the
      label, create an Upstream LSP Control Block, and pass the event
      `Internal Downstream Mapping' to each of the Upstream LSP Control
      Block's state machines.

   State:          IDLE

   Event:          LDP withdraw

   New State:      IDLE

   Actions

         Ignore the event.  It is an internal implementation error.

   State:          IDLE

   Event:          Delete FEC

   New State:      IDLE

   Actions

      Delete the control block.

   State:          IDLE

   Event:          Next Hop Change

   New State:      IDLE

   Actions

      Ignore the event.

   State:          IDLE

   Event:          Downstream Lost

   New State:      IDLE

   Actions

      Ignore the event.





<span class="grey">Boscher, et al.              Informational                     [Page 72]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-73" id="page-73" name="page-73"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/3.9.2%20%3A%20State%20--%20%22ESTABLISHED%22"></a><a class="selflink" href="#section-3.9.2" name="section-3.9.2">3.9.2</a> : State -- "ESTABLISHED"</span>

   State:          ESTABLISHED

   Event:          LDP mapping

   New State:      ESTABLISHED

   Actions

      For each Upstream_LSP_control_block of this FEC, pass event
      `Internal downstream mapping' to its state machine.

   State:          ESTABLISHED

   Event:          LDP withdraw

   New State:      IDLE

   Actions

      For each Upstream_LSP_control_block for this FEC, pass event
      `Internal downstream Withdraw' to its state machine.

      Send a LDP Withdraw downstream.

   State:          ESTABLISHED

   Event:          Delete FEC

   New State:      IDLE

   Actions

      Send LDP-RELEASE downstream and delete the control block.

   State:          ESTABLISHED

   Event:          Next Hop Change

   New State:      IDLE

   Actions

      For each Upstream_LSP_control_block for this FEC, pass event
      `Internal downstream Withdraw' to its state machine.

      Send LDP-REQUEST to the new next hop.



<span class="grey">Boscher, et al.              Informational                     [Page 73]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-74" id="page-74" name="page-74"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   State:          ESTABLISHED

   Event:          Downstream Lost

   New State:      IDLE

   Actions

      Send LDP-WITHDRAW to all Upstream_Control_Block's state machine of
      this FEC.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.10%20LDP%20Related%20Message%20Processing%20for%20downstream%20mode."></a><a class="selflink" href="#section-3.10" name="section-3.10">3.10</a> LDP Related Message Processing for downstream mode.</span>

   -  If an LSR receives an LDP-REQUEST:

      If there is a next hop for this FEC and there is a
      Downstream_Control_Block for this FEC whose state is
      `ESTABLISHED', create a new Upstream_Control_Block and pass
      `internal Mapping' event to its state machine.

   -  If an LSR receives an LDP-MAPPING:

      Locate a Downstream LSP Control Block that has the same FEC, the
      same Downstream LDP Session Identifier and the same Downstream
      Label.  If a Downstream LSP Control Block is found, pass the event
      `LDP Mapping' to its state table.  This could mean that the
      attributes of label binding have changed.

      Otherwise, if there is no matching Downstream LSP Control Block
      found, find a Downstream LSP Control Block of this FEC and its
      next hop is the this downstream peer, pass the event `LDP Mapping'
      to its state machine.

   -  If an LSR receives an LDP-RELEASE:

      Locate an Upstream LSP Control Block that has the same FEC, the
      same Upstream Label, the same Upstream LDP Session Identifier.  If
      no Upstream LSP Control Block is found, ignore the message.  If an
      Upstream LSP Control Block is found, send the event `LDP Release'
      to its state machine.

   -  If an LSR receives an LDP-WITHDRAW:

      Find a Downstream LSP Control Block that has the same FEC, the
      same Downstream LDP Session Identifier and the same Downstream
      Label.  Pass the event `LDP Withdraw' to its state machines.





<span class="grey">Boscher, et al.              Informational                     [Page 74]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-75" id="page-75" name="page-75"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   -  If an Upstream LDP peer is lost:

      Pass the event `Upstream Lost' to the state machines of all the
      Upstream LSP Control Blocks whose upstream LDP peer is that LSR.

   -  If a Downstream LDP peer is lost:

      Pass the event `Label Withdraw' to the state machines of all the
      Downstream LSP Control Blocks whose the downstream LDP peer is
      that LSR.

   -  If a next hop of an FEC is changed:

      Find all the Downstream LSP Control Blocks that has the same FEC
      and the same next hop and pass the event `Next Hop Change' to
      their state machine

   -  If there is a FEC being added to the forwarding table

      Create a new Downstream LSP Control Block with state `IDLE'

   -  If the FEC is deleted from the forwarding table

      Send the `Delete FEC' event to the its control block.

   -  If an LSR receives an LDP-NAK from an  upstream LSR:

      Ignore the message.  An LDP-NAK should never appear in the
      downstream-mode LSR

   -  If an LSR receives an LDP-NAK from a downstream LSR:

      Ignore the message.  It is a protocol error from the downstream
      LSR.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/4.%20Security%20Considerations"></a><a class="selflink" href="#section-4" name="section-4">4</a>. Security Considerations</span>

   This document is provided as an informational extension of the LDP
   specification [<a href="#ref-4" title='"LDP Specification"'>4</a>].  State machines presented here are intended to
   clarify procedures defined in the LDP specification, but do not
   supplant or override definitions and procedures provided there.

   Implementations of a state machine may be vulnerable to spurious
   events generated by an external source.  In this document, events
   fall in two categories: internal events and external events caused by
   receipt of an LDP message.





<span class="grey">Boscher, et al.              Informational                     [Page 75]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-76" id="page-76" name="page-76"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


   LDP messages may be protected using mechanisms described in the LDP
   specification.  See "Security Considerations" in the LDP
   specification [<a href="#ref-4" title='"LDP Specification"'>4</a>].

   Security considerations relating to generation of spurious internal
   events are not addressed in this document.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/5.%20Acknowledgements"></a><a class="selflink" href="#section-5" name="section-5">5</a>. Acknowledgements</span>

   The authors would like to acknowledge the helpful comments and
   suggestions of the following people: Bob Thomas, Myunghee Son and
   Adrian Farrel.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/6.%20References"></a><a class="selflink" href="#section-6" name="section-6">6</a>. References</span>

   [<a id="ref-1" name="ref-1">1</a>] Davie, B., Lawrence, J., McCloghrie, K., Rosen, E., Swallow, G.,
       Rekhter, Y. and P. Doolan, "MPLS Using LDP and ATM Switching",
       <a href="rfc3035.html">RFC 3035</a>, January 2001.

   [<a id="ref-2" name="ref-2">2</a>] Rosen, E., Viswanathan, A. and R. Callon, "Multiprotocol Label
       Switching Architecture", <a href="rfc3031.html">RFC 3031</a>, January 2001.

   [<a id="ref-3" name="ref-3">3</a>] Cucchiara, J., Sjostrand, H. and J. Lucianai, "Definition of
       Managed Objects for the Multiprotocol Label Switching, Label
       Distribution Protocol (LDP)", Work in Progress.

   [<a id="ref-4" name="ref-4">4</a>] Andersson, L., Doolan, P., Feldman, F., Fredette, A. and B.
       Thomas, "LDP Specification", <a href="rfc3036.html">RFC 3036</a>, January 2001.

   [<a id="ref-5" name="ref-5">5</a>] Jamoussi, B., Ed., O., Andersson, L., Callon, R., Dantu, R., Wu,
       L., Doolan, P., Worster, T., Feldman, N., Fredette, A., Girish,
       M., Gray, E., Heinanen, J., Kilty, T. and A. Malis, "Constraint-
       Based LSP Set up Using LDP", <a href="rfc3212.html">RFC 3212</a>, January 2002.


















<span class="grey">Boscher, et al.              Informational                     [Page 76]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-77" id="page-77" name="page-77"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/7.%20Authors%27%20Address"></a><a class="selflink" href="#section-7" name="section-7">7</a>. Authors' Address</span>

   Christophe Boscher
   Alcatel
   Le Mail
   44700 Orvault
   France

   Phone: (33) 251781828
   EMail: christophe.boscher@alcatel.fr

   Pierrick Cheval
   Alcatel
   5 rue Noel-Pons
   92734 Nanterre Cedex
   France

   Phone: (33) 146524027
   EMail: pierrick.cheval@space.alcatel.fr

   Liwen Wu
   Cisco Systems, Inc.
   3550 Cisco Way
   San Jose, CA 95134
   U.S.A

   Phone: 408-853-4065
   EMail: liwwu@cisco.com

   Eric Gray
   Sandburst Corporation
   600 Federal Drive
   Andover, MA 01810

   Phone: (978) 689-1610
   EMail: eric.gray@sandburst.com















<span class="grey">Boscher, et al.              Informational                     [Page 77]</span>
</pre><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-78" id="page-78" name="page-78"> </a>
<span class="grey"><a href="rfc3215.html">RFC 3215</a>                   LDP State Machine                January 2002</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/8.%20Full%20Copyright%20Statement"></a><a class="selflink" href="#section-8" name="section-8">8</a>. Full Copyright Statement</span>

   Copyright (C) The Internet Society (2002).  All Rights Reserved.

   This document and translations of it may be copied and furnished to
   others, and derivative works that comment on or otherwise explain it
   or assist in its implementation may be prepared, copied, published
   and distributed, in whole or in part, without restriction of any
   kind, provided that the above copyright notice and this paragraph are
   included on all such copies and derivative works.  However, this
   document itself may not be modified in any way, such as by removing
   the copyright notice or references to the Internet Society or other
   Internet organizations, except as needed for the purpose of
   developing Internet standards in which case the procedures for
   copyrights defined in the Internet Standards process must be
   followed, or as required to translate it into languages other than
   English.

   The limited permissions granted above are perpetual and will not be
   revoked by the Internet Society or its successors or assigns.

   This document and the information contained herein is provided on an
   "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
   BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
   HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.

Acknowledgement

   Funding for the RFC Editor function is currently provided by the
   Internet Society.



















Boscher, et al.              Informational                     [Page 78]

</pre><br/>
<span class="noprint"><small><small>Html markup produced by rfcmarkup 1.111, available from
<a href="https://tools.ietf.org/tools/rfcmarkup/">https://tools.ietf.org/tools/rfcmarkup/</a>
</small></small></span>



</body><!-- Mirrored from tools.ietf.org/html/rfc3215 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 28 Apr 2015 16:02:18 GMT --></html>