<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><!-- Mirrored from tools.ietf.org/html/rfc4459 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Mar 2018 23:18:41 GMT --><!-- Added by HTTrack --><head><meta content="text/html;charset=utf-8" http-equiv="content-type"/><!-- /Added by HTTrack -->

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <meta content="index,follow" name="robots"/>
    <meta content="rfcmarkup version 1.126" name="creator"/>
    <link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/>
<meta content="urn:ietf:rfc:4459" name="DC.Identifier"/>
<meta content="Tunneling techniques such as IP-in-IP when deployed in the middle of
the network, typically between routers, have certain issues regarding
how large packets can be handled: whether such packets would be
fragmented and reassembled (and how), whether Path MTU Discovery would
be used, or how this scenario could be operationally avoided. This
memo justifies why this is a common, non-trivial problem, and goes on
to describe the different solutions and their characteristics at some
length. This memo provides information for the Internet community." name="DC.Description.Abstract"/>
<meta content="Pekka Savola &lt;psavola@funet.fi&gt;" name="DC.Creator"/>
<meta content="April, 2006" name="DC.Date.Issued"/>
<meta content="MTU and Fragmentation Issues with In-the-Network Tunneling" name="DC.Title"/>

    <link href="https://tools.ietf.org/images/rfc.png" rel="icon" type="image/png"/>
    <link href="https://tools.ietf.org/images/rfc.png" rel="shortcut icon" type="image/png"/>
    <title>RFC 4459 - MTU and Fragmentation Issues with In-the-Network Tunneling</title>
    
    
    <style type="text/css">
	@media only screen 
	  and (min-width: 992px)
	  and (max-width: 1199px) {
	    body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 768px)
	  and (max-width: 991px) {
            body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 480px)
	  and (max-width: 767px) {
            body { font-size: 11pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (max-width: 479px) {
            body { font-size: 8pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-device-width : 375px) 
	  and (max-device-width : 667px) {
            body { font-size: 9.5pt; }
            div.content { width: 96ex; margin: 0 1px; }
        }
	@media only screen 
	  and (min-device-width: 1200px) {
            body { font-size: 10pt; margin: 0 4em; }
            div.content { width: 96ex; margin: 0; }
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        a.selflink {
          color: black;
          text-decoration: none;
        }
        @media print {
            body {
                font-family: monospace;
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 1em;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>                   <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>                     <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>             <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>              <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td>      <td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td>         <td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard (old designation):</td> <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Internet Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>                  <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>                  <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
  <div class="content">
   <div style="height: 13px;">
      <div class="pre noprint docinfo bgorange" onclick="showElem('legend');" onmouseout="hideElem('legend')" onmouseover="this.style.cursor='pointer';" style="height: 6px; position: absolute;" title="Click for colour legend.">                                                                        </div>
      <div class="docinfo noprint pre legend" id="legend" onmouseout="hideElem('legend');" onmouseover="showElem('legend');" style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; ">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="index.html" title="Document search and retrieval page">Docs</a>] [<a href="https://tools.ietf.org/rfc/rfc4459.txt" title="Plaintext version of this document">txt</a>|<a href="https://tools.ietf.org/pdf/rfc4459" title="PDF version of this document">pdf</a>] [<a href="https://tools.ietf.org/html/draft-savola-mtufrag-network-tunneling" title="draft-savola-mtufrag-network-tunneling">draft-savola-mt...</a>] [<a href="https://datatracker.ietf.org/doc/rfc4459" title="IESG Datatracker information for this document">Tracker</a>] [<a href="https://tools.ietf.org/rfcdiff?difftype=--hwdiff&amp;url2=rfc4459" title="Inline diff (wdiff)">Diff1</a>] [<a href="https://tools.ietf.org/rfcdiff?url2=rfc4459" title="Side-by-side diff">Diff2</a>]         </span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<span class="pre noprint docinfo">                                                           INFORMATIONAL</span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<pre>Network Working Group                                          P. Savola
Request for Comments: 4459                                     CSC/FUNET
Category: Informational                                       April 2006


       <span class="h1">MTU and Fragmentation Issues with In-the-Network Tunneling</span>

Status of This Memo

   This memo provides information for the Internet community.  It does
   not specify an Internet standard of any kind.  Distribution of this
   memo is unlimited.

Copyright Notice

   Copyright (C) The Internet Society (2006).

Abstract

   Tunneling techniques such as IP-in-IP when deployed in the middle of
   the network, typically between routers, have certain issues regarding
   how large packets can be handled: whether such packets would be
   fragmented and reassembled (and how), whether Path MTU Discovery
   would be used, or how this scenario could be operationally avoided.
   This memo justifies why this is a common, non-trivial problem, and
   goes on to describe the different solutions and their characteristics
   at some length.

Table of Contents

   <a href="#section-1">1</a>. Introduction ....................................................<a href="#page-2">2</a>
   <a href="#section-2">2</a>. Problem Statement ...............................................<a href="#page-3">3</a>
   <a href="#section-3">3</a>. Description of Solutions ........................................<a href="#page-4">4</a>
      <a href="#section-3.1">3.1</a>. Fragmentation and Reassembly by the Tunnel Endpoints .......<a href="#page-4">4</a>
      <a href="#section-3.2">3.2</a>. Signalling the Lower MTU to the Sources ....................<a href="#page-5">5</a>
      <a href="#section-3.3">3.3</a>. Encapsulate Only When There is Free MTU ....................<a href="#page-6">6</a>
      <a href="#section-3.4">3.4</a>. Fragmentation of the Inner Packet ..........................<a href="#page-8">8</a>
   <a href="#section-4">4</a>. Conclusions .....................................................<a href="#page-9">9</a>
   <a href="#section-5">5</a>. Security Considerations ........................................<a href="#page-10">10</a>
   <a href="#section-6">6</a>. Acknowledgements ...............................................<a href="#page-11">11</a>
   <a href="#section-7">7</a>. References .....................................................<a href="#page-11">11</a>
      <a href="#section-7.1">7.1</a>. Normative References ......................................<a href="#page-11">11</a>
      <a href="#section-7.2">7.2</a>. Informative References ....................................<a href="#page-12">12</a>








<span class="grey">Savola                       Informational                      [Page 1]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-2" id="page-2" name="page-2"> </a>
<span class="grey"><a href="rfc4459.html">RFC 4459</a>         Packet Size Issues in Network Tunnels        April 2006</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/1.%20%20Introduction"></a><a class="selflink" href="#section-1" name="section-1">1</a>.  Introduction</span>

   A large number of ways to encapsulate datagrams in other packets,
   i.e., tunneling mechanisms, have been specified over the years: for
   example, IP-in-IP (e.g., [<a href="#ref-1" title='"IP Encapsulation within IP"'>1</a>] [<a href="#ref-2" title='"Basic Transition Mechanisms for IPv6 Hosts and Routers"'>2</a>], [<a href="#ref-3" title='"Generic Packet Tunneling in IPv6 Specification"'>3</a>]), Generic Routing Encapsulation
   (GRE) [<a href="#ref-4" title='"Generic Routing Encapsulation (GRE)"'>4</a>], Layer 2 Tunneling Protocol (L2TP) [<a href="#ref-5" title='"Layer Two Tunneling Protocol - Version 3 (L2TPv3)"'>5</a>], or IP Security
   (IPsec) [<a href="#ref-6" title='"Security Architecture for the Internet Protocol"'>6</a>] in tunnel mode -- any of which might run on top of IPv4,
   IPv6, or some other protocol and carrying the same or a different
   protocol.

   All of these can be run so that the endpoints of the inner protocol
   are co-located with the endpoints of the outer protocol; in a typical
   scenario, this would correspond to "host-to-host" tunneling.  It is
   also possible to have one set of endpoints co-located, i.e.,
   host-to-router or router-to-host tunneling.  Finally, many of these
   mechanisms are also employed between the routers for all or a part of
   the traffic that passes between them, resulting in router-to-router
   tunneling.

   All these protocols and scenarios have one issue in common: how does
   the source select the maximum packet size so that the packets will
   fit, even encapsulated, in the smallest Maximum Transmission Unit
   (MTU) of the traversed path in the network; and if you cannot affect
   the packet sizes, what do you do to be able to encapsulate them in
   any case?  The four main solutions are as follows (these will be
   elaborated in <a href="#section-3">Section 3</a>):

   1.  Fragmenting all too big encapsulated packets to fit in the paths,
       and reassembling them at the tunnel endpoints.

   2.  Signal to all the sources whose traffic must be encapsulated, and
       is larger than fits, to send smaller packets, e.g., using Path
       MTU Discovery (PMTUD)[<a href="#ref-7" title='"Path MTU discovery"'>7</a>][8].

   3.  Ensure that in the specific environment, the encapsulated packets
       will fit in all the paths in the network, e.g., by using MTU
       bigger than 1500 in the backbone used for encapsulation.

   4.  Fragmenting the original too big packets so that their fragments
       will fit, even encapsulated, in the paths, and reassembling them
       at the destination nodes.  Note that this approach is only
       available for IPv4 under certain assumptions (see <a href="#section-3.4">Section 3.4</a>).

   It is also common to run multiple layers of encapsulation, for
   example, GRE or L2TP over IPsec; with nested tunnels in the network,
   the tunnel endpoints can be the same or different, and both the inner
   and outer tunnels may have different MTU handling strategies.  In




<span class="grey">Savola                       Informational                      [Page 2]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-3" id="page-3" name="page-3"> </a>
<span class="grey"><a href="rfc4459.html">RFC 4459</a>         Packet Size Issues in Network Tunnels        April 2006</span>


   particular, signalling may be a scalable option for the outer tunnel
   or tunnels if the number of innermost tunnel endpoints is limited.

   The tunneling packet size issues are relatively straightforward in
   host-to-host tunneling or host-to-router tunneling where Path MTU
   Discovery only needs to signal to one source node.  The issues are
   significantly more difficult in router-to-router and certain
   router-to-host scenarios, which are the focus of this memo.

   It is worth noting that most of this discussion applies to a more
   generic case, where there exists a link with a lower MTU in the path.
   A concrete and widely deployed example of this is the usage of PPP
   over Ethernet (PPPoE) [<a href="#ref-11" title='"A Method for Transmitting PPP Over Ethernet (PPPoE)"'>11</a>] at the customers' access link.  These
   lower-MTU links, and particularly PPPoE links, are typically not
   deployed in topologies where fragmentation and reassembly might be
   unfeasible (e.g., a backbone), so this may be a slightly easier
   problem.  However, this more generic case is considered out of scope
   of this memo.

   There are also known challenges in specifying and implementing a
   mechanism that would be used at the tunnel endpoint to obtain the
   best suitable packet size to use for encapsulation: if a static value
   is chosen, a lot of fragmentation might end up being performed.  On
   the other hand, if PMTUD is used, the implementation would need to
   update the discovered interface MTU based on the ICMP Packet Too Big
   messages and originate ICMP Packet Too Big message(s) back to the
   source(s) of the encapsulated packets; this also assumes that
   sufficient data has been piggybacked on the ICMP messages (beyond the
   required 64 bits after the IPv4 header).  We'll discuss using PMTUD
   to signal the sources briefly in <a href="#section-3.2">Section 3.2</a>, but in-depth
   specification and analysis are described elsewhere (e.g., in [<a href="#ref-4" title='"Generic Routing Encapsulation (GRE)"'>4</a>] and
   [<a href="#ref-2" title='"Basic Transition Mechanisms for IPv6 Hosts and Routers"'>2</a>]) and are out of scope of this memo.

   <a href="#section-2">Section 2</a> includes a problem statement, <a href="#section-3">section 3</a> describes the
   different solutions with their drawbacks and advantages, and <a href="#section-4">section</a>
   <a href="#section-4">4</a> presents conclusions.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/2.%20%20Problem%20Statement"></a><a class="selflink" href="#section-2" name="section-2">2</a>.  Problem Statement</span>

   It is worth considering why exactly this is considered a problem.

   It is possible to fix all the packet size issues using solution 1,
   fragmenting the resulting encapsulated packet, and reassembling it by
   the tunnel endpoint.  However, this is considered problematic for at
   least three reasons, as described in <a href="#section-3.1">Section 3.1</a>.

   Therefore, it is desirable to avoid fragmentation and reassembly if
   possible.  On the other hand, the other solutions may not be



<span class="grey">Savola                       Informational                      [Page 3]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-4" id="page-4" name="page-4"> </a>
<span class="grey"><a href="rfc4459.html">RFC 4459</a>         Packet Size Issues in Network Tunnels        April 2006</span>


   practical either: especially in router-to-router or router-to-host
   tunneling, Path MTU Discovery might be very disadvantageous --
   consider the case where a backbone router would send ICMP Packet Too
   Big messages to every source that would try to send packets through
   it.  Fragmenting before encapsulation is also not available in IPv6,
   and not available when the Don't Fragment (DF) bit has been set (see
   <a href="#section-3.4">Section 3.4</a> for more).  Ensuring a high enough MTU so encapsulation
   is always possible is of course a valid approach, but requires
   careful operational planning, and may not be a feasible assumption
   for implementors.

   This yields that there is no trivial solution to this problem, and it
   needs to be further explored to consider the trade offs, as is done
   in this memo.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/3.%20%20Description%20of%20Solutions"></a><a class="selflink" href="#section-3" name="section-3">3</a>.  Description of Solutions</span>

   This section describes the potential solutions in a bit more detail.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.1.%20%20Fragmentation%20and%20Reassembly%20by%20the%20Tunnel%20Endpoints"></a><a class="selflink" href="#section-3.1" name="section-3.1">3.1</a>.  Fragmentation and Reassembly by the Tunnel Endpoints</span>

   The seemingly simplest solution to tunneling packet size issues is
   fragmentation of the outer packet by the encapsulator and reassembly
   by the decapsulator.  However, this is highly problematic for at
   least three reasons:

   o  Fragmentation causes overhead: every fragment requires the IP
      header (20 or 40 bytes), and with IPv6, an additional 8 bytes for
      the Fragment Header.

   o  Fragmentation and reassembly require computation: splitting
      datagrams to fragments is a non-trivial procedure, and so is their
      reassembly.  For example, software router forwarding
      implementations may not be able to perform these operations at
      line rate.

   o  At the time of reassembly, all the information (i.e., all the
      fragments) is normally not available; when the first fragment
      arrives to be reassembled, a buffer of the maximum possible size
      may have to be allocated because the total length of the
      reassembled datagram is not known at that time.  Furthermore, as
      fragments might get lost, or be reordered or delayed, the
      reassembly engine has to wait with the partial packet for some
      time (e.g., 60 seconds [<a href="#ref-9" title='"Requirements for Internet Hosts - Communication Layers"'>9</a>]).  When this would have to be done at
      the line rate, with, for example 10 Gbit/s speed, the length of
      the buffers that reassembly might require would be prohibitive.





<span class="grey">Savola                       Informational                      [Page 4]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-5" id="page-5" name="page-5"> </a>
<span class="grey"><a href="rfc4459.html">RFC 4459</a>         Packet Size Issues in Network Tunnels        April 2006</span>


   When examining router-to-router tunneling, the third problem is
   likely the worst; certainly, a hardware computation and
   implementation requirement would also be significant, but not all
   that difficult in the end -- and the link capacity wasted in the
   backbones by additional overhead might not be a huge problem either.

   However, IPv4 identification header length is only 16 bits (compared
   to 32 bits in IPv6), and if a larger number of packets are being
   tunneled between two IP addresses, the ID is very likely to wrap and
   cause data misassociation.  This reassembly wrongly combining data
   from two unrelated packets causes data integrity and potentially a
   confidentiality violation.  This problem is further described in
   [<a href="#ref-12" title='"Fragmentation Considered Very Harmful"'>12</a>].

   IPv6, and IPv4 with the DF bit set in the encapsulating header,
   allows the tunnel endpoints to optimize the tunnel MTU and minimize
   network-based reassembly.  This also prevents fragmentation of the
   encapsulated packets on the tunnel path.  If the IPv4 encapsulating
   header does not have the DF bit set, the tunnel endpoints will have
   to perform a significant amount of fragmentation and reassembly,
   while the use of PMTUD is minimized.

   As <a href="#appendix-A">Appendix A</a> describes, the MTU of the tunnel is also a factor on
   which packets require fragmentation and reassembly; the worst case
   occurs if the tunnel MTU is "infinite" or equal to the physical
   interface MTUs.

   So, if reassembly could be made to work sufficiently reliably, this
   would be one acceptable fallback solution but only for IPv6.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.2.%20%20Signalling%20the%20Lower%20MTU%20to%20the%20Sources"></a><a class="selflink" href="#section-3.2" name="section-3.2">3.2</a>.  Signalling the Lower MTU to the Sources</span>

   Another approach is to use techniques like Path MTU Discovery (or
   potentially a future derivative [<a href="#ref-13" title='"Path MTU Discovery"'>13</a>]) to signal to the sources whose
   packets will be encapsulated in the network to send smaller packets
   so that they can be encapsulated; in particular, when done on
   routers, this includes two separable functions:

   a.  Forwarding behaviour: when forwarding packets, if the IPv4-only
       DF bit is set, the router sends an ICMP Packet Too Big message to
       the source if the MTU of the egress link is too small.

   b.  Router's "host" behaviour: when the router receives an ICMP
       Packet Too Big message related to a tunnel, it (1) adjusts the
       tunnel MTU, and (2) originates an ICMP Packet Too Big message to
       the source address of the encapsulated packet. (2) can be done
       either immediately or by waiting for the next packet to trigger
       an ICMP; the former minimizes the packet loss due to MTU changes.



<span class="grey">Savola                       Informational                      [Page 5]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-6" id="page-6" name="page-6"> </a>
<span class="grey"><a href="rfc4459.html">RFC 4459</a>         Packet Size Issues in Network Tunnels        April 2006</span>


   Note that this only works if the MTU of the tunnel is of reasonable
   size, and not, for example, 64 kilobytes: see <a href="#appendix-A">Appendix A</a> for more.

   This approach would presuppose that PMTUD works.  While it is
   currently working for IPv6, and critical for its operation, there is
   ample evidence that in IPv4, PMTUD is far from reliable due to, for
   example firewalls and other boxes being configured to inappropriately
   drop all the ICMP packets [<a href="#ref-14" title='"Measuring the Evolution of Transport Protocols in the Internet"'>14</a>], or software bugs rendering PMTUD
   inoperational.

   Furthermore, there are two scenarios where signalling from the
   network would be highly undesirable.  The first is when the
   encapsulation would be done in such a prominent place in the network
   that a very large number of sources would need to be signalled with
   this information (possibly even multiple times, depending on how long
   they keep their PMTUD state).  The second is when the encapsulation
   is done for passive monitoring purposes (network management, lawful
   interception, etc.) -- when it's critical that the sources whose
   traffic is being encapsulated are not aware of this happening.

   When desiring to avoid fragmentation, IPv4 requires one of two
   alternatives [<a href="#ref-1" title='"IP Encapsulation within IP"'>1</a>]: copy the DF bit from the inner packets to the
   encapsulating header, or always set the DF bit of the outer header.
   The latter is better, especially in controlled environments, because
   it forces PMTUD to converge immediately.

   A related technique, which works with TCP under specific scenarios
   only, is so-called "MSS clamping".  With that technique or rather a
   "hack", the TCP packets' Maximum Segment Size (MSS) is reduced by
   tunnel endpoints so that the TCP connection automatically restricts
   itself to the maximum available packet size.  Obviously, this does
   not work for UDP or other protocols that have no MSS.  This approach
   is most applicable and used with PPPoE, but could be applied
   otherwise as well; the approach also assumes that all the traffic
   goes through tunnel endpoints that do MSS clamping -- this is trivial
   for the single-homed access links, but could be a challenge
   otherwise.

   A new approach to PMTUD is in the works [<a href="#ref-13" title='"Path MTU Discovery"'>13</a>], but it is uncertain
   whether that would fix the problems -- at least not the passive
   monitoring requirements.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.3.%20%20Encapsulate%20Only%20When%20There%20is%20Free%20MTU"></a><a class="selflink" href="#section-3.3" name="section-3.3">3.3</a>.  Encapsulate Only When There is Free MTU</span>

   The third approach is an operational one, depending on the
   environment where encapsulation and decapsulation are being
   performed.  That is, if an ISP would deploy tunneling in its
   backbone, which would consist only of links supporting high MTUs



<span class="grey">Savola                       Informational                      [Page 6]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-7" id="page-7" name="page-7"> </a>
<span class="grey"><a href="rfc4459.html">RFC 4459</a>         Packet Size Issues in Network Tunnels        April 2006</span>


   (e.g., Gigabit Ethernet or SDH/SONET), but all its customers and
   peers would have a lower MTU (e.g., 1500, or the backbone MTU minus
   the encapsulation overhead), this would imply that no packets (with
   the encapsulation overhead added) would have a larger MTU than the
   "backbone MTU", and all the encapsulated packets would always fit
   MTU-wise in the backbone links.

   This approach is highly assumptive of the deployment scenario.  It
   may be desirable to build a tunnel to/from another ISP, for example,
   where this might no longer hold; or there might be links in the
   network that cannot support the higher MTUs to satisfy the tunneling
   requirements; or the tunnel might be set up directly between the
   customer and the ISP, in which case fragmentation would occur, with
   tunneled fragments terminating on the ISP and thus requiring
   reassembly capability from the ISP's equipment.

   To restate, this approach can only be considered when tunneling is
   done inside a part of specific kind of ISP's own network, not, for
   example, transiting an ISP.

   Another, related approach might be having the sources use only a low
   enough MTU that would fit in all the physical MTUs; for example, IPv6
   specifies the minimum MTU of 1280 bytes.  For example, if all the
   sources whose traffic would be encapsulated would use this as the
   maximum packet size, there would probably always be enough free MTU
   for encapsulation in the network.  However, this is not the case
   today, and it would be completely unrealistic to assume that this
   kind of approach could be made to work in general.

   It is worth remembering that while the IPv6 minimum MTU is 1280 bytes
   [<a href="#ref-10" title='"Internet Protocol, Version 6 (IPv6) Specification"'>10</a>], there are scenarios where the tunnel implementation must
   implement fragmentation and reassembly [<a href="#ref-3" title='"Generic Packet Tunneling in IPv6 Specification"'>3</a>]: for example, when having
   an IPv6-in-IPv6 tunnel on top of a physical interface with an MTU of
   1280 bytes, or when having two layers of IPv6 tunneling.  This can
   only be avoided by ensuring that links on top of which IPv6 is being
   tunneled have a somewhat larger MTU (e.g., 40 bytes) than 1280 bytes.
   This conclusion can be generalized: because IP can be tunneled on top
   of IP, no single minimum or maximum MTU can be found such that
   fragmentation or signalling to the sources would never be needed.

   All in all, while in certain operational environments it might be
   possible to avoid any problems by deployment choices, or limiting the
   MTU that the sources use, this is probably not a sufficiently good
   general solution for the equipment vendors.  Other solutions must
   also be provided.






<span class="grey">Savola                       Informational                      [Page 7]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-8" id="page-8" name="page-8"> </a>
<span class="grey"><a href="rfc4459.html">RFC 4459</a>         Packet Size Issues in Network Tunnels        April 2006</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.4.%20%20Fragmentation%20of%20the%20Inner%20Packet"></a><a class="selflink" href="#section-3.4" name="section-3.4">3.4</a>.  Fragmentation of the Inner Packet</span>

   A final possibility is fragmenting the inner packet, before
   encapsulation, in such a manner that the encapsulated packet fits in
   the tunnel's path MTU (discovered using PMTUD).  However, one should
   note that only IPv4 supports this "in-flight" fragmentation;
   furthermore, it isn't allowed for packets where the Don't Fragment
   bit has been set.  Even if one could ignore IPv6 completely, so many
   IPv4 host stacks send packets with the DF bit set that this would
   seem unfeasible.

   However, there are existing implementations that violate the standard
   that:

   o  discard too big packets with the DF bit not set instead of
      fragmenting them (this is rare);

   o  ignore the DF bit completely, for all or specified interfaces; or

   o  clear the DF bit before encapsulation, in the egress of configured
      interfaces.  This is typically done for all the traffic, not just
      too big packets (allowing configuring this is common).

   This is non-compliant behaviour, but there are certainly uses for it,
   especially in certain tightly controlled passive monitoring
   scenarios, and it has potential for more generic applicability as
   well, to work around PMTUD issues.

   Clearing the DF bit effectively disables the sender's PMTUD for the
   path beyond the tunnel.  This may result in fragmentation later in
   the network, but as the packets have already been fragmented prior to
   encapsulation, this fragmentation later on does not make matters
   significantly worse.

   As this is an implemented and desired (by some) behaviour, the full
   impacts e.g., for the functioning of PMTUD (for example) should be
   analyzed, and the use of fragmentation-related IPv4 bits should be
   re-evaluated.

   In summary, this approach provides a relatively easy fix for IPv4
   problems, with potential for causing problems for PMTUD; as this
   would not work with IPv6, it could not be considered a generic
   solution.








<span class="grey">Savola                       Informational                      [Page 8]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-9" id="page-9" name="page-9"> </a>
<span class="grey"><a href="rfc4459.html">RFC 4459</a>         Packet Size Issues in Network Tunnels        April 2006</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/4.%20%20Conclusions"></a><a class="selflink" href="#section-4" name="section-4">4</a>.  Conclusions</span>

   Fragmentation and reassembly by the tunnel endpoints are a clear and
   simple solution to the problem, but the hardware reassembly when the
   packets get lost may face significant implementation challenges that
   may be insurmountable.  This approach does not seem feasible,
   especially for IPv4 with high data rates due to problems with
   wrapping the fragment identification field [<a href="#ref-12" title='"Fragmentation Considered Very Harmful"'>12</a>].  Constant wrapping
   may occur when the data rate is in the order of MB/s for IPv4 and in
   the order of dozens of GB/s for IPv6.  However, this reassembly
   approach is probably not a problem for passive monitoring
   applications.

   PMTUD techniques, at least at the moment and especially for IPv4,
   appear to be too unreliable or unscalable to be used in the
   backbones.  It is an open question whether a future solution might
   work better in this aspect.

   It is clear that in some environments the operational approach to the
   problem, ensuring that fragmentation is never necessary by keeping
   higher MTUs in the networks where encapsulated packets traverse, is
   sufficient.  But this is unlikely to be enough in general, and for
   vendors that may not be able to make assumptions about the operators'
   deployments.

   Fragmentation of the inner packet is only possible with IPv4, and is
   sufficient only if standards-incompliant behaviour, with potential
   for bad side-effects (e.g., for PMTUD), is adopted.  It should not be
   used if there are alternatives; fragmentation of the outer packet
   seems a better option for passive monitoring.

   However, if reassembly in the network must be avoided, there are
   basically two possibilities:

   1.  For IPv6, use ICMP signalling or operational methods.

   2.  For IPv4, packets for which the DF bit is not set can be
       fragmented before encapsulation (and the encapsulating header
       would have the DF bit set); packets whose DF bit is set would
       need to get the DF bit cleared (though this is non-compliant).
       This also minimizes the need for (unreliable) Internet-wide
       PMTUD.

   An interesting thing to explicitly note is that when tunneling is
   done in a high-speed backbone, typically one may be able to make
   assumptions on the environment; however, when reassembly is not
   performed in such a network, it might be done in software or with
   lower requirements, and there exists either a reassembly



<span class="grey">Savola                       Informational                      [Page 9]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-10" id="page-10" name="page-10"> </a>
<span class="grey"><a href="rfc4459.html">RFC 4459</a>         Packet Size Issues in Network Tunnels        April 2006</span>


   implementation using PMTUD or using a separate approach for passive
   monitoring -- so this might not be a real problem.

   In consequence, the critical questions at this point appear to be 1)
   whether a higher MTU can be assumed in the high-speed networks that
   deploy tunneling, and 2) whether "slower-speed" networks could cope
   with a software-based reassembly, a less capable hardware-based
   reassembly, or the other workarounds.  An important future task would
   be analyzing the observed incompliant behaviour about the DF bit to
   note whether it has any unanticipated drawbacks.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/5.%20%20Security%20Considerations"></a><a class="selflink" href="#section-5" name="section-5">5</a>.  Security Considerations</span>

   This document describes different issues with packet sizes and in-
   the-network tunneling; this does not have security considerations on
   its own.

   However, different solutions might have characteristics that may make
   them more susceptible to attacks -- for example, a router-based
   fragment reassembly could easily lead to (reassembly) buffer memory
   exhaustion if the attacker sends a sufficient number of fragments
   without sending all of them, so that the reassembly would be stalled
   until a timeout; these and other fragment attacks (e.g., [<a href="#ref-15" title='"Protection Against a Variant of the Tiny Fragment Attack (RFC 1858)"'>15</a>]) have
   already been used against, for example, firewalls and host stacks,
   and need to be taken into consideration in the implementations.

   It is worth considering the cryptographic expense (which is typically
   more significant than the reassembly, if done in software) with
   fragmentation of the inner or outer packet.  If an outer fragment
   goes missing, no cryptographic operations have been yet performed; if
   an inner fragment goes missing, cryptographic operations have already
   been performed.  Therefore, which of these approaches is preferable
   also depends on whether cryptography or reassembly is already
   provided in hardware; for high-speed routers, at least, one should be
   able to assume that if it is performing relatively heavy
   cryptography, hardware support is already required.

   The solutions using PMTUD (and consequently ICMP) will also need to
   take into account the attacks using ICMP.  In particular, an attacker
   could send ICMP Packet Too Big messages indicating a very low MTU to
   reduce the throughput and/or as a fragmentation/reassembly
   denial-of-service attack.  This attack has been described in the
   context of TCP in [<a href="#ref-16" title='"ICMP attacks against TCP"'>16</a>].








<span class="grey">Savola                       Informational                     [Page 10]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-11" id="page-11" name="page-11"> </a>
<span class="grey"><a href="rfc4459.html">RFC 4459</a>         Packet Size Issues in Network Tunnels        April 2006</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/6.%20%20Acknowledgements"></a><a class="selflink" href="#section-6" name="section-6">6</a>.  Acknowledgements</span>

   While the topic is far from new, recent discussions with W. Mark
   Townsley on L2TP fragmentation issues caused the author to sit down
   and write up the issues in general.  Michael Richardson and Mika
   Joutsenvirta provided useful feedback on the first version.  When
   soliciting comments from the NANOG list, Carsten Bormann, Kevin
   Miller, Warren Kumari, Iljitsch van Beijnum, Alok Dube, and Stephen
   J. Wilcox provided useful feedback.  Later, Carlos Pignataro provided
   excellent input, helping to improve the document.  Joe Touch also
   provided input on the memo.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/7.%20%20References"></a><a class="selflink" href="#section-7" name="section-7">7</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.1.%20%20Normative%20References"></a><a class="selflink" href="#section-7.1" name="section-7.1">7.1</a>.  Normative References</span>

   [<a id="ref-1" name="ref-1">1</a>]   Perkins, C., "IP Encapsulation within IP", <a href="rfc2003.html">RFC 2003</a>, October
         1996.

   [<a id="ref-2" name="ref-2">2</a>]   Nordmark, E. and R. Gilligan, "Basic Transition Mechanisms for
         IPv6 Hosts and Routers", <a href="rfc4213.html">RFC 4213</a>, October 2005.

   [<a id="ref-3" name="ref-3">3</a>]   Conta, A. and S. Deering, "Generic Packet Tunneling in IPv6
         Specification", <a href="rfc2473.html">RFC 2473</a>, December 1998.

   [<a id="ref-4" name="ref-4">4</a>]   Farinacci, D., Li, T., Hanks, S., Meyer, D., and P. Traina,
         "Generic Routing Encapsulation (GRE)", <a href="rfc2784.html">RFC 2784</a>, March 2000.

   [<a id="ref-5" name="ref-5">5</a>]   Lau, J., Townsley, M., and I. Goyret, "Layer Two Tunneling
         Protocol - Version 3 (L2TPv3)", <a href="rfc3931.html">RFC 3931</a>, March 2005.

   [<a id="ref-6" name="ref-6">6</a>]   Kent, S. and K. Seo, "Security Architecture for the Internet
         Protocol", <a href="rfc4301.html">RFC 4301</a>, December 2005.

   [<a id="ref-7" name="ref-7">7</a>]   Mogul, J. and S. Deering, "Path MTU discovery", <a href="rfc1191.html">RFC 1191</a>,
         November 1990.

   [<a id="ref-8" name="ref-8">8</a>]   McCann, J., Deering, S., and J. Mogul, "Path MTU Discovery for
         IP version 6", <a href="rfc1981.html">RFC 1981</a>, August 1996.

   [<a id="ref-9" name="ref-9">9</a>]   Braden, R., "Requirements for Internet Hosts - Communication
         Layers", STD 3, <a href="rfc1122.html">RFC 1122</a>, October 1989.

   [<a id="ref-10" name="ref-10">10</a>]  Deering, S. and R. Hinden, "Internet Protocol, Version 6 (IPv6)
         Specification", <a href="rfc2460.html">RFC 2460</a>, December 1998.






<span class="grey">Savola                       Informational                     [Page 11]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-12" id="page-12" name="page-12"> </a>
<span class="grey"><a href="rfc4459.html">RFC 4459</a>         Packet Size Issues in Network Tunnels        April 2006</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.2.%20%20Informative%20References"></a><a class="selflink" href="#section-7.2" name="section-7.2">7.2</a>.  Informative References</span>

   [<a id="ref-11" name="ref-11">11</a>]  Mamakos, L., Lidl, K., Evarts, J., Carrel, D., Simone, D., and
         R. Wheeler, "A Method for Transmitting PPP Over Ethernet
         (PPPoE)", <a href="rfc2516.html">RFC 2516</a>, February 1999.

   [<a id="ref-12" name="ref-12">12</a>]  Mathis, M., <a href="https://www.google.com/search?sitesearch=tools.ietf.org%2Fhtml%2F&amp;q=inurl:draft-+%22Fragmentation+Considered+Very+Harmful%22" style="text-decoration: none">"Fragmentation Considered Very Harmful"</a>, Work in
         Progress, July 2004.

   [<a id="ref-13" name="ref-13">13</a>]  Mathis, M. and J. Heffner, <a href="https://www.google.com/search?sitesearch=tools.ietf.org%2Fhtml%2F&amp;q=inurl:draft-+%22Path+MTU+Discovery%22" style="text-decoration: none">"Path MTU Discovery"</a>, Work in
         Progress, March 2006.

   [<a id="ref-14" name="ref-14">14</a>]  Medina, A., Allman, M., and S. Floyd, "Measuring the Evolution
         of Transport Protocols in the Internet", Computer
         Communications Review, Apr 2005, &lt;<a href="http://www.icir.org/tbit/">http://www.icir.org/tbit/</a>&gt;.

   [<a id="ref-15" name="ref-15">15</a>]  Miller, I., "Protection Against a Variant of the Tiny Fragment
         Attack (<a href="rfc1858.html">RFC 1858</a>)", <a href="rfc3128.html">RFC 3128</a>, June 2001.

   [<a id="ref-16" name="ref-16">16</a>]  Gont, F., <a href="https://www.google.com/search?sitesearch=tools.ietf.org%2Fhtml%2F&amp;q=inurl:draft-+%22ICMP+attacks+against+TCP%22" style="text-decoration: none">"ICMP attacks against TCP"</a>, Work in Progress,
         February 2006.






























<span class="grey">Savola                       Informational                     [Page 12]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-13" id="page-13" name="page-13"> </a>
<span class="grey"><a href="rfc4459.html">RFC 4459</a>         Packet Size Issues in Network Tunnels        April 2006</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/Appendix%20A.%20%20MTU%20of%20the%20Tunnel"></a><a class="selflink" href="#appendix-A" name="appendix-A">Appendix A</a>.  MTU of the Tunnel</span>

   Different tunneling mechanisms may treat the tunnel links as having
   different kinds of MTU values.  Some might use the same default MTU
   as for other interfaces; some others might use the default MTU minus
   the expected IP overhead (e.g., 20, 28, or 40 bytes); some others
   might even treat the tunnel as having an "infinite MTU", e.g., 64
   kilobytes.

   As [<a href="#ref-2" title='"Basic Transition Mechanisms for IPv6 Hosts and Routers"'>2</a>] describes, having an infinite MTU, i.e., always fragmenting
   the outer packet (and never the inner packet) and never performing
   PMTUD for the tunnel path, is a very bad idea, especially in
   host-to-router scenarios.  (It could be argued that if the nodes are
   sure that this is a host-to-host tunnel, a larger MTU might make
   sense if fragmentation and reassembly are more efficient than just
   sending properly sized packets -- but this seems like a stretch.)

Author's Address

   Pekka Savola
   CSC/FUNET
   Espoo
   Finland

   EMail: psavola@funet.fi


























<span class="grey">Savola                       Informational                     [Page 13]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-14" id="page-14" name="page-14"> </a>
<span class="grey"><a href="rfc4459.html">RFC 4459</a>         Packet Size Issues in Network Tunnels        April 2006</span>


Full Copyright Statement

   Copyright (C) The Internet Society (2006).

   This document is subject to the rights, licenses and restrictions
   contained in <a href="https://tools.ietf.org/html/bcp78">BCP 78</a>, and except as set forth therein, the authors
   retain all their rights.

   This document and the information contained herein are provided on an
   "AS IS" basis and THE CONTRIBUTOR, THE ORGANIZATION HE/SHE REPRESENTS
   OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY AND THE INTERNET
   ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES, EXPRESS OR IMPLIED,
   INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE
   INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED
   WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.

Intellectual Property

   The IETF takes no position regarding the validity or scope of any
   Intellectual Property Rights or other rights that might be claimed to
   pertain to the implementation or use of the technology described in
   this document or the extent to which any license under such rights
   might or might not be available; nor does it represent that it has
   made any independent effort to identify any such rights.  Information
   on the procedures with respect to rights in RFC documents can be
   found in <a href="https://tools.ietf.org/html/bcp78">BCP 78</a> and <a href="https://tools.ietf.org/html/bcp79">BCP 79</a>.

   Copies of IPR disclosures made to the IETF Secretariat and any
   assurances of licenses to be made available, or the result of an
   attempt made to obtain a general license or permission for the use of
   such proprietary rights by implementers or users of this
   specification can be obtained from the IETF on-line IPR repository at
   <a href="http://www.ietf.org/ipr">http://www.ietf.org/ipr</a>.

   The IETF invites any interested party to bring to its attention any
   copyrights, patents or patent applications, or other proprietary
   rights that may cover technology that may be required to implement
   this standard.  Please address the information to the IETF at
   ietf-ipr@ietf.org.

Acknowledgement

   Funding for the RFC Editor function is provided by the IETF
   Administrative Support Activity (IASA).







Savola                       Informational                     [Page 14]

</pre><br/>
    <span class="noprint"><small><small>Html markup produced by rfcmarkup 1.126, available from
      <a href="https://tools.ietf.org/tools/rfcmarkup/">https://tools.ietf.org/tools/rfcmarkup/</a>
    </small></small></span>
  </div>




</body><!-- Mirrored from tools.ietf.org/html/rfc4459 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Mar 2018 23:18:41 GMT --></html>