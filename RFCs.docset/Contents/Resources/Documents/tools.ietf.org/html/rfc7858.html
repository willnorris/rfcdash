<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><!-- Mirrored from tools.ietf.org/html/rfc7858 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 14 Aug 2018 13:55:27 GMT --><!-- Added by HTTrack --><head><meta content="text/html;charset=utf-8" http-equiv="content-type"/><!-- /Added by HTTrack -->

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <meta content="index,follow" name="robots"/>
    <meta content="rfcmarkup version 1.127" name="creator"/>
    <link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/>
<meta content="draft-ietf-dprive-start-tls-for-dns" name="DC.Relation.Replaces"/>
<meta content="urn:ietf:rfc:7858" name="DC.Identifier"/>
<meta content="May, 2016" name="DC.Date.Issued"/>
<meta content="Wessels, Duane" name="DC.Creator"/>
<meta content="Heidemann, John" name="DC.Creator"/>
<meta content="Zhu, Liang" name="DC.Creator"/>
<meta content="Mankin, Allison" name="DC.Creator"/>
<meta content="Hoffman, Paul" name="DC.Creator"/>
<meta content="This document describes the use of Transport Layer Security (TLS) to
provide privacy for DNS. Encryption provided by TLS eliminates
opportunities for eavesdropping and on-path tampering with DNS queries
in the network, such as discussed in RFC 7626. In addition, this
document specifies two usage profiles for DNS over TLS and provides
advice on performance considerations to minimize overhead from using
TCP and TLS with DNS.  This document focuses on securing stub-to-
recursive traffic, as per the charter of the DPRIVE Working Group. It
does not prevent future applications of the protocol to recursive-to-
authoritative traffic." name="DC.Description.Abstract"/>
<meta content="Specification for DNS over Transport Layer Security (TLS)" name="DC.Title"/>

    <link href="https://tools.ietf.org/images/rfc.png" rel="icon" type="image/png"/>
    <link href="https://tools.ietf.org/images/rfc.png" rel="shortcut icon" type="image/png"/>
    <title>RFC 7858 - Specification for DNS over Transport Layer Security (TLS)</title>
    
    
    <style type="text/css">
	@media only screen 
	  and (min-width: 992px)
	  and (max-width: 1199px) {
	    body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 768px)
	  and (max-width: 991px) {
            body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 480px)
	  and (max-width: 767px) {
            body { font-size: 11pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (max-width: 479px) {
            body { font-size: 8pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-device-width : 375px) 
	  and (max-device-width : 667px) {
            body { font-size: 9.5pt; }
            div.content { width: 96ex; margin: 0 1px; }
        }
	@media only screen 
	  and (min-device-width: 1200px) {
            body { font-size: 10pt; margin: 0 4em; }
            div.content { width: 96ex; margin: 0; }
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        a.selflink {
          color: black;
          text-decoration: none;
        }
        @media print {
            body {
                font-family: monospace;
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 1em;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>                   <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>                     <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>             <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>              <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td>      <td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td>         <td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard (old designation):</td> <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Internet Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>                  <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>                  <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
  <div class="content">
   <div style="height: 13px;">
      <div class="pre noprint docinfo bgblue" onclick="showElem('legend');" onmouseout="hideElem('legend')" onmouseover="this.style.cursor='pointer';" style="height: 6px; position: absolute;" title="Click for colour legend.">                                                                        </div>
      <div class="docinfo noprint pre legend" id="legend" onmouseout="hideElem('legend');" onmouseover="showElem('legend');" style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; ">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="index.html" title="Document search and retrieval page">Docs</a>] [<a href="https://tools.ietf.org/rfc/rfc7858.txt" title="Plaintext version of this document">txt</a>|<a href="https://tools.ietf.org/pdf/rfc7858" title="PDF version of this document">pdf</a>] [<a href="https://tools.ietf.org/html/draft-ietf-dprive-dns-over-tls" title="draft-ietf-dprive-dns-over-tls">draft-ietf-dpri...</a>] [<a href="https://datatracker.ietf.org/doc/rfc7858" title="IESG Datatracker information for this document">Tracker</a>] [<a href="https://tools.ietf.org/rfcdiff?difftype=--hwdiff&amp;url2=rfc7858" title="Inline diff (wdiff)">Diff1</a>] [<a href="https://tools.ietf.org/rfcdiff?url2=rfc7858" title="Side-by-side diff">Diff2</a>] [<a href="https://www.rfc-editor.org/errata_search.php?rfc=7858">Errata</a>]</span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<span class="pre noprint docinfo">Updated by: <a href="rfc8310.html">8310</a>                                       PROPOSED STANDARD</span><br/>
<span class="pre noprint docinfo">                                                            <span style="color: #C00;">Errata Exist</span></span><br/>
<pre>Internet Engineering Task Force (IETF)                             Z. Hu
Request for Comments: 7858                                        L. Zhu
Category: Standards Track                                   J. Heidemann
ISSN: 2070-1721                                                  USC/ISI
                                                               A. Mankin
                                                             Independent
                                                              D. Wessels
                                                           Verisign Labs
                                                              P. Hoffman
                                                                   ICANN
                                                                May 2016


       <span class="h1">Specification for DNS over Transport Layer Security (TLS)</span>

Abstract

   This document describes the use of Transport Layer Security (TLS) to
   provide privacy for DNS.  Encryption provided by TLS eliminates
   opportunities for eavesdropping and on-path tampering with DNS
   queries in the network, such as discussed in <a href="rfc7626.html">RFC 7626</a>.  In addition,
   this document specifies two usage profiles for DNS over TLS and
   provides advice on performance considerations to minimize overhead
   from using TCP and TLS with DNS.

   This document focuses on securing stub-to-recursive traffic, as per
   the charter of the DPRIVE Working Group.  It does not prevent future
   applications of the protocol to recursive-to-authoritative traffic.

Status of This Memo

   This is an Internet Standards Track document.

   This document is a product of the Internet Engineering Task Force
   (IETF).  It represents the consensus of the IETF community.  It has
   received public review and has been approved for publication by the
   Internet Engineering Steering Group (IESG).  Further information on
   Internet Standards is available in <a href="rfc5741.html#section-2">Section 2 of RFC 5741</a>.

   Information about the current status of this document, any errata,
   and how to provide feedback on it may be obtained at
   <a href="http://www.rfc-editor.org/info/rfc7858">http://www.rfc-editor.org/info/rfc7858</a>.









<span class="grey">Hu, et al.                   Standards Track                    [Page 1]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-2" id="page-2" name="page-2"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


Copyright Notice

   Copyright (c) 2016 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="https://tools.ietf.org/html/bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.

Table of Contents

   <a href="#section-1">1</a>.  Introduction  . . . . . . . . . . . . . . . . . . . . . . . .   <a href="#page-3">3</a>
   <a href="#section-2">2</a>.  Key Words . . . . . . . . . . . . . . . . . . . . . . . . . .   <a href="#page-4">4</a>
   <a href="#section-3">3</a>.  Establishing and Managing DNS-over-TLS Sessions . . . . . . .   <a href="#page-4">4</a>
     <a href="#section-3.1">3.1</a>.  Session Initiation  . . . . . . . . . . . . . . . . . . .   <a href="#page-4">4</a>
     <a href="#section-3.2">3.2</a>.  TLS Handshake and Authentication  . . . . . . . . . . . .   <a href="#page-5">5</a>
     <a href="#section-3.3">3.3</a>.  Transmitting and Receiving Messages . . . . . . . . . . .   <a href="#page-5">5</a>
     <a href="#section-3.4">3.4</a>.  Connection Reuse, Close, and Reestablishment  . . . . . .   <a href="#page-6">6</a>
   <a href="#section-4">4</a>.  Usage Profiles  . . . . . . . . . . . . . . . . . . . . . . .   <a href="#page-7">7</a>
     <a href="#section-4.1">4.1</a>.  Opportunistic Privacy Profile . . . . . . . . . . . . . .   <a href="#page-7">7</a>
     <a href="#section-4.2">4.2</a>.  Out-of-Band Key-Pinned Privacy Profile  . . . . . . . . .   <a href="#page-7">7</a>
   <a href="#section-5">5</a>.  Performance Considerations  . . . . . . . . . . . . . . . . .   <a href="#page-9">9</a>
   <a href="#section-6">6</a>.  IANA Considerations . . . . . . . . . . . . . . . . . . . . .  <a href="#page-10">10</a>
   <a href="#section-7">7</a>.  Design Evolution  . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-10">10</a>
   <a href="#section-8">8</a>.  Security Considerations . . . . . . . . . . . . . . . . . . .  <a href="#page-11">11</a>
   <a href="#section-9">9</a>.  References  . . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-12">12</a>
     <a href="#section-9.1">9.1</a>.  Normative References  . . . . . . . . . . . . . . . . . .  <a href="#page-12">12</a>
     <a href="#section-9.2">9.2</a>.  Informative References  . . . . . . . . . . . . . . . . .  <a href="#page-13">13</a>
   <a href="#appendix-A">Appendix A</a>.  Out-of-Band Key-Pinned Privacy Profile Example . . .  <a href="#page-16">16</a>
   Acknowledgments . . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-17">17</a>
   Contributors  . . . . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-17">17</a>
   Authors' Addresses  . . . . . . . . . . . . . . . . . . . . . . .  <a href="#page-18">18</a>













<span class="grey">Hu, et al.                   Standards Track                    [Page 2]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-3" id="page-3" name="page-3"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/1.%20%20Introduction"></a><a class="selflink" href="#section-1" name="section-1">1</a>.  Introduction</span>

   Today, nearly all DNS queries [<a href="rfc1034.html" title='"Domain names - concepts and facilities"'>RFC1034</a>] [<a href="rfc1035.html" title='"Domain names - implementation and specification"'>RFC1035</a>] are sent
   unencrypted, which makes them vulnerable to eavesdropping by an
   attacker that has access to the network channel, reducing the privacy
   of the querier.  Recent news reports have elevated these concerns,
   and recent IETF work has specified privacy considerations for DNS
   [<a href="rfc7626.html" title='"DNS Privacy Considerations"'>RFC7626</a>].

   Prior work has addressed some aspects of DNS security, but until
   recently, there has been little work on privacy between a DNS client
   and server.  DNS Security Extensions (DNSSEC) [<a href="rfc4033.html" title='"DNS Security Introduction and Requirements"'>RFC4033</a>] provide
   _response integrity_ by defining mechanisms to cryptographically sign
   zones, allowing end users (or their first-hop resolver) to verify
   replies are correct.  By intention, DNSSEC does not protect request
   and response privacy.  Traditionally, either privacy was not
   considered a requirement for DNS traffic or it was assumed that
   network traffic was sufficiently private; however, these perceptions
   are evolving due to recent events [<a href="rfc7258.html" title='"Pervasive Monitoring Is an Attack"'>RFC7258</a>].

   Other work that has offered the potential to encrypt between DNS
   clients and servers includes DNSCurve [<a href="#ref-DNSCurve" title='"DNSCurve: Link-Level Security for the Domain Name System"'>DNSCurve</a>], DNSCrypt
   [<a href="#ref-DNSCRYPT-WEBSITE" title='"DNSCrypt"'>DNSCRYPT-WEBSITE</a>], Confidential DNS [<a href="#ref-CONFIDENTIAL-DNS" title='"Confidential DNS"'>CONFIDENTIAL-DNS</a>], and IPSECA
   [<a href="#ref-IPSECA" title='"Opportunistic Encryption with DANE Semantics and IPsec: IPSECA"'>IPSECA</a>].  In addition to the present specification, the DPRIVE
   Working Group has also adopted a proposal for DNS over Datagram
   Transport Layer Security (DTLS) [<a href="#ref-DNSoD" title='"DNS over DTLS (DNSoD)"'>DNSoD</a>].

   This document describes using DNS over TLS on a well-known port and
   also offers advice on performance considerations to minimize
   overheads from using TCP and TLS with DNS.

   Initiation of DNS over TLS is very straightforward.  By establishing
   a connection over a well-known port, clients and servers expect and
   agree to negotiate a TLS session to secure the channel.  Deployment
   will be gradual.  Not all servers will support DNS over TLS and the
   well-known port might be blocked by some firewalls.  Clients will be
   expected to keep track of servers that support TLS and those that
   don't.  Clients and servers will adhere to the TLS implementation
   recommendations and security considerations of [<a href="#ref-BCP195" title='"Recommendations for Secure Use of Transport Layer Security (TLS) and Datagram Transport Layer Security (DTLS)"'>BCP195</a>].

   The protocol described here works for queries and responses between
   stub clients and recursive servers.  It might work equally between
   recursive clients and authoritative servers, but this application of
   the protocol is out of scope for the DNS PRIVate Exchange (DPRIVE)
   Working Group per its current charter.






<span class="grey">Hu, et al.                   Standards Track                    [Page 3]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-4" id="page-4" name="page-4"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


   This document describes two profiles in <a href="#section-4">Section 4</a> that provide
   different levels of assurance of privacy: an opportunistic privacy
   profile and an out-of-band key-pinned privacy profile.  It is
   expected that a future document based on [<a href="#ref-TLS-DTLS-PROFILES" title='"Authentication and (D)TLS Profile for DNS-over-TLS and DNS-over-DTLS"'>TLS-DTLS-PROFILES</a>] will
   further describe additional privacy profiles for DNS over both TLS
   and DTLS.

   An earlier draft version of this document described a technique for
   upgrading a DNS-over-TCP connection to a DNS-over-TLS session with,
   essentially, "STARTTLS for DNS".  To simplify the protocol, this
   document now only uses a well-known port to specify TLS use, omitting
   the upgrade approach.  The upgrade approach no longer appears in this
   document, which now focuses exclusively on the use of a well-known
   port for DNS over TLS.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/2.%20%20Key%20Words"></a><a class="selflink" href="#section-2" name="section-2">2</a>.  Key Words</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <a href="rfc2119.html">RFC 2119</a> [<a href="rfc2119.html" title='"Key words for use in RFCs to Indicate Requirement Levels"'>RFC2119</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/3.%20%20Establishing%20and%20Managing%20DNS-over-TLS%20Sessions"></a><a class="selflink" href="#section-3" name="section-3">3</a>.  Establishing and Managing DNS-over-TLS Sessions</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.1.%20%20Session%20Initiation"></a><a class="selflink" href="#section-3.1" name="section-3.1">3.1</a>.  Session Initiation</span>

   By default, a DNS server that supports DNS over TLS MUST listen for
   and accept TCP connections on port 853, unless it has mutual
   agreement with its clients to use a port other than 853 for DNS over
   TLS.  In order to use a port other than 853, both clients and servers
   would need a configuration option in their software.

   By default, a DNS client desiring privacy from DNS over TLS from a
   particular server MUST establish a TCP connection to port 853 on the
   server, unless it has mutual agreement with its server to use a port
   other than port 853 for DNS over TLS.  Such another port MUST NOT be
   port 53 but MAY be from the "first-come, first-served" port range.
   This recommendation against use of port 53 for DNS over TLS is to
   avoid complication in selecting use or non-use of TLS and to reduce
   risk of downgrade attacks.  The first data exchange on this TCP
   connection MUST be the client and server initiating a TLS handshake
   using the procedure described in [<a href="rfc5246.html" title='"The Transport Layer Security (TLS) Protocol Version 1.2"'>RFC5246</a>].

   DNS clients and servers MUST NOT use port 853 to transport cleartext
   DNS messages.  DNS clients MUST NOT send and DNS servers MUST NOT
   respond to cleartext DNS messages on any port used for DNS over TLS
   (including, for example, after a failed TLS handshake).  There are
   significant security issues in mixing protected and unprotected data,




<span class="grey">Hu, et al.                   Standards Track                    [Page 4]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-5" id="page-5" name="page-5"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


   and for this reason, TCP connections on a port designated by a given
   server for DNS over TLS are reserved purely for encrypted
   communications.

   DNS clients SHOULD remember server IP addresses that don't support
   DNS over TLS, including timeouts, connection refusals, and TLS
   handshake failures, and not request DNS over TLS from them for a
   reasonable period (such as one hour per server).  DNS clients
   following an out-of-band key-pinned privacy profile (<a href="#section-4.2">Section 4.2</a>) MAY
   be more aggressive about retrying DNS-over-TLS connection failures.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.2.%20%20TLS%20Handshake%20and%20Authentication"></a><a class="selflink" href="#section-3.2" name="section-3.2">3.2</a>.  TLS Handshake and Authentication</span>

   Once the DNS client succeeds in connecting via TCP on the well-known
   port for DNS over TLS, it proceeds with the TLS handshake [<a href="rfc5246.html" title='"The Transport Layer Security (TLS) Protocol Version 1.2"'>RFC5246</a>],
   following the best practices specified in [<a href="#ref-BCP195" title='"Recommendations for Secure Use of Transport Layer Security (TLS) and Datagram Transport Layer Security (DTLS)"'>BCP195</a>].

   The client will then authenticate the server, if required.  This
   document does not propose new ideas for authentication.  Depending on
   the privacy profile in use (<a href="#section-4">Section 4</a>), the DNS client may choose not
   to require authentication of the server, or it may make use of a
   trusted Subject Public Key Info (SPKI) Fingerprint pin set.

   After TLS negotiation completes, the connection will be encrypted and
   is now protected from eavesdropping.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.3.%20%20Transmitting%20and%20Receiving%20Messages"></a><a class="selflink" href="#section-3.3" name="section-3.3">3.3</a>.  Transmitting and Receiving Messages</span>

   All messages (requests and responses) in the established TLS session
   MUST use the two-octet length field described in <a href="rfc1035.html#section-4.2.2">Section 4.2.2 of
   [RFC1035]</a>.  For reasons of efficiency, DNS clients and servers SHOULD
   pass the two-octet length field, and the message described by that
   length field, to the TCP layer at the same time (e.g., in a single
   "write" system call) to make it more likely that all the data will be
   transmitted in a single TCP segment (<a href="rfc7766.html#section-8">[RFC7766], Section 8</a>).

   In order to minimize latency, clients SHOULD pipeline multiple
   queries over a TLS session.  When a DNS client sends multiple queries
   to a server, it should not wait for an outstanding reply before
   sending the next query (<a href="rfc7766.html#section-6.2.1.1">[RFC7766], Section 6.2.1.1</a>).

   Since pipelined responses can arrive out of order, clients MUST match
   responses to outstanding queries on the same TLS connection using the
   Message ID.  If the response contains a Question Section, the client
   MUST match the QNAME, QCLASS, and QTYPE fields.  Failure by clients
   to properly match responses to outstanding queries can have serious
   consequences for interoperability (<a href="rfc7766.html#section-7">[RFC7766], Section 7</a>).




<span class="grey">Hu, et al.                   Standards Track                    [Page 5]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-6" id="page-6" name="page-6"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.4.%20%20Connection%20Reuse%2C%20Close%2C%20and%20Reestablishment"></a><a class="selflink" href="#section-3.4" name="section-3.4">3.4</a>.  Connection Reuse, Close, and Reestablishment</span>

   For DNS clients that use library functions such as "getaddrinfo()"
   and "gethostbyname()", current implementations are known to open and
   close TCP connections for each DNS query.  To avoid excess TCP
   connections, each with a single query, clients SHOULD reuse a single
   TCP connection to the recursive resolver.  Alternatively, they may
   prefer to use UDP to a DNS-over-TLS-enabled caching resolver on the
   same machine that then uses a system-wide TCP connection to the
   recursive resolver.

   In order to amortize TCP and TLS connection setup costs, clients and
   servers SHOULD NOT immediately close a connection after each
   response.  Instead, clients and servers SHOULD reuse existing
   connections for subsequent queries as long as they have sufficient
   resources.  In some cases, this means that clients and servers may
   need to keep idle connections open for some amount of time.

   Proper management of established and idle connections is important to
   the healthy operation of a DNS server.  An implementor of DNS over
   TLS SHOULD follow best practices for DNS over TCP, as described in
   [<a href="rfc7766.html" title='"DNS Transport over TCP - Implementation Requirements"'>RFC7766</a>].  Failure to do so may lead to resource exhaustion and
   denial of service.

   Whereas client and server implementations from the era of [<a href="rfc1035.html" title='"Domain names - implementation and specification"'>RFC1035</a>]
   are known to have poor TCP connection management, this document
   stipulates that successful negotiation of TLS indicates the
   willingness of both parties to keep idle DNS connections open,
   independent of timeouts or other recommendations for DNS over TCP
   without TLS.  In other words, software implementing this protocol is
   assumed to support idle, persistent connections and be prepared to
   manage multiple, potentially long-lived TCP connections.

   This document does not make specific recommendations for timeout
   values on idle connections.  Clients and servers should reuse and/or
   close connections depending on the level of available resources.
   Timeouts may be longer during periods of low activity and shorter
   during periods of high activity.  Current work in this area may also
   assist DNS-over-TLS clients and servers in selecting useful timeout
   values [<a href="rfc7828.html" title='"The edns-tcp-keepalive EDNS0 Option"'>RFC7828</a>] [<a href="#ref-TDNS" title='"Connection-Oriented DNS to Improve Privacy and Security"'>TDNS</a>].

   Clients and servers that keep idle connections open MUST be robust to
   termination of idle connection by either party.  As with current DNS
   over TCP, DNS servers MAY close the connection at any time (perhaps
   due to resource constraints).  As with current DNS over TCP, clients
   MUST handle abrupt closes and be prepared to reestablish connections
   and/or retry queries.




<span class="grey">Hu, et al.                   Standards Track                    [Page 6]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-7" id="page-7" name="page-7"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


   When reestablishing a DNS-over-TCP connection that was terminated, as
   discussed in [<a href="rfc7766.html" title='"DNS Transport over TCP - Implementation Requirements"'>RFC7766</a>], TCP Fast Open [<a href="rfc7413.html" title='"TCP Fast Open"'>RFC7413</a>] is of benefit.
   Underlining the requirement for sending only encrypted DNS data on a
   DNS-over-TLS port (<a href="#section-3.2">Section 3.2</a>), when using TCP Fast Open, the client
   and server MUST immediately initiate or resume a TLS handshake
   (cleartext DNS MUST NOT be exchanged).  DNS servers SHOULD enable
   fast TLS session resumption [<a href="rfc5077.html" title='"Transport Layer Security (TLS) Session Resumption without Server-Side State"'>RFC5077</a>], and this SHOULD be used when
   reestablishing connections.

   When closing a connection, DNS servers SHOULD use the TLS close-
   notify request to shift TCP TIME-WAIT state to the clients.
   Additional requirements and guidance for optimizing DNS over TCP are
   provided by [<a href="rfc7766.html" title='"DNS Transport over TCP - Implementation Requirements"'>RFC7766</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/4.%20%20Usage%20Profiles"></a><a class="selflink" href="#section-4" name="section-4">4</a>.  Usage Profiles</span>

   This protocol provides flexibility to accommodate several different
   use cases.  This document defines two usage profiles: (1)
   opportunistic privacy and (2) out-of-band key-pinned authentication
   that can be used to obtain stronger privacy guarantees if the client
   has a trusted relationship with a DNS server supporting TLS.
   Additional methods of authentication will be defined in a forthcoming
   document [<a href="#ref-TLS-DTLS-PROFILES" title='"Authentication and (D)TLS Profile for DNS-over-TLS and DNS-over-DTLS"'>TLS-DTLS-PROFILES</a>].

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.1.%20%20Opportunistic%20Privacy%20Profile"></a><a class="selflink" href="#section-4.1" name="section-4.1">4.1</a>.  Opportunistic Privacy Profile</span>

   For opportunistic privacy, analogous to SMTP opportunistic security
   [<a href="rfc7435.html" title='"Opportunistic Security: Some Protection Most of the Time"'>RFC7435</a>], one does not require privacy, but one desires privacy when
   possible.

   With opportunistic privacy, a client might learn of a TLS-enabled
   recursive DNS resolver from an untrusted source.  One possible
   example flow would be if the client used the DHCP DNS server option
   [<a href="rfc3646.html" title='"DNS Configuration options for Dynamic Host Configuration Protocol for IPv6 (DHCPv6)"'>RFC3646</a>] to discover the IP address of a TLS-enabled recursive and
   then attempted DNS over TLS on port 853.  With such a discovered DNS
   server, the client might or might not validate the resolver.  These
   choices maximize availability and performance, but they leave the
   client vulnerable to on-path attacks that remove privacy.

   Opportunistic privacy can be used by any current client, but it only
   provides privacy when there are no on-path active attackers.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.2.%20%20Out-of-Band%20Key-Pinned%20Privacy%20Profile"></a><a class="selflink" href="#section-4.2" name="section-4.2">4.2</a>.  Out-of-Band Key-Pinned Privacy Profile</span>

   The out-of-band key-pinned privacy profile can be used in
   environments where an established trust relationship already exists
   between DNS clients and servers (e.g., stub-to-recursive in
   enterprise networks, actively maintained contractual service



<span class="grey">Hu, et al.                   Standards Track                    [Page 7]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-8" id="page-8" name="page-8"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


   relationships, or a client using a public DNS resolver).  The result
   of this profile is that the client has strong guarantees about the
   privacy of its DNS data by connecting only to servers it can
   authenticate.  Operators of a DNS-over-TLS service in this profile
   are expected to provide pins that are specific to the service being
   pinned (i.e., public keys belonging directly to the end entity or to
   a service-specific private certificate authority (CA)) and not to a
   public key(s) of a generic public CA.

   In this profile, clients authenticate servers by matching a set of
   SPKI Fingerprints in an analogous manner to that described in
   [<a href="rfc7469.html" title='"Public Key Pinning Extension for HTTP"'>RFC7469</a>].  With this out-of-band key-pinned privacy profile, client
   administrators SHOULD deploy a backup pin along with the primary pin,
   for the reasons explained in [<a href="rfc7469.html" title='"Public Key Pinning Extension for HTTP"'>RFC7469</a>].  A backup pin is especially
   helpful in the event of a key rollover, so that a server operator
   does not have to coordinate key transitions with all its clients
   simultaneously.  After a change of keys on the server, an updated pin
   set SHOULD be distributed to all clients in some secure way in
   preparation for future key rollover.  The mechanism for an
   out-of-band pin set update is out of scope for this document.

   Such a client will only use DNS servers for which an SPKI Fingerprint
   pin set has been provided.  The possession of a trusted pre-deployed
   pin set allows the client to detect and prevent person-in-the-middle
   and downgrade attacks.

   However, a configured DNS server may be temporarily unavailable when
   configuring a network.  For example, for clients on networks that
   require authentication through web-based login, such authentication
   may rely on DNS interception and spoofing.  Techniques such as those
   used by DNSSEC-trigger [<a href="#ref-DNSSEC-TRIGGER" title='"Dnssec-Trigger"'>DNSSEC-TRIGGER</a>] MAY be used during network
   configuration, with the intent to transition to the designated DNS
   provider after authentication.  The user MUST be alerted whenever
   possible that the DNS is not private during such bootstrap.

   Upon successful TLS connection and handshake, the client computes the
   SPKI Fingerprints for the public keys found in the validated server's
   certificate chain (or in the raw public key, if the server provides
   that instead).  If a computed fingerprint exactly matches one of the
   configured pins, the client continues with the connection as normal.
   Otherwise, the client MUST treat the SPKI validation failure as a
   non-recoverable error.  <a href="#appendix-A">Appendix A</a> provides a detailed example of how
   this authentication could be performed in practice.

   Implementations of this privacy profile MUST support the calculation
   of a fingerprint as the SHA-256 [<a href="rfc6234.html" title='"US Secure Hash Algorithms (SHA and SHA-based HMAC and HKDF)"'>RFC6234</a>] hash of the DER-encoded
   ASN.1 representation of the SPKI of an X.509 certificate.




<span class="grey">Hu, et al.                   Standards Track                    [Page 8]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-9" id="page-9" name="page-9"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


   Implementations MUST support the representation of a SHA-256
   fingerprint as a base64-encoded character string [<a href="rfc4648.html" title='"The Base16, Base32, and Base64 Data Encodings"'>RFC4648</a>].
   Additional fingerprint types MAY also be supported.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/5.%20%20Performance%20Considerations"></a><a class="selflink" href="#section-5" name="section-5">5</a>.  Performance Considerations</span>

   DNS over TLS incurs additional latency at session startup.  It also
   requires additional state (memory) and increased processing (CPU).

   Latency:  Compared to UDP, DNS over TCP requires an additional round-
      trip time (RTT) of latency to establish a TCP connection.  TCP
      Fast Open [<a href="rfc7413.html" title='"TCP Fast Open"'>RFC7413</a>] can eliminate that RTT when information exists
      from prior connections.  The TLS handshake adds another two RTTs
      of latency.  Clients and servers should support connection
      keepalive (reuse) and out-of-order processing to amortize
      connection setup costs.  Fast TLS connection resumption [<a href="rfc5077.html" title='"Transport Layer Security (TLS) Session Resumption without Server-Side State"'>RFC5077</a>]
      further reduces the setup delay and avoids the DNS server keeping
      per-client session state.

      TLS False Start [<a href="#ref-TLS-FALSESTART" title='"Transport Layer Security (TLS) False Start"'>TLS-FALSESTART</a>] can also lead to a latency
      reduction in certain situations.  Implementations supporting TLS
      False Start need to be aware that it imposes additional
      constraints on how one uses TLS, over and above those stated in
      [<a href="#ref-BCP195" title='"Recommendations for Secure Use of Transport Layer Security (TLS) and Datagram Transport Layer Security (DTLS)"'>BCP195</a>].  It is unsafe to use False Start if your implementation
      and deployment does not adhere to these specific requirements.
      See [<a href="#ref-TLS-FALSESTART" title='"Transport Layer Security (TLS) False Start"'>TLS-FALSESTART</a>] for the details of these additional
      constraints.

   State:  The use of connection-oriented TCP requires keeping
      additional state at the server in both the kernel and application.
      The state requirements are of particular concern on servers with
      many clients, although memory-optimized TLS can add only modest
      state over TCP.  Smaller timeout values will reduce the number of
      concurrent connections, and servers can preemptively close
      connections when resource limits are exceeded.

   Processing:  The use of TLS encryption algorithms results in slightly
      higher CPU usage.  Servers can choose to refuse new DNS-over-TLS
      clients if processing limits are exceeded.

   Number of connections:  To minimize state on DNS servers and
      connection startup time, clients SHOULD minimize the creation of
      new TCP connections.  Use of a local DNS request aggregator (a
      particular type of forwarder) allows a single active DNS-over-TLS
      connection from any given client computer to its server.
      Additional guidance can be found in [<a href="rfc7766.html" title='"DNS Transport over TCP - Implementation Requirements"'>RFC7766</a>].





<span class="grey">Hu, et al.                   Standards Track                    [Page 9]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-10" id="page-10" name="page-10"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


   A full performance evaluation is outside the scope of this
   specification.  A more detailed analysis of the performance
   implications of DNS over TLS (and DNS over TCP) is discussed in
   [<a href="#ref-TDNS" title='"Connection-Oriented DNS to Improve Privacy and Security"'>TDNS</a>] and [<a href="rfc7766.html" title='"DNS Transport over TCP - Implementation Requirements"'>RFC7766</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/6.%20%20IANA%20Considerations"></a><a class="selflink" href="#section-6" name="section-6">6</a>.  IANA Considerations</span>

   IANA has added the following value to the "Service Name and Transport
   Protocol Port Number Registry" in the System Range.  The registry for
   that range requires IETF Review or IESG Approval [<a href="rfc6335.html" title='"Internet Assigned Numbers Authority (IANA) Procedures for the Management of the Service Name and Transport Protocol Port Number Registry"'>RFC6335</a>], and such
   a review was requested using the early allocation process [<a href="rfc7120.html" title='"Early IANA Allocation of Standards Track Code Points"'>RFC7120</a>]
   for the well-known TCP port in this document.

   IANA has reserved the same port number over UDP for the proposed DNS-
   over-DTLS protocol [<a href="#ref-DNSoD" title='"DNS over DTLS (DNSoD)"'>DNSoD</a>].

    Service Name           domain-s
    Port Number            853
    Transport Protocol(s)  TCP/UDP
    Assignee               IESG
    Contact                IETF Chair
    Description            DNS query-response protocol run over TLS/DTLS
    Reference              This document

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/7.%20%20Design%20Evolution"></a><a class="selflink" href="#section-7" name="section-7">7</a>.  Design Evolution</span>

   Earlier draft versions of this document proposed an upgrade-based
   approach to establish a TLS session.  The client would signal its
   interest in TLS by setting a "TLS OK" bit in the Extensions
   Mechanisms for DNS (EDNS(0)) flags field.  A server would signal its
   acceptance by responding with the TLS OK bit set.

   Since we assume the client doesn't want to reveal (leak) any
   information prior to securing the channel, we proposed the use of a
   "dummy query" that clients could send for this purpose.  The proposed
   query name was STARTTLS, query type TXT, and query class CH.

   The TLS OK signaling approach has both advantages and disadvantages.
   One important advantage is that clients and servers could negotiate
   TLS.  If the server is too busy, or doesn't want to provide TLS
   service to a particular client, it can respond negatively to the TLS
   probe.  An ancillary benefit is that servers could collect
   information on adoption of DNS over TLS (via the TLS OK bit in
   queries) before implementation and deployment.  Another anticipated
   advantage is the expectation that DNS over TLS would work over port
   53.  That is, no need to "waste" another port and deploy new firewall
   rules on middleboxes.




<span class="grey">Hu, et al.                   Standards Track                   [Page 10]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-11" id="page-11" name="page-11"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


   However, at the same time, there was uncertainty whether or not
   middleboxes would pass the TLS OK bit, given that the EDNS0 flags
   field has been unchanged for many years.  Another disadvantage is
   that the TLS OK bit may make downgrade attacks easy and
   indistinguishable from broken middleboxes.  From a performance
   standpoint, the upgrade-based approach had the disadvantage of
   requiring 1xRTT additional latency for the dummy query.

   Following this proposal, DNS over DTLS was proposed separately.  DNS
   over DTLS claimed it could work over port 53, but only because a non-
   DTLS server interprets a DNS-over-DTLS query as a response.  That is,
   the non-DTLS server observes the QR flag set to 1.  While this
   technically works, it seems unfortunate and perhaps even undesirable.

   DNS over both TLS and DTLS can benefit from a single well-known port
   and avoid extra latency and misinterpreted queries as responses.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/8.%20%20Security%20Considerations"></a><a class="selflink" href="#section-8" name="section-8">8</a>.  Security Considerations</span>

   Use of DNS over TLS is designed to address the privacy risks that
   arise out of the ability to eavesdrop on DNS messages.  It does not
   address other security issues in DNS, and there are a number of
   residual risks that may affect its success at protecting privacy:

   1.  There are known attacks on TLS, such as person-in-the-middle and
       protocol downgrade.  These are general attacks on TLS and not
       specific to DNS over TLS; please refer to the TLS RFCs for
       discussion of these security issues.  Clients and servers MUST
       adhere to the TLS implementation recommendations and security
       considerations of [<a href="#ref-BCP195" title='"Recommendations for Secure Use of Transport Layer Security (TLS) and Datagram Transport Layer Security (DTLS)"'>BCP195</a>].  DNS clients keeping track of servers
       known to support TLS enables clients to detect downgrade attacks.
       For servers with no connection history and no apparent support
       for TLS, depending on their privacy profile and privacy
       requirements, clients may choose to (a) try another server when
       available, (b) continue without TLS, or (c) refuse to forward the
       query.

   2.  Middleboxes [<a href="rfc3234.html" title='"Middleboxes: Taxonomy and Issues"'>RFC3234</a>] are present in some networks and have been
       known to interfere with normal DNS resolution.  Use of a
       designated port for DNS over TLS should avoid such interference.
       In general, clients that attempt TLS and fail can either fall
       back on unencrypted DNS or wait and retry later, depending on
       their privacy profile and privacy requirements.

   3.  Any DNS protocol interactions performed in the clear can be
       modified by a person-in-the-middle attacker.  For example,
       unencrypted queries and responses might take place over port 53
       between a client and server.  For this reason, clients MAY



<span class="grey">Hu, et al.                   Standards Track                   [Page 11]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-12" id="page-12" name="page-12"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


       discard cached information about server capabilities advertised
       in cleartext.

   4.  This document does not, itself, specify ideas to resist known
       traffic analysis or side-channel leaks.  Even with encrypted
       messages, a well-positioned party may be able to glean certain
       details from an analysis of message timings and sizes.  Clients
       and servers may consider the use of a padding method to address
       privacy leakage due to message sizes [<a href="rfc7830.html" title='"The EDNS(0) Padding Option"'>RFC7830</a>].  Since traffic
       analysis can be based on many kinds of patterns and many kinds of
       classifiers, simple padding schemes alone might not be sufficient
       to mitigate such an attack.  Padding will, however, form a part
       of more complex mitigations for traffic-analysis attacks that are
       likely to be developed over time.  Implementors who can offer
       flexibility in terms of how padding can be used may be in a
       better position to enable such mitigations to be deployed in the
       future.

   As noted earlier, DNSSEC and DNS over TLS are independent and fully
   compatible protocols, each solving different problems.  The use of
   one does not diminish the need nor the usefulness of the other.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/9.%20%20References"></a><a class="selflink" href="#section-9" name="section-9">9</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/9.1.%20%20Normative%20References"></a><a class="selflink" href="#section-9.1" name="section-9.1">9.1</a>.  Normative References</span>

   [<a id="ref-BCP195" name="ref-BCP195">BCP195</a>]   Sheffer, Y., Holz, R., and P. Saint-Andre,
              "Recommendations for Secure Use of Transport Layer
              Security (TLS) and Datagram Transport Layer Security
              (DTLS)", <a href="https://tools.ietf.org/html/bcp195">BCP 195</a>, <a href="rfc7525.html">RFC 7525</a>, May 2015,
              &lt;<a href="https://www.rfc-editor.org/info/bcp195">https://www.rfc-editor.org/info/bcp195</a>&gt;.

   [<a id="ref-RFC1034" name="ref-RFC1034">RFC1034</a>]  Mockapetris, P., "Domain names - concepts and facilities",
              STD 13, <a href="rfc1034.html">RFC 1034</a>, DOI 10.17487/RFC1034, November 1987,
              &lt;<a href="http://www.rfc-editor.org/info/rfc1034">http://www.rfc-editor.org/info/rfc1034</a>&gt;.

   [<a id="ref-RFC1035" name="ref-RFC1035">RFC1035</a>]  Mockapetris, P., "Domain names - implementation and
              specification", STD 13, <a href="rfc1035.html">RFC 1035</a>, DOI 10.17487/RFC1035,
              November 1987, &lt;<a href="http://www.rfc-editor.org/info/rfc1035">http://www.rfc-editor.org/info/rfc1035</a>&gt;.

   [<a id="ref-RFC2119" name="ref-RFC2119">RFC2119</a>]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", <a href="https://tools.ietf.org/html/bcp14">BCP 14</a>, <a href="rfc2119.html">RFC 2119</a>,
              DOI 10.17487/RFC2119, March 1997,
              &lt;<a href="http://www.rfc-editor.org/info/rfc2119">http://www.rfc-editor.org/info/rfc2119</a>&gt;.

   [<a id="ref-RFC4648" name="ref-RFC4648">RFC4648</a>]  Josefsson, S., "The Base16, Base32, and Base64 Data
              Encodings", <a href="rfc4648.html">RFC 4648</a>, DOI 10.17487/RFC4648, October 2006,
              &lt;<a href="http://www.rfc-editor.org/info/rfc4648">http://www.rfc-editor.org/info/rfc4648</a>&gt;.



<span class="grey">Hu, et al.                   Standards Track                   [Page 12]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-13" id="page-13" name="page-13"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


   [<a id="ref-RFC5077" name="ref-RFC5077">RFC5077</a>]  Salowey, J., Zhou, H., Eronen, P., and H. Tschofenig,
              "Transport Layer Security (TLS) Session Resumption without
              Server-Side State", <a href="rfc5077.html">RFC 5077</a>, DOI 10.17487/RFC5077,
              January 2008, &lt;<a href="http://www.rfc-editor.org/info/rfc5077">http://www.rfc-editor.org/info/rfc5077</a>&gt;.

   [<a id="ref-RFC5246" name="ref-RFC5246">RFC5246</a>]  Dierks, T. and E. Rescorla, "The Transport Layer Security
              (TLS) Protocol Version 1.2", <a href="rfc5246.html">RFC 5246</a>,
              DOI 10.17487/RFC5246, August 2008,
              &lt;<a href="http://www.rfc-editor.org/info/rfc5246">http://www.rfc-editor.org/info/rfc5246</a>&gt;.

   [<a id="ref-RFC6234" name="ref-RFC6234">RFC6234</a>]  Eastlake 3rd, D. and T. Hansen, "US Secure Hash Algorithms
              (SHA and SHA-based HMAC and HKDF)", <a href="rfc6234.html">RFC 6234</a>,
              DOI 10.17487/RFC6234, May 2011,
              &lt;<a href="http://www.rfc-editor.org/info/rfc6234">http://www.rfc-editor.org/info/rfc6234</a>&gt;.

   [<a id="ref-RFC6335" name="ref-RFC6335">RFC6335</a>]  Cotton, M., Eggert, L., Touch, J., Westerlund, M., and S.
              Cheshire, "Internet Assigned Numbers Authority (IANA)
              Procedures for the Management of the Service Name and
              Transport Protocol Port Number Registry", <a href="https://tools.ietf.org/html/bcp165">BCP 165</a>,
              <a href="rfc6335.html">RFC 6335</a>, DOI 10.17487/RFC6335, August 2011,
              &lt;<a href="http://www.rfc-editor.org/info/rfc6335">http://www.rfc-editor.org/info/rfc6335</a>&gt;.

   [<a id="ref-RFC7120" name="ref-RFC7120">RFC7120</a>]  Cotton, M., "Early IANA Allocation of Standards Track Code
              Points", <a href="https://tools.ietf.org/html/bcp100">BCP 100</a>, <a href="rfc7120.html">RFC 7120</a>, DOI 10.17487/RFC7120, January
              2014, &lt;<a href="http://www.rfc-editor.org/info/rfc7120">http://www.rfc-editor.org/info/rfc7120</a>&gt;.

   [<a id="ref-RFC7469" name="ref-RFC7469">RFC7469</a>]  Evans, C., Palmer, C., and R. Sleevi, "Public Key Pinning
              Extension for HTTP", <a href="rfc7469.html">RFC 7469</a>, DOI 10.17487/RFC7469, April
              2015, &lt;<a href="http://www.rfc-editor.org/info/rfc7469">http://www.rfc-editor.org/info/rfc7469</a>&gt;.

   [<a id="ref-RFC7766" name="ref-RFC7766">RFC7766</a>]  Dickinson, J., Dickinson, S., Bellis, R., Mankin, A., and
              D. Wessels, "DNS Transport over TCP - Implementation
              Requirements", <a href="rfc7766.html">RFC 7766</a>, DOI 10.17487/RFC7766, March 2016,
              &lt;<a href="http://www.rfc-editor.org/info/rfc7766">http://www.rfc-editor.org/info/rfc7766</a>&gt;.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/9.2.%20%20Informative%20References"></a><a class="selflink" href="#section-9.2" name="section-9.2">9.2</a>.  Informative References</span>

   [<a id="ref-CONFIDENTIAL-DNS" name="ref-CONFIDENTIAL-DNS">CONFIDENTIAL-DNS</a>]
              Wijngaards, W. and G. Wiley, <a href="https://www.google.com/search?sitesearch=tools.ietf.org%2Fhtml%2F&amp;q=inurl:draft-+%22Confidential+DNS%22" style="text-decoration: none">"Confidential DNS"</a>, Work in
              Progress, <a href="https://tools.ietf.org/html/draft-wijngaards-dnsop-confidentialdns-03">draft-wijngaards-dnsop-confidentialdns-03</a>, March
              2015.

   [<a id="ref-DNSCRYPT-WEBSITE" name="ref-DNSCRYPT-WEBSITE">DNSCRYPT-WEBSITE</a>]
              Denis, F., "DNSCrypt", December 2015,
              &lt;<a href="https://www.dnscrypt.org/">https://www.dnscrypt.org/</a>&gt;.






<span class="grey">Hu, et al.                   Standards Track                   [Page 13]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-14" id="page-14" name="page-14"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


   [<a id="ref-DNSCurve" name="ref-DNSCurve">DNSCurve</a>] Dempsky, M., "DNSCurve: Link-Level Security for the Domain
              Name System", Work in Progress, <a href="https://tools.ietf.org/html/draft-dempsky-dnscurve-01">draft-dempsky-dnscurve-01</a>,
              February 2010.

   [<a id="ref-DNSoD" name="ref-DNSoD">DNSoD</a>]    Reddy, T., Wing, D., and P. Patil, "DNS over DTLS
              (DNSoD)", Work in Progress, <a href="https://tools.ietf.org/html/draft-ietf-dprive-dnsodtls-06">draft-ietf-dprive-dnsodtls-06</a>,
              April 2016.

   [<a id="ref-DNSSEC-TRIGGER" name="ref-DNSSEC-TRIGGER">DNSSEC-TRIGGER</a>]
              NLnet Labs, "Dnssec-Trigger", May 2014,
              &lt;<a href="https://www.nlnetlabs.nl/projects/dnssec-trigger/">https://www.nlnetlabs.nl/projects/dnssec-trigger/</a>&gt;.

   [<a id="ref-IPSECA" name="ref-IPSECA">IPSECA</a>]   Osterweil, E., Wiley, G., Okubo, T., Lavu, R., and A.
              Mohaisen, "Opportunistic Encryption with DANE Semantics
              and IPsec: IPSECA", Work in Progress,
              <a href="https://tools.ietf.org/html/draft-osterweil-dane-ipsec-03">draft-osterweil-dane-ipsec-03</a>, July 2015.

   [<a id="ref-RFC3234" name="ref-RFC3234">RFC3234</a>]  Carpenter, B. and S. Brim, "Middleboxes: Taxonomy and
              Issues", <a href="rfc3234.html">RFC 3234</a>, DOI 10.17487/RFC3234, February 2002,
              &lt;<a href="http://www.rfc-editor.org/info/rfc3234">http://www.rfc-editor.org/info/rfc3234</a>&gt;.

   [<a id="ref-RFC3646" name="ref-RFC3646">RFC3646</a>]  Droms, R., Ed., "DNS Configuration options for Dynamic
              Host Configuration Protocol for IPv6 (DHCPv6)", <a href="rfc3646.html">RFC 3646</a>,
              DOI 10.17487/RFC3646, December 2003,
              &lt;<a href="http://www.rfc-editor.org/info/rfc3646">http://www.rfc-editor.org/info/rfc3646</a>&gt;.

   [<a id="ref-RFC4033" name="ref-RFC4033">RFC4033</a>]  Arends, R., Austein, R., Larson, M., Massey, D., and S.
              Rose, "DNS Security Introduction and Requirements",
              <a href="rfc4033.html">RFC 4033</a>, DOI 10.17487/RFC4033, March 2005,
              &lt;<a href="http://www.rfc-editor.org/info/rfc4033">http://www.rfc-editor.org/info/rfc4033</a>&gt;.

   [<a id="ref-RFC7258" name="ref-RFC7258">RFC7258</a>]  Farrell, S. and H. Tschofenig, "Pervasive Monitoring Is an
              Attack", <a href="https://tools.ietf.org/html/bcp188">BCP 188</a>, <a href="rfc7258.html">RFC 7258</a>, DOI 10.17487/RFC7258, May
              2014, &lt;<a href="http://www.rfc-editor.org/info/rfc7258">http://www.rfc-editor.org/info/rfc7258</a>&gt;.

   [<a id="ref-RFC7413" name="ref-RFC7413">RFC7413</a>]  Cheng, Y., Chu, J., Radhakrishnan, S., and A. Jain, "TCP
              Fast Open", <a href="rfc7413.html">RFC 7413</a>, DOI 10.17487/RFC7413, December 2014,
              &lt;<a href="http://www.rfc-editor.org/info/rfc7413">http://www.rfc-editor.org/info/rfc7413</a>&gt;.

   [<a id="ref-RFC7435" name="ref-RFC7435">RFC7435</a>]  Dukhovni, V., "Opportunistic Security: Some Protection
              Most of the Time", <a href="rfc7435.html">RFC 7435</a>, DOI 10.17487/RFC7435,
              December 2014, &lt;<a href="http://www.rfc-editor.org/info/rfc7435">http://www.rfc-editor.org/info/rfc7435</a>&gt;.

   [<a id="ref-RFC7626" name="ref-RFC7626">RFC7626</a>]  Bortzmeyer, S., "DNS Privacy Considerations", <a href="rfc7626.html">RFC 7626</a>,
              DOI 10.17487/RFC7626, August 2015,
              &lt;<a href="http://www.rfc-editor.org/info/rfc7626">http://www.rfc-editor.org/info/rfc7626</a>&gt;.





<span class="grey">Hu, et al.                   Standards Track                   [Page 14]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-15" id="page-15" name="page-15"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


   [<a id="ref-RFC7828" name="ref-RFC7828">RFC7828</a>]  Wouters, P., Abley, J., Dickinson, S., and R. Bellis, "The
              edns-tcp-keepalive EDNS0 Option", <a href="rfc7828.html">RFC 7828</a>,
              DOI 10.17487/RFC7828, April 2016,
              &lt;<a href="http://www.rfc-editor.org/info/rfc7828">http://www.rfc-editor.org/info/rfc7828</a>&gt;.

   [<a id="ref-RFC7830" name="ref-RFC7830">RFC7830</a>]  Mayrhofer, A., "The EDNS(0) Padding Option", <a href="rfc7830.html">RFC 7830</a>,
              DOI 10.17487/RFC7830, May 2016,
              &lt;<a href="http://www.rfc-editor.org/info/rfc7830">http://www.rfc-editor.org/info/rfc7830</a>&gt;.

   [<a id="ref-TDNS" name="ref-TDNS">TDNS</a>]     Zhu, L., Hu, Z., Heidemann, J., Wessels, D., Mankin, A.,
              and N. Somaiya, "Connection-Oriented DNS to Improve
              Privacy and Security", 2015 IEEE Symposium on Security and
              Privacy (SP), DOI 10.1109/SP.2015.18,
              &lt;<a href="http://dx.doi.org/10.1109/SP.2015.18">http://dx.doi.org/10.1109/SP.2015.18</a>&gt;.

   [<a id="ref-TLS-DTLS-PROFILES" name="ref-TLS-DTLS-PROFILES">TLS-DTLS-PROFILES</a>]
              Dickinson, S., Gillmor, D., and T. Reddy, "Authentication
              and (D)TLS Profile for DNS-over-TLS and DNS-over-DTLS",
              Work in Progress, <a href="https://tools.ietf.org/html/draft-ietf-dprive-dtls-and-tls-profiles-01">draft-ietf-dprive-dtls-and-tls-</a>
              <a href="https://tools.ietf.org/html/draft-ietf-dprive-dtls-and-tls-profiles-01">profiles-01</a>, March 2016.

   [<a id="ref-TLS-FALSESTART" name="ref-TLS-FALSESTART">TLS-FALSESTART</a>]
              Langley, A., Modadugu, N., and B. Moeller, "Transport
              Layer Security (TLS) False Start", Work in Progress,
              <a href="https://tools.ietf.org/html/draft-ietf-tls-falsestart-02">draft-ietf-tls-falsestart-02</a>, May 2016.


























<span class="grey">Hu, et al.                   Standards Track                   [Page 15]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-16" id="page-16" name="page-16"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/Appendix%20A.%20%20Out-of-Band%20Key-Pinned%20Privacy%20Profile%20Example"></a><a class="selflink" href="#appendix-A" name="appendix-A">Appendix A</a>.  Out-of-Band Key-Pinned Privacy Profile Example</span>

   This section presents an example of how the out-of-band key-pinned
   privacy profile could work in practice based on a minimal pin set
   (two pins).

   A DNS client system is configured with an out-of-band key-pinned
   privacy profile from a network service, using a pin set containing
   two pins.  Represented in HTTP Public Key Pinning (HPKP) [<a href="rfc7469.html" title='"Public Key Pinning Extension for HTTP"'>RFC7469</a>]
   style, the pins are:

   o  pin-sha256="FHkyLhvI0n70E47cJlRTamTrnYVcsYdjUGbr79CfAVI="

   o  pin-sha256="dFSY3wdPU8L0u/8qECuz5wtlSgnorYV2f66L6GNQg6w="

   The client also configures the IP addresses of its expected DNS
   server: perhaps 192.0.2.3 and 2001:db8::2:4.

   The client connects to one of these addresses on TCP port 853 and
   begins the TLS handshake: negotiation of TLS 1.2 with a Diffie-
   Hellman key exchange.  The server sends a certificate message with a
   list of three certificates (A, B, and C) and signs the
   ServerKeyExchange message correctly with the public key found in
   certificate A.

   The client now takes the SHA-256 digest of the SPKI in cert A and
   compares it against both pins in the pin set.  If either pin matches,
   the verification is successful; the client continues with the TLS
   connection and can make its first DNS query.

   If neither pin matches the SPKI of cert A, the client verifies that
   cert A is actually issued by cert B.  If it is, it takes the SHA-256
   digest of the SPKI in cert B and compares it against both pins in the
   pin set.  If either pin matches, the verification is successful.
   Otherwise, it verifies that B was issued by C and then compares the
   pins against the digest of C's SPKI.

   If none of the SPKIs in the cryptographically valid chain of certs
   match any pin in the pin set, the client closes the connection with
   an error and marks the IP address as failed.











<span class="grey">Hu, et al.                   Standards Track                   [Page 16]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-17" id="page-17" name="page-17"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


Acknowledgments

   The authors would like to thank Stephane Bortzmeyer, John Dickinson,
   Brian Haberman, Christian Huitema, Shumon Huque, Simon Joseffson,
   Kim-Minh Kaplan, Simon Kelley, Warren Kumari, John Levine, Ilari
   Liusvaara, Bill Manning, George Michaelson, Eric Osterweil, Jinmei
   Tatuya, Tim Wicinski, and Glen Wiley for reviewing this
   specification.  They also thank Nikita Somaiya for early work on this
   idea.

   Work by Zi Hu, Liang Zhu, and John Heidemann on this document is
   partially sponsored by the U.S. Dept. of Homeland Security (DHS)
   Science and Technology Directorate, Homeland Security Advanced
   Research Projects Agency (HSARPA), Cyber Security Division, BAA
   11-01-RIKA and Air Force Research Laboratory, Information Directorate
   under agreement number FA8750-12-2-0344, and contract number
   D08PC75599.

Contributors

   The below individuals contributed significantly to the document:

   Sara Dickinson
   Sinodun Internet Technologies
   Magdalen Centre
   Oxford Science Park
   Oxford  OX4 4GA
   United Kingdom

   Email: sara@sinodun.com
   URI:   <a href="http://sinodun.com/">http://sinodun.com</a>


   Daniel Kahn Gillmor
   ACLU
   125 Broad Street, 18th Floor
   New York, NY  10004
   United States













<span class="grey">Hu, et al.                   Standards Track                   [Page 17]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-18" id="page-18" name="page-18"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


Authors' Addresses

   Zi Hu
   USC/Information Sciences Institute
   4676 Admiralty Way, Suite 1133
   Marina del Rey, CA  90292
   United States

   Phone: +1-213-587-1057
   Email: zihu@outlook.com


   Liang Zhu
   USC/Information Sciences Institute
   4676 Admiralty Way, Suite 1133
   Marina del Rey, CA  90292
   United States

   Phone: +1-310-448-8323
   Email: liangzhu@usc.edu


   John Heidemann
   USC/Information Sciences Institute
   4676 Admiralty Way, Suite 1001
   Marina del Rey, CA  90292
   United States

   Phone: +1-310-822-1511
   Email: johnh@isi.edu


   Allison Mankin
   Independent

   Phone: +1-301-728-7198
   Email: Allison.mankin@gmail.com


   Duane Wessels
   Verisign Labs
   12061 Bluemont Way
   Reston, VA  20190
   United States

   Phone: +1-703-948-3200
   Email: dwessels@verisign.com




<span class="grey">Hu, et al.                   Standards Track                   [Page 18]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-19" id="page-19" name="page-19"> </a>
<span class="grey"><a href="rfc7858.html">RFC 7858</a>                      DNS over TLS                      May 2016</span>


   Paul Hoffman
   ICANN

   Email: paul.hoffman@icann.org















































Hu, et al.                   Standards Track                   [Page 19]

</pre><br/>
    <span class="noprint"><small><small>Html markup produced by rfcmarkup 1.127, available from
      <a href="https://tools.ietf.org/tools/rfcmarkup/">https://tools.ietf.org/tools/rfcmarkup/</a>
    </small></small></span>
  </div>




</body><!-- Mirrored from tools.ietf.org/html/rfc7858 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 14 Aug 2018 13:55:27 GMT --></html>