<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><!-- Mirrored from tools.ietf.org/html/rfc5589 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Mar 2018 23:18:35 GMT --><!-- Added by HTTrack --><head><meta content="text/html;charset=utf-8" http-equiv="content-type"/><!-- /Added by HTTrack -->

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <meta content="index,follow" name="robots"/>
    <meta content="rfcmarkup version 1.126" name="creator"/>
    <link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/>
<meta content="urn:ietf:rfc:5589" name="DC.Identifier"/>
<meta content="This document describes providing Call Transfer capabilities in the
Session Initiation Protocol (SIP). SIP extensions such as REFER and
Replaces are used to provide a number of transfer services including
blind transfer, consultative transfer, and attended transfer. This
work is part of the SIP multiparty call control framework." name="DC.Description.Abstract"/>
<meta content="Johnston, Alan" name="DC.Creator"/>
<meta content="Sparks, Robert J." name="DC.Creator"/>
<meta content="June, 2009" name="DC.Date.Issued"/>
<meta content="Session Initiation Protocol Call Control - Transfer" name="DC.Title"/>

    <link href="https://tools.ietf.org/images/rfc.png" rel="icon" type="image/png"/>
    <link href="https://tools.ietf.org/images/rfc.png" rel="shortcut icon" type="image/png"/>
    <title>RFC 5589 - Session Initiation Protocol Call Control - Transfer</title>
    
    
    <style type="text/css">
	@media only screen 
	  and (min-width: 992px)
	  and (max-width: 1199px) {
	    body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 768px)
	  and (max-width: 991px) {
            body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 480px)
	  and (max-width: 767px) {
            body { font-size: 11pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (max-width: 479px) {
            body { font-size: 8pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-device-width : 375px) 
	  and (max-device-width : 667px) {
            body { font-size: 9.5pt; }
            div.content { width: 96ex; margin: 0 1px; }
        }
	@media only screen 
	  and (min-device-width: 1200px) {
            body { font-size: 10pt; margin: 0 4em; }
            div.content { width: 96ex; margin: 0; }
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        a.selflink {
          color: black;
          text-decoration: none;
        }
        @media print {
            body {
                font-family: monospace;
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 1em;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>                   <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>                     <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>             <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>              <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td>      <td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td>         <td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard (old designation):</td> <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Internet Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>                  <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>                  <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
  <div class="content">
   <div style="height: 13px;">
      <div class="pre noprint docinfo bgmagenta" onclick="showElem('legend');" onmouseout="hideElem('legend')" onmouseover="this.style.cursor='pointer';" style="height: 6px; position: absolute;" title="Click for colour legend.">                                                                        </div>
      <div class="docinfo noprint pre legend" id="legend" onmouseout="hideElem('legend');" onmouseover="showElem('legend');" style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; ">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="index.html" title="Document search and retrieval page">Docs</a>] [<a href="https://tools.ietf.org/rfc/rfc5589.txt" title="Plaintext version of this document">txt</a>|<a href="https://tools.ietf.org/pdf/rfc5589" title="PDF version of this document">pdf</a>] [<a href="https://tools.ietf.org/html/draft-ietf-sipping-cc-transfer" title="draft-ietf-sipping-cc-transfer">draft-ietf-sipp...</a>] [<a href="https://datatracker.ietf.org/doc/rfc5589" title="IESG Datatracker information for this document">Tracker</a>] [<a href="https://tools.ietf.org/rfcdiff?difftype=--hwdiff&amp;url2=rfc5589" title="Inline diff (wdiff)">Diff1</a>] [<a href="https://tools.ietf.org/rfcdiff?url2=rfc5589" title="Side-by-side diff">Diff2</a>] [<a href="https://www.rfc-editor.org/errata_search.php?rfc=5589">Errata</a>]</span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<span class="pre noprint docinfo">                                                   BEST CURRENT PRACTICE</span><br/>
<span class="pre noprint docinfo">                                                            <span style="color: #C00;">Errata Exist</span></span><br/>
<pre>Network Working Group                                          R. Sparks
Request for Comments: 5589                                       Tekelec
BCP: 149                                                A. Johnston, Ed.
Category: Best Current Practice                                    Avaya
                                                               D. Petrie
                                                               SIPez LLC
                                                               June 2009


       <span class="h1">Session Initiation Protocol (SIP) Call Control - Transfer</span>

Status of This Memo

   This document specifies an Internet Best Current Practices for the
   Internet Community, and requests discussion and suggestions for
   improvements.  Distribution of this memo is unlimited.


Copyright Notice

   Copyright (c) 2009 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="https://tools.ietf.org/html/bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents in effect on the date of
   publication of this document (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>).
   Please review these documents carefully, as they describe your rights
   and restrictions with respect to this document.

   This document may contain material from IETF Documents or IETF
   Contributions published or made publicly available before November
   10, 2008.  The person(s) controlling the copyright in some of this
   material may not have granted the IETF Trust the right to allow
   modifications of such material outside the IETF Standards Process.
   Without obtaining an adequate license from the person(s) controlling
   the copyright in such materials, this document may not be modified
   outside the IETF Standards Process, and derivative works of it may
   not be created outside the IETF Standards Process, except to format
   it for publication as an RFC or to translate it into languages other
   than English.

Abstract

   This document describes providing Call Transfer capabilities in the
   Session Initiation Protocol (SIP).  SIP extensions such as REFER and
   Replaces are used to provide a number of transfer services including
   blind transfer, consultative transfer, and attended transfer.  This
   work is part of the SIP multiparty call control framework.



<span class="grey">Sparks, et al.           Best Current Practice                  [Page 1]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-2" id="page-2" name="page-2"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


Table of Contents

   <a href="#section-1">1</a>. Overview ........................................................<a href="#page-3">3</a>
   <a href="#section-2">2</a>. Actors and Roles ................................................<a href="#page-3">3</a>
   <a href="#section-3">3</a>. Terminology .....................................................<a href="#page-4">4</a>
   <a href="#section-4">4</a>. Requirements ....................................................<a href="#page-4">4</a>
   <a href="#section-5">5</a>. Using REFER to Achieve Call Transfer ............................<a href="#page-5">5</a>
   <a href="#section-6">6</a>. Basic Transfer ..................................................<a href="#page-6">6</a>
      <a href="#section-6.1">6.1</a>. Successful Transfer ........................................<a href="#page-8">8</a>
      <a href="#section-6.2">6.2</a>. Transfer with Dialog Reuse ................................<a href="#page-11">11</a>
      <a href="#section-6.3">6.3</a>. Failed Transfer ...........................................<a href="#page-15">15</a>
           <a href="#section-6.3.1">6.3.1</a>. Target Busy ........................................<a href="#page-16">16</a>
           <a href="#section-6.3.2">6.3.2</a>. Transfer Target Does Not Answer ....................<a href="#page-17">17</a>
   <a href="#section-7">7</a>. Transfer with Consultation Hold ................................<a href="#page-18">18</a>
      <a href="#section-7.1">7.1</a>. Exposing Transfer Target ..................................<a href="#page-18">18</a>
      <a href="#section-7.2">7.2</a>. Protecting Transfer Target ................................<a href="#page-19">19</a>
      <a href="#section-7.3">7.3</a>. Attended Transfer .........................................<a href="#page-24">24</a>
      <a href="#section-7.4">7.4</a>. Recovery When One Party Does Not Support REFER ............<a href="#page-28">28</a>
      7.5. Attended Transfer When Contact URI Is Not Known to
           Route to a User Agent .....................................<a href="#page-29">29</a>
      <a href="#section-7.6">7.6</a>. Semi-Attended Transfer ....................................<a href="#page-37">37</a>
      <a href="#section-7.7">7.7</a>. Attended Transfer Fallback to Basic Transfer ..............<a href="#page-42">42</a>
   <a href="#section-8">8</a>. Transfer with Referred-By ......................................<a href="#page-45">45</a>
   <a href="#section-9">9</a>. Transfer as an Ad Hoc Conference ...............................<a href="#page-49">49</a>
   <a href="#section-10">10</a>. Transfer with Multiple Parties ................................<a href="#page-52">52</a>
   <a href="#section-11">11</a>. Gateway Transfer Issues .......................................<a href="#page-54">54</a>
      <a href="#section-11.1">11.1</a>. Coerce Gateway Hairpins to the Same Gateway ..............<a href="#page-54">54</a>
      <a href="#section-11.2">11.2</a>. Consultative Turned Blind Gateway Glare ..................<a href="#page-55">55</a>
   <a href="#section-12">12</a>. Security Considerations .......................................<a href="#page-55">55</a>
   <a href="#section-13">13</a>. Acknowledgments ...............................................<a href="#page-56">56</a>
   <a href="#section-14">14</a>. References ....................................................<a href="#page-56">56</a>
      <a href="#section-14.1">14.1</a>. Normative References .....................................<a href="#page-56">56</a>
      <a href="#section-14.2">14.2</a>. Informative References ...................................<a href="#page-57">57</a>


















<span class="grey">Sparks, et al.           Best Current Practice                  [Page 2]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-3" id="page-3" name="page-3"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/1.%20%20Overview"></a><a class="selflink" href="#section-1" name="section-1">1</a>.  Overview</span>

   This document describes providing Call Transfer capabilities and
   requirements in SIP [<a href="rfc3261.html" title='"SIP: Session Initiation Protocol"'>RFC3261</a>].  This work is part of the multiparty
   call control framework [<a href="#ref-CC-FRMWRK" title='"A Call Control and Multi-party usage framework for the Session Initiation Protocol (SIP)"'>CC-FRMWRK</a>].

   The mechanisms discussed here are most closely related to
   traditional, basic, and consultation hold transfers.

   This document details the use of the REFER method [<a href="rfc3515.html" title='"The Session Initiation Protocol (SIP) Refer Method"'>RFC3515</a>] and
   Replaces [<a href="rfc3891.html" title='"The Session Initiation Protocol (SIP) "'>RFC3891</a>] header field to achieve call transfer.

   A User Agent (UA) that fully supports the transfer mechanisms
   described in this document supports REFER [<a href="rfc3515.html" title='"The Session Initiation Protocol (SIP) Refer Method"'>RFC3515</a>] and Replaces
   [<a href="rfc3891.html" title='"The Session Initiation Protocol (SIP) "'>RFC3891</a>] in addition to <a href="rfc3261.html">RFC 3261</a> [<a href="rfc3261.html" title='"SIP: Session Initiation Protocol"'>RFC3261</a>].  A User Agent should use
   a Contact URI that meets the requirements in Section 8.1.1.8 of <a href="rfc3261.html">RFC</a>
   <a href="rfc3261.html">3261</a>.  A compliant User Agent supports the Target-Dialog header field
   [<a href="rfc4538.html" title='"Request Authorization through Dialog Identification in the Session Initiation Protocol (SIP)"'>RFC4538</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/2.%20%20Actors%20and%20Roles"></a><a class="selflink" href="#section-2" name="section-2">2</a>.  Actors and Roles</span>

   There are three actors in a given transfer event, each playing one of
   the following roles:

   Transferee:        the party being transferred to the Transfer
                      Target.

   Transferor:        the party initiating the transfer.

   Transfer Target:   the new party being introduced into a call with
                      the Transferee.

   The following roles are used to describe transfer requirements and
   scenarios:

   Originator:        wishes to place a call to the Recipient.  This
                      actor is the source of the first INVITE in a
                      session, to either a Facilitator or a Screener.

   Facilitator:       receives a call or out-of-band request from the
                      Originator, establishes a call to the Recipient
                      through the Screener, and connects the Originator
                      to the Recipient.  Typically, a Facilitator acts
                      on behalf of the Originator.







<span class="grey">Sparks, et al.           Best Current Practice                  [Page 3]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-4" id="page-4" name="page-4"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   Screener:          receives a call ultimately intended for the
                      Recipient and transfers the calling party to the
                      Recipient if appropriate.  Typically, a Screener
                      acts on behalf of the Recipient.

   Recipient:         the party to which the Originator is ultimately
                      connected.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/3.%20%20Terminology"></a><a class="selflink" href="#section-3" name="section-3">3</a>.  Terminology</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <a href="https://tools.ietf.org/html/bcp14">BCP 14</a>, <a href="rfc2119.html">RFC 2119</a>
   [<a href="rfc2119.html" title='"Key words for use in RFCs to Indicate Requirement Levels"'>RFC2119</a>].

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/4.%20%20Requirements"></a><a class="selflink" href="#section-4" name="section-4">4</a>.  Requirements</span>

   1.  Any party in a SIP session must be able to transfer any other
       party in that session at any point in that session.

   2.  The Transferor and the Transferee must not be removed from a
       session as part of a transfer transaction.

            At first glance, requirement 2 may seem to indicate
            that the user experience in a transfer must be
            significantly different from what a current Private Branch
            Exchange (PBX) or Centrex user expects.  As the call flows
            in this document show, this is not the case.  A client may
            preserve the current experience.  In fact, without
            this requirement, some forms of the current
            experience (ringback on transfer failure,
            for instance) will be lost.

   3.  The Transferor must know whether or not the transfer was
       successful.

   4.  The Transferee must be able to replace an existing dialog with a
       new dialog.

   5.  The Transferor and Transferee should indicate their support for
       the primitives required to achieve transfer.

   6.  The Transferor should provide the Transfer Target and Transferee
       with information about the nature and progress of the transfer
       operation being attempted.






<span class="grey">Sparks, et al.           Best Current Practice                  [Page 4]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-5" id="page-5" name="page-5"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


            To meet this requirement, the transfer operation can
            be modeled as an ad hoc conference between three
            parties, as discussed in <a href="#section-9">Section 9</a>.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/5.%20%20Using%20REFER%20to%20Achieve%20Call%20Transfer"></a><a class="selflink" href="#section-5" name="section-5">5</a>.  Using REFER to Achieve Call Transfer</span>

   A REFER [<a href="rfc3515.html" title='"The Session Initiation Protocol (SIP) Refer Method"'>RFC3515</a>] can be issued by the Transferor to cause the
   Transferee to issue an INVITE to the Transfer Target.  Note that a
   successful REFER transaction does not terminate the session between
   the Transferor and the Transferee.  If those parties wish to
   terminate their session, they must do so with a subsequent BYE
   request.  The media negotiated between the transferee and the
   Transfer Target is not affected by the media that had been negotiated
   between the Transferor and the Transferee.  In particular, the INVITE
   issued by the Transferee will have the same Session Description
   Protocol (SDP) body it would have if the Transferee had initiated
   that INVITE on its own.  Further, the disposition of the media
   streams between the Transferor and the Transferee is not altered by
   the REFER method.

   Agents may alter a session's media through additional signaling.  For
   example, they may make use of the SIP hold re-INVITE [<a href="rfc3261.html" title='"SIP: Session Initiation Protocol"'>RFC3261</a>] or
   conferencing extensions described in the conferencing framework
   [<a href="rfc4353.html" title='"A Framework for Conferencing with the Session Initiation Protocol (SIP)"'>RFC4353</a>].

   To perform the transfer, the Transferor and Transferee could reuse an
   existing dialog established by an INVITE to send the REFER.  This
   would result in a single dialog shared by two uses -- an invite usage
   and a subscription usage.  The call flows for this are shown in
   detail in <a href="#section-6.2">Section 6.2</a>.  However, the approach described in this
   document is to avoid dialog reuse.  The issues and difficulties
   associated with dialog reuse are described in [<a href="rfc5057.html" title='"Multiple Dialog Usages in the Session Initiation Protocol"'>RFC5057</a>].

   Motivations for reusing the existing dialog include:

   1.  There was no way to ensure that a REFER on a new dialog would
       reach the particular endpoint involved in a transfer.  Many
       factors, including details of implementations and changes in
       proxy routing between an INVITE and a REFER could cause the REFER
       to be sent to the wrong place.  Sending the REFER down the
       existing dialog ensured it got to the endpoint to which we were
       already talking.

   2.  It was unclear how to associate an existing invite usage with a
       REFER arriving on a new dialog, where it was completely obvious
       what the association was when the REFER came on the INVITE
       usage's dialog.




<span class="grey">Sparks, et al.           Best Current Practice                  [Page 5]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-6" id="page-6" name="page-6"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   3.  There were concerns with authorizing out-of-dialog REFERs.  The
       authorization policy for REFER in most implementations piggybacks
       on the authorization policy for INVITE (which is, in most cases,
       based simply on "I placed or answered this call").

   Globally Routable UA URIs (GRUUs) [<a href="#ref-SIP-GRUU" title='"Obtaining and Using Globally Routable User Agent (UA) URIs (GRUU) in the Session Initiation Protocol (SIP)"'>SIP-GRUU</a>] can be used to address
   problem 1.  Problem 2 can be addressed using the Target-Dialog header
   field defined in [<a href="rfc4538.html" title='"Request Authorization through Dialog Identification in the Session Initiation Protocol (SIP)"'>RFC4538</a>].  In the immediate term, this solution to
   problem 2 allows the existing REFER authorization policy to be
   reused.

   As a result, if the Transferee supports the target-dialog extension
   and the Transferor knows the Contact URI is routable outside the
   dialog, the REFER SHOULD be sent in a new dialog.  If the nature of
   the Contact URI is not known or if support for the target-dialog
   extension is not known, the REFER SHOULD be sent inside the existing
   dialog.  A Transferee MUST be prepared to receive a REFER either
   inside or outside a dialog.  One way that a Transferor could know
   that a Contact URI is routable outside a dialog is by validation
   (e.g., sending an OPTIONS and receiving a response) or if it
   satisfies the properties described in the GRUU specification
   [<a href="#ref-SIP-GRUU" title='"Obtaining and Using Globally Routable User Agent (UA) URIs (GRUU) in the Session Initiation Protocol (SIP)"'>SIP-GRUU</a>].

   This document does not prescribe the flows and examples precisely as
   they are shown, but rather the flows illustrate the principles for
   best practice for the transfer feature.  The call flows represent
   well-reviewed examples of SIP usage to implement transfer with REFER,
   which are Best Common Practice according to IETF consensus.

   In most of the following examples, the Transferor is in the
   atlanta.example.com domain, the Transferee is in the
   biloxi.example.com, and the Transfer Target is in the
   chicago.example.com domain.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/6.%20%20Basic%20Transfer"></a><a class="selflink" href="#section-6" name="section-6">6</a>.  Basic Transfer</span>

   Basic Transfer consists of the Transferor providing the Transfer
   Target's contact to the Transferee.  The Transferee attempts to
   establish a session using that contact and reports the results of
   that attempt to the Transferor.  The signaling relationship between
   the Transferor and Transferee is not terminated, so the call is
   recoverable if the Transfer Target cannot be reached.  Note that the
   Transfer Target's contact information has been exposed to the
   Transferee.  The provided contact can be used to make new calls in
   the future.






<span class="grey">Sparks, et al.           Best Current Practice                  [Page 6]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-7" id="page-7" name="page-7"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   The participants in a basic transfer SHOULD indicate support for the
   REFER and NOTIFY methods in Allow header fields in INVITE, 200 OK to
   INVITE, and OPTIONS messages.  Participants SHOULD also indicate
   support for Target-Dialog in the Supported header field.

   The diagrams below show the first line of each message.  The first
   column of the figure shows the dialog used in that particular
   message.  In these diagrams, media is managed through re-INVITE
   holds, but other mechanisms (mixing multiple media streams at the UA
   or using the conferencing extensions, for example) are valid.
   Selected message details are shown labeled as message F1, F2, etc.

   Each of the flows below shows the dialog between the Transferor and
   the Transferee remaining connected (on hold) during the REFER
   process.  While this provides the greatest flexibility for recovery
   from failure, it is not necessary.  If the Transferor's agent does
   not wish to participate in the remainder of the REFER process and has
   no intention of assisting with recovery from transfer failure, it
   could emit a BYE to the Transferee as soon as the REFER transaction
   completes.  This flow is sometimes known as "unattended transfer" or
   "blind transfer".

   Figure 1 shows transfer when the Transferee utilizes a GRUU and
   supports the target-dialog extension and indicates this to the
   Transferor.  As a result, the Transferor sends the REFER outside the
   INVITE dialog.  The Transferee is able to match this REFER to the
   existing dialog using the Target-Dialog header field in the refer
   which references the existing dialog.























<span class="grey">Sparks, et al.           Best Current Practice                  [Page 7]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-8" id="page-8" name="page-8"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.1.%20%20Successful%20Transfer"></a><a class="selflink" href="#section-6.1" name="section-6.1">6.1</a>.  Successful Transfer</span>

             Transferor           Transferee             Transfer
                  |                    |                  Target
                  |          INVITE F1 |                    |
          dialog1 |&lt;-------------------|                    |
                  |          200 OK F2 |                    |
          dialog1 |-------------------&gt;|                    |
                  |            ACK     |                    |
          dialog1 |&lt;-------------------|                    |
                  |  INVITE (hold)     |                    |
          dialog1 |-------------------&gt;|                    |
                  |  200 OK            |                    |
          dialog1 |&lt;-------------------|                    |
                  |  ACK               |                    |
          dialog1 |-------------------&gt;|                    |
                  |  REFER F3 (Target-Dialog:1)             |
          dialog2 |-------------------&gt;|                    |
                  |  202 Accepted      |                    |
          dialog2 |&lt;-------------------|                    |
                  | NOTIFY (100 Trying) F4                  |
          dialog2 |&lt;-------------------|                    |
                  |            200 OK  |                    |
          dialog2 |-------------------&gt;|                    |
                  |                    |  INVITE F5         |
          dialog3 |                    |-------------------&gt;|
                  |                    |  200 OK            |
          dialog3 |                    |&lt;-------------------|
                  |                    |  ACK               |
          dialog3 |                    |-------------------&gt;|
                  |  NOTIFY (200 OK) F6|                    |
          dialog2 |&lt;-------------------|                    |
                  |            200 OK  |                    |
          dialog2 |-------------------&gt;|                    |
                  |  BYE               |                    |
          dialog1 |-------------------&gt;|                    |
                  |  200 OK            |                    |
          dialog1 |&lt;-------------------|                    |
                  |                    |             BYE    |
          dialog3 |                    |&lt;-------------------|
                  |                    |             200 OK |
          dialog3 |                    |-------------------&gt;|

   Figure 1: Basic Transfer Call Flow







<span class="grey">Sparks, et al.           Best Current Practice                  [Page 8]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-9" id="page-9" name="page-9"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F1 INVITE Transferee -&gt; Transferor

   INVITE sips:transferor@atlanta.example.com SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   Max-Forwards: 70
   To: &lt;sips:transferor@atlanta.example.com&gt;
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
   Call-ID: 090459243588173445
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces, gruu, tdialog
   Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   Content-Type: application/sdp
   Content-Length: ...


   F2 200 OK Transferor -&gt; Transferee

   SIP/2.0 200 OK
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   To: &lt;sips:transferor@atlanta.example.com&gt;;tag=31kdl4i3k
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
   Call-ID: 090459243588173445
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces, gruu, tdialog
   Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
   Content-Type: application/sdp
   Content-Length: ...


   F3 REFER Transferor -&gt; Transferee

   REFER sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha SIP/2.0
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKna9
   Max-Forwards: 70
   To: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
   Call-ID: a84b4c76e66710
   CSeq: 314159 REFER
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: gruu, replaces, tdialog
   Require: tdialog
   Refer-To: &lt;sips:transfertarget@chicago.example.com&gt;
   Target-Dialog: 090459243588173445;local-tag=7553452
    ;remote-tag=31kdl4i3k
   Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
   Content-Length: 0



<span class="grey">Sparks, et al.           Best Current Practice                  [Page 9]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-10" id="page-10" name="page-10"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F4 NOTIFY Transferee -&gt; Transferor

   NOTIFY sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   Max-Forwards: 70
   To: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
   From: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
    ;tag=a6c85cf
   Call-ID: a84b4c76e66710
   CSeq: 73 NOTIFY
   Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces, tdialog
   Event: refer
   Subscription-State: active;expires=60
   Content-Type: message/sipfrag
   Content-Length: ...

   SIP/2.0 100 Trying


   F5 INVITE Transferee -&gt; Transfer Target

   INVITE sips:transfertarget@chicago.example.com SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas41234
   Max-Forwards: 70
   To: &lt;sips:transfertarget@chicago.example.com&gt;
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=j3kso3iqhq
   Call-ID: 90422f3sd23m4g56832034
   CSeq: 521 REFER
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces, gruu, tdialog
   Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   Content-Type: application/sdp
   Content-Length: ...
















<span class="grey">Sparks, et al.           Best Current Practice                 [Page 10]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-11" id="page-11" name="page-11"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F6 NOTIFY Transferee -&gt; Transferor

   NOTIFY sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   Max-Forwards: 70
   To: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
   From: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
    ;tag=a6c85cf
   Call-ID: a84b4c76e66710
   CSeq: 74 NOTIFY
   Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces, tdialog
   Event: refer
   Subscription-State: terminated;reason=noresource
   Content-Type: message/sipfrag
   Content-Length: ...

   SIP/2.0 200 OK

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.2.%20%20Transfer%20with%20Dialog%20Reuse"></a><a class="selflink" href="#section-6.2" name="section-6.2">6.2</a>.  Transfer with Dialog Reuse</span>

   In this scenario, the Transferor does not know the properties of the
   Transferee's Contact URI or does not know that the Transferee
   supports the Target-Dialog header field.  As a result, the REFER is
   sent inside the INVITE dialog.

























<span class="grey">Sparks, et al.           Best Current Practice                 [Page 11]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-12" id="page-12" name="page-12"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


             Transferor           Transferee             Transfer
                  |                    |                  Target
                  |         INVITE F1  |                    |
          dialog1 |&lt;-------------------|                    |
                  |         200 OK F2  |                    |
          dialog1 |-------------------&gt;|                    |
                  |            ACK     |                    |
          dialog1 |&lt;-------------------|                    |
                  |  INVITE (hold)     |                    |
          dialog1 |-------------------&gt;|                    |
                  |  200 OK            |                    |
          dialog1 |&lt;-------------------|                    |
                  |  ACK               |                    |
          dialog1 |-------------------&gt;|                    |
                  |  REFER F3          |                    |
          dialog1 |-------------------&gt;|                    |
                  |  202 Accepted      |                    |
          dialog1 |&lt;-------------------|                    |
                  | NOTIFY (100 Trying) F4                  |
          dialog1 |&lt;-------------------|                    |
                  |            200 OK  |                    |
          dialog1 |-------------------&gt;|                    |
                  |                    |  INVITE F5         |
          dialog2 |                    |-------------------&gt;|
                  |                    |  200 OK            |
          dialog2 |                    |&lt;-------------------|
                  |                    |  ACK               |
          dialog2 |                    |-------------------&gt;|
                  |  NOTIFY (200 OK) F6|                    |
          dialog1 |&lt;-------------------|                    |
                  |            200 OK  |                    |
          dialog1 |-------------------&gt;|                    |
                  |  BYE               |                    |
          dialog1 |-------------------&gt;|                    |
                  |  200 OK            |                    |
          dialog1 |&lt;-------------------|                    |
                  |                    |             BYE    |
          dialog2 |                    |&lt;-------------------|
                  |                    |             200 OK |
          dialog2 |                    |-------------------&gt;|

   Figure 2: Transfer with Dialog Reuse









<span class="grey">Sparks, et al.           Best Current Practice                 [Page 12]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-13" id="page-13" name="page-13"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F1 INVITE Transferee -&gt; Transferor

   INVITE sips:transferor@atlanta.example.com SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   Max-Forwards: 70
   To: &lt;sips:transferor@atlanta.example.com&gt;
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
   Call-ID: 090459243588173445
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces
   Contact: &lt;sips:transferee@192.0.2.4&gt;
   Content-Type: application/sdp
   Content-Length: ...


   F2 200 OK Transferor -&gt; Transferee

   SIP/2.0 200 OK
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   To: &lt;sips:transferor@atlanta.example.com&gt;;tag=31kdl4i3k
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
   Call-ID: 090459243588173445
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: gruu, replaces
   Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
   Content-Type: application/sdp
   Content-Length: ...


   F3 REFER Transferor -&gt; Transferee

   REFER sips:transferee@192.0.2.4 SIP/2.0
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKna9
   Max-Forwards: 70
   To: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=31kdl4i3k
   Call-ID: 090459243588173445
   CSeq: 314159 REFER
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces
   Refer-To: &lt;sips:transfertarget@chicago.example.com&gt;
   Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
   Content-Length: 0






<span class="grey">Sparks, et al.           Best Current Practice                 [Page 13]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-14" id="page-14" name="page-14"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F4 NOTIFY Transferee -&gt; Transferor

   NOTIFY sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   Max-Forwards: 70
   To: &lt;sips:transferor@atlanta.example.com&gt;;tag=31kdl4i3k
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
   Call-ID: 090459243588173445
   CSeq: 29888 INVITE
   Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces
   Event: refer
   Subscription-State: active;expires=60
   Content-Type: message/sipfrag
   Content-Length: ...

   SIP/2.0 100 Trying


   F5 INVITE Transferee -&gt; Transfer Target

   INVITE sips:transfertarget@chicago.example.com SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas41234
   Max-Forwards: 70
   To: &lt;sips:transfertarget@chicago.example.com&gt;
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=j3kso3iqhq
   Call-ID: 90422f3sd23m4g56832034
   CSeq: 521 REFER
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces
   Contact: &lt;sips:transferee@192.0.2.4&gt;
   Content-Type: application/sdp
   Content-Length: ...

















<span class="grey">Sparks, et al.           Best Current Practice                 [Page 14]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-15" id="page-15" name="page-15"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F6 NOTIFY Transferee -&gt; Transferor

   NOTIFY sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   Max-Forwards: 70
   To: &lt;sips:transferor@atlanta.example.com&gt;;tag=31kdl4i3k
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
   Call-ID: 090459243588173445
   CSeq: 29889 INVITE
   Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces
   Event: refer
   Subscription-State: terminated;reason=noresource
   Content-Type: message/sipfrag
   Content-Length: ...

   SIP/2.0 200 OK

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.3.%20%20Failed%20Transfer"></a><a class="selflink" href="#section-6.3" name="section-6.3">6.3</a>.  Failed Transfer</span>

   This section shows examples of failed transfer attempts.  After the
   transfer failure occurs, the Transferor takes the Transferee off hold
   and resumes the session.



























<span class="grey">Sparks, et al.           Best Current Practice                 [Page 15]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-16" id="page-16" name="page-16"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/6.3.1.%20%20Target%20Busy"></a><a class="selflink" href="#section-6.3.1" name="section-6.3.1">6.3.1</a>.  Target Busy</span>

             Transferor           Transferee             Transfer
                  |                    |                  Target
                  |                    |                    |
                  |            INVITE  |                    |
          dialog1 |&lt;-------------------|                    |
                  |            200 OK  |                    |
          dialog1 |-------------------&gt;|                    |
                  |            ACK     |                    |
          dialog1 |&lt;-------------------|                    |
                  |  INVITE (hold)     |                    |
          dialog1 |-------------------&gt;|                    |
                  |  200 OK            |                    |
          dialog1 |&lt;-------------------|                    |
                  |  ACK               |                    |
          dialog1 |-------------------&gt;|                    |
                  |  REFER (Target-Dialog:1)                |
          dialog2 |-------------------&gt;|                    |
                  |  202 Accepted      |                    |
          dialog2 |&lt;-------------------|                    |
                  | NOTIFY (100 Trying)|                    |
          dialog2 |&lt;-------------------|                    |
                  |            200 OK  |                    |
          dialog2 |-------------------&gt;|                    |
                  |                    |  INVITE            |
          dialog3 |                    |-------------------&gt;|
                  |                    |  486 Busy Here     |
          dialog3 |                    |&lt;-------------------|
                  |                    |  ACK               |
          dialog3 |                    |-------------------&gt;|
                  | NOTIFY (486 Busy Here)                  |
          dialog2 |&lt;-------------------|                    |
                  |            200 OK  |                    |
          dialog2 |-------------------&gt;|                    |
                  |  INVITE (unhold)   |                    |
          dialog1 |-------------------&gt;|                    |
                  |  200 OK            |                    |
          dialog1 |&lt;-------------------|                    |
                  |  ACK               |                    |
          dialog1 |-------------------&gt;|                    |
                  |  BYE               |                    |
          dialog1 |-------------------&gt;|                    |
                  |  200 OK            |                    |
          dialog1 |&lt;-------------------|                    |

   Figure 3: Failed Transfer - Target Busy




<span class="grey">Sparks, et al.           Best Current Practice                 [Page 16]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-17" id="page-17" name="page-17"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/6.3.2.%20%20Transfer%20Target%20Does%20Not%20Answer"></a><a class="selflink" href="#section-6.3.2" name="section-6.3.2">6.3.2</a>.  Transfer Target Does Not Answer</span>

             Transferor           Transferee             Transfer
                  |                    |                  Target
                  |            INVITE  |                    |
          dialog1 |&lt;-------------------|                    |
                  |            200 OK  |                    |
          dialog1 |-------------------&gt;|                    |
                  |            ACK     |                    |
          dialog1 |&lt;-------------------|                    |
                  |  INVITE (hold)     |                    |
          dialog1 |-------------------&gt;|                    |
                  |  200 OK            |                    |
          dialog1 |&lt;-------------------|                    |
                  |  ACK               |                    |
          dialog1 |-------------------&gt;|                    |
                  |  REFER             |                    |
          dialog2 |-------------------&gt;|                    |
                  |  202 Accepted      |                    |
          dialog2 |&lt;-------------------|                    |
                  | NOTIFY (100 Trying)|                    |
          dialog2 |&lt;-------------------|                    |
                  |            200 OK  |                    |
          dialog2 |-------------------&gt;|                    |
                  |                    |  INVITE            |
          dialog3 |                    |-------------------&gt;|
                  |                    |  180 Ringing       |
          dialog3 |                    |&lt;-------------------|
                  |          (Transferee gets tired of waiting)
                  |                    |  CANCEL            |
          dialog3 |                    |-------------------&gt;|
                  |                    |  200 OK (CANCEL)   |
          dialog3 |                    |&lt;-------------------|
                  |                 487 Request Cancelled (INVITE)
          dialog3 |                    |&lt;-------------------|
                  |                    |  ACK               |
          dialog3 |                    |-------------------&gt;|
                  |    NOTIFY (487 Request Cancelled)       |
          dialog2 |&lt;-------------------|                    |
                  |            200 OK  |                    |
          dialog2 |-------------------&gt;|                    |
                  |  INVITE (unhold)   |                    |
          dialog1 |-------------------&gt;|                    |
                  |  200 OK            |                    |
          dialog1 |&lt;-------------------|                    |
                  |  ACK               |                    |
          dialog1 |-------------------&gt;|                    |
                  |  BYE               |                    |



<span class="grey">Sparks, et al.           Best Current Practice                 [Page 17]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-18" id="page-18" name="page-18"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


          dialog1 |-------------------&gt;|                    |
                  |  200 OK            |                    |
          dialog1 |&lt;-------------------|                    |

   Figure 4: Failed Transfer - Target Does Not Answer

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/7.%20%20Transfer%20with%20Consultation%20Hold"></a><a class="selflink" href="#section-7" name="section-7">7</a>.  Transfer with Consultation Hold</span>

   Transfer with consultation hold involves a session between the
   Transferor and the Transfer Target before the transfer actually takes
   place.  This is implemented with SIP Hold and Transfer as described
   above.

   A nice feature is for the Transferor to let the target know that the
   session relates to an intended transfer.  Since many UAs render the
   display name in the From header field to the user, a consultation
   INVITE could contain a string such as "Incoming consultation from
   Transferor with intent to transfer Transferee", where the display
   names of the transferor and transferee are included in the string.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.1.%20%20Exposing%20Transfer%20Target"></a><a class="selflink" href="#section-7.1" name="section-7.1">7.1</a>.  Exposing Transfer Target</span>

   The Transferor places the Transferee on hold, establishes a call with
   the Transfer Target to alert them to the impending transfer,
   terminates the connection with the Transfer Target, then proceeds
   with transfer as above.  This variation can be used to provide an
   experience similar to that expected by current PBX and Centrex users.

   To (hopefully) improve clarity, non-REFER transactions have been
   collapsed into one indicator with the arrow showing the direction of
   the request.




















<span class="grey">Sparks, et al.           Best Current Practice                 [Page 18]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-19" id="page-19" name="page-19"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


             Transferor           Transferee             Transfer
                  |                    |                  Target
                  |                    |                    |
          dialog1 | INVITE/200 OK/ACK  |                    |
                  |&lt;-------------------|                    |
          dialog1 | INVITE (hold)/200 OK/ACK                |
                  |-------------------&gt;|                    |
          dialog2 | INVITE/200 OK/ACK  |                    |
                  |----------------------------------------&gt;|
          dialog2 | BYE/200 OK         |                    |
                  |----------------------------------------&gt;|
          dialog3 | REFER              |                    |
                  |-------------------&gt;|                    |
          dialog3 | 202 Accepted       |                    |
                  |&lt;-------------------|                    |
          dialog3 | NOTIFY (100 Trying)|                    |
                  |&lt;-------------------|                    |
          dialog3 |            200 OK  |                    |
                  |-------------------&gt;|                    |
          dialog4 |                    |  INVITE/200 OK/ACK |
                  |                    |-------------------&gt;|
          dialog3 | NOTIFY (200 OK)    |                    |
                  |&lt;-------------------|                    |
          dialog3 |            200 OK  |                    |
                  |-------------------&gt;|                    |
          dialog1 | BYE/200 OK         |                    |
                  |-------------------&gt;|                    |
          dialog4 |                    |         BYE/200 OK |
                  |                    |&lt;-------------------|

   Figure 5: Transfer with Consultation Hold - Exposing Transfer Target

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.2.%20%20Protecting%20Transfer%20Target"></a><a class="selflink" href="#section-7.2" name="section-7.2">7.2</a>.  Protecting Transfer Target</span>

   The Transferor places the Transferee on hold, establishes a call with
   the Transfer Target and then reverses their roles, transferring the
   original Transfer Target to the original Transferee.  This has the
   advantage of hiding information about the original Transfer Target
   from the original Transferee.  On the other hand, the Transferee's
   experience is different than in current systems.  The Transferee is
   effectively "called back" by the Transfer Target.

   One of the problems with this simplest implementation of a target
   protecting transfer is that the Transferee is receiving a new call
   from the Transfer Target.  Unless the Transferee's agent has a
   reliable way to associate this new call with the call it already has
   with the Transferor, it will have to alert the new call on another
   appearance.  If this, or some other call-waiting-like UI were not



<span class="grey">Sparks, et al.           Best Current Practice                 [Page 19]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-20" id="page-20" name="page-20"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   available, the Transferee might be stuck returning a Busy-Here to the
   Transfer Target, effectively preventing the transfer.  There are many
   ways that correlation could be provided.  The dialog parameters could
   be provided directly as header parameters in the Refer-To URI, for
   example.  The Replaces mechanism [<a href="rfc3891.html" title='"The Session Initiation Protocol (SIP) "'>RFC3891</a>] uses this approach and
   solves this problem nicely.

   For the flow below, dialog1 means dialog identifier 1, and consists
   of the parameters of the Replaces header for dialog 1.  In [<a href="rfc3891.html" title='"The Session Initiation Protocol (SIP) "'>RFC3891</a>],
   this is the Call-ID, To-tag, and From-tag.

   Note that the Transferee's agent emits a BYE to the Transferor's
   agent as an immediate consequence of processing the Replaces header.

   The Transferor knows that both the Transferee and the Transfer Target
   support the Replaces header from the Supported: replaces header
   contained in the 200 OK responses from both.

   In this scenario, the Transferee utilizes a GRUU as a Contact URI for
   reasons discussed in <a href="#section-6.3">Section 6.3</a>.

   Note that the conventions used in the SIP Torture Test Messages
   [<a href="rfc4475.html" title='"Session Initiation Protocol (SIP) Torture Test Messages"'>RFC4475</a>] document are reused, specifically the &lt;allOneLine&gt; tag.




























<span class="grey">Sparks, et al.           Best Current Practice                 [Page 20]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-21" id="page-21" name="page-21"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


             Transferor           Transferee             Transfer
                  |                    |                  Target
                  |                    |                    |
        dialog1   | INVITE/200 OK/ACK F1 F2                 |
                  |&lt;-------------------|                    |
        dialog1   | INVITE (hold)/200 OK/ACK                |
                  |-------------------&gt;|                    |
        dialog2   | INVITE/200 OK/ACK F3 F4                 |
                  |----------------------------------------&gt;|
        dialog2   | INVITE (hold)/200 OK/ACK                |
                  |----------------------------------------&gt;|
        dialog3   | REFER (Target-Dialog:2,                 |
                  |  Refer-To:sips:Transferee?Replaces=1) F5|
                  |----------------------------------------&gt;|
        dialog3   | 202 Accepted       |                    |
                  |&lt;----------------------------------------|
        dialog3   | NOTIFY (100 Trying)|                    |
                  |&lt;----------------------------------------|
        dialog3   |                    |            200 OK  |
                  |----------------------------------------&gt;|
        dialog4   |         INVITE (Replaces:dialog1)/200 OK/ACK F6
                  |                    |&lt;-------------------|
        dialog1   | BYE/200 OK         |                    |
                  |&lt;-------------------|                    |
        dialog3   | NOTIFY (200 OK)    |                    |
                  |&lt;----------------------------------------|
        dialog3   |                    |            200 OK  |
                  |----------------------------------------&gt;|
        dialog2   | BYE/200 OK         |                    |
                  |----------------------------------------&gt;|
                  |              (Transferee and target converse)
        dialog4   |                    |  BYE/200 OK        |
                  |                    |-------------------&gt;|

   Figure 6: Transfer Protecting Transfer Target
















<span class="grey">Sparks, et al.           Best Current Practice                 [Page 21]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-22" id="page-22" name="page-22"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F1 INVITE Transferee -&gt; Transferor

   INVITE sips:transferor@atlanta.example.com SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   Max-Forwards: 70
   To: &lt;sips:transferor@atlanta.example.com&gt;
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
   Call-ID: 090459243588173445
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces, gruu
   Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   Content-Type: application/sdp
   Content-Length: ...


   F2 200 OK Transferor -&gt; Transferee

   SIP/2.0 200 OK
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   To: &lt;sips:transferor@atlanta.example.com&gt;;tag=31431
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
   Call-ID: 090459243588173445
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces, gruu, tdialog
   Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
   Content-Type: application/sdp
   Content-Length: ...


   F3 INVITE Transferor -&gt; Transfer Target

   INVITE sips:transfertarget@chicago.example.com SIP/2.0
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnas432
   Max-Forwards: 70
   To: &lt;sips:transfertarget@chicago.example.com&gt;
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
   Call-ID: 592435881734450904
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: gruu, replaces, tdialog
   Require: replaces
   Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=384i32lw3&gt;
   Content-Type: application/sdp
   Content-Length: ...





<span class="grey">Sparks, et al.           Best Current Practice                 [Page 22]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-23" id="page-23" name="page-23"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F4 200 OK Transfer Target -&gt; Transferor

   SIP/2.0 200 OK
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnas432
    ;received=192.0.2.1
   To: &lt;sips:transfertarget@chicago.example.com&gt;;tag=9m2n3wq
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
   Call-ID: 592435881734450904
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces, gruu, tdialog
   Contact: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958&gt;
   Content-Type: application/sdp
   Content-Length: ...


   F5 REFER Transferor -&gt; Transfer Target

   REFER sips:482n4z24kdg@chicago.example.com;gr=8594958 SIP/2.0
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnashds9
   Max-Forwards: 70
   To: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958&gt;
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
   Call-ID: a84b4c76e66710
   CSeq: 314159 REFER
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: gruu, replaces, tdialog
   Require: tdialog
   &lt;allOneLine&gt;
   Refer-To: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha
   ?Replaces=090459243588173445%3Bto-tag%3D7553452%3Bfrom-tag%3D31431&gt;
   &lt;/allOneLine&gt;
   Target-Dialog: 592435881734450904;local-tag=9m2n3wq
    ;remote-tag=763231
   Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
   Content-Length: 0















<span class="grey">Sparks, et al.           Best Current Practice                 [Page 23]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-24" id="page-24" name="page-24"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F6 INVITE Transfer Target -&gt; Transferee

   INVITE sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha SIP/2.0
   Via: SIP/2.0/TLS client.chicago.example.com;branch=z9hG4bKnaslu84
   Max-Forwards: 70
   To: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   From: &lt;sips:transfertarget@chicago.example.com&gt;;tag=341234
   Call-ID: kmzwdle3dl3d08
   CSeq: 41 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: gruu, replaces, tdialog
   Contact: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958&gt;
   Replaces: 090459243588173445;to-tag=7553452;from-tag=31431
   Content-Type: application/sdp
   Content-Length: ...

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.3.%20%20Attended%20Transfer"></a><a class="selflink" href="#section-7.3" name="section-7.3">7.3</a>.  Attended Transfer</span>

   The Transferor places the Transferee on hold, establishes a call with
   the Transfer Target to alert them to the impending transfer, places
   the target on hold, then proceeds with transfer using an escaped
   Replaces header field in the Refer-To header.  This is another common
   service expected by current PBX and Centrex users.

   The Contact URI of the Transfer Target SHOULD be used by the
   Transferor as the Refer-To URI, unless the URI is suspected or known
   to not be routable outside the dialog.  Otherwise, the Address of
   Record (AOR) of the Transfer Target SHOULD be used.  That is, the
   same URI that the Transferor used to establish the session with the
   Transfer Target should be used.  In case the triggered INVITE is
   routed to a different User Agent than the Transfer Target, the
   Require: replaces header field SHOULD be used in the triggered
   INVITE.  (This is to prevent an incorrect User Agent that does not
   support Replaces from ignoring the Replaces and answering the INVITE
   without a dialog match.)

   It is possible that proxy/service routing may prevent the triggered
   INVITE from reaching the same User Agent.  If this occurs, the
   triggered invite will fail with a timeout, 403, 404, etc. error.  The
   Transferee MAY then retry the transfer with the Refer-To URI set to
   the Contact URI.










<span class="grey">Sparks, et al.           Best Current Practice                 [Page 24]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-25" id="page-25" name="page-25"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


             Transferor           Transferee             Transfer
                  |                    |                  Target
                  |                    |                    |
         dialog1  | INVITE/200 OK/ACK F1 F2                 |
                  |&lt;-------------------|                    |
         dialog1  | INVITE (hold)/200 OK/ACK                |
                  |-------------------&gt;|                    |
         dialog2  | INVITE/200 OK/ACK F3 F4                 |
                  |----------------------------------------&gt;|
         dialog2  | INVITE (hold)/200 OK/ACK                |
                  |----------------------------------------&gt;|
         dialog3  | REFER (Target-Dialog:1,                 |
                  |  Refer-To:sips:TransferTarget?Replaces=2) F5
                  |-------------------&gt;|                    |
         dialog3  | 202 Accepted       |                    |
                  |&lt;-------------------|                    |
         dialog3  | NOTIFY (100 Trying)|                    |
                  |&lt;-------------------|                    |
         dialog3  |            200 OK  |                    |
                  |-------------------&gt;|                    |
         dialog4  |        INVITE (Replaces:dialog2)/200 OK/ACK F6
                  |                    |-------------------&gt;|
         dialog2  | BYE/200 OK         |                    |
                  |&lt;----------------------------------------|
         dialog3  | NOTIFY (200 OK)    |                    |
                  |&lt;-------------------|                    |
         dialog3  |            200 OK  |                    |
                  |-------------------&gt;|                    |
         dialog1  | BYE/200 OK         |                    |
                  |-------------------&gt;|                    |
         dialog4  |                    |         BYE/200 OK |
                  |                    |&lt;-------------------|

   Figure 7: Attended Transfer Call Flow

















<span class="grey">Sparks, et al.           Best Current Practice                 [Page 25]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-26" id="page-26" name="page-26"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F1 INVITE Transferee -&gt; Transferor

   INVITE sips:transferor@atlanta.example.com SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   Max-Forwards: 70
   To: &lt;sips:transferor@atlanta.example.com&gt;
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
   Call-ID: 090459243588173445
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces, gruu, tdialog
   Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   Content-Type: application/sdp
   Content-Length: ...


   F2 200 OK Transferor -&gt; Transferee

   SIP/2.0 200 OK
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   To: &lt;sips:transferor@atlanta.example.com&gt;;tag=31431
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
   Call-ID: 090459243588173445
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces, gruu, tdialog
   Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
   Content-Type: application/sdp
   Content-Length: ...


   F3 INVITE Transferor -&gt; Transfer Target

   INVITE sips:transfertarget@chicago.example.com SIP/2.0
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnas432
   Max-Forwards: 70
   To: &lt;sips:transfertarget@chicago.example.com&gt;
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
   Call-ID: 592435881734450904
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: gruu, replaces, tdialog
   Require: replaces
   Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=384i32lw3&gt;
   Content-Type: application/sdp
   Content-Length: ...





<span class="grey">Sparks, et al.           Best Current Practice                 [Page 26]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-27" id="page-27" name="page-27"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F4 200 OK Transfer Target -&gt; Transferor

   SIP/2.0 200 OK
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnas432
    ;received=192.0.2.1
   To: &lt;sips:transfertarget@chicago.example.com&gt;;tag=9m2n3wq
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
   Call-ID: 592435881734450904
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces, gruu
   Contact: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958&gt;
   Content-Type: application/sdp
   Content-Length: ...


   F5 REFER Transferor -&gt; Transferee

   REFER sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha SIP/2.0
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnashds9
   Max-Forwards: 70
   To: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
   Call-ID: a84b4c76e66710
   CSeq: 314159 REFER
   Require: tdialog
   &lt;allOneLine&gt;
   Refer-To: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958?
   Replaces=592435881734450904%3Bto-tag%3D9m2n3wq%3Bfrom-tag3D763231&gt;
   &lt;/allOneLine&gt;
   Target-Dialog: 592435881734450904;local-tag=9m2n3wq
    ;remote-tag=763231
   Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
   Content-Length: 0

















<span class="grey">Sparks, et al.           Best Current Practice                 [Page 27]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-28" id="page-28" name="page-28"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F6 INVITE Transferee -&gt; Transfer Target

   INVITE sips:482n4z24kdg@chicago.example.com;gr=8594958 SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnaslu82
   Max-Forwards: 70
   To: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958&gt;
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=954
   Call-ID: kmzwdle3dl3d08
   CSeq: 41 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: gruu, replaces, tdialog
   Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   Replaces: 592435881734450904;to-tag=9m2n3wq;from-tag=763231
   Content-Type: application/sdp
   Content-Length: ...

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.4.%20%20Recovery%20When%20One%20Party%20Does%20Not%20Support%20REFER"></a><a class="selflink" href="#section-7.4" name="section-7.4">7.4</a>.  Recovery When One Party Does Not Support REFER</span>

   If protecting or exposing the Transfer Target is not a concern, it is
   possible to complete a transfer with consultation hold when only the
   transferor and one other party support REFER.  Note that a 405 Method
   Not Allowed might be returned instead of the 501 Not Implemented
   response.




























<span class="grey">Sparks, et al.           Best Current Practice                 [Page 28]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-29" id="page-29" name="page-29"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


             Transferor           Transferee             Transfer
                  |                    |                  Target
                  |                    |                    |
         dialog1  | INVITE/200 OK/ACK  |                    |
                  |&lt;-------------------|                    |
         dialog1  | INVITE (hold)/200 OK/ACK                |
                  |-------------------&gt;|                    |
         dialog2  | INVITE/200 OK/ACK  |                    |
                  |----------------------------------------&gt;|
         dialog2  | INVITE (hold)/200 OK/ACK                |
                  |----------------------------------------&gt;|
         dialog3  | REFER (Target-Dialog:1,                 |
                  |    Refer-To:sips:TransferTarget?Replaces=2)
                  |-------------------&gt;|                    |
         dialog3  | 501 Not Implemented                     |
                  |&lt;-------------------|                    |
         dialog4  | REFER (Refer-To:sips:Transferee?Replaces=dialog1)
                  |----------------------------------------&gt;|
         dialog4  | 202 Accepted       |                    |
                  |&lt;----------------------------------------|
         dialog4  | NOTIFY (100 Trying)|                    |
                  |&lt;----------------------------------------|
         dialog4  |                    |            200 OK  |
                  |----------------------------------------&gt;|
         dialog5  |             INVITE (Replaces:dialog1)/200 OK/ACK
                  |                    |&lt;-------------------|
         dialog4  | NOTIFY (200 OK)    |                    |
                  |&lt;----------------------------------------|
         dialog4  |                    |            200 OK  |
                  |----------------------------------------&gt;|
         dialog1  | BYE/200 OK         |                    |
                  |&lt;-------------------|                    |
         dialog2  | BYE/200 OK         |                    |
                  |----------------------------------------&gt;|
         dialog5  |                    |  BYE/200 OK        |
                  |                    |-------------------&gt;|

   Figure 8: Recovery When One Party Does Not Support REFER

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.5.%20%20Attended%20Transfer%20When%20Contact%20URI%20Is%20Not%20Known%20to%20Route%20to%20a"></a><a class="selflink" href="#section-7.5" name="section-7.5">7.5</a>.  Attended Transfer When Contact URI Is Not Known to Route to a</span>
<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/Unique%20User%20Agent"></a>      Unique User Agent</span>

   It is a requirement of <a href="rfc3261.html">RFC 3261</a> that a Contact URI be globally
   routable even outside the dialog.  However, due to <a href="rfc2543.html">RFC 2543</a> User
   Agents and some architectures (NAT/Firewall traversal, screening
   proxies, Application Layer Gateways (ALGs), etc.) this will not





<span class="grey">Sparks, et al.           Best Current Practice                 [Page 29]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-30" id="page-30" name="page-30"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   always be the case.  As a result, the method of attended transfer
   shown in Figures 6, 7, and 8 SHOULD only be used if the Contact URI
   is known to be routable outside the dialog.

   Figure 9 shows such a scenario where the Transfer Target Contact URI
   is not routable outside the dialog, so the triggered INVITE is sent
   to the AOR of the Transfer Target.

          Transferor           Transferee  Screening       Transfer
              |                  |           Proxy         Target
              |                  |             |             |
      dialog1 | INVITE/200 OK/ACK|             |             |
              |&lt;-----------------|             |             |
      dialog1 | INVITE (hold)/200 OK/ACK       |             |
              |-----------------&gt;|             |             |
      dialog2 | INVITE/200 OK/ACK F1 F2        |             |
              |--------------------------------|------------&gt;|
      dialog2 | INVITE (hold)/200 OK/ACK                     |
              |--------------------------------|------------&gt;|
      dialog1 | REFER (Refer-To:sips:TargetAOR               |
              |         ?Replaces=dialog2&amp;Require=replaces) F3
              |-----------------&gt;|             |             |
      dialog1 | 202 Accepted     |             |             |
              |&lt;-----------------|             |             |
      dialog1 | NOTIFY (100 Trying)            |             |
              |&lt;-----------------|             |             |
      dialog1 |          200 OK  |             |             |
              |-----------------&gt;|             |             |
      dialog4 |INVITE (Replaces:dialog2,Require:replaces)/200 OK/ACK F6
              |                  |------------&gt;|------------&gt;|
      dialog2 | BYE/200 OK       |             |             |
              |&lt;-------------------------------|&lt;------------|
      dialog1 | NOTIFY (200 OK) F7             |             |
              |&lt;-----------------|             |             |
      dialog1 |          200 OK  |             |             |
              |-----------------&gt;|             |             |
      dialog1 | BYE/200 OK       |             |             |
              |-----------------&gt;|             |             |
      dialog3 |                  |             |  BYE/200 OK |
              |                  |&lt;------------|-------------|

   Figure 9: Attended Transfer Call Flow with a Contact URI Not Known to
   Be Globally Routable








<span class="grey">Sparks, et al.           Best Current Practice                 [Page 30]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-31" id="page-31" name="page-31"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F1 INVITE Transferor -&gt; Transfer Target

   INVITE sips:transfertarget@chicago.example.com SIP/2.0
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bK76
   Max-Forwards: 70
   To: &lt;sips:transfertarget@chicago.example.com&gt;
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
   Call-ID: 090459243588173445
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces
   Contact: &lt;sips:transferor@pc33.atlanta.example.com&gt;
   Content-Type: application/sdp
   Content-Length: ...


   F2 200 OK Transfer Target -&gt; Transferee

   SIP/2.0 200 OK
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnas432
    ;received=192.0.2.1
   To: &lt;sips:transfertarget@chicago.example.com&gt;;tag=9m2n3wq
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
   Call-ID: 090459243588173445
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces
   Contact: &lt;sips:transfertarget@client.chicago.example.com&gt;
   Content-Type: application/sdp
   Content-Length: ...


   F3 REFER Transferor -&gt; Transferee

   REFER sips:transferee@192.0.2.4 SIP/2.0
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnashds9
   Max-Forwards: 70
   To: &lt;sips:transferee@biloxi.example.com&gt;;tag=a6c85cf
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
   Call-ID: a84b4c76e66710
   CSeq: 314160 REFER
   &lt;allOneLine&gt;
   Refer-To: &lt;sips:transfertarget@chicago.example.com?Replaces=
   090459243588173445%3Bto-tag%3D9m2n3wq%3Bfrom-tag%3D763231
   &amp;Require=replaces&gt;
   &lt;allOneLine&gt;
   Contact: &lt;sips:transferor@pc33.atlanta.example.com&gt;
   Content-Length: 0



<span class="grey">Sparks, et al.           Best Current Practice                 [Page 31]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-32" id="page-32" name="page-32"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F4 INVITE Transferee -&gt; Transfer Target

   INVITE sips:transfertarget@chicago.example.com SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnaslu82
   Max-Forwards: 70
   To: &lt;sips:transfertarget@chicago.example.com&gt;
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=954
   Call-ID: 20482817324945934422930
   CSeq: 42 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces
   Contact: &lt;sips:transferee@192.0.2.4&gt;
   Replaces: 090459243588173445;to-tag=9m2n3wq;from-tag=763231
   Require: replaces
   Content-Type: application/sdp
   Content-Length: ...


   F5 NOTIFY Transferee -&gt; Transferor

   NOTIFY sips:transferor@pc33.atlanta.com SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   Max-Forwards: 70
   To: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=a6c85cf
   Call-ID: a84b4c76e66710
   CSeq: 76 NOTIFY
   Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces
   Event: refer;id=98873867
   Subscription-State: terminated;reason=noresource
   Content-Type: message/sipfrag
   Content-Length: ...

   SIP/2.0 200 OK

   Figure 10 shows a failure case in which the AOR URI fails to reach
   the Transfer Target.  As a result, the transfer is retried with the
   Contact URI, at which point it succeeds.

   Note that there is still no guarantee that the correct endpoint will
   be reached, and the result of this second REFER may also be a
   failure.  In that case, the Transferor could fall back to unattended
   transfer or give up on the transfer entirely.  Since two REFERs are
   sent within the dialog creating two distinct subscriptions, the
   Transferee uses the 'id' parameter in the Event header field to
   distinguish notifications for the two subscriptions.



<span class="grey">Sparks, et al.           Best Current Practice                 [Page 32]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-33" id="page-33" name="page-33"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


          Transferor           Transferee  Screening      Transfer
              |                  |           Proxy         Target
              |                  |             |             |
      dialog1 | INVITE/200 OK/ACK|             |             |
              |&lt;-----------------|             |             |
      dialog1 | INVITE (hold)/200 OK/ACK       |             |
              |-----------------&gt;|             |             |
      dialog2 | INVITE/200 OK/ACK F1 F2        |             |
              |--------------------------------|------------&gt;|
      dialog2 | INVITE (hold)/200 OK/ACK                     |
              |--------------------------------|------------&gt;|
      dialog1 | REFER (Refer-To:sips:TargetAOR?              |
              |       Replaces=dialog2&amp;Require=replaces) F3  |
              |-----------------&gt;|             |             |
      dialog1 | 202 Accepted     |             |             |
              |&lt;-----------------|             |             |
      dialog1 | NOTIFY (100 Trying)            |             |
              |&lt;-----------------|             |             |
      dialog1 |          200 OK  |             |             |
              |-----------------&gt;|             |             |
      dialog3 |                  |INVITE (Replaces:dialog2,  |
              |                  | Require:replaces)/403/ACK |
              |                  |------------&gt;|             |
      dialog1 | NOTIFY (403 Forbidden) F4      |             |
              |&lt;-----------------|             |             |
      dialog1 |          200 OK  |             |             |
              |-----------------&gt;|             |             |
      dialog1 |REFER(Refer-To:sips:TargetContact?Replaces=dialog2) F5
              |-----------------&gt;|             |             |
      dialog1 | 202 Accepted     |             |             |
              |&lt;-----------------|             |             |
      dialog1 | NOTIFY (100 Trying)            |             |
              |&lt;-----------------|             |             |
      dialog1 |          200 OK  |             |             |
              |-----------------&gt;|             |             |
      dialog4 |                INVITE (Replaces:dialog2)/200 OK/ACK F6
              |                  |------------&gt;|------------&gt;|
      dialog2 | BYE/200 OK       |             |             |
              |&lt;-------------------------------|&lt;------------|
      dialog1 | NOTIFY (200 OK) F7             |             |
              |&lt;-----------------|             |             |
      dialog1 |          200 OK  |             |             |
              |-----------------&gt;|             |             |
      dialog1 | BYE/200 OK       |             |             |
              |-----------------&gt;|             |             |
      dialog3 |                  |             |  BYE/200 OK |
              |                  |&lt;------------|-------------|




<span class="grey">Sparks, et al.           Best Current Practice                 [Page 33]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-34" id="page-34" name="page-34"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   Figure 10: Attended Transfer Call Flow with Non-Routable Contact URI
   and AOR Failure

   F1 INVITE Transferor -&gt; Transfer Target

   INVITE sips:transfertarget@chicago.example.com SIP/2.0
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bK76
   Max-Forwards: 70
   To: &lt;sips:transfertarget@chicago.example.com&gt;
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
   Call-ID: 090459243588173445
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces
   Contact: &lt;sips:transferor@pc33.atlanta.example.com&gt;
   Content-Type: application/sdp
   Content-Length: ...


   F2 200 OK Transfer Target -&gt; Transferee

   SIP/2.0 200 OK
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnas432
    ;received=192.0.2.1
   To: &lt;sips:transfertarget@chicago.example.com&gt;;tag=9m2n3wq
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
   Call-ID: 090459243588173445
   CSeq: 29887 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces
   Contact: &lt;sips:transfertarget@client.chicago.example.com&gt;
   Content-Type: application/sdp
   Content-Length: ...


















<span class="grey">Sparks, et al.           Best Current Practice                 [Page 34]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-35" id="page-35" name="page-35"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F3 REFER Transferor -&gt; Transferee

   REFER sips:transferee@192.0.2.4 SIP/2.0
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnashds9
   Max-Forwards: 70
   To: &lt;sips:transferee@biloxi.example.com&gt;;tag=a6c85cf
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
   Call-ID: a84b4c76e66710
   CSeq: 314159 REFER
   &lt;allOneLine&gt;
   Refer-To: &lt;sips:transfertarget@chicago.example.com?Replaces=
   090459243588173445%3Bto-tag%3D9m2n3wq%3Bfrom-tag%3D763231
   &amp;Require=replaces&gt;
   &lt;/allOneLine&gt;
   Contact: &lt;sips:transferor@pc33.atlanta.example.com&gt;
   Content-Length: 0


   F4 NOTIFY Transferee -&gt; Transferor

   NOTIFY sips:transferor@pc33.atlanta.com SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   Max-Forwards: 70
   To: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=a6c85cf
   Call-ID: a84b4c76e66710
   CSeq: 74 NOTIFY
   Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces
   Event: refer;id=314159
   Subscription-State: terminated;reason=noresource
   Content-Type: message/sipfrag
   Content-Length: ...

   SIP/2.0 403 Forbidden















<span class="grey">Sparks, et al.           Best Current Practice                 [Page 35]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-36" id="page-36" name="page-36"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F5 REFER Transferor -&gt; Transferee

   REFER sips:transferee@192.0.2.4 SIP/2.0
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnashds9
   Max-Forwards: 70
   To: &lt;sips:transferee@biloxi.example.com&gt;;tag=a6c85cf
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
   Call-ID: a84b4c76e66710
   CSeq: 314160 REFER
   &lt;allOneLine&gt;
   Refer-To: &lt;sips:transfertarget@client.chicago.example.com
   ?Replaces=090459243588173445%3Bto-tag%3D9m2n3wq
   %3Bfrom-tag%3D763231&gt;
   &lt;/allOneLine&gt;
   Contact: &lt;sips:transferor@pc33.atlanta.example.com&gt;
   Content-Length: 0


   F6 INVITE Transferee -&gt; Transfer Target

   INVITE sips:transfertarget@client.chicago.example.com SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnaslu82
   Max-Forwards: 70
   To: &lt;sips:transfertarget@chicago.example.com&gt;
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=954
   Call-ID: 20482817324945934422930
   CSeq: 42 INVITE
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces
   Contact: &lt;sips:transferee@192.0.2.4&gt;
   Replaces: 090459243588173445;to-tag=9m2n3wq;from-tag=763231
   Content-Type: application/sdp
   Content-Length: ...


















<span class="grey">Sparks, et al.           Best Current Practice                 [Page 36]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-37" id="page-37" name="page-37"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F7 NOTIFY Transferee -&gt; Transferor

   NOTIFY sips:transferor@pc33.atlanta.com SIP/2.0
   Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
   Max-Forwards: 70
   To: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=a6c85cf
   Call-ID: a84b4c76e66710
   CSeq: 76 NOTIFY
   Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
   Supported: replaces
   Event: refer;id=314160
   Subscription-State: terminated;reason=noresource
   Content-Type: message/sipfrag
   Content-Length: ...

   SIP/2.0 200 OK

   To prevent this scenario from happening, the Transfer Target SHOULD
   use a Contact URI that is routable outside the dialog, which will
   result in the call flow of Figure 7.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.6.%20%20Semi-Attended%20Transfer"></a><a class="selflink" href="#section-7.6" name="section-7.6">7.6</a>.  Semi-Attended Transfer</span>

   In any of the consultation hold flows above, the Transferor may
   decide to terminate its attempt to contact the Transfer Target before
   that session is established.  Most frequently, that will be the end
   of the scenario, but in some circumstances, the Transferor may wish
   to proceed with the transfer action.  For example, the Transferor may
   wish to complete the transfer knowing that the Transferee will end up
   eventually talking to the Transfer Target's voicemail service.  Some
   PBX systems support this feature, sometimes called "semi-attended
   transfer", that is effectively a hybrid between a fully attended
   transfer and an unattended transfer.  A call flow is shown in Figure
   11.  In this flow, the Transferor's User Agent continues the transfer
   as an attended transfer even after the Transferor hangs up.  Note
   that media must be played to the Transfer Target upon answer --
   otherwise, the Target may hang up and the resulting transfer
   operation will fail.











<span class="grey">Sparks, et al.           Best Current Practice                 [Page 37]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-38" id="page-38" name="page-38"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


             Transferor           Transferee            Transfer
                  |                    |                 Target
                  |                    |                    |
         dialog1  | INVITE/200 OK/ACK F1 F2                 |
                  |&lt;-------------------|                    |
         dialog1  | INVITE (hold)/200 OK/ACK                |
                  |-------------------&gt;|                    |
         dialog2  | INVITE             |                    |
                  |----------------------------------------&gt;|
         dialog2  |                    |       180 Ringing  |
                  |&lt;----------------------------------------|
               Transferor hangs up but wants transfer to continue
                  |                    |                    |
                  | User Agent continues transfer operation |
                  |                    |                    |
         dialog2  |                    |           200 OK   |
                  |&lt;----------------------------------------|
         dialog2  | ACK                |                    |
                  |----------------------------------------&gt;|
         dialog2  | Media Played to keep Target from hanging up
                  |========================================&gt;|
         dialog3  | REFER (Target-Dialog:1,                 |
                  |  Refer-To:sips:TransferTarget?Replaces=2)
                  |-------------------&gt;|                    |
         dialog3  | 202 Accepted       |                    |
                  |&lt;-------------------|                    |
         dialog3  | NOTIFY (100 Trying)|                    |
                  |&lt;-------------------|                    |
         dialog3  |            200 OK  |                    |
                  |-------------------&gt;|                    |
         dialog4  |             INVITE (Replaces:dialog2)/200 OK/ACK
                  |                    |-------------------&gt;|
         dialog2  | BYE/200 OK         |                    |
                  |&lt;----------------------------------------|
         dialog3  | NOTIFY (200 OK)    |                    |
                  |&lt;-------------------|                    |
         dialog3  |            200 OK  |                    |
                  |-------------------&gt;|                    |
         dialog1  | BYE/200 OK         |                    |
                  |-------------------&gt;|                    |
         dialog4  |                    |         BYE/200 OK |
                  |                    |&lt;-------------------|

   Figure 11: Recommended Semi-Attended Transfer Call Flow

   Two other possible semi-attended transfer call flows are shown in
   Figures 12 and 13.  However, these call flows are NOT RECOMMENDED due
   to race conditions.  In both of these flows, when the Transferor



<span class="grey">Sparks, et al.           Best Current Practice                 [Page 38]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-39" id="page-39" name="page-39"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   hangs up, the Transferor attempts to revert to unattended transfer by
   sending a CANCEL to the target.  This can result in two race
   conditions.  One is that the target answers despite the CANCEL and
   the resulting unattended transfer fails.  This race condition can be
   eliminated by the Transferor waiting to send the REFER until the 487
   response from the target is returned.  Instead of a 487, a 200 OK may
   be returned indicating that the target has answered the consultation
   call.  In this case, the call flow in Figure 13 must be followed.  In
   this flow, the Transferor must play some kind of media to the Target
   to prevent the Target from hanging up, or the transfer will fail.
   That is, the human at the Transfer Target will hear silence from when
   they answer (message F1) until the transfer completes (F3 and they
   are talking to the Transferee unless some media is played (F2)).

   The second race condition occurs in Figure 12 if the Transfer Target
   goes "off hook" after the CANCEL is received and the 487 returned.
   This may result in a 486 Busy Here response to the unattended
   transfer.

   The recommended call flow of Figure 11 does not utilize a CANCEL and
   does not suffer from these race conditions.






























<span class="grey">Sparks, et al.           Best Current Practice                 [Page 39]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-40" id="page-40" name="page-40"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


             Transferor           Transferee            Transfer
                  |                    |                 Target
                  |                    |                    |
         dialog1  | INVITE/200 OK/ACK  |                    |
                  |&lt;-------------------|                    |
         dialog1  | INVITE (hold)/200 OK/ACK                |
                  |-------------------&gt;|                    |
         dialog2  | INVITE                                  |
                  |----------------------------------------&gt;|
         dialog2  | 180 Ringing                             |
                  |&lt;----------------------------------------|
                  |                                         |
                  |  Transferor gives up waiting            |
                  |                                         |
         dialog2  | CANCEL                                  |
                  |----------------------------------------&gt;|
         dialog2  | 200 OK                                  |
                  |&lt;----------------------------------------|
         dialog2  | 487 Request Terminated                  |
                  |&lt;----------------------------------------|
         dialog2  | ACK                                     |
                  |----------------------------------------&gt;|
         dialog3  | REFER (Target-Dialog:1) F3              |
                  |-------------------&gt;|                    |
         dialog3  | 202 Accepted       |                    |
                  |&lt;-------------------|                    |
         dialog3  | NOTIFY (100 Trying)|                    |
                  |&lt;-------------------|                    |
         dialog3  |            200 OK  |                    |
                  |-------------------&gt;|                    |
         dialog4  |                INVITE/200 OK/ACK        |
                  |                    |-------------------&gt;|
         dialog3  | NOTIFY (200 OK)    |                    |
                  |&lt;-------------------|                    |
         dialog3  |            200 OK  |                    |
                  |-------------------&gt;|                    |
         dialog1  | BYE/200 OK         |                    |
                  |-------------------&gt;|                    |
         dialog4  |                    |         BYE/200 OK |
                  |                    |&lt;-------------------|

   Figure 12: Semi-Attended Transfer as Blind Transfer Call Flow (Not
   Recommended)








<span class="grey">Sparks, et al.           Best Current Practice                 [Page 40]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-41" id="page-41" name="page-41"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


             Transferor           Transferee            Transfer
                  |                    |                 Target
                  |                    |                    |
         dialog1  | INVITE/200 OK/ACK  |                    |
                  |&lt;-------------------|                    |
         dialog1  | INVITE (hold)/200 OK/ACK                |
                  |-------------------&gt;|                    |
         dialog2  | INVITE                                  |
                  |----------------------------------------&gt;|
         dialog2  | 180 Ringing                             |
                  |&lt;----------------------------------------|
                  |                                         |
                  |Transferor gives up waiting but Target answers
                  |                                         |
         dialog2  | CANCEL                                  |
                  |----------------------------------------&gt;|
         dialog2  | 200 OK (CANCEL)                         |
                  |&lt;----------------------------------------|
         dialog2  | 200 OK (INVITE) F1                      |
                  |&lt;----------------------------------------|
         dialog2  | ACK                                     |
                  |----------------------------------------&gt;|
         dialog2  | INVITE (hold)/200 OK/ACK                |
                  |----------------------------------------&gt;|
                  |  Tones or media played avoid silence F2 |
                  |========================================&gt;|
         dialog1  |REFER (Refer-To:sips:TransferTarget      |
                  |                      ?Replaces=dialog2) |
                  |-------------------&gt;|                    |
         dialog1  | 202 Accepted       |                    |
                  |&lt;-------------------|                    |
         dialog1  | NOTIFY (100 Trying)|                    |
                  |&lt;-------------------|                    |
         dialog1  |            200 OK  |                    |
                  |-------------------&gt;|                    |
         dialog3  |         INVITE (Replaces:dialog2)/200 OK/ACK F3
                  |                    |-------------------&gt;|
         dialog2  | BYE/200 OK         |                    |
                  |&lt;----------------------------------------|
         dialog1  | NOTIFY (200 OK)    |                    |
                  |&lt;-------------------|                    |
         dialog1  |            200 OK  |                    |
                  |-------------------&gt;|                    |
         dialog1  | BYE/200 OK         |                    |
                  |-------------------&gt;|                    |
         dialog3  |                    |         BYE/200 OK |
                  |                    |&lt;-------------------|




<span class="grey">Sparks, et al.           Best Current Practice                 [Page 41]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-42" id="page-42" name="page-42"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   Figure 13: Semi-Attended Transfer as Attended Transfer Call Flow (Not
   Recommended)

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.7.%20%20Attended%20Transfer%20Fallback%20to%20Basic%20Transfer"></a><a class="selflink" href="#section-7.7" name="section-7.7">7.7</a>.  Attended Transfer Fallback to Basic Transfer</span>

   In this flow, an attempted attended transfer fails so the Transferor
   falls back to basic transfer.

   The call flow in Figure 14 shows the use of Require: replaces in the
   INVITE sent by the Transferor to the Transfer Target in which the
   Transferor's intention at the time of sending the INVITE to the
   Transfer Target was known to be to complete an attended transfer.
   Since the Target does not support Replaces, the INVITE is rejected
   with a 420 Bad Extension response, and the Transferor switches from
   attended transfer to basic transfer immediately.




































<span class="grey">Sparks, et al.           Best Current Practice                 [Page 42]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-43" id="page-43" name="page-43"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


             Transferor           Transferee             Transfer
                  |                    |                  Target
                  |                    |                    |
         dialog1  | INVITE/200 OK/ACK  |                    |
                  |&lt;-------------------|                    |
         dialog1  |   OPTIONS/200 OK   |                    |
                  |-------------------&gt;|                    |
         dialog1  | INVITE (hold)/200 OK/ACK                |
                  |-------------------&gt;|                    |
         dialog2  | INVITE (Require:replaces)               |
                  |----------------------------------------&gt;|
         dialog2  |                     420 Bad Extension   |
                  |&lt;----------------------------------------|
         dialog2  |    ACK                                  |
                  |----------------------------------------&gt;|
         dialog1  | REFER (Refer-To:sips:TransferTarget)    |
                  |-------------------&gt;|                    |
         dialog1  |    202 Accepted    |                    |
                  |&lt;-------------------|                    |
         dialog1  | NOTIFY (100 Trying)|                    |
                  |&lt;-------------------|                    |
         dialog1  |            200 OK  |                    |
                  |-------------------&gt;|                    |
         dialog3  |                    |  INVITE/200 OK/ACK |
                  |                    |-------------------&gt;|
         dialog1  | NOTIFY (200 OK)    |                    |
                  |&lt;-------------------|                    |
         dialog1  |            200 OK  |                    |
                  |-------------------&gt;|                    |
         dialog1  | BYE/200 OK         |                    |
                  |-------------------&gt;|                    |
         dialog3  |                    |         BYE/200 OK |
                  |                    |&lt;-------------------|

   Figure 14: Attended Transfer Fallback to Basic Transfer Using
   Require:replaces

   Figure 15 shows the use of OPTIONS when the Transferee and Transfer
   Target do not explicitly indicate support for the REFER method and
   Replaces header fields in Allow and Supported header fields and the
   Transferor did not have the intention of performing an attended
   transfer when the INVITE to the Target was sent.  In dialog1, the
   Transferor determines, using OPTIONS, that the Transferee does
   support REFER and Replaces.  As a result, the Transferor begins the
   attended transfer by placing the Transferee on hold and calling the
   Transfer Target.  Using an OPTIONS in dialog2, the Transferor
   determines that the target does not support either REFER or Replaces,




<span class="grey">Sparks, et al.           Best Current Practice                 [Page 43]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-44" id="page-44" name="page-44"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   making attended transfer impossible.  The Transferor then ends
   dialog2 by sending a BYE then sends a REFER to the Transferee using
   the AOR URI of the Transfer Target.

             Transferor           Transferee             Transfer
                  |                    |                  Target
                  |                    |                    |
         dialog1  | INVITE/200 OK/ACK  |                    |
                  |&lt;-------------------|                    |
         dialog1  |   OPTIONS/200 OK   |                    |
                  |-------------------&gt;|                    |
         dialog1  | INVITE (hold)/200 OK/ACK                |
                  |-------------------&gt;|                    |
         dialog2  | INVITE/200 OK/ACK  |                    |
                  |----------------------------------------&gt;|
         dialog2  | OPTIONS/200 OK     |                    |
                  |----------------------------------------&gt;|
         dialog2  |    BYE/200 OK      |                    |
                  |----------------------------------------&gt;|
         dialog3  |REFER (Target-Dialog:1,                  |
                  |          Refer-To:sips:TransferTarget)  |
                  |-------------------&gt;|                    |
         dialog3  |    202 Accepted    |                    |
                  |&lt;-------------------|                    |
         dialog3  | NOTIFY (100 Trying)|                    |
                  |&lt;-------------------|                    |
         dialog3  |            200 OK  |                    |
                  |-------------------&gt;|                    |
         dialog4  |                    |  INVITE/200 OK/ACK |
                  |                    |-------------------&gt;|
         dialog3  | NOTIFY (200 OK)    |                    |
                  |&lt;-------------------|                    |
         dialog3  |            200 OK  |                    |
                  |-------------------&gt;|                    |
         dialog1  | BYE/200 OK         |                    |
                  |-------------------&gt;|                    |
         dialog4  |                    |         BYE/200 OK |
                  |                    |&lt;-------------------|

   Figure 15: Attended Transfer Fallback to Basic Transfer











<span class="grey">Sparks, et al.           Best Current Practice                 [Page 44]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-45" id="page-45" name="page-45"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/8.%20%20Transfer%20with%20Referred-By"></a><a class="selflink" href="#section-8" name="section-8">8</a>.  Transfer with Referred-By</span>

   In the previous examples, the Transfer Target does not have
   definitive information about what party initiated the transfer, or,
   in some cases, even that transfer is taking place.  The Referred-By
   mechanism [<a href="rfc3892.html" title='"The Session Initiation Protocol (SIP) Referred-By Mechanism"'>RFC3892</a>] provides a way for the Transferor to provide the
   Transferee with a way to let the Transfer Target know what party
   initiated the transfer.

   The simplest and least secure approach just involves the inclusion of
   the Referred-By header field in the REFER, which is then copied into
   the triggered INVITE.  However, a more secure mechanism involving the
   Referred-By security token, which is generated and signed by the
   Transferor and passed in a message body to the Transferee then to the
   Transfer Target.

   The call flow in Figure 16 shows the Referred-By header field and
   body in the REFER F5 and triggered INVITE F6.  Note that the Secure/
   Multipurpose Internet Mail Extensions (S/MIME) signature is not shown
   in the example below.  The conventions used in the SIP Torture Test
   Messages [<a href="rfc4475.html" title='"Session Initiation Protocol (SIP) Torture Test Messages"'>RFC4475</a>] document are reused, specifically the &lt;hex&gt; and
   &lt;allOneLine&gt; tags.





























<span class="grey">Sparks, et al.           Best Current Practice                 [Page 45]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-46" id="page-46" name="page-46"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


             Transferor           Transferee             Transfer
                  |                    |                  Target
                  |                    |                    |
         dialog1  | INVITE/200 OK/ACK F1 F2                 |
                  |&lt;-------------------|                    |
         dialog1  | INVITE (hold)/200 OK/ACK                |
                  |-------------------&gt;|                    |
         dialog2  | INVITE/200 OK/ACK F3 F4                 |
                  |----------------------------------------&gt;|
         dialog2  | INVITE (hold)/200 OK/ACK                |
                  |----------------------------------------&gt;|
         dialog3  | REFER (Target-Dialog:1, Referred-By:Transferor,
                  |  Refer-To:sips:TransferTarget?Replaces=2) F5
                  |-------------------&gt;|                    |
         dialog3  | 202 Accepted       |                    |
                  |&lt;-------------------|                    |
         dialog3  | NOTIFY (100 Trying)|                    |
                  |&lt;-------------------|                    |
         dialog3  |            200 OK  |                    |
                  |-------------------&gt;|                    |
         dialog4  |        INVITE (Replaces:dialog2,        |
                  |         Referred-By:Transferor )/200 OK/ACK F6
                  |                    |-------------------&gt;|
         dialog2  | BYE/200 OK         |                    |
                  |&lt;----------------------------------------|
         dialog3  | NOTIFY (200 OK)    |                    |
                  |&lt;-------------------|                    |
         dialog3  |            200 OK  |                    |
                  |-------------------&gt;|                    |
         dialog1  | BYE/200 OK         |                    |
                  |-------------------&gt;|                    |
         dialog4  |                    |         BYE/200 OK |
                  |                    |&lt;-------------------|

   Figure 16: Attended Transfer Call Flow with Referred-By
















<span class="grey">Sparks, et al.           Best Current Practice                 [Page 46]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-47" id="page-47" name="page-47"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   F5 REFER Transferor -&gt; Transferee

   REFER sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha SIP/2.0
   Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bK392039842
   Max-Forwards: 70
   To: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   From: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
   Call-ID: a84b4c76e66710
   CSeq: 314160 REFER
   &lt;allOneLine&gt;
   Refer-To: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958
   ?Replaces=090459243588173445%3Bto-tag%3D9m2n3wq%3Bfrom-tag
   %3D763231&amp;Require=replaces&gt;
   &lt;/allOneLine&gt;
   Supported: gruu, replaces, tdialog
   Require: tdialog
   Referred-By: &lt;sips:transferor@atlanta.example.com&gt;
    ;cid="20398823.2UWQFN309shb3@atlanta.example.com"
   Target-Dialog: 592435881734450904;local-tag=9m2n3wq;remote-tag=763231
   Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
   Content-Type: multipart/mixed; boundary=unique-boundary-1
   Content-Length: ...

   --unique-boundary-1
   Content-ID: &lt;20398823.2UWQFN309shb3@atlanta.example.com&gt;

   Content-Length: 2961
   Content-Type: multipart/signed;
                protocol="application/pkcs-7-signature";
                micalg=sha1;
                boundary="----590F24D439B31E08745DEF0CD9397189"

   ------590F24D439B31E08745DEF0CD9397189
   Content-Type: message/sipfrag

   Date: Thu, 18 Sep 2003 13:07:43 GMT
   &lt;allOneLine&gt;
   Refer-To: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958
   ?Replaces=090459243588173445%3B
   to-tag%3D9m2n3wq%3Bfrom-tag%3D763231&amp;Require=replaces&gt;
   &lt;/allOneLine&gt;
   Referred-By: &lt;sips:transferor@atlanta.example.com&gt;
    ;cid="20398823.2UWQFN309shb3@atlanta.example.com"

   ------590F24D439B31E08745DEF0CD9397189
   Content-Type: application/pkcs-7-signature; name="smime.p7s"





<span class="grey">Sparks, et al.           Best Current Practice                 [Page 47]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-48" id="page-48" name="page-48"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   Content-Transfer-Encoding: binary
   Content-Disposition: attachment; filename="smime.p7s"

   &lt;hex&gt;3082088806092A86
   4886F70D010702A082087930820875020101310B300906052B0E03021A050030

   . . . (Signature not shown)

   8E63D306487A740A197A3970594CF47DD385643B1DC49FF767A3D2B428388966
   79089AAD95767F&lt;/hex&gt;

   ------590F24D439B31E08745DEF0CD9397189--

   --unique_boundary-1


   F6 INVITE Transferee -&gt; Transfer Target

   INVITE sips:482n4z24kdg@chicago.example.com;gr=8594958 SIP/2.0
   Via: SIP/2.0/TLS referee.example;branch=z9hG4bKffe209934aac
   To: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958&gt;
   From: &lt;sips:transferee@biloxi.example.com&gt;;tag=2909034023
   Call-ID: fe9023940-a3465@referee.example
   CSeq: 889823409 INVITE
   Max-Forwards: 70
   Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
   Referred-By: &lt;sips:transferor@atlanta.example.com&gt;
      ;cid="20398823.2UWQFN309shb3@atlanta.example.com"
   Replaces:090459243588173445;to-tag=9m2n3wq;from-
    tag=76323
   Require: replaces
   Supported: gruu, replaces, tdialog
   Content-Type: multipart/mixed; boundary=my-boundary-9
   Content-Length: ...

   --my-boundary-9
   Content-Type: application/sdp

   Content-Length: 156

   v=0
   o=referee 2890844526 2890844526 IN IP4 referee.example
   s=Session SDP
   c=IN IP4 referee.example
   t=0 0
   m=audio 49172 RTP/AVP 0
   a=rtpmap:0 PCMU/8000




<span class="grey">Sparks, et al.           Best Current Practice                 [Page 48]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-49" id="page-49" name="page-49"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   --my-boundary-9
   Content-Length: 2961
   Content-Type: multipart/signed;
                protocol="application/pkcs-7-signature";
                micalg=sha1;
                boundary="----590F24D439B31E08745DEF0CD9397189"

   ------590F24D439B31E08745DEF0CD9397189
   Content-Type: message/sipfrag

   Date: Thu, 18 Sep 2003 13:07:43 GMT

   &lt;allOneLine&gt;
   Refer-To: &lt;sips:transfertarget@chicago.example.com;
   Replaces=090459243588173445%3B
   to-tag%3D9m2n3wq%3Bfrom-tag%3D763231&amp;Require=replaces&gt;
   &lt;/allOneLine&gt;
   Referred-By: &lt;sips:transferor@atlanta.example.com&gt;
    ;cid="20398823.2UWQFN309shb3@atlanta.example.com"

   ------590F24D439B31E08745DEF0CD9397189
   Content-Type: application/pkcs-7-signature; name="smime.p7s"
   Content-Transfer-Encoding: binary
   Content-Disposition: attachment; filename="smime.p7s"

   &lt;hex&gt;3082088806092A86
   4886F70D010702A082087930820875020101310B300906052B0E03021A050030

   . . .  (Signature not shown)

   8E63D306487A740A197A3970594CF47DD385643B1DC49FF767A3D2B428388966
   79089AAD95767F&lt;/hex&gt;

   ------590F24D439B31E08745DEF0CD9397189--

   --my-boundary-9--

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/9.%20%20Transfer%20as%20an%20Ad%20Hoc%20Conference"></a><a class="selflink" href="#section-9" name="section-9">9</a>.  Transfer as an Ad Hoc Conference</span>

   In this flow, shown in Figure 17, Bob does an attended transfer of
   Alice to Carol.  In order to keep both Alice and Carol fully informed
   of the nature and state of the transfer operation, Bob acts as a
   focus [<a href="rfc4579.html" title='"Session Initiation Protocol (SIP) Call Control - Conferencing for User Agents"'>RFC4579</a>] and hosts an ad hoc conference involving Alice, Bob,
   and Carol.  Alice and Carol subscribe to the conference package
   [<a href="rfc4575.html" title='"A Session Initiation Protocol (SIP) Event Package for Conference State"'>RFC4575</a>] of Bob's focus, which allows them to know the exact status
   of the operation.  After the transfer operation is complete, Bob
   deletes the conference.




<span class="grey">Sparks, et al.           Best Current Practice                 [Page 49]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-50" id="page-50" name="page-50"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   This call flow meets requirement 6 of <a href="#section-4">Section 4</a>.  NOTIFY messages
   related to the refer package are indicated as NOTIFY (refer), while
   NOTIFYs related to the Conference Info package are indicated as
   NOTIFY (Conf-Info).

   Note that any type of semi-attended transfer in which media mixing or
   relaying could be implemented using this model.  In addition to
   simply mixing, the focus could introduce additional media signals
   such as simulated ring tone or on hold announcements to improve the
   user experience.

   Alice                  Bob                 Carol
      |                    |                    |
      | INVITE             |                    |
      |-------------------&gt;|                    |
      |   180 Ringing      |                    |
      |&lt;-------------------|                    |
      |     200 OK         |                    |
      |&lt;-------------------|                    |
      |        ACK         |                    |
      |-------------------&gt;|                    |
      |        RTP         |                    |
      |&lt;==================&gt;|                    |
      |                    |                    |
   Bob places Alice on hold and begins acting like a focus
      |                    |                    |
      | INVITE (hold) Contact:Conf-ID;isfocus   |
      |&lt;-------------------|                    |
      |    200 OK          |                    |
      |-------------------&gt;|                    |
      |        ACK         |                    |
      |&lt;-------------------|                    |
      |                    |                    |
      | Alice subscribes to the conference package
      |                    |                    |
      | SUBSCRIBE sip:Conf-ID                   |
      |-------------------&gt;|                    |
      |     200 OK         |                    |
      |&lt;-------------------|                    |
      | NOTIFY (Conf-Info) |                    |
      |&lt;-------------------|                    |
      |     200 OK         |                    |
      |-------------------&gt;|                    |
      |                    |                    |
      |       Bob begins consultation operation |
      |                    |                    |
      |INVITE Require:replaces Contact:Conf-ID;isfocus
      |                    |-------------------&gt;|



<span class="grey">Sparks, et al.           Best Current Practice                 [Page 50]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-51" id="page-51" name="page-51"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


      |                    |   180 Ringing      |
      |                    |&lt;-------------------|
      |                    |     200 OK         |
      |                    |&lt;-------------------|
      |                    |       ACK          |
      |                    |-------------------&gt;|
      |                    |        RTP         |
      |                    |&lt;==================&gt;|
      |                    |                    |
      |Carol subscribes to the conference package
      |                - learns Bob is on hold  |
      |                    |                    |
      |                    |SUBSCRIBE sip:Conf-ID
      |                    |&lt;-------------------|
      |                    |      200 OK        |
      |                    |-------------------&gt;|
      |                    | NOTIFY (Conf-Info) |
      |                    |-------------------&gt;|
      |                    |      200 OK        |
      |                    |&lt;-------------------|
      |                    |                    |
      | Alice learns that Bob is talking to Carol
      |                    |                    |
      | NOTIFY (Conf-Info) |                    |
      |&lt;-------------------|                    |
      |     200 OK         |                    |
      |-------------------&gt;|                    |
      |                    |  INVITE (hold)     |
      |                    |-------------------&gt;|
      |                    |      200 OK        |
      |                    |&lt;-------------------|
      |                    |      ACK           |
      |                    |-------------------&gt;|
      |                    |                    |
      | Alice learns that Carol is now on hold  |
      |                    |                    |
      | NOTIFY (Conf-Info) |                    |
      |&lt;-------------------|                    |
      |     200 OK         |                    |
      |-------------------&gt;|                    |
      |                    |                    |
      |           Bob begins transfer operation |
      |                    |                    |
      |     REFER Refer-To: Carol               |
      |&lt;-------------------|                    |
      |     202 Accepted   |                    |
      |-------------------&gt;|                    |
      | NOTIFY (Refer)     |                    |



<span class="grey">Sparks, et al.           Best Current Practice                 [Page 51]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-52" id="page-52" name="page-52"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


      |-------------------&gt;|                    |
      |     200 OK         |                    |
      |&lt;-------------------|                    |
      |  INVITE Replaces:B-C Contact:Alice      |
      |----------------------------------------&gt;|
      |                 200 OK                  |
      |&lt;----------------------------------------|
      |                   ACK                   |
      |----------------------------------------&gt;|
      |                    RTP                  |
      |&lt;=======================================&gt;|
      |                    |       BYE          |
      |                    |&lt;-------------------|
      |                    |      200 OK        |
      |                    |-------------------&gt;|
      | NOTIFY (Refer)     |                    |
      |-------------------&gt;|                    |
      |     200 OK         |                    |
      |&lt;-------------------|                    |
      |                    |                    |
      | Bob terminates the ad-hoc conference    |
      |                    |                    |
      |       BYE          |                    |
      |&lt;-------------------|                    |
      |     200 OK         |                    |
      |-------------------&gt;|                    |
      |                    | NOTIFY (Conf-Info) |
      |                    |-------------------&gt;|
      |                    |      200 OK        |
      |                    |&lt;-------------------|
      | NOTIFY (Conf-Info) |                    |
      |&lt;-------------------|                    |
      |     200 OK         |                    |
      |-------------------&gt;|                    |

   Figure 17: Attended Transfer as an Ad Hoc Conference

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/10.%20%20Transfer%20with%20Multiple%20Parties"></a><a class="selflink" href="#section-10" name="section-10">10</a>.  Transfer with Multiple Parties</span>

   In this example, shown in Figure 18, the Originator places a call to
   the Facilitator who reaches the Recipient through the Screener.  The
   Recipient's contact information is exposed to the Facilitator and the
   Originator.  This example is provided for clarification of the
   semantics of the REFER method only, and it should not be used as the
   design of an implementation.






<span class="grey">Sparks, et al.           Best Current Practice                 [Page 52]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-53" id="page-53" name="page-53"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


       Originator   Facilitator   Screener   Recipient
      |            |            |          |
   1  |INVITE/200 OK/ACK        |          |"Get Fred for me!"
      |-----------&gt;|            |          |     "Right away!"
   2  |INVITE (hold)/200 OK/ACK |          |
      |&lt;-----------|            |          |
   2  |            |INVITE/200 OK/ACK      |"I have a call
      |            |-----------&gt;|          |from Mary for Fred"
   2  |            |INVITE (hold)/200 OK/ACK   "Hold please"
      |            |&lt;-----------|          |
   3  |            |            |INVITE/200 OK/ACK
      |            |            |---------&gt;|"You have a call
      |            |            |          |from Mary"
      |            |            |          |  "Put her through"
   3  |            |            |INVITE (hold)/200 OK/ACK
      |            |            |---------&gt;|
   4  |            |REFER       |          |
      |            |&lt;-----------|          |
   4  |            |202 Accepted|          |
      |            |-----------&gt;|          |
   4  |            |NOTIFY (100 Trying)    |
      |            |-----------&gt;|          |
   4  |            |200 OK      |          |
      |            |&lt;-----------|          |
   5  |            |INVITE/200 OK/ACK      |
      |            |----------------------&gt;|"This is Fred"
   4  |            |NOTIFY (200 OK)        |  "Please hold for
      |            |-----------&gt;|          |              Mary"
   4  |            |200 OK      |          |
      |            |&lt;-----------|          |
   2  |            |BYE/200 OK  |          |
      |            |&lt;-----------|          |
   3  |            |            |BYE/200 OK|
      |            |            |---------&gt;|
   5  |            |INVITE (hold)/200 OK/ACK
      |            |----------------------&gt;|
   6  |REFER       |            |          |
      |&lt;-----------|            |          |
   6  |202 Accepted|            |          |
      |-----------&gt;|            |          |
   6  |NOTIFY (100 Trying)      |          |
      |-----------&gt;|            |          |
   6  |200 OK      |            |          |
      |&lt;-----------|            |          |
   7  |INVITE/200 OK/ACK        |          |
      |-----------------------------------&gt;| "Hey Fred"





<span class="grey">Sparks, et al.           Best Current Practice                 [Page 53]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-54" id="page-54" name="page-54"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   6  |NOTIFY (200 OK)          |          |    "Hello Mary"
      |-----------&gt;|            |          |
   6  |200 OK      |            |          |
      |&lt;-----------|            |          |
   1  |BYE/200 OK  |            |          |
      |&lt;-----------|            |          |
   5  |            |BYE/200 OK  |          |
      |            |----------------------&gt;|
   7  |BYE/200 OK  |            |          |
      |&lt;-----------------------------------| "See you later"

   Figure 18: Transfer with Multiple Parties Example

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/11.%20%20Gateway%20Transfer%20Issues"></a><a class="selflink" href="#section-11" name="section-11">11</a>.  Gateway Transfer Issues</span>

   A gateway in SIP acts as a User Agent.  As a result, the entire
   preceding discussion and call flows apply equally well to gateways as
   native SIP endpoints.  However, there are some gateway-specific
   issues that are documented in this section.  While this discussion
   focuses on the common cases involving Public Switched Telephone
   Network (PSTN) gateways, similar situations exist for other gateways,
   such as H.323/SIP gateways.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/11.1.%20%20Coerce%20Gateway%20Hairpins%20to%20the%20Same%20Gateway"></a><a class="selflink" href="#section-11.1" name="section-11.1">11.1</a>.  Coerce Gateway Hairpins to the Same Gateway</span>

   To illustrate how a hairpin situation can occur in transfer, consider
   this example.  The original call dialog is setup with the Transferee
   residing on the PSTN side of a SIP gateway.  The Transferor is a SIP
   phone purely in the IP space.  The Transfer Target is on the PSTN
   side of a SIP gateway as well.  After completing the transfer,
   (regardless of consultative or blind) the Transferee is in a call
   with the Transfer Target (both on the PSTN side of a gateway).  It is
   often desirable to remove the gateway(s) out of the loop.  This is
   likely to only be possible if both legs of the target call are on the
   same gateway.  With both legs on the same gateway, it may be able to
   invoke the analogous transfer on the PSTN side.  Then the target call
   would not involve the gateway.

   So the problem is how to give the proxy enough information so that it
   knows to route the call to the same gateway.  With a simple single
   call that hairpins, the incoming and outgoing leg have the same
   dialog.  The proxy should have enough information to optimize the
   routing.

   In the consultative transfer scenario, it is desirable to coerce the
   consultative INVITE out the same gateway as the original call to be
   transferred.  However, there is no way to relate the consultation
   with the original call.  In the consultative case, the target call



<span class="grey">Sparks, et al.           Best Current Practice                 [Page 54]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-55" id="page-55" name="page-55"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   INVITE includes the Replaces header, which contains dialog
   information that can be used to relate it to the consultation.
   However, there is no information that relates the target call to the
   original.

   In the blind transfer scenario, it is desirable to coerce the target
   call onto the same gateway as the original call.  However, the same
   problem exists in that the target-dialog cannot be related to the
   original dialog.

   In either transfer scenario, it may be desirable to push the transfer
   operation onto the non-SIP side of the gateway.  Presumably, this is
   not possible unless all of the legs go out the same gateway.  If the
   gateway supports more than one trunk group, it might also be
   necessary to get all of the legs on the same trunk group in order to
   perform the transfer on the non-SIP side of the gateway.

   Solutions to these gateway specific issues may involve new extensions
   to SIP in the future.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/11.2.%20%20Consultative%20Turned%20Blind%20Gateway%20Glare"></a><a class="selflink" href="#section-11.2" name="section-11.2">11.2</a>.  Consultative Turned Blind Gateway Glare</span>

   In the consultative transfer case turned blind, there is a glare-like
   problem.  The Transferor initiates the consultation INVITE, the
   Transferor gets impatient and hangs up, transitioning this to a blind
   transfer.  The Transfer Target on the gateway (connected through a
   PSTN switch to a single line or dumb analog phone) rings.  The user
   answers the phone just after the CANCEL is received by the Transfer
   Target.  The REFER and INVITE for the target call are sent.  The
   Transferee attempts to set up the call on the PSTN side, but gets
   either a busy response or lands in the users voicemail as the user
   has the handset in hand and off hook.

   This is another example of a race condition that this call flow can
   cause.  The recommended behavior is to use the approach described in
   <a href="#section-7.6">Section 7.6</a>.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/12.%20%20Security%20Considerations"></a><a class="selflink" href="#section-12" name="section-12">12</a>.  Security Considerations</span>

   The call transfer flows shown in this document are implemented using
   the REFER and Replaces call control primitives in SIP.  As such, the
   security considerations detailed in the REFER [<a href="rfc3515.html" title='"The Session Initiation Protocol (SIP) Refer Method"'>RFC3515</a>] and Replaces
   [<a href="rfc3891.html" title='"The Session Initiation Protocol (SIP) "'>RFC3891</a>] documents MUST be followed, which are briefly summarized in
   the following paragraphs.  This document addresses the issue of
   protecting the Address of Record URI of a Transfer Target in Sections
   7.1 and 7.2.





<span class="grey">Sparks, et al.           Best Current Practice                 [Page 55]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-56" id="page-56" name="page-56"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   Any REFER request MUST be appropriately authenticated and authorized
   using standard SIP mechanisms or else calls may be hijacked.  A User
   Agent may use local policy or human intervention in deciding whether
   or not to accept a REFER.  In generating NOTIFY responses based on
   the outcome of the triggered request, care should be taken in
   constructing the message/sipfrag body to ensure that no private
   information is leaked.

   An INVITE containing a Replaces header field SHOULD only be accepted
   if it has been properly authenticated and authorized using standard
   SIP mechanisms, and the requestor is authorized to perform dialog
   replacement.  Special care is needed if the replaced dialog utilizes
   additional media streams compared to the original dialog.  In this
   case, the user MUST authorize the addition of new media streams in a
   dialog replacement.  For example, the same mechanism used to
   authorize the addition of a media stream in a re-INVITE could be
   used.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/13.%20%20Acknowledgments"></a><a class="selflink" href="#section-13" name="section-13">13</a>.  Acknowledgments</span>

   This document is a collaborative product of the SIP working group.
   Thanks to Rohan Mahy for his input on the use of Replaces in
   transfer.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/14.%20%20References"></a><a class="selflink" href="#section-14" name="section-14">14</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/14.1.%20%20Normative%20References"></a><a class="selflink" href="#section-14.1" name="section-14.1">14.1</a>.  Normative References</span>

   [<a id="ref-RFC2119" name="ref-RFC2119">RFC2119</a>]    Bradner, S., "Key words for use in RFCs to Indicate
                Requirement Levels", <a href="https://tools.ietf.org/html/bcp14">BCP 14</a>, <a href="rfc2119.html">RFC 2119</a>, March 1997.

   [<a id="ref-RFC3261" name="ref-RFC3261">RFC3261</a>]    Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston,
                A., Peterson, J., Sparks, R., Handley, M., and E.
                Schooler, "SIP: Session Initiation Protocol", <a href="rfc3261.html">RFC 3261</a>,
                June 2002.

   [<a id="ref-RFC3515" name="ref-RFC3515">RFC3515</a>]    Sparks, R., "The Session Initiation Protocol (SIP) Refer
                Method", <a href="rfc3515.html">RFC 3515</a>, April 2003.

   [<a id="ref-RFC3891" name="ref-RFC3891">RFC3891</a>]    Mahy, R., Biggs, B., and R. Dean, "The Session
                Initiation Protocol (SIP) "Replaces" Header", <a href="rfc3891.html">RFC 3891</a>,
                September 2004.

   [<a id="ref-RFC3892" name="ref-RFC3892">RFC3892</a>]    Sparks, R., "The Session Initiation Protocol (SIP)
                Referred-By Mechanism", <a href="rfc3892.html">RFC 3892</a>, September 2004.






<span class="grey">Sparks, et al.           Best Current Practice                 [Page 56]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-57" id="page-57" name="page-57"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


   [<a id="ref-RFC4538" name="ref-RFC4538">RFC4538</a>]    Rosenberg, J., "Request Authorization through Dialog
                Identification in the Session Initiation Protocol
                (SIP)", <a href="rfc4538.html">RFC 4538</a>, June 2006.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/14.2.%20%20Informative%20References"></a><a class="selflink" href="#section-14.2" name="section-14.2">14.2</a>.  Informative References</span>

   [<a id="ref-CC-FRMWRK" name="ref-CC-FRMWRK">CC-FRMWRK</a>]  Mahy, R., Sparks, R., Rosenberg, J., Petrie, D., and A.
                Johnston, "A Call Control and Multi-party usage
                framework for the Session Initiation Protocol (SIP)",
                Work in Progress, March 2009.

   [<a id="ref-RFC4353" name="ref-RFC4353">RFC4353</a>]    Rosenberg, J., "A Framework for Conferencing with the
                Session Initiation Protocol (SIP)", <a href="rfc4353.html">RFC 4353</a>,
                February 2006.

   [<a id="ref-RFC4475" name="ref-RFC4475">RFC4475</a>]    Sparks, R., Hawrylyshen, A., Johnston, A., Rosenberg,
                J., and H. Schulzrinne, "Session Initiation Protocol
                (SIP) Torture Test Messages", <a href="rfc4475.html">RFC 4475</a>, May 2006.

   [<a id="ref-RFC4575" name="ref-RFC4575">RFC4575</a>]    Rosenberg, J., Schulzrinne, H., and O. Levin, "A Session
                Initiation Protocol (SIP) Event Package for Conference
                State", <a href="rfc4575.html">RFC 4575</a>, August 2006.

   [<a id="ref-RFC4579" name="ref-RFC4579">RFC4579</a>]    Johnston, A. and O. Levin, "Session Initiation Protocol
                (SIP) Call Control - Conferencing for User Agents",
                <a href="https://tools.ietf.org/html/bcp119">BCP 119</a>, <a href="rfc4579.html">RFC 4579</a>, August 2006.

   [<a id="ref-RFC5057" name="ref-RFC5057">RFC5057</a>]    Sparks, R., "Multiple Dialog Usages in the Session
                Initiation Protocol", <a href="rfc5057.html">RFC 5057</a>, November 2007.

   [<a id="ref-SIP-GRUU" name="ref-SIP-GRUU">SIP-GRUU</a>]   Rosenberg, J., "Obtaining and Using Globally Routable
                User Agent (UA) URIs (GRUU) in the Session Initiation
                Protocol (SIP)", Work in Progress, October 2007.


















<span class="grey">Sparks, et al.           Best Current Practice                 [Page 57]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-58" id="page-58" name="page-58"> </a>
<span class="grey"><a href="rfc5589.html">RFC 5589</a>                    SIP CC Transfer                    June 2009</span>


Authors' Addresses

   Robert Sparks
   Tekelec
   17210 Campbell Road
   Suite 250
   Dallas, Texas  75252
   USA

   EMail: RjS@nostrum.com


   Alan Johnston (editor)
   Avaya
   St. Louis, MO

   EMail: alan@sipstation.com


   Daniel Petrie
   SIPez LLC
   Arlington, MA  02476
   US

   Phone: +1 617 273 4000
   EMail: dan.ietf@SIPez.com
   URI:   <a href="http://www.sipez.com/">http://www.SIPez.com/</a>
























Sparks, et al.           Best Current Practice                 [Page 58]

</pre><br/>
    <span class="noprint"><small><small>Html markup produced by rfcmarkup 1.126, available from
      <a href="https://tools.ietf.org/tools/rfcmarkup/">https://tools.ietf.org/tools/rfcmarkup/</a>
    </small></small></span>
  </div>




</body><!-- Mirrored from tools.ietf.org/html/rfc5589 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Mar 2018 23:18:35 GMT --></html>