<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><!-- Mirrored from tools.ietf.org/html/rfc5508 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Mar 2018 23:18:34 GMT --><!-- Added by HTTrack --><head><meta content="text/html;charset=utf-8" http-equiv="content-type"/><!-- /Added by HTTrack -->

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <meta content="index,follow" name="robots"/>
    <meta content="rfcmarkup version 1.126" name="creator"/>
    <link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/>
<meta content="draft-srisuresh-behave-nat-icmp" name="DC.Relation.Replaces"/>
<meta content="urn:ietf:rfc:5508" name="DC.Identifier"/>
<meta content="April, 2009" name="DC.Date.Issued"/>
<meta content="Srisuresh, Pyda" name="DC.Creator"/>
<meta content="Sivakumar, Senthil" name="DC.Creator"/>
<meta content="Ford, Bryan" name="DC.Creator"/>
<meta content="Guha, Saikat" name="DC.Creator"/>
<meta content="This document specifies the behavioral properties required of the
Network Address Translator (NAT) devices in conjunction with the
Internet Control Message Protocol (ICMP). The objective of this memo
is to make NAT devices more predictable and compatible with diverse
application protocols that traverse the devices. Companion documents
provide behavioral recommendations specific to TCP, UDP, and other
protocols. This document specifies an Internet Best Current Practices
for the Internet Community, and requests discussion and suggestions
for improvements." name="DC.Description.Abstract"/>
<meta content="NAT Behavioral Requirements for ICMP" name="DC.Title"/>

    <link href="https://tools.ietf.org/images/rfc.png" rel="icon" type="image/png"/>
    <link href="https://tools.ietf.org/images/rfc.png" rel="shortcut icon" type="image/png"/>
    <title>RFC 5508 - NAT Behavioral Requirements for ICMP</title>
    
    
    <style type="text/css">
	@media only screen 
	  and (min-width: 992px)
	  and (max-width: 1199px) {
	    body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 768px)
	  and (max-width: 991px) {
            body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 480px)
	  and (max-width: 767px) {
            body { font-size: 11pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (max-width: 479px) {
            body { font-size: 8pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-device-width : 375px) 
	  and (max-device-width : 667px) {
            body { font-size: 9.5pt; }
            div.content { width: 96ex; margin: 0 1px; }
        }
	@media only screen 
	  and (min-device-width: 1200px) {
            body { font-size: 10pt; margin: 0 4em; }
            div.content { width: 96ex; margin: 0; }
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        a.selflink {
          color: black;
          text-decoration: none;
        }
        @media print {
            body {
                font-family: monospace;
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 1em;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>                   <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>                     <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>             <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>              <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td>      <td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td>         <td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard (old designation):</td> <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Internet Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>                  <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>                  <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
  <div class="content">
   <div style="height: 13px;">
      <div class="pre noprint docinfo bgmagenta" onclick="showElem('legend');" onmouseout="hideElem('legend')" onmouseover="this.style.cursor='pointer';" style="height: 6px; position: absolute;" title="Click for colour legend.">                                                                        </div>
      <div class="docinfo noprint pre legend" id="legend" onmouseout="hideElem('legend');" onmouseover="showElem('legend');" style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; ">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="index.html" title="Document search and retrieval page">Docs</a>] [<a href="https://tools.ietf.org/rfc/rfc5508.txt" title="Plaintext version of this document">txt</a>|<a href="https://tools.ietf.org/pdf/rfc5508" title="PDF version of this document">pdf</a>] [<a href="https://tools.ietf.org/html/draft-ietf-behave-nat-icmp" title="draft-ietf-behave-nat-icmp">draft-ietf-beha...</a>] [<a href="https://datatracker.ietf.org/doc/rfc5508" title="IESG Datatracker information for this document">Tracker</a>] [<a href="https://tools.ietf.org/rfcdiff?difftype=--hwdiff&amp;url2=rfc5508" title="Inline diff (wdiff)">Diff1</a>] [<a href="https://tools.ietf.org/rfcdiff?url2=rfc5508" title="Side-by-side diff">Diff2</a>]         </span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<span class="pre noprint docinfo">Updated by: <a href="rfc7857.html">7857</a>                                   BEST CURRENT PRACTICE</span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<pre>Network Working Group                                       P. Srisuresh
Request for Comments: 5508                                Kazeon Systems
BCP: 148                                                         B. Ford
Category: Best Current Practice                                  MPI-SWS
                                                            S. Sivakumar
                                                           Cisco Systems
                                                                 S. Guha
                                                              Cornell U.
                                                              April 2009


                 <span class="h1">NAT Behavioral Requirements for ICMP</span>

Status of This Memo

   This document specifies an Internet Best Current Practices for the
   Internet Community, and requests discussion and suggestions for
   improvements.  Distribution of this memo is unlimited.

Copyright Notice

   Copyright (c) 2009 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="https://tools.ietf.org/html/bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents in effect on the date of
   publication of this document (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>).
   Please review these documents carefully, as they describe your rights
   and restrictions with respect to this document.

   This document may contain material from IETF Documents or IETF
   Contributions published or made publicly available before November
   10, 2008.  The person(s) controlling the copyright in some of this
   material may not have granted the IETF Trust the right to allow
   modifications of such material outside the IETF Standards Process.
   Without obtaining an adequate license from the person(s) controlling
   the copyright in such materials, this document may not be modified
   outside the IETF Standards Process, and derivative works of it may
   not be created outside the IETF Standards Process, except to format
   it for publication as an RFC or to translate it into languages other
   than English.










<span class="grey">Srisuresh, et al.        Best Current Practice                  [Page 1]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-2" id="page-2" name="page-2"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


Abstract

   This document specifies the behavioral properties required of the
   Network Address Translator (NAT) devices in conjunction with the
   Internet Control Message Protocol (ICMP).  The objective of this memo
   is to make NAT devices more predictable and compatible with diverse
   application protocols that traverse the devices.  Companion documents
   provide behavioral recommendations specific to TCP, UDP, and other
   protocols.

Table of Contents

   <a href="#section-1">1</a>. Introduction and Scope ..........................................<a href="#page-3">3</a>
   <a href="#section-2">2</a>. Terminology .....................................................<a href="#page-4">4</a>
   <a href="#section-3">3</a>. ICMP Query Handling .............................................<a href="#page-6">6</a>
      <a href="#section-3.1">3.1</a>. ICMP Query Mapping .........................................<a href="#page-6">6</a>
      <a href="#section-3.2">3.2</a>. ICMP Query Session Timeouts ................................<a href="#page-7">7</a>
   <a href="#section-4">4</a>. ICMP Error Forwarding ...........................................<a href="#page-8">8</a>
      <a href="#section-4.1">4.1</a>. ICMP Error Payload Validation ..............................<a href="#page-8">8</a>
      <a href="#section-4.2">4.2</a>. ICMP Error Packet Translation .............................<a href="#page-10">10</a>
           4.2.1. ICMP Error Packet Received from the External Realm .11
           <a href="#section-4.2.2">4.2.2</a>. ICMP Error Packet Received from the Private Realm ..13
      <a href="#section-4.3">4.3</a>. NAT Sessions Pertaining to ICMP Error Payload .............<a href="#page-15">15</a>
   <a href="#section-5">5</a>. Hairpinning Support for ICMP Packets ...........................<a href="#page-16">16</a>
   <a href="#section-6">6</a>. Rejection of Outbound Flows Disallowed by NAT ..................<a href="#page-17">17</a>
   <a href="#section-7">7</a>. Conformance to <a href="rfc1812.html">RFC 1812</a> ........................................<a href="#page-17">17</a>
      <a href="#section-7.1">7.1</a>. IP Packet Fragmentation ...................................<a href="#page-19">19</a>
           <a href="#section-7.1.1">7.1.1</a>.  Generating "Packet Too Big" ICMP Error Message ....<a href="#page-19">19</a>
           <a href="#section-7.1.2">7.1.2</a>.  Forwarding "Packet Too Big" ICMP Error Message ....<a href="#page-20">20</a>
      <a href="#section-7.2">7.2</a>. Time Exceeded Message .....................................<a href="#page-20">20</a>
      <a href="#section-7.3">7.3</a>. Source Route Options ......................................<a href="#page-20">20</a>
      <a href="#section-7.4">7.4</a>. Address Mask Request/Reply Messages .......................<a href="#page-20">20</a>
      <a href="#section-7.5">7.5</a>. Parameter Problem Message .................................<a href="#page-21">21</a>
      <a href="#section-7.6">7.6</a>. Router Advertisement and Solicitations ....................<a href="#page-21">21</a>
      <a href="#section-7.7">7.7</a>. DS Field Usage ............................................<a href="#page-21">21</a>
   <a href="#section-8">8</a>. Non-QueryError ICMP Messages ...................................<a href="#page-22">22</a>
   <a href="#section-9">9</a>. Summary of Requirements ........................................<a href="#page-22">22</a>
   <a href="#section-10">10</a>. Security Considerations .......................................<a href="#page-25">25</a>
   <a href="#section-11">11</a>. Acknowledgements ..............................................<a href="#page-26">26</a>
   <a href="#section-12">12</a>. References ....................................................<a href="#page-27">27</a>
      <a href="#section-12.1">12.1</a>. Normative References .....................................<a href="#page-27">27</a>
      <a href="#section-12.2">12.2</a>. Informative References ...................................<a href="#page-27">27</a>









<span class="grey">Srisuresh, et al.        Best Current Practice                  [Page 2]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-3" id="page-3" name="page-3"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/1.%20%20Introduction%20and%20Scope"></a><a class="selflink" href="#section-1" name="section-1">1</a>.  Introduction and Scope</span>

   As pointed out in <a href="rfc3424.html">RFC 3424</a> [<a href="#ref-UNSAF" title='"IAB Considerations for UNilateral Self-Address Fixing (UNSAF) Across Network Address Translation"'>UNSAF</a>], NAT implementations vary widely
   in terms of how they handle different traffic.  The purpose of this
   document is to define a specific set of requirements for NAT behavior
   with regard to ICMP messages.  The objective is to reduce the
   unpredictability and brittleness the NAT devices (NATs) introduce.
   This document is an adjunct to [<a href="#ref-BEH-UDP" title='"Network Address Translation (NAT) Behavioral Requirements for Unicast UDP"'>BEH-UDP</a>], [<a href="#ref-BEH-TCP" title='"NAT Behavioral Requirements for TCP"'>BEH-TCP</a>], and other
   protocol-specific BEHAVE document(s) in the future that define
   requirements for NATs when handling protocol-specific traffic.

   The requirements of this specification apply to traditional NATs as
   described in [<a href="#ref-NAT-TRAD" title='"Traditional IP Network Address Translator (Traditional NAT)"'>NAT-TRAD</a>].  A traditional NAT has two variations,
   namely Basic NAT and Network Address Port Translator (NAPT).  Of
   these, NAPT is by far the most commonly deployed NAT device.  NAPT
   allows multiple private hosts to share a single public IP address
   simultaneously.

   This document only covers the ICMP aspects of NAT traversal,
   specifically the traversal of ICMP Query messages and ICMP Error
   messages.  Traditional NAT inherently mandates firewall-like
   filtering behavior [<a href="#ref-BEH-UDP" title='"Network Address Translation (NAT) Behavioral Requirements for Unicast UDP"'>BEH-UDP</a>].  However, firewall functionality in
   general or any other middlebox functionality is out of the scope of
   this document.

   In some cases, ICMP message traversal behavior on a NAT device may be
   overridden by local administrative policies.  Some administrators may
   choose to entirely prohibit forwarding of ICMP Error messages across
   a NAT device.  Some others may choose to prohibit ICMP-Query-based
   applications across a NAT device.  These are local policies and not
   within the scope of this document.  For this reason, some of the ICMP
   requirements listed in the document are preceded with a constraint of
   local policy permitting.

   This document focuses strictly on the behavior of the NAT device, and
   not on the behavior of applications that traverse NATs.  Application
   designers may refer to [<a href="#ref-BEH-APP" title='"Application Design Guidelines for Traversal through Network Address Translators"'>BEH-APP</a>] and [<a href="#ref-ICE" title='"Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols"'>ICE</a>] for recommendations and
   guidelines on how to make applications work robustly over NATs that
   follow the requirements specified here and the adjunct protocol-
   specific BEHAVE documents.

   Per [<a href="rfc1812.html" title='"Requirements for IP Version 4 Routers"'>RFC1812</a>], ICMP is a control protocol that is considered to be an
   integral part of IP, although it is architecturally layered upon IP
   -- it uses IP to carry its data end-to-end.  As such, many of the
   ICMP behavioral requirements discussed in this document apply to all
   IP protocols.





<span class="grey">Srisuresh, et al.        Best Current Practice                  [Page 3]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-4" id="page-4" name="page-4"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   In case a requirement in this document conflicts with protocol-
   specific BEHAVE requirement(s), protocol-specific BEHAVE documents
   will take precedence.  The authors are not aware of any conflicts
   between this and any other IETF document at the time of this writing.

   <a href="#section-2">Section 2</a> describes the terminology used throughout the document.
   <a href="#section-3">Section 3</a> is focused on requirements concerning ICMP-Query-based
   applications traversing a NAT device.  Sections <a href="#section-4">4</a> and <a href="#section-5">5</a> describe
   requirements concerning ICMP Error messages traversing a NAT device.
   Sections <a href="#section-6">6</a> describes requirements concerning ICMP Error messages
   generated by a NAT device.  <a href="#section-7">Section 7</a> reviews <a href="rfc1812.html">RFC 1812</a> conformance
   requirements and applicability to NATs when handling ICMP messages.
   <a href="#section-8">Section 8</a> reviews a requirement for ICMP messages that are neither
   ICMP Query nor ICMP Error kind.  <a href="#section-9">Section 9</a> summarizes all the
   requirements in one place.  <a href="#section-10">Section 10</a> has a discussion on security
   considerations.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/2.%20%20Terminology"></a><a class="selflink" href="#section-2" name="section-2">2</a>.  Terminology</span>

   Definitions for the majority of the NAT terms used throughout the
   document may be found in [<a href="#ref-NAT-TERM" title='"IP Network Address Translator (NAT) Terminology and Considerations"'>NAT-TERM</a>] and [<a href="#ref-BEH-UDP" title='"Network Address Translation (NAT) Behavioral Requirements for Unicast UDP"'>BEH-UDP</a>].

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <a href="rfc2119.html">RFC 2119</a> [<a href="rfc2119.html" title='"Key words for use in RFCs to Indicate Requirement Levels"'>RFC2119</a>].

   The term "Realm" is adapted from [<a href="#ref-NAT-TERM" title='"IP Network Address Translator (NAT) Terminology and Considerations"'>NAT-TERM</a>] and is defined as
   follows.  "Realm" is often interchanged for "network domain" or
   simply "network" throughout the document.

   Address realm or Realm - An address realm is a network domain in
   which the network addresses are uniquely assigned to entities such
   that datagrams can be routed to them.  Routing protocols used within
   the network domain are responsible for finding routes to entities
   given their network addresses.  Note that this document is limited to
   describing NAT in the IPv4 environment and does not address the use
   of NAT in other types of environments (e.g., the IPV6 environment).

   The term "NAT Session" is adapted from [<a href="#ref-NAT-MIB" title='"Definitions of Managed Objects for Network Address Translators (NAT)"'>NAT-MIB</a>] and is defined as
   follows:

   NAT Session - A NAT session is an association between a session as
   seen in the private realm and a session as seen in the public realm,
   by virtue of NAT translation.  If a session in the private realm were
   to be represented as (PrivateSrcAddr, PrivateDstAddr,
   TransportProtocol, PrivateSrcPort, PrivateDstPort) and the same
   session in the public realm were to be represented as (PublicSrcAddr,
   PublicDstAddr, TransportProtocol, PublicSrcPort, PublicDstPort), the



<span class="grey">Srisuresh, et al.        Best Current Practice                  [Page 4]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-5" id="page-5" name="page-5"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   NAT session would provide the translation glue between the two
   session representations.  NAT sessions in the document are restricted
   to sessions based on TCP, UDP, and ICMP.  In the future, NAT sessions
   may be extended to be based on other transport protocols such as
   Stream Control Transmission Protocol (SCTP), UDP-lite, and Datagram
   Congestion Control Protocol (DCCP).

   ICMP Message Classification - <a href="rfc1122.html#section-3.2.2">Section 3.2.2 of [RFC1122]</a> and <a href="rfc1812.html#section-4.3.1">Section</a>
   <a href="rfc1812.html#section-4.3.1">4.3.1 of [RFC1812]</a> broadly group ICMP messages into two main
   categories, namely "ICMP Query" messages and "ICMP Error" messages.
   All ICMP Error messages listed in <a href="rfc1122.html">RFC 1122</a> and <a href="rfc1812.html">RFC 1812</a> contain part
   of the Internet datagram that elicited the ICMP error.  All the ICMP
   Query messages listed in <a href="rfc1122.html">RFC 1122</a> and <a href="rfc1812.html">RFC 1812</a> contain an
   "Identifier" field, which is referred to in this document as the
   "Query Identifier".  There are however ICMP messages that do not fall
   into either of these two categories.  We refer to them as "Non-
   QueryError ICMP Messages".  All three ICMP message classes are
   described as follows:

   o ICMP Query Messages - ICMP Query messages are characterized by an
     Identifier field in the ICMP header.  The Identifier field used by
     the ICMP Query messages is also referred to as "Query Identifier"
     or "Query Id", for short throughout the document.  A Query Id is
     used by Query senders and responders as the equivalent of a TCP/UDP
     port to identify an ICMP Query session.  ICMP Query messages
     include ICMP messages defined after <a href="rfc1122.html">RFC 1122</a> or <a href="rfc1812.html">RFC 1812</a> (for
     example, Domain Name Request/Reply ICMP messages defined in <a href="rfc1788.html">RFC</a>
     <a href="rfc1788.html">1788</a>), as they include request/response pairs and contain an
     "Identifier" field.

   o ICMP Error Messages - ICMP Error messages provide signaling for IP.
     All ICMP Error messages are characterized by the fact that they
     embed the original datagram that triggered the ICMP Error message.
     The original datagram embedded within the ICMP Error payload is
     also referred to as the "Embedded packet" throughout the document.
     Unlike ICMP Query messages, ICMP Error messages do not have a Query
     Id in the ICMP header.

   o Non-QueryError ICMP Messages - ICMP messages that do not fall under
     either of the above two classes are referred to as "Non-QueryError
     ICMP Messages" throughout the document.  For example, Router
     Discovery ICMP messages [<a href="rfc1256.html" title='"ICMP Router Discovery Messages"'>RFC1256</a>] are "request/response" type ICMP
     messages.  However, they are not characterized as ICMP Query
     messages in this document as they do not have an "Identifier" field
     within the messages.  Likewise, there are other ICMP messages
     defined in [<a href="rfc4065.html" title='"Instructions for Seamoby and Experimental Mobility Protocol IANA Allocations"'>RFC4065</a>] that do not fall in either of the ICMP Query
     or ICMP Error message categories, but will be referred to as Non-
     QueryError ICMP messages.



<span class="grey">Srisuresh, et al.        Best Current Practice                  [Page 5]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-6" id="page-6" name="page-6"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   The reason for categorizing ICMP messages for NAT behavioral
   properties is that each category has different characteristics used
   for mapping (i.e., the Query Id and the Embedded datagram), which
   leaves the Non-QueryError ICMP messages in a separate, distinctive
   group.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/3.%20%20ICMP%20Query%20Handling"></a><a class="selflink" href="#section-3" name="section-3">3</a>.  ICMP Query Handling</span>

   This section lists the behavioral requirements for a NAT device when
   processing ICMP Query packets.  The following subsections discuss
   requirements specific to ICMP Query handling in detail.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.1.%20%20ICMP%20Query%20Mapping"></a><a class="selflink" href="#section-3.1" name="section-3.1">3.1</a>.  ICMP Query Mapping</span>

   Unless explicitly overridden by local policy, a NAT device MUST
   permit ICMP Queries and their associated responses, when the Query is
   initiated from a private host to the external hosts.  ICMP Query
   mapping by NAT devices is necessary for current ICMP-Query-based
   applications to work.  This entails a NAT device to transparently
   forward ICMP Query packets initiated from the nodes behind NAT, and
   the responses to these Query packets in the opposite direction.  As
   specified in [<a href="#ref-NAT-TRAD" title='"Traditional IP Network Address Translator (Traditional NAT)"'>NAT-TRAD</a>], this requires translating the IP header.  A
   NAPT device further translates the ICMP Query Id and the associated
   checksum in the ICMP header prior to forwarding.

   NAT mapping of ICMP Query Identifiers SHOULD be external-host
   independent.  Say, an internal host A sent an ICMP Query out to an
   external host B using Query Id X.  And, say, the NAT assigned this an
   external mapping of Query Id X' on the NAT's public address.  If host
   A reused the Query Id X to send ICMP Queries to the same or different
   external host, the NAT device SHOULD reuse the same Query Id mapping
   (i.e., map the private host's Query Id X to Query Id X' on NAT's
   public IP address) instead of assigning a different mapping.  This is
   similar to the "endpoint independent mapping" requirement specified
   in the TCP and UDP requirement documents [<a href="#ref-BEH-UDP" title='"Network Address Translation (NAT) Behavioral Requirements for Unicast UDP"'>BEH-UDP</a>], [<a href="#ref-BEH-TCP" title='"NAT Behavioral Requirements for TCP"'>BEH-TCP</a>].

   Below is justification for making the endpoint-independent mapping
   for ICMP Query Id a SHOULD [<a href="rfc2119.html" title='"Key words for use in RFCs to Indicate Requirement Levels"'>RFC2119</a>] requirement.  ICMP Ping
   [<a href="rfc1470.html" title='"FYI on a Network Management Tool Catalog: Tools for Monitoring and Debugging TCP/IP Internets and Interconnected Devices"'>RFC1470</a>] and ICMP traceroute [<a href="#ref-MS-TRCRT" title='"How to use the Tracert command-line utility to troubleshoot TCP/IP problems in Windows"'>MS-TRCRT</a>] are two most commonly known
   legacy applications built on top of ICMP Query messages.  Neither of
   these applications require the ICMP Query Id to be retained across
   different sessions with external hosts.  But, that may not be the
   case with future applications.  In the future, when an end host
   application reuses the same Query Identifier in sessions with
   different target hosts, the end host application might require that
   the endpoint identity (i.e., the tuple of IP address and Query
   Identifier) appears the same across all its target hosts.  In an IP
   network without NAT requirements, such a requirement will be valid.



<span class="grey">Srisuresh, et al.        Best Current Practice                  [Page 6]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-7" id="page-7" name="page-7"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   In a world with NAT devices, the above assumption will be valid when
   NAT devices enforce endpoint mapping that is external-host
   independent.  Given the dichotomy between legacy applications not
   requiring endpoint-independent mapping and future applications that
   might require it, the requirement level is kept at SHOULD [<a href="rfc2119.html" title='"Key words for use in RFCs to Indicate Requirement Levels"'>RFC2119</a>].

   REQ-1: Unless explicitly overridden by local policy, a NAT device
          MUST permit ICMP Queries and their associated responses, when
          the Query is initiated from a private host to the external
          hosts.

          a) NAT mapping of ICMP Query Identifiers SHOULD be external-
             host independent.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.2.%20%20ICMP%20Query%20Session%20Timeouts"></a><a class="selflink" href="#section-3.2" name="section-3.2">3.2</a>.  ICMP Query Session Timeouts</span>

   NATs maintain a mapping timeout for the ICMP Queries that traverse
   them.  The mapping timeout is the time a mapping will stay active
   without packets traversing the NAT.  There is great variation in the
   values used by different NATs.  The ICMP Query session timeout
   requirement is necessary for current ICMP Query applications to work.
   Query response times can vary.  ICMP-Query-based applications are
   primarily request/response driven.

   Ideally, the timeout should be set to Maximum Round Trip Time
   (Maximum RTT).  For the purposes of constraining the maximum RTT, the
   Maximum Segment Lifetime (MSL), defined in [<a href="rfc793.html" title='"Transmission Control Protocol"'>RFC793</a>], could be
   considered a guideline to set packet lifetime.  Per [<a href="rfc793.html" title='"Transmission Control Protocol"'>RFC793</a>], MSL is
   the maximum amount of time a TCP segment can exist in a network
   before being delivered to the intended recipient.  This is the
   maximum duration an IP packet can be assumed to take to reach the
   intended destination node before declaring that the packet will no
   longer be delivered.  For an application initiating an ICMP Query
   message and waiting for a response for the Query, the Maximum RTT
   could in practice be constrained to be the sum total of MSL for the
   Query message and MSL for the response message.  In other words,
   Maximum RTT could be constrained to no more than 2x MSL.  The
   recommended value for MSL in [<a href="rfc793.html" title='"Transmission Control Protocol"'>RFC793</a>] is 120 seconds, even though
   several implementations set this to 60 seconds or 30 seconds.  When
   MSL is 120 seconds, the Maximum RTT (2x MSL) would be 240 seconds.

   In practice, ICMP Ping [<a href="rfc1470.html" title='"FYI on a Network Management Tool Catalog: Tools for Monitoring and Debugging TCP/IP Internets and Interconnected Devices"'>RFC1470</a>] and ICMP traceroute [<a href="#ref-MS-TRCRT" title='"How to use the Tracert command-line utility to troubleshoot TCP/IP problems in Windows"'>MS-TRCRT</a>], the
   two most commonly known legacy applications built on top of ICMP
   Query messages, take less than 10 seconds to complete a round trip
   when the target node is operational on the network.






<span class="grey">Srisuresh, et al.        Best Current Practice                  [Page 7]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-8" id="page-8" name="page-8"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   Setting the ICMP NAT session timeout to a very large duration (say,
   240 seconds) could potentially tie up precious NAT resources such as
   Query mappings and NAT Sessions for the whole duration.  On the other
   hand, setting the timeout very low can result in premature freeing of
   NAT resources and applications failing to complete gracefully.  The
   ICMP Query session timeout needs to be a balance between the two
   extremes.  A 60-second timeout is a balance between the two extremes.
   An ICMP Query session timer MUST NOT expire in less than 60 seconds.
   It is RECOMMENDED that the ICMP Query session timer be made
   configurable.

   REQ-2: An ICMP Query session timer MUST NOT expire in less than 60
          seconds.

          a) It is RECOMMENDED that the ICMP Query session timer be made
             configurable.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/4.%20%20ICMP%20Error%20Forwarding"></a><a class="selflink" href="#section-4" name="section-4">4</a>.  ICMP Error Forwarding</span>

   Many applications make use of ICMP Error messages from end hosts and
   intermediate devices to shorten application timeouts.  Some
   applications will not operate correctly without the receipt of ICMP
   Error messages.  The following sub-sections discuss the requirements
   a NAT device must conform to in order to ensure reliable forwarding.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.1.%20%20ICMP%20Error%20Payload%20Validation"></a><a class="selflink" href="#section-4.1" name="section-4.1">4.1</a>.  ICMP Error Payload Validation</span>

   An ICMP Error message checksum covers the entire ICMP message,
   including the payload.  When an ICMP Error packet is received, if the
   ICMP checksum fails to validate, the NAT SHOULD silently drop the
   ICMP Error packet.  This is because NAT uses the embedded IP and
   transport headers for forwarding and translating the ICMP Error
   message (described in <a href="#section-4.2">Section 4.2</a>).  When the ICMP checksum is
   invalid, the embedded IP and transport headers, which are covered by
   the ICMP checksum, are also suspect.

   [<a id="ref-RFC1812" name="ref-RFC1812">RFC1812</a>] and [<a href="rfc1122.html" title='"Requirements for Internet Hosts - Communication Layers"'>RFC1122</a>] require a router or an end host that receives
   an IP packet with an invalid IP header checksum to silently drop the
   IP packet.  As such, end hosts and routers do not generate an ICMP
   Error message in response to IP packets with invalid IP header
   checksums.  For this reason, if the IP checksum of the embedded
   packet within an ICMP Error message fails to validate, the NAT SHOULD
   silently drop the Error packet.

   When the IP packet embedded within the ICMP Error message includes IP
   options, the NAT device must not assume that the transport header of
   the embedded packet is at a fixed offset (as would be the case when
   there are no IP options associated with the packet) from the start of



<span class="grey">Srisuresh, et al.        Best Current Practice                  [Page 8]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-9" id="page-9" name="page-9"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   the embedded packet.  Specifically, if the embedded packet includes
   IP options, the NAT device MUST traverse past the IP options to
   locate the start of transport header for the embedded packet.

   It is possible to compute the transport checksum of the embedded
   packet within an ICMP Error message when the ICMP Error message
   contains the entire transport segment.  However, ICMP Error messages
   do not contain the entire transport segment in many cases.  This is
   because [<a href="#ref-ICMP" title='"Internet Control Message Protocol"'>ICMP</a>] stipulates that an ICMP Error message should embed an
   IP header and only a minimum of 64 bits of the IP payload.  Even
   though <a href="rfc1812.html#section-4.3.2.3">Section 4.3.2.3 of [RFC1812]</a> recommends an ICMP Error
   originator include as much of the original packet as possible in the
   payload, the length of the resulting ICMP datagram cannot exceed 576
   bytes.  ICMP Error originators truncate IP packets that do not fit
   within the stipulations.

   A NAT device SHOULD NOT validate the transport checksum of the
   embedded packet within an ICMP Error message, even when it is
   possible to do so.  This is because a NAT dropping an ICMP Error
   message due to an invalid transport checksum will make it harder for
   end hosts to receive error reporting for certain types of corruption.
   End-to-end validation of ICMP Error messages is best left to end
   hosts.  Many newer revision end host TCP/IP stacks implement the
   improvements in [<a href="#ref-TCP-SOFT" title="&quot;TCP's Reaction to Soft Errors&quot;">TCP-SOFT</a>] and do not accept ICMP Error messages with
   a mismatched IP or TCP checksum in the embedded packet, if the
   embedded datagram contains a full IP packet and the TCP checksum can
   be calculated.

   In the case that the ICMP Error payload includes ICMP extensions
   [<a href="#ref-ICMP-EXT" title='"Extended ICMP to Support Multi-Part Messages"'>ICMP-EXT</a>], the NAT device MUST exclude the optional zero-padding and
   the ICMP extensions when evaluating transport checksum for the
   embedded packet.  Readers are urged to refer to [<a href="#ref-ICMP-EXT" title='"Extended ICMP to Support Multi-Part Messages"'>ICMP-EXT</a>] for
   information on identifying the presence of ICMP extensions in an ICMP
   message.

   REQ-3: When an ICMP Error packet is received, if the ICMP checksum
          fails to validate, the NAT SHOULD silently drop the ICMP Error
          packet.  If the ICMP checksum is valid, do the following:

          a) If the IP checksum of the embedded packet fails to
             validate, the NAT SHOULD silently drop the Error packet;
             and

          b) If the embedded packet includes IP options, the NAT device
             MUST traverse past the IP options to locate the start of
             the transport header for the embedded packet; and





<span class="grey">Srisuresh, et al.        Best Current Practice                  [Page 9]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-10" id="page-10" name="page-10"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


          c) The NAT device SHOULD NOT validate the transport checksum
             of the embedded packet within an ICMP Error message, even
             when it is possible to do so; and

          d) If the ICMP Error payload contains ICMP extensions
             [<a href="#ref-ICMP-EXT" title='"Extended ICMP to Support Multi-Part Messages"'>ICMP-EXT</a>], the NAT device MUST exclude the optional zero-
             padding and the ICMP extensions when evaluating transport
             checksum for the embedded packet.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.2.%20%20ICMP%20Error%20Packet%20Translation"></a><a class="selflink" href="#section-4.2" name="section-4.2">4.2</a>.  ICMP Error Packet Translation</span>

   Section 4.3 of [<a href="#ref-NAT-TRAD" title='"Traditional IP Network Address Translator (Traditional NAT)"'>NAT-TRAD</a>] describes the fields of an ICMP Error
   message that a NAT device translates.  In this section, we describe
   the requirements a NAT device must conform to while performing the
   translations.  Requirements identified in this section are necessary
   for the current applications to work correctly.

   Consider the following scenario in Figure 1.  Say, NAT-xy is a NAT
   device connecting hosts in private and external networks.  Router-x
   and Host-x are in the external network.  Router-y and Host-y are in
   the private network.  The subnets in the external network are
   routable from the private as well as the external domains.  By
   contrast, the subnets in the private network are only routable within
   the private domain.  When Host-y initiated a session to Host-x, let
   us say that the NAT device mapped the endpoint on Host-y into Host-y'
   in the external network.  The following subsections describe the
   processing of ICMP Error messages on the NAT device(NAT-xy) when the
   NAT device receives an ICMP Error message in response to a packet
   pertaining to this session.






















<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 10]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-11" id="page-11" name="page-11"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


                               Host-x
                                  |
                          ---------------+-------------------
                                         |
                                  +-------------+
                                  |  Router-x   |
                                  +-------------+
            External Network             |
            --------------------+--------+-------------------
                                |   ^
                                |   | (Host-y', Host-x)
                                |   |
                          +-------------+
                          |    NAT-xy   |
                          +-------------+
                                |
    Private Network             |
   ----------------+------------+----------------
                   |
            +-------------+
            | Router-y    |
            +-------------+
                   |
   ----------------+-------+--------
                           | ^
                           | | (Host-y, Host-x)
                           | |
                         Host-y

     Figure 1.  A Session from a Private Host Traversing a NAT Device

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/4.2.1.%20%20ICMP%20Error%20Packet%20Received%20from%20the%20External%20Realm"></a><a class="selflink" href="#section-4.2.1" name="section-4.2.1">4.2.1</a>.  ICMP Error Packet Received from the External Realm</span>

   Say, a packet from Host-y to Host-x triggered an ICMP Error message
   from one of Router-x or Host-x (both of which are in the external
   domain).  Such an ICMP Error packet will have one of Router-x or
   Host-x as the source IP address and Host-y' as the destination IP
   address as described in Figure 2 below.













<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 11]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-12" id="page-12" name="page-12"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


                               Host-x
                                  |
                          ---------------+-------------------
                                         |
                                  +-------------+
                                  |  Router-x   |
                                  +-------------+
            External Network             |
            --------------------+--------+-------------------
                                |
                                |  | ICMP Error Packet to Host-y'
                                |  v
                          +-------------+
                          |    NAT-xy   |
                          +-------------+
    Private Network             |
   ----------------+------------+----------------
                   |
            +-------------+
            | Router-y    |
            +-------------+
                   |
   ----------------+-------+--------
                           |
                         Host-y

        Figure 2.  ICMP Error Packet Received from External Network

   When the NAT device receives the ICMP Error packet, the NAT device
   uses the packet embedded within the ICMP Error message (i.e., the IP
   packet from Host-y' to Host-x) to look up the NAT Session to which
   the embedded packet belongs.  If the NAT device does not have an
   active mapping for the embedded packet, the NAT SHOULD silently drop
   the ICMP Error packet.  Otherwise, the NAT device MUST use the
   matching NAT Session to translate the embedded packet; that is,
   translate the source IP address of the embedded packet (e.g., Host-y'
   -&gt; Host-y) and transport headers.

   The ICMP Error payload may contain ICMP extension objects [<a href="#ref-ICMP-EXT" title='"Extended ICMP to Support Multi-Part Messages"'>ICMP-EXT</a>].
   NATs are encouraged to support ICMP extension objects.  At the time
   of this writing, the authors are not aware of any standard ICMP
   extension objects containing realm-specific information.

   The NAT device MUST also use the matching NAT Session to translate
   the destination IP address in the outer IP header.  In the outer
   header, the source IP address will remain unchanged because the
   originator of the ICMP Error message (Host-x or Router-x) is in an
   external domain and is routable from the private domain.



<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 12]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-13" id="page-13" name="page-13"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   REQ-4: If a NAT device receives an ICMP Error packet from an external
          realm, and the NAT device does not have an active mapping for
          the embedded payload, the NAT SHOULD silently drop the ICMP
          Error packet.  If the NAT has active mapping for the embedded
          payload, then the NAT MUST do the following prior to
          forwarding the packet, unless explicitly overridden by local
          policy:

          a) Revert the IP and transport headers of the embedded IP
             packet to their original form, using the matching mapping;
             and

          b) Leave the ICMP Error type and code unchanged; and

          c) Modify the destination IP address of the outer IP header to
             be the same as the source IP address of the embedded packet
             after translation.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/4.2.2.%20%20ICMP%20Error%20Packet%20Received%20from%20the%20Private%20Realm"></a><a class="selflink" href="#section-4.2.2" name="section-4.2.2">4.2.2</a>.  ICMP Error Packet Received from the Private Realm</span>

   Now, say, a packet from Host-x to Host-y triggered an ICMP Error
   message from one of Router-y or Host-y (both of which are in the
   private domain).  Such an ICMP Error packet will have one of Router-y
   or Host-y as the source IP address and Host-x as the destination IP
   address as specified in Figure 3 below.


























<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 13]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-14" id="page-14" name="page-14"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


                               Host-x
                                  |
                          ---------------+-------------------
                                         |
                                  +-------------+
                                  |  Router-x   |
                                  +-------------+
            External Network             |
            --------------------+--------+-------------------
                                |
                                |
                          +-------------+
                          |    NAT-xy   |
                          +-------------+
                                |  ^
                                |  | ICMP Error Packet to Host-x
    Private Network             |
   ----------------+------------+----------------
                   |
            +-------------+
            | Router-y    |
            +-------------+
                   |
   ----------------+-------+--------
                           |
                         Host-y

        Figure 3.  ICMP Error Packet Received from Private Network

   When the NAT device receives the ICMP Error packet, the NAT device
   MUST use the packet embedded within the ICMP Error message (i.e., the
   IP packet from Host-x to Host-y) to look up the NAT Session to which
   the embedded packet belongs.  If the NAT device does not have an
   active mapping for the embedded packet, the NAT SHOULD silently drop
   the ICMP Error packet.  Otherwise, the NAT device MUST use the
   matching NAT Session to translate the embedded packet.

   The ICMP Error payload may contain ICMP extension objects [<a href="#ref-ICMP-EXT" title='"Extended ICMP to Support Multi-Part Messages"'>ICMP-EXT</a>].
   NATs are encouraged to support ICMP extension objects.  At the time
   of this writing, the authors are not aware of any standard ICMP
   extension objects containing realm-specific information.

   In the outer header, the destination IP address will remain
   unchanged, as the IP address for Host-x is already in the external
   domain.  If the ICMP Error message is generated by Host-y, the NAT
   device must simply use the NAT Session to translate the source IP
   address Host-y to Host-y'.  If the ICMP Error message is originated
   by the intermediate node Router-y, translation of the source IP



<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 14]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-15" id="page-15" name="page-15"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   address varies depending on whether the Basic NAT or NAPT function
   [<a href="#ref-NAT-TRAD" title='"Traditional IP Network Address Translator (Traditional NAT)"'>NAT-TRAD</a>] is enforced by the NAT device.  A NAT device enforcing the
   Basic NAT function has a pool of public IP addresses and enforces
   address mapping (which is different from the endpoint mapping
   enforced by NAPT) when a private node initiates an outgoing session
   via the NAT device.  So, if the NAT device has active mapping for the
   IP address of the intermediate node Router-y, the NAT device MUST
   translate the source IP address of the ICMP Error packet with the
   public IP address in the mapping.  In all other cases, the NAT device
   MUST simply use its own IP address in the external domain to
   translate the source IP address.

   REQ-5: If a NAT device receives an ICMP Error packet from the private
          realm, and the NAT does not have an active mapping for the
          embedded payload, the NAT SHOULD silently drop the ICMP Error
          packet.  If the NAT has active mapping for the embedded
          payload, then the NAT MUST do the following prior to
          forwarding the packet, unless explicitly overridden by local
          policy:

          a) Revert the IP and transport headers of the embedded IP
             packet to their original form, using the matching mapping;
             and

          b) Leave the ICMP Error type and code unchanged; and

          c) If the NAT enforces Basic NAT function ([<a href="#ref-NAT-TRAD" title='"Traditional IP Network Address Translator (Traditional NAT)"'>NAT-TRAD</a>]), and
             the NAT has active mapping for the IP address that sent the
             ICMP Error, translate the source IP address of the ICMP
             Error packet with the public IP address in the mapping.  In
             all other cases, translate the source IP address of the
             ICMP Error packet with its own public IP address.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/4.3.%20%20NAT%20Sessions%20Pertaining%20to%20ICMP%20Error%20Payload"></a><a class="selflink" href="#section-4.3" name="section-4.3">4.3</a>.  NAT Sessions Pertaining to ICMP Error Payload</span>

   While processing an ICMP Error packet pertaining to an ICMP Query or
   Query response message, a NAT device MUST NOT refresh or delete the
   NAT Session that pertains to the embedded payload within the ICMP
   Error packet.  This is in spite of the fact that the NAT device uses
   the NAT Session to translate the embedded payload.  This ensures that
   the NAT Session will not be modified if someone is able to spoof ICMP
   Error messages for the session.  [<a href="#ref-ICMP-ATK" title='"ICMP Attacks against TCP"'>ICMP-ATK</a>] lists a number of
   potential ICMP attacks that may be attempted by malicious users on
   the network.  This requirement is necessary for current applications
   to work correctly.






<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 15]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-16" id="page-16" name="page-16"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   REQ-6: While processing an ICMP Error packet pertaining to an ICMP
          Query or Query response message, a NAT device MUST NOT refresh
          or delete the NAT Session that pertains to the embedded
          payload within the ICMP Error packet.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/5.%20%20Hairpinning%20Support%20for%20ICMP%20Packets"></a><a class="selflink" href="#section-5" name="section-5">5</a>.  Hairpinning Support for ICMP Packets</span>

   [<a id="ref-BEH-UDP" name="ref-BEH-UDP">BEH-UDP</a>] and [<a href="#ref-BEH-TCP" title='"NAT Behavioral Requirements for TCP"'>BEH-TCP</a>] mandate support for hairpinning for UDP and
   TCP sessions, respectively, on NAT devices.  A NAT device needs to
   support hairpinning for ICMP Query sessions as well.  Specifically,
   NAT devices enforcing Basic NAT [<a href="#ref-NAT-TRAD" title='"Traditional IP Network Address Translator (Traditional NAT)"'>NAT-TRAD</a>] MUST support the traversal
   of hairpinned ICMP Query sessions.  Say, for example, individual
   private hosts register their NAT assigned external IP address with a
   rendezvous server.  Other hosts that wish to initiate ICMP Query
   sessions to the registered hosts might do so using the public address
   registered with the rendezvous server.  For this reason, Basic NAT
   devices are required to support the traversal of hairpinned ICMP
   Query sessions.  This requirement is necessary for current
   applications to work correctly.

   Packets belonging to any of the hairpinned sessions could, in turn,
   trigger ICMP Error messages directed to the source of hairpinned IP
   packets.  Such hairpinned ICMP Error messages will traverse the NAT
   devices en route.  All NAT devices (i.e., Basic NAT as well as NAPT
   devices) MUST support the traversal of hairpinned ICMP Error
   messages.  Specifically, the NAT device must translate not only the
   embedded hairpinned packet, but also the outer IP header that is
   hairpinned.  This requirement is necessary for current applications
   to work correctly.

   A hairpinned ICMP Error message is received from a node in a private
   network.  As such, the ICMP Error processing requirement specified in
   Req-5 is applicable in its entirety in processing the ICMP Error
   message.  In addition, the NAT device MUST translate the destination
   IP address of the outer IP header to be same as the source IP address
   of the embedded IP packet after the translation.

   REQ-7: NAT devices enforcing Basic NAT [<a href="#ref-NAT-TRAD" title='"Traditional IP Network Address Translator (Traditional NAT)"'>NAT-TRAD</a>] MUST support the
          traversal of hairpinned ICMP Query sessions.  All NAT devices
          (i.e., Basic NAT as well as NAPT devices) MUST support the
          traversal of hairpinned ICMP Error messages:

          a) When forwarding a hairpinned ICMP Error message, the NAT
             device MUST translate the destination IP address of the
             outer IP header to be same as the source IP address of the
             embedded IP packet after the translation.





<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 16]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-17" id="page-17" name="page-17"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/6.%20%20Rejection%20of%20Outbound%20Flows%20Disallowed%20by%20NAT"></a><a class="selflink" href="#section-6" name="section-6">6</a>.  Rejection of Outbound Flows Disallowed by NAT</span>

   A NAT device typically permits all outbound sessions.  However, a NAT
   device may disallow some outbound sessions due to resource
   constraints or administration considerations.  For example, a NAT
   device may not permit the first packet of a new outbound session if
   the NAT device is out of resources (out of addresses or TCP/UDP
   ports, or NAT Session resources) to set up a state for the session,
   or, if the specific session is administratively restricted by the NAT
   device.

   When a NAT device is unable to establish a NAT Session for a new
   transport-layer (TCP, UDP, ICMP, etc.) flow due to resource
   constraints or administrative restrictions, the NAT device SHOULD
   send an ICMP destination unreachable message, with a code of 13
   (Communication administratively prohibited) to the sender, and drop
   the original packet.  This requirement is meant primarily for future
   use.  Current applications do not require this for them to work
   correctly.  The justification for using ICMP code 13 in the ICMP
   Error message is as follows: <a href="rfc1812.html#section-5.2.7.1">Section 5.2.7.1 of [RFC1812]</a> recommends
   routers use ICMP code 13 (Communication administratively prohibited)
   when they administratively filter packets.  ICMP code 13 is a soft
   error and is on par with other soft error codes generated in response
   to transient events such as "network unreachable" (ICMP type=3,
   code=0).

   Some NAT designers opt to never reject an outbound flow.  When a NAT
   runs short of resources, they prefer to steal a resource from an
   existing NAT Session rather than reject the outbound flow.  Such a
   design choice may appear conformant to REQ-8 below.  However, the
   design choice is in violation of the spirit of both REQ-8 and REQ-2.
   Such a design choice is strongly discouraged.

   REQ-8: When a NAT device is unable to establish a NAT Session for a
   new transport-layer (TCP, UDP, ICMP, etc.) flow due to resource
   constraints or administrative restrictions, the NAT device SHOULD
   send an ICMP destination unreachable message, with a code of 13
   (Communication administratively prohibited) to the sender, and drop
   the original packet.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/7.%20%20Conformance%20to%20RFC%201812"></a><a class="selflink" href="#section-7" name="section-7">7</a>.  Conformance to <a href="rfc1812.html">RFC 1812</a></span>

   This document specifies NATs to have a behavior that is consistent
   with the way routers handle ICMP messages, as specified in <a href="rfc1812.html#section-4.3">Section</a>
   <a href="rfc1812.html#section-4.3">4.3 of [RFC1812]</a>.  However, since the publication of [<a href="rfc1812.html" title='"Requirements for IP Version 4 Routers"'>RFC1812</a>], some
   of its requirements are no longer best current practices.  Thus, the
   following requirements are derived from [<a href="rfc1812.html" title='"Requirements for IP Version 4 Routers"'>RFC1812</a>] and apply to NATs
   compliant with this specification:



<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 17]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-18" id="page-18" name="page-18"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   REQ-9: A NAT device MAY implement a policy control that prevents ICMP
          messages being generated toward certain interface(s).
          Implementation of such a policy control overrides the MUSTs
          and SHOULDs in REQ-10.

   REQ-10: Unless overridden by REQ-9's policy, a NAT device needs to
           support ICMP messages as below, some conforming to <a href="rfc1812.html#section-4.3">Section</a>
           <a href="rfc1812.html#section-4.3">4.3 of [RFC1812]</a> and some superseding the requirements of
           <a href="rfc1812.html#section-4.3">Section 4.3 of [RFC1812]</a>:

          a. MUST support:

             1. Destination Unreachable Message, as described in <a href="#section-7.1">Section</a>
                <a href="#section-7.1">7.1</a> of this document.

             2. Time Exceeded Message, as described in <a href="#section-7.2">Section 7.2</a> of
                this document.

             3. Echo Request/Reply Messages, as described in REQ-1.

          b. MAY support:

             1. Redirect Message, as described in <a href="rfc1812.html#section-4.3.3.2">Section 4.3.3.2 of
                [RFC1812]</a>.

             2. Timestamp and Timestamp Reply Messages, as described in
                <a href="rfc1812.html#section-4.3.3.8">Section 4.3.3.8 of [RFC1812]</a>.

             3. Source Route Options, as described in <a href="#section-7.3">Section 7.3</a> of
                this document.

             4. Address Mask Request/Reply Message, as described in
                <a href="#section-7.4">Section 7.4</a> of this document.

             5. Parameter Problem Message, as described in <a href="#section-7.5">Section 7.5</a>
                of this document.

             6. Router Advertisement and Solicitations, as described in
                <a href="#section-7.6">Section 7.6</a> of this document.

          c. SHOULD NOT support:

             1. Source Quench Message, as described in <a href="rfc1812.html#section-4.3.3.3">Section 4.3.3.3
                of [RFC1812]</a>.

             2. Information Request/reply, as described in <a href="rfc1812.html#section-4.3.3.7">Section</a>
                <a href="rfc1812.html#section-4.3.3.7">4.3.3.7 of [RFC1812]</a>.




<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 18]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-19" id="page-19" name="page-19"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


          In addition, a NAT device is RECOMMENDED to conform to the
          following implementation considerations:

          d. DS Field Usage, as described in <a href="#section-7.7">Section 7.7</a> of this
             document.

          e. When Not to Send ICMP Errors, as described in <a href="rfc1812.html#section-4.3.2.7">Section</a>
             <a href="rfc1812.html#section-4.3.2.7">4.3.2.7 of [RFC1812]</a>.

          f. Rate Limiting, as described in <a href="rfc1812.html#section-4.3.2.8">Section 4.3.2.8 of
             [RFC1812]</a>.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.1.%20%20IP%20Packet%20Fragmentation"></a><a class="selflink" href="#section-7.1" name="section-7.1">7.1</a>.  IP Packet Fragmentation</span>

   Many networking applications (which include TCP- as well as UDP-based
   applications) depend on ICMP Error messages from the network to
   perform end-to-end path MTU discovery [<a href="#ref-PMTU" title='"Path MTU discovery"'>PMTU</a>].  Once the path MTU is
   discovered, an application that chooses to avoid fragmentation may do
   so by originating IP packets that fit within the path MTU en route
   and setting the DF (Don't Fragment) bit in the IP header, so the
   intermediate nodes en route do not fragment the IP packets.  The
   following sub-sections discuss the need for NAT devices to honor the
   DF bit in the IP header and be able to generate "Packet Too Big" ICMP
   Error message when they cannot forward the IP packet without
   fragmentation.  Also discussed is the need to seamlessly forward ICMP
   Error messages generated by other intermediate devices.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/7.1.1.%20%20Generating%20%22Packet%20Too%20Big%22%20ICMP%20Error%20Message"></a><a class="selflink" href="#section-7.1.1" name="section-7.1.1">7.1.1</a>.  Generating "Packet Too Big" ICMP Error Message</span>

   When a router is unable to forward a datagram because it exceeds the
   MTU of the next-hop network and its Don't Fragment (DF) bit is set,
   the router is required by [<a href="rfc1812.html" title='"Requirements for IP Version 4 Routers"'>RFC1812</a>] to return an ICMP Destination
   Unreachable message to the source of the datagram, with the code
   indicating "fragmentation needed and DF set".  Further, [<a href="#ref-PMTU" title='"Path MTU discovery"'>PMTU</a>] states
   that the router MUST include the MTU of that next-hop network in the
   low-order 16 bits of the ICMP header field that is labeled "unused"
   in the ICMP specification [<a href="#ref-ICMP" title='"Internet Control Message Protocol"'>ICMP</a>].

   A NAT device MUST honor the DF bit in the IP header of the packets
   that transit the device.  The NAT device may not be able to forward
   an IP packet without fragmentation if the MTU on the forwarding
   interface of the NAT device is not adequate for the IP packet.  If
   the DF bit is set on a transit IP packet and the NAT device cannot
   forward the packet without fragmentation, the NAT device MUST send a
   "Packet Too Big" ICMP message (ICMP type 3, code 4) with the next-hop
   MTU back to the sender and drop the original IP packet.  The sender
   will usually resend after taking the appropriate corrective action.




<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 19]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-20" id="page-20" name="page-20"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   If the DF bit is not set and the MTU on the forwarding interface of
   the NAT device mandates fragmentation, the NAT device MUST fragment
   the packet and forward the fragments [<a href="rfc1812.html" title='"Requirements for IP Version 4 Routers"'>RFC1812</a>].

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/7.1.2.%20%20Forwarding%20%22Packet%20Too%20Big%22%20ICMP%20Error%20Message"></a><a class="selflink" href="#section-7.1.2" name="section-7.1.2">7.1.2</a>.  Forwarding "Packet Too Big" ICMP Error Message</span>

   This is the flip side of the argument for the above section.  By
   virtue of the address translation NAT performs, NAT may end up being
   the recipient of "Packet Too Big" messages.

   When the NAT device is the recipient of a "Packet Too Big" ICMP
   message from the network, the NAT device MUST forward the ICMP
   message back to the intended recipient, pursuant to the previously
   stated requirements (REQ-3, REQ-4, and REQ-5).

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.2.%20%20Time%20Exceeded%20Message"></a><a class="selflink" href="#section-7.2" name="section-7.2">7.2</a>.  Time Exceeded Message</span>

   A NAT device MUST generate a "Time Exceeded" ICMP Error message when
   it discards a packet due to an expired Time to Live (TTL) field.  A
   NAT device MAY have a per-interface option to disable origination of
   these messages on that interface, but that option MUST default to
   allowing the messages to be originated.

   When a NAT device conforms to the above requirement, it ensures that
   legacy applications such as Traceroute [<a href="rfc1470.html" title='"FYI on a Network Management Tool Catalog: Tools for Monitoring and Debugging TCP/IP Internets and Interconnected Devices"'>RFC1470</a>], [<a href="#ref-MS-TRCRT" title='"How to use the Tracert command-line utility to troubleshoot TCP/IP problems in Windows"'>MS-TRCRT</a>], which
   depend upon the "Time Exceeded" ICMP Error message, will continue to
   operate even as NAT devices are en route.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.3.%20%20Source%20Route%20Options"></a><a class="selflink" href="#section-7.3" name="section-7.3">7.3</a>.  Source Route Options</span>

   A NAT device MAY support modifying IP addresses in the source route
   option so the IP addresses in the source route option are realm
   relevant.  If a NAT device does not support forwarding packets with
   the source route option, the NAT device SHOULD NOT forward outbound
   ICMP messages that contain the source route option in the outer or
   inner IP header.  This is because such messages could reveal private
   IP addresses to the external realm.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.4.%20%20Address%20Mask%20Request%2FReply%20Messages"></a><a class="selflink" href="#section-7.4" name="section-7.4">7.4</a>.  Address Mask Request/Reply Messages</span>

   <a href="rfc1812.html#section-4.3.3.9">Section 4.3.3.9 of [RFC1812]</a> says an IP router MUST implement support
   for receiving ICMP Address Mask Request messages and responding with
   ICMP Address Mask Reply messages.  However, several years (more than
   13 years at the time of this document) have elapsed since the text in
   <a href="rfc1812.html">RFC 1812</a> was written.  In the intervening time, DHCP [<a href="#ref-DHCP" title='"Dynamic Host Configuration Protocol"'>DHCP</a>] has
   replaced the use of address mask request/reply.  At the current time,





<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 20]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-21" id="page-21" name="page-21"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   there is rarely any host that does not meet host requirements
   [<a href="rfc1122.html" title='"Requirements for Internet Hosts - Communication Layers"'>RFC1122</a>] and needs a NAT device to support address mask
   request/reply.

   For this reason, a NAT device is not required to support this ICMP
   message.

   A NAT device MAY support address mask request/reply messages.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.5.%20%20Parameter%20Problem%20Message"></a><a class="selflink" href="#section-7.5" name="section-7.5">7.5</a>.  Parameter Problem Message</span>

   <a href="rfc1812.html#section-4.3.3.5">Section 4.3.3.5 of [RFC1812]</a> says an IP router MUST generate a
   Parameter Problem message for any error not specifically covered by
   another ICMP message.  However, this message is rarely used in
   practice in networks where IPv4 NATs are deployed.

   For this reason, a NAT device is not required to support this ICMP
   message.

   A NAT device MAY support parameter problem messages.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.6.%20%20Router%20Advertisement%20and%20Solicitations"></a><a class="selflink" href="#section-7.6" name="section-7.6">7.6</a>.  Router Advertisement and Solicitations</span>

   <a href="rfc1812.html#section-4.3.3.10">Section 4.3.3.10 of [RFC1812]</a> says an IP router MUST support the
   router part of the ICMP Router Discovery Protocol on all connected
   networks on which the router supports either IP multicast or IP
   broadcast addressing.  However, this message is rarely used in
   practice in networks where IPv4 NATs are deployed.

   For this reason, a NAT device is not required to support this ICMP
   message.

   A NAT device MAY support Router Advertisement and Solicitations.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.7.%20%20DS%20Field%20Usage"></a><a class="selflink" href="#section-7.7" name="section-7.7">7.7</a>.  DS Field Usage</span>

   [<a id="ref-RFC1812" name="ref-RFC1812">RFC1812</a>] refers to the Type of Service (TOS) octet in the IP header,
   which contains the TOS and IP precedence fields.  However, the TOS
   and IP precedence fields are no longer in use today.  [<a href="rfc2474.html" title='"Definition of the Differentiated Services Field (DS Field) in the IPv4 and IPv6 Headers"'>RFC2474</a>]
   renamed the TOS octet as the DS field and defined diffserv classes
   within the DS field.

   When generating an ICMP message, a NAT device SHOULD copy the
   diffserv class of the message that causes the sending of the ICMP
   error message.  A NAT device MAY allow configuration of the diffserv
   class to be used for the different types of ICMP messages.





<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 21]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-22" id="page-22" name="page-22"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/8.%20%20Non-QueryError%20ICMP%20Messages"></a><a class="selflink" href="#section-8" name="section-8">8</a>.  Non-QueryError ICMP Messages</span>

   In the preceding sections, ICMP requirements were identified for NAT
   devices, with a primary focus on ICMP Query and ICMP Error messages,
   as defined in the Terminology Section (see <a href="#section-2">Section 2</a>).  This document
   provides no guidance on the handling of Non-QueryError ICMP messages
   by the NAT devices.  A NAT MAY drop or appropriately handle Non-
   QueryError ICMP messages.

       REQ-11: A NAT MAY drop or appropriately handle Non-QueryError
           ICMP messages.  The semantics of Non-QueryError ICMP messages
           is defined in <a href="#section-2">Section 2</a>.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/9.%20%20Summary%20of%20Requirements"></a><a class="selflink" href="#section-9" name="section-9">9</a>.  Summary of Requirements</span>

   Below is a summary of all the requirements.

   REQ-1: Unless explicitly overridden by local policy, a NAT device
          MUST permit ICMP Queries and their associated responses, when
          the Query is initiated from a private host to the external
          hosts.

          a) NAT mapping of ICMP Query Identifiers SHOULD be external
             host independent.

   REQ-2: An ICMP Query session timer MUST NOT expire in less than 60
          seconds.

          a) It is RECOMMENDED that the ICMP Query session timer be made
             configurable.

   REQ-3: When an ICMP Error packet is received, if the ICMP checksum
          fails to validate, the NAT SHOULD silently drop the ICMP Error
          packet.  If the ICMP checksum is valid, do the following:

          a) If the IP checksum of the embedded packet fails to
             validate, the NAT SHOULD silently drop the Error packet;
             and

          b) If the embedded packet includes IP options, the NAT device
             MUST traverse past the IP options to locate the start of
             the transport header for the embedded packet; and

          c) The NAT device SHOULD NOT validate the transport checksum
             of the embedded packet within an ICMP Error message, even
             when it is possible to do so; and





<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 22]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-23" id="page-23" name="page-23"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


          d) If the ICMP Error payload contains ICMP extensions
             [<a href="#ref-ICMP-EXT" title='"Extended ICMP to Support Multi-Part Messages"'>ICMP-EXT</a>], the NAT device MUST exclude the optional zero-
             padding and the ICMP extensions when evaluating transport
             checksum for the embedded packet.

   REQ-4: If a NAT device receives an ICMP Error packet from an external
          realm, and the NAT device does not have an active mapping for
          the embedded payload, the NAT SHOULD silently drop the ICMP
          Error packet.  If the NAT has active mapping for the embedded
          payload, then the NAT MUST do the following prior to
          forwarding the packet, unless explicitly overridden by local
          policy:

          a) Revert the IP and transport headers of the embedded IP
             packet to their original form, using the matching mapping;
             and

          b) Leave the ICMP Error type and code unchanged; and

          c) Modify the destination IP address of the outer IP header to
             be same as the source IP address of the embedded packet
             after translation.

   REQ-5: If a NAT device receives an ICMP Error packet from the private
          realm, and the NAT does not have an active mapping for the
          embedded payload, the NAT SHOULD silently drop the ICMP Error
          packet.  If the NAT has active mapping for the embedded
          payload, then the NAT MUST do the following prior to
          forwarding the packet, unless explicitly overridden by local
          policy.

          a) Revert the IP and transport headers of the embedded IP
             packet to their original form, using the matching mapping;
             and

          b) Leave the ICMP Error type and code unchanged; and

          c) If the NAT enforces Basic NAT function [<a href="#ref-NAT-TRAD" title='"Traditional IP Network Address Translator (Traditional NAT)"'>NAT-TRAD</a>], and the
             NAT has active mapping for the IP address that sent the
             ICMP Error, translate the source IP address of the ICMP
             Error packet with the public IP address in the mapping.  In
             all other cases, translate the source IP address of the
             ICMP Error packet with its own public IP address.

   REQ-6: While processing an ICMP Error packet pertaining to an ICMP
          Query or Query response message, a NAT device MUST NOT refresh
          or delete the NAT Session that pertains to the embedded
          payload within the ICMP Error packet.



<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 23]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-24" id="page-24" name="page-24"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   REQ-7: NAT devices enforcing Basic NAT ([<a href="#ref-NAT-TRAD" title='"Traditional IP Network Address Translator (Traditional NAT)"'>NAT-TRAD</a>]) MUST support the
          traversal of hairpinned ICMP Query sessions.  All NAT devices
          (i.e., Basic NAT as well as NAPT devices) MUST support the
          traversal of hairpinned ICMP Error messages.

          a) When forwarding a hairpinned ICMP Error message, the NAT
             device MUST translate the destination IP address of the
             outer IP header to be same as the source IP address of the
             embedded IP packet after the translation.

   REQ-8: When a NAT device is unable to establish a NAT Session for a
          new transport-layer (TCP, UDP, ICMP, etc.) flow due to
          resource constraints or administrative restrictions, the NAT
          device SHOULD send an ICMP destination unreachable message,
          with a code of 13 (Communication administratively prohibited)
          to the sender, and drop the original packet.

   REQ-9: A NAT device MAY implement a policy control that prevents ICMP
          messages being generated toward certain interface(s).
          Implementation of such a policy control overrides the MUSTs
          and SHOULDs in REQ-10.

   REQ-10: Unless overridden by REQ-9's policy, a NAT device needs to
           support ICMP messages as below, some conforming to <a href="rfc1812.html#section-4.3">Section</a>
           <a href="rfc1812.html#section-4.3">4.3 of [RFC1812]</a> and some superseding the requirements of
           <a href="rfc1812.html#section-4.3">Section 4.3 of [RFC1812]</a>:

          a. MUST support:

             1. Destination Unreachable Message, as described in <a href="#section-7.1">Section</a>
                <a href="#section-7.1">7.1</a> of this document.

             2. Time Exceeded Message, as described in <a href="#section-7.2">Section 7.2</a> of
                this document.

             3. Echo Request/Reply Messages, as described in REQ-1.

          b. MAY support:

             1. Redirect Message, as described in <a href="rfc1812.html#section-4.3.3.2">Section 4.3.3.2 of
                [RFC1812]</a>.

             2. Timestamp and Timestamp Reply Messages, as described in
                <a href="rfc1812.html#section-4.3.3.8">Section 4.3.3.8 of [RFC1812]</a>.

             3. Source Route Options, as described in <a href="#section-7.3">Section 7.3</a> of
                this document.




<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 24]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-25" id="page-25" name="page-25"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


             4. Address Mask Request/Reply Message, as described in
                <a href="#section-7.4">Section 7.4</a> of this document.

             5. Parameter Problem Message, as described in <a href="#section-7.5">Section 7.5</a>
                of this document.

             6. Router Advertisement and Solicitations, as described in
                <a href="#section-7.6">Section 7.6</a> of this document.

          c. SHOULD NOT support:

             1. Source Quench Message, as described in <a href="rfc1812.html#section-4.3.3.3">Section 4.3.3.3
                of [RFC1812]</a>.

             2. Information Request/reply, as described in <a href="rfc1812.html#section-4.3.3.7">Section</a>
                <a href="rfc1812.html#section-4.3.3.7">4.3.3.7 of [RFC1812]</a>.

          In addition, a NAT device is RECOMMENDED to conform to the
          following implementation considerations:

          d. DS Field Usage, as described in <a href="#section-7.7">Section 7.7</a> of this
             document.

          e. When Not to Send ICMP Errors, as described in <a href="rfc1812.html#section-4.3.2.7">Section</a>
             <a href="rfc1812.html#section-4.3.2.7">4.3.2.7 of [RFC1812]</a>.

          f. Rate Limiting, as described in <a href="rfc1812.html#section-4.3.2.8">Section 4.3.2.8 of
             [RFC1812]</a>.

   REQ-11: A NAT MAY drop or appropriately handle Non-QueryError ICMP
           messages.  The semantics of Non-QueryError ICMP messages is
           defined in <a href="#section-2">Section 2</a>.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/10.%20%20Security%20Considerations"></a><a class="selflink" href="#section-10" name="section-10">10</a>.  Security Considerations</span>

   This document does not introduce any new security concerns related to
   ICMP message handling in the NAT devices.  However, the requirements
   in the document do mitigate some security concerns known to exist
   with ICMP messages.

   [<a id="ref-ICMP-ATK" name="ref-ICMP-ATK">ICMP-ATK</a>] lists a number of ICMP attacks that can be directed
   against end host TCP stacks.  For example, a rogue entity could
   bombard the NAT device with a large number of ICMP Errors.  If the
   NAT device did not validate the legitimacy of the ICMP Error packets,
   the ICMP Errors would be forwarded directly to the end nodes.  End
   hosts not capable of defending themselves against such bogus ICMP
   Error attacks could be adversely impacted by such attacks.  Req-3
   recommends validating the ICMP checksum and the IP checksum of the



<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 25]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-26" id="page-26" name="page-26"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   embedded payload prior to forwarding.  These checksum validations by
   themselves do not protect end hosts from attacks.  However, checksum
   validation mitigates end hosts from malformed ICMP Error attacks.
   Req-4 and Req-5 further mandate that when a NAT device does not find
   a mapping selection for the embedded payload, the NAT should drop the
   ICMP Error packets, without forwarding.

   A rogue source could also try to send bogus ICMP Error messages for
   the active NAT sessions, with intent to destroy the sessions.  Req-6
   averts such an attack by ensuring that an ICMP Error message does not
   affect the state of a session on the NAT device.

   Req-8 recommends a NAT device sending an ICMP Error message when the
   NAT device is unable to create a NAT session due to lack of
   resources.  Some administrators may choose not to have the NAT device
   send an ICMP Error message, as doing so could confirm to a malicious
   attacker that the attack has succeeded.  For this reason, sending of
   the specific ICMP Error message stated in REQ-8 is left to the
   discretion of the NAT device administrator.

   Unfortunately, ICMP messages are sometimes blocked at network
   boundaries due to local security policy.  Thus, some of the
   requirements in this document allow local policy to override the
   recommendations of this document.  Blocking such ICMP messages is
   known to break some protocol features (most notably path MTU
   Discovery) and some applications (e.g., ping, traceroute), and such
   blocking is NOT RECOMMENDED.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/11.%20%20Acknowledgements"></a><a class="selflink" href="#section-11" name="section-11">11</a>.  Acknowledgements</span>

   The authors wish to thank Fernando Gont, Dan Wing, Carlos Pignataro,
   Philip Matthews, and members of the BEHAVE working group for doing a
   thorough review of early versions of the document and providing
   valuable input and offering generous amounts of their time in shaping
   the ICMP requirements.  Their valuable feedback made this document a
   better read.  Dan Wing and Fernando Gont were a steady source of
   encouragement.  Fernando Gont spent many hours preparing slides and
   presenting the document in an IETF meeting on behalf of the authors.
   The authors wish to thank Carlos Pignataro and Dan Tappan, authors of
   the [<a href="#ref-ICMP-EXT" title='"Extended ICMP to Support Multi-Part Messages"'>ICMP-EXT</a>] document, for their feedback concerning ICMP
   extensions.  The authors wish to thank Philip Matthews for agreeing
   to be a technical reviewer for the document.  Lastly, the authors
   highly appreciate the rigorous feedback from the IESG members.








<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 26]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-27" id="page-27" name="page-27"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/12.%20%20References"></a><a class="selflink" href="#section-12" name="section-12">12</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/12.1.%20%20Normative%20References"></a><a class="selflink" href="#section-12.1" name="section-12.1">12.1</a>.  Normative References</span>

   [<a id="ref-BEH-UDP" name="ref-BEH-UDP">BEH-UDP</a>]  Audet, F., Ed., and C. Jennings, "Network Address
              Translation (NAT) Behavioral Requirements for Unicast
              UDP", <a href="https://tools.ietf.org/html/bcp127">BCP 127</a>, <a href="rfc4787.html">RFC 4787</a>, January 2007.

   [<a id="ref-ICMP" name="ref-ICMP">ICMP</a>]     Postel, J., "Internet Control Message Protocol", STD 5,
              <a href="rfc792.html">RFC 792</a>, September 1981.

   [<a id="ref-ICMP-EXT" name="ref-ICMP-EXT">ICMP-EXT</a>] Bonica, R., Gan, D., Tappan, D., and C. Pignataro,
              "Extended ICMP to Support Multi-Part Messages", <a href="rfc4884.html">RFC 4884</a>,
              April 2007.

   [<a id="ref-NAT-TRAD" name="ref-NAT-TRAD">NAT-TRAD</a>] Srisuresh, P. and K. Egevang, "Traditional IP Network
              Address Translator (Traditional NAT)", <a href="rfc3022.html">RFC 3022</a>, January
              2001.

   [<a id="ref-RFC793" name="ref-RFC793">RFC793</a>]   Postel, J., "Transmission Control Protocol", STD 7, <a href="rfc793.html">RFC</a>
              <a href="rfc793.html">793</a>, September 1981.

   [<a id="ref-RFC1812" name="ref-RFC1812">RFC1812</a>]  Baker, F., Ed., "Requirements for IP Version 4 Routers",
              <a href="rfc1812.html">RFC 1812</a>, June 1995.

   [<a id="ref-RFC2119" name="ref-RFC2119">RFC2119</a>]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", <a href="https://tools.ietf.org/html/bcp14">BCP 14</a>, <a href="rfc2119.html">RFC 2119</a>, March 1997.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/12.2.%20%20Informative%20References"></a><a class="selflink" href="#section-12.2" name="section-12.2">12.2</a>.  Informative References</span>

   [<a id="ref-BEH-APP" name="ref-BEH-APP">BEH-APP</a>]  Ford, B., Srisuresh, P., and D. Kegel, "Application Design
              Guidelines for Traversal through Network Address
              Translators", Work in Progress, March 2007.

   [<a id="ref-BEH-TCP" name="ref-BEH-TCP">BEH-TCP</a>]  Guha, S., Ed., Biswas, K., Ford, B., Sivakumar, S., and P.
              Srisuresh, "NAT Behavioral Requirements for TCP", <a href="https://tools.ietf.org/html/bcp142">BCP 142</a>,
              <a href="rfc5382.html">RFC 5382</a>, October 2008.

   [<a id="ref-DHCP" name="ref-DHCP">DHCP</a>]     Droms, R., "Dynamic Host Configuration Protocol", <a href="rfc2131.html">RFC</a>
              <a href="rfc2131.html">2131</a>, March 1997.

   [<a id="ref-ICE" name="ref-ICE">ICE</a>]      Rosenberg, J., "Interactive Connectivity Establishment
              (ICE): A Protocol for Network Address Translator (NAT)
              Traversal for Offer/Answer Protocols", Work in Progress,
              October 2007.

   [<a id="ref-ICMP-ATK" name="ref-ICMP-ATK">ICMP-ATK</a>] Gont, F., <a href="https://www.google.com/search?sitesearch=tools.ietf.org%2Fhtml%2F&amp;q=inurl:draft-+%22ICMP+Attacks+against+TCP%22" style="text-decoration: none">"ICMP Attacks against TCP"</a>, Work in Progress,
              October 2008.



<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 27]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-28" id="page-28" name="page-28"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


   [<a id="ref-MS-TRCRT" name="ref-MS-TRCRT">MS-TRCRT</a>] Microsoft Support, "How to use the Tracert command-line
              utility to troubleshoot TCP/IP problems in Windows",
              <a href="http://support.microsoft.com/kb/162326">http://support.microsoft.com/kb/162326</a>, October, 2006.

   [<a id="ref-NAT-MIB" name="ref-NAT-MIB">NAT-MIB</a>]  Rohit, R., Srisuresh, P., Raghunarayan, R., Pai, N., and
              C. Wang, "Definitions of Managed Objects for Network
              Address Translators (NAT)", <a href="rfc4008.html">RFC 4008</a>, March 2005.

   [<a id="ref-NAT-TERM" name="ref-NAT-TERM">NAT-TERM</a>] Srisuresh, P. and M. Holdrege, "IP Network Address
              Translator (NAT) Terminology and Considerations", <a href="rfc2663.html">RFC</a>
              <a href="rfc2663.html">2663</a>, August 1999.

   [<a id="ref-PMTU" name="ref-PMTU">PMTU</a>]     Mogul, J. and S. Deering, "Path MTU discovery", <a href="rfc1191.html">RFC 1191</a>,
              November 1990.

   [<a id="ref-RFC1122" name="ref-RFC1122">RFC1122</a>]  Braden, R., Ed., "Requirements for Internet Hosts -
              Communication Layers", STD 3, <a href="rfc1122.html">RFC 1122</a>, October 1989.

   [<a id="ref-RFC1256" name="ref-RFC1256">RFC1256</a>]  Deering, S., Ed., "ICMP Router Discovery Messages", <a href="rfc1256.html">RFC</a>
              <a href="rfc1256.html">1256</a>, September 1991.

   [<a id="ref-RFC1470" name="ref-RFC1470">RFC1470</a>]  Enger, R. and J. Reynolds, "FYI on a Network Management
              Tool Catalog: Tools for Monitoring and Debugging TCP/IP
              Internets and Interconnected Devices", FYI 2, <a href="rfc1470.html">RFC 1470</a>,
              June 1993.

   [<a id="ref-RFC2474" name="ref-RFC2474">RFC2474</a>]  Nichols, K., Blake, S., Baker, F., and D. Black,
              "Definition of the Differentiated Services Field (DS
              Field) in the IPv4 and IPv6 Headers", <a href="rfc2474.html">RFC 2474</a>, December
              1998.

   [<a id="ref-RFC4065" name="ref-RFC4065">RFC4065</a>]  Kempf, J., "Instructions for Seamoby and Experimental
              Mobility Protocol IANA Allocations", <a href="rfc4065.html">RFC 4065</a>, July 2005.

   [<a id="ref-TCP-SOFT" name="ref-TCP-SOFT">TCP-SOFT</a>] Gont, F., "TCP's Reaction to Soft Errors", <a href="rfc5461.html">RFC 5461</a>,
              February 2009.

   [<a id="ref-UNSAF" name="ref-UNSAF">UNSAF</a>]    Daigle, L., Ed., and IAB, "IAB Considerations for
              UNilateral Self-Address Fixing (UNSAF) Across Network
              Address Translation", <a href="rfc3424.html">RFC 3424</a>, November 2002.











<span class="grey">Srisuresh, et al.        Best Current Practice                 [Page 28]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-29" id="page-29" name="page-29"> </a>
<span class="grey"><a href="rfc5508.html">RFC 5508</a>          NAT Behavioral Requirements for ICMP        April 2009</span>


Authors' Addresses

   Pyda Srisuresh
   Kazeon Systems, Inc.
   1161 San Antonio Rd.
   Mountain View, CA 94043
   U.S.A.

   Phone: +1 408 836 4773
   EMail: srisuresh@yahoo.com


   Bryan Ford
   Max Planck Institute for Software Systems
   Campus Building E1 4
   D-66123 Saarbruecken
   Germany

   Phone: +49-681-9325657
   EMail: baford@mpi-sws.org


   Senthil Sivakumar
   Cisco Systems, Inc.
   7100-8 Kit Creek Road
   PO Box 14987
   Research Triangle Park, NC  27709-4987
   U.S.A.

   Phone: +1 919 392 5158
   EMail: ssenthil@cisco.com


   Saikat Guha
   Cornell University
   331 Upson Hall
   Ithaca, NY  14853
   U.S.A.

   Phone: +1 607 255 1008
   EMail: saikat@cs.cornell.edu










Srisuresh, et al.        Best Current Practice                 [Page 29]

</pre><br/>
    <span class="noprint"><small><small>Html markup produced by rfcmarkup 1.126, available from
      <a href="https://tools.ietf.org/tools/rfcmarkup/">https://tools.ietf.org/tools/rfcmarkup/</a>
    </small></small></span>
  </div>




</body><!-- Mirrored from tools.ietf.org/html/rfc5508 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Mar 2018 23:18:34 GMT --></html>