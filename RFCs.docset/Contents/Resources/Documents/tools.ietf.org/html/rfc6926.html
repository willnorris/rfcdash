<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><!-- Mirrored from tools.ietf.org/html/rfc6926 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 23 Aug 2016 18:36:58 GMT --><!-- Added by HTTrack --><head><meta content="text/html;charset=utf-8" http-equiv="content-type"/><!-- /Added by HTTrack -->

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <meta content="index,follow" name="robots"/>
    <meta content="rfcmarkup version 1.119" name="creator"/>
    <link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/>
<meta content="draft-kinnear-dhc-dhcpv4-bulk-leasequery" name="DC.Relation.Replaces"/>
<meta content="urn:ietf:rfc:6926" name="DC.Identifier"/>
<meta content="April, 2013" name="DC.Date.Issued"/>
<meta content="Joshi, Bharat" name="DC.Creator"/>
<meta content="Kinnear, Kim" name="DC.Creator"/>
<meta content="Russell, Neil" name="DC.Creator"/>
<meta content="Stapp, Mark" name="DC.Creator"/>
<meta content="The Dynamic Host Configuration Protocol for IPv4 (DHCPv4) Leasequery
protocol allows a requestor to request information about DHCPv4
bindings. This protocol is limited to queries for individual bindings.
In some situations, individual binding queries may not be efficient or
even possible. This document extends the DHCPv4 Leasequery protocol to
allow for bulk transfer of DHCPv4 address binding data via TCP." name="DC.Description.Abstract"/>
<meta content="DHCPv4 Bulk Leasequery" name="DC.Title"/>

    <link href="https://tools.ietf.org/images/rfc.png" rel="icon" type="image/png"/>
    <link href="https://tools.ietf.org/images/rfc.png" rel="shortcut icon" type="image/png"/>
    <title>RFC 6926 - DHCPv4 Bulk Leasequery</title>
    
    
    <style type="text/css">
	@media only screen 
	  and (min-width: 992px)
	  and (max-width: 1199px) {
	    body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 768px)
	  and (max-width: 991px) {
            body { font-size: 14pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-width: 480px)
	  and (max-width: 767px) {
            body { font-size: 11pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (max-width: 479px) {
            body { font-size: 8pt; }
            div.content { width: 96ex; margin: 0 auto; }
        }
	@media only screen 
	  and (min-device-width : 375px) 
	  and (max-device-width : 667px) {
            body { font-size: 9.5pt; }
            div.content { width: 96ex; margin: 0 1px; }
        }
	@media only screen 
	  and (min-device-width: 1200px) {
            body { font-size: 10pt; margin: 0 4em; }
            div.content { width: 96ex; margin: 0; }
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        a.selflink {
          color: black;
          text-decoration: none;
        }
        @media print {
            body {
                font-family: monospace;
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 1em;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>                   <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>                     <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>             <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>              <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td>      <td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td>         <td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard (old designation):</td> <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Internet Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>                  <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>                  <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
  <div class="content">
   <div style="height: 13px;">
      <div class="pre noprint docinfo bgblue" onclick="showElem('legend');" onmouseout="hideElem('legend')" onmouseover="this.style.cursor='pointer';" style="height: 6px; position: absolute;" title="Click for colour legend.">                                                                        </div>
      <div class="docinfo noprint pre legend" id="legend" onmouseout="hideElem('legend');" onmouseover="showElem('legend');" style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; ">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="index.html" title="Document search and retrieval page">Docs</a>] [<a href="https://tools.ietf.org/rfc/rfc6926.txt" title="Plaintext version of this document">txt</a>|<a href="https://tools.ietf.org/pdf/rfc6926" title="PDF version of this document">pdf</a>] [<a href="https://tools.ietf.org/html/draft-ietf-dhc-dhcpv4-bulk-leasequery" title="draft-ietf-dhc-dhcpv4-bulk-leasequery">draft-ietf-dhc-dh...</a>] [<a href="https://tools.ietf.org/rfcdiff?difftype=--hwdiff&amp;url2=rfc6926" title="Inline diff (wdiff)">Diff1</a>] [<a href="https://tools.ietf.org/rfcdiff?url2=rfc6926" title="Side-by-side diff">Diff2</a>]                 </span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<span class="pre noprint docinfo">Updated by: <a href="rfc7724.html">7724</a>                                       PROPOSED STANDARD</span><br/>
<span class="pre noprint docinfo">                                                                        </span><br/>
<pre>Internet Engineering Task Force (IETF)                        K. Kinnear
Request for Comments: 6926                                      M. Stapp
Category: Standards Track                            Cisco Systems, Inc.
ISSN: 2070-1721                                               R. Desetti
                                                                B. Joshi
                                                            Infosys Ltd.
                                                              N. Russell
                                            Sea Street Technologies Inc.
                                                             P. Kurapati
                                                        Juniper Networks
                                                                 B. Volz
                                                     Cisco Systems, Inc.
                                                              April 2013


                         <span class="h1">DHCPv4 Bulk Leasequery</span>

Abstract

   The Dynamic Host Configuration Protocol for IPv4 (DHCPv4) Leasequery
   protocol allows a requestor to request information about DHCPv4
   bindings.  This protocol is limited to queries for individual
   bindings.  In some situations, individual binding queries may not be
   efficient or even possible.  This document extends the DHCPv4
   Leasequery protocol to allow for bulk transfer of DHCPv4 address
   binding data via TCP.

Status of This Memo

   This is an Internet Standards Track document.

   This document is a product of the Internet Engineering Task Force
   (IETF).  It represents the consensus of the IETF community.  It has
   received public review and has been approved for publication by the
   Internet Engineering Steering Group (IESG).  Further information on
   Internet Standards is available in <a href="rfc5741.html#section-2">Section 2 of RFC 5741</a>.

   Information about the current status of this document, any errata,
   and how to provide feedback on it may be obtained at
   <a href="http://www.rfc-editor.org/info/rfc6926">http://www.rfc-editor.org/info/rfc6926</a>.











<span class="grey">Kinnear, et al.              Standards Track                    [Page 1]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-2" id="page-2" name="page-2"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


Copyright Notice

   Copyright (c) 2013 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="https://tools.ietf.org/html/bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.





































<span class="grey">Kinnear, et al.              Standards Track                    [Page 2]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-3" id="page-3" name="page-3"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


Table of Contents

   <a href="#section-1">1</a>. Introduction ....................................................<a href="#page-4">4</a>
   <a href="#section-2">2</a>. Terminology .....................................................<a href="#page-5">5</a>
   <a href="#section-3">3</a>. Design Goals ....................................................<a href="#page-8">8</a>
      <a href="#section-3.1">3.1</a>. Information Acquisition before Data Starts .................<a href="#page-8">8</a>
      <a href="#section-3.2">3.2</a>. Lessen Need for Caching and Negative Caching ...............<a href="#page-8">8</a>
      <a href="#section-3.3">3.3</a>. Antispoofing in 'Fast Path' ................................<a href="#page-8">8</a>
      <a href="#section-3.4">3.4</a>. Minimize Data Transmission .................................<a href="#page-9">9</a>
   <a href="#section-4">4</a>. Protocol Overview ...............................................<a href="#page-9">9</a>
   <a href="#section-5">5</a>. Interaction between UDP Leasequery and Bulk Leasequery .........<a href="#page-11">11</a>
   <a href="#section-6">6</a>. Message and Option Definitions .................................<a href="#page-12">12</a>
      <a href="#section-6.1">6.1</a>. Message Framing for TCP ...................................<a href="#page-12">12</a>
      <a href="#section-6.2">6.2</a>. New or Changed Options ....................................<a href="#page-13">13</a>
      <a href="#section-6.3">6.3</a>. Connection and Transmission Parameters ....................<a href="#page-20">20</a>
   <a href="#section-7">7</a>. Requestor Behavior .............................................<a href="#page-21">21</a>
      <a href="#section-7.1">7.1</a>. Connecting and General Processing .........................<a href="#page-21">21</a>
      <a href="#section-7.2">7.2</a>. Forming a Bulk Leasequery .................................<a href="#page-21">21</a>
      <a href="#section-7.3">7.3</a>. Processing Bulk Replies ...................................<a href="#page-23">23</a>
      <a href="#section-7.4">7.4</a>. Processing Time Values in Leasequery Messages .............<a href="#page-25">25</a>
      <a href="#section-7.5">7.5</a>. Querying Multiple Servers .................................<a href="#page-26">26</a>
      7.6. Making Sense out of Multiple Responses concerning
           a Single IPv4 Address .....................................<a href="#page-26">26</a>
      <a href="#section-7.7">7.7</a>. Multiple Queries to a Single Server over One Connection ...<a href="#page-27">27</a>
      <a href="#section-7.8">7.8</a>. Closing Connections .......................................<a href="#page-28">28</a>
   <a href="#section-8">8</a>. Server Behavior ................................................<a href="#page-29">29</a>
      <a href="#section-8.1">8.1</a>. Accepting Connections .....................................<a href="#page-29">29</a>
      <a href="#section-8.2">8.2</a>. Replying to a Bulk Leasequery .............................<a href="#page-29">29</a>
      <a href="#section-8.3">8.3</a>. Building a Single Reply for Bulk Leasequery ...............<a href="#page-33">33</a>
      <a href="#section-8.4">8.4</a>. Multiple or Parallel Queries ..............................<a href="#page-34">34</a>
      <a href="#section-8.5">8.5</a>. Closing Connections .......................................<a href="#page-35">35</a>
   <a href="#section-9">9</a>. Security Considerations ........................................<a href="#page-35">35</a>
   <a href="#section-10">10</a>. IANA Considerations ...........................................<a href="#page-37">37</a>
   <a href="#section-11">11</a>. Acknowledgements ..............................................<a href="#page-38">38</a>
   <a href="#section-12">12</a>. References ....................................................<a href="#page-38">38</a>
      <a href="#section-12.1">12.1</a>. Normative References .....................................<a href="#page-38">38</a>
      <a href="#section-12.2">12.2</a>. Informative References ...................................<a href="#page-39">39</a>














<span class="grey">Kinnear, et al.              Standards Track                    [Page 3]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-4" id="page-4" name="page-4"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/1.%20%20Introduction"></a><a class="selflink" href="#section-1" name="section-1">1</a>.  Introduction</span>

   DHCPv4 [<a href="rfc2131.html" title='"Dynamic Host Configuration Protocol"'>RFC2131</a>] [<a href="rfc2132.html" title='"DHCP Options and BOOTP Vendor Extensions"'>RFC2132</a>] specifies a protocol for the assignment of
   IPv4 address and configuration information to IPv4 nodes.  DHCPv4
   servers maintain authoritative binding information.

      +--------+
      | DHCPv4 |     +--------------+
      | Server |-...-|    DHCP      |
      |        |     |  Relay Agent |
      +--------+     +--------------+
                          |        |
                      +------+   +------+
                      |Modem1|   |Modem2|
                      +------+   +------+
                         |        |    |
                      +-----+  +-----+ +-----+
                      |Node1|  |Node2| |Node3|
                      +-----+  +-----+ +-----+

       Figure 1:  Example DHCPv4 Configuration

   DHCPv4 relay agents receive DHCPv4 messages and frequently append a
   Relay Agent Information option [<a href="rfc3046.html" title='"DHCP Relay Agent Information Option"'>RFC3046</a>] before relaying them to the
   configured DHCPv4 servers (see Figure 1).  In this process, some
   relay agents also glean lease information sent by the server and
   cache it locally.  This information is used for a variety of
   purposes.  Two examples are prevention of spoofing attempts from the
   DHCPv4 clients and installation of routes.  When a relay agent
   reboots, this information is frequently lost.

   The DHCPv4 Leasequery capability [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>] extends the basic DHCPv4
   capability to allow an external entity, such as a relay agent, to
   query a DHCPv4 server to rapidly recover lease state information
   about a particular IP address or client.

   The existing query types in Leasequery are typically data driven; the
   relay agent initiates the Leasequery when it receives data traffic
   from or to the client.  This approach may not scale well when there
   are thousands of clients connected to the relay agent or when the
   relay agent has a need to rebuild its internal data store prior to
   processing traffic in one direction or another.

   Some applications require the ability to query the server without
   waiting for traffic from or to clients.  This query capability, in
   turn, requires an underlying transport more suitable to the bulk
   transmission of data.




<span class="grey">Kinnear, et al.              Standards Track                    [Page 4]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-5" id="page-5" name="page-5"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   This document extends the DHCPv4 Leasequery protocol [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>] to add
   support for queries that address these additional requirements.
   There may be many thousands of DHCPv4 bindings returned as the result
   of a single request, so TCP [<a href="rfc4614.html" title='"A Roadmap for Transmission Control Protocol (TCP) Specification Documents"'>RFC4614</a>] is specified for efficiency of
   data transfer.  We define several additional query types, each of
   which can return multiple responses, in order to meet a variety of
   requirements.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/2.%20%20Terminology"></a><a class="selflink" href="#section-2" name="section-2">2</a>.  Terminology</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and
   "OPTIONAL" in this document are to be interpreted as described in <a href="rfc2119.html">RFC</a>
   <a href="rfc2119.html">2119</a> [<a href="rfc2119.html" title='"Key words for use in RFCs to Indicate Requirement Levels"'>RFC2119</a>].

   This document uses the following terms:

   o "absolute time"

      Absolute time is a 32-bit quantity containing the number of
      seconds since January 1, 1970.

   o "access concentrator"

      An access concentrator is a router or switch at the broadband
      access provider's edge of a public broadband access network.  This
      document assumes that the access concentrator includes the DHCPv4
      relay agent functionality, for example, a CMTS (Cable Modem
      Termination System) in a cable environment or a DSLAM (Digital
      Subscriber Line Access Multiplexer) in a DSL environment.

   o "active binding"

      An IP address with an active binding refers to an IP address that
      is currently associated with a DHCPv4 client where that DHCPv4
      client has the right to use the IP address.

   o "Bulk Leasequery"

      Bulk Leasequery involves requesting and receiving the existing
      DHCPv4 address binding information in an efficient manner.

   o "clock skew"

      The clock skew for a Bulk Leasequery connection is the difference
      between the absolute time on a DHCPv4 server and the absolute time
      on the system where a requestor of a Bulk Leasequery is executing.
      It is not absolutely constant but is likely to vary only slowly.



<span class="grey">Kinnear, et al.              Standards Track                    [Page 5]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-6" id="page-6" name="page-6"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


      It is possible that, when both systems run NTP, the clock skew is
      negligible; this is not only acceptable but desired.

      While it is easy to think that this can be calculated precisely
      after one message is received by a requestor from a DHCPv4 server,
      a more accurate value is derived from continuously examining the
      instantaneous value developed from each message received from a
      DHCPv4 server and using it to make small adjustments to the
      existing value held in the requestor.

   o "Default VPN"

      A default VPN indicates that the address being described belongs
      to the set of addresses not part of any VPN (in other words, the
      normal address space operated on by DHCP).  This includes Special
      Use IPv4 Addresses as defined in [<a href="rfc5735.html" title='"Special Use IPv4 Addresses"'>RFC5735</a>].

   o "DHCPv4 client"

      A DHCPv4 client is an Internet node using DHCPv4 to obtain
      configuration parameters such as a network address.

   o "DHCPv4 relay agent"

      A DHCPv4 relay agent is an agent that is neither a DHCPv4 client
      nor a DHCP server that transfers BOOTP and DHCPv4 messages between
      clients and servers residing on different subnets, per [<a href="rfc951.html" title='"Bootstrap Protocol"'>RFC951</a>]
      and [<a href="rfc1542.html" title='"Clarifications and Extensions for the Bootstrap Protocol"'>RFC1542</a>].

   o "DHCPv4 server"

      A DHCPv4 server is an Internet node that returns configuration
      parameters to DHCPv4 clients.

   o "DSLAM"

      DSLAM stands for Digital Subscriber Line Access Multiplexer.

   o "downstream"

      Downstream refers to a direction away from the central part of a
      network and toward the edge.  In a DHCPv4 context, this typically
      refers to a network direction that is away from the DHCPv4 server
      and toward the DHCPv4 client.

   o "Global VPN"

      Global VPN is another name for the default VPN.



<span class="grey">Kinnear, et al.              Standards Track                    [Page 6]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-7" id="page-7" name="page-7"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   o "IP address"

      In this document, the term "IP address" refers to an IPv4 IP
      address.

   o "IP address binding"

      An IP address binding is the information that a DHCPv4 server
      keeps regarding the relationship between a DHCPv4 client and an IP
      address.  This includes the identity of the DHCPv4 client and the
      expiration time, if any, of any lease that client has on a
      particular IP address.  In some contexts, this may include
      information on IP addresses that are currently associated with
      DHCPv4 clients, and in others, it may also include IP addresses
      with no current association to a DHCPv4 client.

   o "MAC address"

      In the context of a DHCPv4 message, a Media Access Control (MAC)
      address consists of the fields: hardware type "htype", hardware
      length "hlen", and client hardware address "chaddr".

   o "upstream"

      Upstream refers to a direction toward the central part of a
      network and away from the edge.  In a DHCPv4 context, this
      typically refers to a network direction that is away from the
      DHCPv4 client and toward the DHCPv4 server.

   o "stable storage"

      Stable storage is used to hold information concerning IP address
      bindings (among other things) so that this information is not lost
      in the event of a failure that requires restart of the network
      element.  DHCPv4 servers are typically expected to have high-speed
      access to stable storage, while relay agents and access
      concentrators usually do not have access to stable storage,
      although they may have periodic access to such storage.

   o "xid"

      Transaction-id.  The term "xid" refers to the DHCPv4 field
      containing the transaction-id of the message.








<span class="grey">Kinnear, et al.              Standards Track                    [Page 7]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-8" id="page-8" name="page-8"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/3.%20%20Design%20Goals"></a><a class="selflink" href="#section-3" name="section-3">3</a>.  Design Goals</span>

   The goal of this document is to provide a lightweight protocol for an
   access concentrator or other network element (such as a DHCP relay
   agent) to retrieve IP address binding information available in the
   DHCPv4 server.  The protocol should also allow an access concentrator
   or DHCP relay agent to retrieve consolidated IP address binding
   information for either the entire access concentrator or a single
   connection/circuit.  Throughout the discussion below, everything that
   applies to an access concentrator also applies to a DHCP relay agent.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.1.%20%20Information%20Acquisition%20before%20Data%20Starts"></a><a class="selflink" href="#section-3.1" name="section-3.1">3.1</a>.  Information Acquisition before Data Starts</span>

   The existing data-driven approach required by [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>] means that
   the Leasequeries can only be performed after an access concentrator
   receives data.  To implement antispoofing, the concentrator must drop
   messages for each client until it gets lease information from the
   DHCPv4 server for that client.  If an access concentrator finishes
   the Leasequeries before it starts receiving data, then there is no
   need to drop legitimate messages.  In this way, outage time may be
   reduced.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.2.%20%20Lessen%20Need%20for%20Caching%20and%20Negative%20Caching"></a><a class="selflink" href="#section-3.2" name="section-3.2">3.2</a>.  Lessen Need for Caching and Negative Caching</span>

   The result of a single Leasequery should be cached, whether that
   results in a positive or negative cache, in order to remember that
   the Leasequery was performed.  This caching is required to limit the
   traffic imposed upon a DHCPv4 server by Leasequeries for information
   already received.

   These caches not only consume precious resources, they also need to
   be managed.  Hence, they should be avoided as much as possible.  One
   of the goals of the DHCPv4 Bulk Leasequery is to reduce the need for
   this sort of caching.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.3.%20%20Antispoofing%20in%20%27Fast%20Path%27"></a><a class="selflink" href="#section-3.3" name="section-3.3">3.3</a>.  Antispoofing in 'Fast Path'</span>

   If antispoofing is not done in the fast path, it will become a
   bottleneck and may lead to denial of service of the access
   concentrator.  The Leasequeries should make it possible to do
   antispoofing in the fast path.










<span class="grey">Kinnear, et al.              Standards Track                    [Page 8]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-9" id="page-9" name="page-9"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/3.4.%20%20Minimize%20Data%20Transmission"></a><a class="selflink" href="#section-3.4" name="section-3.4">3.4</a>.  Minimize Data Transmission</span>

   It may be that a network element is able to periodically save its
   entire list of assigned IP addresses to some form of stable storage.
   In this case, it will wish to recover all of the updates to this
   information without duplicating the information it has recovered from
   its own stable storage.

   Bulk Leasequery allows the specification of a query-start-time as
   well as a query-end-time.  Use of query times allows a network
   element that periodically commits information to stable storage to
   recover just what it lost since the last commit.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/4.%20%20Protocol%20Overview"></a><a class="selflink" href="#section-4" name="section-4">4</a>.  Protocol Overview</span>

   The DHCPv4 Bulk Leasequery protocol is modeled on the existing
   individual DHCPv4 Leasequery protocol in [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>] as well as related
   work on DHCPv6 Bulk Leasequery [<a href="rfc5460.html" title='"DHCPv6 Bulk Leasequery"'>RFC5460</a>].  A Bulk Leasequery
   requestor opens a TCP connection to a DHCPv4 server using the DHCPv4
   port 67.  Note that this implies that the Leasequery requestor has
   server IP address(es) available via configuration or some other means
   and that it has unicast IP reachability to the DHCPv4 server.  No
   relaying of Bulk Leasequery messages is specified.

   After establishing a connection, the requestor sends a
   DHCPBULKLEASEQUERY message over the connection.

   The server uses the message type and additional data in the DHCPv4
   DHCPBULKLEASEQUERY message to identify any relevant bindings.

   In order to support some query types, servers may have to maintain
   additional data structures or otherwise be able to locate bindings
   that have been requested by the Leasequery requestor.

   Relevant bindings are returned in DHCPv4 messages with either the
   DHCPLEASEACTIVE message type for an IP address with a currently
   active lease or, in some situations, a DHCPLEASEUNASSIGNED message
   type for an IP address that is controlled by the DHCPv4 server but is
   not actively leased by a DHCPv4 client at the present time.

   The Bulk Leasequery protocol is designed to provide an external
   entity with information concerning existing DHCPv4 IPv4 address
   bindings managed by the DHCPv4 server.  When complete, the DHCPv4
   server will send a DHCPLEASEQUERYDONE message.  If a connection is
   lost while processing a Bulk Leasequery, the Bulk Leasequery must be
   retried as there is no provision for determining the extent of data
   already received by the requestor for a Bulk Leasequery.




<span class="grey">Kinnear, et al.              Standards Track                    [Page 9]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-10" id="page-10" name="page-10"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   Bulk Leasequery supports queries by MAC address and by Client
   Identifier in a way similar to [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>].  The Bulk Leasequery
   protocol also adds several new queries.

   o  Query by Relay Identifier

      This query asks a server for the bindings associated with a
      specific relay agent; the relay agent is identified by a Relay
      Agent Identifier carried in a Relay-ID sub-option [<a href="rfc6925.html" title='"The DHCPv4 Relay Agent Identifier Sub-Option"'>RFC6925</a>].
      Relay agents can include this sub-option while relaying messages
      to DHCPv4 servers.  Servers can retain the Relay-ID and associate
      it with bindings made on behalf of the relay agent's clients.  The
      bindings returned are only those for DHCPv4 clients with a
      currently active binding.

   o  Query by Remote ID

      This query asks a server for the bindings associated with a relay
      agent Remote ID sub-option [<a href="rfc3046.html" title='"DHCP Relay Agent Information Option"'>RFC3046</a>] value.  The bindings returned
      are only those for DHCPv4 clients with a currently active binding.

   o  Query for All Configured IP Addresses

      This query asks a server for information concerning all IP
      addresses configured in that DHCPv4 server by specifying no other
      type of query.  In this case, the bindings returned are for all
      configured IP addresses, whether or not they contain a currently
      active binding to a DHCPv4 client, since one point of this type of
      query is to update an existing database with changes after a
      particular point in time.

   Any of the above queries can be qualified by the specification of a
   query-start-time or a query-end-time (or both).  When these timers
   are used as qualifiers, they indicate that a binding should be
   included if it changed on or after the query-start-time and on or
   before the query-end-time.

   In addition, any of the above queries can be qualified by the
   specification of a VPN-ID option [<a href="rfc6607.html" title='"Virtual Subnet Selection Options for DHCPv4 and DHCPv6"'>RFC6607</a>] to select the VPN on which
   the query should be processed.  The VPN-ID option is also extended to
   allow queries across all available VPNs.  In the absence of any VPN-
   ID option, only the default (global) VPN is used to satisfy the
   query.








<span class="grey">Kinnear, et al.              Standards Track                   [Page 10]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-11" id="page-11" name="page-11"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/5.%20%20Interaction%20between%20UDP%20Leasequery%20and%20Bulk%20Leasequery"></a><a class="selflink" href="#section-5" name="section-5">5</a>.  Interaction between UDP Leasequery and Bulk Leasequery</span>

   Bulk Leasequery can be seen as an extension of the existing UDP
   Leasequery protocol [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>].  This section clarifies the
   relationship between the two protocols.

   The Bulk Leasequery TCP connection is only designed to handle the
   DHCPBULKLEASEQUERY request.  It is not intended as an alternative
   DHCPv4 communication option for clients seeking other DHCPv4
   services.  DHCPv4 address allocation could not be performed over a
   TCP connection in any case, as a TCP connection requires an IP
   address and no IPv4 address exists prior to a successful DHCPv4
   address allocation exchange.  In addition, the existing DHCPv4 UDP
   transmission regime is implemented in untold millions of devices
   deployed worldwide, and complicating DHCPv4 services with alternative
   transmission approaches (even if it were possible) would be worse
   than any perceived benefit to doing so.

   Two of the query types introduced in the UDP Leasequery protocol can
   be used in the Bulk Leasequery protocol -- Query by MAC address and
   Query by Client-identifier.

   The contents of the reply messages are similar between the existing
   UDP Leasequery protocol and the Bulk Leasequery protocol, though more
   information is returned in the Bulk Leasequery messages.

   One change in behavior for these existing queries is required when
   Bulk Leasequery is used.  Sections <a href="#section-6.1">6.1</a>, <a href="#section-6.4.1">6.4.1</a>, and <a href="#section-6.4.2">6.4.2</a> of [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>]
   specify the use of an associated-ip option in DHCPLEASEACTIVE
   messages in cases where multiple bindings were found.  When Bulk
   Leasequery is used, this mechanism is not necessary; a server
   returning multiple bindings simply does so directly as specified in
   this document.  The associated-ip option MUST NOT appear in Bulk
   Leasequery replies.

   Implementors should note that the TCP message framing defined in
   <a href="#section-6.1">Section 6.1</a> is not compatible with the UDP message format.  If a TCP-
   framed request is sent as a UDP message, it may not be valid, because
   protocol fields will be offset by the message-size prefix.












<span class="grey">Kinnear, et al.              Standards Track                   [Page 11]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-12" id="page-12" name="page-12"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/6.%20%20Message%20and%20Option%20Definitions"></a><a class="selflink" href="#section-6" name="section-6">6</a>.  Message and Option Definitions</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.1.%20%20Message%20Framing%20for%20TCP"></a><a class="selflink" href="#section-6.1" name="section-6.1">6.1</a>.  Message Framing for TCP</span>

   The use of TCP for the Bulk Leasequery protocol permits multiple
   messages to be sent from one end of the connection to the other
   without requiring a request/response paradigm as does UDP DHCPv4
   [<a href="rfc2131.html" title='"Dynamic Host Configuration Protocol"'>RFC2131</a>].  The receiver needs to be able to determine the size of
   each message it receives.  Two octets containing the message size in
   network byte order are prepended to each DHCPv4 message sent on a
   Bulk Leasequery TCP connection.  The two message-size octets 'frame'
   each DHCPv4 message.

   The maximum message size is 65535 octets.

      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |         message-size          |    op (1)     |   htype (1)   |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |   hlen (1)    |   hops (1)    |              ....             |
     +---------------+---------------+                               +
     |                                                               |
     .                  remainder of DHCPv4 message,
     .                   from Figure 1 of [<a href="rfc2131.html" title='"Dynamic Host Configuration Protocol"'>RFC2131</a>]                  .
     .                                                               .
     .                           (variable)                          .
     |                                                               |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

          message-size    the number of octets in the message that
                          follows, as a 16-bit unsigned integer in
                          network byte order.

          All other fields are as specified in DHCPv4 [<a href="rfc2131.html" title='"Dynamic Host Configuration Protocol"'>RFC2131</a>].

                 Figure 2:  Format of a DHCPv4 Message in TCP

   The intent in using this format is that code that currently knows how
   to deal with sending or receiving a message in [<a href="rfc2131.html" title='"Dynamic Host Configuration Protocol"'>RFC2131</a>] format will
   easily be able to deal with the message contained in the TCP framing.










<span class="grey">Kinnear, et al.              Standards Track                   [Page 12]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-13" id="page-13" name="page-13"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.2.%20%20New%20or%20Changed%20Options"></a><a class="selflink" href="#section-6.2" name="section-6.2">6.2</a>.  New or Changed Options</span>

   The existing messages DHCPLEASEUNASSIGNED and DHCPLEASEACTIVE are
   used as the value of the dhcp-message-type option to indicate an IP
   address that is currently not leased or currently leased to a DHCPv4
   client, respectively [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>].

   Additional options have also been defined to enable the Bulk
   Leasequery protocol to communicate useful information to the
   requestor.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/6.2.1.%20%20dhcp-message-type"></a><a class="selflink" href="#section-6.2.1" name="section-6.2.1">6.2.1</a>.  dhcp-message-type</span>

   The dhcp-message-type option (option 53) from <a href="rfc2132.html#section-9.6">Section 9.6 of
   [RFC2132]</a> requires new values.  The values of these message types are
   shown below in an extension of the table from <a href="rfc2132.html#section-9.6">Section 9.6 of
   [RFC2132]</a>:

            Value   Message Type
            -----   ------------
            14      DHCPBULKLEASEQUERY
            15      DHCPLEASEQUERYDONE

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/6.2.2.%20%20status-code"></a><a class="selflink" href="#section-6.2.2" name="section-6.2.2">6.2.2</a>.  status-code</span>

   The status-code option allows a machine-readable value to be returned
   regarding the status of a DHCPBULKLEASEQUERY request.

   This option has two possible scopes when used with Bulk Leasequery,
   depending on the context in which it appears.  It refers to the
   information in a single Leasequery reply if the value of the dhcp-
   message-type is DHCPLEASEACTIVE or DHCPLEASEUNASSIGNED.  It refers to
   the message stream related to an entire request if the value of the
   dhcp-message-type is DHCPLEASEQUERYDONE.

   The code for this option is 151.  The length of this option is a
   minimum of 1 octet.

                     Status           Status
       Code    Len    Code            Message
      +------+------+------+------+------+--   --+-----+
      |  151 | n+1  |status|  s1  |  s2  |  ...  | sn  |
      +------+------+------+------+------+--   --+-----+








<span class="grey">Kinnear, et al.              Standards Track                   [Page 13]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-14" id="page-14" name="page-14"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   The status-code is indicated in one octet as defined in the table
   below.  The Status Message is an optional UTF-8-encoded text string
   suitable for display to an end user.  This text string MUST NOT
   contain a termination character (e.g., a null).  The Len field
   describes the length of the Status Message without any terminator
   character.  Null characters MUST NOT appear in the Status Message
   string, and it is a protocol violation for them to appear in any
   position in the Status Message, including at the end.

     Name    Status Code Description
     ----    ----------- -----------
     Success         000 Success.  Also signaled by absence of
                         a status-code option.

     UnspecFail      001 Failure, reason unspecified.

     QueryTerminated 002 Indicates that the server is unable to
                         perform a query or has prematurely terminated
                         the query for some reason (which should be
                         communicated in the text message).

     MalformedQuery  003 The query was not understood.

     NotAllowed      004 The query or request was understood but was
                         not allowed in this context.

   A status-code option MAY appear in the options field of a DHCPv4
   message.  If the status-code option does not appear, it is assumed
   that the operation was successful.  The status-code option SHOULD NOT
   appear in a message that is successful unless there is some text
   string that needs to be communicated to the requestor.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/6.2.3.%20%20base-time"></a><a class="selflink" href="#section-6.2.3" name="section-6.2.3">6.2.3</a>.  base-time</span>

   The base-time option is the current time the message was created to
   be sent by the DHCPv4 server to the requestor of the Bulk Leasequery.
   This MUST be an absolute time.  All of the other time-based options
   in the reply message are relative to this time, including the dhcp-
   lease-time [<a href="rfc2132.html" title='"DHCP Options and BOOTP Vendor Extensions"'>RFC2132</a>] and client-last-transaction-time [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>].
   This time is in the context of the DHCPv4 server that placed this
   option in a message.

   This is an unsigned integer in network byte order.








<span class="grey">Kinnear, et al.              Standards Track                   [Page 14]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-15" id="page-15" name="page-15"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   The code for this option is 152.  The length of this option is 4
   octets.

                       DHCPv4 Server
       Code   Len        base-time
      +-----+-----+-----+-----+-----+-----+
      | 152 |  4  |  t1 |  t2 |  t3 |  t4 |
      +-----+-----+-----+-----+-----+-----+

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/6.2.4.%20%20start-time-of-state"></a><a class="selflink" href="#section-6.2.4" name="section-6.2.4">6.2.4</a>.  start-time-of-state</span>

   The start-time-of-state option allows the receiver to determine the
   time at which the IP address made the transition into its current
   state.

   This MUST NOT be an absolute time, which is equivalent to saying that
   this MUST NOT be an absolute number of seconds since January 1, 1970.
   Instead, this MUST be the unsigned integer number of seconds from the
   time the IP address transitioned its current state to the time
   specified in the base-time option in the same message.

   This is an unsigned integer in network byte order.

   The code for this option is 153.  The length of this option is 4
   octets.

                     Seconds in the past
       Code   Len      from base-time
      +-----+-----+-----+-----+-----+-----+
      | 153 |  4  |  t1 |  t2 |  t3 |  t4 |
      +-----+-----+-----+-----+-----+-----+

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/6.2.5.%20%20query-start-time"></a><a class="selflink" href="#section-6.2.5" name="section-6.2.5">6.2.5</a>.  query-start-time</span>

   The query-start-time option specifies a start query time to the
   DHCPv4 server.  If specified, only bindings that have changed on or
   after the query-start-time should be included in the response to the
   query.

   The requestor MUST determine the query-start-time using lease
   information it has received from the DHCPv4 server.  This MUST be an
   absolute time in the DHCPv4 server's context (see <a href="#section-7.4">Section 7.4</a>).

   Typically (though this is not a requirement), the query-start-time
   option will contain the value most recently received in a base-time
   option by the requestor, as this will indicate the last successful
   communication with the DHCP server.




<span class="grey">Kinnear, et al.              Standards Track                   [Page 15]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-16" id="page-16" name="page-16"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   This MUST be an absolute time.

   This is an unsigned integer in network byte order.

   The code for this option is 154.  The length of this option is 4
   octets.

                         DHCPv4 Server
       Code   Len      query-start-time
      +-----+-----+-----+-----+-----+-----+
      | 154 |  4  |  t1 |  t2 |  t3 |  t4 |
      +-----+-----+-----+-----+-----+-----+

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/6.2.6.%20%20query-end-time"></a><a class="selflink" href="#section-6.2.6" name="section-6.2.6">6.2.6</a>.  query-end-time</span>

   The query-end-time option specifies an end query time to the DHCPv4
   server.  If specified, only bindings that have changed on or before
   the query-end-time should be included in the response to the query.

   The requestor MUST determine the query-end-time based on lease
   information it has received from the DHCPv4 server.  This MUST be an
   absolute time in the context of the DHCPv4 server.

   In the absence of information to the contrary, the requestor SHOULD
   assume that the time context of the DHCPv4 server is identical to the
   time context of the requestor (see <a href="#section-7.4">Section 7.4</a>).

   This is an unsigned integer in network byte order.

   The code for this option is 155.  The length of this option is 4
   octets.

                         DHCPv4 Server
       Code   Len       query-end-time
      +-----+-----+-----+-----+-----+-----+
      | 155 |  4  |  t1 |  t2 |  t3 |  t4 |
      +-----+-----+-----+-----+-----+-----+














<span class="grey">Kinnear, et al.              Standards Track                   [Page 16]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-17" id="page-17" name="page-17"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/6.2.7.%20%20dhcp-state"></a><a class="selflink" href="#section-6.2.7" name="section-6.2.7">6.2.7</a>.  dhcp-state</span>

   The dhcp-state option allows greater detail to be returned than
   allowed by the DHCPLEASEACTIVE and DHCPLEASEUNASSIGNED message types.

   The code for this option is 156.  The length of this option is 1
   octet.

       0                   1                   2
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |     156       |    Length     |    State      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

        156      The option code.

        Length   The option length, 1 octet.

        State    The state of the IP address.

     Value  State
     -----  -----
       1    AVAILABLE     Address is available to local DHCPv4 server
       2    ACTIVE        Address is assigned to a DHCPv4 client
       3    EXPIRED       Lease has expired
       4    RELEASED      Lease has been released by DHCPv4 client
       5    ABANDONED     Server or client flagged address as unusable
       6    RESET         Lease was freed by some external agent
       7    REMOTE        Address is available to a remote DHCPv4 server
       8    TRANSITIONING Address is moving between states

   Note that some of these states may be transient and may not appear in
   normal use.  A DHCPv4 server MUST implement at least the AVAILABLE
   and ACTIVE states and SHOULD implement at least the ABANDONED and
   RESET states.

   Note the states AVAILABLE and REMOTE are relative to the current
   server.  An address that is available to the current server should
   show AVAILABLE on that server, and if another server is involved with
   that address as well, it should show as REMOTE on that other server.

   The dhcp-state option SHOULD contain ACTIVE when it appears in a
   DHCPLEASEACTIVE message.  A DHCPv4 server MAY choose to not send a
   dhcp-state option in a DHCPLEASEACTIVE message, and a requestor
   SHOULD assume that the dhcp-state is ACTIVE if no dhcp-state option
   appears in a DHCPLEASEACTIVE message.





<span class="grey">Kinnear, et al.              Standards Track                   [Page 17]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-18" id="page-18" name="page-18"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   The reference to local and remote relate to possible use in an
   environment that includes multiple servers cooperating to provide an
   increased availability solution.  In this case, an IP address with
   the state of AVAILABLE is available to the local server, while one
   with the state of REMOTE is available to a remote server.  Usually,
   an IP address that is AVAILABLE on one server would be REMOTE on any
   remote server.  The TRANSITIONING state is also likely to be useful
   in multiple server deployments, where sometimes one server must
   interlock a state change with one or more other servers.  Should a
   Bulk Leasequery need to send information concerning the state of the
   IP address during this period, it SHOULD use the TRANSITIONING state,
   since the IP address is likely to be neither ACTIVE or AVAILABLE.

   There is no requirement for the state of an IP address to transition
   in a well-defined way from state to state.  To put this another way,
   you cannot draw a simple state transition graph for the states of an
   IP address, and the requestor of a Leasequery MUST NOT depend on one
   certain state always following a particular previous state.  While a
   state transition diagram can be drawn, it would be fully connected
   and therefore conveys no useful information.  Every state can (at
   times) follow every other state.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/6.2.8.%20%20data-source"></a><a class="selflink" href="#section-6.2.8" name="section-6.2.8">6.2.8</a>.  data-source</span>

   The data-source option contains information about the source of the
   data in a DHCPLEASEACTIVE or a DHCPLEASEUNASSIGNED message.  It
   SHOULD be used when there are two or more servers that might have
   information about a particular IP address binding.  Frequently, two
   servers work together to provide an increased availability solution
   for the DHCPv4 service, and in these cases, both servers will respond
   to Bulk Leasequery requests for the same IP address.  When one server
   is working with another server and both may respond with information
   about the same IP address, each server SHOULD return the data-source
   option with the other information provided about the IP address.

   The data contained in this option will allow an external process to
   better discriminate between the information provided by each of the
   servers servicing this IPv4 address.













<span class="grey">Kinnear, et al.              Standards Track                   [Page 18]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-19" id="page-19" name="page-19"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   The code for this option is 157.  The length of this option is 1
   octet.

         0                   1                   2
         0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3
        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
        |     157       |    Length     |     Flags     |
        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

          157      The option code.

          Length   The option length, 1 octet.

          Flags    The source information for this message.

                      0 1 2 3 4 5 6 7
                     +-+-+-+-+-+-+-+-+
                     |    UNA      |R|
                     +-+-+-+-+-+-+-+-+

                     R:  REMOTE flag

                          remote = 1
                          local = 0

                     UNA:  UNASSIGNED

   The REMOTE flag is used to indicate where the most recent change of
   state (or other interesting change) concerning this IPv4 address took
   place.  If the value is local, then the change took place on the
   server from which this message was transmitted.  If the value is
   remote, then the change took place on some other server and was made
   known to the server from which this message was transmitted.

   If this option was requested and it doesn't appear, the requestor
   MUST consider that the data-source was local.

   Unassigned bits MUST be ignored.













<span class="grey">Kinnear, et al.              Standards Track                   [Page 19]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-20" id="page-20" name="page-20"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/6.2.9.%20%20Virtual%20Subnet%20Selection%20Type%20and%20Information"></a><a class="selflink" href="#section-6.2.9" name="section-6.2.9">6.2.9</a>.  Virtual Subnet Selection Type and Information</span>

   All of the (sub-)options defined in [<a href="rfc6607.html" title='"Virtual Subnet Selection Options for DHCPv4 and DHCPv6"'>RFC6607</a>] carry identical
   payloads, consisting of a type and additional VSS (Virtual Subnet
   Selection) information.  The existing table is extended (see below)
   with a new type 254 to allow specification of a type code that
   indicates that all VPNs are to be used to process the Bulk
   Leasequery.

              Type   VSS Information Format
              ----------------------------------------------------------
              0      Network Virtual Terminal (NVT) ASCII VPN identifier
              1      <a href="rfc2685.html">RFC 2685</a> VPN-ID
   CHANGED -&gt; 2-253  Unassigned
      NEW  -&gt; 254    All VPNs (wildcard)
              255    Global, default VPN

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/6.3.%20%20Connection%20and%20Transmission%20Parameters"></a><a class="selflink" href="#section-6.3" name="section-6.3">6.3</a>.  Connection and Transmission Parameters</span>

   DHCPv4 servers that support Bulk Leasequery SHOULD listen for
   incoming TCP connections on the DHCPv4 server port 67.
   Implementations MAY offer to make the incoming port configurable, but
   port 67 MUST be the default.  Requestors SHOULD make TCP connections
   to port 67 and MAY offer to make the destination server port
   configurable.

   This section presents a table of values used to control Bulk
   Leasequery behavior, including recommended defaults.  Implementations
   MAY make these values configurable.  However, configuring too-small
   timeout values may lead to harmful behavior both to this application
   as well as to other traffic in the network.  As a result, timeout
   values smaller than the default values are NOT RECOMMENDED.

   Parameter             Default   Description
   --------------------------------------------------------------------
   BULK_LQ_DATA_TIMEOUT  300 secs  Bulk Leasequery data timeout
                                   for both client and server
                                   (see Sections <a href="#section-7">7</a> and <a href="#section-8">8</a>)
   BULK_LQ_MAX_CONNS     10        Max Bulk Leasequery TCP connections
                                   at the server side (see <a href="#section-8.1">Section 8.1</a>)











<span class="grey">Kinnear, et al.              Standards Track                   [Page 20]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-21" id="page-21" name="page-21"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/7.%20%20Requestor%20Behavior"></a><a class="selflink" href="#section-7" name="section-7">7</a>.  Requestor Behavior</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.1.%20%20Connecting%20and%20General%20Processing"></a><a class="selflink" href="#section-7.1" name="section-7.1">7.1</a>.  Connecting and General Processing</span>

   A requestor attempts to establish a TCP connection to a DHCPv4 server
   in order to initiate a Leasequery exchange.  If the attempt fails,
   the requestor MAY retry.

   If Bulk Leasequery is terminated prematurely by a DHCPLEASEQUERYDONE
   with a status-code option with a status code of QueryTerminated or by
   the failure of the connection over which it was being submitted, the
   requestor MAY retry the request after the creation of a new
   connection.

   Messages from the DHCPv4 server come as multiple responses to a
   single DHCPBULKLEASEQUERY message.  Thus, each DHCPBULKLEASEQUERY
   request MUST have an xid (transaction-id) unique on the connection on
   which it is sent.  All of the messages that come as a response to
   that message will contain the same xid as the request.  The xid
   allows the data-streams of two different DHCPBULKLEASEQUERY requests
   to be demultiplexed by the requestor.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.2.%20%20Forming%20a%20Bulk%20Leasequery"></a><a class="selflink" href="#section-7.2" name="section-7.2">7.2</a>.  Forming a Bulk Leasequery</span>

   Bulk Leasequery is designed to create a connection that will transfer
   the state of some subset (or possibly all) of the IP address bindings
   from the DHCPv4 server to the requestor.  The DHCPv4 server will send
   all of the requested IPv4 address bindings across this connection
   with minimal delay after it receives the request.  In this context,
   "all IP address binding information" means information about all IPv4
   addresses configured within the DHCPv4 server that meet the specified
   query criteria.  For some query criteria, this may include IP address
   binding information for IP addresses that may not now have or ever
   have had an association with a specific DHCPv4 client.

   To form the Bulk query, a DHCPv4 request is constructed with a dhcp-
   message-type of DHCPBULKLEASEQUERY.  The query SHOULD have a dhcp-
   parameter-request-list to inform the DHCPv4 server which DHCPv4
   options are of interest to the requestor sending the
   DHCPBULKLEASEQUERY message.  The dhcp-parameter-request-list in a
   DHCPBULKLEASEQUERY message SHOULD contain the codes for base-time,
   dhcp-lease-time, start-time-of-state, and client-last-transaction-
   time.

   A DHCPBULKLEASEQUERY request is constructed of one primary query and
   optionally one or more qualifiers for it.





<span class="grey">Kinnear, et al.              Standards Track                   [Page 21]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-22" id="page-22" name="page-22"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   The possible primary queries are listed below.  Each
   DHCPBULKLEASEQUERY request MUST contain only one of these primary
   queries.

   o  Query by MAC address

      In a Query by MAC address, the chaddr, htype, and hlen of the
      DHCPv4 packet are filled in with the values requested.

   o  Query by Client-identifier

      In a Query by Client-identifier, a Client-identifier option
      containing the requested value is included in the
      DHCPBULKLEASEQUERY request.

   o  Query by Remote ID

      In a Query by Remote ID, a Remote ID sub-option containing the
      requested value is included in the relay-agent-information option
      of the DHCPBULKLEASEQUERY request.

   o  Query by Relay-ID

      In a Query by Relay-ID, a Relay-ID sub-option [<a href="rfc6925.html" title='"The DHCPv4 Relay Agent Identifier Sub-Option"'>RFC6925</a>] containing
      the requested value is included in the relay-agent-information
      option of the DHCPBULKLEASEQUERY request.

   o  Query for All Configured IP Addresses

      A Query for All Configured IP addresses is signaled by the absence
      of any other primary query.

   There are three qualifiers that can be applied to any of the above
   primary queries.  These qualifiers can appear individually or
   together in any combination, but only one of each can appear.

   o  Query Start Time

      Inclusion of a query-start-time option specifies that only IP
      address bindings that have changed on or after the time specified
      in the query-start-time option should be returned.

   o  Query End Time

      Inclusion of a query-end-time option specifies that only IP
      address bindings that have changed on or before the time specified
      in the query-end-time option should be returned.




<span class="grey">Kinnear, et al.              Standards Track                   [Page 22]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-23" id="page-23" name="page-23"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   o  VPN-ID

      If no VPN-ID option appears in the DHCPBULKLEASEQUERY, the default
      (global) VPN is searched to satisfy the query specified by the
      DHCPBULKLEASEQUERY.  Using the VPN-ID option [<a href="rfc6607.html" title='"Virtual Subnet Selection Options for DHCPv4 and DHCPv6"'>RFC6607</a>] allows the
      requestor to specify a single VPN other than the default VPN.  In
      addition, the VPN-ID option has been extended as part of this
      document to allow specification that all configured VPNs be
      searched in order to satisfy the query specified in the
      DHCPBULKLEASEQUERY.

      In all cases, any message returned from a DHCPBULKLEASEQUERY
      request containing information about an IP address for other than
      the default (global) VPN MUST contain a VPN-ID option in the
      message.

   Use of the query-start-time or the query-end-time options or both can
   serve to reduce the amount of data transferred over the TCP
   connection by a considerable amount.  Note that the times specified
   in the query-start-time or query-end-time options are absolute times,
   not durations offset from "now".

   The TCP connection may become blocked or stop being writable while
   the requestor is sending its query.  Should this happen, the
   implementation's behavior is controlled by the current value of
   BULK_LQ_DATA_TIMEOUT.  The default value is given elsewhere in this
   document, and this value may be overridden by local configuration of
   the operator.

   If this situation is detected, the requestor SHOULD start a timer
   using the current value of BULK_LQ_DATA_TIMEOUT.  If that timer
   expires, the requestor SHOULD terminate the connection.  This timer
   is completely independent of any TCP timeout established by the TCP
   protocol connection.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.3.%20%20Processing%20Bulk%20Replies"></a><a class="selflink" href="#section-7.3" name="section-7.3">7.3</a>.  Processing Bulk Replies</span>

   The requestor attempts to read a DHCPv4 Leasequery reply message from
   the TCP connection.

   The TCP connection may stop delivering reply data (i.e., the
   connection stops being readable).  Should this happen, the
   implementation's behavior is controlled by the current value of
   BULK_LQ_DATA_TIMEOUT.  The default value is given elsewhere in this
   document, and this value may be overridden by local configuration of
   the operator.





<span class="grey">Kinnear, et al.              Standards Track                   [Page 23]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-24" id="page-24" name="page-24"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   If this situation is detected, the requestor SHOULD start a timer
   using the current value of BULK_LQ_DATA_TIMEOUT.  If that timer
   expires, the requestor SHOULD terminate the connection.

   A single Bulk Leasequery can, and usually will, result in a large
   number of replies.  The requestor MUST be prepared to receive more
   than one reply with an xid matching a single DHCPBULKLEASEQUERY
   message from a single DHCPv4 server.  If the xid in the received
   message does not match an outstanding DHCPBULKLEASEQUERY message, the
   requestor MUST close the TCP connection.

   If the requestor receives more data than it can process, it can
   simply abort the connection and try again with a more specific
   request.  It can also simply read the TCP connection more slowly and
   match the rate at which it can digest the information returned in the
   Bulk Leasequery packets with the rate at which it reads those packets
   from the TCP connection.

   The DHCPv4 server MUST send a server-identifier option (option 54) in
   the first response to any DHCPBULKLEASEQUERY message.  The DHCPv4
   server SHOULD NOT send server-identifier options in subsequent
   responses to that DHCPBULKLEASEQUERY message.  The requestor MUST
   cache the server-identifier option from the first response and apply
   it to any subsequent responses.

   The response messages generated by a DHCPBULKLEASEQUERY request are:

   o  DHCPLEASEACTIVE

      A Bulk Leasequery will generate DHCPLEASEACTIVE messages
      containing binding data for bound IP addresses that match the
      specified query criteria.  The IP address that is bound to a
      DHCPv4 client will appear in the ciaddr field of the
      DHCPLEASEACTIVE message.  The message may contain a non-zero
      chaddr, htype, hlen, and possibly additional options.

   o  DHCPLEASEUNASSIGNED

      Some queries will also generate DHCPLEASEUNASSIGNED messages for
      IP addresses that match the query criteria.  These messages
      indicate that the IP address is managed by the DHCPv4 server but
      is not currently bound to any DHCPv4 client.  The IP address to
      which this message refers will appear in the ciaddr field of the
      DHCPLEASEUNASSIGNED message.  A DHCPLEASEUNASSGINED message MAY
      also contain information about the last DHCPv4 client that was
      bound to this IP address.  The message may contain a non-zero
      chaddr, htype, hlen, and possibly additional options in this case.




<span class="grey">Kinnear, et al.              Standards Track                   [Page 24]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-25" id="page-25" name="page-25"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   o  DHCPLEASEQUERYDONE

      A response of DHCPLEASEQUERYDONE indicates that the server has
      completed its response to the query and that no more messages will
      be sent in response to the DHCPBULKLEASEQUERY.  More details will
      sometimes be available in the received status-code option in the
      DHCPLEASEQUERYDONE message.  If there is no status-code option in
      the DHCPLEASEQUERYDONE message, then the query completed
      successfully.

      Note that a query that returned no data, that is, a
      DHCPBULKLEASEQUERY request followed by a DHCPLEASEQUERYDONE
      response, is considered a successful query in that no errors
      occurred during the processing.  It is not considered an error to
      have no information to return to a DHCPBULKLEASEQUERY request.

   The DHCPLEASEUNKNOWN message MUST NOT appear in a response to a Bulk
   Leasequery.

   The requestor MUST NOT assume that there is any inherent order in the
   IP address binding information that is sent in response to a
   DHCPBULKLEASEQUERY.  While the base-time will tend to increase
   monotonically (as it is the current time on the DHCPv4 server), the
   actual time that any IP address binding information changed is
   unrelated to the base-time.

   The DHCPLEASEQUERYDONE message always ends a successful
   DHCPBULKLEASEQUERY request and any unsuccessful DHCPBULKLEASEQUERY
   requests not terminated by a dropped connection.  After receiving a
   DHCPLEASEQUERYDONE from a server, the requestor MAY close the TCP
   connection to that server if no other DHCPBULKLEASEQUERY is
   outstanding on that TCP connection.

   The DHCPv4 Leasequery protocol [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>] uses the associated-ip
   option as an indicator that multiple bindings were present in
   response to a single DHCPv4 client-based query.  For Bulk Leasequery,
   a separate message is returned for each binding, so the associated-ip
   option is not used.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.4.%20%20Processing%20Time%20Values%20in%20Leasequery%20Messages"></a><a class="selflink" href="#section-7.4" name="section-7.4">7.4</a>.  Processing Time Values in Leasequery Messages</span>

   Bulk Leasequery requests may be made to a DHCPv4 server whose
   absolute time may not be synchronized with the local time of the
   requestor.  Thus, there are at least two time contexts in even the
   simplest Bulk Leasequery response, and in the situation where
   multiple DHCPv4 servers are queried, the situation becomes even more
   complex.




<span class="grey">Kinnear, et al.              Standards Track                   [Page 25]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-26" id="page-26" name="page-26"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   If the requestor of a Bulk Leasequery is saving the data returned in
   some form, it has a requirement to store a variety of time values;
   some of these will be time in the context of the requestor, and some
   will be time in the context of the DHCPv4 server.

   When receiving a DHCPLEASEACTIVE or DHCPLEASEUNASSIGNED message from
   the DHCPv4 server, the message will contain a base-time option.  The
   time contained in this base-time option is in the context of the
   DHCPv4 server.  As such, it is an ideal time to save and use as input
   to a DHCPBULKLEASEQUERY in the query-start-time or query-end-time
   options, should the requestor ever need to issue a DHCPBULKLEASEQUERY
   message using those options as part of a later query, since those
   options require a time in the context of the DHCPv4 server.

   In addition to saving the base-time for possible future use in a
   query-start-time or query-end-time option, the base-time is used as
   part of the conversion of the other times in the Leasequery message
   to values that are meaningful in the context of the requestor.  These
   other time values are specified as a offset (duration) from the base-
   time value and not as an absolute time.

   In systems whose clocks are synchronized, perhaps using NTP, the
   clock skew will usually be zero.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.5.%20%20Querying%20Multiple%20Servers"></a><a class="selflink" href="#section-7.5" name="section-7.5">7.5</a>.  Querying Multiple Servers</span>

   A Bulk Leasequery requestor MAY be configured to attempt to connect
   to and query from multiple DHCPv4 servers in parallel.  The DHCPv4
   Leasequery specification [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>] includes a discussion about
   reconciling binding data received from multiple DHCPv4 servers.

   In addition, the algorithm in <a href="#section-7.6">Section 7.6</a> should be used.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.6.%20%20Making%20Sense%20out%20of%20Multiple%20Responses%20concerning%20a%20Single%20IPv4"></a><a class="selflink" href="#section-7.6" name="section-7.6">7.6</a>.  Making Sense out of Multiple Responses concerning a Single IPv4</span>
<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/Address"></a>      Address</span>

   Any requestor of an Bulk Leasequery MUST be prepared for multiple
   responses to arrive for a particular IPv4 address from multiple
   different DHCPv4 servers.  The following algorithm SHOULD be used to
   decide if the information just received is more up to date (i.e.,
   better) than the best existing information.  In the discussion below,
   the information that is received from a DHCPv4 server about a
   particular IPv4 address is termed a "record".  The times used in the
   algorithm below SHOULD have been converted into the requestor's
   context, and the time comparisons SHOULD be performed in a manner
   consistent with the information in <a href="#section-7.4">Section 7.4</a>.





<span class="grey">Kinnear, et al.              Standards Track                   [Page 26]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-27" id="page-27" name="page-27"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   o  If both the existing and the new record contain client-last-
      transaction-time information, the record with the later client-
      last-transaction-time is considered better.

   o  If one of the records contains client-last-transaction-time
      information and the other one doesn't, then compare the client-
      last-transaction-time in the record that contains it against the
      other record's start-time-of-state.  The record with the later
      time is considered better.

   o  If neither record contains client-last-transaction-time
      information, compare their start-time-of-state information.  The
      record with the later start-time-of-state is considered better.

   o  If none of the comparisons above yield a clear answer as to which
      record is later, then compare the value of the REMOTE flag from
      the data-source option for each record.  If the values of the
      REMOTE flag are different between the two records, the record with
      the REMOTE flag value of local is considered better.

   The above algorithm does not necessarily determine which record is
   better.  In the event that the algorithm is inconclusive with regard
   to a record that was just received by the requestor, the requestor
   SHOULD use additional information in the two records to make a
   determination as to which record is better.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.7.%20%20Multiple%20Queries%20to%20a%20Single%20Server%20over%20One%20Connection"></a><a class="selflink" href="#section-7.7" name="section-7.7">7.7</a>.  Multiple Queries to a Single Server over One Connection</span>

   Bulk Leasequery requestors may need to make multiple queries in order
   to recover binding information.  A requestor MAY use a single
   connection to issue multiple queries to a server willing to support
   them.  Each query MUST have a unique xid.

   A server SHOULD allow configuration of the number of queries that can
   be processed simultaneously over a single connection.  A server
   SHOULD read the number of queries it is configured to process
   simultaneously and only read any subsequent queries as current
   queries are processed.

   A server that is processing multiple queries simultaneously MUST NOT
   block sending replies on new queries until all replies for the
   existing query are complete.  Requestors need to be aware that
   replies for multiple queries may be interleaved within the stream of
   reply messages.  Requestors that are not able to process interleaved
   replies (based on xid) MUST NOT send more than one query over a
   single connection prior to the completion of the previous query.





<span class="grey">Kinnear, et al.              Standards Track                   [Page 27]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-28" id="page-28" name="page-28"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   Requestors should be aware that servers are not required to process
   more than one query over a connection at a time (the limiting case
   for the configuration described above) and that servers are likely to
   limit the rate at which they process queries from any one requestor.

<span class="h4"><a class="dashAnchor" name="//apple_ref/Section/7.7.1.%20%20Example"></a><a class="selflink" href="#section-7.7.1" name="section-7.7.1">7.7.1</a>.  Example</span>

   This example illustrates what a series of queries and responses might
   look like.  This is only an example -- there is no requirement that
   this sequence must be followed or that requestors or servers must
   support parallel queries.

   In the example session, the client sends four queries after
   establishing a connection.  Query 1 returns no results; query 2
   returns 3 messages, and the stream of replies concludes before the
   client issues any new query.  Query 3 and query 4 overlap, and the
   server interleaves its replies to those two queries.

     Requestor                             Server
     ---------                             ------
     DHCPBULKLEASEQUERY xid 1 -----&gt;
                              &lt;-----       DHCPLEASEQUERYDONE xid 1
     DHCPBULKLEASEQUERY xid 2 -----&gt;
                              &lt;-----       DHCPLEASEACTIVE xid 2
                              &lt;-----       DHCPLEASEACTIVE xid 2
                              &lt;-----       DHCPLEASEACTIVE xid 2
                              &lt;-----       DHCPLEASEQUERYDONE xid 2
     DHCPBULKLEASEQUERY xid 3 -----&gt;
     DHCPBULKLEASEQUERY xid 4 -----&gt;
                              &lt;-----       DHCPLEASEACTIVE xid 4
                              &lt;-----       DHCPLEASEACTIVE xid 4
                              &lt;-----       DHCPLEASEACTIVE xid 3
                              &lt;-----       DHCPLEASEACTIVE xid 4
                              &lt;-----       DHCPLEASEUNASSIGNED xid 3
                              &lt;-----       DHCPLEASEACTIVE xid 4
                              &lt;-----       DHCPLEASEACTIVE xid 3
                              &lt;-----       DHCPLEASEQUERYDONE xid 3
                              &lt;-----       DHCPLEASEACTIVE xid 4
                              &lt;-----       DHCPLEASEQUERYDONE xid 4

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/7.8.%20%20Closing%20Connections"></a><a class="selflink" href="#section-7.8" name="section-7.8">7.8</a>.  Closing Connections</span>

   If a requestor has no additional queries to send, or doesn't know if
   it has additional queries to send or not, then it SHOULD close the
   connection after receiving the DHCPLEASEQUERYDONE message for the
   last outstanding query that it sent.





<span class="grey">Kinnear, et al.              Standards Track                   [Page 28]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-29" id="page-29" name="page-29"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   The requestor SHOULD close connections in a graceful manner and not
   an abort.  The requestor SHOULD NOT assume that the manner in which
   the DHCP server closed a connection carries any special meaning.

   Typically, the requestor is the entity that will close the
   connection, as servers will often wait with an open connection in
   case the requestor has additional queries.

   If a server closes a connection with an exception condition, the
   requestor SHOULD consider as valid any completely received
   intermediate results, and the requestor MAY retry the Bulk Leasequery
   operation.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/8.%20%20Server%20Behavior"></a><a class="selflink" href="#section-8" name="section-8">8</a>.  Server Behavior</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/8.1.%20%20Accepting%20Connections"></a><a class="selflink" href="#section-8.1" name="section-8.1">8.1</a>.  Accepting Connections</span>

   Servers that implement DHCPv4 Bulk Leasequery listen for incoming TCP
   connections.  Port numbers are discussed in <a href="#section-6.3">Section 6.3</a>.  Servers
   MUST be able to limit the number of concurrently accepted and active
   connections.  The value BULK_LQ_MAX_CONNS SHOULD be the default;
   implementations MAY permit the value to be configurable.  Connections
   SHOULD be accepted and, if the number of connections is over
   BULK_LQ_MAX_CONNS, they SHOULD be closed immediately.

   Servers MAY restrict Bulk Leasequery connections and
   DHCPBULKLEASEQUERY messages to certain requestors.  Connections not
   from permitted requestors SHOULD be closed immediately to avoid
   server connection resource exhaustion.  Servers MAY restrict some
   requestors to certain query types.  Servers MAY reply to queries that
   are not permitted with the DHCPLEASEQUERYDONE message with a status-
   code option status of NotAllowed or MAY simply close the connection.

   If the TCP connection becomes blocked while the server is accepting a
   connection or reading a query, it SHOULD be prepared to terminate the
   connection after a BULK_LQ_DATA_TIMEOUT.  We make this recommendation
   to allow servers to control the period of time they are willing to
   wait before abandoning an inactive connection, independent of the TCP
   implementations they may be using.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/8.2.%20%20Replying%20to%20a%20Bulk%20Leasequery"></a><a class="selflink" href="#section-8.2" name="section-8.2">8.2</a>.  Replying to a Bulk Leasequery</span>

   If the connection becomes blocked while the server is attempting to
   send reply messages, the server SHOULD be prepared to terminate the
   TCP connection after a BULK_LQ_DATA_TIMEOUT.






<span class="grey">Kinnear, et al.              Standards Track                   [Page 29]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-30" id="page-30" name="page-30"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   Every Bulk Leasequery request MUST be terminated by sending a final
   DHCPLEASEQUERYDONE message if such a message can be sent.  The
   DHCPLEASEQUERYDONE message MUST have a status-code option status if
   the termination was other than successful, and SHOULD NOT contain a
   status-code option status if the termination was successful.

   If the DHCPv4 server encounters an error during processing of the
   DHCPBULKLEASEQUERY message, either during initial processing or later
   during the message processing, it SHOULD send a DHCPLEASEQUERYDONE
   containing a status-code option.  It MAY close the connection after
   this error is signaled, but that is not required.

   If the server does not find any bindings satisfying a query, it MUST
   send a DHCPLEASEQUERYDONE.  It SHOULD NOT include a status-code
   option with a Success status unless there is a useful string to
   include in the status-code option.  Otherwise, the server sends each
   binding's data in a DHCPLEASEACTIVE or DHCPLEASEUNASSIGNED message.

   The response to a DHCPBULKLEASEQUERY may involve examination of
   multiple DHCPv4 IP address bindings maintained by the DHCPv4 server.
   The Bulk Leasequery protocol does not require any ordering of the IP
   addresses returned in DHCPLEASEACTIVE or DHCPLEASEUNASSIGNED
   messages.

   When responding to a DHCPBULKLEASEQUERY message, the DHCPv4 server
   MUST NOT send more than one message for each applicable IP address,
   even if the state of some of those IP addresses changes during the
   processing of the message.  Updates to such IP address state are
   already handled by normal protocol processing, so no special effort
   is needed here.

   If the ciaddr, yiaddr, or siaddr is non-zero in a DHCPBULKLEASEQUERY
   request, the request must be terminated immediately by a
   DHCPLEASEQUERYDONE message with a status-code option status of
   MalformedQuery.

   Any DHCPBULKLEASEQUERY that has more than one of the following
   primary query types specified MUST be terminated immediately by a
   DHCPLEASEQUERYDONE message with a status-code option status code of
   NotAllowed.

   The allowable queries in a DHCPBULKLEASEQUERY message are processed
   as follows.  Note that the descriptions of the primary queries below
   must be constrained by the actions of any of the three qualifiers
   described subsequently as well.






<span class="grey">Kinnear, et al.              Standards Track                   [Page 30]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-31" id="page-31" name="page-31"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   The following table discusses how to process the various queries.
   For information on how to identify the query, see the information in
   <a href="#section-7.2">Section 7.2</a>.

   o  Query by MAC address

      Every IP address that has a current binding to a DHCPv4 client
      matching the chaddr, htype, and hlen in the DHCPBULKLEASEQUERY
      request MUST be returned in a DHCPLEASEACTIVE message.

   o  Query by Client-identifier

      Every IP address that has a current binding to a DHCPv4 client
      matching the Client-identifier option in the DHCPBULKLEASEQUERY
      request MUST be returned in a DHCPLEASEACTIVE message.

   o  Query by Remote ID

      Every IP address that has a current binding to a DHCPv4 client
      matching the Remote ID sub-option of the relay-agent-information
      option in the DHCPBULKLEASEQUERY request MUST be returned in a
      DHCPLEASEACTIVE message.

   o  Query by Relay-ID

      Every IP address that has a current binding to a DHCPv4 client
      matching the Relay-ID sub-option of the relay-agent-information
      option in the DHCPBULKLEASEQUERY request MUST be returned in a
      DHCPLEASEACTIVE message.

   o  Query for All Configured IP Addresses

      A Query for All Configured IP addresses is signaled by the absence
      of any other primary query.  That is, if there is no value in the
      chaddr, hlen, htype, no Client-identifier option, and no Remote ID
      sub-option or Relay-ID sub-option of the relay-agent-information
      option, then the request is a query for information concerning all
      configured IP addresses.  In this case, every configured IP
      address that has a current binding to a DHCPv4 client MUST be
      returned in a DHCPLEASEACTIVE message.  In addition, every
      configured IP address that does not have a current binding to a
      DHCPv4 client MUST be returned in a DHCPLEASEUNASSIGNED message.

      In this form of query, each configured IP address MUST be returned
      at most one time.  In the absence of qualifiers restricting the
      number of IP addresses returned, every configured IP address MUST
      be returned exactly once.




<span class="grey">Kinnear, et al.              Standards Track                   [Page 31]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-32" id="page-32" name="page-32"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   There are three qualifiers that can be applied to any of the above
   primary queries.  These qualifiers can appear individually or
   together in any combination, but only one of each can appear.

   o  Query Start Time

      If a query-start-time option appears in the DHCPBULKLEASEQUERY
      request, only IP address bindings that have changed on or after
      the time specified in the query-start-time option should be
      returned.

   o  Query End Time

      If a query-end-time option appears in the DHCPBULKLEASEQUERY
      request, only IP address bindings that have changed on or before
      the time specified in the query-end-time option should be
      returned.

   o  VPN-ID

      If no VPN-ID option appears in the DHCPBULKLEASEQUERY, the default
      (global) VPN is used to satisfy the query.  A VPN-ID option
      [<a href="rfc6607.html" title='"Virtual Subnet Selection Options for DHCPv4 and DHCPv6"'>RFC6607</a>] value other than the wildcard value (254) allows the
      requestor to specify a single VPN other than the default VPN.  In
      addition, the VPN-ID option has been extended as part of this
      document to allow specification of a type 254, which indicates
      that all configured VPNs be searched in order to satisfy the
      primary query.

      In all cases, if the information returned in a DHCPLEASEACTIVE or
      DHCPLEASEUNASSIGNED message is for a VPN other than the default
      (global) VPN, a VPN-ID option MUST appear in the packet.

   The query-start-time and query-end-time qualifiers are used to
   constrain the amount of data returned by a Bulk Leasequery request by
   returning only IP addresses whose address bindings have changed in
   some way during the time window specified by the query-start-time and
   query-end-time.

   A DHCPv4 server SHOULD consider an address binding to have changed
   during a specified time window if either the client-last-
   transaction-time or the start-time-of-state of the address binding
   changed during that time window.

   The DHCPv4 server MAY return address binding data in any order, as
   long as binding information for any given IP address is not repeated.
   When all binding data for a given DHCPBULKLEASEQUERY has been sent,
   the DHCPv4 server MUST send a DHCPBULKLEASEQUERYDONE message.



<span class="grey">Kinnear, et al.              Standards Track                   [Page 32]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-33" id="page-33" name="page-33"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/8.3.%20%20Building%20a%20Single%20Reply%20for%20Bulk%20Leasequery"></a><a class="selflink" href="#section-8.3" name="section-8.3">8.3</a>.  Building a Single Reply for Bulk Leasequery</span>

   The DHCPv4 Leasequery specification [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>] describes the initial
   construction of DHCPLEASEQUERY reply messages using the
   DHCPLEASEACTIVE and DHCPLEASEUNASSIGNED message types in <a href="#section-6.4.2">Section</a>
   <a href="#section-6.4.2">6.4.2</a>.  All of the reply messages in Bulk Leasequery are similar to
   the reply messages for an IP address query.  Message transmission and
   framing for TCP are described in this document in <a href="#section-6.1">Section 6.1</a>.

   [<a id="ref-RFC2131" name="ref-RFC2131">RFC2131</a>] and [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>] specify that every response message MUST
   contain the server-identifier option.  However, that option will be
   the same for every response from a particular DHCPBULKLEASEQUERY
   request.  Thus, the DHCPv4 server MUST include the server-identifier
   option in the first message sent in response to a DHCPBULKLEASEQUERY.
   It SHOULD NOT include the server-identifier option in later messages.

   The message type of DHCPLEASEACTIVE or DHCPLEASEUNASSIGNED is based
   on the value of the dhcp-state option.  If the dhcp-state option
   value is ACTIVE, then the message type is DHCPLEASEACTIVE; otherwise,
   the message type is DHCPLEASEUNASSIGNED.

   In addition to the basic message construction described in [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>],
   the following guidelines exist:

   1.  If the dhcp-state option code appears in the dhcp-parameter-
       request-list, the DHCPv4 server SHOULD include a dhcp-state
       option whose value corresponds most closely to the state held by
       the DHCPv4 server for the IP address associated with this reply.
       If the state is ACTIVE and the message being returned is
       DHCPLEASEACTIVE, then the DHCPv4 server MAY choose to not send
       the dhcp-state option.  The requestor SHOULD assume that any
       DHCPLEASEACTIVE message arriving without a requested dhcp-state
       option has a dhcp-state of ACTIVE.

   2.  If the base-time option code appears in the dhcp-parameter-
       request-list, the DHCPv4 server MUST include a base-time option,
       which is the current time in the DHCPv4 server's context and the
       time from which the start-time-of-state, dhcp-lease-time, client-
       last-transaction-time, and other duration-style times are based
       upon.

   3.  If the start-time-of-state option code appears in the dhcp-
       parameter-request-list, the DHCPv4 server MUST include a start-
       time-of-state option whose value represents the time at which the
       dhcp-state option's state became valid.






<span class="grey">Kinnear, et al.              Standards Track                   [Page 33]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-34" id="page-34" name="page-34"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   4.  If the dhcp-lease-time option code appears in the dhcp-
       parameter-request-list, the DHCPv4 server MUST include a dhcp-
       lease-time option for any state that has a timeout value
       associated with it.

   5.  If the data-source option code appears in the dhcp-parameter-
       request-list, the DHCPv4 server MUST include the data-source
       option in any situation where any of the bits would be non-zero.
       Thus, in the absence of the data-source option, the assumption is
       that all of the flags are zero.

   6.  If the client-last-transaction-time option code appears in the
       dhcp-parameter-request-list, the DHCPv4 server MUST include the
       client-last-transaction-time option in any situation where the
       information is available.

   7.  If there is a dhcp-parameter-request-list in the initial
       DHCPBULKLEASEQUERY request, then it should be used for all of the
       replies generated by that request.  Some options can be sent from
       a DHCPv4 client to the server or from the DHCPv4 server to a
       DHCPv4 client.  Option 125 is such an option.  If the option code
       for one of these options appears in the dhcp-parameter-request-
       list, it SHOULD result in returning the value of the option sent
       by the DHCPv4 client to the server if one exists.

   Note that there may be other requirements for a reply to a
   DHCPBULKLEASEQUERY request, as discussed in <a href="#section-8.2">Section 8.2</a>.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/8.4.%20%20Multiple%20or%20Parallel%20Queries"></a><a class="selflink" href="#section-8.4" name="section-8.4">8.4</a>.  Multiple or Parallel Queries</span>

   As discussed in <a href="#section-7.3">Section 7.3</a>, requestors may want to use a connection
   that has already been established when they need to make additional
   queries.  Servers SHOULD support reading and processing multiple
   queries from a single connection and SHOULD allow configuration of
   the number of simultaneous queries it may process.  A server MUST NOT
   read more query messages from a connection than it is prepared to
   process simultaneously.

   This SHOULD be a feature that is administratively controlled.
   Servers SHOULD offer configuration that limits the number of
   simultaneous queries permitted from any one requestor, in order to
   control resource use if there are multiple requestors seeking
   service.








<span class="grey">Kinnear, et al.              Standards Track                   [Page 34]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-35" id="page-35" name="page-35"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/8.5.%20%20Closing%20Connections"></a><a class="selflink" href="#section-8.5" name="section-8.5">8.5</a>.  Closing Connections</span>

   The DHCPv4 server SHOULD close connections in a graceful manner and
   not abort the connection.  The DHCPv4 server SHOULD NOT assume that
   the manner in which the requestor closed a connection carries any
   special meaning.

   Typically, the DHCPv4 server will only close the connection after
   some form of an exception or a timeout on the connection.

   Using a timer to detect when a connection is idle and then closing
   that connection is designed to protect the DHCPv4 server from
   consuming unnecessary resources.

   The DHCPv4 server should start a timer for BULK_LQ_DATA_TIMEOUT
   seconds for a particular connection after it sends a
   DHCPLEASEQUERYDONE message over that connection if there is no
   current query outstanding for that connection.  It should restart
   this timer if a query arrives over that connection.  If the timer
   expires, the DHCPv4 server should close the connection.

   The server MUST close its end of the TCP connection if it encounters
   an error sending data on the connection.  The server MUST close its
   end of the TCP connection if it finds that it has to abort an in-
   process request.  A server aborting an in-process request SHOULD
   attempt to signal that to its requestors by using the QueryTerminated
   status code in the status-code option in a DHCPLEASEQUERYDONE
   message, including a message string indicating details of the reason
   for the abort.  If the connection is closed for any reason, all of
   the data flows associated with any currently outstanding
   DHCPBULKLEASEQUERY messages will be terminated.

   If the server detects that the requesting end of the connection has
   been closed, the server MUST close its end of the connection.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/9.%20%20Security%20Considerations"></a><a class="selflink" href="#section-9" name="section-9">9</a>.  Security Considerations</span>

   The Security Considerations section of [<a href="rfc2131.html" title='"Dynamic Host Configuration Protocol"'>RFC2131</a>] details the general
   threats to DHCPv4.  The DHCPv4 Leasequery specification [<a href="rfc4388.html" title='"Dynamic Host Configuration Protocol (DHCP) Leasequery"'>RFC4388</a>]
   describes recommendations for the Leasequery protocol, especially
   with regard to authentication of LEASEQUERY messages, mitigation of
   packet-flooding DoS attacks, and restriction to trusted requestors.

   The use of TCP introduces some additional concerns.  Attacks that
   attempt to exhaust the DHCPv4 server's available TCP connection
   resources, such as SYN flooding attacks, can compromise the ability
   of legitimate requestors to receive service.  Malicious requestors
   who succeed in establishing connections but who then send invalid



<span class="grey">Kinnear, et al.              Standards Track                   [Page 35]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-36" id="page-36" name="page-36"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   queries, partial queries, or no queries at all can also exhaust a
   server's pool of available connections.  We recommend that servers
   offer configuration to limit the sources of incoming connections,
   that they limit the number of accepted connections and the number of
   in-process queries from any one connection, and that they limit the
   period of time during which an idle connection will be left open.

   There are two specific issues regarding Bulk Leasequery security that
   deserve explicit mention.  The first is preventing information that
   Bulk Leasequery can provide from reaching clients who are not
   authorized to receive such information.  The second is ensuring that
   authorized clients of the Bulk Leasequery capability receive accurate
   information from the server (and that this information is not
   disrupted in transit).

   To prevent information leakage to unauthorized clients, servers
   SHOULD restrict Bulk Leasequery connections and DHCPBULKLEASEQUERY
   messages to certain requestors, either through explicit configuration
   of the server itself or by employing external network elements to
   provide such restrictions.  In particular, the typical DHCPv4 client
   SHOULD NOT be allowed to receive a response to a Bulk Leasequery
   request, and some technique MUST exist to allow prevention of such
   access in any environment where Bulk Leasequery is deployed.

   Connections not from permitted requestors SHOULD be closed
   immediately to avoid server connection resource exhaustion or
   alternatively, simply not be allowed to reach the server at all.
   Servers SHOULD have the capability to restrict certain requestors to
   certain query types.  Servers MAY reply to queries that are not
   permitted with the DHCPLEASEQUERYDONE message with a status-code
   option status of NotAllowed or MAY simply close the connection.

   To prevent disruption and malicious corruption of Bulk Leasequery
   data flows between the server and authorized clients, these data
   flows SHOULD transit only secured networks.  These data flows are
   typically infrastructure oriented, and there is usually no reason to
   have them flowing over networks where such attacks are likely.  In
   the rare cases where these data flows might need to be sent through
   unsecured networks, they MUST be sent over connections secured
   through means external to the DHCPv4/DHCPv6 server and its client(s)
   (e.g., through VPNs).

   Authentication for DHCP messages [<a href="rfc3118.html" title='"Authentication for DHCP Messages"'>RFC3118</a>] MUST NOT be used to
   attempt to secure transmission of the messages described in this
   document.  In particular, the message framing would not be protected
   by using the mechanisms described in [<a href="rfc3118.html" title='"Authentication for DHCP Messages"'>RFC3118</a>] (which was designed
   only with UDP transport in mind).




<span class="grey">Kinnear, et al.              Standards Track                   [Page 36]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-37" id="page-37" name="page-37"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/10.%20%20IANA%20Considerations"></a><a class="selflink" href="#section-10" name="section-10">10</a>.  IANA Considerations</span>

   IANA has assigned the following new DHCPv4 option codes from the
   registry "BOOTP Vendor Extensions and DHCP Options" maintained at
   <a href="http://www.iana.org/assignments/bootp-dhcp-parameters">http://www.iana.org/assignments/bootp-dhcp-parameters</a>.

      1.  An option code of 151 for status-code.

      2.  An option code of 152 for base-time.

      3.  An option code of 153 for start-time-of-state.

      4.  An option code of 154 for query-start-time.

      5.  An option code of 155 for query-end-time.

      6.  An option code of 156 for dhcp-state.

      7.  An option code of 157 for data-source.

   IANA has assigned the following new DHCP message types from the
   registry "DHCP Message Type 53 Values" maintained at
   <a href="http://www.iana.org/assignments/bootp-dhcp-parameters">http://www.iana.org/assignments/bootp-dhcp-parameters</a>.

      1.  A dhcp-message-type of 14 for DHCPBULKLEASEQUERY.

      2.  A dhcp-message-type of 15 for DHCPLEASEQUERYDONE.

   IANA has created a new registry on the same assignments page, titled
   "DHCP State 156 Values" (where 156 corresponds to the assigned value
   of the dhcp-state option above).  This registry has the following
   initial values:

      State
      -----
        1     AVAILABLE
        2     ACTIVE
        3     EXPIRED
        4     RELEASED
        5     ABANDONED
        6     RESET
        7     REMOTE
        8     TRANSITIONING

   New values for this namespace may only be defined by IETF Review, as
   described in [<a href="rfc5226.html" title='"Guidelines for Writing an IANA Considerations Section in RFCs"'>RFC5226</a>].





<span class="grey">Kinnear, et al.              Standards Track                   [Page 37]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-38" id="page-38" name="page-38"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   IANA has created a new registry on the same assignments page, titled
   "DHCP Status Code 151 Values" (where 151 corresponds to the assigned
   value of the status-code option above).  This registry has the
   following initial values:

      Name    status-code
      ----    -----------
      Success         000
      UnspecFail      001
      QueryTerminated 002
      MalformedQuery  003
      NotAllowed      004

   New values for this namespace may only be defined by IETF Review, as
   described in [<a href="rfc5226.html" title='"Guidelines for Writing an IANA Considerations Section in RFCs"'>RFC5226</a>].

   IANA has revised the registry "VSS Type Options" created by [<a href="rfc6607.html" title='"Virtual Subnet Selection Options for DHCPv4 and DHCPv6"'>RFC6607</a>]
   in the overall area "Dynamic Host Configuration Protocol (DHCP) and
   Bootstrap Protocol (BOOTP) Parameters".  It has been revised to
   appear as follows.  Note that the number range for "Unassigned" has
   changed, and a new line for "All VPNs (wildcard)" was added.

     Type     VSS Information Format
     ------------------------------------------------------------
      0       Network Virtual Terminal (NVT) ASCII VPN identifier
      1       <a href="rfc2685.html">RFC 2685</a> VPN-ID
      2-253   Unassigned
      254     All VPNs (wildcard)
      255     Global, default VPN

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/11.%20%20Acknowledgements"></a><a class="selflink" href="#section-11" name="section-11">11</a>.  Acknowledgements</span>

   Significant text as well as important ideas were borrowed in whole or
   in part from "DHCPv6 Bulk Leasequery" [<a href="rfc5460.html" title='"DHCPv6 Bulk Leasequery"'>RFC5460</a>], written by Mark
   Stapp.  Further suggestions and improvements were made by
   participants in the DHC Working Group, including Alfred Hoenes.

<span class="h2"><a class="dashAnchor" name="//apple_ref/Section/12.%20%20References"></a><a class="selflink" href="#section-12" name="section-12">12</a>.  References</span>

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/12.1.%20%20Normative%20References"></a><a class="selflink" href="#section-12.1" name="section-12.1">12.1</a>.  Normative References</span>

   [<a id="ref-RFC2119" name="ref-RFC2119">RFC2119</a>]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", <a href="https://tools.ietf.org/html/bcp14">BCP 14</a>, <a href="rfc2119.html">RFC 2119</a>, March 1997.

   [<a id="ref-RFC2131" name="ref-RFC2131">RFC2131</a>]  Droms, R., "Dynamic Host Configuration Protocol", <a href="rfc2131.html">RFC</a>
              <a href="rfc2131.html">2131</a>, March 1997.





<span class="grey">Kinnear, et al.              Standards Track                   [Page 38]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-39" id="page-39" name="page-39"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   [<a id="ref-RFC2132" name="ref-RFC2132">RFC2132</a>]  Alexander, S. and R. Droms, "DHCP Options and BOOTP Vendor
              Extensions", <a href="rfc2132.html">RFC 2132</a>, March 1997.

   [<a id="ref-RFC3046" name="ref-RFC3046">RFC3046</a>]  Patrick, M., "DHCP Relay Agent Information Option", <a href="rfc3046.html">RFC</a>
              <a href="rfc3046.html">3046</a>, January 2001.

   [<a id="ref-RFC3118" name="ref-RFC3118">RFC3118</a>]  Droms, R., Ed., and W. Arbaugh, Ed., "Authentication for
              DHCP Messages", <a href="rfc3118.html">RFC 3118</a>, June 2001.

   [<a id="ref-RFC4388" name="ref-RFC4388">RFC4388</a>]  Woundy, R. and K. Kinnear, "Dynamic Host Configuration
              Protocol (DHCP) Leasequery", <a href="rfc4388.html">RFC 4388</a>, February 2006.

   [<a id="ref-RFC5226" name="ref-RFC5226">RFC5226</a>]  Narten, T. and H. Alvestrand, "Guidelines for Writing an
              IANA Considerations Section in RFCs", <a href="https://tools.ietf.org/html/bcp26">BCP 26</a>, <a href="rfc5226.html">RFC 5226</a>,
              May 2008.

   [<a id="ref-RFC5735" name="ref-RFC5735">RFC5735</a>]  Cotton, M. and L. Vegoda, "Special Use IPv4 Addresses",
              <a href="https://tools.ietf.org/html/bcp153">BCP 153</a>, <a href="rfc5735.html">RFC 5735</a>, January 2010.

   [<a id="ref-RFC6607" name="ref-RFC6607">RFC6607</a>]  Kinnear, K., Johnson, R., and M. Stapp, "Virtual Subnet
              Selection Options for DHCPv4 and DHCPv6", <a href="rfc6607.html">RFC 6607</a>, April
              2012.

   [<a id="ref-RFC6925" name="ref-RFC6925">RFC6925</a>]  Joshi, B., Desetti, R., and M. Stapp, "The DHCPv4 Relay
              Agent Identifier Sub-Option", <a href="rfc6925.html">RFC 6925</a>, April 2013.

<span class="h3"><a class="dashAnchor" name="//apple_ref/Section/12.2.%20%20Informative%20References"></a><a class="selflink" href="#section-12.2" name="section-12.2">12.2</a>.  Informative References</span>

   [<a id="ref-RFC951" name="ref-RFC951">RFC951</a>]   Croft, W. and J. Gilmore, "Bootstrap Protocol", <a href="rfc951.html">RFC 951</a>,
              September 1985.

   [<a id="ref-RFC1542" name="ref-RFC1542">RFC1542</a>]  Wimer, W., "Clarifications and Extensions for the
              Bootstrap Protocol", <a href="rfc1542.html">RFC 1542</a>, October 1993.

   [<a id="ref-RFC4614" name="ref-RFC4614">RFC4614</a>]  Duke, M., Braden, R., Eddy, W., and E. Blanton, "A Roadmap
              for Transmission Control Protocol (TCP) Specification
              Documents", <a href="rfc4614.html">RFC 4614</a>, September 2006.

   [<a id="ref-RFC5460" name="ref-RFC5460">RFC5460</a>]  Stapp, M., "DHCPv6 Bulk Leasequery", <a href="rfc5460.html">RFC 5460</a>, February
              2009.











<span class="grey">Kinnear, et al.              Standards Track                   [Page 39]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-40" id="page-40" name="page-40"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


Authors' Addresses

   Kim Kinnear
   Cisco Systems, Inc.
   1414 Massachusetts Ave.
   Boxborough, Massachusetts 01719
   USA

   Phone: (978) 936-0000
   EMail: kkinnear@cisco.com


   Mark Stapp
   Cisco Systems, Inc.
   1414 Massachusetts Ave.
   Boxborough, Massachusetts 01719
   USA

   Phone: (978) 936-0000
   EMail: mjs@cisco.com


   D.T.V Ramakrishna Rao
   Infosys Ltd.
   44 Electronics City, Hosur Road
   Bangalore  560 100
   India

   EMail: ramakrishnadtv@infosys.com
   URI:   <a href="http://www.infosys.com/">http://www.infosys.com/</a>


   Bharat Joshi
   Infosys Ltd.
   44 Electronics City, Hosur Road
   Bangalore  560 100
   India

   EMail: bharat_joshi@infosys.com
   URI:   <a href="http://www.infosys.com/">http://www.infosys.com/</a>


   Neil Russell
   Sea Street Technologies Inc.

   EMail: neil.e.russell@gmail.com





<span class="grey">Kinnear, et al.              Standards Track                   [Page 40]</span></pre>
<hr align="left" class="noprint" style="width: 96ex;"/><!--NewPage--><pre class="newpage"><a class="invisible" href="#page-41" id="page-41" name="page-41"> </a>
<span class="grey"><a href="rfc6926.html">RFC 6926</a>                 DHCPv4 Bulk Leasequery               April 2013</span>


   Pavan Kurapati
   Juniper Networks
   1194 N. Mathilda Ave.
   Sunnyvale, CA   94089
   USA

   EMail: kurapati@juniper.net
   URI:   <a href="http://www.juniper.net/">http://www.juniper.net/</a>


   Bernie Volz
   Cisco Systems, Inc.
   1414 Massachusetts Ave.
   Boxborough, Massachusetts 01719
   USA

   Phone: (978) 936-0000
   EMail: volz@cisco.com

































Kinnear, et al.              Standards Track                   [Page 41]

</pre><br/>
    <span class="noprint"><small><small>Html markup produced by rfcmarkup 1.119, available from
      <a href="https://tools.ietf.org/tools/rfcmarkup/">https://tools.ietf.org/tools/rfcmarkup/</a>
    </small></small></span>
  </div>




</body><!-- Mirrored from tools.ietf.org/html/rfc6926 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 23 Aug 2016 18:36:58 GMT --></html>